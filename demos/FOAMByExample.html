<html>
 <head>
  <link rel="stylesheet" type="text/css" href="../core/foam.css" />
  <script language="javascript" src="../core/bootFOAM.js"></script>
  <script language="javascript" src="dragon.js"></script>
  <title>FOAM DOM Objects</title>
  <style>
    h3 {color: #444;}
    .code {width:900px; white-space: pre; border: 1px solid; padding: 5px; font-family: monospace;}
    .output {width:900px; white-space: pre; border: 1px solid; padding: 5px; color: blue;}
    .error {border: 2px solid red;}
    .description { margin-left: 20px; font-size: 115%; }
  </style>
 </head>

 <body>

<script language="javascript">
FOAModel({
  name: 'DemoView',
  extendsModel: 'DetailView',
  templates: [ { name: 'toHTML' } ]
});
</script>

<foam id="t1" model="UnitTest" onInit="this.test()" view="DemoView">
  <name>Event Tests</name>
  <description>Test event primitives.</description>
  <async>true</async>
  <code>
    FOAModel({name: 'Test', properties: [ { name: 'x' } ]});
    var t = Test.create();
    t.x$.addListener(function() { log(t.x); });
    t.x = 1;
    t.x = 2;
    t.x = 3;
    Movement.animate(500, function() { t.x = 10; })();
    setTimeout(ret, 550);
  </code>
</foam>

<!--
<foam model="Model" name="DemoView" extendsModel="DetailView">
  <templates>
     <template name="toHTML"><code>
       <h2>$$name{mode:'read-only'}<h2>
       <div class="code">$$code{mode:'read-only'}</div>
       <div class="results">$$results</div>
     </code></template>
  </templates>
</foam>
-->

<foam model="UnitTest" onInit="this.test()" view="DemoView">
  <name>By-Name Value binding</name>
  <description>Demonstrate the binding of $ values.</description>
  <code>
    FOAModel({name: 'Test', properties: [ { name: 'x' } ]});
    var t1 = Test.create({x:1});
    var t2 = Test.create({x:2});

    t1.x$ = t2.x$;
    log([t1.x, t2.x]);

    t1.x = 3;
    log([t1.x, t2.x]);

    t2.x = 4;
    log([t1.x, t2.x]);

    var t3 = Test.create({x$: t1.x$});
    log([t1.x, t2.x, t3.x]);

    t3.x = 5;
    log([t1.x, t2.x, t3.x]);
  </code>
</foam>

<foam model="UnitTest" onInit="this.test()" view="DemoView">
  <name>Context Examples</name>
  <code>
    X.a = 42;
    log(X.a);
    var Y = X.sub({a:1,b:2}, 'Y');
    log(Y);
    log(Y.a);
    Mouse.create();
    var m1 = Mouse.create();
    var m2 = Y.Mouse.create();
    log('m2.X ', m2.X);
    log('m1.X ', m1.X);
    log(m2.X.a);
    var m3 = m2.X.Mouse.create();
    log(m3.X);
    log(m3.X.a);
  </code>
  <tests>
    <foam model="UnitTest" name="SubTest1"><code>
    log('sub test 1, part 1');
    log('sub test 1, part 2');
    </code></foam>
    <foam model="UnitTest" name="SubTest2"><code>
    log('sub test 2');
    </code></foam>
  </tests>
</foam>

<foam model="UnitTest" onInit="this.test()" view="DemoView">
  <name>A UnitTest embedded in DOM</name>
  <code>
    log('Here I am.');
    log('And here.');
  </code>
  <tests>
    <foam model="UnitTest" name="SubTest1"><code>
    log('sub test 1, part 1');
    log('sub test 1, part 2');
    </code></foam>
    <foam model="UnitTest" name="SubTest2"><code>
    log('sub test 2');
    </code></foam>
  </tests>
</foam>

<foam model="UnitTest" onInit="this.test()" view="DemoView">
  <name>A failed Test</name>
  <code>
    fail("Something's wrong.");
  </code>
</foam>

<foam model="UnitTest" onInit="this.test()" view="DemoView">
  <name>Property Type Conversions</name>
  <description>Test that properties coerce values properly..</description>
  <code>
    o = FOAM({
      model_: 'Model',
      name: 'Test',
      properties: [
        { model_: 'StringProperty',  name: 's' },
        { model_: 'IntProperty', name: 'i' },
        { model_: 'FloatProperty',   name: 'f' }
      ]
    }).create();

    assert(o.s === '', 'Default value for String Properties should be empty string.');
    o.s = 'string'; assert(o.s === 'string', 'Setting String Properties should work.');
    o.s = undefined; assert(o.s === '', 'Setting String Properties to undefined should convert value to empty string.');
    o.s = 1; assert(o.s === '1', 'Setting String Properties to numbers should convert value to String.');

    assert(o.i === 0, 'Default value for Int Properties should be 0.');
    o.i = 1; assert(o.i === 1, 'Setting Int Properties should work.');
    o.i = undefined; assert(o.i === 0, 'Setting Int Properties to undefined should convert value to 0.');
    o.i = '1'; assert(o.i === 1, 'Setting Int Properties to a string should convert value to Int.');

    assert(o.f === 0.0, 'Default value for Float Properties should be 0.0.');
    o.f = 1.0; assert(o.f === 1.0, 'Setting Float Properties should work.');
    o.f = undefined; assert(o.f === 0.0, 'Setting Float Properties to undefined should convert value to 0.0.');
    o.f = '1.1'; assert(o.f === 1.1, 'Setting Float Properties to a string should convert value to Float.');
  </code>
</foam>

<foam model="UnitTest" onInit="this.test()" view="DemoView">
  <name>DAO Tests</name>
  <description>Define the Model (like a schema) and create a DAO.</description>
  <code>
    Person = FOAM({
      model_: 'Model',
      name: 'Person',
      properties: [
        { name: 'id' },
        { name: 'name' },
        { name: 'sex', defaultValue: 'M' },
        { model_: 'IntProperty', name: 'age' }
      ]
    });

    dao = MDAO.create({model: Person})
      .addIndex(Person.NAME)
      .addIndex(Person.SEX, Person.AGE);

    log(dao);
  </code>
  <tests>
    <foam model="UnitTest" name="SubTest1">
      <description>Add some sample data and select ot a 'sink'.</description>
      <code>
        dao.put(Person.create({id:'1', name:'John',  age:21}));
        dao.put(Person.create({id:'2', name:'Dave',  age:20}));
        dao.put(Person.create({id:'3', name:'Steve', age:19}));
        dao.put(Person.create({id:'4', name:'Andy',  age:18}));

        dao.select({put: function(p) { log('person: ', p.name); }});
    </code></foam>
    <foam model="UnitTest" name="SubTest2">
      <description>Select directly to an Array.</description>
      <code>
        var a = [];
        dao.select(a);
        jlog(a);
    </code></foam>
  </tests>
</foam>

<foam model="UnitTest" onInit="this.test()" view="DemoView">
  <name>aFunc Tests</name>
  <description>Test FOAM's Asynchronous-Functions (aFunc's).</description>
  <code>
    f1 = function(ret) { log('f1() called.'); ret(1); };
    f2 = function(ret, a) { log('f2() called.'); ret(a,2); };
    aprint = function(ret) { log(argsToArray(arguments).slice(1).join(', ')); ret(); };
  </code>
  <tests>


    <foam model="UnitTest" name="test1"><async>true</async><code>aprint.ao(f2.ao(f1))(ret);</code></foam>
    <foam model="UnitTest" name="test2"><async>true</async><code>f1.aseq(f2.aseq(aprint))(ret);</code></foam>
    <foam model="UnitTest" name="test3"><async>true</async><code>f1.aseq(aprint)(ret);</code></foam>
    <foam model="UnitTest" name="test4"><async>true</async><code>ao(aprint,f2,f1)(ret);</code></foam>
    <foam model="UnitTest" name="test5"><async>true</async><code>aseq(f1, aprint)(ret);</code></foam>
    <foam model="UnitTest" name="test6"><async>true</async><code>aseq(f1,f2,aprint)(ret);</code></foam>
    <foam model="UnitTest" name="amemo">
      <async>true</async>
      <description>Test that amemo() only executes its delegate once.</description>
      <code>
        m = amemo(function(ret) { log('Should only see this once.'); ret(1); });
        apar(m, m, m).aseq(aprint)(ret);
      </code>
    </foam>
    <foam model="UnitTest" name="test7">
      <async>true</async>
      <code>
        aseq(
          function(ret) { log('fB'); ret(1); },
          function(ret) { log('fC'); ret(2); },
          aprint
        )(ret);
      </code>
    </foam>
    <foam model="UnitTest" name="test8">
      <async>true</async>
      <code>
        apar(
          function(ret, a) { log('fB'); ret(1); },
          function(ret, a) { log('fC'); ret(2); }
        )(aprint.aseq(ret));
      </code>
    </foam>
    <!--
    <foam model="UnitTest" name="test9">
      <async>true</async>
      <code>
        aseq(
          arepeatpar(5, aseq(ayield(), function(ret, a, b) { log('a', a); ret(1); })),
          ayield(),
          arepeatpar(5, function(ret, a, b) { log('b', a); ret(1); }),
          ayield()
        )(ret);
      </code>
    </foam>
    -->
    <foam model="UnitTest" name="arepeat 1">
      <async>true</async>
      <code>
        arepeat(5, f1)(ret);
      </code>
    </foam>
    <foam model="UnitTest" name="arepeat 2">
      <async>true</async>
      <code>
        arepeat(5, function(ret, a, b) { log(a); ret(1); }).aseq(aprint)(ret);
      </code>
    </foam>
    <foam model="UnitTest" name="arepeat 3">
      <async>true</async>
      <code>
        aseq(
          arepeat(5, function(ret, a, b) { log(a); ret(1); }),
          aprint)(ret);
      </code>
    </foam>
    <foam model="UnitTest" name="test11">
      <async>true</async>
      <code>
        aseq(
          function(ret) { log('fA'); ret(1); },
          apar(
            function(ret, a) { log('fB', a); ret(1); },
            function(ret, a) { log('fC', a); ret(2); }
          ),
          aprint
        )(ret);
      </code>
    </foam>
    <foam model="UnitTest" name="anop">
      <async>true</async>
      <code>log('anop'); aseq(alog('before'), anop, alog('after'))(ret);</code>
    </foam>
    <foam model="UnitTest" name="abind1">
      <async>true</async>
      <code>
          var boo = function() { log('boo'); }
          boo();
          boo.abind(null)(ret);
      </code>
    </foam>
    <foam model="UnitTest" name="abind2">
      <async>true</async>
      <code>
        aseq(
          f1,
          function() { log('sync fn'); }.abind(this),
          f2
        )(ret);
      </code>
    </foam>
    <foam model="UnitTest" name="alog">
      <async>true</async>
      <code>log('alog'); alog('a message')(ret);</code>
    </foam>
    <!--
    <foam model="UnitTest" name="cooperative multithreading">
      <async>true</async>
      <code>
          apar(
            arepeat(10, aseq(alog('A'), ayield())),
            arepeat(10, aseq(alog('B'), ayield()))
          ))(ret);
      </code>
    </foam>
    -->
    <!--
    <foam model="UnitTest" name="atimeout">
      <async>true</async>
      <description>What should be the semantics of atimeout()?  Should it still ret()?</description>
      <code>
        aseq(
          aseq(
            alog('starting'),
            atimeout(1000, asleep(500), alog('too slow')),
            alog('on time')
          ),
          aseq(
            alog('starting'),
            atimeout(1000, asleep(1500), alog('too slow')),
            alog('on time')
          ))(ret);
      </code>
    </foam>
    -->
    <foam id="test" model="UnitTest" name="asleep2">
      <async>true</async>
      <code>
        log('**********');
        log('************** Beginning asleep2');
        aseq(alog('before'), asleep(100), alog('after'), asleep(100), alog('much after'))(ret);
//        log('after it all');
      </code>
    </foam>
    <foam model="UnitTest" name="asleep2">
      <async>true</async>
      <code>
        log('at the start');
        aseq(asleep(100), alog('a message'))(ret);
      </code>
    </foam>
    <!--
    <foam model="UnitTest" name="ayield">
      <async>true</async>
      <code>
        aseq(ayield, alog('And then this second.'))(ret);
        log('This should print first.');
      </code>
    </foam>
    -->
    <foam model="UnitTest" name="Future Function">
      <async>true</async>
      <code>
        log('start');
  var functionFuture = afuture();
  var fn = futurefn(functionFuture);

  fn("hello");
  setTimeout(function() { fn(" world!"); ret(); }, 200);
  setTimeout(function() { functionFuture.set(log); }, 100);
      </code>
    </foam>
    <foam model="UnitTest" name="asynchronized">
      <code>
        tlock = {};

        f1 = aseq(
          alog('f1 start'),
          asleep(200),
          alog('f1 end')
        );
      </code>
      <tests>
        <foam model="UnitTest" name="Without Synchronization">
          <async>true</async>
          <code>
            apar(f1, f1, f1)(ret);
          </code>
        </foam>
        <foam model="UnitTest" name="With Synchronization">
          <async>true</async>
          <code>
            f1 = asynchronized(f1);

            apar(f1, f1, f1)(ret);
          </code>
        </foam>
        <foam model="UnitTest" name="With Synchronization (Sequential)">
          <async>true</async>
          <code>
            apar(aseq(f1, f1, f1), aseq(f1, f1, f1))(ret);
          </code>
        </foam>
      </tests>
    </foam>
  </tests>
</foam>

<foam model="UITest" view="DemoView">
  <name>View Tests</name>
  <description>Test Views and Data-Binding.</description>
  <tests>
    <foam model="UITest" name="AllViews">
      <description>Test all simple view types.</description>
      <code>
FOAModel({
  name: 'AllViews',

  properties: [
    {
      name: 'defaultEverything'
    },
    {
      name: 'defaultValue',
      defaultValue: 'defaultValue'
    },
    {
      name: 'clickToEnableEdit',
      defaultValue: 'click to enable edit',
      view: {
        model_: 'TextFieldView',
        className: 'clickToEnableEdit'
      }
    },
    {
      model_: 'StringProperty',
      name: 'stringProperty'
    },
    {
      model_: 'StringProperty',
      name: 'stringWithWidth',
      displayWidth: 60
    },
    {
      model_: 'StringProperty',
      name: 'stringWithWidthAndHeight',
      displayWidth: 40,
      displayHeight: 5
    },
    {
      model_: 'StringProperty',
      name: 'readOnlyStaticHTML',
      mode: 'read-only',
      defaultValue: '<font color=red><b>BOO!</b></font>'
    },
    {
      model_: 'BooleanProperty',
      name: 'booleanProperty'
    },
    {
      model_: 'BooleanProperty',
      name: 'imageBooleanProperty',
      view: ImageBooleanView.create({
               trueImage: 'data:image/gif;base64,R0lGODlhDwAPAMQfAF9h4RYVnZeQJC0u0lRQU42R6P/7Fv74L05NrRkZxi4tW52XXv71D8nAIWxnjnRxr3NuMJKOluXbBe7kCa2x7UFD1vPoB77D8Jqe6n6B5tvTUr62BMrP8lJPh1xbuv///yH5BAEAAB8ALAAAAAAPAA8AAAWD4CeOWQKMaDpESepi3tFlLgpExlK9RT9ohkYi08N8KhWP8nEwMBwIDyJRSTgO2CaDYcBOCAlMgtDYmhmTDSFQ+HAqgbLZIlAMLqiKw7m1EAYuFQsGEhITEwItKBc/EgIEAhINAUYkCBIQAQMBEGonIwAKa21iCgo7IxQDFRQjF1VtHyEAOw==', //'images/star_on.gif',
               falseImage: 'data:image/gif;base64,R0lGODlhDwAPALMPAP///8zj++r7/7vb/rHW/tPt/9Lk+qzT/rbY/sHh/8Te/N7q+Nzy/7nY/djn+f///yH5BAEAAA8ALAAAAAAPAA8AAARg8MkZjpo4k0KyNwlQBB42MICAfEF7APDRBsYzIEkewGKeDI1DgUckMg6GTdFIqC0QgyUgQVhgGkOi4OBBCJYdzILAywIGNcoOgCAQvowBRpE4kgzCQgPjQCAcEwsNTRIRADs=' //'images/star_off.gif'
             })
    },
    {
      model_: 'DateProperty',
      name: 'dateProperty'
    },
    {
      model_: 'DateTimeProperty',
      name: 'dateTimeProperty'
    },
    {
      model_: 'DateTimeProperty',
      name: 'relativeDateTimeProperty',
      view: 'RelativeDateTimeFieldView',
      defaultValue: new Date(Date.now()-123456)
    },
    {
      model_: 'IntProperty',
      name: 'integerProperty',
      defaultValue: 42
    },
    {
      model_: 'FunctionProperty',
      name: 'functionProperty',
      defaultValue: function() { console.log('boo!'); }
    },
<!--
    {
      model_: 'ReferenceProperty',
      name: 'referenceProperty',
      subType: 'Model'
    },
-->
    {
      model_: 'StringArrayProperty',
      name: 'stringArrayProperty',
      defaultValue: ["value1", "value2", "value3"]
    },
    {
      model_: 'EMailProperty',
      name: 'emailProperty'
    },
    {
      model_: 'URLProperty',
      name: 'urlProperty'
    },
    {
      name: 'choiceView',
      view: {
        model_: 'ChoiceView',
        helpText: 'Help Text',
        choices: [ 'Value1', 'Value2', 'Value3' ]
      }
    },
    {
      name: 'choiceViewWithDefaultValue',
      defaultValue: 'Value1',
      view: {
        model_: 'ChoiceView',
        helpText: 'Help Text',
        choices: [ 'Value1', 'Value2', 'Value3' ]
      }
    },
    {
      name: 'choiceViewWithLabels',
      view: {
        model_: 'ChoiceView',
        helpText: 'Help Text',
        choices: [
          [ 'value1', 'Label 1' ],
          [ 'value2', 'Label 2' ],
          [ 'value3', 'Label 3' ]
        ]
      }
    },
    {
      name: 'choiceListView',
      defaultValue: 'value2',
      view: ChoiceListView.create({
        choices: [
          [ 'value1', 'Label 1' ],
          [ 'value2', 'Label 2' ],
          [ 'value3', 'Label 3' ]
        ]
      })
    },
    {
      name: 'verticalChoiceListView',
      defaultValue: 'value2',
      view: ChoiceListView.create({
        orientation: 'vertical',
        choices: [
          [ 'value1', 'Label 1' ],
          [ 'value2', 'Label 2' ],
          [ 'value3', 'Label 3' ]
        ]
      })
    },
    {
      name: 'radioBoxView',
      view: RadioBoxView.create({
         helpText: 'Help Text',
         choices: [
           [ 'value1', 'Label 1' ],
           [ 'value2', 'Label 2' ],
           [ 'value3', 'Label 3' ]
         ]
      })
    },
    {
      model_: 'ArrayProperty',
      name: 'arrayProperty',
      subType: 'Model'
    }
  ]
});

  var allViews = AllViews.create();
  var dv1 = DetailView.create({value: SimpleValue.create(allViews)});
  var dv2 = DetailView.create({value: SimpleValue.create(allViews)});
  log('<table><tr><td>' + dv1.toHTML() + '</td><td>' + dv2.toHTML() + '</td></tr></table>');
  dv1.initHTML();
  dv2.initHTML();
      </code>
    </foam>
    <foam model="UITest" name="TextFieldView">
      <description>Test data-binding in TextFieldViews.</description>
      <code>
        var v1 = TextFieldView.create();
        var v2 = TextFieldView.create();

        render(v1);
        render(v2);

        v1.data$ = v2.data$;
      </code>
    </foam>
    <foam model="UITest" name="TextFieldView/onKeyMode">
      <description>Test data-binding in TextFieldViews with onKeyMode enabled.</description>
      <code>
        var v1 = TextFieldView.create({onKeyMode: true});
        var v2 = TextFieldView.create({onKeyMode: true});

        render(v1);
        render(v2);

        v1.data$ = v2.data$;
      </code>
    </foam>
    <foam model="UITest" name="TextFieldView/readOnlyMode">
      <description>Test data-binding in TextFieldViews with onKeyMode enabled.</description>
      <code>
        var v1 = TextFieldView.create({onKeyMode: true});
        var v2 = TextFieldView.create({mode: 'read-only'});

        render(v1);
        render(v2);

        v1.data$ = v2.data$;
      </code>
    </foam>
    <foam model="UITest" name="DetailView">
      <description>Test data-binding in TextFieldViews with onKeyMode enabled.</description>
      <code>
        var t   = Timer.create();
        var dv1 = DetailView.create({value: SimpleValue.create(t)});
        var dv2 = DetailView.create({value: SimpleValue.create(t)});

        render(dv1);
        render(dv2);
      </code>
    </foam>
    <foam model="UITest" name="DetailViewSwitchModel">
      <description>Test DetailView's ability to switch to value with a different Model.</description>
      <code>
        var t  = Timer.create();
        var dv = DetailView.create({value: SimpleValue.create(t)});

        render(dv);
        dv.value.set(TextFieldView.create());
      </code>
    </foam>
    <foam model="UITest" name="ChoiceViews">
      <description>Test data-binding in ChoiceViews.</description>
      <code>
        var choices = [ 'Value1', 'Value2', 'Value3' ];
        var v1 = ChoiceView.create({choices: choices});
        var v2 = ChoiceListView.create({choices: choices});
        var v3 = RadioBoxView.create({choices: choices});

        render(v1); render(v2); render(v3);

        v1.data$ = v2.data$ = v3.data$;
      </code>
    </foam>
  </tests>
</foam>
 </body>
</html>
