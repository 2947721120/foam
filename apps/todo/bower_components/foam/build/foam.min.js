function memoize(a){var b={};return function(){var c=argsToArray(arguments).toString();return b.hasOwnProperty(c)||(b[c]=a.apply(this,arguments)),b[c]}}function constantFn(a){return function(){return a}}function randomAct(){for(var a=0,b=0;b<arguments.length;b+=2)a+=arguments[b];for(var c=Math.random(),b=0,d=0;b<arguments.length;b+=2)if(d+=arguments[b],d/a>=c)return void arguments[b+1]()}function defineProperties(a,b){for(var c in b)try{Object.defineProperty(a,c,{value:b[c],configurable:!0,writable:!0})}catch(d){console.log("Warning: "+d)}}function Object_forEach(a,b){for(var c in a)a.hasOwnProperty(c)&&b(a[c],c)}function predicatedSink(a,b){return a!==TRUE&&b?{__proto__:b,$UID:b.$UID,put:function(c,d,e){!b.put||c&&!a.f(c)||b.put(c,d,e)},remove:function(c,d,e){!b.remove||c&&!a.f(c)||b.remove(c,d,e)},toString:function(){return"PredicatedSink("+b.$UID+", "+a+", "+b+")"}}:b}function limitedSink(a,b){var c=0;return{__proto__:b,put:function(d,e,f){c++>=a&&f?f.stop():b.put(d,e,f)}}}function skipSink(a,b){var c=0;return{__proto__:b,put:function(d,e,f){c++>=a&&b.put(d,e,f)}}}function orderedSink(a,b){return a=toCompare(a),{__proto__:b,i:0,arr:[],put:function(a){this.arr.push(a)},eof:function(){this.arr.sort(a),this.arr.select(b)}}}function trampoline(a,b,c,d){var e;a.defineProperty(b,c,{get:function(){return e?e:(e=d(),Object.defineProperty(b,c,e),e)},writable:!0,configurable:!0})}function multiline(a){var b=a.toString(),c=b.indexOf("/*"),d=b.lastIndexOf("*/");return b.substring(c+2,d)}function findPageXY(a){for(var b,c=0,d=0;a;)b=a,c+=a.offsetLeft,d+=a.offsetTop,a=a.offsetParent;return[c,d,b]}function stringtoutf8(a){for(var b=[],c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d&&b.push(d)}return b}function prep(a){return"string"==typeof a?literal(a):a}function prepArgs(a){for(var b=0;b<a.length;b++)a[b]=prep(a[b]);return a}function range(a,b){var c=function(c){return c.head?c.head<a||c.head>b?void 0:c.tail.setValue(c.head):void 0};return c.toString=function(){return"range("+a+", "+b+")"},c}function literal(a,b){var c=function(c){for(var d=0;d<a.length;d++,c=c.tail)if(a.charAt(d)!==c.head)return void 0;return c.setValue(b||a)};return c.toString=function(){return'"'+a+'"'},c}function literal_ic(a,b){a=a.toLowerCase();var c=function(c){for(var d=0;d<a.length;d++,c=c.tail)if(!c.head||a.charAt(d)!==c.head.toLowerCase())return void 0;return c.setValue(b||a)};return c.toString=function(){return'"'+a+'"'},c}function anyChar(a){return a.head?a.tail:void 0}function notChar(a){return function(b){return b.head&&b.head!==a?b.tail.setValue(b.head):void 0}}function notChars(a){return function(b){return b.head&&-1==a.indexOf(b.head)?b.tail.setValue(b.head):void 0}}function not(a,b){a=prep(a),b=prep(b);var c=function(c){return this.parse(a,c)?void 0:b?this.parse(b,c):c};return c.toString=function(){return"not("+a+")"},c}function optional(a){a=prep(a);var b=function(b){return this.parse(a,b)||b.setValue(void 0)};return b.toString=function(){return"optional("+a+")"},b}function copyInput(a){a=prep(a);var b=function(b){var c=this.parse(a,b);return c?c.setValue(b.str_.toString().substring(b.pos,c.pos)):c};return b.toString=function(){return"copyInput("+a+")"},b}function lookahead(a){a=prep(a);var b=function(b){return this.parse(a,b)&&b};return b.toString=function(){return"lookahead("+a+")"},b}function repeat(a,b,c,d){a=prep(a),b=prep(b);var e=function(e){for(var f=[],g=0;!d||d>g;g++){var h;if(b&&0!=f.length){if(!(h=this.parse(b,e)))break;e=h}if(!(h=this.parse(a,e)))break;f.push(h.value),e=h}return c&&f.length<c?void 0:e.setValue(f)};return e.toString=function(){return"repeat("+a+", "+b+", "+c+", "+d+")"},e}function plus(a){return repeat(a,void 0,1)}function noskip(a){return function(b){return this.skip_=!1,b=this.parse(a,b),this.skip_=!0,b}}function repeat0(a){return a=prep(a),function(b){for(var c;c=this.parse(a,b);)b=c;return b.setValue("")}}function seq(){var a=prepArgs(arguments),b=function(b){for(var c=[],d=0;d<a.length;d++){if(!(b=this.parse(a[d],b)))return void 0;c.push(b.value)}return b.setValue(c)};return b.toString=function(){return"seq("+argsToArray(a).join(",")+")"},b}function seq1(a){var b=prepArgs(argsToArray(arguments).slice(1)),c=function(c){for(var d,e=0;e<b.length;e++){if(!(c=this.parse(b[e],c)))return void 0;e==a&&(d=c.value)}return c.setValue(d)};return c.toString=function(){return"seq1("+a+", "+argsToArray(b).join(",")+")"},c}function alt(){function a(){return void 0}function b(a,b){var c=b.head,d={getValue:function(){return this.value},setValue:function(a){this.value=a},value:b.value,head:c},e=!1;return d.__defineGetter__("tail",function(){return e=!0,{value:this.value,getValue:function(){return this.value},setValue:function(a){this.value=a}}}),this.parse(a,d),e}function c(c){var f=c.head,g=e[f];if(!g){for(var h=[],i=0;i<d.length;i++){var j=d[i];b.call(this,j,c)&&h.push(j)}g=0==h.length?a:1==h.length?h[0]:simpleAlt.apply(null,h),e[f]=g}return g}var d=prepArgs(arguments),e={};return function(a){return this.parse(c.call(this,a),a)}}function alt(){var a=prepArgs(arguments),b=function(b){for(var c=0;c<a.length;c++){var d=this.parse(a[c],b);if(d)return d}return void 0};return b.toString=function(){return"alt("+argsToArray(a).join(" | ")+")"},b}function str(a){a=prep(a);var b=function(b){var b=this.parse(a,b);return b?b.setValue(b.value.join("")):void 0};return b.toString=function(){return"str("+a+")"},b}function pick(a,b){b=prep(b);var c=function(c){var c=this.parse(b,c);if(!c)return void 0;for(var d=[],e=0;e<a.length;e++)d.push(c.value[a[e]]);return c.setValue(d)};return c.toString=function(){return"pick("+a+", "+b+")"},c}function parsedebug(a){return function(b){var c=DEBUG_PARSE;DEBUG_PARSE=!0;var d=this.parse(a,b);return DEBUG_PARSE=c,d}}function sym(a){var b=function(b){var c=this[a];return c||console.log("PARSE ERROR: Unknown Symbol <"+a+">"),this.parse(c,b)};return b.toString=function(){return"<"+a+">"},b}function defineTTLProperty(a,b,c,d){Object.defineProperty(a,b,{get:function(){var a,e=void 0;return Object.defineProperty(this,b,{get:function(){function b(){setTimeout(function(){a?b():e=void 0,a=!1},c)}return e?a=!0:(a=!1,e=d(),b()),e}}),this[b]}})}function sub(a,b){var c={__proto__:this};if(a)for(var d in a)a.hasOwnProperty(d)&&Object.defineProperty(c,d,{value:a[d],writable:"window"!==d});return b&&(c.NAME=b,c.toString=function(){return"CONTEXT("+b+")"}),c}function subWindow(a,b,c){if(!a)return this.sub();var d=a.document,e={isBackground:!!c,window:a,document:d,console:a.console,log:a.console.log.bind(console),warn:a.console.warn.bind(console),info:a.console.info.bind(console),error:a.console.error.bind(console),$:function(a){return d.FOAM_OBJECTS&&d.FOAM_OBJECTS[a]?d.FOAM_OBJECTS[a]:d.getElementById(a)},$$:function(a){return d.getElementsByClassName(a)},dynamic:function(a,b){Events.dynamic(a,b,this)},memento:a.WindowHashValue&&a.WindowHashValue.create({window:a}),setTimeout:a.setTimeout.bind(a),clearTimeout:a.clearTimeout.bind(a),setInterval:a.setInterval.bind(a),clearInterval:a.clearInterval.bind(a),requestAnimationFrame:function(b){return a.requestAnimationFrame(b)},cancelAnimationFrame:a.cancelAnimationFrame&&a.cancelAnimationFrame.bind(a)};c&&(e.requestAnimationFrame=function(b){return a.setTimeout(b,16)},e.cancelAnimationFrame=e.clearTimeout);var f=this.sub(e,b);return a.X=f,f}function registerModel(a,b){var c=this,d=this===GLOBAL?a:{__proto__:a,create:function(a){return this.__proto__.create(a,c)}};return Object.defineProperty(this,b||a.name,{get:function(){return this===c?d:this.registerModel(a)},configurabe:!0}),d}function $addWindow(a){a.window.$WID=$WID__++,$documents.push(a.document)}function $removeWindow(a){for(var b=$documents.length-1;b>=0;b--)$documents[b].defaultView&&$documents[b].defaultView!==a||$documents.splice(b,1)}function testModel(a,b){a.tests&&b&&a.tests.forEach(function(a){a.test();var c=UnitTestResultView.create({value:SimpleValue.create(a)});b.insertAdjacentHTML("beforeend",c.toHTML()),c.initHTML()})}function arequire(a){var b=GLOBAL[a];if(!b.required__){for(var c=[],d=0;d<b.templates.length;d++){var e=b.templates[d];c.push(aseq(aevalTemplate(b.templates[d]),function(a){return function(c,d){b.getPrototype()[a.name]=d,c()}}(e)))}b.required__=amemo(aseq(apar.apply(apar,c),aconstant(b)))}return b.required__}function override(a,b,c){var d=a[b],e=function(){return d.apply(this,arguments)},f=function(){var a=this.SUPER;this.SUPER=e;try{return c.apply(this,arguments)}finally{this.SUPER=a}};f.super_=d,a[b]=f}function KeyboardShortcutController(a,b){this.contexts_={},this.body_={},this.processView_(b),a.addEventListener("keydown",this.processKey_.bind(this))}function toNum(a){return a.replace?parseInt(a.replace("px","")):a}function compile_(a){return a.f?a:a===!0?TRUE:a===!1?FALSE:ConstantExpr.create({arg1:a})}function compileArray_(a){for(var b=[],c=0;c<a.length;c++){var d=a[c];null!==d&&void 0!==d&&b.push(compile_(d))}return b}function SUM(a){return SumExpr.create({arg1:a})}function MIN(a){return MinExpr.create({arg1:a})}function MAX(a){return MaxExpr.create({arg1:a})}function AVG(a){return AvgExpr.create({arg1:a})}function COUNT(){return CountExpr.create()}function SEQ(){return SeqExpr.create({args:argsToArray(arguments)})}function UPDATE(){return UpdateExpr.create({args:compileArray_.call(null,Array.prototype.slice.call(arguments,0,-1)),dao:arguments[arguments.length-1]})}function SET(a,b){return SetExpr.create({arg1:compile_(a),arg2:compile_(b)})}function GROUP_BY(a,b){return GroupByExpr.create({arg1:a,arg2:b})}function GRID_BY(a,b,c){return GridByExpr.create({xFunc:a,yFunc:b,acc:c})}function MAP(a,b){return MapExpr.create({arg1:a,arg2:b||[]})}function DISTINCT(a,b){return DistinctExpr.create({arg1:a,arg2:b})}function AND(){return AndExpr.create({args:compileArray_.call(null,arguments)})}function OR(){return OrExpr.create({args:compileArray_.call(null,arguments)})}function NOT(a){return NotExpr.create({arg1:compile_(a)})}function EXPLAIN(a){return DescribeExpr.create({arg1:a})}function IN(a,b){return InExpr.create({arg1:compile_(a),arg2:b})}function EQ(a,b){var c=EqExpr.create();return c.instance_.arg1=compile_(a),c.instance_.arg2=compile_(b),c}function NEQ(a,b){return NeqExpr.create({arg1:compile_(a),arg2:compile_(b)})}function LT(a,b){return LtExpr.create({arg1:compile_(a),arg2:compile_(b)})}function GT(a,b){return GtExpr.create({arg1:compile_(a),arg2:compile_(b)})}function LTE(a,b){return LteExpr.create({arg1:compile_(a),arg2:compile_(b)})}function GTE(a,b){return GteExpr.create({arg1:compile_(a),arg2:compile_(b)})}function STARTS_WITH(a,b){return StartsWithExpr.create({arg1:compile_(a),arg2:compile_(b)})}function CONTAINS(a,b){return ContainsExpr.create({arg1:compile_(a),arg2:compile_(b)})}function CONTAINS_IC(a,b){return ContainsICExpr.create({arg1:compile_(a),arg2:compile_(b)})}function CONCAT(){return ConcatExpr.create({args:compileArray_.call(null,arguments)})}function TREE(a,b){return TreeExpr.create({parentProperty:a,childrenProperty:b})}function ADD(a,b){return AddExpr.create({arg1:compile_(a),arg2:compile_(b)})}function DESC(a){return DescExpr.isInstance(a)?a.arg1:DescExpr.create({arg1:a})}function anop(a){a&&a(void 0)}function alog(){var a=arguments;return function(b){console.log.apply(console,a),b&&b.apply(this,[].shift.call(arguments))}}function aprofile(a){return function(b){var c=argsToArray(arguments);console.profile();var d=function(){console.profileEnd(),b&&b(arguments)};aapply_(a,d,c)}}function aconstant(a){return function(b){b&&b(a)}}function arepeat(a,b){return a?function(c){var d=argsToArray(arguments);d.splice(1,0,0,a);var e=atramp(function(){return d[1]==a-1?(d[0]=c,void b.apply(this,d)):(b.apply(this,d),void d[1]++)});d[0]=e,e.apply(this,d)}:anop}function aforEach(){}function awhile(a,b){return function(c){var d=argsToArray(arguments),e=function(){return a()?void b.apply(this,d):void c.apply(void 0,arguments)};d[0]=e,e.apply(this,d)}}function aif(a,b,c){return function(d){a?b.apply(this,arguments):c?c.apply(this,arguments):d()}}function asleep(a){return function(b){window.setTimeout(b,a)}}function afuture(){var a=!1,b=void 0,c=[];return{set:function(){if(a)return void console.log("ERROR: redundant set on future");b=arguments,a=!0;for(var d=0;d<c.length;d++)c[d].apply(null,b);c=void 0},get:function(d){return a?void d.apply(null,b):void c.push(d)}}}function aapply_(a,b,c){c.unshift(b),a.apply(this,c)}function asynchronized(a,b){function c(a){return function(){var b=d.q.shift();b?setTimeout(b,0):d.active=!1,a()}}var d=b||{};return d.q||(d.q=[],d.active=!1),function(b){return d.active?void d.q.push(function(){a(c(b))}):(d.active=!0,void a(c(b)))}}function atimeout(a,b,c){return function(d){var e=!1,f=!1;setTimeout(function(){f||(e=!0,console.log("timeout"),c&&c())},a),b(aseq(function(a){e||(f=!0),f&&a()},d))}}function amemo(a){var b,c,d=!1;return function(e){if(d)return void e.apply(null,b);var f=!c;f&&(c=[]),c.push(e),f&&a(function(){b=arguments;for(var e=0;e<c.length;e++)c[e]&&c[e].apply(null,b);a=void 0,d=!0,c=void 0})}}function amerged(a){var b;return function(c){var d=!b;if(d){b=[];var e=argsToArray(arguments)}b.push(c),d&&(e[0]=function(){var a=b;b=void 0;for(var c=0;c<a.length;c++)a[c]&&a[c].apply(null,arguments)},a.apply(null,e))}}function ao(){for(var a=arguments[arguments.length-1],b=0;b<arguments.length-1;b++)a=arguments[b].ao(a);return a}function aseq(){for(var a=arguments[arguments.length-1],b=arguments.length-2;b>=0;b--)a=arguments[b].aseq(a);return a}function apar(){var a=[],b=0,c=arguments;return function(d){if(0==c.length)return void(d&&d());for(var e=Array.prototype.splice.call(arguments,1),f=function(e){if(a[e]=Array.prototype.splice.call(arguments,1),++b==c.length){for(var f=[],g=0;g<c.length;g++)for(var h=0;h<a[g].length;h++)f.push(a[g][h]);d&&d.apply(null,f)}},g=0;g<c.length;g++)c[g].apply(null,[f.bind(null,g)].concat(e))}}function arepeatpar(a,b){return function(c){for(var d=0,e=Array.prototype.splice.call(arguments,1),f=function(){if(++d==a){var b=[];c&&c.apply(null,b)}},g=0;a>g;g++)b.apply(null,[f.bind(null,g)].concat([g,a]).concat(e))}}function axhr(a,b,c){var d=b||"GET",e=c||[];return function(b){var c=new XMLHttpRequest;c.open(d,a),c.asend(function(a){b(JSON.parse(a))},e&&e.join("&"))}}function futurefn(a){return function(){var b=arguments;a.get(function(a){a.apply(void 0,b)})}}function filteredDAO(a,b){return a===TRUE?b:{__proto__:b,select:function(c,d){return b.select(c,d?{__proto__:d,query:d.query?AND(a,d.query):a}:{query:a})},removeAll:function(c,d){return b.removeAll(c,d?{__proto__:d,query:d.query?AND(a,d.query):a}:{query:a})},listen:function(c,d){return b.listen(c,d?{__proto__:d,query:d.query?AND(a,d.query):a}:{query:a})}}}function orderedDAO(a,b){return{__proto__:b,select:function(c,d){return d?d.order||(d={__proto__:d,order:a}):d={order:a},b.select(c,d)}}}function limitedDAO(a,b){return{__proto__:b,select:function(c,d){return d=d?"limit"in d?{__proto__:d,limit:Math.min(a,d.limit)}:{__proto__:d,limit:a}:{limit:a},b.select(c,d)}}}function skipDAO(a,b){return{__proto__:b,select:function(c,d){return d=d?{__proto__:d,skip:a}:{__proto__:d,skip:a},b.select(c,d)}}}function atxn(a){return function(b){if(GLOBAL.__TXN__)a.apply(this,arguments);else{GLOBAL.__TXN__={};var c=argsToArray(arguments);c[0]=function(){GLOBAL.__TXN__=void 0,b()},a.apply(this,c)}}}function dump(a){return Array.isArray(a)?"["+a.map(dump).join(",")+"]":a?a.toString():"<undefined>"}function pos(a,b,c,d,e){a.style;c=c||0,null!=b&&(a.style.top=toNum(b)+"px"),null!=c&&(a.style.left=toNum(c)+"px"),null!=d&&(a.style.width=toNum(d)+"px"),null!=e&&(a.style.height=toNum(e)+"px")}function outProtobufPrimitive(a,b,c,d){switch(a){case"String":case"string":case"bytes":d.varint(b<<3|2),bytes=stringtoutf8(c),d.varint(bytes.length),d.bytes(bytes);break;case"Int":case"uint64":case"int64":case"uint32":case"int32":d.varint(b<<3),c instanceof String||"string"==typeof c?d.varintstring(c):d.varint(c);break;case"bool":case"boolean":case"Boolean":d.varint(b<<3),d.varint(Number(c));break;default:c&&c.model_&&(d.varint(b<<3|2),d.message(c))}}function varint(a){var b=function(b){for(var c=[];b;){var d=b.head;if(null==d)return void 0;if(c.push(127&d),b=b.tail,!(128&d))break}for(var e=0,f=0;f<c.length;f++)e+=c[f]*Math.pow(2,7*f);return void 0!=a&&e!=a?void 0:b.setValue(e)};return b.toString=function(){return"varint("+a+")"},b}function varintstring(a){var b=function(b){for(var c=[];b;){var d=b.head;if(null==d)return void 0;if(c.push(127&d),b=b.tail,!(128&d))break}for(var e=0,f=[],g=0,h=0;h<c.length;h++)for(e+=c[h]*Math.pow(2,7*h-8*g);e>255;)f.unshift((255&e).toString(16)),0==f[0].length?f[0]="00":1==f[0].length&&(f[0]="0"+f[0]),g++,e>>=8;return(e>0||0==f.length)&&(f.unshift(e.toString(16)),0==f[0].length?f[0]="00":1==f[0].length&&(f[0]="0"+f[0])),f=f.join(""),void 0!=a&&f!=a?void 0:b.setValue(f)};return b.toString=function(){return"varintstring("+a+")"},b}function varintkey(a,b){var c=varint(),d=function(d){if(!(d=this.parse(c,d)))return void 0;var e=7&d.value,f=d.value>>3;return void 0!=a&&a!=f||void 0!=b&&b!=e?void 0:d.setValue([f,e])};return d.toString=function(){return"varintkey("+a+", "+b+")"},d}function toboolean(a){return function(b){return(b=this.parse(a,b))?b.setValue(!!b.value):void 0}}function index(a,b){return function(c){return(c=this.parse(b,c))?c.setValue(c.value[a]):void 0}}function protouint32(a){return seq(varintkey(a,0),varint())}function protovarintstring(a){return seq(varintkey(a,0),varintstring())}function protoint32(a){return protouint32(a)}function protobool(a){return seq(varintkey(a,0),toboolean(varint()))}function protobytes(a){var b=seq(varintkey(a,2),varint()),c=function(a){if(!(a=this.parse(b,a)))return void 0;var c=a.value,d=c[1];return(a=this.parse(repeat(anyChar,void 0,d,d),a))?a.setValue([c[0],a.value]):void 0};return c.toString=function(){return"protobytes("+a+")"},c}function protobytes0(a){var b=seq(varintkey(a,2),varint()),c=function(a){if(!(a=this.parse(b,a)))return void 0;for(var c=a.value,d=c[1];d--;)a=a.itail;return a.setValue([c,void 0])};return c.toString=function(){return"protobytes0("+a+")"},c}function protostring(a){var b=seq(varintkey(a,2),varint()),c=IncrementalUtf8.create(),d=function(a){if(!(a=this.parse(b,a)))return void 0;for(var d=a.value,e=d[1],f=0;e>f;f++){var g=a.head;if(!g)return void c.reset();c.put(a.head),a=a.itail}var h=a.setValue([d[0],c.string]);return c.reset(),h};return d.toString=function(){return"protostring("+a+")"},d}function protomessage(a,b){var c=seq(varintkey(a,2),varint()),d=function(a){if(!(a=this.parse(c,a)))return void 0;var d=a.value[0],e=a.value[1];b=b||repeat(anyChar);var f=a.limit(a.pos+e+1),g=this.parse(b,a);return g?(g.limit(f),g.setValue([d,g.value])):void a.limit(f)};return d.toString=function(){return"protomessage("+a+")"},d}function lazyEval(a){var b;return function(){return b||(b=a.call(this)),b}}navigator&&-1!=navigator.userAgent.indexOf("Firefox")&&(console.log("Loading Firefox Support."),Object.defineProperties(MouseEvent.prototype,{offsetX:{get:function(){return this.clientX-this.target.getBoundingClientRect().left}},offsetY:{get:function(){return this.clientY-this.target.getBoundingClientRect().top}}}));var DEBUG=!1,DEBUG_STACK=DEBUG?function(){return(new Error).stack}:function(){return"Set DEBUG = true in stdlib.js for stacktrace."},GLOBAL=GLOBAL||this;String.prototype.startsWith||(String.prototype.startsWith=function(a){return 0==this.lastIndexOf(a,0)}),String.prototype.equalsIC=function(a){return a&&this.toUpperCase()===a.toUpperCase()},String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},String.prototype.labelize=function(){return this.replace(/[a-z][A-Z]/g,function(a){return a.charAt(0)+" "+a.charAt(1)}).capitalize()},String.prototype.constantize=function(){return this.replace(/[a-z][^a-z]/g,function(a){return a.substring(0,1)+"_"+a.substring(1,2)}).toUpperCase()},Object.defineProperty(Object.prototype,"$UID",{get:function(){var a=1;return function(){return this.$UID__||(this.$UID__=a++)}}()}),Object.defineProperty(Object.prototype,"clone",{value:function(){return this},writable:!0}),Object.defineProperty(Object.prototype,"deepClone",{value:function(){return this.clone()},writable:!0}),Object.defineProperty(Object.prototype,"become",{value:function(a){for(var b=Object.getOwnPropertyNames(this),c=0;c<b.length;c++)delete this[b[c]];var d=Object.getOwnPropertyNames(a);for(c=0;c<d.length;c++)Object.defineProperty(this,d[c],Object.getOwnPropertyDescriptor(a,d[c]));this.__proto__=a.__proto__}}),Function.prototype.bind=function(){var a=Function.prototype.bind,b=function(a,b){var c=function(){return a.apply(b,arguments)};return c.toString=function(){return a.toString()},c};return function(c){return 1==arguments.length?b(this,c):a.apply(this,argsToArray(arguments))}}(),Date.prototype.toRelativeDateString=function(){var a=Math.floor((Date.now()-this.getTime())/1e3);if(60>a)return"moments ago";var b=Math.floor(a/60);if(1==b)return"1 minute ago";if(60>b)return b+" minutes ago";var c=Math.floor(b/60);if(1==c)return"1 hour ago";if(24>c)return c+" hours ago";var d=Math.floor(c/24);if(1==d)return"1 day ago";if(7>d)return d+" days ago";if(365>d){var e=1900+this.getYear(),f=this.toDateString().replace(" "+e,"");return f.substring(4)}return this.toDateString().substring(4)},Date.prototype.compareTo=function(a){if(a===this)return 0;var b=this.getTime()-a.getTime();return 0==b?0:b>0?1:-1},Date.prototype.toMQL=function(){return this.getFullYear()+"/"+(this.getMonth()+1)+"/"+this.getDate()},String.prototype.compareTo=function(a){return a==this?0:a>this?-1:1},Number.prototype.compareTo=function(a){return a==this?0:a>this?-1:1},Boolean.prototype.compareTo=function(a){return(this.valueOf()?1:0)-(a?1:0)};var argsToArray=function(a){for(var b=new Array(a.length),c=0;c<a.length;c++)b[c]=a[c];return b},StringComparator=function(a,b){return a==b?0:b>a?-1:1},toCompare=function(a){return Array.isArray(a)?CompoundComparator.apply(null,a):a.compare?a.compare.bind(a):a};Object.defineProperty(Array.prototype,"binaryInsert",{value:function(a){for(var b=0,c=this.length-1;c>=b;){var d=b+Math.floor((c-b)/2),e=a.compareTo(this[d]);if(0==e)return this;0>e?c=d-1:b=d+1}return this.splice(b,0,a),this}}),Object.defineProperty(Array.prototype,"intern",{value:function(){for(var a=0;a<this.length;a++)this[a].intern&&(this[a]=this[a].intern());return this}}),Object.defineProperty(Array.prototype,"compareTo",{value:function(a){if(this.length!==a.length)return-1;for(var b=0;b<this.length;b++){var c=this[b].compareTo(a[b]);if(0!==c)return c}return 0}}),Object.defineProperty(Array.prototype,"fReduce",{value:function(a,b){compare=toCompare(a);for(var c=[],d=0,e=0,f=0;d<this.length&&e<b.length;){var g=compare(this[d],b[e]);0>g?c[f++]=this[d++]:0!=g?c[f++]=b[e++]:(c[f++]=this[d++],c[f++]=b[e++])}return d!=this.length&&(c=c.concat(this.slice(d))),e!=b.length&&(c=c.concat(b.slice(e))),c}});var CompoundComparator=function(){for(var a=arguments,b=0;b<a.length;b++)a[b]=toCompare(a[b]);return function(b,c){for(var d=0;d<a.length;d++){var e=a[d](b,c);if(0!=e)return e}return 0}};Object.defineProperty(Array.prototype,"pushAll",{value:function(a){return this.push.apply(this,a),this.length}}),console.log.json=function(){for(var a=[],b=0;b<arguments.length;b++){var c=arguments[b];a.push(c&&c.toJSON?c.toJSON():c)}console.log.apply(console,a)},console.log.str=function(){for(var a=[],b=0;b<arguments.length;b++){var c=arguments[b];a.push(c&&c.toString?c.toString():c)}console.log.apply(console,a)},console.log.put=console.log.bind(console),console.log.remove=console.log.bind(console,"remove: "),console.log.error=console.log.bind(console,"error: "),console.log.json.put=console.log.json.bind(console),console.log.json.reduceI=console.log.json.bind(console,"reduceI: "),console.log.json.remove=console.log.json.bind(console,"remove: "),console.log.json.error=console.log.json.bind(console,"error: "),console.log.str.put=console.log.str.bind(console),console.log.str.remove=console.log.str.bind(console,"remove: "),console.log.str.error=console.log.str.bind(console,"error: "),document.put=function(a){a.write?a.write(this):this.write(a.toString())},String.prototype.put=function(a){return this+a.toJSON()},window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem,window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame,window.Blob&&(Blob.prototype.slice=Blob.prototype.slice||Blob.prototype.webkitSlice),String.prototype.intern=function(){var a={};return function(){return a[this]||(a[this]=this.toString())}}(),window.XMLHttpRequest&&(XMLHttpRequest.prototype.asend=function(a,b){var c=this;c.onerror=function(){console.log("XHR Error: ",arguments)},c.onloadend=function(){a(c.response,c)},c.send(b)}),RegExp.quote=function(a){return(a+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")};var FeatureSet={create:function(){var a=Object.create(this);return a.a_=[],a.version_=1,a.parentVersion_=0,a.names_={},a},where:function(a){return{__proto__:this,forEach:function(b){return this.__proto__.forEach.call(this,function(c){a(c)&&b(c)})},localForEach:function(b){return this.__proto__.localForEach.call(this,function(c){a(c)&&b(c)})}}},forEach:function(a){var b=this;this.parent&&this.parent.where(function(a){return!a.name||!b.names_[a.name]}).forEach(a),this.localForEach(a)},localForEach:function(a){for(var b=0;b<this.a_.length;b++){var c=this.a_[b];c.name&&c!==this.names_[c.name]||a(this.a_[b])}},add:function(a){a.name&&(this.names_[a.name]=a),this.a_.push(a),this.version_++},get parent(){return this.parent_},set parent(a){this.parent_=a},get version(){return this.version_}},SourceBlob=function(a,b,c,d){for(var e=c||0,f=d||147456;e<a.size;){var g=Math.min(f,a.size-e);b.put(a.slice(e,e+g)),e+=g}b&&b.eof&&b.eof()},BlobToText=function(a){function b(){d.readAsText(c[0])}var c=[],d=new FileReader;return d.onload=function(){a.put&&a.put(d.result),c.shift(),c.length&&b()},d.onerror=function(b){a.error&&a.error(b)},{__proto__:a,put:function(a){c.push(a),1==c.length&&b()}}},TextToLines=function(a){var b=void 0,c=function(a){for(var b=[],c=0,d=0;d<a.length;d++)10==a.charCodeAt(d)&&(b.push(a.slice(c,d+1)),c=d+1);return b.push(a.slice(c)),b};return{__proto__:a,put:function(d){var e,f=c(d),g=f[f.length-1];for(i=0;i<f.length-1;i++)b?(e=b+f[i],b=void 0):e=f[i],a.put(e);b=b?b+g:g},eof:function(){b&&a.put(b),a.eof&&a.eof()}}},BlobReader={create:function(a,b,c){return{__proto__:this,blob:a,buffersize:b||2048,position:c||0}},nextSlice_:function(){if(this.position>=this.blob.size)return null;var a=this.blob,b=Math.min(this.buffersize,this.blob.size-this.position);return a=this.blob.slice(this.position,this.position+b),this.position+=b,a},read:function(a){return(slice=this.nextSlice_())?void(a.put&&a.put(slice)):void(a.eof&&a.eof())}},TextReader={create:function(a){return{__proto__:this,reader:a}},read:function(a){var b={__proto__:a,put:function(a){var b=new FileReader,c=this;b.readAsText(a),b.onload=function(){c.__proto__.put&&c.__proto__.put(b.result)},b.onerror=function(a){c.__proto__.error&&c.__proto__.error(a)}}};this.reader.read(b)}},LineBasedReader={create:function(a){return{__proto__:this,reader:a,index:0,buffer:""}},emitLine_:function(){for(;this.index<this.buffer.length;this.index++)if("\n"==this.buffer[this.index]){this.index++;var a=this.buffer.slice(0,this.index);return this.buffer=this.buffer.slice(this.index),this.index=0,this.sink.put&&this.sink.put(a),!0}return!1},read:function(a){this.sink=a,this.emitLine_()||this.reader.read(this)},put:function(a){this.buffer+=a,this.emitLine_()||this.reader.read(this)},eof:function(){this.sink.eof&&this.sink.eof()}},FullReader={create:function(a){return{__proto__:this,reader:a}},read:function(a){var b=this.reader,c={__proto__:a,put:function(a){this.__proto__.put(a),b.read(this)}};b.read(c)}},AsBlobReader={create:function(a){return{__proto__:this,reader:a}},read:function(a){var b={__proto__:a,put:function(a){this.__proto__.put&&this.__proto__.put(new Blob([a]))}};this.reader.read(b)}},SocketReader={create:function(a,b){return{__proto__:this,socket:a,buffersize:b||2048}},read:function(a){chrome.socket.read(this.socket.socketId,function(b){return b.resultCode<0?void(a.error&&a.error(b.resultCode)):(0==b.resultCode&&a.eof&&a.eof(),void a.put(b.data))})}},ProtoWriter={create:function(){return{__proto__:this,value_:[]}},get value(){return new Uint8Array(this.value_)},varint:function(a){for(;a>127;)this.value_.push(127&a|128),a=Math.floor(a/Math.pow(2,7));this.value_.push(a)},bytes:function(a){this.value_=this.value_.concat(a)},varintstring:function(a){for(var b=[],c=a.length-2;c>-2;c-=2){var d=0>c?a.substr(0,1):a.substr(c,2);b.push(parseInt(d,16))}for(var e=0,c=0;c<b.length-1;c++)e>>>=7,e|=b[c]<<c,this.value_.push(127&e|128);e>>>=7,e|=b[c]<<c,this.varint(e)},bytestring:function(a){for(var b=[],c=0;c<a.length;c+=2)b.push(parseInt(a.substr(c,2),16));this.bytes(b)},message:function(a){{var b=ProtoWriter.create();a.outProtobuf(b)}b=b.value_,this.varint(b.length),this.bytes(b)}},SocketManager={create:function(){return{__proto__:this}},get:function(a){var b=a.split(":"),c=b[0],d=b[1],e=parseInt(b[2]);return amemo(function(a){chrome.socket.create(c,{},function(b){chrome.socket.connect(b.socketId,d,e,function(c){return 0==c?void a({socketId:b.socketId}):void a(null)})})})}};String.prototype.hashCode=function(){var a=0;if(0==this.length)return a;for(i=0;i<this.length;i++){var b=this.charCodeAt(i);a=(a<<5)-a+b,a&=a}return a};var Base64Decoder={lookup:function(a){var b=a.charCodeAt(0);return 43==b?62:47==b?63:58>b?b+4:91>b?b-65:b-71},create:function(a,b){return b=b||512,{__proto__:this,bufsize:b,buffer:new ArrayBuffer(b),pos:0,chunk:3,sink:a}},put:function(a){var b=0;this.view=new DataView(this.buffer);for(var c=0;c<a.length&&"="!=a[c];c++){var d=this.lookup(a[c]);void 0!==d&&(b|=d<<6*this.chunk,0==this.chunk?(this.emit(3,b),b=0,this.chunk=3):this.chunk--)}"="==a[c]&&(c++,c<a.length?"="==a[c]&&this.emit(1,b):this.emit(2,b))},emit:function(a,b){for(var c=0;a>c;c++)this.view.setUint8(this.pos,b>>8*(2-c)&255),this.pos++,this.pos>=this.buffer.byteLength&&(this.sink.put(this.buffer),this.buffer=new ArrayBuffer(this.bufsize),this.view=new DataView(this.buffer),this.pos=0)},eof:function(){this.sink.put(this.buffer.slice(0,this.pos)),this.sink.eof&&this.sink.eof()}},Base64Encoder={table:["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],encode:function(a,b){var c="";if(b>=0)var d=0,e=function(a){c+=a,d=(d+1)%b,0==d&&(c+="\r\n")};else e=function(a){c+=a};for(var f=0;f+2<a.byteLength;f+=3)e(this.table[a[f]>>>2]),e(this.table[(3&a[f])<<4|a[f+1]>>>4]),e(this.table[(15&a[f+1])<<2|a[f+2]>>>6]),e(this.table[63&a[f+2]]);return f<a.byteLength&&(e(this.table[a[f]>>>2]),f+1<a.byteLength?(e(this.table[(3&a[f])<<4|a[f+1]>>>4]),e(this.table[(15&a[f+1])<<2])):(e(this.table[(3&a[f])<<4]),e("=")),e("=")),c}},QuotedPrintable={encode:function(){},decode:function(a,b){for(var c="",d=function(a){"="===a?f=e:c+=a},e=function(){var a="",e=0;return function(g){return"\r"===g||"\n"===g?(e=0,void(f=d)):(a+=g,e++,void(2==e&&(b.put(parseInt(a,16)),0==b.remaining&&(c+=b.string,b.reset()),a="",e=0,f=d)))}}(),f=d,g=0;g<a.length;g++)f(a[g]);return c}};String.fromCharCode=function(){var a=String.fromCharCode,b=[];return function(c){if(1==arguments.length)return b[c]||(b[c]=a(c));for(var d="",e=0;e<arguments.length;e++)d+=b[arguments[e]]||(b[arguments[e]]=a(arguments[e]));return d}}();var IncrementalUtf8={create:function(){return{__proto__:this,charcode:void 0,remaining:0,string:""}},reset:function(){this.string="",this.remaining=0,this.charcode=void 0},put:function(a){if(void 0==this.charcode)if(this.charcode=a,128&this.charcode)if(192==(224&this.charcode))this.remaining=1,this.charcode=(31&a)<<6*this.remaining;
else if(224==(240&this.charcode))this.remaining=2,this.charcode=(15&a)<<6*this.remaining;else if(240==(248&this.charcode))this.remaining=3,this.charcode=(7&a)<<6*this.remaining;else if(248==(252&this.charcode))this.remaining=4,this.charcode=(3&a)<<6*this.remaining;else{if(252!=(254&this.charcode))throw"Bad charcode value";this.remaining=5,this.charcode=(1&a)<<6*this.remaining}else this.remaining=0,this.charcode=(127&a)<<6*this.remaining;else this.remaining>0&&(this.remaining--,this.charcode|=(63&a)<<6*this.remaining);0==this.remaining&&(this.string+=String.fromCharCode(this.charcode),this.charcode=void 0)}},utf8tostring=function(){var a=IncrementalUtf8.create();return function(b){for(var c=0;c<b.length;c++)a.put(b[c]);var d=a.string;return a.reset(),d}}(),StringPS={create:function(a){return{__proto__:this,pos:0,str_:[a],tail_:[]}},set str(a){this.str_[0]=a},get head(){return this.pos>=this.str_[0].length?null:this.str_[0].charAt(this.pos)},get value(){return this.hasOwnProperty("value_")?this.value_:this.str_[0].charAt(this.pos-1)},get tail(){return this.tail_[0]||(this.tail_[0]={__proto__:this.__proto__,str_:this.str_,pos:this.pos+1,tail_:[]})},setValue:function(a){return{__proto__:this.__proto__,str_:this.str_,pos:this.pos,tail_:this.tail_,value_:a}}},DEBUG_PARSE=!1,grammar={parseString:function(a){var b=this.stringPS;b.str=a;var c=this.parse(this.START,b);return c&&c.value},parse:function(a,b){DEBUG_PARSE&&b.str_&&(console.log(new Array(b.pos).join("."),b.head),console.log(b.pos+"> "+b.str_[0].substring(0,b.pos)+"("+b.head+")"));var c=a.call(this,b);return DEBUG_PARSE&&console.log(a+" ==> "+!!c+"  "+(c&&c.value)),c},"export":function(a){return this[a].bind(this)},addAction:function(a,b){var c=this[a];this[a]=function(a){var d=a.value,e=this.parse(c,a);return e&&e.setValue(b.call(this,e.value,d))},this[a].toString=function(){return"<<"+a+">>"}},addActions:function(a){for(var b in a)this.addAction(b,a[b]);return this}};defineTTLProperty(grammar,"stringPS",5e3,function(){return StringPS.create("")});var SkipGrammar={create:function(a,b){return{__proto__:a,skip_:!0,parse:function(a,b){return this.skip_&&(b=this.skip.call(grammar,b)||b),this.__proto__.parse.call(this,a,b)},skip:b}}},EventService={UNSUBSCRIBE_EXCEPTION:"unsubscribe",WILDCARD:"*",oneTime:function(a){return function(){throw a.apply(this,argsToArray(arguments)),EventService.UNSUBSCRIBE_EXCEPTION}},consoleLog:function(a){return function(){var b=argsToArray(arguments);console.log(b),a.apply(this,b)}},merged:function(a,b,c){var d=b||16;return function(){var b=null,e=!1,f=!1,g=null,h=function(){if(b=DEBUG_STACK(),g=arguments,f)throw EventService.UNSUBSCRIBE_EXCEPTION;e||(e=!0,(c&&c.setTimeout||setTimeout)(function(){e=!1;var b=argsToArray(g);g=null;try{a.apply(this,b)}catch(c){c===EventService.UNSUBSCRIBE_EXCEPTION&&(f=!0)}},d))};return h.toString=function(){return"MERGED("+d+", "+a.$UID+", "+a+")"},h}()},animate:function(a,b){return function(){var c=null,d=!1,e=!1,f=null,g=function(){if(c=DEBUG_STACK(),f=arguments,e)throw EventService.UNSUBSCRIBE_EXCEPTION;d||(d=!0,(b&&b.requestAnimationFrame||requestAnimationFrame)(function(){d=!1;var b=argsToArray(f);f=null;try{a.apply(this,b)}catch(c){c===EventService.UNSUBSCRIBE_EXCEPTION&&(e=!0)}}))};return g.toString=function(){return"ANIMATE("+a.$UID+", "+a+")"},g}()},async:function(a){return this.delay(0,a)},delay:function(a,b){return function(){var c=argsToArray(arguments);setTimeout(function(){b.apply(this,c)},a)}},hasListeners:function(){return!0},publish:function(a){return this.subs_?this.pub_(this.subs_,0,a,this.appendArguments([this,a],arguments,1)):0},publishAsync:function(){var a=argsToArray(arguments),b=this;setTimeout(function(){b.publish.apply(b,a)},0)},deepPublish:function(){return this.publish.apply(this,arguments)},lazyPublish:function(a,b){return this.hasListeners(a)?this.publish.apply(this,b()):0},subscribe:function(a,b){this.subs_||(this.subs_={}),this.sub_(this.subs_,0,a,b)},unsubscribe:function(a,b){this.subs_&&this.unsub_(this.subs_,0,a,b)},unsubscribeAll:function(){this.sub_={}},pub_:function(a,b,c,d){var e=0;if(null==a)return 0;if(b<c.length){var f=c[b];if(f==this.WILDCARD)return this.notifyListeners_(c,a,d);f&&(e+=this.pub_(a[f],b+1,c,d))}return e+=this.notifyListeners_(c,a[null],d)},sub_:function(a,b,c,d){if(b==c.length)a[null]||(a[null]=[]),a[null].push(d);else{var e=c[b];a[e]||(a[e]={}),this.sub_(a[e],b+1,c,d)}},unsub_:function(a,b,c,d){if(b==c.length){if(!a[null])return!0;a[null].deleteI(d)||console.warn("phantom unsubscribe"),a[null].length||delete a[null]}else{var e=c[b];if(!a[e])return!1;this.unsub_(a[e],b+1,c,d)&&delete a[e]}return 0==Object.keys(a).length},notifyListeners_:function(a,b,c){if(null==b)return 0;if(Array.isArray(b)){for(var d=0;d<b.length;d++){var e=b[d];try{e.apply(null,c)}catch(f){f!==this.UNSUBSCRIBE_EXCEPTION?console.error("Error delivering event (removing listener): ",a.join(".")):console.warn("Unsubscribing listener: ",a.join(".")),b.splice(d,1),d--}}return b.length}for(var g in b)return this.notifyListeners_(a,b[g],c)},appendArguments:function(a,b,c){for(var d=c;d<b.length;d++)a.push(b[d]);return a}},PropertyChangeSupport={__proto__:EventService,PROPERTY_TOPIC:"property",propertyTopic:function(a){return[this.PROPERTY_TOPIC,a]},propertyChange:function(a,b,c){this.subs_&&(null==a||b!==c)&&this.publish(this.propertyTopic(a),b,c)},propertyChange_:function(a,b,c){this.subs_&&b!==c&&this.publish(a,b,c)},globalChange:function(){this.publish(this.propertyTopic(this.WILDCARD),null,null)},addListener:function(a){this.addPropertyListener(null,a)},removeListener:function(a){this.removePropertyListener(null,a)},addPropertyListener:function(a,b){this.subscribe(this.propertyTopic(a),b)},removePropertyListener:function(a,b){this.unsubscribe(this.propertyTopic(a),b)},propertyValue:function(a){var b=this;return{$UID:b.$UID+"."+a,get:function(){return b[a]},set:function(c){b[a]=c},get value(){return this.get()},set value(a){this.set(a)},addListener:function(c){b.addPropertyListener(a,c)},removeListener:function(c){b.removePropertyListener(a,c)},toString:function(){return"PropertyValue("+a+")"}}}},FunctionStack={create:function(){var a=[!1];return{stack:a,push:function(b){a.unshift(b)},pop:function(){a.shift()}}}},Events={listeners_:{},identity:function(a){return a},follow:function(a,b){if(a&&b){var c=function(){var c=a.get(),d=b.get();c!==d&&b.set(c)};a.addListener(c),c()}},map:function(a,b,c){if(a&&b){var d=function(){var d=c(a.get()),e=b.get();d!==e&&b.set(d)};d(),a.addListener(d)}},unfollow:function(a,b){if(a&&b){var c=[a.$UID,b.$UID],d=this.listeners_[c];d&&(delete this.listeners_[c],a.removeListener(d))}},link:function(a,b){a&&b&&(this.follow(a,b),this.follow(b,a))},relate:function(a,b,c,d,e){if(a&&b){var f=!1,g=function(a,b,c){return function(){if(!e||!f){var d=c(a.get()),g=b.get();d!==g&&(f=!0,b.set(d),f=!1)}}},h=g(a,b,c),i=g(b,a,d);a.addListener(h),b.addListener(i),h()}},unlink:function(a,b){this.unfollow(a,b),this.unfollow(b,a)},dynamic:function(a,b,c){var d=b?function(){b(a())}:a,e=EventService.animate(d,c);Events.onGet.push(function(a,b){a.propertyValue(b).addListener(e)});var f=a();Events.onGet.pop(),b&&b(f)},onSet:FunctionStack.create(),onGet:FunctionStack.create()};Function.prototype.o=function(a){var b=this;return function(){return b.call(this,a.apply(this,argsToArray(arguments)))}};var Movement={distance:function(a,b){return Math.sqrt(a*a+b*b)},o:function(a,b){return function(c){return a(b(c))}},avg:function(a,b){return function(c){return(a(c)+b(c))/2}},linear:function(a){return a},back:function(a){return.5>a?2*a:2-2*a},accelerate:function(a){return(Math.sin(a*Math.PI-Math.PI/2)+1)/2},easeIn:function(a){var b=1/(1-a/2);return function(c){var d=Math.min(c,a),e=Math.max(c-a,0);return(a?.5*d*(d/a)*b:0)+e*b}},reverse:function(a){return function(b){return 1-a(1-b)}},easeOut:function(a){return Movement.reverse(Movement.easeIn(a))},oscillate:function(a,b,c){var d=c||3;return function(c){if(1-a>c)return c/(1-a);var e=(c-1+a)/a;return 1+2*(1-e)*b*Math.sin(2*d*Math.PI*e)}},bounce:function(a,b,c){var d=c||3;return function(c){if(1-a>c)return c/(1-a);var e=(c-1+a)/a;return 1-2*(1-e)*b*Math.abs(Math.sin(2*d*Math.PI*e))}},bounce2:function(a){var b=1/(1-a);return function(c){if(1-a>c)return b*c;return 1-(c-1+a)*b/2}},stepBack:function(a){return function(b){return a>b?-b:-2*a+(1+2*a)*b}},ease:function(a,b){return Movement.o(Movement.easeIn(a),Movement.easeOut(b))},seq:function(a,b){return a&&b?function(){a.apply(this,argsToArray(arguments)),b()}:a?a:b},animate:function(a,b,c,d){if(0==a)return Movement.seq(b,d);var e=c||Movement.linear;return function(){function c(){clearInterval(f),d&&d(),d=null}var f,g=(DEBUG_STACK(),[]);b&&(Events.onSet.push(function(a,b,c){g.push([a,b,a[b],c])}),b.apply(this,argsToArray(arguments)),Events.onSet.pop());var h=Date.now();return g.length>0&&(f=setInterval(function(){for(var b=Date.now(),d=e((Math.min(b,h+a)-h)/a),f=0;f<g.length;f++){var i=g[f],j=i[0],k=i[1],l=i[2],m=i[3];j[k]=l+(m-l)*d}b>=h+a&&c()},16)),c}},compile:function(a,b){function c(){}function d(a){return Array.isArray(a)&&0==a[0]}function e(a,b){return function(){document.onclick=function(){document.onclick=null,b()}}}function f(a){return Array.isArray(a)&&"number"==typeof a[0]}function g(a,b){return a[3]=Movement.seq(a[3],b),function(){Movement.animate.apply(null,a)()}}function h(a){return Array.isArray(a)&&Array.isArray(a[0])}function i(a,b){var c=function(a){return function(){--a||b()}}(a.length);return function(){for(var b=0;b<a.length;b++)f(a[b])?Movement.animate(a[b][0],a[b][1],a[b][2],Movement.seq(a[b][3],c))():Movement.compile(a[b],c)()}}function j(a,b){return Movement.seq(a,b)}function k(a,l){if(l>=a.length)return b||c;var m=k(a,l+1),n=a[l];return d(n)?e(n,m):f(n)?g(n,m):h(n)?i(n,m):j(n,m)}return k(a,0)},onIntersect:function(){},stepTowards:function(a,b,c){var d=a.x-b.x,e=a.y-b.y,f=Math.atan2(e,d),g=Math.sqrt(d*d+e*e);g=0>g?Math.max(-c,g):Math.min(c,g),b.x+=g*Math.cos(-f),b.y-=g*Math.sin(-f)},moveTowards:function(a,b,c,d){var e=b.propertyValue("x"),f=b.propertyValue("y"),g=c.propertyValue("x"),h=c.propertyValue("y");a.addListener(function(){var a=e.get()-g.get(),b=f.get()-h.get(),c=Math.atan2(b,a),i=Math.sqrt(a*a+b*b);i=0>i?Math.max(-d,i):Math.min(d,i),g.set(g.get()+i*Math.cos(-c)),h.set(h.get()-i*Math.sin(-c))})},orbit:function(a,b,c,d,e){var f=b.x$,g=b.y$,h=c.x$,i=c.y$;a.addListener(EventService.animate(function(){var b=a.time;h.set(f.get()+d*Math.sin(b/e*Math.PI*2)),i.set(g.get()+d*Math.cos(b/e*Math.PI*2))}))}},AbstractFormatter={where:function(a){return{__proto__:this,p:a.f&&a.f.bind(a)||a}},p:function(){return!0}},JSONUtil={keyify:function(a){return'"'+a+'"'},escape:function(a){return a.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/[\x00-\x1f]/g,function(a){return"\\u00"+(a.charCodeAt(0)<16?"0"+a.charCodeAt(0).toString(16):a.charCodeAt(0).toString(16))})},parseToMap:function(str){return eval("("+str+")")},parse:function(a){return this.mapToObj(this.parseToMap(a))},arrayToObjArray:function(a,b){for(var c=0;c<a.length;c++)a[c]=this.mapToObj(a[c],b);return a},mapToObj:function(a,b){if(!a||"object"==typeof a.model_)return a;if(Array.isArray(a))return this.arrayToObjArray(a);if(a instanceof Function)return a;if(a instanceof Date)return a;if(a instanceof Object){var c=0;for(var d in a)"model_"!=d&&"prototype_"!=d&&(a[d]=this.mapToObj(a[d])),c++;return b&&!a.model_?b.create(a):GLOBAL[a.model_]?GLOBAL[a.model_].create(a):a}return a},compact:{__proto__:AbstractFormatter,stringify:function(a){var b="";return this.output(function(){for(var a=0;a<arguments.length;a++)b+=arguments[a]},a),b},output:function(a,b){Array.isArray(b)?this.outputArray_(a,b):"string"==typeof b?(a('"'),a(JSONUtil.escape(b)),a('"')):b instanceof Function?a(b):b instanceof Date?a(b.getTime()):b instanceof Object?b.model_?this.outputObject_(a,b):this.outputMap_(a,b):"number"==typeof b?(isFinite(b)||(b=null),a(b)):(void 0===b&&(b=null),a(b))},outputObject_:function(a,b){a("{",'"model_":"',b.model_.name,'"');for(var c in b.model_.properties){var d=b.model_.properties[c];if(this.p(d)&&d.name in b.instance_){var e=b[d.name];if(e==d.defaultValue)continue;a(",",JSONUtil.keyify(d.name),":"),this.output(a,e)}}a("}")},outputMap_:function(a,b){var c=!0;a("{");for(var d in b){var e=b[d];c||a(","),a(JSONUtil.keyify(d),":"),this.output(a,e),c=!1}a("}")},outputArray_:function(a,b){if(0==b.length)return a("[]"),a;var c=!0;a("[");for(var d=0;d<b.length;d++,c=!1){var e=b[d];c||a(","),this.output(a,e)}a("]")}},pretty:{__proto__:AbstractFormatter,stringify:function(a){var b="";return this.output(function(){for(var a=0;a<arguments.length;a++)b+=arguments[a]},a),b},output:function(a,b,c){var d=c||"";Array.isArray(b)?this.outputArray_(a,b,d):"string"==typeof b?(a('"'),a(JSONUtil.escape(b)),a('"')):b instanceof Function?a(b):b instanceof Date?a("new Date('",b,"')"):b instanceof Object?b.model_?this.outputObject_(a,b,d):this.outputMap_(a,b,d):"number"==typeof b?(isFinite(b)||(b=null),a(b)):(void 0===b&&(b=null),a(b))},outputObject_:function(a,b,c){var d=c||"",e=d+"   ";a(d,"{\n",e,'"model_": "',b.model_.name,'"');for(var f in b.model_.properties){var g=b.model_.properties[f];if(this.p(g)&&"parent"!==g.name&&g.name in b.instance_){var h=b[g.name];a(",\n",e,'"',g.name,'"',": "),this.output(a,h,e)}}a("\n",d,"}")},outputMap_:function(a,b,c){var d=c||"",e=d+"   ",f=!0;a(d,"{\n",e);for(var g in b){var h=b[g];f||a(",\n"),a(e,JSONUtil.keyify(g),": "),this.output(a,h,e),f=!1}a("\n",d,"}")},outputArray_:function(a,b,c){if(0==b.length)return a("[]"),a;var d=c||"",e=d+"   ",f=!0;a("[\n");for(var g=0;g<b.length;g++,f=!1){var h=b[g];f||a(",\n"),"string"==typeof h&&a(e),this.output(a,h,e)}a("\n",d,"]")}},moreCompact:{__proto__:AbstractFormatter},compressed:{__proto__:AbstractFormatter,stringify:function(a){return Iuppiter.Base64.encode(Iuppiter.compress(JSONUtil.compact.stringify(a),!0))}}};JSONUtil.stringify=JSONUtil.pretty.stringify.bind(JSONUtil.pretty),JSONUtil.output=JSONUtil.pretty.output.bind(JSONUtil.pretty),JSONUtil.where=JSONUtil.pretty.where.bind(JSONUtil.pretty);var NOT_TRANSIENT=function(a){return!a.transient},XMLParser={__proto__:grammar,START:seq1(1,sym("whitespace"),sym("tag"),sym("whitespace")),tag:seq("<",sym("label"),sym("whitespace"),repeat(sym("attribute"),sym("whitespace")),sym("whitespace"),">",repeat(alt(sym("tag"),sym("text"))),"</",sym("label"),">"),label:str(plus(notChars(" =/	\r\n<>'\""))),text:str(plus(notChar("<"))),attribute:seq(sym("label"),"=",sym("value")),value:str(alt(seq1(1,'"',repeat(notChar('"')),'"'),seq1(1,"'",repeat(notChar("'")),"'"))),whitespace:repeat(alt(" ","	","\r","\n"))};XMLParser.addActions({tag:function(a){if(a[1]!=a[8])return void 0;var b={tag:a[1],attrs:{},children:a[6]};return a[3].forEach(function(a){b.attrs[a[0]]=a[2]}),b}});var XMLUtil={escape:function(a){return a&&a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},unescape:function(a){return a&&a.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")},escapeAttr:function(a){return a&&a.replace(/"/g,"&quot;")},unescapeAttr:function(a){return a&&a.replace(/&quot;/g,'"')},parse:function(a){var b=XMLParser.parseString(a);return b?this.parseArray(b.children):b},parseObject:function(tag){var obj={},self=this;if(tag.children.forEach(function(c){if("object"==typeof c&&c.attrs&&c.attrs.name){var result;if(c.attrs.type&&"function"==c.attrs.type){var code=XMLUtil.unescape(c.children.join(""));result=code.startsWith("function")?eval("("+code+")"):new Function(code)}else result=self.parseArray(c.children);obj[self.unescapeAttr(c.attrs.name)]=result}}),!tag.attrs.model)return obj;var model=this.unescapeAttr(tag.attrs.model);return GLOBAL[model]?GLOBAL[model].create(obj):obj},parseArray:function(a){var b=this,c=[];return a.forEach(function(a){"object"==typeof a&&c.push("i"==a.tag?XMLUtil.unescape(a.children[0]):b.parseObject(a))}),c.length?c:XMLUtil.unescape(a.join(""))},compact:{stringify:function(a){var b=[];return this.output(b.push.bind(b),a),"<foam>"+b.join("")+"</foam>"},output:function(a,b){Array.isArray(b)?this.outputArray_(a,b):"string"==typeof b?a(XMLUtil.escape(b)):b instanceof Function?a(b):b instanceof Object?b.model_?this.outputObject_(a,b):this.outputMap_(a,b):a(b)},outputObject_:function(a,b){a('<object model="',XMLUtil.escapeAttr(b.model_.name),'">');for(var c in b.model_.properties){var d=b.model_.properties[c];if("parent"!==d.name&&b.instance_&&d.name in b.instance_){var e=b[d.name];if(Array.isArray(e)&&0==e.length)continue;if(e==d.defaultValue)continue;a('<property name="',XMLUtil.escapeAttr(d.name),'" '+("function"==typeof e?'type="function"':"")+">"),this.output(a,e),a("</property>")}}a("</object>")},outputMap_:function(a,b){a("<object>");for(var c in b){var d=b[c];a('<property name="',XMLUtil.escapeAttr(c),'">'),this.output(a,d),a("</property>")}a("</object>")},outputArray_:function(a,b){if(0==b.length)return a;for(var c=0;c<b.length;c++,first=!1){var d=b[c];"string"==typeof d||"number"==typeof d?a("<i>",XMLUtil.escape(d),"</i>"):this.output(a,d)}}},pretty:{stringify:function(a){var b=[];return this.output(b.push.bind(b),a),"<foam>\n"+b.join("")+"</foam>\n"},output:function(a,b,c){var d=c||"";if(Array.isArray(b))this.outputArray_(a,b,d);else if("string"==typeof b)a(XMLUtil.escape(b));else if(b instanceof Function)a(b);else if(b instanceof Object)try{b.model_&&"string"!=typeof b.model_?this.outputObject_(a,b,d):this.outputMap_(a,b,d)}catch(e){console.log("toXMLError: ",e)}else a(b)},outputObject_:function(a,b,c){var d=c||"",e=d+"  ";a(d,'<object model="',XMLUtil.escapeAttr(b.model_.name),'">');for(var f in b.model_.properties){var g=b.model_.properties[f];if("parent"!==g.name&&b.instance_&&g.name in b.instance_){var h=b[g.name];if(Array.isArray(h)&&0==h.length)continue;if(h==g.defaultValue)continue;var i="function"==typeof b[g.name]?' type="function"':"";a("\n",e,'<property name="',XMLUtil.escapeAttr(g.name),'"',i,">"),this.output(a,h,e),a("</property>")}}a("\n",d,"</object>"),a("\n")},outputMap_:function(a,b,c){var d=c||"",e=d+"  ";a(d,"<object>");for(var f in b){var g=b[f];a("\n",e,'<property name="',XMLUtil.escapeAttr(f),'">'),this.output(a,g,e),a("</property>")}a("\n",d,"</object>\n")},outputArray_:function(a,b,c){if(0==b.length)return a;for(var d=c||"",e=d+"  ",f=0;f<b.length;f++,first=!1){var g=b[f];a("\n"),"string"==typeof g||"number"==typeof g?a(e,"<i>",XMLUtil.escape(g),"</i>"):this.output(a,g,e)}a("\n",d)}}};XMLUtil.stringify=XMLUtil.pretty.stringify.bind(XMLUtil.pretty),XMLUtil.output=XMLUtil.pretty.output.bind(XMLUtil.pretty);var X=this.subWindow(window,"DEFAULT WINDOW").sub({IN_WINDOW:!1}),registerFactory=function(){},registerModelForModel=function(){},registerFactoryForModel=function(){},$documents=[];window&&$documents.push(window.document);var $WID__=0,$=function(a){for(var b=0;b<$documents.length;b++){if(document.FOAM_OBJECTS&&document.FOAM_OBJECTS[a])return document.FOAM_OBJECTS[a];var c=$documents[b].getElementById(a);if(c)return c}return void 0},$$=function(a){for(var b=0;b<$documents.length;b++){var c=$documents[b].getElementsByClassName(a);if(c.length>0)return c}return[]},FOAM=function(a){var b=JSONUtil.mapToObj(a);return b};FOAM.putFactory=function(a,b,c){a.__defineGetter__(b,function(){return console.log("Bouncing Factory: ",b),delete a[b],a[b]=c()})};var UNUSED_MODELS={},USED_MODELS={},FOAModel=function(a){return a.templates?(registerModel.call(this,JSONUtil.mapToObj(a,Model)),void(USED_MODELS[a.name]=!0)):(UNUSED_MODELS[a.name]=!0,void Object.defineProperty(GLOBAL,a.name,{get:function(){return USED_MODELS[a.name]=!0,delete UNUSED_MODELS[a.name],Object.defineProperty(GLOBAL,a.name,{value:null,configurable:!0}),registerModel(JSONUtil.mapToObj(a,Model)),this[a.name]},configurable:!0}))};FOAM.browse=function(a,b){var c=b||GLOBAL[a.name+"DAO"]||GLOBAL[a.plural];c||(c=StorageDAO.create({model:a}),GLOBAL[a.name+"DAO"]=c);var d=DAOController.create({model:a,dao:c,useSearchView:!1}).addDecorator(ActionBorder.create({actions:DAOController.actions})),e=GLOBAL.stack;d.X.stack=e,e.pushView(d)},FOAM.lookup=function(a,b){for(var c=a.split("."),d=b||GLOBAL,e=0;e<c.length;e++)d=d[c[e]];return d},FOAModel({name:"UnitTestResultView",extendsModel:"AbstractView",properties:[{name:"value",type:"Value"}],methods:{toHTML:function(){var a=this.value.get(),b=a.failed>0?"foamTestFailed":"foamTestPassed",c=a.results.replace(/\n/g,"<br/>\n"),d='<div class="'+b+' foamTest" id="'+this.getID()+'"><p><strong>'+a.description+"</strong></p><p><span>Passed: "+a.passed+"</span>&nbsp;&nbsp;<span>Failed: "+a.failed+"</span></p>";return c.length&&(d+='<div class="foamTestOutput">'+c+"</div>"),a.tests&&a.tests.length>0?d+'<div class="foamInnerTests">'+this.toInnerHTML()+"</div></div>":d+"</div>"},toInnerHTML:function(){var a=ArrayListView.create({value:SimpleValue.create(this.value.get().tests),listView:UnitTestResultView});return this.addChild(a),a.toHTML()}}});var FOAM_POWERED='<a style="text-decoration:none;" href="http://code.google.com/p/foam-framework/" target="_blank"><font size=+1 face="catull" style="text-shadow:rgba(64,64,64,0.3) 3px 3px 4px;"><font color="#3333FF">F</font><font color="#FF0000">O</font><font color="#FFCC00">A</font><font color="#33CC00">M</font><font color="#555555" > POWERED</font></font></a>',JSONParser=SkipGrammar.create({__proto__:grammar,START:copyInput(sym("objAsString")),objAsString:copyInput(sym("obj")),obj:seq1(1,"{",repeat(sym("pair"),","),"}"),pair:seq(sym("key"),":",sym("value")),key:alt(sym("symbol"),sym("string")),symbol:noskip(str(seq(sym("char"),str(repeat(sym("alpha")))))),"char":alt(range("a","z"),range("A","Z"),"_","$"),alpha:alt(sym("char"),range("0","9")),value:alt(sym("expr"),sym("number"),sym("string"),sym("obj"),sym("bool"),sym("array")),expr:str(seq(sym("symbol"),optional(str(alt(seq(".",sym("expr")),seq("(",str(repeat(sym("value"),",")),")")))))),number:noskip(seq(optional("-"),repeat(range("0","9"),null,1),optional(seq(".",repeat(range("0","9")))))),string:noskip(alt(sym("single quoted string"),sym("double quoted string"))),"double quoted string":seq1(1,'"',str(repeat(sym("double quoted char"))),'"'),"double quoted char":alt(sym("escape char"),literal('\\"','"'),notChar('"')),"single quoted string":seq1(1,"'",str(repeat(sym("single quoted char"))),"'"),"single quoted char":alt(sym("escape char"),literal("\\'","'"),notChar("'")),"escape char":alt(literal("\\\\","\\"),literal("\\n","\n")),bool:alt(literal("true",!0),literal("false",!1)),array:seq1(1,"[",repeat(sym("value"),","),"]")}.addActions({obj:function(a){for(var b={},c=0;c<a.length;c++)b[a[c][0]]=a[c][2];return b}}),repeat0(alt(" ","	","\n","\r"))),TemplateParser={__proto__:grammar,START:sym("markup"),markup:repeat0(alt(sym("create child"),sym("simple value"),sym("live value tag"),sym("raw values tag"),sym("values tag"),sym("code tag"),sym("ignored newline"),sym("newline"),sym("single quote"),sym("text"))),"create child":seq("$$",repeat(notChars(" $\n<{")),optional(JSONParser.export("objAsString"))),"simple value":seq("%%",repeat(notChars(' "\n<'))),"live value tag":seq("<%#",repeat(not("%>",anyChar)),"%>"),"raw values tag":alt(seq("<%=",repeat(not("%>",anyChar)),"%>"),seq("{{{",repeat(not("}}}",anyChar)),"}}}")),"values tag":seq("{{",repeat(not("}}",anyChar)),"}}"),"code tag":seq("<%",repeat(not("%>",anyChar)),"%>"),"ignored newline":literal("\\\n"),newline:literal("\n"),"single quote":literal("'"),text:anyChar},TemplateOutput={create:function(a){var b="",c=function(){for(var c=0;c<arguments.length;c++){var d=arguments[c];d&&(d.appendHTML?d.appendHTML(this):b+=d.toHTML?d.toHTML():d,d.initHTML&&a.addChild&&a.addChild(d))}};return c.toString=function(){return b},c}},TemplateCompiler={__proto__:TemplateParser,out:[],push:function(){this.out.push.apply(this.out,arguments)},header:"var self = this; var escapeHTML = View.getPrototype().strToHTML; var out = opt_out ? opt_out : TemplateOutput.create(this);out('",footer:"');return out.toString();"}.addActions({markup:function(){var a=this.header+this.out.join("")+this.footer;return this.out=[],a},"create child":function(a){var b=a[1].join("").constantize();this.push("', this.createTemplateView('",b,"'",a[2]?", "+a[2]:"","),\n'")},"simple value":function(a){this.push("',\n this.",a[1].join(""),",\n'")},"raw values tag":function(a){this.push("',\n",a[1].join(""),",\n'")},"values tag":function(a){this.push("',\n",a[1].join(""),",\n'")},"live value tag":function(a){this.push("',\nthis.dynamicTag('span', function() { return ",a[1].join(""),"; }.bind(this)),\n'")},"code tag":function(a){this.push("');\n",a[1].join(""),"out('")},"single quote":function(){this.push("\\'")},newline:function(){this.push("\\n")},text:function(a){this.push(a)}}),TemplateUtil={lazyCompile:function(a){var b;return function(){if(!b){if(!a.template)throw"Must arequire() template model before use for "+a.name;b=TemplateUtil.compile(a.template)}return b.apply(this,arguments)}},compile:window.chrome&&window.chrome.app&&window.chrome.app.runtime?function(){return function(){return"Models must be arequired()'ed for Templates to be compiled in Packaged Apps."}}:function(a){var b=TemplateCompiler.parseString(a);try{return new Function("opt_out",b)}catch(c){return console.log("Template Error: ",c),console.log(b),function(){}}},stringifyTemplate:function(){return function(){var a=[];return this.output(a.push.bind(a),obj),a.join("")}}},aeval=function(src){return aconstant(eval("("+src+")"))},aevalTemplate=function(a){return a.template?aeval("function (opt_out) {"+TemplateCompiler.parseString(a.template)+"}"):aseq(a.futureTemplate,function(a,b){aeval("function (opt_out) {"+TemplateCompiler.parseString(b)+"}")(a)})},prefix="",AbstractPrototype={__proto__:PropertyChangeSupport,TYPE:"AbstractPrototype",create:function(a,b){var c=Object.create(this);return c.instance_={},b&&(c.X=b),"object"==typeof a&&c.copyFrom(a),c.init(a),c},X:X,selectProperties_:function(a,b){if(this.hasOwnProperty(a))return this[a];for(var c=[],d=this.model_.properties,e=0;e<d.length;e++)d[e][b]&&c.push(d[e]);return this[a]=c,c},init:function(){if(this.model_){for(var a=this.selectProperties_("dynamicValueProperties_","dynamicValue"),b=0;b<a.length;b++){var c=a[b];!function(a,b,c){Events.dynamic(c.bind(a),function(c){a[b]=c})}(this,c.name,c.dynamicValue)}a=this.selectProperties_("factoryProperties_","factory");for(var b=0;b<a.length;b++){var c=a[b];this.hasOwnProperty(c.name)||(this[c.name]=c.factory.call(this))}this.model_==Model&&"Model"!=this.name&&(this.create=ModelProto.create)}},defineFOAMGetter:function(a,b){var c=Events.onGet.stack;this.__defineGetter__(a,function(){var d=b.call(this,a),e=c[0];return e&&e(this,a,d),d})},defineFOAMSetter:function(a,b){var c=Events.onSet.stack;this.__defineSetter__(a,function(d){var e=c[0];(!e||e(this,a,d))&&b.call(this,d,a)})},toString:function(){return this.model_.name+"Prototype"},hasOwnProperty:function(a){return"undefined"!=typeof this.instance_[a]},writeActions:function(a,b){for(var c,d=0;c=this.model_.properties[d];d++)if(c.actionFactory)for(var e=c.actionFactory(this,c.f(this),c.f(a)),f=0;f<e.length;f++)b(e[f])},equals:function(a){return 0==this.compareTo(a)},compareTo:function(a){for(var b=this.model_.properties,c=0;c<b.length;c++){var d=b[c].compare(this,a);if(d)return d}return 0},diff:function(a){for(var b,c={},d=0;b=this.model_.properties[d];d++)if(Array.isArray(b.f(this))){var e=b.f(this).diff(b.f(a));(0!==e.added.length||0!==e.removed.length)&&(c[b.name]=e)}else 0!==b.f(this).compareTo(b.f(a))&&(c[b.name]=b.f(a));return c},clearProperty:function(a){delete this.instance_[a]},defineProperty:function(a){var b=a.name;if(a.name$_=b+"$",AbstractPrototype.__lookupGetter__(a.name$_)||Object.defineProperty(AbstractPrototype,a.name$_,{get:function(){return this.propertyValue(b)},set:function(a){Events.link(a,this.propertyValue(b))},configurable:!0}),a.getter?this.defineFOAMGetter(b,a.getter):this.defineFOAMGetter(b,a.defaultValueFn?function(){return"undefined"!=typeof this.instance_[b]?this.instance_[b]:a.defaultValueFn.call(this,a)}:function(){return"undefined"!=typeof this.instance_[b]?this.instance_[b]:a.defaultValue}),a.setter)this.defineFOAMSetter(b,a.setter);else{var c=function(a,c){this.instance_[b]=c};("int"===a.type||"float"===a.type)&&(c=function(a){return function(b,c){a.call(this,b,"number"!=typeof c?Number(c):c)}}(c)),a.postSet&&(c=function(a,b){return function(c,d){a.call(this,c,d),b.call(this,c,d)}}(c,a.postSet));var d=PropertyChangeSupport.propertyTopic(b);c=function(a){return function(b,c){a.call(this,b,c),this.propertyChange_(d,b,c)}}(c),a.preSet&&(c=function(b,c){return function(d,e){b.call(this,d,c.call(this,d,e,a))}}(c,a.preSet)),c=function(a){return function(c){a.call(this,this[b],c)}}(c),this.defineFOAMSetter(b,c)}},hashCode:function(){for(var a=17,b=0;b<this.model_.properties.length;b++){var c=this[this.model_.properties[b].name],d=c?c.hashCode?c.hashCode():c.toString().hashCode():0;a=(a<<5)-a+d,a&=a}return a},toProtobuf:function(){var a=ProtoWriter.create();return this.outProtobuf(a),a.value},outProtobuf:function(a){for(var b=0;b<this.model_.properties.length;b++){var c=this.model_.properties[b];Number.isFinite(c.prototag)&&c.outProtobuf(this,a)}},clone:function(){var a=Object.create(this.__proto__);a.instance_={};for(var b in this.instance_){var c=this[b];a[b]=Array.isArray(c)?c.clone():c}return a},deepClone:function(){var a=this.clone();for(var b in a.instance_){var c=a.instance_[b];if(Array.isArray(c))for(var d=0;d<c.length;d++){var e=c[d];e=e.deepClone()}}return a},copyFrom:function(a){if(a&&this.model_)for(var b=this.model_.properties,c=0;c<b.length;c++){var d=b[c];a.hasOwnProperty(d.name)&&(this[d.name]=a[d.name]),a.hasOwnProperty(d.name$_)&&(this[d.name$_]=a[d.name$_])}return this},output:function(a){return JSONUtil.output(a,this)},toJSON:function(){return JSONUtil.stringify(this)},toXML:function(){return XMLUtil.stringify(this)},write:function(a,b){var c=(b||DetailView).create({model:this.model_,value:SimpleValue.create(this),showActions:!0});a.writeln(c.toHTML()),c.initHTML()},decorate:function(a,b,c){var d=this[a];return this[a]=function(){return b.call(this,c,d.bind(this),arguments)},this},addDecorator:function(a){a.decorateObject&&a.decorateObject(this);for(var b=0;b<a.model_.methods.length;b++){var c=a.model_.methods[b];"decorateObject"!==c.name&&this.decorate(c.name,c.code,a)}return this}};this.Method=null,this.Action=null,this.Relationship=null;var ModelProto={__proto__:PropertyChangeSupport,TYPE:"ModelProto <startup only, error if you see this>",buildPrototype:function(){function a(a,b){c.__proto__[a]?override(c,a,b):c[a]=b}var b=this.extendsModel&&GLOBAL[this.extendsModel],c=Object.create(b?b.getPrototype():AbstractPrototype);if(c.instance_={},c.model_=this,c.name_=this.name,c.TYPE=this.name+"Prototype",this.models&&Object_forEach(this.models,function(a){c.model_[a.name]=c[a.name]=JSONUtil.mapToObj(a,Model)}),this.properties){for(var d=0;d<this.properties.length;d++){var e=this.properties[d];if(b){var f=b.getProperty(e.name);f&&(e=f.clone().copyFrom(e),this.properties[d]=e,this[e.name.constantize()]=e)}c.defineProperty(e)}this.propertyMap_=null}if(b)for(var d=0;d<b.properties.length;d++){var e=b.properties[d],g=e.name.constantize();this[g]||(this[g]=e)}if(this.templates&&Object_forEach(this.templates,function(b){a(b.name,TemplateUtil.lazyCompile(b))}),this.actions)for(var d=0;d<this.actions.length;d++)(function(c){if(b){var e=b.getAction(c.name);e&&(console.log("superAction: ",c.name,c.model_.name),c=e.clone().copyFrom(c),this.actions[d]=c)}a(c.name,function(){c.callIfEnabled(this)})}).bind(this)(this.actions[d]);for(var h in this.methods){var i=this.methods[h];Method&&Method.isInstance(i)?a(i.name,i.generateFunction()):a(h,i)}for(var h in this.relationships){var j=this.relationships[h];Object.defineProperty(c,j.name,{get:function(a){return function(){return GLOBAL[a.relatedModel].where(EQ(a.relatedProperty,this.id))}}(j),configurable:!1})
}var k=function(a,b,c,d,e){c.name=b,Object.defineProperty(a,b,{get:function(){var a=c.bind(this);return e?a=EventService.animate(a,this.X):d&&(a=EventService.merged(a,d===!0?void 0:d,this.X)),Object.defineProperty(this,b,{value:a}),a},configurable:!0})};if(Array.isArray(this.listeners))for(var d=0;d<this.listeners.length;d++){var l=this.listeners[d];k(c,l.name,l.code,l.isMerged,l.isAnimated)}else this.listeners&&Object_forEach(this.listeners,function(a,b){k(c,b,a)});if(this.topics&&Object_forEach(this.topics,function(){}),b){for(var d=b.properties.length-1;d>=0;d--){var e=b.properties[d];this.getProperty&&this.getPropertyWithoutCache_(e.name)||this.properties.unshift(e)}this.propertyMap_=null,this.actions=b.actions.concat(this.actions)}if(this.properties.length>0&&!c.__lookupGetter__("id")){var m=this.ids;1==m.length?(c.__defineGetter__("id",function(){return this[m[0]]}),c.__defineSetter__("id",function(a){this[m[0]]=a})):m.length>1&&(c.__defineGetter__("id",function(){return m.map(function(a){return this[a]})}),c.__defineSetter__("id",function(a){m.map(function(b,c){this[b]=a[c]})}))}return c},getPrototype:function(){return this.prototype_&&this.prototype_.model_==this?this.prototype_:this.prototype_=this.buildPrototype()},create:function(a,b){return this.getPrototype().create(a,b)},isSubModel:function(a){try{return a&&(a===this||this.isSubModel(a.getPrototype().__proto__.model_))}catch(b){return!1}},getPropertyWithoutCache_:function(a){for(var b=0;b<this.properties.length;b++){var c=this.properties[b];if(c.name===a)return c}return null},getProperty:function(a){if(!this.propertyMap_){if(!this.properties.length)return void 0;for(var b={},c=0;c<this.properties.length;c++){var d=this.properties[c];b[d.name]=d}this.propertyMap_=b}return this.propertyMap_[a]},getAction:function(a){for(var b=0;b<this.actions.length;b++)if(this.actions[b].name===a)return this.actions[b]},hashCode:function(){var a="";for(var b in this.properties)a+=this.properties[b].toString();return a.hashCode()},isInstance:function(a){return a&&a.model_&&this.isSubModel(a.model_)},toString:function(){return"ModelProto("+this.name+")"}},BinaryProtoGrammar,Model={__proto__:ModelProto,name:"Model",plural:"Models",help:"Describes the attributes and properties of an entity.",tableProperties:["name","label","plural"],ids:["name"],properties:[{name:"package",help:"Java class package.",defaultValueFn:function(){return this.extendsModel?GLOBAL[this.extendsModel].package:""}},{name:"abstract",type:"boolean",defaultValue:!1,help:"If the java class is abstract."},{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the entity."},{name:"label",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.name.labelize()},help:"The display label for the entity."},{name:"javaClassName",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return(this.abstract?"Abstract":"")+this.name},help:"The Java classname of this Model."},{name:"extendsModel",type:"String",displayWidth:70,displayHeight:1,defaultValue:"",help:"The parent model of this model."},{name:"plural",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.name+"s"},help:"The plural form of this model's name."},{name:"version",type:"int",defaultValue:1,help:"Version number of model."},{name:"ids",label:"Key Properties",type:"Array[String]",view:"StringArrayView",defaultValueFn:function(){return this.properties.length?[this.properties[0].name]:[]},help:"Properties which make up unique id."},{name:"tableProperties",type:"Array[String]",view:"StringArrayView",displayWidth:70,factory:function(){return this.properties.map(function(a){return a.name})},help:"Properties to be displayed in table view. Defaults to all properties."},{name:"searchProperties",type:"Array[String]",view:"StringArrayView",displayWidth:70,defaultValueFn:function(){return this.tableProperties},help:"Properties display in a search view. Defaults to table properties."},{name:"properties",type:"Array[Property]",subType:"Property",view:"ArrayView",factory:function(){return[]},defaultValue:[],help:"Properties associated with the entity.",preSet:function(a,b){if(Property){for(var c=0;c<b.length;c++){var d=b[c];"string"==typeof d&&(b[c]=d={name:d}),d.model_?"string"==typeof d.model_&&(d=b[c]=FOAM(d)):d=b[c]=Property.create(d),this[d.name.constantize()]=b[c]}return this.propertyMap_=null,b}}},{name:"actions",type:"Array[Action]",subType:"Action",view:"ArrayView",factory:function(){return[]},defaultValue:[],help:"Actions associated with the entity.",preSet:function(a,b){if(Action){for(var c=0;c<b.length;c++){var d=b[c];d.model_?"string"==typeof d.model_&&(b[c]=FOAM(d)):b[c]=Action.create(d),this[d.name.constantize()]=b[c]}return b}}},{name:"methods",type:"Array[Method]",subType:"Method",view:"ArrayView",factory:function(){return[]},defaultValue:[],help:"Methods associated with the entity.",preSet:function(a,b){if(Method){if(Array.isArray(b))return JSONUtil.arrayToObjArray(b,Method);var c=[];for(var d in b){var e=b[d],f=Method.create({name:d,code:e});c.push(f)}return c}}},{name:"listeners",type:"Array[Method]",subType:"Method",view:"ArrayView",factory:function(){return[]},preSet:function(a,b){return Array.isArray(b)?JSONUtil.arrayToObjArray(b,Method):b},defaultValue:[],help:"Event listeners associated with the entity."},{name:"templates",type:"Array[Template]",subType:"Template",view:"ArrayView",factory:function(){return[]},defaultValue:[],postSet:function(a,b){var c=0;b.forEach(function(a){if("function"==typeof a)a=b[c]=Template.create({name:a.name,template:multiline(a)});else if(a.template)"function"==typeof a.template&&(a.template=multiline(a.template));else{var d=afuture(),e=document.currentScript.src;a.futureTemplate=d.get,e=e.substring(0,e.lastIndexOf("/")+1),e+=this.name+"_"+a.name+".ft";var f=new XMLHttpRequest;f.open("GET",e),f.asend(function(b){a.template=b,d.set(b),a.futureTemplate=void 0})}c++}.bind(this))},help:"Templates associated with this entity."},{name:"models",type:"Array[Model]",subType:"Model",view:"ArrayView",factory:function(){return[]},defaultValue:[],help:"Sub-models embedded within this model."},{name:"tests",label:"Unit Tests",type:"Array[Unit Test]",subType:"UnitTest",view:"ArrayView",factory:function(){return[]},defaultValue:[],help:"Unit tests associated with this model."},{name:"relationships",subType:"Relationship",view:"ArrayView",factory:function(){return[]},defaultValue:[],help:"Relationships of this model to other models.",preSet:function(a,b){if(Relationship){for(var c=0;c<b.length;c++){var d=b[c];d.model_?"string"==typeof d.model_&&(d=b[c]=FOAM(d)):d=b[c]=Relationship.create(d),this[d.name.constantize()]=b[c]}return b}}},{name:"issues",type:"Array[Issue]",subType:"Issue",view:"ArrayView",factory:function(){return[]},defaultValue:[],help:"Issues associated with this model."},{name:"help",label:"Help Text",type:"String",displayWidth:70,displayHeight:6,view:"TextAreaView",defaultValue:"",help:"Help text associated with the entity."},{name:"notes",type:"String",displayWidth:70,displayHeight:6,view:"TextAreaView",defaultValue:"",help:"Internal documentation associated with this entity."},{name:"createActionFactory",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"FunctionView",defaultValue:"",help:"Factory to create the action object for creating this object"},{name:"deleteActionFactory",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"FunctionView",defaultValue:"",help:"Factory to create the action object for deleting this object"}],templates:[{model_:"Template",name:"javaSource",description:"Java Source",template:"// Generated by FOAM, do not modify.\n// Version <%= this.version %>\n<%\n  var className       = this.javaClassName;\n  var parentClassName = this.extendsModel ? this.extendsModel : 'AbstractFObject';\n\n  if ( GLOBAL[parentClassName] && GLOBAL[parentClassName].abstract ) parentClassName = 'Abstract' + parentClassName;\n\n%>\n<% if ( this.package ) { %>\\\npackage <%= this.package %>;\n\n<% } %>\\\nimport foam.core.*;\n\npublic<%= this.abstract ? ' abstract' : '' %> class <%= className %>\n   extends <%= parentClassName %>\n{\n   <% for ( var key in this.properties ) { var prop = this.properties[key]; %>\n   public final static Property <%= prop.name.constantize() %> = new Abstract<%= prop.javaType.capitalize() %>Property() {\n     public String getName() { return \"<%= prop.name %>_\"; }\n     public String getLabel() { return \"<%= prop.label %>\"; }\n     public Object get(Object o) { return ((<%= this.name %>) o).get<%= prop.name.capitalize() %>(); }\n     public void set(Object o, Object v) { ((<%= this.name %>) o).set<%= prop.name.capitalize() %>(toNative(v)); }\n     public int compare(Object o1, Object o2) { return compareValues(((<%= this.name%>)o1).<%= prop.name %>_, ((<%= this.name%>)o2).<%= prop.name %>_); }\n   };\n   <% } %>\n\n   final static Model model__ = new AbstractModel(new Property[] {<% for ( var key in this.properties ) { var prop = this.properties[key]; %> <%= prop.name.constantize() %>,<% } %> }) {\n     public String getName() { return \"<%= this.name %>\"; }\n     public String getLabel() { return \"<%= this.label %>\"; }\n     public Property id() { return <%= this.ids.length ? this.ids[0].constantize() : 'null' %>; }\n   };\n\n   public Model model() {\n     return model__;\n   }\n   public static Model MODEL() {\n     return model__;\n   }\n\n   <% for ( var key in this.properties ) { var prop = this.properties[key]; %>\n   private <%= prop.javaType %> <%= prop.name %>_;   <% } %>\n\n   public <%= className %>()\n   {\n   }\n<% if ( this.properties.length ) { %> \n   public <%= className %>(<% for ( var key in this.properties ) { var prop = this.properties[key]; %><%= prop.javaType, ' ', prop.name, key < this.properties.length-1 ? ', ': '' %><% } %>)\n   {   <% for ( var key in this.properties ) { var prop = this.properties[key]; %>\n      <%= prop.name %>_ = <%= prop.name %>;   <% } %>\n   }\n<% } %>\n\n   <% for ( var key in this.properties ) { var prop = this.properties[key]; %>\n   public <%= prop.javaType %> get<%= prop.name.capitalize() %>() {\n       return <%= prop.name %>_;\n   };\n   public void set<%= prop.name.capitalize() %>(<%= prop.javaType, ' ', prop.name %>) {\n       <%= prop.name %>_ = <%= prop.name %>;\n   };\n   <% } %>\n\n   public int hashCode() { \n      int hash = 1;\n   <% for ( var key in this.properties ) { var prop = this.properties[key]; %>\n      hash = hash * 31 + hash(<%= prop.name %>_);   <% } %>\n\n      return hash;\n   }\n\n   public int compareTo(Object obj) {\n      if ( obj == this ) return 0;\n      if ( obj == null ) return 1;\n\n      <%= this.name %> other = (<%= this.name %>) obj;\n \n      int cmp;\n   <% for ( var key in this.properties ) { var prop = this.properties[key]; %>\n      if ( ( cmp = compare(get<%= prop.name.capitalize() %>(), other.get<%= prop.name.capitalize() %>()) ) != 0 ) return cmp;   <% } %>\n\n      return 0;\n   }\n\n   public StringBuilder append(StringBuilder b) {\n      return b\n   <% for ( var key in this.properties ) { var prop = this.properties[key]; %>\\\n      .append(\"<%= prop.name %>=\").append(get<%= prop.name.capitalize() %>())<%= key < this.properties.length-1 ? '.append(\", \")' : '' %> \n   <% } %>      ;\n   }\n\n   public Object fclone() {\n      <%= this.name %> c = new <%= this.name %>();\n      <% for ( var key in this.properties ) { var prop = this.properties[key]; %>\\\nc.set<%= prop.name.capitalize() %>(get<%= prop.name.capitalize() %>());\n      <% } %>\\\nreturn c;\n   }\n\n}"},{model_:"Template",name:"closureExterns",description:"Closure Externs JavaScript Source",template:"/**\n * @constructor\n */\n<%= this.name %> = function() {};\n<% for ( var i = 0 ; i < this.properties.length ; i++ ) { var prop = this.properties[i]; %>\n<%= prop.closureSource(undefined, this.name) %>\n<% } %><% for ( var i = 0 ; i < this.methods.length ; i++ ) { var meth = this.methods[i]; %>\n<%= meth.closureSource(undefined, this.name) %>\n<% } %>"},{model_:"Template",name:"dartSource",description:"Dart Class Source",template:'<% out(this.name); %>\n{\n<% for ( var key in this.properties ) { var prop = this.properties[key]; %>   var <%= prop.name %>;\n<% } %>\n\n   <%= this.name %>()\n   {\n\n   }\n\n   <%= this.name %>(<% for ( var key in this.properties ) { var prop = this.properties[key]; %>this.<%= prop.name, key < this.properties.length-1 ? ", ": "" %><% } %>)\n}'}],toString:function(){return"Model"}},Property={__proto__:ModelProto,name:"Property",plural:"Properties",help:"Describes a properties of a modelled entity.",ids:["name"],tableProperties:["name","label","type","required","defaultValue"],properties:[{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the property."},{name:"label",type:"String",required:!1,displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.name.labelize()},help:"The display label for the property."},{name:"tableLabel",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.name.labelize()},help:"The table display label for the entity."},{name:"type",type:"String",required:!0,view:{create:function(){return ChoiceView.create({choices:["Array","Boolean","Color","Date","DateTime","Email","Enum","Float","Function","Image","Int","Object","Password","String","String[]","URL"]})}},defaultValue:"String",help:"The type of the property."},{name:"javaType",type:"String",required:!1,defaultValueFn:function(){return this.type},help:"The java type that represents the type of this property."},{name:"javascriptType",type:"String",required:!1,defaultValueFn:function(){return this.type},help:"The javascript type that represents the type of this property."},{name:"shortName",type:"String",required:!0,displayWidth:10,displayHeight:1,defaultValue:"",help:"A short alternate name to be used for compact encoding."},{name:"aliases",type:"Array[String]",view:"StringArrayView",defaultValue:[],help:"Alternate names for this property."},{name:"mode",type:"String",defaultValue:"read-write",view:{create:function(){return ChoiceView.create({choices:["read-only","read-write","final"]})}}},{name:"subType",label:"Sub-Type",type:"String",displayWidth:30,help:"The type of the property."},{name:"units",type:"String",required:!0,displayWidth:70,displayHeight:1,defaultValue:"",help:"The units of the property."},{name:"required",type:"Boolean",view:"BooleanView",defaultValue:!0,help:"Indicates if the property is a required field."},{name:"hidden",type:"Boolean",view:"BooleanView",defaultValue:!1,help:"Indicates if the property is hidden."},{name:"transient",type:"Boolean",view:"BooleanView",defaultValue:!1,help:"Indicates if the property is transient."},{name:"displayWidth",type:"int",displayWidth:8,displayHeight:1,defaultValue:"30",help:"The display width of the property."},{name:"displayHeight",type:"int",displayWidth:8,displayHeight:1,defaultValue:1,help:"The display height of the property."},{name:"view",type:"view",defaultValue:"TextFieldView",help:"View component for the property."},{model_:"FunctionProperty",name:"detailViewPreRow",defaultValue:function(){return""},help:"Inject HTML before row in DetailView."},{model_:"FunctionProperty",name:"detailViewPostRow",defaultValue:function(){return""},help:"Inject HTML before row in DetailView."},{name:"defaultValue",type:"String",required:!1,displayWidth:70,displayHeight:1,defaultValue:"",help:"The property's default value."},{name:"defaultValueFn",label:"Default Value Function",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"FunctionView",defaultValue:"",help:"The property's default value function."},{name:"dynamicValue",label:"Value's Dynamic Function",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"FunctionView",defaultValue:"",help:"A dynamic function which computes the property's value."},{name:"factory",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"FunctionView",defaultValue:"",help:"Factory for creating initial value when new object instantiated."},{name:"getter",type:"Function",required:!1,displayWidth:70,displayHeight:3,view:"FunctionView",defaultValue:"",help:"The property's default value function."},{name:"preSet",type:"Function",required:!1,displayWidth:70,displayHeight:3,view:"FunctionView",defaultValue:"",help:"An adapter function called before normal setter logic."},{name:"postSet",type:"Function",required:!1,displayWidth:70,displayHeight:3,view:"FunctionView",defaultValue:"",help:"A function called after normal setter logic, but before property change event fired."},{name:"setter",type:"Function",required:!1,displayWidth:70,displayHeight:3,view:"FunctionView",defaultValue:"",help:"The property's default value function."},{name:"tableFormatter",label:"Table Cell Formatter",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"FunctionView",defaultValue:"",help:"Function to format value for display in TableView."},{name:"summaryFormatter",label:"Summary Formatter",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"FunctionView",defaultValue:"",help:"Function to format value for display in SummaryView."},{name:"tableWidth",type:"String",required:!1,defaultValue:"",help:"Table View Column Width."},{name:"help",label:"Help Text",type:"String",required:!1,displayWidth:70,displayHeight:6,view:"TextAreaView",defaultValue:"",help:"Help text associated with the property."},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."},{name:"actionFactory",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"FunctionView",defaultValue:"",help:"Factory to create the action objects for taking this property from value A to value B"},{name:"compareProperty",type:"Function",view:"FunctionView",displayWidth:70,displayHeight:5,defaultValue:function(a,b){return(a.localeCompare||a.compareTo).call(a,b)},help:"Comparator function."},{name:"fromElement",defaultValue:function(a){return a.innerHTML},help:"Function to extract from from DOM Element."},{name:"autocompleter",subType:"Autocompleter",help:"Name or model for the autocompleter for this property."}],methods:{f:function(a){return a[this.name]||a},compare:function(a,b){return this.compareProperty(this.f(a),this.f(b))},toSQL:function(){return this.name},toMQL:function(){return this.name}},getProperty:function(a){for(var b=0;b<this.properties.length;b++){var c=this.properties[b];if(c.name===a)return c}return document.writeln("couldn't find: "+a),null},templates:[{model_:"Template",name:"closureSource",description:"Closure Externs JavaScript Source",template:"/**\n * @type {<%= this.javascriptType %>}\n */\n<%= arguments[1] %>.prototype.<%= this.name %> = undefined;"}],toString:function(){return"Property"}};Model.methods={getPropertyWithoutCache_:ModelProto.getPropertyWithoutCache_,getProperty:ModelProto.getProperty,getAction:ModelProto.getAction,hashCode:ModelProto.hashCode,buildPrototype:ModelProto.buildPrototype,getPrototype:ModelProto.getPrototype,isSubModel:ModelProto.isSubModel,isInstance:ModelProto.isInstance},Model=Model.create(Model),Model.model_=Model,Property=Model.create(Property);var StringProperty=Model.create({extendsModel:"Property",name:"StringProperty",help:"Describes a properties of type String.",properties:[{name:"displayHeight",type:"int",displayWidth:8,defaultValue:1,help:"The display height of the property."},{name:"type",type:"String",displayWidth:20,defaultValue:"String",help:"The FOAM type of this property."},{name:"preSet",defaultValue:function(a,b){return void 0===b||null===b?"":b.toString()}},{name:"javaType",type:"String",displayWidth:70,defaultValue:"String",help:"The Java type of this property."},{name:"view",defaultValue:"TextFieldView"},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."}]}),BooleanProperty=Model.create({extendsModel:"Property",name:"BooleanProperty",help:"Describes a properties of type String.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Boolean",help:"The FOAM type of this property."},{name:"javaType",type:"String",displayWidth:70,defaultValue:"bool",help:"The Java type of this property."},{name:"view",defaultValue:"BooleanView"},{name:"defaultValue",defaultValue:!1},{name:"preSet",defaultValue:function(a,b){return!!b}},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."},{name:"fromElement",defaultValue:function(a){var b=a.innerHTML.trim();return b.equalsIC("y")||b.equalsIC("yes")||b.equalsIC("true")||b.equalsIC("t")}}]}),DateProperty=Model.create({extendsModel:"Property",name:"DateProperty",help:"Describes a properties of type String.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Date",help:"The FOAM type of this property."},{name:"displayWidth",defaultValue:50},{name:"javaType",type:"String",defaultValue:"Date",help:"The Java type of this property."},{name:"view",defaultValue:"DateFieldView"},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."},{name:"preSet",defaultValue:function(a,b){return"string"==typeof b?new Date(b):b}},{name:"tableFormatter",defaultValue2:function(a){return a.toDateString()},defaultValue:function(a){return a.toRelativeDateString()}}]}),DateTimeProperty=Model.create({extendsModel:"DateProperty",name:"DateTimeProperty",help:"Describes a properties of type String.",properties:[{name:"type",type:"String",displayWidth:25,defaultValue:"datetime",help:"The FOAM type of this property."},{name:"preSet",defaultValue:function(a,b){return"number"==typeof b?new Date(b):"string"==typeof b?new Date(b):b}},{name:"view",defaultValue:"DateTimeFieldView"}]}),IntProperty=Model.create({extendsModel:"Property",name:"IntProperty",help:"Describes a properties of type Int.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Int",help:"The FOAM type of this property."},{name:"displayWidth",defaultValue:10},{name:"javaType",type:"String",displayWidth:10,defaultValue:"int",help:"The Java type of this property."},{name:"view",defaultValue:"IntFieldView"},{name:"preSet",defaultValue:function(a,b){return parseInt(b||0)}},{name:"defaultValue",defaultValue:0},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."},{name:"compareProperty",defaultValue:function(a,b){return a===b?0:a>b?1:-1}}]}),FloatProperty=Model.create({extendsModel:"Property",name:"FloatProperty",help:"Describes a properties of type Float.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Float",help:"The FOAM type of this property."},{name:"defaultValue",defaultValue:0},{name:"javaType",type:"String",displayWidth:10,defaultValue:"double",help:"The Java type of this property."},{name:"displayWidth",defaultValue:15},{name:"view",defaultValue:"FloatFieldView"},{name:"preSet",defaultValue:function(a,b){return parseFloat(b||0)}},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."}]}),FunctionProperty=Model.create({extendsModel:"Property",name:"FunctionProperty",help:"Describes a properties of type Function.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Function",help:"The FOAM type of this property."},{name:"javaType",type:"String",displayWidth:10,defaultValue:"Function",help:"The Java type of this property."},{name:"displayWidth",defaultValue:15},{name:"view",defaultValue:"FunctionView"},{name:"defaultValue",defaultValue:function(){}},{name:"fromElement",defaultValue:function(e){var txt=e.innerHTML.trim();return txt.startsWith("function")?eval("("+txt+")"):new Function(txt)}},{name:"preSet",defaultValue:function(_,value){return"string"==typeof value?value.startsWith("function")?eval("("+value+")"):new Function(value):value}}]}),ArrayProperty=Model.create({extendsModel:"Property",name:"ArrayProperty",help:"Describes a properties of type Array.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Array",help:"The FOAM type of this property."},{name:"subType",type:"String",displayWidth:20,defaultValue:"",help:"The FOAM sub-type of this property."},{name:"preSet",defaultValue:function(a,b,c){var d=GLOBAL[c.subType];if(!d)return b;for(var e=0;e<b.length;e++)b[e]=b[e].model_?FOAM(b[e]):d.create(b[e]);return b}},{name:"javaType",type:"String",displayWidth:10,defaultValueFn:function(a){return a.subType+"[]"},help:"The Java type of this property."},{name:"view",defaultValue:"ArrayView"},{name:"factory",defaultValue:function(){return[]}},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."}]}),ReferenceProperty=Model.create({extendsModel:"Property",name:"ReferenceProperty",help:"A foreign key reference to another Entity.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Reference",help:"The FOAM type of this property."},{name:"subType",type:"String",displayWidth:20,defaultValue:"",help:"The FOAM sub-type of this property."},{name:"subKey",type:"EXPR",displayWidth:20,factory:function(){return this.subType+".ID"},help:"The foreign key that this property references."},{name:"javaType",type:"String",displayWidth:10,defaultValueFn:function(){return"Object"},help:"The Java type of this property."},{name:"view",defaultValue:"TextFieldView"},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."}]}),StringArrayProperty=Model.create({extendsModel:"Property",name:"StringArrayProperty",help:"An array of String values.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Array[]",help:"The FOAM type of this property."},{name:"subType",type:"String",displayWidth:20,defaultValue:"String",help:"The FOAM sub-type of this property."},{name:"displayWidth",defaultValue:50},{name:"factory",defaultValue:function(){return[]}},{name:"javaType",type:"String",displayWidth:10,defaultValue:"String[]",help:"The Java type of this property."},{name:"view",defaultValue:"StringArrayView"},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."}]}),DAOProperty=Model.create({extendsModel:"Property",name:"DAOProperty",help:"Describes a DAO property.",properties:[{name:"type",defaultValue:"DAO",help:"The FOAM type of this property."},{name:"view",defaultValue:"ArrayView"},{name:"getter",defaultValue:function(a){return this.instance_[a]||(this.instance_[a]=ProxyDAO.create({delegate:NullDAO.create({})})),this.instance_[a]}},{name:"setter",defaultValue:function(a,b){a&&(this.instance_[b]||(this.instance_[b]=ProxyDAO.create()),this.instance_[b].delegate=a)}}]}),ReferenceArrayProperty=Model.create({name:"ReferenceArrayProperty",extendsModel:"ReferenceProperty",properties:[{name:"type",defaultValue:"Array",displayWidth:20,help:"The FOAM type of this property."},{name:"factory",defaultValue:function(){return[]}},{name:"view",defaultValue:"StringArrayView"}]}),EMailProperty=StringProperty,URLProperty=StringProperty;FOAModel({name:"Action",tableProperties:["name","label"],properties:[{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the action."},{name:"label",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.name.labelize()},help:"The display label for the action."},{name:"help",label:"Help Text",type:"String",displayWidth:70,displayHeight:6,defaultValue:"",help:"Help text associated with the action."},{name:"default",type:"Boolean",view:"BooleanView",defaultValue:!1,help:"Indicates if this is the default action."},{model_:"FunctionProperty",name:"isAvailable",label:"Available",displayWidth:70,displayHeight:3,defaultValue:function(){return!0},help:"Function to determine if action is available."},{model_:"FunctionProperty",name:"isEnabled",label:"Enabled",displayWidth:70,displayHeight:3,defaultValue:function(){return!0},help:"Function to determine if action is enabled."},{model_:"FunctionProperty",name:"labelFn",label:"Label Function",defaultValue:function(a){return a.label},help:"Function to determine label. Defaults to 'this.label'."},{name:"iconUrl",type:"String",defaultValue:void 0,help:"Provides a url for an icon to render for this action"},{name:"showLabel",type:"String",defaultValue:!0,help:"Property indicating whether the label should be rendered along side the icon"},{name:"children",type:"Array",factory:function(){return[]},subType:"Action",view:"ArrayView",help:"Child actions of this action.",persistent:!1},{name:"parent",type:"String",help:"The parent action of this action"},{model_:"FunctionProperty",name:"action",displayWidth:80,displayHeight:20,defaultValue:"",help:"Function to implement action."},{model_:"StringArrayProperty",name:"keyboardShortcuts"}],methods:{callIfEnabled:function(a){this.isEnabled.call(a,this)&&this.action.call(a,this)}}}),Action.getPrototype().callIfEnabled=function(a){this.isEnabled.call(a,this)&&this.action.call(a,this)},FOAModel({name:"Arg",tableProperties:["type","name","description"],properties:[{name:"type",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"Object",help:"The type of this argument."},{name:"javaType",type:"String",required:!1,defaultValueFn:function(){return this.type},help:"The java type that represents the type of this property."},{name:"javascriptType",type:"String",required:!1,defaultValueFn:function(){return this.type},help:"The javascript type that represents the type of this property."},{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the entity."},{model_:"BooleanProperty",name:"required",defaultValue:!0},{name:"defaultValue",help:"Default Value if not required and not provided."},{name:"description",type:"String",displayWidth:70,displayHeight:1,defaultValue:"",help:"A brief description of this topic."},{name:"help",label:"Help Text",type:"String",displayWidth:70,displayHeight:6,defaultValue:"",help:"Help text associated with the entity."}],methods:{decorateFunction:function(a,b){if("Object"===this.type)return a;var c=this.type;return this.required?function(){return void 0===arguments[b]&&console.assert(!1,"Missing required argument# "+b),typeof arguments[b]!==c&&console.assert(!1,"argument# "+b+" type expected to be "+c+", but was "+typeof arguments[b]+": "+arguments[b]),a.apply(this,arguments)}:function(){return void 0!==arguments[b]&&typeof arguments[b]!==c&&console.assert(!1,"argument# "+b+" type expected to be "+c+", but was "+typeof arguments[b]+": "+arguments[b]),a.apply(this,arguments)}}},templates:[{model_:"Template",name:"javaSource",description:"Java Source",template:"<%= this.type %> <%= this.name %>"},{model_:"Template",name:"closureSource",description:"Closure JavaScript Source",template:"@param {<%= this.javascriptType %>} <%= this.name %> ."},{model_:"Template",name:"webIdl",description:"Web IDL Source",template:"<%= this.type %> <%= this.name %>"}]}),FOAModel({name:"Method",tableProperties:["name","description"],properties:[{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the entity."},{name:"description",type:"String",displayWidth:70,displayHeight:1,defaultValue:"",help:"A brief description of this topic."},{name:"help",label:"Help Text",type:"String",displayWidth:70,displayHeight:6,defaultValue:"",help:"Help text associated with the entity."},{name:"code",type:"Function",displayWidth:80,displayHeight:30,view:"FunctionView",help:"Javascript code to implement this method."},{name:"returnType",defaultValue:"",help:"Interface package."},{model_:"BooleanProperty",name:"returnTypeRequired",defaultValue:!0},{model_:"ArrayProperty",name:"args",type:"Array[Arg]",subType:"Arg",view:"ArrayView",factory:function(){return[]
},defaultValue:[],help:"Method arguments."},{name:"isMerged",help:"As a listener, should this be merged?"},{model_:"BooleanProperty",name:"isAnimated",help:"As a listener, should this be animated?",defaultValue:!1}],templates:[{model_:"Template",name:"javaSource",description:"Java Source",template:'<%= this.returnType || "void" %> <%= this.name %>(<% for ( var i = 0 ; i < this.args.length ; i++ ) { var arg = this.args[i]; %><%= arg.javaSource() %><% if ( i < this.args.length-1 ) out(", ");%><% } %>)'},{model_:"Template",name:"closureSource",description:"Closure JavaScript Source",template:"/**\n<% for ( var i = 0; i < this.args.length ; i++ ) { var arg = this.args[i]; %> * <%= arg.closureSource() %>\n<% } %><% if (this.returnType) { %> * @return {<%= this.returnType %>} .\n<% } %> */\n<%= arguments[1] %>.prototype.<%= this.name %> = goog.abstractMethod;"},{model_:"Template",name:"webIdl",description:"Web IDL Source",template:"<%= this.returnType || 'void' %> <%= this.name %>(<% for ( var i = 0 ; i < this.args.length ; i++ ) { var arg = this.args[i]; %><%= arg.webIdl() %><% if ( i < this.args.length-1 ) out(\", \"); %><% } %>)"}]}),Method.getPrototype().decorateFunction=function(a){for(var b=0;b<this.args.length;b++){var c=this.args[b];a=c.decorateFunction(a,b)}var d=this.returnType;return d?function(){var b=a.apply(this,arguments);return typeof b!==d&&console.assert(!1,"return type expected to be "+d+", but was "+typeof b+": "+b),b}:a},Method.getPrototype().generateFunction=function(){return DEBUG?this.decorateFunction(this.code):this.code},FOAModel({name:"Interface",tableProperties:["package","name","description"],properties:[{name:"package",help:"Interface package."},{name:"extends",type:"Array[String]",view:"StringArrayView",help:"Interfaces extended by this interface."},{name:"name",required:!0,help:"Interface name."},{name:"description",type:"String",required:!0,displayWidth:70,displayHeight:1,defaultValue:"",help:"The template's unique name."},{name:"help",label:"Help Text",displayWidth:70,displayHeight:6,view:"TextAreaView",help:"Help text associated with the argument."},{model_:"ArrayProperty",name:"methods",type:"Array[Method]",subType:"Method",view:"ArrayView",factory:function(){return[]},defaultValue:[],help:"Methods associated with the interface."}],templates:[{model_:"Template",name:"javaSource",description:"Java Source",template:'public interface <% out(this.name); %>\n<% if ( this.extends.length ) { %>   extends <%= this.extends.join(", ") %>\n<% } %>{\n<% for ( var i = 0 ; i < this.methods.length ; i++ ) { var meth = this.methods[i]; %>   <%= meth.javaSource() %>;\n<% } %>}'},{model_:"Template",name:"closureSource",description:"Closure JavaScript Source",template:"goog.provide('<%= this.name %>');\n\n/**\n * @interface\n<% for ( var i = 0 ; i < this.extends.length ; i++ ) { var ext = this.extends[i]; %> * @extends {<%= ext %>}\n<% } %> */\n<%= this.name %> = function() {};\n<% for ( var i = 0 ; i <  this.methods.length ; i++ ) { var meth = this.methods[i]; %>\n<%= meth.closureSource(undefined, this.name) %>\n<% } %>"},{model_:"Template",name:"webIdl",description:"Web IDL Source",template:"interface <%= this.name %> <% if (this.extends.length) { %>: <%= this.extends[0] %> <% } %>{\n<% for ( var i = 0 ; i < this.methods.length ; i++ ) { var meth = this.methods[i]; %>  <%= meth.webIdl() %>;\n<% } %>}"}]}),FOAModel({name:"Template",tableProperties:["name","description"],properties:[{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The template's unique name."},{name:"description",type:"String",required:!0,displayWidth:70,displayHeight:1,defaultValue:"",help:"The template's unique name."},{name:"template",type:"String",displayWidth:180,displayHeight:30,rows:30,cols:80,defaultValue:"",view:"TextAreaView",help:"Template text. <%= expr %> or <% out(...); %>"}]}),FOAModel({name:"UnitTest",plural:"Unit Tests",tableProperties:["description","passed","failed"],properties:[{model_:"Property",name:"name",type:"String",required:!0,displayWidth:50,help:"The unit test's name."},{model_:"Property",name:"description",type:"String",displayWidth:70,displayHeight:5,defaultValue:"",help:"A multi-line description of the unit test."},{model_:"IntProperty",name:"passed",required:!0,displayWidth:8,displayHeight:1,view:"IntFieldView",help:"Number of sub-tests to pass."},{model_:"IntProperty",name:"failed",required:!0,displayWidth:8,displayHeight:1,help:"Number of sub-tests to fail."},{name:"scope",hidden:!0,factory:function(){return{}}},{model_:"BooleanProperty",name:"async",defaultValue:!1},{model_:"FunctionProperty",name:"code",label:"Test Code",displayWidth:80,displayHeight:30,fromElement:function(e){var txt=e.innerHTML;return txt=txt.trim().startsWith("function")?txt:this.async?"function(ret) {\n"+txt+"\n}":"function() {\n"+txt+"\n}",eval("("+txt+")")},preSet:function(_,value){if("string"==typeof value&&(value=value.startsWith("function")?eval("("+value+")"):new Function(value)),"function"==typeof value&&this.async&&0===value.length){var str=value.toString();return eval("(function(ret)"+str.substring(str.indexOf("{"))+")")}return value}},{model_:"Property",name:"results",type:"String",mode:"read-only",required:!0,displayWidth:80,displayHeight:20},{model_:"StringArrayProperty",name:"tags",label:"Tags"},{name:"tests",label:"Unit Tests",type:"Array[Unit Test]",subType:"UnitTest",view:"ArrayView",fromElement:function(a){return DOM.initElementChildren(a)},preSet:function(a,b){if(Array.isArray(b))return b;var c=[];for(key in b)c.push(UnitTest.create({name:key,code:b[key]}));return c},factory:function(){return[]},help:"Sub-tests of this test."}],actions:[{name:"test",help:"Run the unit tests.",action:function(){asynchronized(this.atest(),this.LOCK)(function(){})}}],methods:{LOCK:{},atest:function(){var self=this;this.scope.log=this.log.bind(this),this.scope.jlog=this.jlog.bind(this),this.scope.assert=this.assert.bind(this),this.scope.fail=this.fail.bind(this),this.scope.ok=this.ok.bind(this),this.results="",this.passed=0,this.failed=0;var code;with(this.scope)code=eval("("+this.code.toString()+")");var afuncs=[],oldLog;return afuncs.push(function(a){oldLog=console.log,console.log=self.scope.log,a()}),afuncs.push(this.async?code.bind(this):code.abind(this)),afuncs.push(function(a){console.log=oldLog,a()}),this.tests.forEach(function(a){afuncs.push(function(b){a.scope.__proto__=self.scope,a.atest()(b)}),afuncs.push(function(b){self.passed+=a.passed,self.failed+=a.failed,b()})}),aseq.apply(this,afuncs)},append:function(a){this.results+=a},log:function(){for(var a=0;a<arguments.length;a++)this.append(arguments[a]);this.append("\n")},jlog:function(){for(var a=0;a<arguments.length;a++)this.append(JSONUtil.stringify(arguments[a]));this.append("\n")},addHeader:function(a){this.log('<tr><th colspan=2 class="resultHeader">'+a+"</th></tr>")},assert:function(a,b){a?this.passed++:this.failed++,this.log((b?b:"(no message)")+" "+(a?"<font color=green>OK</font>":"<font color=red>ERROR</font>"))},fail:function(a){this.assert(!1,a)},ok:function(a){this.assert(!0,a)}}}),FOAModel({name:"Relationship",tableProperties:["name","label","relatedModel","relatedProperty"],properties:[{name:"name",type:"String",displayWidth:30,displayHeight:1,defaultValueFn:function(){return GLOBAL[this.relatedModel].plural},help:"The coding identifier for the action."},{name:"label",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.name.labelize()},help:"The display label for the action."},{name:"help",label:"Help Text",type:"String",displayWidth:70,displayHeight:6,defaultValue:"",help:"Help text associated with the relationship."},{name:"relatedModel",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The name of the related Model."},{name:"relatedProperty",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The join property of the related Model."}]}),FOAModel({name:"Issue",plural:"Issues",help:"An issue describes a question, feature request, or defect.",ids:["id"],tableProperties:["id","severity","status","summary","assignedTo"],properties:[{model_:"Property",name:"id",label:"Issue ID",type:"String",required:!0,displayWidth:12,displayHeight:1,defaultValue:0,view:"IntFieldView",help:"Issue's unique sequence number."},{name:"severity",view:{create:function(){return ChoiceView.create({choices:["Feature","Minor","Major","Question"]})}},defaultValue:"String",help:"The severity of the issue."},{name:"status",type:"String",required:!0,view:{create:function(){return ChoiceView.create({choices:["Open","Accepted","Complete","Closed"]})}},defaultValue:"String",help:"The status of the issue."},{model_:"Property",name:"summary",type:"String",required:!0,displayWidth:70,displayHeight:1,help:"A one line summary of the issue."},{model_:"Property",name:"created",type:"DateTime",required:!0,displayWidth:50,displayHeight:1,factory:function(){return new Date},help:"When this issue was created."},{model_:"Property",name:"createdBy",type:"String",defaultValue:"kgr",required:!0,displayWidth:30,displayHeight:1,help:"Who created the issue."},{model_:"Property",name:"assignedTo",type:"String",defaultValue:"kgr",displayWidth:30,displayHeight:1,help:"Who the issue is currently assigned to."},{model_:"Property",name:"notes",displayWidth:75,displayHeight:20,view:"TextAreaView",help:"Notes describing issue."}],tests:[{model_:"UnitTest",description:"test1",code:function(){this.addHeader("header"),this.ok("pass"),this.fail("fail")}}]}),function(){for(var a=0;a<Model.templates.length;a++)Model.templates[a]=JSONUtil.mapToObj(Model.templates[a]);!function(){for(var a=Model.properties,b=0;b<a.length;b++)Property.isInstance(a[b])||(a[b]=Property.getPrototype().create(a[b]))}()}(),Model.properties=Model.properties.concat([{name:"protoparser",label:"ProtoParser",type:"Grammar",hidden:!0,"transient":!0,defaultValueFn:function(){for(var a,b={__proto__:BinaryProtoGrammar,START:sym("model"),model:[]},c=0;a=this.properties[c];c++)if(a.prototag){var d,e=ArrayProperty.isInstance(a)?a.subType:a.type;switch(e){case"uint32":case"int32":d=protouint32(a.prototag);break;case"uint64":case"int64":case"fixed64":d=protovarintstring(a.prototag);break;case"boolean":case"bool":d=protobool(a.prototag);break;case"string":d=protostring(a.prototag);break;case"bytes":d=protobytes(a.prototag);break;default:var f=GLOBAL[e];if(!f)throw"Could not find model for "+e;if("Enum"==f.type){d=protouint32(a.prototag);break}d=protomessage(a.prototag,f.protoparser.export("START"))}b[a.name]=d,function(a){b.addAction(a.name,function(b){return[a,b[1]]})}(a),b.model.push(sym(a.name))}b.model.push(sym("unknown field")),b.model=repeat(alt.apply(void 0,b.model));var g=this;return b.addAction("model",function(a){for(var b,c={},d=0;b=a[d];d++)b[0]&&Property.isInstance(b[0])&&(c[b[0].name]=ArrayProperty.isInstance(b[0])?(c[b[0].name]||[]).concat(b[1]):b[1]);return g.create(c)}),this.instance_.protoparser=b,b}}]),Model.methods={getPropertyWithoutCache_:ModelProto.getPropertyWithoutCache_,getProperty:ModelProto.getProperty,getAction:ModelProto.getAction,hashCode:ModelProto.hashCode,buildPrototype:ModelProto.buildPrototype,getPrototype:ModelProto.getPrototype,isSubModel:ModelProto.isSubModel,isInstance:ModelProto.isInstance},Model=Model.getPrototype().create(Model),Model.model_=Model,Model.create=ModelProto.create;var SimpleValue=Model.create({name:"SimpleValue",properties:[{name:"value"}],methods:{init:function(a){this.value=a||""},get:function(){return this.value},set:function(a){this.value=a},toString:function(){return"SimpleValue("+this.value+")"}}});KeyboardShortcutController.prototype.processView_=function(a){var b=a.shortcuts;b&&b.forEach(function(a){var b=a[0],c=a[1],d=a[2];this.addAccelerator(b,c,d)}.bind(this));try{var c=a.children;c.forEach(this.processView_.bind(this))}catch(d){console.log(d)}},KeyboardShortcutController.prototype.addAccelerator=function(a,b,c){if(c){if("string"!=typeof c)throw"Context must be an identifier for a DOM node.";c in this.contexts_||(this.contexts_[c]={}),this.contexts_[c][a]=b}else this.body_[a]=b},KeyboardShortcutController.prototype.shouldIgnoreKeyEventsForTarget_=function(a){var b=a.target;return b.isContentEditable||"INPUT"==b.tagName||"TEXTAREA"==b.tagName},KeyboardShortcutController.prototype.processKey_=function(a){if(!this.shouldIgnoreKeyEventsForTarget_(a)){for(var b=a.target;b&&b!=document.body;b=b.parentNode){var c=b.id;if(c&&c in this.contexts_){var d=this.contexts_[c];if(a.keyIdentifier in d){var e=d[a.keyIdentifier];return e(a),void a.preventDefault()}}}if(console.log("Looking for "+a.keyIdentifier),a.keyIdentifier in this.body_){var e=this.body_[a.keyIdentifier];e(a),a.preventDefault()}}};var DOM={init:function(a){a.document.FOAM_OBJECTS||(a.document.FOAM_OBJECTS={});for(var b=a.document.querySelectorAll("foam"),c=0;c<b.length;c++){var d=b[c];GLOBAL[d.getAttribute("view")],GLOBAL[d.getAttribute("model")]}var e=[];for(var f in USED_MODELS)e.push(arequire(f));aseq(apar.apply(null,e),function(){for(var c=0;c<b.length;c++)this.initElement(b[c],a.document)}.bind(this))()},initElementChildren:function(a){for(var b=[],c=0;c<a.children.length;c++){var d=a.children[c];"FOAM"===d.tagName&&b.push(DOM.initElement(d))}return b},initElement:function(a,b){function c(a){for(var b=0;b<f.properties.length;b++){var c=f.properties[b];if(c.name.toUpperCase()==a)return c}return null}if(!b||b.contains(a)){var d={},e=a.getAttribute("model"),f=GLOBAL[e];if(!f)return console.error("Unknown Model: ",e),void(a.outerHTML="Unknown Model: "+e);f.getPrototype();for(var g=0;g<a.attributes.length;g++){var h=a.attributes[g],i=h.name,j=h.value,k=f.getProperty(i);k?(j.startsWith("#")&&(j=j.substring(1),j=$(j)),d[i]=j):{model:!0,view:!0,id:!0,oninit:!0,showactions:!0}[i]||console.log("unknown attribute: ",i)}for(var g=0;g<a.children.length;g++){var l=a.children[g],i=l.nodeName,k=c(i);k?d[k.name]=k.fromElement(l):console.log("unknown element: ",i)}var m=f.create(d),n=a.getAttribute("oninit");if(n&&Function(n).bind(m)(),b){var o;if(View.isInstance(m)||CView.isInstance(m))o=m;else{var p=a.getAttribute("view"),q=p?GLOBAL[p]:DetailView;if(o=q.create({model:f,value:SimpleValue.create(m)}),!p){var h=a.getAttribute("showActions");o.showActions=h?h.equalsIC("y")||h.equalsIC("yes")||h.equalsIC("true")||h.equalsIC("t"):!0}}a.id&&(b.FOAM_OBJECTS[a.id]=m),m.view_=o,a.outerHTML=o.toHTML(),o.initHTML()}return m}},setClass:function(a,b,c){var d=a.className||"",e=void 0===c?!0:c;a.className=d.replace(" "+b,"").replace(b,""),e&&(a.className=a.className+" "+b)}};window.addEventListener("load",function(){DOM.init(X)},!1),FOAModel({name:"View",label:"View",properties:[{name:"id",label:"Element ID",type:"String",factory:function(){return this.nextID()}},{name:"parent",type:"View",hidden:!0},{name:"children",type:"Array[View]",factory:function(){return[]}},{name:"shortcuts",type:"Array[Shortcut]",factory:function(){return[]}},{name:"$",hidden:!0,mode:"read-only",getter:function(){return $(this.id)},help:"DOM Element."},{name:"tagName",defaultValue:"span"},{name:"className",defaultValue:""},{name:"extraClassName",defaultValue:""}],methods:{ON_HIDE:["onHide"],ON_SHOW:["onShow"],deepPublish:function(){var a=this.publish.apply(this,arguments);if(this.children)for(var b=0;b<this.children.length;b++){var c=this.children[b];a+=c.deepPublish.apply(c,arguments)}return a},strToHTML:function(a){return a.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},cssClassAttr:function(){return this.className?' class="'+this.className+" "+this.extraClassName+'"':""},dynamicTag:function(a,b){var c=this.nextID();return this.X.dynamic(function(){var a=b(),d=$(c);d&&(d.innerHTML=a)}.bind(this)),"<"+a+' id="'+c+'"></'+a+">"},bindSubView:function(a,b){a.setValue(this.propertyValue(b.name))},viewModel:function(){return this.model_},createView:function(a,b){var c=b&&b.X||this.X,d=c.PropertyView.create({prop:a,args:b});return this.addChild(d),d},createActionView:function(a,b,c){var d=c&&c.X||this.X,e=c&&c.model_?c.model_:"ActionButton",f=d[e].create({action:a,value:b}).copyFrom(c);return this[a.name+"View"]=f,f},createTemplateView:function(a,b){var c=this.model_[a];return Action.isInstance(c)?this.createActionView(c,SimpleValue.create(this),b):this.createView(c,b)},focus:function(){this.$&&this.$.focus&&this.$.focus()},addChild:function(a){if(!a.parent){try{a.parent=this}catch(b){console.log(b)}var c=this.children;return c.push(a),this.children=c,this}},removeChild:function(a){return this.children.deleteI(a),a.parent=void 0,this},addChildren:function(){return Array.prototype.forEach.call(arguments,this.addChild.bind(this)),this},addShortcut:function(a,b,c){this.shortcuts.push([a,b,c])},nextID:function(){return"view"+(arguments.callee._nextId=(arguments.callee._nextId||0)+1)},addInitializer:function(a){(this.initializers_||(this.initializers_=[])).push(a)},on:function(a,b,c){return c=c||this.nextID(),b=b.bind(this),this.addInitializer(function(){var d=$(c);d&&d.addEventListener(a,b.bind(this),!1)}),c},setAttribute:function(a,b,c){c=c||this.nextID(),b=b.bind(this),this.addInitializer(function(){this.X.dynamic(b,function(){var d=$(c);if(!d)throw EventService.UNSUBSCRIBE_EXCEPTION;var e=b(d.getAttribute(a));void 0==e?d.removeAttribute(a):d.setAttribute(a,e)})}.bind(this))},setClass:function(a,b,c){return c=c||this.nextID(),b=b.bind(this),this.addInitializer(function(){this.X.dynamic(b,function(){var d=$(c);if(!d)throw EventService.UNSUBSCRIBE_EXCEPTION;DOM.setClass(d,a,b())})}.bind(this)),c},insertInElement:function(a){var b=$(a);b.innerHTML=this.toHTML(),this.initHTML()},write:function(a){a.writeln(this.toHTML()),this.initHTML()},updateHTML:function(){this.$&&(this.$.innerHTML=this.toInnerHTML(),this.initInnerHTML())},toInnerHTML:function(){return""},toHTML:function(){return"<"+this.tagName+' id="'+this.id+'"'+this.cssClassAttr()+">"+this.toInnerHTML()+"</"+this.tagName+">"},initHTML:function(){this.initInnerHTML()},initInnerHTML:function(){this.invokeInitializers(),this.initChildren()},initChildren:function(){if(this.children)for(var a=0;a<this.children.length;a++)try{this.children[a].initHTML()}catch(b){console.log("Error on View.child.initHTML",b,b.stack)}},invokeInitializers:function(){if(this.initializers_){for(var a=0;a<this.initializers_.length;a++)this.initializers_[a]();this.initializers_=void 0}},destroy:function(){},close:function(){this.$&&this.$.remove(),this.destroy(),this.publish("closed")}}}),FOAModel({name:"PropertyView",extendsModel:"View",properties:[{name:"prop",type:"Property"},{name:"parent",type:"View",postSet:function(a,b){b[this.prop.name+"View"]=this.view,this.data||(this.data=b.data||b.get&&b.get()),this.view&&(this.view.parent=b)}},{name:"data",postSet:function(){this.bindData()}},{name:"innerView",help:"Override for prop.view"},{name:"view",type:"View"},"args"],methods:{init:function(a){if(this.SUPER(a),this.args&&this.args.model_){var b=this.X[this.args.model_].create(this.prop);delete this.args.model_}else b=this.createViewFromProperty(this.prop);b.copyFrom(this.args),b.parent=this.parent,this.view=b,this.bindData()},createViewFromProperty:function(a){var b=this.innerView||a.view;if(!b)return this.X.TextFieldView.create(a);if("string"==typeof b)return this.X[b].create(a);if(b.model_&&"string"==typeof b.model_)return FOAM(a.view);if(b.model_){var c=b.deepClone().copyFrom(a);return c.id=c.nextID(),c}return"function"==typeof b?b(a,this):b.create(a)},bindData:function(){var a=this.view,b=this.data;if(a&&b){var c=b.propertyValue(this.prop.name);a.model_.DATA?Events.link(c,a.data$):a.setValue?a.setValue(c):a.value=c}},toHTML:function(){return this.view.toHTML()},initHTML:function(){this.view.initHTML()}}}),FOAModel({name:"PopupView",extendsModel:"View",properties:[{name:"view",type:"View"},{name:"x"},{name:"y"},{name:"width",defaultValue:void 0},{name:"maxWidth",defaultValue:void 0},{name:"maxHeight",defaultValue:void 0},{name:"height",defaultValue:void 0}],methods:{open:function(a){if(!this.$){var b=(a.$||a).ownerDocument,c=b.createElement("div");c.style.left=this.x+"px",c.style.top=this.y+"px",this.width&&(c.style.width=this.width+"px"),this.height&&(c.style.height=this.height+"px"),this.maxWidth&&(c.style.maxWidth=this.maxWidth+"px"),this.maxHeight&&(c.style.maxHeight=this.maxHeight+"px"),c.style.position="absolute",c.id=this.id,c.innerHTML=this.view.toHTML(),b.body.appendChild(c),this.view.initHTML()}},close:function(){this.$&&this.$.remove()},destroy:function(){this.close(),this.view.destroy()}}}),FOAModel({name:"AutocompleteView",extendsModel:"PopupView",help:"Default autocomplete popup.",properties:["closeTimeout","autocompleter","completer","current",{model_:"IntProperty",name:"closeTime",units:"ms",help:"Time to delay the actual close on a .close call.",defaultValue:200},{name:"view",postSet:function(a,b){a&&(a.data$.removeListener(this.complete),a.choices$.removeListener(this.choicesUpdate)),b.data$.addListener(this.complete),b.choices$.addListener(this.choicesUpdate)}},{name:"target",postSet:function(a,b){a&&a.unsubscribe("keydown",this.onKeyDown),b.subscribe("keydown",this.onKeyDown)}},{name:"maxHeight",defaultValue:400},{name:"className",defaultValue:"autocompletePopup"}],methods:{autocomplete:function(a){if(!this.completer){var b=FOAM.lookup(this.autocompleter,this.X);this.completer=b.create()}this.view||(this.view=this.makeView()),this.current=a,this.open(this.target),this.completer.autocomplete(a)},makeView:function(){return this.X.ChoiceListView.create({dao:this.completer.autocompleteDao,extraClassName:"autocomplete",orientation:"vertical",mode:"final",objToChoice:this.completer.f,useSelection:!0})},init:function(a){this.SUPER(a),this.subscribe("blur",function(){this.close()}.bind(this))},open:function(a){if(this.closeTimeout&&(this.X.clearTimeout(this.closeTimeout),this.closeTimeout=0),this.$)return void this.position(this.$.firstElementChild,a.$||a);var b=a.$||a,c=b.ownerDocument;this.X.document!==c;var d=(c.createElement("div"),c.defaultView);this.X.window!==d,b.insertAdjacentHTML("afterend",this.toHTML().trim()),this.position(this.$.firstElementChild,b),this.initHTML()},close:function(a){if(a)return this.closeTimeout&&(this.X.clearTimeout(this.closeTimeout),this.closeTimeout=0),void this.SUPER();if(!this.closeTimeout){var b=this.SUPER,c=this;this.closeTimeout=this.X.setTimeout(function(){c.closeTimeout=0,b.call(c)},this.closeTime)}},position:function(a,b){var c=b.ownerDocument,d=findPageXY(b),e=[c.firstElementChild.offsetWidth,c.firstElementChild.offsetHeight];e[1]-(d[1]+b.offsetHeight)<(this.height||this.maxHeight||400)&&(a.style.bottom=b.offsetHeight,c.defaultView.innerHeight-d[1]),a.style.left=d[2].offsetWidth-d[0]<600?600-d[2].offsetWidth:-b.offsetWidth,this.width&&(a.style.width=this.width+"px"),this.height&&(a.style.height=this.height+"px"),this.maxWidth&&(a.style.maxWidth=this.maxWidth+"px",a.style.overflowX="auto"),this.maxHeight&&(a.style.maxHeight=this.maxHeight+"px",a.style.overflowY="auto")}},listeners:[{name:"onKeyDown",code:function(a,a,b){this.view&&(38===b.keyCode?(this.view.index--,this.view.scrollToSelection(this.$),b.preventDefault()):40===b.keyCode?(this.view.index++,this.view.scrollToSelection(this.$),b.preventDefault()):13===b.keyCode&&(this.view.commit(),b.preventDefault()))}},{name:"complete",code:function(){this.target.onAutocomplete(this.view.data),this.view=this.makeView(),this.close(!0)}},{name:"choicesUpdate",code:function(){this.view&&(0===this.view.choices.length||1===this.view.choices.length&&this.view.choices[0][1]===this.current)&&this.close(!0)}}],templates:[function(){}]}),FOAModel({name:"StaticHTML",extendsModel:"View",properties:[{model_:"StringProperty",name:"content"},{model_:"BooleanProperty",name:"escapeHTML",defaultValue:!1}],methods:{toHTML:function(){return this.escapeHTML?this.strToHTML(this.content):this.content}}}),FOAModel({name:"MenuSeparator",extendsModel:"StaticHTML",properties:[{name:"content",defaultValue:'<hr class="menuSeparator">'}]});var DomValue={DEFAULT_EVENT:"change",DEFAULT_PROPERTY:"value",create:function(a,b,c){if(!a)throw"Missing Element in DomValue";return{__proto__:this,element:a,event:b||this.DEFAULT_EVENT,property:c||this.DEFAULT_PROPERTY}},setElement:function(a){this.element=a},get:function(){return this.element[this.property]},set:function(a){this.element[this.property]!==a&&(this.element[this.property]=a)},addListener:function(a){if(this.event)try{this.element.addEventListener(this.event,a,!1)}catch(b){}},removeListener:function(a){if(this.event)try{this.element.removeEventListener(this.event,a,!1)}catch(b){}},toString:function(){return"DomValue("+this.event+", "+this.property+")"}};FOAModel({name:"WindowHashValue",properties:[{name:"window",defaultValueFn:function(){return this.X.window}}],methods:{get:function(){return this.window.location.hash?this.window.location.hash.substring(1):""},set:function(a){this.window.location.hash=a},addListener:function(a){this.window.addEventListener("hashchange",a,!1)},removeListener:function(a){this.window.removeEventListener("hashchange",a,!1)},toString:function(){return"WindowHashValue("+this.get()+")"}}}),X.memento=X.WindowHashValue.create(),FOAModel({name:"ImageView",extendsModel:"View",properties:[{name:"value",factory:function(){return SimpleValue.create()},postSet:function(a,b){a&&Events.unfollow(a,this.domValue),Events.follow(b,this.domValue)}},{name:"data",getter:function(){return this.value.get()},setter:function(a){this.value=SimpleValue.create(a)}},{name:"backupImage"},{name:"domValue",postSet:function(a,b){a&&Events.unfollow(this.value,a),Events.follow(this.value,b)}},{name:"displayWidth",postSet:function(a,b){this.$&&(this.$.style.width=b)}},{name:"displayHeight",postSet:function(a,b){this.$&&(this.$.style.height=b)}}],methods:{setValue:function(a){this.value=a},toHTML:function(){return this.backupImage&&window.IS_CHROME_APP?'<img class="imageView" id="'+this.id+'" src="'+this.backupImage+'">':'<img class="imageView" id="'+this.id+'" src="'+this.data+'">'},isSupportedUrl:function(a){return a=a.trim().toLowerCase(),a.startsWith("data:")||a.startsWith("blob:")||a.startsWith("filesystem:")},initHTML:function(){if(this.SUPER(),this.backupImage&&this.$.addEventListener("error",function(){this.data=this.backupImage}.bind(this)),window.IS_CHROME_APP&&!this.isSupportedUrl(this.value.get())){var a=this,b=new XMLHttpRequest;b.open("GET",this.value.get()),b.responseType="blob",b.asend(function(b){b&&(a.$.src=URL.createObjectURL(b))})}else this.domValue=DomValue.create(this.$,void 0,"src"),this.displayHeight=this.displayHeight,this.displayWidth=this.displayWidth}}}),FOAModel({name:"BlobImageView",extendsModel:"View",help:"Image view for rendering a blob as an image.",properties:[{name:"value",factory:function(){return SimpleValue.create()},postSet:function(a,b){a&&a.removeListener(this.onValueChange),b.addListener(this.onValueChange)}},{model_:"IntProperty",name:"displayWidth"},{model_:"IntProperty",name:"displayHeight"}],methods:{setValue:function(a){this.value=a},toHTML:function(){return'<img id="'+this.id+'">'},initHTML:function(){this.SUPER();var a=this;this.$.style.width=a.displayWidth,this.$.style.height=a.displayHeight,this.onValueChange()}},listeners:[{name:"onValueChange",code:function(){this.value.get()&&this.$&&(this.$.src=URL.createObjectURL(this.value.get()))}}]}),FOAModel({name:"TextFieldView",label:"Text Field",extendsModel:"View",properties:[{model_:"StringProperty",name:"name",defaultValue:"field"},{model_:"IntProperty",name:"displayWidth",defaultValue:30},{model_:"IntProperty",name:"displayHeight",defaultValue:1},{model_:"StringProperty",name:"type",defaultValue:"text"},{model_:"StringProperty",name:"placeholder",defaultValue:void 0},{model_:"BooleanProperty",name:"onKeyMode",help:"If true, value is updated on each keystroke."},{model_:"BooleanProperty",name:"escapeHTML",help:"If true, HTML content is excaped in display mode."},{model_:"StringProperty",name:"mode",defaultValue:"read-write",view:{create:function(){return ChoiceView.create({choices:["read-only","read-write","final"]})}}},{name:"domValue"},{name:"data"},{model_:"StringProperty",name:"readWriteTagName",defaultValueFn:function(){return 1===this.displayHeight?"input":"textarea"}},{model_:"BooleanProperty",name:"autocomplete",defaultValue:!0},"autocompleter","autocompleteView"],methods:{ESCAPE:["escape"],toHTML:function(){return"read-write"===this.mode?this.toReadWriteHTML():this.toReadOnlyHTML()},toReadWriteHTML:function(){var a="<"+this.readWriteTagName+' id="'+this.id+'"';return a+=' type="'+this.type+'" '+this.cssClassAttr(),a+="input"===this.readWriteTagName?' size="'+this.displayWidth+'"':' rows="'+this.displayHeight+'" cols="'+this.displayWidth+'"',a+=' name="'+this.name+'">',a+="</"+this.readWriteTagName+">"},toReadOnlyHTML:function(){return"<"+this.tagName+' id="'+this.id+'"'+this.cssClassAttr()+' name="'+this.name+'"></'+this.tagName+">"},setupAutocomplete:function(){if(this.autocomplete&&this.autocompleter){var a=this.autocompleteView=this.X.AutocompleteView.create({autocompleter:this.autocompleter,target:this});this.bindAutocompleteEvents(a)}},onAutocomplete:function(a){this.data=a},bindAutocompleteEvents:function(a){this.$.addEventListener("blur",function(){a.publish("blur")}),this.$.addEventListener("input",function(){a.autocomplete(this.textToValue(this.$.value))}.bind(this)),this.$.addEventListener("focus",function(){a.autocomplete(this.textToValue(this.$.value))}.bind(this))},initHTML:function(){this.SUPER(),this.placeholder&&(this.$.placeholder=this.placeholder),"read-write"===this.mode?(this.domValue=DomValue.create(this.$,this.onKeyMode?"input":"change"),Events.relate(this.data$,this.domValue,this.valueToText.bind(this),this.textToValue.bind(this),this.onKeyMode),this.onKeyMode&&this.$.addEventListener("blur",this.onBlur),this.$.addEventListener("keydown",this.onKeyDown),this.setupAutocomplete()):(this.domValue=DomValue.create(this.$,"undefined",this.escapeHTML?"textContent":"innerHTML"),Events.map(this.data$,this.domValue,this.valueToText.bind(this)))},textToValue:function(a){return a},valueToText:function(a){return a},destroy:function(){Events.unlink(this.domValue,this.data$)}},listeners:[{name:"onKeyDown",code:function(a){27==a.keyCode?(this.domValue.set(this.data),this.publish(this.ESCAPE)):this.publish("keydown",a)}},{name:"onBlur",code:function(){this.domValue.get()!==this.data&&this.domValue.set(this.data)}}]}),FOAModel({name:"DateFieldView",label:"Date Field",extendsModel:"TextFieldView",properties:[{model_:"StringProperty",name:"type",defaultValue:"date"}],methods:{initHTML:function(){this.domValue=DomValue.create(this.$,void 0,"valueAsDate"),Events.link(this.data$,this.domValue)}}}),FOAModel({name:"DateTimeFieldView",label:"Date-Time Field",extendsModel:"View",properties:[{model_:"StringProperty",name:"name"},{model_:"StringProperty",name:"mode",defaultValue:"read-write"},{name:"domValue",postSet:function(a){a&&this.value&&Events.unlink(a,this.value)}},{name:"data"}],methods:{valueToDom:function(a){return a?a.getTime():0},domToValue:function(a){return new Date(a)},toHTML:function(){return"read-write"===this.mode?'<input id="'+this.id+'" type="datetime-local" name="'+this.name+'"/>':'<span id="'+this.id+'" name="'+this.name+'"></span>'},initHTML:function(){this.SUPER(),this.domValue=DomValue.create(this.$,"read-write"===this.mode?"input":void 0,"read-write"===this.mode?"valueAsNumber":"textContent"),Events.relate(this.data$,this.domValue,this.valueToDom,this.domToValue),Events.relate(this.data$,this.domValue,this.valueToDom.bind(this),this.domToValue.bind(this))}}}),FOAModel({name:"RelativeDateTimeFieldView",label:"Relative Date-Time Field",extendsModel:"DateTimeFieldView",properties:[{name:"mode",defaultValue:"read-only"}],methods:{valueToDom:function(a){return a.toRelativeDateString()}}}),FOAModel({name:"HTMLView",label:"HTML Field",extendsModel:"View",properties:[{name:"name",type:"String",defaultValue:""},{model_:"StringProperty",name:"tag",defaultValue:"span"},{name:"value",type:"Value",factory:function(){return SimpleValue.create()
},postSet:function(a,b){"read-write"===this.mode?(Events.unlink(this.domValue,a),Events.link(b,this.domValue)):Events.follow(b,this.domValue)}}],methods:{toHTML:function(){var a="<"+this.tag+' id="'+this.id+'"';return this.name&&(a+=' name="'+this.name+'"'),a+="></"+this.tag+">"},getValue:function(){return this.value},setValue:function(a){this.value=a},initHTML:function(){var a=this.$;return a?(this.domValue=DomValue.create(a,void 0,"innerHTML"),void this.setValue(this.value)):void console.log("stale HTMLView")},destroy:function(){Events.unlink(this.domValue,this.value)}}}),FOAModel({name:"RoleView",extendsModel:"View",properties:[{name:"roleName",type:"String",defaultValue:""},{name:"models",type:"Array[String]",defaultValue:[]},{name:"selection",type:"Value",factory:function(){return SimpleValue.create()}},{name:"model",type:"Model"}],methods:{initHTML:function(){var a=this.$;this.domValue=DomValue.create(a),Events.link(this.value,this.domValue)},toHTML:function(){var a="";a+='<select id="'+this.id+'" name="'+this.name+'" size='+this.size+"/>";for(var b=0;b<this.choices.length;b++)a+="	<option>"+this.choices[b].toString()+"</option>";return a+="</select>"},getValue:function(){return this.value},setValue:function(a){Events.unlink(this.domValue,this.value),this.value=a,Events.link(a,this.domValue)},destroy:function(){Events.unlink(this.domValue,this.value)}}}),FOAModel({name:"BooleanView",extendsModel:"View",properties:[{name:"name",label:"Name",type:"String",defaultValue:"field"}],methods:{toHTML:function(){return'<input type="checkbox" id="'+this.id+'" name="'+this.name+'"'+this.cssClassAttr()+"/>"},initHTML:function(){var a=this.$;this.domValue=DomValue.create(a,"change","checked"),Events.link(this.value,this.domValue)},getValue:function(){return this.value},setValue:function(a){Events.unlink(this.domValue,this.value),this.value=a,Events.link(a,this.domValue)},destroy:function(){Events.unlink(this.domValue,this.value)}}}),FOAModel({name:"ImageBooleanView",extendsModel:"View",properties:[{name:"name",label:"Name",type:"String",defaultValue:""},{name:"value",postSet:function(a,b){a&&a.removeListener(this.update),b.addListener(this.update),this.update()}},{name:"trueImage"},{name:"falseImage"}],methods:{image:function(){return this.value.get()?this.trueImage:this.falseImage},toHTML:function(){var a=this.id;return this.on("click",this.onClick,a),this.name?'<img id="'+a+'" '+this.cssClassAttr()+'" name="'+this.name+'">':'<img id="'+a+'" '+this.cssClassAttr()+">"},initHTML:function(){this.$&&(this.invokeInitializers(),this.$.src=this.image())},getValue:function(){return this.value},setValue:function(a){this.value=a},destroy:function(){this.value.removeListener(this.update)}},listeners:[{name:"update",code:function(){this.$&&(this.$.src=this.image())}},{name:"onClick",code:function(a){a.stopPropagation(),this.value.set(!this.value.get())}}]}),FOAModel({name:"CSSImageBooleanView",extendsModel:"View",properties:["data"],methods:{initHTML:function(){this.$&&(this.data$.addListener(this.update),this.$.addEventListener("click",this.onClick))},toHTML:function(){return'<span id="'+this.id+'" class="'+this.className+" "+(this.data?"true":"")+'">&nbsp;&nbsp;&nbsp;</span>'}},listeners:[{name:"update",code:function(){this.$&&DOM.setClass(this.$,"true",this.data)}},{name:"onClick",code:function(a){a.stopPropagation(),this.data=!this.data,this.update()}}]}),FOAModel({name:"ImageBooleanView2",extendsModel:"View",properties:[{name:"name",label:"Name",type:"String",defaultValue:"field"},{name:"value",postSet:function(){this.$&&(this.$.src=this.image())}},{name:"trueImage"},{name:"falseImage"}],methods:{image:function(){return this.value?this.trueImage:this.falseImage},toHTML:function(){return'<img id="'+this.id+'" name="'+this.name+'">'},initHTML:function(){this.$.addEventListener("click",this.onClick),this.$.src=this.image()}},listeners:[{name:"onClick",code:function(a){a.stopPropagation(),this.value=!this.value}}]}),FOAModel({name:"TextAreaView",extendsModel:"TextFieldView",label:"Text-Area View",properties:[{model_:"IntProperty",name:"displayHeight",defaultValue:5},{model_:"IntProperty",name:"displayWidth",defaultValue:70}]}),FOAModel({name:"FunctionView",extendsModel:"TextFieldView",properties:[{name:"onKeyMode",defaultValue:!0},{name:"displayWidth",defaultValue:80},{name:"displayHeight",defaultValue:8},{name:"errorView",factory:function(){return TextFieldView.create({mode:"read-only"})}}],methods:{initHTML:function(){this.SUPER(),this.errorView.initHTML(),this.errorView.$.style.color="red",this.errorView.$.style.display="none"},toHTML:function(){return this.errorView.toHTML()+" "+this.SUPER()},setError:function(a){this.errorView.data=a||"",this.errorView.$.style.display=a?"block":"none"},textToValue:function(text){if(!text)return null;try{var ret=eval("("+text+")");return this.setError(void 0),ret}catch(x){return console.log("JS Error: ",x,text),this.setError(x),text}},valueToText:function(a){return a?a.toString():""}}}),FOAModel({name:"JSView",extendsModel:"TextAreaView",methods:{init:function(a){this.SUPER(),this.cols=a&&a.displayWidth||100,this.rows=a&&a.displayHeight||50},textToValue:function(a){try{return JSONUtil.parse(a)}catch(b){console.log("error")}return a},valueToText:function(a){return JSONUtil.pretty.stringify(a)}}}),FOAModel({name:"XMLView",label:"XML View",extendsModel:"TextAreaView",methods:{init:function(a){this.SUPER(),this.cols=a&&a.displayWidth||100,this.rows=a&&a.displayHeight||50},textToValue:function(a){return this.val_},valueToText:function(a){return this.val_=a,XMLUtil.stringify(a)}}}),FOAModel({name:"SummaryView",extendsModel:"View",properties:[{name:"model",type:"Model"},{name:"value",type:"Value",factory:function(){return SimpleValue.create()}}],methods:{getValue:function(){return this.value},toHTML:function(){return(this.model.getPrototype().toSummaryHTML||this.defaultToHTML).call(this)},defaultToHTML:function(){this.children=[];var a=this.model,b=this.get(),c=[];c.push('<div id="'+this.id+'" class="summaryView">'),c.push("<table>");for(var d=0;d<a.properties.length;d++){var e=a.properties[d];if(!e.hidden){var f=b[e.name];f&&(c.push("<tr>"),c.push('<td class="label">'+e.label+"</td>"),c.push('<td class="value">'),c.push(e.summaryFormatter?e.summaryFormatter(this.strToHTML(f)):this.strToHTML(f)),c.push("</td></tr>"))}}return c.push("</table>"),c.push("</div>"),c.join("")},get:function(){return this.getValue().get()}}}),FOAModel({name:"HelpView",extendsModel:"View",properties:[{name:"model",type:"Model"}],methods:{toHTML:function(){var a=this.model,b=[];b.push('<div id="'+this.id+'" class="helpView">'),b.push('<div class="intro">'),b.push(a.help),b.push("</div>");for(var c=0;c<a.properties.length;c++){var d=a.properties[c];if(!d.hidden){if(b.push('<div class="label">'),b.push(d.label),b.push('</div><div class="text">'),d.subType&&-1!=d.type.indexOf("[")){var e=this.X[d.subType],f=HelpView.create({model:e});e!=a&&b.push(f.toHTML())}else b.push(d.help);b.push("</div>")}}return b.push("</div>"),b.join("")}}}),FOAModel({name:"EditColumnsView",extendsModel:"View",properties:[{name:"model",type:"Model"},{model_:"StringArrayProperty",name:"properties"},{model_:"StringArrayProperty",name:"availableProperties"}],listeners:[{name:"onAddColumn",code:function(a){this.properties=this.properties.concat([a])}},{name:"onRemoveColumn",code:function(a){this.properties=this.properties.deleteF(a)}}],methods:{toHTML:function(){var a='<span id="'+this.id+'" class="editColumnView" style="position: absolute;right: 0.96;background: white;top: 138px;border: 1px solid black;">';a+="Show columns:",a+="<table>";for(var b=0;b<this.properties.length;b++){var c=this.model.getProperty(this.properties[b]);a+='<tr><td id="'+this.on("click",this.onRemoveColumn.bind(this,c.name))+'">&nbsp;&#x2666;&nbsp;'+c.label+"</td></tr>"}for(var b=0;b<this.availableProperties.length;b++){var c=this.availableProperties[b];-1==this.properties.indexOf(c.name)&&(a+='<tr><td id="'+this.on("click",this.onAddColumn.bind(this,c.name))+'">&nbsp;&nbsp;&nbsp;&nbsp;'+c.label+"</td></tr>")}return a+="</table>",a+="</span>"}}}),FOAModel({name:"ActionButton",extendsModel:"View",properties:[{name:"action",postSet:function(a,b){a&&a.removeListener(this.render),b.addListener(this.render)}},{name:"data",setter:function(a,b){this.value=SimpleValue.create(b)}},{name:"value",type:"Value",factory:function(){return SimpleValue.create()}},{name:"className",factory:function(){return"actionButton actionButton-"+this.action.name}},{name:"tagName",defaultValue:"button"},{name:"showLabel",defaultValueFn:function(){return this.action.showLabel}},{name:"iconUrl",defaultValueFn:function(){return this.action.iconUrl}}],listeners:[{name:"render",isAnimated:!0,code:function(){this.updateHTML()}}],methods:{toHTML:function(){var a=this,b=a.value.get();return this.on("click",function(){a.action.callIfEnabled(a.value.get())},this.id),this.setAttribute("data-tip",function(){return a.action.help||void 0},this.id),this.setAttribute("disabled",function(){var b=a.value.get();return a.action.isEnabled.call(b,a.action)?void 0:"disabled"},this.id),this.X.dynamic(function(){a.action.labelFn.call(b,a.action),a.updateHTML()}),this.SUPER()},toInnerHTML:function(){var a="";if(this.iconUrl&&(a+='<img src="'+XMLUtil.escapeAttr(this.action.iconUrl)+'">'),this.showLabel){var b=this.value.get();a+=b?this.action.labelFn.call(b,this.action):this.action.label}return a}}}),FOAModel({name:"ActionLink",extendsModel:"ActionButton",properties:[{name:"className",factory:function(){return"actionLink actionLink-"+this.action.name}},{name:"tagName",defaultValue:"a"}],methods:{toHTML:function(){return this.setAttribute("href",function(){return"#"},this.id),this.SUPER()},toInnerHTML:function(){if(this.action.iconUrl)return'<img src="'+XMLUtil.escapeAttr(this.action.iconUrl)+'" />';if(this.action.showLabel){var a=this.value.get();return a?this.action.labelFn.call(a,this.action):this.action.label}}}}),FOAModel({name:"ToolbarView",label:"Toolbar",extendsModel:"View",properties:[{model_:"BooleanProperty",name:"horizontal",defaultValue:!0},{model_:"BooleanProperty",name:"icons",defaultValueFn:function(){return this.horizontal}},{name:"value",type:"Value",factory:function(){return SimpleValue.create()},postSet:function(){}},{name:"left"},{name:"top"},{name:"bottom"},{name:"right"},{name:"document"},{model_:"BooleanPropery",name:"openedAsMenu",defaultValue:!1}],methods:{preButton:function(){return" "},postButton:function(){return this.horizontal?" ":"<br>"},openAsMenu:function(){var a=this.document.createElement("div");this.openedAsMenu=!0,a.id=this.nextID(),a.className="ActionMenuPopup",this.top?a.style.top=this.top:a.style.bottom=this.bottom,this.left?a.style.left=this.left:a.style.right=this.right,a.innerHTML=this.toHTML(!0);var b=this;a.onclick=function(){b.close()},a.onmouseout=function(c){c.toElement.parentNode!=a&&c.toElement.parentNode.parentNode!=a&&b.close()},this.document.body.appendChild(a),this.initHTML()},close:function(){return this.openedAsMenu?(this.openedAsMenu=!1,this.$.parentNode.remove(),this.destroy(),void this.publish("closed")):this.SUPER()},toHTML:function(a){var b="",c=a?"ActionMenu":"ActionToolbar";b+='<div id="'+this.id+'" class="'+c+'">';for(var d=0;d<this.children.length;d++)b+=this.preButton(this.children[d])+this.children[d].toHTML()+(MenuSeparator.isInstance(this.children[d])?"":this.postButton(this.children[d]));return b+="</div>"},initHTML:function(){this.SUPER(),this.addShortcut("Right",function(a){for(var b=0;b<this.children.length&&a.target!=this.children[b].$;++b);b=(b+1)%this.children.length,this.children[b].$.focus()}.bind(this),this.id),this.addShortcut("Left",function(a){for(var b=0;b<this.children.length&&a.target!=this.children[b].$;++b);b=(b+this.children.length-1)%this.children.length,this.children[b].$.focus()}.bind(this),this.id)},addAction:function(a){var b=ActionButton.create({action:a,value:this.value});if(a.children.length>0){var c=this;b.action=a.clone(),b.action.action=function(){var d=ToolbarView.create({value:c.value,document:c.document,left:b.$.offsetLeft,top:b.$.offsetTop});d.addActions(a.children),d.openAsMenu(b)}}this.addChild(b)},addActions:function(a){a.forEach(this.addAction.bind(this))},addSeparator:function(){this.addChild(MenuSeparator.create())}}}),FOAModel({name:"ActionBorder",properties:[{name:"actions"},{name:"value"}],methods:{toHTML:function(a,b,c){var d="";d+=b.apply(this,c),d+='<div class="actionToolbar">';for(var e=a.actions||this.model.actions,f=0;f<e.length;f++){var g=e[f],h=ActionButton.create({action:g});a.value?h.value$=a.value$:this.value?h.value$=this.value$:h.value=SimpleValue.create(this),d+=" "+h.toHTML()+" ",this.addChild(h)}return d+="</div>"}}}),FOAModel({name:"ProgressView",extendsModel:"View",properties:[{name:"value",type:"Value",factory:function(){return SimpleValue.create()}}],methods:{toHTML:function(){return'<progress value="25" id="'+this.id+'" max="100" >25</progress>'},setValue:function(a){this.value.removeListener(this.listener_),this.value=a,a.addListener(this.listener_)},updateValue:function(){var a=this.$;a.value=parseInt(this.value.get())},initHTML:function(){this.$;this.listener_=this.updateValue.bind(this),this.value.addListener(this.listener_)},destroy:function(){this.value.removeListener(this.listener_)}}});var ArrayView={create:function(a){var b=DAOController.create({model:GLOBAL[a.subType]});return b}};FOAModel({name:"GridView",extendsModel:"View",properties:[{name:"row",type:"ChoiceView",factory:function(){return ChoiceView.create()}},{name:"col",label:"column",type:"ChoiceView",factory:function(){return ChoiceView.create()}},{name:"acc",label:"accumulator",type:"ChoiceView",factory:function(){return ChoiceView.create()}},{name:"accChoices",label:"Accumulator Choices",type:"Array",factory:function(){return[]}},{name:"scrollMode",type:"String",defaultValue:"Bars",view:{model_:"ChoiceView",choices:["Bars","Warp"]}},{name:"model",type:"Model"},{name:"dao",label:"DAO",type:"DAO",postSet:function(){this.repaint_()}},{name:"grid",type:"GridByExpr",factory:function(){return GridByExpr.create()}}],methods:{updateHTML:function(){if(this.$){var a=this;this.grid.xFunc=this.col.data||this.grid.xFunc,this.grid.yFunc=this.row.data||this.grid.yFunc,this.grid.acc=this.acc.data||this.grid.acc,this.dao.select(this.grid.clone())(function(b){if("Bars"===a.scrollMode){console.time("toHTML");var c=b.toHTML();console.timeEnd("toHTML"),a.$.innerHTML=c,b.initHTML()}else{var d=this.X.GridCView.create({grid:b,x:5,y:5,width:1e3,height:800});a.$.innerHTML=d.toHTML(),d.initHTML(),d.paint()}})}},initHTML:function(){this.scrollModeView.data$=this.scrollMode$;var a=[[{f:function(){return""}},"none"]];this.model.properties.orderBy(Property.LABEL).select({put:function(b){a.push([b,b.label])}}),this.row.choices=a,this.col.choices=a,this.acc.choices=this.accChoices,this.row.initHTML(),this.col.initHTML(),this.acc.initHTML(),this.SUPER(),this.row.data$.addListener(this.repaint_),this.col.data$.addListener(this.repaint_),this.acc.data$.addListener(this.repaint_),this.scrollMode$.addListener(this.repaint_),this.updateHTML()}},listeners:[{name:"repaint_",isAnimated:!0,code:function(){this.updateHTML()}}],templates:[{model_:"Template",name:"toHTML",description:"TileView",template:'<div class="column expand"><div class="gridViewControl">Rows: <%= this.row.toHTML() %> &nbsp;Cols: <%= this.col.toHTML() %> &nbsp;Cells: <%= this.acc.toHTML() %> &nbsp;Scroll: $$scrollMode <br/></div><div id="<%= this.id%>" class="gridViewArea column" style="flex: 1 1 100%"></div></div>'}]}),FOAModel({name:"Mouse",properties:[{name:"x",type:"int",view:"IntFieldView",defaultValue:0},{name:"y",type:"int",view:"IntFieldView",defaultValue:0}],methods:{connect:function(a){return a.addEventListener("mousemove",this.onMouseMove),this}},listeners:[{name:"onMouseMove",isAnimated:!0,code:function(a){this.x=a.offsetX,this.y=a.offsetY}}]}),FOAModel({name:"ViewChoice",tableProperties:["label","view"],properties:[{name:"label",type:"String",displayWidth:20,defaultValue:"",help:"View's label."},{name:"view",type:"view",defaultValue:"DetailView",help:"View factory."}]}),FOAModel({name:"AlternateView",extendsModel:"View",properties:[{name:"value",factory:function(){return SimpleValue.create("")}},{name:"views",type:"Array[ViewChoice]",subType:"ViewChoice",view:"ArrayView",defaultValue:[],help:"View choices."},{name:"dao",label:"DAO",type:"DAO",postSet:function(a,b){this.choice&&(this.view?this.view.dao=b:this.installSubView())}},{name:"choice",postSet:function(a,b){this.$&&a!=b&&this.installSubView()},hidden:!0},{name:"mode",getter:function(){return this.choice.label},setter:function(a){for(var b=0;b<this.views.length;b++)if(this.views[b].label===a){var c=this.mode;return this.choice=this.views[b],void this.propertyChange("mode",c,a)}}},{name:"headerView",help:"Optional View to be displayed in header.",defaultValue:null},{name:"view"}],listeners:[{name:"installSubView",isAnimated:!0,code:function(){var a=this.choice,b="function"==typeof a.view?a.view(this.value.get().model_,this.value):GLOBAL[a.view].create({model:this.value.get().model_,value:this.value});b.model_&&b.model_.getProperty("dao")&&(b.dao=this.dao),this.$.innerHTML=b.toHTML(),b.initHTML(),b.value&&b.value.set(this.value.get()),this.view=b}}],methods:{init:function(){this.SUPER(),this.choice=this.views[0]},toHTML:function(){var a=[],b=this.views[0];a.push('<div class="AltViewOuter column" style="margin-bottom:5px;">'),a.push('<div class="altViewButtons rigid">'),this.headerView&&(a.push(this.headerView.toHTML()),this.addChild(this.headerView));for(var c=0;c<this.views.length;c++){var d=this.views[c],e=function(a){return this.choice=a,!1}.bind(this,d),f=this.nextID();this.addPropertyListener("choice",function(a,b){DOM.setClass($(b),"mode_button_active",this.choice===a)}.bind(this,d,f));var g="buttonify";0==c&&(g+=" capsule_left"),c==this.views.length-1&&(g+=" capsule_right"),d==this.choice&&(g+=" mode_button_active"),a.push('<a class="'+g+'" id="'+this.on("click",e,f)+'">'+d.label+"</a>"),d.label==this.selected&&(b=d)}return a.push("</div>"),a.push("<br/>"),a.push('<div class="altView column" id="'+this.id+'"> </div>'),a.push("</div>"),a.join("")},initHTML:function(){this.SUPER(),this.choice=this.choice||this.views[0],this.installSubView()}}}),FOAModel({name:"SwipeAltView",extendsModel:"View",properties:[{name:"views",type:"Array[ViewChoice]",subType:"ViewChoice",view:"ArrayView",factory:function(){return[]},help:"Child views"},{name:"index",help:"The index of the currently selected view",defaultValue:0,preSet:function(a,b){return 0>b?0:b>=this.views.length?this.views.length-1:b},postSet:function(a,b){this.views[a].view.deepPublish(this.ON_HIDE),this.snapToCurrent(Math.abs(a-b))},hidden:!0},{name:"headerView",help:"Optional View to be displayed in header.",factory:function(){return ChoiceListView.create({choices:this.views.map(function(a){return a.label}),index$:this.index$,className:"swipeAltHeader foamChoiceListView horizontal"})}},{name:"data",help:"Generic data field for the views. Proxied to all the child views.",postSet:function(a,b){this.views.forEach(function(a){a.view.data=b})}},{name:"slider",help:"Internal element which gets translated around",hidden:!0},{name:"width",help:"Set when we know the width",hidden:!0},{name:"x",help:"X coordinate of the translation",hidden:!0,postSet:function(a,b){this.slider.style["-webkit-transform"]="translate3d(-"+b+"px, 0, 0)"}},{name:"touch",help:"TouchManager's FOAMTouch object",hidden:!0},{name:"touchStarted",model_:"BooleanProperty",defaultValue:!1,help:"True if we received a touchstart",hidden:!0},{name:"touchLive",model_:"BooleanProperty",defaultValue:!1,help:"True if a touch is currently active",hidden:!0}],methods:{init:function(){this.SUPER();var a=this;this.views.forEach(function(b,c){c!=a.index&&b.view.deepPublish(a.ON_HIDE)})},toHTML:function(){var a=[],b=this.views[this.index];return this.headerView&&(a.push(this.headerView.toHTML()),this.addChild(this.headerView)),a.push('<div id="'+this.id+'" class="swipeAltOuter">'),a.push('<div class="swipeAltSlider" style="width: 100%">'),a.push('<div class="swipeAltInner" style="left: 0px">'),a.push(b.view.toHTML()),a.push("</div>"),a.push("</div>"),a.push("</div>"),a.join("")},initHTML:function(){if(this.$){this.SUPER(),this.slider=this.$.children[0],this.width=this.$.clientWidth;for(var a=[],b=0;b<this.views.length;b++)a.push('<div class="swipeAltInner">'),a.push(this.views[b].view.toHTML()),a.push("</div>");this.slider.innerHTML=a.join(""),window.addEventListener("resize",this.resize,!1),this.X.touchManager.install(TouchReceiver.create({id:"swipeAltView-"+this.id,element:this.$,delegate:this}));var c=this;window.setTimeout(function(){c.resize(),c.views.forEach(function(a){a.view.initHTML()})},0)}},snapToCurrent:function(a){var b=this,c=150+150*a;Movement.animate(c,function(){b.x=b.index*b.width},Movement.ease(150/c,150/c),function(){b.views[b.index].view.deepPublish(b.ON_SHOW)})()}},listeners:[{name:"resize",code:function(){if(!this.$)return void window.removeEventListener("resize",this.resize,!1);this.width=this.$.clientWidth;var a=this,b=window.requestAnimationFrame(function(){a.x=a.index*a.width;for(var c=0;c<a.slider.children.length;c++)a.slider.children[c].style.left=100*c+"%";window.cancelAnimationFrame(b)})}},{name:"onTouchStart",code:function(a,b){return Object.keys(a).length>1?{drop:!0}:(this.touch=a[b[0]],this.touchStarted=!0,this.touchLive=!1,{weight:.5})}},{name:"onTouchMove",code:function(){if(!this.touchStarted)return{drop:!0};var a=Math.abs(this.touch.x-this.touch.startX),b=Math.abs(this.touch.y-this.touch.startY);if(!this.touchLive&&Math.sqrt(a*a+b*b)<6)return{preventDefault:!0,weight:.5};if(!this.touchLive&&b>a)return{drop:!0};this.touchLive=!0;var c=this.index*this.width-(this.touch.x-this.touch.startX);0>c&&(c=0);var d=(this.views.length-1)*this.width;return c>d&&(c=d),this.x=c,{claim:!0,weight:.9}}},{name:"onTouchEnd",code:function(a,b){if(!this.touchLive)return this.onTouchCancel(a,b);this.touchLive=!1;var c=this.touch.x;return Math.abs(c-this.touch.startX)>this.width/3?c<this.touch.startX?this.index++:this.index--:this.snapToCurrent(1),{drop:!0}}},{name:"onTouchCancel",code:function(){return this.touchLive=!1,this.touchStarted=!1,{drop:!0}}}]}),FOAModel({name:"GalleryView",extendsModel:"SwipeAltView",properties:[{name:"images",required:!0,help:"List of image URLs for the gallery",postSet:function(a,b){this.views=b.map(function(a){return ViewChoice.create({view:GalleryImageView.create({source:a})})})}},{name:"height",help:"Optionally set the height"},{name:"headerView",factory:function(){return null}}],methods:{initHTML:function(){this.SUPER();var a=document.createElement("div");a.classList.add("galleryCirclesOuter");for(var b=0;b<this.views.length;b++){var c=document.createElement("div");c.classList.add("galleryCircle"),this.index==b&&c.classList.add("selected"),a.appendChild(c)}this.$.appendChild(a),this.$.classList.add("galleryView"),this.$.style.height=this.height,this.index$.addListener(function(b,c,d,e){a.children[d].classList.remove("selected"),a.children[e].classList.add("selected")})}}}),FOAModel({name:"GalleryImageView",extendsModel:"View",properties:["source"],methods:{toHTML:function(){return'<img class="galleryImage" src="'+this.source+'" />'}}}),FOAModel({name:"ModelAlternateView",extendsModel:"AlternateView",methods:{init:function(){this.views=FOAM([{model_:"ViewChoice",label:"GUI",view:"DetailView"},{model_:"ViewChoice",label:"JS",view:"JSView"},{model_:"ViewChoice",label:"XML",view:"XMLView"},{model_:"ViewChoice",label:"UML",view:"XMLView"},{model_:"ViewChoice",label:"Split",view:"SplitView"}])}}}),FOAModel({name:"FloatFieldView",extendsModel:"TextFieldView",properties:[{name:"precision",defaultValue:void 0},{name:"type",defaultValue:"number"}],methods:{formatNumber:function(a){if(!a)return"0";a=a.toFixed(this.precision);for(var b=a.length-1;b>0&&"0"===a.charAt(b);b--);return a.substring(0,"."===a.charAt(b)?b:b+1)},valueToText:function(a){return this.hasOwnProperty("precision")?this.formatNumber(a):String.valueOf(a)},textToValue:function(a){return parseFloat(a)||0}}}),FOAModel({name:"IntFieldView",extendsModel:"TextFieldView",properties:[{name:"type",defaultValue:"number"}],methods:{textToValue:function(a){return parseInt(a)||"0"},valueToText:function(a){return a?a:"0"}}}),FOAModel({name:"StringArrayView",extendsModel:"TextFieldView",methods:{findCurrentValues:function(){for(var a=this.$.selectionStart,b=this.$.value,c=b.split(","),d=0,e=0;e+c[d].length<a;)e+=c[d].length+1,d++;return{values:c,i:d}},setValues:function(a,b){this.domValue.set(this.valueToText(a)+","),this.data=this.textToValue(this.domValue.get());for(var c=a.length-1===b,d=0,e=0;b>=e;e++)d+=a[e].length+1;this.$.setSelectionRange(d,d),c&&this.X.setTimeout(function(){this.autocompleteView.autocomplete("")}.bind(this),0)},onAutocomplete:function(a){var b=this.findCurrentValues();b.values[b.i]=a,this.setValues(b.values,b.i)},bindAutocompleteEvents:function(a){function b(){var b=c.findCurrentValues();a.autocomplete(b.values[b.i])}var c=this;this.$.addEventListener("input",b),this.$.addEventListener("focus",b),this.$.addEventListener("blur",function(){a.publish("blur")})},textToValue:function(a){return a.replace(/\s/g,"").split(",")},valueToText:function(a){return a?a.toString():""}}}),FOAModel({name:"MultiLineStringArrayView",extendsModel:"View",properties:[{model_:"StringProperty",name:"name"},{model_:"StringProperty",name:"type",defaultValue:"text"},{model_:"IntProperty",name:"displayWidth",defaultValue:30},{model_:"BooleanProperty",name:"onKeyMode",defaultValue:!0},{model_:"BooleanProperty",name:"autocomplete",defaultValue:!0},{name:"data"},"autocompleter",{model_:"ArrayProperty",subType:"MultiLineStringArrayView.RowView",name:"inputs"}],models:[{model_:"Model",name:"RowView",extendsModel:"View",properties:["field",{name:"tagName",defaultValue:"div"}],methods:{toInnerHTML:function(){return this.children=[this.field],this.field.toHTML()+'<input type="button" id="'+this.on("click",function(){this.publish("remove")}.bind(this))+'" class="multiLineStringRemove" value="X">'}}}],methods:{toHTML:function(){var a=ToolbarView.create({value:SimpleValue.create(this)});return a.addActions([this.model_.ADD]),this.children=[a],'<div id="'+this.id+'"><div></div>'+a.toHTML()+"</div>"},initHTML:function(){this.SUPER(),this.data$.addListener(this.update),this.update()},row:function(){var a=this.model_.RowView.create({field:this.X.TextFieldView.create({name:this.name,type:this.type,displayWidth:this.displayWidth,onKeyMode:this.onKeyMode,autocomplete:this.autocomplete,autocompleter:this.autocompleter})});return a},setValue:function(a){this.value=a}},listeners:[{name:"update",code:function(){if(this.$){var a=this.inputs,b=this.$.firstElementChild,c=[],d=this.data;if(a.length>d.length){for(var e=d.length;e<a.length;e++)a[e].$.remove(),this.removeChild(a[e]);a.length=d.length}else{var f="";for(e=a.length;e<d.length;e++){var g=this.row();this.addChild(g),c.push(g),a.push(g),g.subscribe("remove",this.onRemove),g.field.data$.addListener(this.onInput),f+=g.toHTML()}f&&b.insertAdjacentHTML("beforeend",f)}for(e=0;e<d.length;e++)a[e].field.data!==d[e]&&(a[e].field.data=d[e]);for(this.inputs=a,e=0;e<c.length;e++)c[e].initHTML()}}},{name:"onRemove",code:function(a){for(var b=this.inputs,c=0;c<b.length;c++)if(b[c]===a){this.data=this.data.slice(0,c).concat(this.data.slice(c+1));break}}},{name:"onInput",code:function(){if(this.$){for(var a=this.inputs,b=[],c=0;c<a.length;c++)b.push(a[c].field.data);this.data=b}}}],actions:[{name:"add",label:"Add",action:function(){this.data=this.data.pushF("")}}]}),FOAModel({extendsModel:"View",name:"SplitView",properties:[{name:"view1",label:"View 1"},{name:"view2",label:"View 2"}],methods:{init:function(){this.SUPER(),this.view1=DetailView.create(),this.view2=JSView.create(),this.setValue(SimpleValue.create(""))},setValue:function(a){this.value=a,this.view1&&this.view1.setValue(a),this.view2&&this.view2.setValue(a)},set:function(a){this.value.set(a)},get:function(){return this.value.get()},toHTML:function(){var a=[];return a.push("<table width=80%><tr><td width=40%>"),a.push(this.view1.toHTML()),a.push("</td><td>"),a.push(this.view2.toHTML()),a.push("</td></tr></table><tr><td width=40%>"),a.join("")},initHTML:function(){this.view1.initHTML(),this.view2.initHTML()}}}),FOAModel({name:"ListValueView",help:"Combines an input view with a value view for the edited value.",extendsModel:"View",properties:[{name:"valueView"},{name:"inputView"},{name:"placeholder",postSet:function(a,b){this.inputView.placeholder=b}},{name:"value",factory:function(){return SimpleValue.create({value:[]})},postSet:function(a,b){this.inputView.setValue(b),this.valueView.value=b}}],methods:{focus:function(){this.inputView.focus()},toHTML:function(){return this.valueView.lastView=this.inputView,this.valueView.toHTML()},setValue:function(a){this.value=a},initHTML:function(){this.SUPER(),this.valueView.initHTML()}}}),FOAModel({extendsModel:"View",name:"ListInputView",properties:[{name:"name"},{name:"dao",help:"The DAO to fetch autocomplete objects from."},{name:"property",help:"The property model to map autocomplete objecst to values with."},{model_:"ArrayProperty",name:"searchProperties",help:"The properties with which to construct the autocomplete query with."},{name:"autocompleteView",postSet:function(a,b){a&&a.unsubscribe("selected",this.selected),b.subscribe("selected",this.selected)}},{name:"placeholder",postSet:function(a,b){this.$&&this.usePlaceholer&&(this.$.placeholder=b)}},{model_:"BooleanValue",name:"usePlaceholder",defaultValue:!0,postSet:function(a,b){this.$&&(this.$.placeholder=b?this.placeholder:"")}},{name:"value",help:"The array value we are editing.",factory:function(){return SimpleValue.create({value:[]})},postSet:function(a,b){a&&a.removeListener(this.onValueChange),b.addListener(this.onValueChange)}},{name:"domInputValue"}],methods:{toHTML:function(){return this.on("keydown",this.onKeyDown,this.id),this.on("blur",this.animate(this.delay(200,this.animate(this.animate(this.onBlur)))),this.id),this.on("focus",this.onInput,this.id),'<input name="'+this.name+'" type="text" id="'+this.id+'" class="listInputView">'+this.autocompleteView.toHTML()},setValue:function(a){this.value=a},initHTML:function(){this.SUPER(),this.usePlaceholder&&this.placeholder&&(this.$.placeholder=this.placeholder),this.autocompleteView.initHTML(),this.domInputValue=DomValue.create(this.$,"input"),this.domInputValue.addListener(this.onInput)},pushValue:function(a){this.value.set(this.value.get().concat(a)),this.domInputValue.set(""),this.onInput()},popValue:function(){var a=this.value.get().slice();a.pop(),this.value.set(a)}},listeners:[{name:"selected",code:function(){this.autocompleteView.value.get()&&this.pushValue(this.property.f(this.autocompleteView.value.get()))}},{name:"onInput",code:function(){var a=this.domInputValue.get();if(","===a.charAt(a.length-1))return void(a.length>1?this.pushValue(a.substring(0,a.length-1)):this.domInputValue.set(""));if(""===a)return void(this.autocompleteView.dao=[]);var b=OR();a=this.domInputValue.get();for(var c=0;c<this.searchProperties.length;c++)b.args.push(STARTS_WITH(this.searchProperties[c],a));a=this.value.get(),a.length>0&&(b=AND(NOT(IN(this.property,a)),b)),this.autocompleteView.dao=this.dao.where(b)}},{name:"onKeyDown",code:function(a){40===a.keyCode?(this.autocompleteView.nextSelection(),a.preventDefault()):38===a.keyCode?(this.autocompleteView.prevSelection(),a.preventDefault()):13===a.keyCode||9===a.keyCode?this.autocompleteView.value.get()&&(this.pushValue(this.property.f(this.autocompleteView.value.get())),a.preventDefault()):8===a.keyCode&&""===this.domInputValue.get()&&this.popValue()}},{name:"onBlur",code:function(){var a=this.domInputValue.get();a.length>0?this.pushValue(a):this.domInputValue.set(""),this.autocompleteView.dao=[]
}},{name:"onValueChange",code:function(){this.usePlaceholder=0==this.value.get().length}}]}),FOAModel({name:"ArrayTileView",extendsModel:"View",properties:[{name:"dao"},{name:"property"},{name:"tileView"},{name:"lastView"},{name:"value",factory:function(){return SimpleValue.create()},postSet:function(a,b){a&&a.removeListener(this.paint),b.addListener(this.paint)}},{model_:"BooleanProperty",name:"painting",defaultValue:!1}],methods:{toHTML:function(){return this.on("click",this.onClick,this.id),'<ul id="'+this.id+'" class="arrayTileView"><li class="arrayTileLastView">'+this.lastView.toHTML()+"</li></ul>"},initHTML:function(){this.SUPER(),this.lastView.initHTML(),this.paint(),this.$.ownerDocument.defaultView.addEventListener("resize",this.layout)}},listeners:[{name:"onClick",code:function(){this.lastView.focus()}},{name:"layout",isAnimated:!0,code:function(){if(this.$){var a=this.$.lastChild;a.style.width="100px",a.style.width=100+a.parentNode.clientWidth-(a.offsetWidth+a.offsetLeft)-4-75,this.painting=!1}}},{name:"paint",isAnimated:!0,code:function(){if(this.painting)return void this.paint();this.painting=!0,this.children=[];var a=this.value.get(),b=a.length,c=this,d=function(){for(;c.$.firstChild!==c.$.lastChild;)c.$.removeChild(c.$.firstChild);var a=document.createElement("div");a.style.display="None",c.$.insertBefore(a,c.$.lastChild),a.outerHTML=c.children.map(function(a){return'<li class="arrayTileItem">'+a.toHTML()+"</li>"}).join(""),c.children.forEach(function(a){a.initHTML()}),c.layout()};0==a.length?d():c.$.style.display="";for(var e=0;e<a.length;e++)this.dao.find(EQ(this.property,a[e]),{put:function(a){var e=c.tileView.create();e.value.set(a),e.subscribe("remove",c.onRemove),c.addChild(e),b--,0==b&&d()},error:function(){b--,0==b&&d()}})}},{name:"onRemove",code:function(a,b,c){var d=this;this.value.set(this.value.get().removeF({f:function(a){return a===d.property.f(c)}}))}}]}),FOAModel({name:"ArrayListView",extendsModel:"View",properties:[{name:"value",factory:function(){return SimpleValue.create([])},postSet:function(a,b){a&&a.removeListener(this.update),b.addListener(this.update),this.update()}},{name:"listView"}],methods:{toHTML:function(){return'<div id="'+this.id+'"></div>'},initHTML:function(){this.SUPER(),this.update()},setValue:function(a){this.value=a}},listeners:[{name:"update",animate:!0,code:function(){if(this.$){this.$.innerHTML="";for(var a=this.value.get(),b=new Array(a.length),c=0;c<a.length;c++){var d=this.listView.create();b[c]=d,d.value=SimpleValue.create(a[c])}this.$.innerHTML=b.map(function(a){return a.toHTML()}).join(""),b.forEach(function(a){a.initHTML()})}}}]}),FOAModel({name:"KeyView",extendsModel:"View",properties:[{name:"dao",factory:function(){return this.X[this.subType+"DAO"]}},{name:"mode"},{name:"data",postSet:function(a,b){var c=this,d=FOAM.lookup(this.subKey,this.X);this.dao.where(EQ(d,b)).limit(1).select({put:function(a){c.innerData=a}})}},{name:"innerData"},{name:"subType"},{name:"model",defaultValueFn:function(){return this.X[this.subType]}},{name:"subKey"},{name:"innerView",defaultValue:"DetailView"}],methods:{toHTML:function(){this.children=[];var a=FOAM.lookup(this.innerView).create({model:this.model,mode:this.mode,data$:this.innerData$});return this.addChild(a),a.toHTML()}}}),FOAModel({name:"DAOKeyView",extendsModel:"View",properties:[{name:"dao",factory:function(){return this.X[this.subType+"DAO"]}},{name:"mode"},{name:"data",postSet:function(a,b){var c=FOAM.lookup(this.subKey,this.X);this.innerData=this.dao.where(IN(c,b))}},{name:"innerData"},{name:"subType"},{name:"model",defaultValueFn:function(){return this.X[this.subType]}},{name:"subKey"},{name:"innerView",defaultValue:"DAOListView"},"dataView"],methods:{toHTML:function(){this.children=[];var a=FOAM.lookup(this.innerView).create({model:this.model,mode:this.mode,data$:this.innerData$});return this.addChild(a),a.toHTML()}}}),FOAModel({name:"AutocompleteListView",extendsModel:"View",properties:[{name:"dao",postSet:function(a,b){a&&a.unlisten(this.paint),b.listen(this.paint),this.value.set(""),this.paint()},hidden:!0},{name:"value",hidden:!0,factory:function(){return SimpleValue.create()}},{name:"model",hidden:!0},{name:"innerView",type:"View",preSet:function(a,b){return"string"==typeof b&&(b=GLOBAL[b]),b},defaultValueFn:function(){return this.model.listView}},{model_:"ArrayProperty",name:"objs"},{model_:"IntProperty",name:"selection",defaultValue:0,postSet:function(a,b){this.value.set(this.objs[b]),this.$&&(this.$.children[a]&&(this.$.children[a].className="autocompleteListItem"),this.$.children[b].className+=" autocompleteSelectedItem")}},{model_:"IntProperty",name:"count",defaultValue:20},{model_:"IntProperty",name:"left"},{model_:"IntProperty",name:"top"}],methods:{setValue:function(a){this.value=a},initHTML:function(){this.SUPER(),this.$.style.display="none";var a=this;this.propertyValue("left").addListener(function(b){a.$.left=b}),this.propertyValue("top").addListener(function(b){a.$.top=b})},nextSelection:function(){if(0!==this.objs.length){var a=this.selection+1;a>=this.objs.length&&(a=0),this.selection=a}},prevSelection:function(){if(0!==this.objs.length){var a=this.selection-1;0>a&&(a=this.objs.length-1),this.selection=a}}},templates:[{name:"toHTML",template:'<ul class="autocompleteListView" id="<%= this.id %>"></ul>'}],listeners:[{name:"paint",isAnimated:!0,code:function(){if(this.$){var a=[],b=0,c=this.value.get(),d=this;this.dao.limit(this.count).select({put:function(d){a.push(d),d.id===c.id&&(b=a.length-1)},eof:function(){if(d.$.innerHTML="",d.objs=a,0===a.length)return void(d.$.style.display="none");for(var c=0;c<a.length;c++){var e=a[c],f=d.innerView.create({}),g=document.createElement("li");g.onclick=function(a){return function(){d.selection=a,d.publish("selected")}}(c),g.className="autocompleteListItem",d.$.appendChild(g),f.value.set(e),g.innerHTML=f.toHTML(),f.initHTML()}d.selection=b,d.$.style.display=""}})}}}]}),FOAModel({name:"ViewSwitcher",extendsModel:"View",help:"A view which cycles between an array of views.",properties:[{name:"views",factory:function(){return[]},postSet:function(){this.viewIndex=this.viewIndex}},{name:"value",postSet:function(a,b){this.activeView.value=b}},{name:"activeView",postSet:function(a,b){a&&(a.unsubscribe("nextview",this.onNextView),a.unsubscribe("prevview",this.onPrevView)),b.subscribe("nextview",this.onNextView),b.subscribe("prevview",this.onPrevView),this.value&&(b.value=this.value)}},{model_:"IntProperty",name:"viewIndex",preSet:function(a,b){return b>=this.views.length?0:0>b?this.views.length-1:b},postSet:function(){this.activeView=this.views[this.viewIndex]}}],methods:{toHTML:function(){return'<div id="'+this.id+'" style="display:none"></div>'+this.toInnerHTML()},updateHTML:function(){this.$&&(this.$.nextElementSibling.outerHTML=this.toInnerHTML(),this.initInnerHTML())},toInnerHTML:function(){return this.activeView.toHTML()},initInnerHTML:function(){this.activeView.initInnerHTML()}},listeners:[{name:"onNextView",code:function(){this.viewIndex=this.viewIndex+1,this.updateHTML()}},{name:"onPrevView",code:function(){this.viewIndex=this.viewIndex-1,this.updateHTML()}}]}),FOAModel({name:"PredicatedView",extendsModel:"View",properties:[{name:"predicate",defaultValueFn:function(){return TRUE},postSet:function(){this.updateDAO()}},{name:"data",help:"Payload of the view; assumed to be a DAO.",postSet:function(){this.updateDAO()}},{name:"view",required:!0}],methods:{init:function(){"string"==typeof this.view&&(this.view=FOAM.lookup(this.view)),this.children=[this.view]},toHTML:function(){return this.view.toHTML()},initHTML:function(){this.view.initHTML()},updateDAO:function(){this.data&&this.data.where&&(this.view.data=this.data.where(this.predicate))}}}),FOAModel({name:"DAOListView",extendsModel:"View",properties:[{name:"dao",postSet:function(a,b){this.X.DAO=b,a&&a.unlisten(this.onDAOUpdate),this.hidden||(b.listen(this.onDAOUpdate),this.updateHTML())}},{name:"hidden",postSet:function(a,b){this.dao&&(b?this.dao.unlisten(this.onDAOUpdate):(this.dao.listen(this.onDAOUpdate),this.updateHTML()))}},{name:"data",setter:function(a){this.value=SimpleValue.create(a)}},{name:"value",setter:function(a){this.dao=a.value,a.addListener(function(){this.dao=a.value}.bind(this))}},{name:"rowView",defaultValue:"DetailView"},{name:"mode",defaultValue:"read-write",view:{create:function(){return ChoiceView.create({choices:["read-only","read-write","final"]})}}},{model_:"BooleanProperty",name:"useSelection",defaultValue:!1},"selection",{name:"scrollContainer",help:"Containing element that is responsible for scrolling."},{name:"chunkSize",defaultValue:0,help:"Number of entries to load in each infinite scroll chunk."},{name:"chunksLoaded",hidden:!0,defaultValue:1,help:"The number of chunks currently loaded."}],methods:{init:function(){this.SUPER(),this.X=this.X.sub();var a=this;this.subscribe(this.ON_HIDE,function(){a.hidden=!0}),this.subscribe(this.ON_SHOW,function(){a.hidden=!1})},initHTML:function(){if(this.chunkSize>0){for(var a=this.$;a&&"scroll"!==window.getComputedStyle(a).overflow;)a=a.parentElement;this.scrollContainer=a||window,a.addEventListener("scroll",this.onScroll,!1)}this.hidden||this.updateHTML()},updateHTML:function(){if(this.dao&&this.$&&!this.painting){this.painting=!0;var a=[],b=FOAM.lookup(this.rowView);this.children=[],this.initializers_=[];var c=this.dao;this.chunkSize&&(c=c.limit(this.chunkSize*this.chunksLoaded)),c.select({put:function(c){"read-write"===this.mode&&(c=c.clone());var d=b.create({value:SimpleValue.create(c),model:c.model_},this.X);d.DAO=this.dao,"read-write"===this.mode&&c.addListener(function(){this.dao.put(c)}.bind(this,c)),this.addChild(d),this.useSelection&&a.push('<div class="'+this.className+' row" id="'+this.on("click",function(){this.selection=c}.bind(this))+'">'),a.push(d.toHTML()),this.useSelection&&a.put("</div>")}.bind(this)})(function(){var b=this.$;b&&(b.innerHTML=a.join(""),this.initInnerHTML(),this.children=[],this.painting=!1)}.bind(this))}}},listeners:[{name:"onDAOUpdate",isAnimated:!0,code:function(){this.updateHTML()}},{name:"onScroll",code:function(){var a=this.scrollContainer;this.chunkSize>0&&a.scrollTop+a.offsetHeight>=a.scrollHeight&&(this.chunksLoaded++,this.updateHTML())}}]}),FOAModel({name:"TouchListView",extendsModel:"View",properties:[{model_:"DAOProperty",name:"dao"},{name:"model"},{model_:"IntProperty",name:"rowViewHeight"},{model_:"IntProperty",name:"height"},{model_:"IntProperty",name:"scrollTop",defaultValue:0,preSet:function(a,b){return 0>b?0:b},postSet:function(){this.scroll()}}],methods:{init:function(){this.SUPER(),this.dao.listen(this.scroll)},toHTML:function(){var a=(this.id,this.nextID()),b=this.X.TouchInput;return b.subscribe(b.TOUCH_START,this.onTouchStart),b.subscribe(b.TOUCH_END,this.onTouchEnd),'<div id="'+this.id+'" style="height:'+this.height+'px;overflow:hidden;"><div id="'+a+'" style="z-index:1;position:absolute;height:'+this.height+';width:100%"></div><div></div></div>'},formatObject:function(a){for(var b,c="",d=0;b=this.model.properties[d];d++)c+=b.summaryFormatter?b.summaryFormatter(b.f(a),a):this.strToHTML(b.f(a));return c},initHTML:function(){this.SUPER(),this.scroll()}},listeners:[{name:"scroll",code:function(){if(this.$){var a=-(this.scrollTop%this.rowViewHeight),b=Math.floor(this.height/this.rowViewHeight)+2,c=Math.floor(this.scrollTop/this.rowViewHeight),d=this;this.dao.skip(c).limit(b).select()(function(b){for(var c="",e=0;e<b.length;e++)c+='<div style="height:'+d.rowViewHeight+'px;overflow:hidden">',c+=d.formatObject(b[e]),c+="</div>";d.$.lastElementChild.innerHTML=c,d.$.lastElementChild.style.webkitTransform="translate3d(0px, "+a+"px, 0px)"})}}},{name:"onTouchStart",code:function(a,a,b){this.touch||(this.touch=b);var c=this;this.touch.y$.addListener(function(a,a,b,d){c.scrollTop=c.scrollTop+b-d})}},{name:"onTouchEnd",code:function(a,a,b){b.id===this.touch.id&&(this.touch="")}}]}),FOAModel({name:"UITestResultView",label:"UI Test Result View",extendsModel:"View",properties:[{name:"data"}],methods:{initHTML:function(){var a=this.parent,b=a.obj,c=this.$;b.append=function(a){c.insertAdjacentHTML("beforeend",a)},b.scope.render=function(a){b.append(a.toHTML()),a.initHTML()};var d=b.tests;b.tests=[],b.test(),b.tests=d}}}),FOAModel({name:"UITest",label:"UI Test",extendsModel:"UnitTest",properties:[{name:"results",view:"UITestResultView"}],methods:{}}),FOAModel({name:"TwoModeTextFieldView",extendsModel:"View",properties:[{name:"data",postSet:function(a,b){this.$&&(this.$.textContent=b||this.placeholder)}},{name:"placeholder"},{name:"editView"}],methods:{init:function(a){this.SUPER(a),this.editView=this.X.FullScreenTextFieldView.create(a)},initHTML:function(){this.SUPER(),this.data=this.data}},templates:[function(){}],listeners:[{name:"onClick",code:function(){this.editView.data=this.data,this.X.stack.pushView(this.editView),this.editView.data$.addListener(this.onDataSet)}},{name:"onDataSet",code:function(){this.editView.data$.removeListener(this.onDataSet),this.data=this.editView.data,this.X.stack.back()}}]}),FOAModel({name:"FullScreenTextFieldView",extendsModel:"View",properties:["data","softData","autocompleter",{model_:"BooleanProperty",name:"autocomplete",defaultValue:!0},"autocompleteView","placeholder","domValue"],methods:{initHTML:function(){this.SUPER();var a=this.$.firstElementChild;this.placeholder&&(a.placeholder=this.placeholder),this.domValue=DomValue.create(a,"input"),Events.follow(this.data$,this.softData$),Events.relate(this.softData$,this.domValue,this.valueToText.bind(this),this.textToValue.bind(this)),a.addEventListener("keydown",this.onKeyDown)},focus:function(){this.$.firstElementChild.focus()},valueToText:function(a){return a},textToValue:function(a){return a}},templates:[function(){}],listeners:[{name:"onKeyDown",code:function(a){13===a.keyCode&&(this.data=this.softData)}}]}),FOAModel({name:"SlidePanelView",help:'A controller that shows a main view with a small strip of the secondary view visible at the right edge. This "panel" can be dragged by a finger or mouse pointer to any position from its small strip to fully exposed. If the containing view is wide enough, both panels will be always visible.',extendsModel:"View",properties:["mainView","panelView",{name:"minWidth",defaultValueFn:function(){var a=this.main$();return a?toNum(this.X.window.getComputedStyle(a).width):300}},{name:"width",hidden:!0,help:"Set internally by the resize handler",postSet:function(a,b){this.main$().style.width=b+"px"}},{name:"minPanelWidth",defaultValueFn:function(){if(this.panelView&&this.panelView.minWidth)return this.panelView.minWidth;var a=this.panel$();return a?toNum(this.X.window.getComputedStyle(a).width):250}},{name:"panelWidth",hidden:!0,help:"Set internally by the resize handler",postSet:function(a,b){this.panel$().style.width=b+"px"}},{name:"parentWidth",help:"A pseudoproperty that returns the current with (CSS pixels) of the containing element",getter:function(){return toNum(this.X.window.getComputedStyle(this.$.parentNode).width)}},{name:"stripWidth",help:"The width in (CSS) pixels of the minimal visible strip of panel",defaultValue:30},{name:"panelRatio",help:"The ratio (0-1) of the total width occupied by the panel, when the containing element is wide enough for expanded view.",defaultValue:.5},{name:"panelX",preSet:function(a,b){return b<=this.parentWidth-this.panelWidth?this.parentWidth-this.panelWidth:b>=this.parentWidth-this.stripWidth?this.parentWidth-this.stripWidth:b},postSet:function(a,b){this.panel$().style.webkitTransform="translate3d("+b+"px, 0,0)"}},"dragging","firstDragX","oldPanelX","expanded"],methods:{toHTML:function(){return'<div id="'+this.id+'" style="display: inline-block; position: relative; height: 100%"><div id="'+this.id+'-main" style="height:100%">'+this.mainView.toHTML()+'</div><div id="'+this.id+'-panel" style="height:100%; position: absolute; top: 0; left: 0">'+this.panelView.toHTML()+"</div></div>"},initHTML:function(){this.SUPER(),this.panel$().addEventListener("mousedown",this.onMouseDown),this.panel$().addEventListener("touchstart",this.onTouchStart),this.panel$().addEventListener("touchmove",this.onTouchMove),this.panel$().addEventListener("touchend",this.onTouchEnd),this.X.document.addEventListener("mousemove",this.onMouseMove),this.X.document.addEventListener("mouseup",this.onMouseUp),this.X.window.addEventListener("resize",this.onResize),this.onResize(),this.mainView.initHTML(),this.panelView.initHTML()},main$:function(){return this.X.window.document.getElementById(this.id+"-main")},panel$:function(){return this.X.window.document.getElementById(this.id+"-panel")}},listeners:[{name:"onResize",isAnimated:!0,code:function(){this.$&&(this.parentWidth>=this.minWidth+this.minPanelWidth?(this.panelWidth=Math.max(this.panelRatio*this.parentWidth,this.minPanelWidth),this.width=this.parentWidth-this.panelWidth,this.panelX=this.width,this.expanded=!0):(this.width=Math.max(this.parentWidth-this.stripWidth,this.minWidth),this.panelWidth=this.minPanelWidth,this.panelX=this.width,this.expanded=!1))}},{name:"onMouseDown",code:function(a){this.expanded||(this.firstDragX=a.clientX,this.oldPanelX=this.panelX,this.dragging=!0,a.stopPropagation())}},{name:"onTouchStart",code:function(a){if(!(this.expanded||a.touches.length>1)){{a.touches[0]}this.firstDragX=a.touches[0].clientX,this.oldPanelX=this.panelX,this.dragging=!0,a.stopPropagation(),a.preventDefault()}}},{name:"onMouseMove",code:function(a){if(!this.expanded&&this.dragging){a.preventDefault();var b=a.clientX-this.firstDragX;this.panelX=this.oldPanelX+b}}},{name:"onTouchMove",code:function(a){if(!this.expanded&&this.dragging){a.preventDefault();var b=a.touches[0].clientX-this.firstDragX;this.panelX=this.oldPanelX+b}}},{name:"onMouseUp",code:function(){this.expanded||(this.dragging=!1)}},{name:"onTouchEnd",code:function(){this.expanded||(this.dragging=!1)}}]}),FOAModel({name:"AbstractChoiceView",extendsModel:"View",properties:[{model_:"BooleanProperty",name:"autoSetData",help:"If true, this.data is set when choices update and the current data is not one of the choices.",defaultValue:!0},{name:"data",help:"The value of the current choice (ie. [value, label] -> value).",postSet:function(a,b){for(var c=0;c<this.choices.length;c++)if(this.choices[c][0]===b)return void(this.index!==c&&(this.index=c))}},{name:"label",help:"The label of the current choice (ie. [value, label] -> label).",postSet:function(a,b){for(var c=0;c<this.choices.length;c++)if(this.choices[c][1]===b)return void(this.index!==c&&(this.index=c))}},{name:"choice",help:"The current choice (ie. [value, label]).",getter:function(){for(var a=this.data,b=0;b<this.choices.length;b++){var c=this.choices[b];if(a===c[0])return c}return void 0},setter:function(a){var b=this.choice;this.data=a[0],this.label=a[1],this.propertyChange("choice",b,this.choice)}},{name:"choices",type:"Array[StringField]",help:"Array of [value, label] choices.  Simple String values will be upgraded to [value, value].",defaultValue:[],preSet:function(a,b){b=b.clone();for(var c=0;c<b.length;c++)Array.isArray(b[c])||(b[c]=[b[c],b[c]]);return b},postSet:function(a,b){for(var c=this.data,d=0;d<b.length;d++){var e=b[d];if(c===e[0]){this.useSelection?this.index=d:this.choice=e;break}}this.autoSetData&&d===b.length&&(this.useSelection?this.index=0:this.data=b.length?b[0][0]:void 0),this.$&&this.updateHTML()}},{name:"index",help:"The index of the current choice.",preSet:function(a,b){return 0>b||0==this.choices.length?0:b>=this.choices.length?this.choices.length-1:b},postSet:function(a,b){this.useSelection||this.data!==this.choices[b][0]&&(this.data=this.choices[b][0])}},{model_:"FunctionProperty",name:"objToChoice",help:"A Function which adapts an object from the DAO to a [key, value, ...] choice."},{name:"useSelection",help:"When set, data and choice do not update until an entry is firmly selected",model_:"BooleanProperty"},{name:"dao",postSet:function(a,b){a&&a.unlisten(this.onDAOUpdate),b&&this.$&&(b.listen(this.onDAOUpdate),this.onDAOUpdate())}}],listeners:[{name:"onDAOUpdate",isMerged:100,code:function(){this.dao.select(MAP(this.objToChoice))(function(a){this.choices=a.arg2}.bind(this))}}],methods:{initHTML:function(){this.SUPER(),this.dao=this.dao},findChoiceIC:function(a){a=a.toLowerCase();for(var b=0;b<this.choices.length;b++)if(this.choices[b][1].toLowerCase()==a)return this.choices[b]},commit:function(){this.useSelection&&(this.choice=this.choices[this.index])}}}),FOAModel({name:"ChoiceListView",extendsModel:"AbstractChoiceView",properties:[{name:"orientation",defaultValue:"horizontal",view:{model_:"ChoiceView",choices:[["horizontal","Horizontal"],["vertical","Vertical"]]},postSet:function(a,b){this.$&&(DOM.setClass(this.$,a,!1),DOM.setClass(this.$,b))}},{name:"className",defaultValueFn:function(){return"foamChoiceListView "+this.orientation}},{name:"tagName",defaultValue:"ul"},{name:"innerTagName",defaultValue:"li"}],listeners:[{name:"updateSelected",code:function(){if(this.$&&this.$.children)for(var a=0;a<this.$.children.length;a++){var b=this.$.children[a];DOM.setClass(b,"selected",a===this.index)}}}],methods:{init:function(){this.SUPER(),this.index$.addListener(this.updateSelected),this.choices$.addListener(this.updateSelected)},choiceToHTML:function(a,b){return"<"+this.innerTagName+' id="'+a+'" class="choice">'+b[1]+"</"+this.innerTagName+">"},toInnerHTML:function(){for(var a=[],b=0;b<this.choices.length;b++){var c=this.choices[b],d=this.nextID();this.on("click",function(a){this.choice=this.choices[a]}.bind(this,b),d),a.push(this.choiceToHTML(d,c))}return a.join("")},initHTML:function(){this.SUPER(),this.updateSelected()},scrollToSelection:function(){var a=this.$.children[this.index];if(a){for(var b=a.parentElement;b;){var c=this.X.window.getComputedStyle(b).overflow;if("scroll"===c||"auto"===c)break;b=b.parentElement}b=b||this.X.window,a.offsetTop<b.scrollTop?a.scrollIntoView(!0):a.offsetTop+a.offsetHeight>=b.scrollTop+b.offsetHeight&&a.scrollIntoView()}}}}),FOAModel({name:"ChoiceView",extendsModel:"AbstractChoiceView",properties:[{name:"name",type:"String",defaultValue:"field"},{name:"helpText",type:"String",defaultValue:void 0},{name:"size",type:"int",defaultValue:1}],methods:{toHTML:function(){return'<select id="'+this.id+'" name="'+this.name+'" size='+this.size+"/></select>"},updateHTML:function(){var a=[];this.helpText&&(a.push('<option disabled="disabled">'),a.push(this.helpText),a.push("</option>"));for(var b=0;b<this.choices.length;b++){var c=this.choices[b],d=this.nextID();try{this.on("click",this.onClick,d),this.on("mouseover",this.onMouseOver,d),this.on("mouseout",this.onMouseOut,d)}catch(e){}a.push('	<option id="'+d+'"'),c[0]===this.data&&a.push(" selected"),a.push(' value="'),a.push(b+'">'),a.push(c[1].toString()),a.push("</option>")}this.$.innerHTML=a.join(""),View.getPrototype().initHTML.call(this)},initHTML:function(){this.SUPER();var a=this.$;this.updateHTML(),this.domValue=DomValue.create(a),Events.link(this.index$,this.domValue)}},listeners:[{name:"onMouseOver",code:function(a){this.timer_&&this.X.clearTimeout(this.timer_),this.prev=void 0===this.prev?this.data:this.prev,this.index=a.target.value}},{name:"onMouseOut",code:function(){this.timer_&&this.X.clearTimeout(this.timer_),this.timer_=this.X.setTimeout(function(){this.data=this.prev||"",this.prev=void 0}.bind(this),1)}},{name:"onClick",code:function(a){this.data=this.prev=this.choices[a.target.value][0]}}]}),FOAModel({name:"RadioBoxView",extendsModel:"ChoiceView",methods:{toHTML:function(){return'<span id="'+this.id+'"/></span>'},updateHTML:function(){var a="",b=this;this.choices.forEach(function(c){var d=c[0],e=c[1],f=b.nextID();a+=e+':<input type="radio" name="',a+=b.id,a+='" value="',a+=d,a+='" ',a+='id="'+f+'"',b.data===d&&(a+=" checked"),a+="> ",b.on("click",function(){b.data=d},f),b.data$.addListener(function(){$(f).checked=b.data==d})}),this.$.innerHTML=a,View.getPrototype().initHTML.call(this)},initHTML:function(){this.SUPER(),Events.dynamic(function(){this.choices}.bind(this),this.updateHTML.bind(this))}}}),FOAModel({name:"PopupChoiceView",extendsModel:"AbstractChoiceView",properties:[{name:"linkLabel"},{name:"iconUrl"},{name:"tagName",defaultValue:"button"},{name:"className",defaultValue:"popupChoiceView"},{model_:"BooleanProperty",name:"showValue"}],listeners:[{name:"popup",code:function(){var a=this.X.ChoiceListView.create({className:"popupChoiceList",data:this.data,choices:this.choices,autoSetData:this.autoSetData});a.data$.addListener(EventService.animate(function(){this.data=a.data,a.$&&a.$.remove()}.bind(this),this.X));var b=findPageXY(this.$.querySelector(".action")),c=(this.X.document.body.insertAdjacentHTML("beforeend",a.toHTML()),this.X.window.getComputedStyle(a.$)),d=a.$.parentNode;a.$.style.top=b[1]-2,a.$.style.left=b[0]-toNum(c.width)+30,a.$.style.maxHeight=Math.max(200,this.X.window.innerHeight-b[1]-10),a.initHTML(),a.$.addEventListener("click",function(){a.$&&a.$.remove()}),d.addEventListener("mousemove",function(b){a.$?a.$.contains(b.target)||(d.removeEventListener("mousemove",arguments.callee),a.$.remove()):d.removeEventListener("mousemove",arguments.callee)})}}],methods:{toInnerHTML:function(){var a="";if(this.showValue){var b=this.nextID();a+='<span id="'+b+'" class="value">'+(this.choice[1]||"")+"</span>",this.data$.addListener(function(){this.X.$(b).innerHTML=this.choice[1]}.bind(this))}return a+='<span class="action">',this.iconUrl&&(a+='<img src="'+XMLUtil.escapeAttr(this.iconUrl)+'">'),this.linkLabel&&(a+=this.linkLabel),a+="</span>"},initHTML:function(){this.SUPER(),this.$.addEventListener("click",this.popup)}}}),FOAModel({name:"DetailView",extendsModel:"View",properties:[{name:"data",getter:function(){return this.value.value},setter:function(a){this.value=SimpleValue.create(a)}},{name:"value",type:"Value",factory:function(){return SimpleValue.create()},postSet:function(a,b){a&&a.removeListener(this.onValueChange),b&&b.addListener(this.onValueChange),this.onValueChange()}},{name:"model",type:"Model",postSet:function(){this.$&&(this.children=[],this.$.outerHTML=this.toHTML(),this.initHTML())}},{name:"title",defaultValueFn:function(){return"Edit "+this.model.label}},{name:"obj",getter:function(){return this.value.value}},{model_:"BooleanProperty",name:"showActions",defaultValue:!1,postSet:function(a,b){b&&this.addDecorator(this.X.ActionBorder.create())}},{model_:"StringProperty",name:"mode",defaultValue:"read-write"}],listeners:[{name:"onValueChange",code:function(){this.onValueChange_.apply(this,arguments),this.obj&&this.obj.model_&&(this.model=this.obj.model_),this.$&&this.updateSubViews()}},{name:"onKeyboardShortcut",code:function(a){var b=this.keyMap_[this.evtToKeyCode(a)];b&&b.callIfEnabled(this.obj)}}],methods:{onValueChange_:function(){},bindSubView:function(a,b){this.get()&&(a.setValue?a.setValue(this.get().propertyValue(b.name)):a.value=this.get().propertyValue(b.name))},viewModel:function(){return this.model},getValue:function(){return this.value},setValue:function(a){this.getValue(),this.value=a,this.updateSubViews(),a.addListener(this.updateSubViews.bind(this))},createTemplateView:function(a,b){var c=this.viewModel()[a];return c?Action.isInstance(c)?this.createActionView(c,this.value,b):this.createView(c,b):this.SUPER(a,b)},titleHTML:function(){var a=this.title;return a?'<tr><th colspan=2 class="heading">'+a+"</th></tr>":""},startColumns:function(){return"<tr><td colspan=2><table valign=top><tr><td valign=top><table>"},nextColumn:function(){return"</table></td><td valign=top><table valign=top>"},endColumns:function(){return"</table></td></tr></table></td></tr>"},rowToHTML:function(a,b){var c="";return a.detailViewPreRow&&(c+=a.detailViewPreRow(this)),c+='<tr class="detail-'+a.name+'">',b.model_===DAOController?(c+="<td colspan=2><div class=detailArrayLabel>"+a.label+"</div>",c+=b.toHTML(),c+="</td>"):(c+="<td class='label'>"+a.label+"</td>",c+="<td>",c+=b.toHTML(),c+="</td>"),c+="</tr>",a.detailViewPostRow&&(c+=a.detailViewPostRow(this)),c},toHTML:function(){return(this.model.getPrototype().toDetailHTML||this.defaultToHTML).call(this)},defaultToHTML:function(){this.children=[];var a=this.model,b="";b+='<div id="'+this.id+'" class="detailView" name="form">',b+="<table>",b+=this.titleHTML();for(var c=0;c<a.properties.length;c++){var d=a.properties[c];d.hidden||(b+=this.rowToHTML(d,this.createView(d)))}return b+="</table>",b+="</div>"},initHTML:function(){this.SUPER(),this.updateSubViews(),this.initKeyboardShortcuts()},set:function(a){this.getValue().set(a)},get:function(){return this.getValue().get()},evtToKeyCode:function(a){var b="";return a.ctrlKey&&(b+="ctrl-"),a.shiftKey&&(b+="shift-"),b+=a.keyCode},initKeyboardShortcuts:function(){for(var a={},b=!1,c=0;c<this.model.actions.length;c++)for(var d=this.model.actions[c],e=0;e<d.keyboardShortcuts.length;e++){var f=d.keyboardShortcuts[e],g=f.toString();a[g]=d,b=!0}b&&(this.keyMap_=a,this.$.parentElement.addEventListener("keydown",this.onKeyboardShortcut))},updateSubViews:function(){var a=this.get();if(""!==a)for(var b=0;b<this.children.length;b++){var c=this.children[b],d=c.prop;if(d)try{c.model_.DATA?c.data=a:c.value=a.propertyValue(d.name)}catch(e){console.log("error: ",d.name," ",e)}}},setModel:function(a){a&&(this.obj=a)}}}),FOAModel({name:"UpdateDetailView",extendsModel:"DetailView",properties:[{name:"originalData"},{name:"data",getter:function(){return this.value.value},setter:function(a){this.originalData=a.deepClone(),this.value=SimpleValue.create(a)}},{name:"dao"},{name:"stack",defaultValueFn:function(){return this.X.stack}},{name:"view"}],actions:[{name:"save",help:"Save updates.",isEnabled:function(){return!this.originalData.equals(this.data)},action:function(){var a=this,b=this.data;this.dao.put(b,{put:function(){console.log("Saving: ",b.toJSON()),a.stack.back()},error:function(){console.error("Error saving",arguments)}})}},{name:"cancel",help:"Cancel update.",isEnabled:function(){return!this.originalData.equals(this.data)},action:function(){this.stack.back()}},{name:"back",isEnabled:function(){return this.originalData.equals(this.data)},action:function(){this.stack.back()}}]}),FOAModel({name:"TableView",extendsModel:"View",label:"Table View",properties:[{name:"model",type:"Model",defaultValueFn:function(){return this.X.model}},{model_:"StringArrayProperty",name:"properties",preSet:function(a,b){return b&&0!=b.length?b:null},postSet:function(){this.repaint()},defaultValue:null},{name:"hardSelection",type:"Value",postSet:function(a,b){this.publish(this.ROW_SELECTED,b)},factory:function(){return SimpleValue.create()}},{name:"selection",type:"Value",factory:function(){return SimpleValue.create()}},{name:"children",type:"Array[View]",factory:function(){return[]}},{name:"sortOrder",type:"Comparator",postSet:function(){this.repaint()},defaultValue:void 0},{name:"dao",label:"DAO",type:"DAO",required:!0,hidden:!0,postSet:function(a,b){this.daoListener&&(a&&a.unlisten(this.daoListener),b&&b.listen(this.daoListener)),this.scrollbar.value=0,this.onDAOUpdate()}},{name:"value",postSet:function(a,b){a&&a.removeListener(this.onValueChange),b.addListener(this.onValueChange),this.onValueChange()}},{name:"rows",type:"Int",defaultValue:50,postSet:function(a,b){a!==b&&this.repaint()}},{model_:"IntProperty",name:"height"},{model_:"BooleanProperty",name:"scrollEnabled",defaultValue:!1},{model_:"BooleanProperty",name:"editColumnsEnabled",defaultValue:!1},{name:"scrollbar",type:"ScrollCView",factory:function(){var a=this.X.ScrollCView.create({height:800,width:24,x:1,y:0,size:200,extent:10});return a.value$.addListener(this.repaint),a}},{name:"scrollPitch",help:"Number of (CSS) pixels of touch drag required to scroll by one",defaultValue:10},{name:"touchScrolling",model_:"BooleanProperty",defaultValue:!1,hidden:!0,"transient":!0},{name:"touchPrev",hidden:!0,"transient":!0,defaultValue:0}],listeners:[{name:"onResize",isMerged:200,code:function(){if(this.$){var a=this.$.parentElement.offsetHeight,b=Math.ceil((a-47)/20)+1;
this.rows=b,this.scrollbar.height=a-1,this.scrollbar.paint()}}},{name:"onDAOUpdate",isAnimated:!0,code:function(){this.dao&&this.dao.select(COUNT())(function(a){this.scrollbar.size=a.count,this.repaint()}.bind(this))}},{name:"repaint",isAnimated:!0,code:function(){this.repaintNow()}},{name:"onValueChange",code:function(){this.dao=this.value.value}},{name:"onEditColumns",code:function(){var a=EditColumnsView.create({model:this.model,properties:this.properties||this.model.tableProperties,availableProperties:this.model.properties});a.addPropertyListener("properties",function(){a.close(),this.properties=a.properties,a.removePropertyListener("properties",arguments.callee),this.repaint()}.bind(this)),this.$.insertAdjacentHTML("beforebegin",a.toHTML()),a.initHTML()}},{name:"onTouchStart",code:function(a){return a.length>1?{drop:!0}:{weight:.3}}},{name:"onTouchMove",code:function(a,b){var c=a[b[0]];if(this.touchScrolling){var d=this.scrollbar,e=c.y-this.touchPrev;return e>this.scrollPitch&&d.value>0?(this.touchPrev=c.y,d.value--):e<-this.scrollPitch&&d.value<d.size-d.extent&&(this.touchPrev=c.y,d.value++),{claim:!0,weight:.99,preventDefault:!0}}return Math.abs(c.dy)>10&&Math.abs(c.dx)<10?(this.touchScrolling=!0,this.touchPrev=c.y,{claim:!0,weight:.8,preventDefault:!0}):c.distance<10?{preventDefault:!0}:{drop:!0}}},{name:"onTouchEnd",code:function(){return this.touchScrolling=!1,{drop:!0}}}],methods:{ROW_SELECTED:["escape"],DOUBLE_CLICK:"double-click",toHTML:function(){return'<div style="display:flex;width:100%;height:100%"><span id="'+this.id+'" style="flex:1 1 100%;overflow-x:auto;overflow-y:hidden;">'+this.tableToHTML()+'</span><span style="width:19px;flex:none;overflow:hidden;">'+this.scrollbar.toHTML()+"</span></div>"},initHTML:function(){if(this.scrollbar.initHTML(),this.onDAOUpdate(),this.daoListener={put:this.onDAOUpdate,remove:this.onDAOUpdate},this.scrollEnabled){(this.window||window).addEventListener("resize",this.onResize,!1);var a=this.scrollbar;this.$.parentElement.onmousewheel=function(b){b.wheelDeltaY>0&&a.value?a.value--:b.wheelDeltaY<0&&a.value<a.size-a.extent&&a.value++},this.X.touchManager&&this.X.touchManager.install(TouchReceiver.create({id:"qbug-table-scroll-"+this.id,element:this.$.parentElement,delegate:this})),this.onResize()}this.dao&&this.dao.listen(this.daoListener)},repaintNow:function(){var a=this.dao;if(a&&this.$){a=a.skip(this.scrollbar.value);var b=this;this.sortOrder&&(a=a.orderBy(this.sortOrder)),a.limit(this.rows).select()(function(a){b.objs=a,b.$&&(b.$.innerHTML=b.tableToHTML(),b.initHTML_())})}},tableToHTML:function(){var a=this.model;this.initializers_&&(delete this.initializers_,this.children=[]);var b=[],c=[];b.push('<table class="foamTable '+a.name+'Table">'),b.push("<thead><tr>");for(var d=this.properties||this.model.tableProperties,e=0;e<d.length;e++){var f=d[e],g=a.getProperty(f);if(g&&!g.hidden){b.push("<th scope=col "),b.push("id="+this.on("click",function(a,b){return function(){a.sortOrder=a.sortOrder===b?DESC(b):b,a.repaintNow()}}(this,g))),g.tableWidth&&b.push(' width="'+g.tableWidth+'"');var h="";this.sortOrder===g?h=' <span class="indicator">&#9650;</span>':this.sortOrder&&DescExpr.isInstance(this.sortOrder)&&this.sortOrder.arg1===g&&(h=' <span class="indicator">&#9660;</span>'),b.push(">"+g.tableLabel+h+"</th>"),c.push(g)}}this.editColumnsEnabled&&b.push('<th width=15 id="'+this.on("click",this.onEditColumns)+'">...</th>'),b.push('</tr><tr style="height:2px"></tr></thead><tbody>');var i=this.objs;if(i)for(var j=this.hardSelection.get(),e=0;e<i.length;e++){var k=i[e],l="tr-"+this.id;j&&k.id==j.id&&(l+=" rowSelected"),b.push('<tr class="'+l+'">');for(var m=0;m<c.length;m++){var g=c[m];b.push(m==c.length-1&&this.editColumnsEnabled?'<td colspan=2 class="'+g.name+'">':'<td class="'+g.name+'">');var n=k[g.name];b.push(g.tableFormatter?g.tableFormatter(n,k,this):null==n?"&nbsp;":this.strToHTML(n)),b.push("</td>")}b.push("</tr>")}return b.push("</tbody></table>"),b.join("")},initHTML_:function(){this.initHTML.super_.call(this);for(var a=$$("tr-"+this.id),b=this,c=0;c<a.length;c++){var d=a[c];d.onmouseover=function(a,b){return function(){a.set(b)}}(this.selection,this.objs[c]),d.onmouseout=function(a){return function(){a.set(b.hardSelection.get())}}(this.selection,this.objs[c]),d.onclick=function(a,c){return function(d){b.hardSelection.set(c),a.set(c),delete a.prevValue;for(var e=d.srcElement;e&&"TR"!==e.tagName;)e=e.parentNode;for(var f=e;f&&"TBODY"!==f.tagName;)f=f.parentNode;for(var g=f?f.childNodes:[],h=0;h<g.length;h++)g[h].classList.remove("rowSelected");e&&e.classList.add("rowSelected")}}(this.selection,this.objs[c]),d.ondblclick=function(a,c){return function(){b.publish(b.DOUBLE_CLICK,c,a)}}(this.selection,this.objs[c])}delete this.initializers_,this.children=[]},setValue:function(a){this.value=a},destroy:function(){}}}),FOAModel({name:"Canvas",extendsModel:"View",properties:[{name:"background",label:"Background Color",type:"String",defaultValue:"white"},{name:"width",type:"int",defaultValue:100,postSet:function(a,b){this.$&&(this.$.width=b)}},{name:"height",type:"int",defaultValue:100,postSet:function(a,b){this.$&&(this.$.height=b)}}],listeners:[{name:"paint",isAnimated:!0,code:function(){if(!this.$)throw EventService.UNSUBSCRIBE_EXCEPTION;this.erase(),this.paintChildren()}}],methods:{toHTML:function(){return'<canvas id="'+this.id+'" width="'+this.width+'" height="'+this.height+'"> </canvas>'},initHTML:function(){this.$&&(this.canvas=this.$.getContext("2d"))},addChild:function(a){a.parent=null,this.SUPER(a);try{a.addListener(this.paint)}catch(b){console.log(b)}return this},erase:function(){this.canvas.fillStyle=this.background,this.canvas.fillRect(0,0,this.width,this.height)},paintChildren:function(){for(var a=0;a<this.children.length;a++){var b=this.children[a];this.canvas.save(),b.paint(),this.canvas.restore()}}}}),FOAModel({name:"CView",label:"CView",properties:[{name:"parent",type:"CView",hidden:!0},{name:"x",type:"int",view:"IntFieldView",defaultValue:10},{name:"y",type:"int",view:"IntFieldView",defaultValue:10},{name:"width",type:"int",view:"IntFieldView",defaultValue:10},{name:"height",type:"int",view:"IntFieldView",defaultValue:10},{name:"children",type:"CView[]",factory:function(){return[]},hidden:!0},{name:"background",label:"Background Color",type:"String",defaultValue:"white"},{name:"canvas",type:"Canvas",getter:function(){return this.parent&&this.parent.canvas},setter:void 0,hidden:!0}],listeners:[{name:"resizeParent",code:function(){this.parent.width=this.x+this.width+1,this.parent.height=this.y+this.height+2}}],methods:{toHTML:function(){return this.parent||(this.parent=this.X.Canvas.create(),this.x$.addListener(this.resizeParent),this.y$.addListener(this.resizeParent),this.width$.addListener(this.resizeParent),this.height$.addListener(this.resizeParent),this.resizeParent()),this.parent.toHTML()},initHTML:function(){var a=this,b=this.parent;b.addChild(this),b.initHTML(),this.X.dynamic(function(){a.background},function(){b.background=a.background})},write:function(a){a.writeln(this.toHTML()),this.initHTML()},addChild:function(a){return this.children.push(a),a.parent=this,this},removeChild:function(a){return this.children.deleteI(a),a.parent=void 0,this},erase:function(){this.canvas.fillStyle=this.background,this.canvas.fillRect(0,0,this.width,this.height)},paintChildren:function(){for(var a=0;a<this.children.length;a++){var b=this.children[a];this.canvas.save(),b.paint(),this.canvas.restore()}},paintSelf:function(){},paint:function(){this.parent.$&&(this.erase(),this.paintSelf(),this.paintChildren())}}}),FOAModel({name:"Label",properties:[{name:"parent",type:"CView",hidden:!0},{name:"text",type:"String",defaultValue:""},{name:"align",label:"Alignment",type:"String",defaultValue:"start"},{name:"font",type:"String",defaultValue:""},{name:"color",type:"String",defaultValue:"black"},{name:"x",type:"int",defaultValue:100},{name:"y",type:"int",defaultValue:100},{name:"maxWidth",label:"Maximum Width",type:"int",defaultValue:-1}],methods:{paint:function(){var a=this.parent.canvas,b=a.font,c=a.textAlign;this.font&&(a.font=this.font),a.textAlign=this.align,a.fillStyle=this.color,a.fillText(this.text,this.x,this.y),a.font=b,a.textAlign=c}}}),FOAModel({name:"Box",extendsModel:"Label",properties:[{name:"background",label:"Background Color",type:"String",defaultValue:"white"},{name:"border",label:"Border Color",type:"String",defaultValue:"black"},{name:"a",label:"Angle",type:"int",defaultValue:0},{name:"width",type:"int",defaultValue:100},{name:"height",type:"int",defaultValue:100}],methods:{paint:function(){var a=this.parent.canvas;a.save(),this.a&&(a.translate(this.x+this.width/2,this.y+this.height/2),a.rotate(this.a),a.translate(-this.x-this.width/2,-this.y-this.height/2)),a.fillStyle=this.background,a.fillRect(this.x,this.y,this.width,this.height),this.border&&this.width&&this.height&&(a.strokeStyle=this.border,a.strokeRect(this.x,this.y,this.width,this.height));var b=a.font,c=a.textAlign;this.font&&(a.font=this.font),a.textAlign="center",a.fillStyle=this.color,a.fillText(this.text,this.x+this.width/2,this.y+this.height/2+10),a.font=b,a.textAlign=c;var d=a.createLinearGradient(this.x,this.y,this.x+this.width,this.y+this.height);d.addColorStop(0,"rgba(0,0,0,0.35)"),d.addColorStop(.5,"rgba(0,0,0,0)"),d.addColorStop(1,"rgba(255,255,255,0.45)"),a.fillStyle=d,a.fillRect(this.x,this.y,this.width,this.height),a.restore()}}}),FOAModel({name:"Circle",properties:[{name:"parent",type:"CView",hidden:!0},{name:"color",type:"String",defaultValue:"white"},{name:"border",label:"Border Color",type:"String",defaultValue:void 0},{name:"borderWidth",type:"int",defaultValue:1},{name:"alpha",type:"int",defaultValue:1},{name:"x",type:"int",defaultValue:100},{name:"y",type:"int",defaultValue:100},{name:"r",label:"Radius",type:"int",defaultValue:20}],methods:{paint3d:function(){var a=this.parent.canvas,b=a.createRadialGradient(this.x+this.r/6,this.y+this.r/6,this.r/3,this.x+2,this.y,this.r);b.addColorStop(0,"#a7a7a7"),b.addColorStop(.9,this.color),b.addColorStop(1,"black"),a.fillStyle=b,a.beginPath(),a.arc(this.x,this.y,this.r,0,2*Math.PI,!0),a.closePath(),a.fill()},paint:function(){var a=this.parent.canvas;a.save(),a.globalAlpha=this.alpha,a.fillStyle=this.color,this.border&&this.r&&(a.lineWidth=this.borderWidth,a.strokeStyle=this.border,a.beginPath(),a.arc(this.x,this.y,this.r,0,2*Math.PI,!0),a.closePath(),a.stroke()),this.color&&(a.beginPath(),a.arc(this.x,this.y,this.r,0,2*Math.PI,!0),a.closePath(),a.fill()),a.restore()}}}),FOAModel({name:"ImageCView",properties:[{name:"parent",type:"CView",hidden:!0},{name:"alpha",type:"int",defaultValue:1},{name:"x",type:"int",defaultValue:100},{name:"y",type:"int",defaultValue:100},{name:"scale",type:"int",defaultValue:1},{name:"src",label:"Source",type:"String"}],methods:{init:function(){this.SUPER(),this.image_=new Image,this.image_.src=this.src},paint:function(){var a=this.parent.canvas;a.translate(this.x,this.y),a.scale(this.scale,this.scale),a.translate(-this.x,-this.y),a.drawImage(this.image_,this.x,this.y)}}}),FOAModel({name:"Rectangle",properties:[{name:"parent",type:"CView",hidden:!0},{name:"color",type:"String",defaultValue:"white"},{name:"x",type:"int",defaultValue:1e3},{name:"y",type:"int",defaultValue:100},{name:"width",type:"int",defaultValue:100},{name:"height",type:"int",defaultValue:100}],methods:{paint:function(){var a=this.parent.canvas;a.fillStyle=this.color,a.fillRect(this.x,this.y,this.width,this.height)}}}),FOAModel({name:"ProgressCView",extendsModel:"CView",properties:[{name:"value",type:"Value",factory:function(){return SimpleValue.create()},postSet:function(a,b){a&&a.removeListener(this.updateValue),b.addListener(this.updateValue)}}],listeners:{updateValue:function(){this.paint()}},methods:{paint:function(){var a=this.canvas;a.fillStyle="#fff",a.fillRect(0,0,104,20),a.strokeStyle="#000",a.strokeRect(0,0,104,20),a.fillStyle="#f00",a.fillRect(2,2,parseInt(this.value.get()),16)},destroy:function(){this.value.removeListener(this.listener_)}}}),FOAModel({name:"Graph",extendsModel:"CView",properties:[{name:"style",type:"String",defaultValue:"Line",view:{create:function(){return ChoiceView.create({choices:["Bar","Line","Point"]})}}},{name:"width",type:"int",view:"IntFieldView",defaultValue:5},{name:"height",type:"int",view:"IntFieldView",defaultValue:5},{name:"graphColor",type:"String",defaultValue:"green"},{name:"backgroundColor",type:"String",defaultValue:void 0},{name:"lineWidth",type:"int",defaultValue:6},{name:"drawShadow",type:"boolean",defaultValue:!0},{name:"capColor",type:"String",defaultValue:""},{name:"axisColor",type:"String",defaultValue:"black"},{name:"gridColor",type:"String",defaultValue:void 0},{name:"axisSize",type:"int",defaultValue:2},{name:"xAxisInterval",type:"int",defaultValue:0},{name:"yAxisInterval",type:"int",defaultValue:0},{name:"maxValue",label:"Maximum Value",type:"float",defaultValue:-1},{name:"data",type:"Array[float]",factory:function(){return[]}},{name:"f",label:"Data Function",type:"Function",required:!1,displayWidth:70,displayHeight:3,view:"FunctionView",defaultValue:function(a){return a},help:"The graph's data function."}],issues:[{id:1e3,severity:"Major",status:"Open",summary:"Make 'style' view serializable",created:"Sun Dec 23 2012 18:14:56 GMT-0500 (EST)",createdBy:"kgr",assignedTo:"kgr",notes:"ChoiceView factory prevents Model from being serializable."}],methods:{paintLineData:function(a,b,c,d,e,f,g){if(this.graphColor){a.fillStyle=this.graphColor,a.beginPath(),a.moveTo(b+d,c+f-d);for(var h=0;h<this.data.length;h++){var i=this.f(this.data[h]),j=b+d+(0==h?0:e*h/(this.data.length-1)),k=this.toY(i,g);a.lineTo(j,k)}a.lineTo(b+this.width-1,c+f-d),a.lineTo(b+d,c+f-d),a.fill()}if(this.capColor){this.drawShadow&&(a.shadowOffsetX=0,a.shadowOffsetY=2,a.shadowBlur=2,a.shadowColor="rgba(0, 0, 0, 0.5)"),a.strokeStyle=this.capColor,a.lineWidth=this.lineWidth,a.lineJoin="round",a.beginPath();for(var h=0;h<this.data.length;h++){var i=this.f(this.data[h]),j=this.toX(h)+.5,k=this.toY(i,g)-5;0==h?a.moveTo(j,k):a.lineTo(j,k)}a.stroke()}},paintPointData:function(a,b,c,d,e,f,g){a.shadowOffsetX=2,a.shadowOffsetY=2,a.shadowBlur=2,a.shadowColor="rgba(0, 0, 0, 0.5)",a.strokeStyle=this.capColor,a.lineWidth=2,a.lineJoin="round",a.beginPath();for(var h=0;h<this.data.length;h++){var i=this.f(this.data[h]),j=this.toX(h)+.5,k=this.toY(i,g)+.5;0==h?a.moveTo(j,k):a.lineTo(j,k)}a.stroke(),a.lineWidth=3;for(var h=0;h<this.data.length;h++){var i=this.f(this.data[h]),j=this.toX(h)+.5,k=this.toY(i,g)+.5;a.beginPath(),a.arc(j,k,4,0,-Math.PI/2),a.closePath(),a.stroke()}},paintBarData:function(a,b,c,d,e,f,g){a.fillStyle=this.graphColor;for(var h=0;h<this.data.length;h++){var i=this.f(this.data[h]),j=b+d+e*h/this.data.length,k=this.toY(i,g);a.fillRect(j,k,e/this.data.length+1.5,i*f/g)}},paint:function(){var a=this.canvas,b=this.x,c=this.y,d=this.axisSize,e=this.width-d,f=this.height-d,g=this.maxValue;if(this.backgroundColor&&(a.fillStyle=this.backgroundColor,a.fillRect(b,c,e,f)),-1==g){g=.001;for(var h=0;h<this.data.length;h++){var i=this.f(this.data[h]);g=Math.max(g,i)}}if("Line"==this.style?this.paintLineData(a,b,c,d,e,f,g):"Bar"==this.style?this.paintBarData(a,b,c,d,e,f,g):"Point"==this.style&&this.paintPointData(a,b,c,d,e,f,g),this.axisColor&&0!=d&&(a.fillStyle=this.axisColor,a.fillRect(b,c+f-1.5*d,this.width,d),a.fillRect(b,c,d,this.height-1.5*d)),this.xAxisInterval)for(var h=this.xAxisInterval;h<=this.data.length;h+=this.xAxisInterval){var j=this.toX(h);this.gridColor&&(a.save(),a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=0,a.fillStyle=this.gridColor,a.fillRect(j+1.5,this.toY(0,1)-2*d,.5,-this.height),a.restore()),a.fillRect(j,this.toY(0,1)-2*d,d/2,-d)}if(this.yAxisInterval)for(var h=this.yAxisInterval;g>=h;h+=this.yAxisInterval){var c=this.toY(h,g);this.gridColor&&(a.save(),a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=0,a.fillStyle=this.gridColor,a.fillRect(b+d,c+3,this.width,.5),a.restore()),a.fillRect(b+d,c,d,d/2)}},toX:function(a){var b=this.width-this.axisSize;return this.x+this.axisSize+(0==a?0:b*a/(this.data.length-1))},toY:function(a,b){var c=this.height-this.axisSize;return this.y+c-a*c/b+.5},lastValue:function(){return this.data[this.data.length-1]},addData:function(a,b){var c=b||this.width;this.data.length==c&&this.data.shift(),this.data.push(a)},watch:function(a,b){var c=this;a.addListener(function(){c.addData(a.get(),b)})}}});var WarpedCanvas={create:function(a,b,c,d,e,f){return{__proto__:a,warp:function(a,d){if(Math.abs(f)<.01||1>b&&1>c)return this.x=a,void(this.y=d);var e=a-b,g=d-c,h=Math.sqrt(e*e+g*g),i=Math.atan2(g,e),j=400*(1+f);h/=j,1>h&&(h+=3*f*h*Math.pow(1-h,4)),h*=j,this.x=b+Math.cos(i)*h,this.y=c+Math.sin(i)*h},moveTo:function(b,c){this.warp(b,c),a.moveTo(this.x,this.y),this.X=b,this.Y=c},lineTo:function(b,c){for(var d=100,e=this.X,f=this.Y,g=(b-e)/d,h=(c-f)/d,i=e,j=f,k=0;d>k;k++)i+=g,j+=h,this.warp(i,j),a.lineTo(this.x,this.y);this.X=b,this.Y=c},line:function(b,c,d,e){a.beginPath(),this.moveTo(b,c),this.lineTo(d,e),a.stroke()},fillText:function(b,c,d){this.warp(c,d),a.fillText(b,this.x,this.y)},fillRect:function(b,c,d,e){a.beginPath(),this.moveTo(b,c),this.lineTo(b+d,c),this.lineTo(b+d,c+e),this.lineTo(b,c+e),this.lineTo(b,c),a.closePath(),a.fill()},get font(){return a.linewidth},set font(b){a.linewidth=b},get lineWidth(){return a.linewidth},set lineWidth(b){a.linewidth=b},get strokeStyle(){return a.strokeStyle},set strokeStyle(b){a.strokeStyle=b},get fillStyle(){return a.fillStyle},set fillStyle(b){a.fillStyle=b},get textAlign(){return a.textAlign},set textAlign(b){a.textAlign=b}}}};FOAModel({name:"GridCView",extendsModel:"CView",label:"GridCView",properties:[{name:"grid",type:"GridByExpr"},{name:"mag",help:"The current magnification level.  Animates to desiredMag.",defaultValue:.6},{name:"desiredMag",postSet:function(a,b){this.mag=b},defaultValue:.6},{name:"mouse",factory:function(){return this.X.Mouse.create()}}],listeners:[{name:"onMouseMove",code:function(){this.parent.paint()}}],methods:{initHTML:function(){var a=this;this.SUPER(),this.mouse.connect(this.parent.$),this.parent.$.addEventListener("mouseout",function(){this.animation_&&this.animation_(),this.animation_=Movement.animate(800,function(){a.mag=0},Movement.oscillate(.8,a.mag/4))()}),this.parent.$.addEventListener("mouseenter",function(){this.animation_&&this.animation_(),this.animation_=Movement.animate(400,function(){a.mag=a.desiredMag})()}),this.parent.$.onmousewheel=function(a){a.wheelDeltaY>0?this.desiredMag+=.05:this.desiredMag=Math.max(0,this.desiredMag-.05),this.parent.paint()}.bind(this),this.mouse.addListener(this.onMouseMove)},line:function(a,b,c,d){var e=this.canvas;e.beginPath(),e.moveTo(a,b),e.lineTo(c,d),e.closePath(),e.stroke()},paint:function(){function a(a,b,c,d){k.warp(c,d);var e=a-k.x,f=b-k.y;return e*e+f*f}var b=140,c=30;this.width=this.parent.$.parentElement.clientWidth,this.height=this.parent.$.parentElement.clientHeight;var d=this.canvas,e=this.grid,f=(e.cols.groups,e.rows.groups),g=e.sortedCols(),h=e.sortedRows(),i=this.width,j=this.height,k=WarpedCanvas.create(d,this.mouse.x,this.mouse.y,i,j,this.mag),l=(i-b)/g.length,m=(j-c)/h.length;k.fillStyle="#eee",k.fillRect(0,0,this.width,c),k.fillRect(0,0,b,this.height),k.lineWidth=1,k.strokeStyle="#000",k.fillStyle="#000",k.textAlign="left",k.font="bold 10px arial";for(var n=0;n<g.length;n++){var o=b+n*l;k.fillText(g[n],o+2,c/2+2),k.line(o,0,o,j)}k.line(0,0,0,j),k.line(i,0,i,j);for(var n=0;n<h.length;n++){var p=c+n*m;k.fillText(h[n],5,p+m/2),k.line(0,p,i,p)}k.line(0,0,i,0),k.line(0,j,i,j);for(var q=0;q<h.length;q++)for(var p=h[q],n=0;n<g.length;n++){var o=g[n],r=f[p].groups[o];if(r&&r.toCView){var s=r.toCView(),t=b+l*(n+.5),u=c+m*(q+.5);k.warp(t,u),s.x=k.x,s.y=k.y,s.r=Math.sqrt(Math.min(a(s.x,s.y,t+l/2,u),a(s.x,s.y,t-l/2,u),a(s.x,s.y,t,u+m/2),a(s.x,s.y,t,u-m/2)))-4,s.x-=s.r,s.y-=s.r,s.parent=this.parent,s.r>3&&s.paint()}}}}}),FOAModel({name:"Link",properties:[{name:"richTextView"},{name:"label",displayWidth:28},{name:"link",displayWidth:19,view:{model_:"TextFieldView",placeholder:"Type or paste link."},preSet:function(a,b){return b=b.trim(),b.toLowerCase().startsWith("javascript:")&&(b=""),b}}],methods:{open:function(a,b){var c=LinkView.create({model:Link,value:SimpleValue.create(this)});this.richTextView.$.parentNode.insertAdjacentHTML("beforebegin",c.toHTML()),c.$.style.left=a+this.richTextView.$.offsetLeft,c.$.style.top=b+this.richTextView.$.offsetTop,c.initHTML(),this.view=c}},actions:[{name:"insert",label:"Apply",help:"Insert this link into the document.",action:function(){var a=document.createElement("a"),b=document.createTextNode(this.label);a.href=this.link,a.appendChild(b),this.richTextView.insertElement(a),this.view.close()}}]}),FOAModel({name:"LinkView",extendsModel:"DetailView",properties:[{name:"insertButton",factory:function(){return ActionButton.create({action:Link.INSERT,value:this.value})}}],methods:{init:function(){this.SUPER(),this.addChild(this.insertButton)},initHTML:function(){this.SUPER(),this.$.addEventListener("keyup",this.keyUp),this.labelView.focus()},close:function(){this.$.remove()}},listeners:[{name:"keyUp",code:function(a){27==a.keyCode&&(a.stopPropagation(),this.close())}}],templates:[{name:"toHTML",template:'<div id="<%= this.id %>" class="linkDialog" style="position:absolute">        <table><tr>        <th>Text</th><td>$$label</td></tr><tr>        <th>Link</th><td>$$link        %%insertButton</td>        </tr></table>        </div>'}]}),FOAModel({name:"ColorPickerView",extendsModel:"View",properties:[{name:"value",factory:function(){return SimpleValue.create({})}}],methods:{toHTML:function(){var a="<table>";a+="<tr>";for(var b=this,c=function(c,d,e){var f="rgb("+c+","+d+","+e+")";a+='<td class="pickerCell"><div id="'+b.on("click",function(a){b.value.set(f),a.preventDefault()})+'" class="pickerDiv" style="background-color: '+f+'"></div></td>'},d=0;8>d;d++){var e=Math.floor(255*d/7);c(e,e,e)}return a+="</tr><tr>",c(255,0,0),c(255,153,0),c(255,255,0),c(0,255,0),c(0,255,255),c(0,0,255),c(153,0,255),c(255,0,255),a+="</tr></table>"}}}),FOAModel({name:"RichTextView",extendsModel:"View",properties:[{model_:"StringProperty",name:"height",defaultValue:"400"},{model_:"StringProperty",name:"width",defaultValue:"100%"},{name:"mode",type:"String",defaultValue:"read-write",view:{create:function(){return ChoiceView.create({choices:["read-only","read-write","final"]})}}},{name:"value",type:"Value",factory:function(){return SimpleValue.create()},postSet:function(a,b){Events.unlink(a,this.domValue),Events.link(b,this.domValue),a&&a.removeListener(this.maybeShowPlaceholder),b.addListener(this.maybeShowPlaceholder)}},{name:"placeholder",help:"Placeholder text to appear when no text is entered."},{name:"document",hidden:!0}],listeners:[{name:"maybeShowPlaceholder",code:function(){var a=$(this.placeholderId);a&&(a.style.visibility=""==this.value.get()?"visible":"hidden")}}],methods:{toHTML:function(){{var a="read-write"===this.mode?"":' sandbox="allow-same-origin"';this.id}return this.dropId=this.nextID(),this.placeholderId=this.nextID(),'<div class="richtext"><div id="'+this.dropId+'" class="dropzone"><div class=spacer></div>Drop files here<div class=spacer></div></div><div id="'+this.placeholderId+'" class="placeholder">'+this.placeholder+'</div><iframe style="width:'+this.width+"px;min-height:"+this.height+'px" id="'+this.id+'"'+a+' img-src="*"></iframe></div>'},initHTML:function(){this.SUPER();var a=$(this.dropId);this.dropzone=a,this.document=this.$.contentDocument;var b=this.document.body;$(this.placeholderId).addEventListener("click",function(){b.focus()}),this.document.head.insertAdjacentHTML("afterbegin","<style>blockquote{border-left-color:#ccc;border-left-style:solid;padding-left:1ex;}</style>"),b.style.overflow="auto",b.style.margin="5px",b.style.height="100%";var c=this;b.ondrop=function(a){a.preventDefault(),c.showDropMessage(!1);for(var b=a.dataTransfer.files.length,d=0;b>d;d++){var e=a.dataTransfer.files[d],f=this.addAttachment(e);if(e.type.startsWith("image/")){var g=document.createElement("img");g.id=f,g.src=URL.createObjectURL(e),this.insertElement(g)}}if(b=a.dataTransfer.items.length){var h=this.sanitizeDroppedHtml(a.dataTransfer.getData("text/html"));this.insertElement(h)}}.bind(this),c.dragging_=0,b.ondragenter=function(){c.dragging_++,c.showDropMessage(!0)},b.ondragleave=function(){0==--c.dragging_&&c.showDropMessage(!1)},"read-write"===this.mode&&(this.document.body.contentEditable=!0),this.domValue=DomValue.create(this.document.body,"input","innerHTML"),this.value=this.value,this.maybeShowPlaceholder()},setValue:function(a){this.value=a},getSelectionText:function(){var a=this.$.contentWindow,b=a.getSelection();return b.rangeCount?b.getRangeAt(0).toLocaleString():""},insertElement:function(a){var b=this.$.contentWindow,c=b.getSelection();if(c.rangeCount){var d=c.getRangeAt(0);d.deleteContents(),d.insertNode(a)}else{var e=b.document.createRange();e.selectNodeContents(b.document.body),e.insertNode(a)}this.updateValue()},updateValue:function(){this.value.set(this.document.body.innerHTML)},showDropMessage:function(a){this.$.style.opacity=a?"0":"1"},sanitizeDroppedHtml:function(a){function b(a,c){for(var e=0;e<d.length;e++)if(d[e].name===c.nodeName){if(d[e].clone)newNode=d[e].clone(c);else if(c.nodeType===Node.ELEMENT_NODE){newNode=document.createElement(c.nodeName);for(var f=0;f<d[e].attributes.length;f++)c.hasAttribute(d[e].attributes[f])&&newNode.setAttribute(d[e].attributes[f],c.getAttribute(d[e].attributes[f]))}else newNode=c.nodeType===Node.TEXT_NODE?document.creatTextNode(c.nodeValue):document.createTextNode("");break}for(e===d.length&&(newNode=document.createElement("div")),newNode&&a.appendChild(newNode),f=0;f<c.children.length;f++)b(newNode,c.children[f])}var c=this,d=[{name:"B",attributes:[]},{name:"I",attributes:[]},{name:"U",attributes:[]},{name:"P",attributes:[]},{name:"SECTION",attributes:[]},{name:"BR",attributes:[]},{name:"BLOCKQUOTE",attributes:[]},{name:"DIV",attributes:[]},{name:"IMG",attributes:["src"],clone:function(a){var b=document.createElement("img");if(a.src.startsWith("http")){var d=new XMLHttpRequest;d.open("GET",a.src),d.responseType="blob",d.asend(function(a){a.name="dropped image",a?(b.id=c.addAttachment(a),b.src=URL.createObjectURL(a)):a.parent.removeChild(a),c.updateValue()})}else{if(!a.src.startsWith("data:"))return null;var e=a.src.substring(5,a.src.indexOf(";")),f=Base64Decoder.create([],a.src.length);f.put(a.src.substring(a.src.indexOf("base64,")+7)),f.eof();var g=new Blob(f.sink,{type:e});g.name="dropped image",b.id=c.addAttachment(g),b.src=URL.createObjectURL(g)}return b}},{name:"A",attributes:["href"]},{name:"#TEXT",attributes:[]}],e=document.createElement("iframe");e.sandbox="allow-same-origin",e.style.display="none",document.body.appendChild(e),e.contentDocument.body.innerHTML=a;for(var f=new DocumentFragment,g=0;g<e.contentDocument.body.children.length;g++)b(f,e.contentDocument.body.children[g]);return document.body.removeChild(e),f},addAttachment:function(a){var b="att"+{}.$UID;return console.log("file: ",a,b),this.publish("attachmentAdded",a,b),b},removeImage:function(a){var b=this.document.getElementById(a);b&&(b.outerHTML="",this.value.set(this.document.body.innerHTML))},destroy:function(){Events.unlink(this.domValue,this.value)},textToValue:function(a){return a},valueToText:function(a){return a},setForegroundColor:function(a){this.$.contentWindow.focus(),this.document.execCommand("foreColor",!1,a)},setBackgroundColor:function(a){this.$.contentWindow.focus(),this.document.execCommand("backColor",!1,a)}},actions:[{name:"bold",label:"<b>B</b>",help:"Bold (Ctrl-B)",action:function(){this.$.contentWindow.focus(),this.document.execCommand("bold")}},{name:"italic",label:"<i>I</i>",help:"Italic (Ctrl-I)",action:function(){this.$.contentWindow.focus(),this.document.execCommand("italic")}},{name:"underline",label:"<u>U</u>",help:"Underline (Ctrl-U)",action:function(){this.$.contentWindow.focus(),this.document.execCommand("underline")}},{name:"link",label:"Link",help:"Insert link (Ctrl-K)",action:function(){Link.create({richTextView:this,label:this.getSelectionText()}).open(5,120)}},{name:"fontSize",label:"Font Size",help:"Change the font size.",action:function(){}},{name:"small",help:"Set's the font size to small.",label:"small",parent:"fontSize",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontSize",!1,"2")}},{name:"normal",help:"Set's the font size to normal.",label:"normal",parent:"fontSize",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontSize",!1,"3")}},{name:"large",help:"Set's the font size to small.",label:"large",parent:"fontSize",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontSize",!1,"5")}},{name:"huge",help:"Set's the font size to huge.",label:"huge",parent:"fontSize",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontSize",!1,"7")}},{name:"fontFace",help:"Set's the font face.",label:"Font"},{name:"sansSerif",help:"Set's the font face.",parent:"fontFace",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontName",!1,"arial, sans-serif")}},{name:"serif",help:"Set's the font face.",parent:"fontFace",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontName",!1,"times new roman, serif")}},{name:"wide",help:"Set's the font face.",parent:"fontFace",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontName",!1,"arial bold, sans-serif")}},{name:"narrow",help:"Set's the font face.",parent:"fontFace",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontName",!1,"arial narrow, sans-serif")}},{name:"comicSans",help:"Set's the font face.",parent:"fontFace",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontName",!1,"comic sans, sans-serif")}},{name:"courierNew",help:"Set's the font face.",parent:"fontFace",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontName",!1,"courier new, monospace")}},{name:"garamond",help:"Set's the font face.",parent:"fontFace",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontName",!1,"garamond, sans-serif")}},{name:"georgia",help:"Set's the font face.",parent:"fontFace",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontName",!1,"georgia, sans-serif")}},{name:"tahoma",help:"Set's the font face.",parent:"fontFace",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontName",!1,"tahoma, sans-serif")}},{name:"trebuchet",help:"Set's the font face.",parent:"fontFace",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontName",!1,"trebuchet ms, sans-serif")}},{name:"verdana",help:"Set's the font face.",parent:"fontFace",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontName",!1,"verdana, sans-serif")}},{name:"removeFormatting",help:"Removes formatting from the current selection.",action:function(){this.$.contentWindow.focus(),this.document.execCommand("removeFormat")}},{name:"justification",action:function(){}},{name:"leftJustify",parent:"justification",help:"Align Left (Ctrl-Shift-W)",action:function(){this.$.contentWindow.focus(),this.document.execCommand("justifyLeft")}},{name:"centerJustify",parent:"justification",help:"Align Center (Ctrl-Shift-E)",action:function(){this.$.contentWindow.focus(),this.document.execCommand("justifyCenter")}},{name:"rightJustify",parent:"justification",help:"Align Right (Ctrl-Shift-R)",action:function(){this.$.contentWindow.focus(),this.document.execCommand("justifyRight")}},{name:"numberedList",help:"Numbered List (Ctrl-Shift-7)",action:function(){this.$.contentWindow.focus(),this.document.execCommand("insertOrderedList")}},{name:"bulletList",help:"Bulleted List (Ctrl-Shift-7)",action:function(){this.$.contentWindow.focus(),this.document.execCommand("insertUnorderedList")
}},{name:"decreaseIndentation",help:"Indent Less (Ctrl-[)",action:function(){this.$.contentWindow.focus(),this.document.execCommand("outdent")}},{name:"increaseIndentation",help:"Indent More (Ctrl-])",action:function(){this.$.contentWindow.focus(),this.document.execCommand("indent")}},{name:"blockQuote",help:"Quote (Ctrl-Shift-9)",action:function(){this.$.contentWindow.focus(),this.document.execCommand("formatBlock",!1,"<blockquote>")}}]});var ListChoiceViewRenderer={start:function(a){return'<ul id="'+a+'"/>'},choice:function(a,b,c,d,e){return'<li id="'+c+'" name="'+a+'"'+(e?' class="'+this.selectedCssClass+'"':"")+' value="'+d+'">'+b.n.toString()+"</li>"},end:function(){return"</ul>"}};FOAModel({name:"ListChoiceView",extendsModel:"View",properties:[{name:"name",type:"String",defaultValue:"field"},{name:"helpText",type:"String",defaultValue:void 0},{name:"cssClass",type:"String",defaultValue:"foamListChoiceView"},{name:"selectedCssClass",type:"String",defaultValue:"foamListChoiceViewSelected"},{name:"value",type:"Value",factory:function(){return SimpleValue.create("")}},{name:"choicesDao",type:"DAO",help:"A DAO providing choices to populate the list.",defaultValue:void 0,postSet:function(a,b){b.listen({put:EventService.merged(this.updateHTML.bind(this),500),remove:EventService.merged(this.updateHTML.bind(this),500)})}},{name:"displayNameProperty",type:"Property",help:"The property used to retrieve the display name from the DAO"},{name:"valueProperty",type:"Property",help:"The property used to retieve the value from the DAO"},{name:"renderableProperty",type:"Property",help:"The property used to query the DOA to see if the choice is renderable.",defaultValue:{f:function(){return!0}}},{name:"choices",type:"Array[StringField]",help:"Array of choices or array of { n: name, v: value } pairs.",defaultValue:[],postSet:function(){}},{name:"initialSelectionValue",type:"Value",factory:function(){return SimpleValue.create()}},{name:"renderer",help:"The renderer that renders the view.",defaultValue:ListChoiceViewRenderer}],methods:{toHTML:function(){var a=this.renderer,b=a.start(this.id)+a.end();return b},updateHTML:function(){var a=this;if(this.choicesDao){var b=[];this.choicesDao.select({put:function(c){a.renderableProperty.f(c)&&(c={n:a.displayNameProperty.f(c),v:a.valueProperty.f(c),o:c},b.push(c))}})(function(){var c=a.choices;c!=b&&(a.choices=b,a.listToHTML())})}else a.listToHTML()},listToHTML:function(){var a=[];this.helpText;for(var b=0;b<this.choices.length;b++){var c=this.choices[b],d=this.nextID(),e=this.name;try{this.on("click",this.onClick,d),this.on("mouseover",this.onMouseOver,d),this.on("mouseout",this.onMouseOut,d)}catch(f){}var g=this.prev?c.v==this.prev.get():this.value?c.v==this.value.get():c.v==this.initialSelectedValue.get();a.push(this.renderer.choice(e,c,d,b,g))}this.$.innerHTML=a.join(""),selectedAsList=this.$.getElementsByClassName(this.selectedCssClass),selectedAsList&&selectedAsList.length&&(this.selectedElement=selectedAsList[0]),View.getPrototype().initHTML.call(this)},getValue:function(){return this.value},setValue:function(a){this.value=a},initHTML:function(){this.$;Events.dynamic(function(){this.choices}.bind(this),this.listToHTML.bind(this)),this.updateHTML(),this.setValue(this.value)},indexToValue:function(a){var b=parseInt(a);return isNaN(b)?a:this.choices[b].v},evtToValue:function(a){for(var b=a.target;b.parentNode!=this.$;)b=b.parentNode;return this.indexToValue(b.getAttribute("value"))}},listeners:[{name:"onMouseOver",code:function(a){this.timer_&&window.clearTimeout(this.timer_),this.prev=void 0===this.prev?this.value.get():this.prev,this.value.set(this.evtToValue(a))}},{name:"onMouseOut",code:function(){this.timer_&&window.clearTimeout(this.timer_),this.timer_=window.setTimeout(function(){this.value.set(this.prev||""),this.prev=void 0}.bind(this),1)}},{name:"onClick",code:function(a){this.prev=this.evtToValue(a),this.value.set(this.prev),this.selectedElement&&(this.selectedElement.className=""),a.target.className="selected",this.selectedElement=a.target}}]}),FOAModel({name:"ScrollCView",extendsModel:"CView",properties:[{name:"parent",type:"CView",hidden:!0,postSet:function(a,b){var c=b&&b.$;c&&(c.addEventListener("mousedown",this.mouseDown,!1),c.addEventListener("touchstart",this.touchStart,!1))}},{name:"vertical",type:"boolean",defaultValue:!0},{name:"value",type:"int",help:"The first element being shown, starting at zero.",preSet:function(a,b){return Math.max(0,Math.min(this.size-this.extent,b))},defaultValue:0},{name:"extent",help:"Number of elements shown.",type:"int",minValue:1,defaultValue:10},{name:"size",type:"int",defaultValue:0,help:"Total number of elements being scrolled through.",postSet:function(){this.paint()}},{name:"minHandleSize",type:"int",defaultValue:10,help:"Minimum size to make the drag handle."},{name:"startY",type:"int",defaultValue:0},{name:"startValue",help:"Starting value or current drag operation.",type:"int",defaultValue:0},{name:"handleColor",type:"String",defaultValue:"rgb(107,136,173)"},{name:"borderColor",type:"String",defaultValue:"#555"}],listeners:{mouseDown:function(a){this.startY=a.y-a.offsetY,a.target.ownerDocument.defaultView.addEventListener("mouseup",this.mouseUp,!0),a.target.ownerDocument.defaultView.addEventListener("mousemove",this.mouseMove,!0),a.target.ownerDocument.defaultView.addEventListener("touchstart",this.touchstart,!0),this.mouseMove(a)},mouseUp:function(a){a.preventDefault(),a.target.ownerDocument.defaultView.removeEventListener("mousemove",this.mouseMove,!0),a.target.ownerDocument.defaultView.removeEventListener("mouseup",this.mouseUp,!0)},mouseMove:function(a){var b=a.y-this.startY;a.preventDefault(),this.value=Math.max(0,Math.min(this.size-this.extent,Math.round((b-this.y)/(this.height-4)*this.size)))},touchStart:function(a){this.startY=a.targetTouches[0].pageY,this.startValue=this.value,a.target.ownerDocument.defaultView.addEventListener("touchmove",this.touchMove,!1),this.touchMove(a)},touchEnd:function(a){a.target.ownerDocument.defaultView.removeEventListener("touchmove",this.touchMove,!1),a.target.ownerDocument.defaultView.removeEventListener("touchend",this.touchEnd,!1)},touchMove:function(a){var b=a.targetTouches[0].pageY;a.preventDefault(),this.value=Math.max(0,Math.min(this.size-this.extent,Math.round(this.startValue+(b-this.startY)/(this.height-4)*this.size)))}},methods:{paint:function(){if(this.size){var a=this.canvas;if(a&&(this.erase(),!(this.extent>=this.size))){a.strokeStyle=this.borderColor,a.strokeRect(this.x,this.y,this.width-7,this.height),a.fillStyle=this.handleColor;var b=this.height-8,c=this.extent/this.size*b;c<this.minHandleSize&&(c=this.minHandleSize,b-=this.minHandleSize-c),a.fillRect(this.x+2,this.y+2+this.value/this.size*b,this.width-11,this.y+4+c)}}},destroy:function(){}}}),FOAModel({name:"ScrollBorder",extendsModel:"View",properties:[{name:"view",type:"view",postSet:function(){this.scrollbar.extent=this.view.rows}},{name:"scrollbar",type:"ScrollCView",factory:function(){var a=ScrollCView.create({height:1800,width:20,x:0,y:0,extent:10});return this.dao&&this.dao.select(COUNT())(function(b){a.size=b.count}),a}},{name:"dao",label:"DAO",type:"DAO",hidden:!0,required:!0,postSet:function(a,b){this.view.dao=b;var c=this;this.dao&&this.dao.select(COUNT())(function(a){c.scrollbar.size=a.count,c.scrollbar.value=Math.max(0,Math.min(c.scrollbar.value,c.scrollbar.size-c.scrollbar.extent)),c.dao&&(c.view.dao=c.dao.skip(c.scrollbar.value))})}}],listeners:[{name:"layout",code:function(){this.view.layout()}}],methods:{toHTML:function(){return'<table id="'+this.id+'" width=100% height=100% border=0><tr><td valign=top>'+this.view.toHTML()+'</td><td valign=top><div class="scrollSpacer"></div>'+this.scrollbar.toHTML()+"</td></tr></table>"},initHTML:function(){window.addEventListener("resize",this.layout,!1),this.view.initHTML(),this.scrollbar.initHTML(),this.scrollbar.paint();var a=this.view,b=this.scrollbar,c=this;a.$.onmousewheel=function(a){a.wheelDeltaY>0&&b.value?b.value--:a.wheelDeltaY<0&&b.value<b.size-b.extent&&b.value++},b.addPropertyListener("value",EventService.animate(function(){c.dao&&(c.view.dao=c.dao.skip(b.value))})),Events.dynamic(function(){a.rows},function(){b.extent=a.rows}),Events.dynamic(function(){a.height},function(){b.height=Math.max(a.height-26,0)}),this.layout()}}}),Property.getPrototype().partialEval=function(){return this},Property.getPrototype().toSQL=function(){return this.name},Property.getPrototype().toMQL=function(){return this.name},Property.getPrototype().f=function(a){return a[this.name]},Property.getPrototype().compare=function(a,b){return this.compareProperty(this.f(a),this.f(b))},FOAModel({name:"Expr","package":"foam.mlang",methods:{toMQL:function(){return this.toString()},toSQL:function(){return this.toString()},collectInputs:function(a){a.push(this)},partialEval:function(){return this},minterm:function(a,b){return!!(b>>>a[0]--&1)},normalize:function(){var a=[];this.collectInputs(a);for(var b=new Array(Math.pow(2,a.length)),c=0;c<b.length;c++)b[c]=this.minterm([a.length-1],c);var d=[];for(c=0;c<b.length;c++)if(b[c]){for(var e=[],f=0;f<a.length;f++)c&1<<a.length-f-1&&e.push(a[f]);d.push(AndExpr.create({args:e}))}return OrExpr.create({args:d}).partialEval()},toString:function(){return this.label_},pipe:function(a){var b=this;return{__proto__:a,put:function(c){b.f(c)&&a.put(c)},remove:function(c){b.f(c)&&a.remove(c)}}}}});var TRUE=FOAM({model_:"Model",name:"TRUE",extendsModel:"Expr",methods:{toSQL:function(){return"( 1 = 1 )"},toMQL:function(){return""},f:function(){return!0}}}).create(),FALSE=FOAM({model_:"Model",name:"FALSE",extendsModel:"Expr",methods:{toSQL:function(){return"( 1 <> 1 )"},toMQL:function(){return"<false>"},f:function(){return!1}}}).create(),IDENTITY=FOAM({model_:"Model",name:"IDENTITY",extendsModel:"Expr",methods:{f:function(a){return a},toString:function(){return"IDENTITY"}}}).create();FOAModel({name:"NARY",extendsModel:"Expr","abstract":!0,properties:[{name:"args",label:"Arguments",type:"Expr[]",help:"Sub-expressions",factory:function(){return[]}}],methods:{toSQL:function(){var a;a=this.model_.label,a+="(";for(var b=0;b<this.args.length;b++){var c=this.args[b];a+=c.toSQL(),b<this.args.length-1&&out.push(",")}return a+=")"},toMQL:function(){var a;a=this.model_.label,a+="(";for(var b=0;b<this.args.length;b++){var c=this.args[b];a+=c.toMQL(),b<this.args.length-1&&out.push(",")}return a+=")",str}}}),FOAModel({name:"UNARY",extendsModel:"Expr","abstract":!0,properties:[{name:"arg1",label:"Argument",type:"Expr",help:"Sub-expression",defaultValue:TRUE}],methods:{toSQL:function(){return this.label_+"("+this.arg1.toSQL()+")"},toMQL:function(){return this.label_+"("+this.arg1.toMQL()+")"}}}),FOAModel({name:"BINARY",extendsModel:"UNARY","abstract":!0,properties:[{name:"arg2",label:"Argument",type:"Expr",help:"Sub-expression",defaultValue:TRUE}],methods:{toSQL:function(){return this.arg1.toSQL()+" "+this.label_+" "+this.arg2.toSQL()},toMQL:function(){return this.arg1.toMQL()+" "+this.label_+" "+this.arg2.toMQL()}}}),FOAModel({name:"AndExpr",extendsModel:"NARY","abstract":!0,methods:{toSQL:function(){for(var a="",b=0;b<this.args.length;b++){var c=this.args[b];a+=c.toSQL(),b<this.args.length-1&&(a+=" AND ")}return a},toMQL:function(){for(var a="",b=0;b<this.args.length;b++){var c=this.args[b],d=c.toMQL();OrExpr.isInstance(c)&&(d="("+d+")"),a+=d,b<this.args.length-1&&(a+=" ")}return a},collectInputs:function(a){for(var b=0;b<this.args.length;b++)this.args[b].collectInputs(a)},minterm:function(a,b){for(var c=!0,d=0;d<this.args.length;d++)c=this.args[d].minterm(a,b)&&c;return c},partialEval:function(){for(var a=[],b=!1,c=0;c<this.args.length;c++){var d=this.args[c],e=this.args[c].partialEval();if(e===FALSE)return FALSE;if(AndExpr.isInstance(e)){for(var f=0;f<e.args.length;f++)a.push(e.args[f]);b=!0}else e===TRUE?b=!0:(a.push(e),d!==e&&(b=!0))}return 0==a.length?TRUE:1==a.length?a[0]:b?AndExpr.create({args:a}):this},f:function(a){return this.args.every(function(b){return b.f(a)})}}}),FOAModel({name:"OrExpr",extendsModel:"NARY","abstract":!0,methods:{toSQL:function(){var a;a="(";for(var b=0;b<this.args.length;b++){var c=this.args[b];a+=c.toSQL(),b<this.args.length-1&&(a+=" OR ")}return a+=")"},toMQL:function(){for(var a="",b=0;b<this.args.length;b++){var c=this.args[b];a+=c.toMQL(),b<this.args.length-1&&(a+=" OR ")}return a},collectInputs:function(a){for(var b=0;b<this.args.length;b++)this.args[b].collectInputs(a)},minterm:function(a,b){for(var c=!1,d=0;d<this.args.length;d++)c=this.args[d].minterm(a,b)||c;return c},partialEval:function(){for(var a=[],b=!1,c=0;c<this.args.length;c++){var d=this.args[c],e=this.args[c].partialEval();if(e===TRUE)return TRUE;if(OrExpr.isInstance(e)){for(var f=0;f<e.args.length;f++)a.push(e.args[f]);b=!0}else e!==FALSE&&a.push(e),d!==e&&(b=!0)}return 0==a.length?FALSE:1==a.length?a[0]:b?OrExpr.create({args:a}):this},f:function(a){return this.args.some(function(b){return b.f(a)})}}}),FOAModel({name:"NotExpr",extendsModel:"UNARY","abstract":!0,methods:{toSQL:function(){return"not ( "+this.arg1.toSQL()+" )"},toMQL:function(){return"-( "+this.arg1.toMQL()+" )"},collectInputs:function(a){this.arg1.collectInputs(a)},minterm:function(a,b){return!this.arg1.minterm(a,b)},partialEval:function(){var a=this.arg1.partialEval();return a===TRUE?FALSE:a===FALSE?TRUE:NotExpr.isInstance(a)?a.arg1:EqExpr.isInstance(a)?NeqExpr.create(a):NeqExpr.isInstance(a)?EqExpr.create(a):LtExpr.isInstance(a)?GteExpr.create(a):GtExpr.isInstance(a)?LteExpr.create(a):LteExpr.isInstance(a)?GtExpr.create(a):GteExpr.isInstance(a)?LtExpr.create(a):this.arg1===a?this:NOT(a)},f:function(a){return!this.arg1.f(a)}}}),FOAModel({name:"DescribeExpr",extendsModel:"UNARY",properties:[{name:"plan",help:"Execution Plan",defaultValue:""}],methods:{toString:function(){return this.plan},toSQL:function(){return this.arg1.toSQL()},toMQL:function(){return this.arg1.toMQL()},partialEval:function(){var a=this.arg1.partialEval();return this.arg1===a?this:EXPLAIN(a)},f:function(a){return this.arg1.f(a)}}}),FOAModel({name:"EqExpr",extendsModel:"BINARY","abstract":!0,methods:{toSQL:function(){return this.arg1.toSQL()+"="+this.arg2.toSQL()},toMQL:function(){return this.arg2===TRUE?"is:"+this.arg1.toMQL():this.arg1.toMQL()+"="+this.arg2.toMQL()},partialEval:function(){var a=this.arg1.partialEval(),b=this.arg2.partialEval();return ConstantExpr.isInstance(a)&&ConstantExpr.isInstance(b)?compile_(a.f()==b.f()):this.arg1!==a||this.arg2!==b?EqExpr.create({arg1:a,arg2:b}):this},f:function(a){var b=this.arg1.f(a),c=this.arg2.f(a);return Array.isArray(b)?b.some(function(a){return a==c}):c===TRUE?!!b:c===FALSE?!b:b==c}}}),FOAModel({name:"InExpr",extendsModel:"BINARY",properties:[{name:"arg2",label:"Argument",type:"Expr",help:"Sub-expression",postSet:function(){this.valueSet_=void 0}}],methods:{valueSet:function(){if(!this.valueSet_){for(var a={},b=0;b<this.arg2.length;b++)a[this.arg2[b]]=!0;this.valueSet_=a}return this.valueSet_},toSQL:function(){return this.arg1.toSQL()+" IN "+this.arg2},toMQL:function(){return this.arg1.toMQL()+"="+this.arg2.join(",")},f:function(a){return this.valueSet().hasOwnProperty(this.arg1.f(a))}}}),FOAModel({name:"ContainsExpr",extendsModel:"BINARY",methods:{toSQL:function(){return this.arg1.toSQL()+" like '%' + "+this.arg2.toSQL()+"+ '%'"},toMQL:function(){return this.arg1.toMQL()+":"+this.arg2.toMQL()},partialEval:function(){var a=this.arg1.partialEval(),b=this.arg2.partialEval();return ConstantExpr.isInstance(a)&&ConstantExpr.isInstance(b)?compile_(-1!=a.f().indexOf(b.f())):this.arg1!==a||this.arg2!=b?ContainsExpr.create({arg1:a,arg2:b}):this},f:function(a){var b=this.arg1.f(a),c=this.arg2.f(a);return Array.isArray(b)?b.some(function(a){return-1!=a.indexOf(c)}):-1!=b.indexOf(c)}}}),FOAModel({name:"ContainsICExpr",extendsModel:"BINARY",properties:[{name:"arg2",label:"Argument",type:"Expr",help:"Sub-expression",defaultValue:TRUE,postSet:function(a,b){this.pattern_=new RegExp(b.f().toString().replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"i")}}],methods:{toSQL:function(){return this.arg1.toSQL()+" like '%' + "+this.arg2.toSQL()+"+ '%'"},toMQL:function(){return this.arg1.toMQL()+":"+this.arg2.toMQL()},partialEval:function(){var a=this.arg1.partialEval(),b=this.arg2.partialEval();return ConstantExpr.isInstance(a)&&ConstantExpr.isInstance(b)?compile_(-1!=a.f().toLowerCase().indexOf(b.f())):this.arg1!==a||this.arg2!=b?ContainsICExpr.create({arg1:a,arg2:b}):this},f:function(a){var b=this.arg1.f(a);if(Array.isArray(b)){var c=this.pattern_;return b.some(function(a){return c.test(a)})}return this.pattern_.test(b)}}}),FOAModel({name:"NeqExpr",extendsModel:"BINARY","abstract":!0,methods:{toSQL:function(){return this.arg1.toSQL()+"<>"+this.arg2.toSQL()},toMQL:function(){return"-"+this.arg1.toMQL()+"="+this.arg2.toMQL()},partialEval:function(){var a=this.arg1.partialEval(),b=this.arg2.partialEval();return ConstantExpr.isInstance(a)&&ConstantExpr.isInstance(b)?compile_(a.f()!=b.f()):this.arg1!==a||this.arg2!=b?NeqExpr.create({arg1:a,arg2:b}):this},f:function(a){return this.arg1.f(a)!=this.arg2.f(a)}}}),FOAModel({name:"LtExpr",extendsModel:"BINARY","abstract":!0,methods:{toSQL:function(){return this.arg1.toSQL()+"<"+this.arg2.toSQL()},toMQL:function(){return this.arg1.toMQL()+"-before:"+this.arg2.toMQL()},partialEval:function(){var a=this.arg1.partialEval(),b=this.arg2.partialEval();return ConstantExpr.isInstance(a)&&ConstantExpr.isInstance(b)?compile_(a.f()<b.f()):this.arg1!==a||this.arg2!=b?LtExpr.create({arg1:a,arg2:b}):this},f:function(a){return this.arg1.f(a)<this.arg2.f(a)}}}),FOAModel({name:"GtExpr",extendsModel:"BINARY","abstract":!0,methods:{toSQL:function(){return this.arg1.toSQL()+">"+this.arg2.toSQL()},toMQL:function(){return this.arg1.toMQL()+"-after:"+this.arg2.toMQL()},partialEval:function(){var a=this.arg1.partialEval(),b=this.arg2.partialEval();return ConstantExpr.isInstance(a)&&ConstantExpr.isInstance(b)?compile_(a.f()>b.f()):this.arg1!==a||this.arg2!=b?GtExpr.create({arg1:a,arg2:b}):this},f:function(a){return this.arg1.f(a)>this.arg2.f(a)}}}),FOAModel({name:"LteExpr",extendsModel:"BINARY","abstract":!0,methods:{toSQL:function(){return this.arg1.toSQL()+"<="+this.arg2.toSQL()},toMQL:function(){return this.arg1.toMQL()+"-before:"+this.arg2.toMQL()},partialEval:function(){var a=this.arg1.partialEval(),b=this.arg2.partialEval();return ConstantExpr.isInstance(a)&&ConstantExpr.isInstance(b)?compile_(a.f()<=b.f()):this.arg1!==a||this.arg2!=b?LtExpr.create({arg1:a,arg2:b}):this},f:function(a){return this.arg1.f(a)<=this.arg2.f(a)}}}),FOAModel({name:"GteExpr",extendsModel:"BINARY","abstract":!0,methods:{toSQL:function(){return this.arg1.toSQL()+">="+this.arg2.toSQL()},toMQL:function(){return this.arg1.toMQL()+"-after:"+this.arg2.toMQL()},partialEval:function(){var a=this.arg1.partialEval(),b=this.arg2.partialEval();return ConstantExpr.isInstance(a)&&ConstantExpr.isInstance(b)?compile_(a.f()>=b.f()):this.arg1!==a||this.arg2!=b?GtExpr.create({arg1:a,arg2:b}):this},f:function(a){return this.arg1.f(a)>=this.arg2.f(a)}}}),FOAModel({name:"StartsWithExpr",extendsModel:"BINARY",methods:{toSQL:function(){return this.arg1.toSQL()+" like '%' + "+this.arg2.toSQL()+"+ '%'"},toMQL:function(){return this.arg1.toMQL()+"-after:"+this.arg2.toMQL()},partialEval:function(){var a=this.arg1.partialEval(),b=this.arg2.partialEval();return ConstantExpr.isInstance(a)&&ConstantExpr.isInstance(b)?compile_(a.f().startsWith(b.f())):this.arg1!==a||this.arg2!=b?StartsWithExpr.create({arg1:a,arg2:b}):this},f:function(a){return this.arg1.f(a).startsWith(this.arg2.f(a))}}}),FOAModel({name:"ConstantExpr",extendsModel:"UNARY",methods:{escapeSQLString:function(a){return"'"+a.replace(/\\/g,"\\\\").replace(/'/g,"\\'")+"'"},escapeMQLString:function(a){return a.length>0&&-1==a.indexOf(" ")&&-1==a.indexOf('"')&&-1==a.indexOf(",")?a:'"'+a.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'},toSQL:function(){return"string"==typeof this.arg1?this.escapeSQLString(this.arg1):this.arg1.toString()},toMQL:function(){return"string"==typeof this.arg1?this.escapeMQLString(this.arg1):this.arg1.toMQL?this.arg1.toMQL():this.arg1.toString()},f:function(){return this.arg1}}}),FOAModel({name:"ConcatExpr",extendsModel:"NARY",label:"concat",methods:{partialEval:function(){return this},f:function(a){for(var b=[],c=0;c<this.args.length;c++)b.push(this.args[c].f(a));return b.join("")}}}),FOAModel({name:"SumExpr",extendsModel:"UNARY",properties:[{name:"sum",type:"int",help:"Sum of values.",factory:function(){return 0}}],methods:{pipe:function(a){a.put(this)},put:function(a){this.instance_.sum+=this.arg1.f(a)},remove:function(a){this.sum-=this.arg1.f(a)},toString:function(){return this.sum}}}),FOAModel({name:"AvgExpr",extendsModel:"UNARY",properties:[{name:"count",type:"int",defaultValue:0},{name:"sum",type:"int",help:"Sum of values.",defaultValue:0},{name:"avg",type:"floag",help:"Average of values.",getter:function(){return this.sum/this.count}}],methods:{pipe:function(a){a.put(this)},put:function(a){this.count++,this.sum+=this.arg1.f(a)},remove:function(a){this.count--,this.sum-=this.arg1.f(a)},toString:function(){return this.avg}}}),FOAModel({name:"MaxExpr",extendsModel:"UNARY",properties:[{name:"max",type:"int",help:"Maximum value.",defaultValue:void 0}],methods:{reduce:function(a){return MaxExpr.create({max:Math.max(this.max,a.max)})},reduceI:function(a){this.max=Math.max(this.max,a.max)},pipe:function(a){a.put(this)},put:function(a){var b=this.arg1.f(a);this.max=void 0===this.max?b:Math.max(this.max,b)},remove:function(){},toString:function(){return this.max}}}),FOAModel({name:"MinExpr",extendsModel:"UNARY",properties:[{name:"min",type:"int",help:"Minimum value.",defaultValue:void 0}],methods:{reduce:function(a){return MinExpr.create({max:Math.min(this.min,a.min)})},reduceI:function(a){this.min=Math.min(this.min,a.min)},pipe:function(a){a.put(this)},put:function(a){var b=this.arg1.f(a);this.min=void 0===this.min?b:Math.min(this.min,b)},remove:function(){},toString:function(){return this.min}}}),FOAModel({name:"DistinctExpr",extendsModel:"BINARY",properties:[{name:"values",help:"Distinct values.",factory:function(){return{}}}],methods:{reduce:function(){},reduceI:function(){},put:function(a){var b=this.arg1.f(a);this.values.hasOwnProperty(b)||(this.values[b]=!0,this.arg2.put(a))},remove:function(){},toString:function(){return this.arg2.toString()},toHTML:function(){return this.arg2.toHTML()}}}),FOAModel({name:"GroupByExpr",extendsModel:"BINARY",properties:[{name:"groups",type:"Map[Expr]",help:"Groups.",factory:function(){return{}}}],methods:{reduce:function(){},reduceI:function(a){for(var b in a.groups)this.groups[b]?this.groups[b].reduceI(a.groups[b]):this.groups[b]=a.groups[b].deepClone()},pipe:function(a){for(key in this.groups)a.push([key,this.groups[key].toString()]);return a},put:function(a){var b=this.arg1.f(a);if(Array.isArray(b)){for(var c=0;c<b.length;c++){var d=this.groups.hasOwnProperty(b[c])&&this.groups[b[c]];d||(d=this.arg2.clone(),this.groups[b[c]]=d),d.put(a)}if(0==b.length){var d=this.groups.hasOwnProperty("")&&this.groups[""];d||(d=this.arg2.clone(),this.groups[""]=d),d.put(a)}}else{var d=this.groups.hasOwnProperty(b)&&this.groups[b];d||(d=this.arg2.clone(),this.groups[b]=d),d.put(a)}},clone:function(){return GroupByExpr.create({arg1:this.arg1,arg2:this.arg2})},remove:function(){},toString:function(){return this.groups},deepClone:function(){var a=this.clone();a.groups={};for(var b in this.groups)a.groups[b]=this.groups[b].deepClone();return a},toHTML:function(){var a=[];a.push("<table border=1>");for(var b in this.groups){var c=this.groups[b],d=c.toHTML?c.toHTML():c;a.push("<tr><th>",b,"</th><td>",d,"</td></tr>")}return a.push("</table>"),a.join("")},initHTML:function(){for(var a in this.groups){var b=this.groups[a];b.initHTML&&b.initHTML()}}}}),FOAModel({name:"GridByExpr",extendsModel:"Expr",properties:[{name:"xFunc",label:"X-Axis Function",type:"Expr",help:"Sub-expression",defaultValue:TRUE},{name:"yFunc",label:"Y-Axis Function",type:"Expr",help:"Sub-expression",defaultValue:TRUE},{name:"acc",label:"Accumulator",type:"Expr",help:"Sub-expression",defaultValue:TRUE},{name:"rows",type:"Map[Expr]",help:"Rows.",factory:function(){return{}}},{name:"cols",label:"Columns",type:"Map[Expr]",help:"Columns.",factory:function(){return{}}},{model_:"ArrayProperty",name:"children"}],methods:{init:function(){this.SUPER();var a=this,b=function(){a.cols=GROUP_BY(a.xFunc,COUNT()),a.rows=GROUP_BY(a.yFunc,GROUP_BY(a.xFunc,a.acc))};a.addPropertyListener("xFunc",b),a.addPropertyListener("yFunc",b),a.addPropertyListener("acc",b),b()},reduce:function(){},reduceI:function(){},pipe:function(){},put:function(a){this.rows.put(a),this.cols.put(a)},clone:function(){return this.model_.create({xFunc:this.xFunc,yFunc:this.yFunc,acc:this.acc})},remove:function(){},toString:function(){return this.groups},deepClone:function(){},renderCell:function(a,b,c){var d=c?c.toHTML?c.toHTML():c:"";return c&&c.toHTML&&c.initHTML&&this.children.push(c),"<td>"+d+"</td>"},sortAxis:function(a,b){return a.sort(b.compareProperty)},sortCols:function(a,b){return this.sortAxis(a,b)},sortRows:function(a,b){return this.sortAxis(a,b)},sortedCols:function(){return this.sortCols(Object.getOwnPropertyNames(this.cols.groups),this.xFunc)},sortedRows:function(){return this.sortRows(Object.getOwnPropertyNames(this.rows.groups),this.yFunc)},toHTML:function(){var a;this.children=[];var b=(this.cols.groups,this.rows.groups),c=this.sortedCols(),d=this.sortedRows();a='<table border=0 cellspacing=0 class="gridBy"><tr><th></th>';for(var e=0;e<c.length;e++){var f=c[e],g=f.toHTML?f.toHTML():f;a+="<th>"+g+"</th>"}a+="</tr>";for(var h=0;h<d.length;h++){var i=d[h];a+="<tr><th>"+i+"</th>";for(var e=0;e<c.length;e++){var f=c[e],j=b[i].groups[f];a+=this.renderCell(f,i,j)}a+="</tr>"}return a+="</table>"},initHTML:function(){for(var a=0;a<this.children.length;a++)this.children[a].initHTML();this.children=[]}}}),FOAModel({name:"MapExpr",extendsModel:"BINARY",methods:{reduce:function(){},reduceI:function(){},pipe:function(){},put:function(a){var b=this.arg1.f?this.arg1.f(a):this.arg1(a),c=this.arg2;c.put(b)},clone:function(){return MapExpr.create({arg1:this.arg1,arg2:this.arg2.clone()})},remove:function(){},toString:function(){return this.arg2.toString()},deepClone:function(){},toHTML:function(){return this.arg2.toHTML?this.arg2.toHTML():this.toString()},initHTML:function(){this.arg2.initHTML&&this.arg2.initHTML()}}}),FOAModel({name:"CountExpr",extendsModel:"Expr",properties:[{name:"count",type:"int",defaultValue:0}],methods:{reduce:function(a){return CountExpr.create({count:this.count+a.count})},reduceI:function(a){this.count=this.count+a.count},pipe:function(a){a.put(this)},put:function(){this.count++},remove:function(){this.count--},toString:function(){return this.count}}}),FOAModel({name:"SeqExpr",extendsModel:"NARY",methods:{pipe:function(a){a.put(this)},put:function(a){for(var b=0;b<this.args.length;b++){var c=this.args[b];c.put(a)}},f:function(a){for(var b=[],c=0;c<this.args.length;c++){var d=this.args[c];b.push(d.f(a))}return b},clone:function(){return SeqExpr.create({args:this.args.clone()})},toString:function(){var a=[];a.push("(");for(var b=0;b<this.args.length;b++){var c=this.args[b];a.push(c.toString()),b<this.args.length-1&&a.push(",")}return a.push(")"),a.join("")},toHTML:function(){for(var a=[],b=0;b<this.args.length;b++){var c=this.args[b];a.push(c.toHTML?c.toHTML():c.toString()),b<this.args.length-1&&a.push("&nbsp;")}return a.join("")}}}),FOAModel({name:"UpdateExpr",extendsModel:"NARY",label:"UpdateExpr",properties:[{name:"dao",type:"DAO","transient":!0,hidden:!0}],methods:{put:function(a){(this.objs_||(this.objs_=[])).push(a)},eof:function(){for(var a=0;a<this.objs_.length;a++){var b=this.objs_[a],c=this.f(b);c.id!==b.id&&this.dao.remove(b.id),this.dao.put(c)}this.objs_=void 0},f:function(a){for(var b=a.clone(),c=0;c<this.args.length;c++)this.args[c].f(b);return b},reduce:function(a){return UpdateExpr.create({args:this.args.concat(a.args),dao:this.dao})},reduceI:function(a){this.args=this.args.concat(a.args)},toString:function(){return this.toSQL()},toSQL:function(){for(var a="SET ",b=0;b<this.args.length;b++){var c=this.args[b];a+=c.toSQL(),b<this.args.length-1&&(a+=", ")}return a}}}),FOAModel({name:"SetExpr",label:"SetExpr",extendsModel:"BINARY",methods:{toSQL:function(){return this.arg1.toSQL()+" = "+this.arg2.toSQL()},f:function(a){Property.isInstance(this.arg1)&&(a[this.arg1.name]=this.arg2.f(a))}}}),FOAModel({name:"ExpandableGroupByExpr",extendsModel:"BINARY",properties:[{name:"groups",type:"Map[Expr]",help:"Groups.",factory:function(){return{}}},{name:"expanded",type:"Map",help:"Expanded.",factory:function(){return{}}},{name:"values",type:"Object",help:"Values",factory:function(){return[]}}],methods:{reduce:function(){},reduceI:function(){},select:function(a,b){var c=this;return this.values.select({put:function(b){a.put(b);var d=(c.arg1.f(b),b.children);if(d)for(var e=0;e<d.length;e++)a.put(d[e])}},b),aconstant(a)},putKeyValue_:function(a,b){var c=this.groups.hasOwnProperty(a)&&this.groups[a];c?c.count++:(c=b.clone(),this.expanded[a]&&(c.children=[]),this.groups[a]=c,c.count=1,this.values.push(c)),c.children&&c.children.push(obj)},put:function(a){var b=this.arg1.f(a);if(Array.isArray(b))for(var c=0;c<b.length;c++)this.putKeyValue_(b[c],a);else this.putKeyValue_(b,a)},where:function(a){return filteredDAO(a,this)},limit:function(a){return limitedDAO(a,this)},skip:function(a){return skipDAO(a,this)},orderBy:function(){return orderedDAO(1==arguments.length?arguments[0]:argsToArray(arguments),this)},listen:function(){},unlisten:function(){},remove:function(){},toString:function(){return this.groups},deepClone:function(){return this}}}),FOAModel({name:"TreeExpr",extendsModel:"Expr",properties:[{name:"parentProperty"},{name:"childrenProperty"},{name:"items_",help:"Temporary map to store collected objects.",factory:function(){return{}},"transient":!0},{model_:"ArrayProperty",name:"roots"}],methods:{put:function(a){this.items_[a.id]=a,this.parentProperty.f(a)||this.roots.push(a)},eof:function(){var a=this.parentProperty,b=this.childrenProperty;for(var c in this.items_){var d=this.items_[c],e=a.f(d);if(e){var f=this.items_[e];f[b.name]=b.f(f).concat(d)}}this.items_={}}}}),FOAModel({name:"DescExpr",extendsModel:"UNARY",methods:{toMQL:function(){return"-"+this.arg1.toMQL()},compare:function(a,b){return-1*this.arg1.compare(a,b)}}}),FOAModel({name:"AddExpr",extendsModel:"BINARY",methods:{toSQL:function(){return this.arg1.toSQL()+" + "+this.arg2.toSQL()},f:function(a){return this.arg1.f(a)+this.arg2.f(a)}}});var JOIN=function(a,b,c){return{f:function(d){var e=c.clone();return a.where(EQ(b,d.id)).select(e),[d,e]}}},MONTH=function(a){return{f:function(b){return a.f(b).getMonth()}}},ME="",QueryParserFactory=function(a){for(var b={__proto__:grammar,START:sym("query"),query:sym("or"),or:repeat(sym("and"),literal_ic(" OR "),1),and:repeat(sym("expr"),alt(literal_ic("AND "),not(literal_ic(" OR")," ")),1),expr:alt(sym("negate"),sym("has"),sym("is"),sym("equals"),sym("before"),sym("after"),sym("id")),paren:seq1(1,"(",sym("query"),")"),negate:seq("-",sym("expr")),id:sym("number"),has:seq(literal_ic("has:"),sym("fieldname")),is:seq(literal_ic("is:"),sym("fieldname")),equals:seq(sym("fieldname"),alt(":","="),sym("valueList")),before:seq(sym("fieldname"),alt("<","-before:"),sym("value")),after:seq(sym("fieldname"),alt(">","-after:"),sym("value")),value:alt(sym("me"),sym("date"),sym("string"),sym("number")),valueList:repeat(sym("value"),",",1),me:seq(literal_ic("me"),lookahead(not(sym("char")))),date:alt(sym("literal date"),sym("relative date")),"literal date":seq(sym("number"),"/",sym("number"),"/",sym("number")),"relative date":seq(literal_ic("today"),optional(seq("-",sym("number")))),string:alt(sym("word"),sym("quoted string")),"quoted string":str(seq1(1,'"',repeat(alt(literal('\\"','"'),notChar('"'))),'"')),word:str(plus(sym("char"))),"char":alt(range("a","z"),range("A","Z"),range("0","9"),"-","^","_","@","%","."),number:str(plus(range("0","9")))},c=[],d=0;d<a.properties.length;d++){var e=a.properties[d];
c.push(literal_ic(e.name,e))}for(var d=0;d<a.properties.length;d++)for(var e=a.properties[d],f=0;f<e.aliases.length;f++)e.aliases[f]&&c.push(literal_ic(e.aliases[f],e));for(var d=0;d<a.properties.length;d++){var e=a.properties[d];e.shortName&&c.push(literal_ic(e.shortName,e))}return c.sort(function(a,b){var c=a.length-b.length;return 0!==c?c:a==b?0:b>a?1:-1}),b.fieldname=alt.apply(null,c),b.addActions({id:function(b){return EQ(a.ID,b)},or:function(a){return OR.apply(OR,a)},and:function(a){return AND.apply(AND,a)},negate:function(a){return NOT(a[1])},number:function(a){return parseInt(a)},me:function(){return this.ME||ME},has:function(a){return NEQ(a[1],"")},is:function(a){return EQ(a[1],TRUE)},before:function(a){return LT(a[0],a[2])},after:function(a){return GT(a[0],a[2])},equals:function(a){if("="===a[1])return IN(a[0],a[2]);for(var b=OR(),c=a[2],d=0;d<c.length;d++)b.args.push(":"!=a[1]||"String"!==a[0].type&&"String"!==a[0].subType?EQ(a[0],c[d]):CONTAINS_IC(a[0],c[d]));return b},"literal date":function(a){return new Date(a[0],a[2]-1,a[4])},"relative date":function(a){var b=new Date;return a[1]&&b.setDate(b.getDate()-a[1][1]),b}}),b};FOAModel({name:"GroupBySearchView",extendsModel:"View",label:"GroupBy Search View",properties:[{name:"view",type:"view",factory:function(){return ChoiceView.create({size:this.size,cssClass:"foamSearchChoiceView"})}},{name:"width",type:"int",defaultValue:47},{name:"size",type:"int",defaultValue:17},{name:"dao",label:"DAO",type:"DAO",required:!0,postSet:function(){this.view.id&&this.updateDAO()}},{name:"property",type:"Property"},{name:"filter",type:"Object",defaultValue:TRUE},{name:"predicate",type:"Object",defaultValue:TRUE},{name:"label",type:"String",defaultValueFn:function(){return this.property.label}}],methods:{toHTML:function(){return'<div class="foamSearchView"><div class="foamSearchViewLabel">'+this.label+"</div>"+this.view.toHTML()+"</div>"},initHTML:function(){this.view.initHTML(),Events.dynamic(function(){this.dao},this.updateDAO),this.propertyValue("filter").addListener(this.updateDAO),this.view.data$.addListener(this.updateChoice)}},listeners:[{name:"updateDAO",code:function(){var a=this;this.dao.where(this.filter).select(GROUP_BY(this.property,COUNT()))(function(b){var c=[];for(var d in b.groups){var e=("("+b.groups[d]+")").intern(),f=d.substring(0,a.width-e.length-3),g=f.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");c.push([d,g+Array(a.width-f.length-e.length).join("&nbsp;").intern()+e])}c.sort(),c.splice(0,0,["","-- CLEAR SELECTION --"]),a.view.choices=c})}},{name:"updateChoice",code:function(a,a,a,b){this.predicate=b?EQ(this.property,b):TRUE}}]}),FOAModel({name:"TextSearchView",extendsModel:"View",properties:[{name:"width",type:"int",defaultValue:47},{name:"property",type:"Property"},{name:"predicate",type:"Object",defaultValue:TRUE},{name:"view",type:"view",factory:function(){return TextFieldView.create({displayWidth:this.width,cssClass:"foamSearchTextField"})}},{name:"label",type:"String",defaultValueFn:function(){return this.property.label}}],methods:{toHTML:function(){return'<div class="foamSearchView"><div class="foamSearchViewLabel">'+this.label+"</div>"+this.view.toHTML()+"</div><div id="+this.on("click",this.clear)+' style="text-align:right;width:100%;float:right;margin-bottom:20px;" class="searchTitle"><font size=-1><u>Clear</u></font></div>'},initHTML:function(){this.SUPER(),this.view.initHTML(),this.view.data$.addListener(this.updateValue)}},listeners:[{name:"updateValue",code:function(){var a=this.view.data;return a?void(this.predicate=CONTAINS_IC(this.property,a)):void(this.predicate=TRUE)}},{name:"clear",code:function(){console.log("**************************** clear"),this.view.getValue().set(""),this.predicate=TRUE}}]}),FOAModel({name:"SearchView",extendsModel:"View",properties:[{name:"dao"},{name:"model"},{name:"predicate",type:"Object",defaultValue:TRUE}],methods:{buildSubViews:function(){for(var a=this.model.searchProperties,b=0;b<a.length;b++){var c=GroupBySearchView.create({dao:this.dao,property:this.model[a[b].constantize()]});this.addChild(c),c.addPropertyListener("predicate",this.updatePredicate)}},toInnerHTML:function(){this.children.length||this.buildSubViews();for(var a="",b=0;b<this.children.length;b++)a+=this.children[b].toHTML();return a}},listeners:[{name:"updatePredicate",code:function(){for(var a=TRUE,b=0;b<this.children.length;b++){var c=this.children[b];c.predicate&&(a=AND(a,c.predicate))}this.predicate=a.partialEval()}}]}),FOAModel({name:"SearchBorder",properties:[{name:"dao"},{name:"model"},{name:"view",factory:function(){return SearchView.create({dao:this.dao,model:this.model})}}],methods:{decorateObject:function(a){this.view.addPropertyListener("predicate",function(b,c,c,d){a.dao=b.dao.where(d)})},toHTML:function(a,b){return this.addChild(a.view),a.view.toHTML()+b()}}}),Function.prototype.abind=function(a){return function(b){this.apply(a,arguments),b()}.bind(this)};var atime=function(){var a=1,b={};return function(c,d,e,f){return function(g){var h=c;b[c]?(h+="-"+a++,b[c]++):b[c]=1;var i=performance.now();f&&f(h),e||console.time(h);for(var j=arguments,k=[function(){b[c]--;var a=performance.now();e?e(h,a-i):console.timeEnd(h),g&&g.apply(this,[].shift.call(j))}],l=1;l<j.length;l++)k[l]=j[l];d.apply(this,k)}}}(),ametric=atime,ayield=asleep.bind(null,0);Function.prototype.ao=function(a){var b=this;return function(c){var d=argsToArray(arguments);d[0]=b.bind(this,c),a.apply(this,d)}},Function.prototype.aseq=function(a){return a.ao(this)};var atramp=function(){var a=!1,b=[];return function(c){return function(){if(b.push([c,arguments]),!a){b.length>1,a=!0;for(var d;null!=(d=b.pop());)d[0].apply(this,d[1]);a=!1}}}}(),__JSONP_CALLBACKS__={},wrapJsonpCallback=function(){var a=0;return function(b,c){var d="c"+a++;c&&(d+=Math.floor(16777215*Math.random()).toString(16));var e=__JSONP_CALLBACKS__[d]=function(a){delete __JSONP_CALLBACKS__[d],b&&b.call(this,a)};return e.id=d,e}}(),ajsonp=function(a,b){return function(c){var d=wrapJsonpCallback(c),e=document.createElement("script");e.src=a+"?callback=__JSONP_CALLBACKS__."+d.id+(b?"&"+b.join("&"):""),e.onload=function(){document.body.removeChild(this)},document.body.appendChild(e)}},OAM={time:function(a,b){return function(){console.time(a);var c=b.apply(this,arguments);return console.timeEnd(a),c}},profile:function(a){return function(){console.profile();var b=a.apply(this,arguments);return console.profileEnd(),b}}},Visitor={create:function(){return{__proto__:this,stack:[]}},push:function(a){this.stack.push(a)},pop:function(){return this.stack.pop()},top:function(){return this.stack.length&&this.stack[this.stack.length-1]},visit:function(a){return Array.isArray(a)?this.visitArray(a):"string"==typeof a?this.visitString(a):"number"==typeof a?this.visitNumber(a):a instanceof Function?this.visitFunction(a):a instanceof Date?this.visitDate(a):a===!0?this.visitTrue():a===!1?this.visitFalse():null===a?this.visitNull():a instanceof Object?a.model_?this.visitObject(a):this.visitMap(a):this.visitUndefined()},visitArray:function(a){for(var b=a.length,c=0;b>c;c++)this.visitArrayElement(a,c);return a},visitArrayElement:function(a,b){this.visit(a[b])},visitString:function(a){return a},visitFunction:function(a){return a},visitNumber:function(a){return a},visitDate:function(a){return a},visitObject:function(a){for(var b in a.model_.properties){var c=a.model_.properties[b];c.name in a.instance_&&this.visitProperty(a,c)}return a},visitProperty:function(a,b){this.visit(a[b.name])},visitMap:function(a){for(var b in a)this.visitMapElement(b,a[b]);return a},visitMapElement:function(){},visitTrue:function(){return!0},visitFalse:function(){return!1},visitNull:function(){return null},visitUndefined:function(){return void 0}};FOAModel({model_:"Interface","package":"dao",name:"FlowControl",description:"DAO FLow Control.  Used to control select() behavior.",methods:[{name:"stop"},{name:"error",args:[{name:"e",type:"Object"}]},{name:"isStopped",description:"Returns true iff this selection has been stopped.",returnType:"Boolean"},{name:"getError",description:"Returns error passed to error(), or undefined if error() never called",returnType:"Object"}]}),FOAModel({model_:"Interface","package":"dao",name:"Sink",description:"Data Sink",methods:[{name:"put",description:"Put (add) an object to the Sink.",args:[{name:"obj",type:"Object"},{name:"sink",type:"Sink"}]},{name:"remove",description:"Remove a single object.",args:[{name:"obj",type:"Object"},{name:"sink",type:"Sink"}]},{name:"error",description:"Report an error.",args:[{name:"obj",type:"Object"}]},{name:"eof",description:"Indicate that no more operations will be performed on the Sink."}]}),FOAModel({model_:"Interface",name:"Predicate",description:"A boolean Predicate.",methods:[{name:"f",description:"Find a single object, using either a Predicate or the primary-key.",returnType:"Boolean",args:[{name:"o",description:"The object to be predicated."}]}]}),FOAModel({model_:"Interface",name:"Comparator",description:"A strategy for comparing pairs of Objects.",methods:[{name:"compare",description:"Compare two objects, returning 0 if they are equal, > 0 if the first is larger, and < 0 if the second is.",returnType:"Int",args:[{name:"o1",description:"The first object to be compared."},{name:"o2",description:"The second object to be compared."}]}]}),FOAModel({model_:"Interface","package":"dao",name:"DAO",description:"Data Access Object","extends":["Sink"],methods:[{name:"find",description:"Find a single object, using either a Predicate or the primary-key.",args:[{name:"key",type:"Predicate|Object"},{name:"sink",type:"Sink"}]},{name:"removeAll",description:"Remove all (scoped) objects.",args:[{name:"sink",type:"Sink"},{name:"options",type:"Object",optional:!0}]},{name:"select",description:"Select all (scoped) objects.",args:[{name:"sink",type:"SinkI",optional:!0,help:"Defaults to []."},{name:"options",type:"Object",optional:!0}]},{name:"pipe",description:"The equivalent of doing a select() followed by a listen().",args:[{name:"sink",type:"Sink"},{name:"options",type:"Object",optional:!0}]},{name:"listen",description:"Listen for future (scoped) updates to the DAO.",args:[{name:"sink",type:"Sink"},{name:"options",type:"Object",optional:!0}]},{name:"unlisten",description:"Remove a previously registered listener.",args:[{name:"sink",type:"Sink"}]},{name:"where",description:"Return a DAO that will be filtered to the specified predicate.",returnValue:"DAO",args:[{name:"query",type:"Predicate"}]},{name:"limit",description:"Return a DAO that will limit future select()'s to the specified number of results.",returnValue:"DAO",args:[{name:"count",type:"Int"}]},{name:"skip",description:"Return a DAO that will skip the specified number of objects from future select()'s",returnValue:"DAO",args:[{name:"skip",type:"Int"}]},{name:"orderBy",description:"Return a DAO that will order future selection()'s by the specified sort order.",returnValue:"DAO",args:[{name:"comparators",rest:!0,type:"Comparator",description:"One or more comparators that specify the sort-order."}]}]});var FutureDAO={create:function(a){function b(a){if(c.__proto__!==a){var b=c.__proto__.daoListeners_;c.__proto__=a;for(var d=0;d<b.length;d++)console.log("******************************************************* AddingListener ",c,b[d]),c.listen.apply(c,b[d])}}var c={__proto__:{daoListeners_:[],select:function(){var c=arguments,d=afuture();return a(function(a){b(a),a.select.apply(a,c)(d.set)}),d.get},pipe:function(){var c=arguments;a(function(a){b(a),a.pipe.apply(a,c)})},put:function(){var c=arguments;a(function(a){b(a),a.put.apply(a,c)})},find:function(){var c=arguments;a(function(a){b(a),a.find.apply(a,c)})},where:function(a){return arguments.length>1&&(a=CompoundComparator.apply(null,arguments)),filteredDAO(a,this)},limit:function(a){return limitedDAO(a,this)},skip:function(a){return skipDAO(a,this)},orderBy:function(){return orderedDAO(1==arguments.length?arguments[0]:argsToArray(arguments),this)},listen:function(){},unlisten:function(){}}};return c}},LoggingDAO={create:function(){var a,b;return 2==arguments.length?(a=arguments[0],b=arguments[1]):(a=console.log.bind(console),b=arguments[0]),{__proto__:b,put:function(c,d){a("put",c),b.put(c,d)},remove:function(c,d){a("remove",c),b.remove(c,d)},select:function(c,d){return a("select",d||""),b.select(c,d)},removeAll:function(c,d){return a("removeAll",c),b.remove(c,d)}}}},TimingDAO={create:function(a,b){function c(b){var c=a+"-"+b,d=g[b]++?c+"-"+f++:c;return console.time(f),[d,c,window.performance.now(),b]}function d(a){g[a[3]]--,f--,console.timeEnd(a[0]),console.log("Timing: ",a[1]," ",(window.performance.now()-a[2]).toFixed(3)," ms")}function e(a,b){return{put:function(){d(a),b&&b.put&&b.put.apply(b,arguments)},remove:function(){d(a),b&&b.remove&&b.remove.apply(b,arguments)},error:function(){d(a),b&&b.error&&b.error.apply(b,arguments)},eof:function(){d(a),b&&b.eof&&b.eof.apply(b,arguments)}}}var f,g={put:0,remove:0,find:0,select:0};return{__proto__:b,put:function(a,d){var f=c("put");b.put(a,e(f,d))},remove:function(a,d){var f=c("remove");b.remove(a,e(f,d))},find:function(a,d){var f=c("find");b.find(a,e(f,d))},select:function(a,e){var f=c("select"),g=afuture();return b.select(a,e)(function(a){d(f),g.set(a)}),g.get}}}},ObjectToJSON={__proto__:Visitor.create(),visitFunction:function(a){return a.toString()},visitObject:function(a){return this.push({model_:a.model_.name}),this.__proto__.visitObject.call(this,a),this.pop()},visitProperty:function(a,b){this.top()[b.name]=this.visit(a[b.name])},visitMap:function(a){return this.push({}),Visitor.visitMap.call(this,a),this.pop()},visitMapElement:function(a,b){this.top()[a]=this.visit(b)},visitArray:function(a){return this.push([]),this.__proto__.visitArray.call(this,a),this.pop()},visitArrayElement:function(a,b){this.top().push(this.visit(a[b]))}},JSONToObject={__proto__:ObjectToJSON.create(),visitString:function(o){try{return"function"===o.substr(0,8)?eval("("+o+")"):o}catch(x){return console.log(x,o),o}},visitObject:function(a){var b=GLOBAL[a.model_];if(!b)throw a.model_;var c=b.create();return Object_forEach(a,function(a,b){"model_"!==b&&(c[b]=this.visit(a))}.bind(this)),c},visitArray:Visitor.visitArray,visitArrayElement:function(a,b){a[b]=this.visit(a[b])}};FOAModel({name:"AbstractDAO",methods:{update:function(a){return this.select(UPDATE(a,this))},listen:function(a,b){a=this.decorateSink_(a,b,!0),this.daoListeners_||Object.defineProperty(this,"daoListeners_",{enumerable:!1,value:[]}),this.daoListeners_.push(a)},pipe:function(a,b){a=this.decorateSink_(a,b,!0);var c=this.createFlowControl_(),d=this;this.select({put:function(){a.put&&a.put.apply(a,arguments)},remove:function(){a.remove&&a.remove.apply(a,arguments)},error:function(){a.error&&a.error.apply(a,arguments)},eof:function(){c.stopped?a.eof&&a.eof():d.listen(a,b)}},b,c)},decorateSink_:function(a,b,c,d){return b&&(d||(b.limit&&(a=limitedSink(b.limit,a)),b.skip&&(a=skipSink(b.skip,a))),b.order&&!c&&(a=orderedSink(b.order,a)),b.query&&(a=predicatedSink(b.query.partialEval?b.query.partialEval():b.query,a))),a},createFlowControl_:function(){return{stop:function(){this.stopped=!0},error:function(a){this.errorEvt=a}}},where:function(a){return filteredDAO(a,this)},limit:function(a){return limitedDAO(a,this)},skip:function(a){return skipDAO(a,this)},orderBy:function(){return orderedDAO(1==arguments.length?arguments[0]:argsToArray(arguments),this)},unlisten:function(a){var b=this.daoListeners_;if(b){for(var c=0;c<b.length;c++)if(b[c].$UID===a.$UID)return b.splice(c,1),!0;console.warn("Phantom DAO unlisten: ",this,a)}},removeAll:function(a){var b=this,c=afuture();return this.select({put:function(c){b.remove(c,{remove:a&&a.remove})}})(function(){a&&a.eof(),c.set()}),c.get},notify_:function(a,b){if(this.daoListeners_)for(var c=0;c<this.daoListeners_.length;c++){var d=this.daoListeners_[c],e=d[a];e&&(b[2]={stop:function(a,b){return function(){a(b)}}(this.unlisten.bind(this),d),error:function(){}},e.apply(d,b))}}}}),FOAModel({name:"ProxyDAO",extendsModel:"AbstractDAO",properties:[{name:"delegate",type:"DAO",mode:"read-only",hidden:!0,required:!0,"transient":!0,postSet:function(a,b){this.model=b.model,this.daoListeners_&&this.daoListeners_.length&&(a&&a.unlisten(this.relay()),b.listen(this.relay()),this.notify_("put",[]))}}],methods:{relay:function(){if(!this.relay_){var a=this;this.relay_={put:function(){a.notify_("put",arguments)},remove:function(){a.notify_("remove",arguments)},toString:function(){return"RELAY("+this.$UID+", "+a.model_.name+", "+a.delegate+")"}}}return this.relay_},put:function(a,b){this.delegate.put(a,b)},remove:function(a,b){this.delegate.remove(a,b)},removeAll:function(){return this.delegate.removeAll.apply(this.delegate,arguments)},find:function(a,b){this.delegate.find(a,b)},select:function(a,b){return this.delegate.select(a,b)},listen:function(a,b){this.daoListeners_&&this.daoListeners_.length||this.delegate.listen(this.relay()),this.SUPER(a,b)},unlisten:function(a){this.SUPER(a),this.daoListeners_&&this.daoListeners_.length||this.delegate.unlisten(this.relay())}}}),FOAModel({name:"SeqNoDAO",label:"SeqNoDAO",extendsModel:"ProxyDAO",properties:[{name:"property",type:"Property",required:!0,hidden:!0,defaultValueFn:function(){return this.delegate.model?this.delegate.model.ID:void 0},"transient":!0},{model_:"IntProperty",name:"sequenceValue",defaultValue:1}],methods:{init:function(){this.SUPER();var a=afuture();this.WHEN_READY=a.get,this.delegate.select(MAX(this.property))(function(b){b.max&&(this.sequenceValue=b.max+1),a.set(!0)}.bind(this))},put:function(a,b){this.WHEN_READY(function(){var c=this.property.f(a);c==this.property.defaultValue&&(a[this.property.name]=this.sequenceValue++),this.delegate.put(a,b)}.bind(this))}}}),FOAModel({name:"CachingDAO",extendsModel:"ProxyDAO",properties:[{name:"src"},{name:"cache",help:"Alias for delegate.",getter:function(){return this.delegate},setter:function(a){this.delegate=a}},{name:"model",defaultValueFn:function(){return this.src.model||this.cache.model}}],methods:{init:function(){this.SUPER();var a=this.src,b=this.cache,c=afuture();this.cache=FutureDAO.create(c.get),a.select(b)(function(){a.listen(b),c.set(b),this.cache=b}.bind(this))},put:function(a,b){this.src.put(a,b)},remove:function(a,b){this.src.remove(a,b)},removeAll:function(a,b){return this.src.removeAll(a,b)}}}),FOAModel({name:"CascadingRemoveDAO",label:"Cascading Remove DAO",extendsModel:"ProxyDAO",properties:[{name:"childDAO",type:"DAO",mode:"read-only",hidden:!0,required:!0,"transient":!0},{name:"property",type:"Property",required:!0,hidden:!0,"transient":!0}],methods:{remove:function(a,b){this.childDAO.where(EQ(this.property,a)).removeAll(),this.delegate.remove(a,b)},removeAll:function(a,b){return apar(this.childDAO.removeAll(null,b),this.delegate.removeAll(a,b))}}});var pmap={};for(var key in AbstractDAO.methods)pmap[AbstractDAO.methods[key].name]=AbstractDAO.methods[key].code;defineProperties(Array.prototype,pmap),defineProperties(Array.prototype,{deleteF:function(a){for(var b=this.clone(),c=0;c<b.length;c++)if(b[c]===a){b.splice(c,1);break}return b},deleteI:function(a){for(var b=0;b<this.length;b++)if(this[b]===a)return this.splice(b,1),!0;return!1},removeF:function(a){for(var b=this.clone(),c=0;c<b.length;c++)if(a.f(b[c])){b.splice(c,1);break}return b},removeI:function(a){for(var b=0;b<this.length;b++)a.f(this[b])&&this.splice(b,1);return this},pushF:function(a){var b=this.clone();return b.push(a),b},clone:function(){return this.slice(0)},deepClone:function(){for(var a=this.slice(0),b=0;b<a.length;b++)a[b]=a[b].deepClone();return a},put:function(a,b){this.push(a),this.notify_("put",arguments),b&&b.put&&b.put(a)},find:function(a,b){if(a.f){for(var c in this)if(a.f(this[c]))return void(b&&b.put&&b.put(this[c]))}else for(var c in this)if(this[c].id===a)return void(b&&b.put&&b.put(this[c]));b&&b.error&&b.error("find",a)},remove:function(a,b){var c=a.id?a.id:a;this.removeAll({remove:b&&b.remove},{query:{f:function(a){return a.id?a.id===c:a===c}}})},removeAll:function(a,b){b||(b={}),b.query||(b.query={f:function(){return!0}});for(var c=0;c<this.length;c++){var d=this[c];if(b.query.f(d)){var e=this.splice(c,1)[0];this.notify_("remove",[e]),a&&a.remove&&a.remove(e),c--}}return a&&a.eof&&a.eof(),anop()},select:function(a,b){a=a||[];var c=b&&(b.query||b.order),d=a;if(a=this.decorateSink_(a,b,!1,!c),a.model_===CountExpr)return a.count=this.length,aconstant(d);for(var e=this.createFlowControl_(),f=Math.max(0,c?0:b&&b.skip||0),g=c?this.length:Math.min(this.length,f+(b&&b.limit||this.length)),h=f;g>h&&(a.put(this[h],null,e),!e.stopped);h++)if(e.errorEvt)return a.error&&a.error(e.errorEvt),aconstant(d,e.errorEvt);return a.eof&&a.eof(),aconstant(d)}}),FOAModel({name:"IDBDAO",label:"IndexedDB DAO",extendsModel:"AbstractDAO",properties:[{name:"model",label:"Model",type:"Model",required:!0},{name:"name",label:"Store Name",type:"String",defaultValueFn:function(){return this.model.plural}},{model_:"BooleanProperty",name:"useSimpleSerialization",defaultValue:!0}],methods:{init:function(){this.SUPER(),this.useSimpleSerialization?(this.serialize=this.SimpleSerialize,this.deserialize=this.SimpleDeserialize):(this.serialize=this.FOAMSerialize,this.deserialize=this.FOAMDeserialize),this.withDB=amemo(this.openDB.bind(this))},FOAMDeserialize:function(a){return JSONToObject.visitObject(a)},FOAMSerialize:function(a){return ObjectToJSON.visitObject(a)},SimpleDeserialize:function(a){return this.model.create(a)},SimpleSerialize:function(a){return a.instance_},openDB:function(a){var b=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB,c=b.open("FOAM:"+this.name,1);c.onupgradeneeded=function(a){a.target.result.createObjectStore(this.name)}.bind(this),c.onsuccess=function(b){a(b.target.result)}.bind(this),c.onerror=function(a){console.log("************** failure",a)}},withStore:function(a,b){if("readwrite"!==a)return this.withStore_(a,b);var c=this;if(this.q_)this.q_.push(b),1e4==this.q_.length&&(this.q_=void 0);else{var d=[b];this.q_=d,setTimeout(function(){c.withStore_(a,function(a){c.q_==d&&(c.q_=void 0);for(var b=0;b<d.length;b++)d[b](a)})},0)}},withStore_:function(a,b){if(GLOBAL.__TXN__&&GLOBAL.__TXN__.store)try{return void b.call(this,__TXN__.store)}catch(c){GLOBAL.__TXN__=void 0}this.withDB(function(c){var d=c.transaction([this.name],a),e=d.objectStore(this.name);GLOBAL.__TXN__&&(GLOBAL.__TXN__.store=e),b.call(this,e)}.bind(this))},put:function(a,b){var c=this;this.withStore("readwrite",function(d){var e=d.put(c.serialize(a),a.id);e.transaction.addEventListener("complete",function(){c.notify_("put",[a]),b&&b.put&&b.put(a)}),e.transaction.addEventListener("error",function(){b&&b.error&&b.error("put",a)})})},find:function(a,b){if(Expr.isInstance(a)){var c=!1;return void this.limit(1).where(a).select({put:function(){c=!0,b.put.apply(b,arguments)},eof:function(){c||b.error("find",a)}})}var d=this;this.withStore("readonly",function(c){var e=c.get(a);e.transaction.addEventListener("complete",function(){if(!e.result)return void(b&&b.error&&b.error("find",a));var c=d.deserialize(e.result);b&&b.put&&b.put(c)}),e.onerror=function(){b&&b.error&&b.error("find",a)}})},remove:function(a,b){var c=this;this.withStore("readwrite",function(d){var e=a.id?a.id:a,f=d.get(e);f.onsuccess=function(){if(!f.result)return void(b&&b.error&&b.error("remove",a));var g=c.deserialize(f.result),h=d.delete(e);h.transaction.addEventListener("complete",function(){c.notify_("remove",[g]),b&&b.remove&&b.remove(g)}),h.onerror=function(a){b&&b.error&&b.error("remove",a)}},f.onerror=function(a){b&&b.error&&b.error("remove",a)}})},removeAll:function(a,b){var c=b&&b.query&&b.query.partialEval()||{f:function(){return!0}},d=afuture(),e=this;return this.withStore("readwrite",function(b){var f=b.openCursor();f.onsuccess=function(b){var d=b.target.result;if(d){var f=e.deserialize(d.value);if(c.f(f)){var g=d.delete();g.transaction.addEventListener("complete",function(){e.notify_("remove",[f]),a&&a.remove&&a.remove(f)}),g.onerror=function(b){a&&a.error&&a.error("remove",b)}}d.continue()}},f.transaction.oncomplete=function(){a&&a.eof&&a.eof(),d.set()},f.onerror=function(b){a&&a.error&&a.error("remove",b)}}),d.get},select:function(a,b){a=a||[],a=this.decorateSink_(a,b,!1);var c=this.createFlowControl_(),d=afuture(),e=this;return this.withStore("readonly",function(b){var f=b.openCursor();f.onsuccess=function(b){var f=b.target.result;if(!c.stopped){if(c.errorEvt)return a.error&&a.error(c.errorEvt),void d.set(a,c.errorEvt);if(!f)return a.eof&&a.eof(),void d.set(a);var g=e.deserialize(f.value);a.put(g),f.continue()}},f.onerror=function(b){a.error&&a.error(b)}}),d.get}},listeners:[{name:"updated",code:function(a){console.log("updated: ",a),this.publish("updated")}}]}),FOAModel({name:"StorageDAO",extendsModel:"MDAO",properties:[{name:"name",label:"Store Name",type:"String",defaultValueFn:function(){return this.model.plural}}],methods:{init:function(){this.SUPER();var a=localStorage.getItem(this.name);a&&JSONUtil.parse(a).select(this),this.addRawIndex({execute:function(){},bulkLoad:function(){},toString:function(){return"StorageDAO Update"},plan:function(){return{cost:Number.MAX_VALUE}},put:this.updated,remove:this.updated})}},listeners:[{name:"updated",isMerged:100,code:function(){this.select()(function(a){localStorage.setItem(this.name,JSONUtil.compact.where(NOT_TRANSIENT).stringify(a))}.bind(this))}}]}),FOAModel({extendsModel:"AbstractDAO",name:"AbstractFileDAO",properties:[{name:"model",type:"Model",requred:!0},{name:"filename",label:"Storage file name",type:"String",defaultValueFn:function(){return this.model.plural}},{name:"type",label:"Filesystem Type",type:"String",view:{create:function(){return ChoiceView.create({choices:["Persistent","Temporary"]})}},defaultValue:"Persistent"}],methods:{init:function(){this.SUPER();var a=this,b=amemo(aseq(function(b){window.webkitStorageInfo.requestQuota("Persistent"===a.type?1:0,209715200,function(){b(209715200)},console.error.bind(console))},function(b,c){window.requestFileSystem("Persistent"===a.type?1:0,c,b,console.error.bind(console))},function(b,c){c.root.getFile(a.filename,{create:!0},b,console.error.bind(console))}));this.withWriter=amemo(aseq(b,function(a,b){b.createWriter(a,console.error.bind(console))})),this.withStorage=amemo(aseq(b,function(a,b){b.file(a,console.error.bind(console))},function(b,c){var d=new FileReader,e={};d.onerror=console.error.bind(console),d.onloadend=function(){a.parseContents_(b,d.result,e)},this.readFile_(d,c)}))},put:function(a,b){var c=this;this.withStorage(function(d){d.put(a,{__proto__:b,put:function(){b&&b.put&&b.put(a),c.notify_("put",[a]),c.update_("put",a)}})})},find:function(a,b){this.withStorage(function(c){c.find(a,b)})},remove:function(a,b){var c=this;this.withStorage(function(d){d.remove(a,{__proto__:b,remove:function(a){c.__proto__.remove&&c.__proto__.remove(a),c.notify_("remove",[a]),c.update_("remove",a)}})})},removeAll:function(a,b){var c=this,d=afuture();return this.withStorage(function(e){var f=e.removeAll({__proto__:a,remove:function(a){c.__proto__.remove&&c.__proto__.remove(a),c.notify_("remove",[a]),c.update_("remove",a)}},b);f(d.set)}),d.get},select:function(a,b){this.withStorage(function(c){c.select(a,b)})}}}),FOAModel({name:"JSONFileDAO",extendsModel:"AbstractFileDAO",label:"JSON File DAO",properties:[{name:"writeQueue",type:"Array[String]",defaultValueFn:function(){return[]}}],methods:{init:function(){this.SUPER(),this.withWriter(function(a){a.addEventListener("writeend",function(a){this.writeOne_(a.target)}.bind(this))}.bind(this))},readFile_:function(a,b){a.readAsText(b)},parseContents_:function(ret,contents,storage){with(storage)eval(contents);ret(storage)},writeOne_:function(a){if(1!=a.readyState&&0!=this.writeQueue.length){a.seek(a.length);var b=this.writeQueue,c=b.shift();this.writeQueue=b,a.write(c)}},update_:function(a,b){var c=[];"put"===a?c.push("put("+JSONUtil.compact.stringify(b)+");\n"):"remove"===a&&c.push("remove("+JSONUtil.compact.stringify(b.id)+");\n"),this.writeQueue=this.writeQueue.concat(new Blob(c)),this.withWriter(function(a){this.writeOne_(a)}.bind(this))}}}),FOAModel({name:"KeyCollector",help:"A sink that collects the keys of the objects it's given.",properties:[{name:"keys",type:"Array",factory:function(){return[]}}],methods:{put:function(a){this.keys.push(a.id)},remove:function(a){this.keys.remove(a.id)}}}),FOAModel({name:"WorkerDAO",extendsModel:"AbstractDAO",properties:[{name:"model",type:"Model",required:!0},{name:"delegate",type:"Worker",help:"The web-worker to delegate all actions to.",factory:function(){var a=window.location.protocol+window.location.host+window.location.pathname.substring(0,window.location.pathname.lastIndexOf("/")+1),b=["var url = '"+a+"';\n","var a = importScripts;","importScripts = function(scripts) { \nfor (var i = 0; i < arguments.length; i++) \na(url + arguments[i]); \n};\n","try { importScripts('bootFOAMWorker.js'); } catch(e) { \n debugger; }\n","WorkerDelegate.create({ dao: [] });\n"];return new Worker(window.URL.createObjectURL(new Blob(b,{type:"text/javascript"})))},postSet:function(a,b){a&&a.terminate(),b.addEventListener("message",this.onMessage)}},{name:"requests_",type:"Object",label:"Requests",help:"Map of pending requests to delegate.",factory:function(){return{}}},{name:"nextRequest_",type:"Int",label:"Next Request",help:"Id of the next request to the delegate.",factory:function(){return 1}},{name:"storage_",type:"Object",label:"Storage",help:"Local cache of the data in the delegate.",factory:function(){return{}}}],methods:{init:function(){this.SUPER(),this.delegate.postMessage("")},destroy:function(){this.delegate.terminate()},makeRequest_:function(a,b,c,d){var e=this.nextRequest_++;b=b?ObjectToJSON.visit(b):{};var f={method:a,params:b,request:e};this.requests_[e]={method:a,callback:c,error:d},this.delegate.postMessage(f)},put:function(a,b){this.makeRequest_("put",a,function(){this.storage_[a.id]=a,this.notify_("put",[a]),b&&b.put&&b.put(a)}.bind(this),b&&b.error&&b.error.bind(b))},remove:function(a,b){this.makeRequest_("remove",a,function(a){for(var c=0,d=a.keys[c];d;c++){var e=this.storage_[d];delete this.storage_[d],b&&b.remove&&b.remove(e)}}.bind(this),b&&b.error&&b.error.bind(b))},find:function(a,b){this.storage_.find(a,b)},select:function(a,b){a=a||[];var c=this.createFlowControl_();if(a.model_&&a.reduceI){var d={sink:a,options:b};this.makeRequest_("select",d,function(b){var c=JSONToObject.visit(b.sink);a.reduceI(c),a.eof&&a.eof()}.bind(this),a&&a.error&&a.error.bind(a))}else{var e=KeyCollector.create();d={sink:e,options:b},this.makeRequest_("select",d,function(b){for(var d=JSONToObject.visit(b.sink),e=0;e<d.keys.length;e++){var f=d.keys[e];if(c.stopped)break;if(c.errorEvt){a.error&&a.error(c.errorEvt);break}var g=this.storage_[f];a.put(g)}a.eof&&a.eof()}.bind(this),a&&a.error&&a.error.bind(a))}},handleNotification_:function(a){if("put"==a.method){var b=JSONToObject.visitObject(a.obj);this.storage_[b.id]=b,this.notify_("put",[b])}else if("remove"==a.method){var b=this.stroage_[a.key];delete this.storage_[a.key],this.notify_("remove",[b])}}},listeners:[{name:"onMessage",help:"Callback for message events from the delegate.",code:function(a){var b=a.data;if(b.request){var c=this.requests_[b.request];return delete this.requests_[b.request],b.error?void c.error(b.error):void c.callback(b)}this.handleNotification_(b)}}]}),FOAModel({name:"WorkerDelegate",help:"The client side of a web-worker DAO",properties:[{name:"dao",label:"DAO",type:"DAO",required:"true",postSet:function(a,b){a&&a.unlisten(this),b.listen(this)}}],methods:{init:function(){this.SUPER(),self.addEventListener("message",this.onMessage)},put:function(a){self.postMessage({method:"put",obj:ObjectToJSON.visitObject(a)})},remove:function(a){self.postMessage({method:"remove",key:a.id})}},listeners:[{name:"onMessage",code:function(a){var b=a.data;if(b.method){var c=b.params.model_?JSONToObject.visitObject(b.params):b.params;
if("put"==b.method)this.dao.put(c,{put:function(){self.postMessage({request:b.request})},error:function(){self.postMessage({request:b.request,error:!0})}});else if("remove"==b.method)this.dao.remove(c,{remove:function(){self.postMessage({request:b.request})},error:function(){self.postMessage({request:b.request,error:!0})}});else if("select"==b.method){var d=JSONToObject.visit(b.params),e={__proto__:d.sink,eof:function(){d.sink.eof&&d.sink.eof(),self.postMessage({request:b.request,sink:ObjectToJSON.visit(this.__proto__)})},error:function(){d.sink.error&&d.sink.error(),self.postMessage({request:b.request,error:!0})}};this.dao.select(e,d.options)}}}}]});var ModelDAO={create:function(a,b){var c={__proto__:b,namespace:a,dao:b,created:{},init_:function(){var a=this;this.pipe({put:a.add_.bind(this),remove:a.del_.bind(this)})},add_:function(a){if("Model"!=a.name){this.namespace[a.name]=a,FOAM.putFactory(this.namespace,a.name+"Proto",function(){return this.namespace[a.name].getPrototype()}),FOAM.putFactory(this.namespace,a.name+"DAO",function(){return console.log("Creating '"+a.name+"DAO'"),StorageDAO.create({model:a})})}},del_:function(){for(var a in this.created)delete this.namespace[a]}};return c.init_(),c}};FOAModel({name:"OrderedCollectorSink",properties:[{name:"storage",type:"Array",factory:function(){return[]}},{name:"comparator",type:"Value",required:!0}],methods:{reduceI:function(a){this.storage=this.storage.reduce(this.comparator,a.storage)},put:function(a){this.storage.push(a)}}}),FOAModel({name:"CollectorSink",properties:[{name:"storage",type:"Array",factory:function(){return[]}}],methods:{reduceI:function(a){this.storage=this.storage.concat(a.storage)},put:function(a){this.storage.push(a)}}}),FOAModel({name:"ParitionDAO",extendsModel:"AbstractDAO",properties:[{name:"partitions",type:"Array[DAO]",mode:"read-only",required:!0}],methods:{init:function(){this.SUPER();for(var a=0;a<this.partitions.length;a++){var b=this.partitions[a],c=this;b.listen({put:function(a){c.notify_("put",[a])},remove:function(a){c.notify_("remove",[a])}})}},getPartition_:function(a){return this.partitions[Math.abs(a.hashCode())%this.partitions.length]},put:function(a,b){this.getPartition_(a).put(a,b)},remove:function(a,b){if(a.id)this.getPartition_(a).remove(a,b);else{var c=this;this.find(a,{put:function(a){c.remove(a,b)},error:b&&b.error})}},find:function(a,b){for(var c=0;c<this.partitions.length;c++)this.partitions[c].find(a,b)},select:function(a,b){a=a||[];var c={},d=a;b=b||{},"limit"in b&&(c.limit=b.limit+(b.skip||0),c.skip=0),c.order=b.order,c.query=b.query;var e=this.partitions.length,f=this.createFlowControl_(),g=afuture();if(a.model_&&a.reduceI)var h=a;else h=b.order?OrderedCollectorSink.create({comparator:b.order}):CollectorSink.create({}),"limit"in b&&(a=limitedSink(b.limit,a)),b.skip&&(a=skipSink(b.skip,a)),h.eof=function(){for(var b=0;b<this.storage.length&&!f.stopped;b++){if(f.errorEvt){a.error&&a.error(f.errorEvt),g.set(a,f.errorEvt);break}a.put(this.storage[b],null,f)}};for(var i=new Array(this.partitions.length),j=0;j<this.partitions.length;j++)i[j]=h.deepClone(),i[j].eof=function(){h.reduceI(this),e--,0>=e&&(h.eof&&h.eof(),g.set(d))};for(var j=0;j<this.partitions.length;j++)this.partitions[j].select(i[j],c);return g.get}}}),FOAModel({name:"ActionFactoryDAO",extendsModel:"ProxyDAO",label:"ActionFactoryDAO",properties:[{name:"actionDao",type:"DAO",hidden:!0,required:!0}],methods:{put:function(a,b){var c=this;aseq(function(b){c.delegate.find(a.id,{put:function(a){b(a)},error:function(){b()}})},function(d,e){e?e.writeActions(a,c.actionDao.put.bind(c.actionDao)):a.model_.createActionFactory&&a.model_.createActionFactory(function(a){for(var b=0;b<a.length;b++)c.actionDao.put(a[b])},a),c.delegate.put(a,b),d()})(function(){})},remove:function(a,b){if(a.model_.deleteActionFactory)for(var c=a.model_.deleteActionFactory(a),d=0;d<c.length;d++)this.actionDao.put(c[d]);this.delegate.remove(a,b)}}}),FOAModel({name:"BlobReaderDAO",properties:[{name:"blob",type:"Blob",required:!0}],methods:{put:function(a,b){b&&b.error&&b.error("Unsupported")},remove:function(a,b){b&&b.error&&b.error("Unsupported")},select:function(a,b){b=b||[],b&&b.error&&b.error("Unsupported")},find:function(a,b){var c=this.blob.slice(a[0],a[0]+a[1]),d=new FileReader;d.readAsText(c),d.onload=function(){b&&b.put&&b.put(d.result)},d.onerror=function(a){b&&b.error&&b.error("find",a)}}}}),FOAModel({name:"GDriveDAO",properties:[{name:"authtoken",label:"Authentication Token"}],methods:{put:function(){},remove:function(){},select:function(a){a=a||[];var b=new XMLHttpRequest,c=["maxResults=10"];b.open("GET","https://www.googleapis.com/drive/v2/files?"+c.join("&")),b.setRequestHeader("Authorization","Bearer "+this.authtoken),b.onreadystatechange=function(){if(4==b.readyState){var c=JSON.parse(b.responseText);if(!c||!c.items)return void(a&&a.error&&a.error(b.responseText));for(var d=0;d<c.items.length;d++)a&&a.put&&a.put(c.items[d])}},b.send()},find:function(){}}}),FOAModel({name:"RestDAO",extendsModel:"AbstractDAO",properties:[{name:"model",label:"Type of data stored in this DAO."},{name:"url",label:"REST API URL."},{model_:"ArrayProperty",subType:"Property",name:"paramProperties",help:"Properties that are handled as separate parameters rather than in the query."},{model_:"IntProperty",name:"batchSize",defaultValue:200},{model_:"IntProperty",name:"skipThreshold",defaultValue:1e3}],methods:{jsonToObj:function(a){return this.model.create(a)},objToJson:function(a){return JSONUtil.compact.stringify(a)},buildURL:function(){return this.url},buildFindURL:function(a){return this.url+"/"+a},buildPutURL:function(){return this.url},buildPutParams:function(){return[]},buildSelectParams:function(){return[]},put:function(a,b){var c=this,d={};this.X.ajsonp(this.buildPutURL(a),this.buildPutParams(a),"POST",this.objToJson(a,d))(function(a,e){if(200!==e)return void(b&&b.error&&b.error([a,e]));var f=c.jsonToObj(a,d);b&&b.put&&b.put(f),c.notify_("put",[f])})},remove:function(){},select:function(a,b){a=a||[];var c,d=afuture(),e=this,f=0,g=0,h=this.createFlowControl_(),i={},j=[];if(b){g+=b.skip||0;var k,l=b.query;if(l){var m=l;l=l.normalize();var n=[l,m.deepClone()];j=this.buildSelectParams(a,n),k=this.buildURL(n,i),l=n[0],m=n[1];var o=l.toMQL();o&&j.push("q="+encodeURIComponent(l.toMQL()))}else k=this.buildURL();if(b.order){var p=b.order.toMQL();j.push("sort="+p)}b.limit&&(c=b.limit)}var q=!1;return awhile(function(){return!q},function(b){var d=e.batchSize;if(Number.isFinite(c))var d=Math.min(d,c);CountExpr.isInstance(a)&&(d=0);var l=j.slice();l.push("maxResults="+d),l.push("startIndex="+g),this.X.ajsonp(k,l)(function(d){if(CountExpr.isInstance(a))return a.count=d.totalResults,q=!0,void b();var j=d&&d.items?d.items:[];0==j.length&&(q=!0),g+=j.length;for(var k=0;k<j.length;k++){var l=e.jsonToObj(j[k],i);if(!m||m.f(l)){if(Number.isFinite(c)){if(0>=c){q=!0;break}c--}if(h.stopped){q=!0;break}if(h.errorEvt){a.error&&a.error(h.errorEvt),q=!0;break}a&&a.put&&a.put(l,null,h)}else f++}0>=c&&(q=!0),(!d||g>=d.totalResults)&&(q=!0),f>=e.skipThreshold&&(q=!0),b()})})(function(){a&&a.eof&&a.eof(),d.set(a)}),d.get},find:function(a,b){var c=this;this.X.ajsonp(this.buildFindURL(a))(function(a){a?b&&b.put&&b.put(c.jsonToObj(a)):b&&b.error&&b.error("No Network Response")})}}}),FOAModel({name:"DefaultObjectDAO",help:"A DAO decorator that will generate a default object if no object is found on a .find() call.",extendsModel:"ProxyDAO",properties:[{name:"factory",help:"A factory method to construct the default object."}],methods:{find:function(a,b){var c=this,d={put:b.put.bind(b),error:function(){b.put(c.factory(a))}};this.delegate.find(a,d)}}}),FOAModel({name:"LRUCachingDAO",extendsModel:"ProxyDAO",properties:[{model_:"IntProperty",name:"maxSize",defaultValue:30},{name:"cacheFactory",defaultValueFn:function(){return MDAO}},{name:"cache",hidden:!0}],models:[{model_:"Model",name:"LRUCacheItem",ids:["id"],properties:[{name:"id"},{name:"obj"},{model_:"DateTimeProperty",name:"timestamp"}]}],methods:{init:function(){this.SUPER(),this.cache=this.cacheFactory.create({model:this.LRUCacheItem});var a=this;this.delegate.listen({remove:function(b){a.cache.remove(b)}})},find:function(a,b){var c=this;this.cache.find(a,{put:function(a){a.timestamp=new Date,c.cache.put(a,{put:function(){b&&b.put&&b.put(a.obj)}})},error:function(){c.delegate.find(a,{put:function(d){c.cache.put(c.LRUCacheItem.create({id:a,timestamp:new Date,obj:d}),{put:function(a){b&&b.put&&b.put(a.obj),c.cleanup_()},error:function(){b&&b.error&&b.error.apply(b,arguments)}})},error:function(){b&&b.error&&b.error.apply(b,arguments)}})}})},put:function(a,b){var c=this;this.cache.find(a.id,{put:function(a){a.timestamp=new Date,c.cache.put(a,{put:function(a){c.delegate.put(a.obj,b)},error:function(){b&&b.error&&b.error.apply(this,arguments)}})},error:function(){c.cache.put(c.LRUCacheItem.create({timestamp:new Date,id:a.id,obj:a}),{put:function(){c.delegate.put(a,b),c.cleanup_()},error:function(){b&&b.error&&b.error.apply(this,arguments)}})}})},remove:function(a,b){if(a.id)var c=a.id;else c=a;var d=this;this.cache.remove(a.id,{put:function(){d.delegate.remove(a,b)},error:function(){b&&b.error&&b.error("remove",a)}})},removeAll:function(a,b){var c=this;this.delegate.removeAll({remove:function(b){c.cache.remove(b.id,{remove:function(){a&&a.remove&&a.remove(b)},error:function(){}})},error:function(){a&&a.error&&a.error.apply(a,arguments)}},b)},cleanup_:function(){var a=this;this.cache.orderBy(DESC(this.LRUCacheItem.TIMESTAMP)).skip(this.maxSize).select({put:function(b){a.cache.remove(b)}})}}}),FOAModel({name:"LazyCacheDAO",extendsModel:"ProxyDAO",properties:[{name:"cache"}],methods:{find:function(a,b){var c=this,d={put:b.put.bind(b),error:function(){c.delegate.find(a,{put:function(a){var d=arguments;c.cache.put(a,{put:function(){b.put.apply(b,d)}})},error:function(){b&&b.error&&b.error.apply(b,arguments)}})}};this.cache.find(a,d)}}}),FOAModel({name:"PropertyOffloadDAO",extendsModel:"ProxyDAO",properties:[{name:"property"},{name:"model"},{name:"offloadDAO"},{model_:"BooleanProperty",name:"loadOnSelect"}],methods:{put:function(a,b){if(a.hasOwnProperty(this.property.name)){var c=this.model.create({id:a.id});c[this.property.name]=this.property.f(a),a[this.property.name]="",this.offloadDAO.put(c)}this.delegate.put(a,b)},select:function(a,b){if(!this.loadOnSelect)return this.delegate.select(a,b);var c=this.offloadSink(a);return this.delegate.select(c,b)},offloadSink:function(a){var b=this;return{__proto__:a,put:function(c){a.put&&a.put.apply(a,arguments),b.offloadDAO.find(c.id,{put:function(a){a[b.property.name]&&(c[b.property.name]=a[b.property.name])}})}}},find:function(a,b){this.delegate.find(a,this.offloadSink(b))}}}),FOAModel({name:"BlobSerializeDAO",extendsModel:"ProxyDAO",properties:[{model_:"ArrayProperty",name:"properties",subType:"Property"}],methods:{serialize:function(a,b){b=b.clone();for(var c,d=[],e=0;c=this.properties[e];e++)d.push(function(a){return function(c){if(!b[a.name])return void c();var d=new FileReader;d.onloadend=function(){var e=b[a.name].type;b[a.name]="data:"+e+";base64,"+Base64Encoder.encode(new Uint8Array(d.result)),c()},d.readAsArrayBuffer(b[a.name])}}(c));apar.apply(void 0,d)(function(){a(b)})},deserialize:function(a){for(var b,c=0;b=this.properties[c];c++){var d=b.f(a);if(d){var e=d.substring(d.indexOf(":")+1,d.indexOf(";"));d=d.substring(d.indexOf(";base64")+7);var f=Base64Decoder.create([]);f.put(d),f.eof(),a[b.name]=new Blob(f.sink,{type:e})}}},put:function(a,b){var c=this;this.serialize(function(a){c.delegate.put(a,b)},a)},select:function(a){var b=this,c={__proto__:a,put:function(){var c=Array.prototype.slice.call(arguments);b.deserialize(c[0]),a.put.apply(a,c)}},d=Array.prototype.slice.call(arguments);d[0]=c,this.delegate.select.apply(this.delegate,d)},find:function(a,b){var c=this,d={__proto__:b,put:function(){var a=Array.prototype.slice.call(arguments);c.deserialize(a[0]),b.put.apply(b,a)}};this.delegate.find(a,d)}}}),FOAModel({name:"NullDAO",help:"A DAO that stores nothing and does nothing.",methods:{put:function(a,b){b&&b.put&&b.put(a)},remove:function(a,b){b&&b.remove&&b.remove(a)},select:function(a){return a&&a.eof&&a.eof(),aconstant(a)},find:function(a,b){b&&b.error&&b.error("find",a)},listen:function(){},removeAll:function(){},unlisten:function(){},pipe:function(){},where:function(){return this},limit:function(){return this}}});var WaitCursorDAO=FOAM({model_:"Model",name:"WaitCursorDAO",extendsModel:"ProxyDAO",properties:[{name:"count",defaultValue:0,postSet:function(a,b){this.window&&(0==a?DOM.setClass(this.window.document.body,"waiting"):0==b&&DOM.setClass(this.window.document.body,"waiting",!1))}},{name:"window"}],methods:{select:function(a,b){var c=this,d=afuture();this.count++;var e=function(){c.delegate.select(a,b)(function(a){try{d.set(a)}finally{c.count--}})};return this.count>1?e():this.window.setTimeout(e,1),d.get}}});FOAModel({name:"EasyDAO",extendsModel:"ProxyDAO",help:"A facade for easy DAO setup.",properties:[{name:"model"},{name:"name",defaultValueFn:function(){return this.model.plural}},{model_:"BooleanProperty",name:"seqNo",defaultValue:!1},{name:"seqProperty",type:"Property"},{model_:"BooleanProperty",name:"cache",defaultValue:!1},{model_:"BooleanProperty",name:"logging",defaultValue:!1},{model_:"BooleanProperty",name:"timing",defaultValue:!1},{name:"daoType",defaultValue:"IDBDAO"},{model_:"BooleanProperty",name:"autoIndex",defaultValue:!1}],methods:{init:function(){this.SUPER();var a="string"==typeof this.daoType?GLOBAL[this.daoType]:this.daoType,b={model:this.model,autoIndex:this.autoIndex};this.name&&(b.name=this.name),this.seqNo&&(b.property=this.seqProperty);var c=a.create(b);if(MDAO.isInstance(c)?this.mdao=c:this.cache&&(this.mdao=MDAO.create(b),c=CachingDAO.create({cache:this.mdao,src:c,model:this.model})),this.seqNo){var d={__proto__:b,delegate:c,model:this.model};this.seqProperty&&(d.property=this.seqProperty),c=SeqNoDAO.create(d)}this.timing&&(c=TimingDAO.create(this.name+"DAO",c)),this.logging&&(c=LoggingDAO.create(c)),this.delegate=c},addIndex:function(){this.mdao&&this.mdao.addIndex.apply(this.mdao,arguments)},addRawIndex:function(){this.mdao&&this.mdao.addRawIndex.apply(this.mdao,arguments)}}}),Function.prototype.put=function(){this.apply(this,arguments)},Function.prototype.remove=function(){this.apply(this,arguments)},FOAModel({name:"ClientDAO",extendsModel:"AbstractDAO",properties:[{name:"asend",help:"afunc used to send request to the DAOServer.",required:!0},{name:"model",required:!0},{name:"subject",factory:function(){return this.model.name+"DAO"}}],methods:{oneShot_:function(a,b,c){var d=this;this.asend(function(e){c&&(e||c&&c.error&&c.error(a,b[0]),e.put?(e.put.model_?d.notify_("put",e.put):d.notify_("put",b[0]),c&&c.put&&c.put(e.put)):e.remove?(d.notify_("remove",b[0]),c&&c.remove&&c.remove(e.remove)):e.error&&c.error(e.error))},{subject:d.subject,method:a,params:b})},put:function(a,b){this.oneShot_("put",[a],b)},remove:function(a,b){this.oneShot_("remove",[a],b)},find:function(a,b){this.oneShot_("find",[a],b)},removeAll:function(a,b){var c=!(!a||!a.remove),d=afuture();return this.asend(function(b){c&&b&&a.remove&&b.forEach(a.remove),a&&a.eof&&a.eof(),d.set()},{subject:self.subject,method:"removeAll",params:[c,b]}),d},select:function(a,b){a=a||[];var c=afuture(),d=this;if(a.model_||Array.isArray(a))this.asend(function(b){b||a&&a.error&&a.error(),c.set(b||a)},{subject:d.subject,method:"select",params:[a,b]});else{var e=this.createFlowControl_();this.asend(function(b){if(!b)return a&&a.error&&a.error(""),void c.set(a);for(var d=0;d<b.length&&!e.stopped;d++){if(e.errorEvt){a.error&&a.error(e.errorEvt);break}a.put&&a.put(b[d],null,e)}a.eof&&a.eof(),c.set(a)},{subject:d.subject,method:"select",params:[[],b]})}return c.get}}}),defineProperties(Array.prototype,{diff:function(a){for(var b=a.slice(0),c=[],d=0;d<this.length;d++){for(var e=0;e<b.length;e++)if(0==this[d].compareTo(b[e])){b.splice(e,1),e--;break}e==b.length&&c.push(this[d])}return{added:b,removed:c}}}),FOAModel({name:"SplitDAO",extendsModel:"AbstractDAO",properties:[{model_:"StringProperty",name:"activeQuery"},{name:"model",label:"Model",type:"Model",hidden:!0,required:!0},{name:"local",type:"DAO",mode:"read-only",hidden:!0,required:!0},{name:"remote",type:"DAO",mode:"read-only",hidden:!0,required:!0}],methods:{init:function(){this.SUPER()},put:function(a,b){this.local.put(a,b)},remove:function(a,b){this.local.remove(a,b)},find:function(a,b){this.local.find(a,b)},select:function(a,b){var c=b.query&&b.query.toSQL()||"";if(c!==this.activeQuery){this.activeQuery=c,console.log("new Query");var d=this.buf=MDAO.create({model:this.model});b&&b.order&&this.buf.addIndex(b.order),this.local.select(d,b.query?{query:b.query}:{})(function(){d.select(a,b),this.remote.select(d,b)(function(){d===this.buf&&this.notify_("put")})}.bind(this))}else this.buf.select(a,b)}}}),FOAModel({name:"DelayedDAO",extendsModel:"ProxyDAO",properties:[{model_:"IntProperty",name:"initialDelay"},{model_:"IntProperty",name:"rowDelay"}],methods:{select:function(a,b){var c=0,d={__proto__:a,put:function(){var b=arguments;setTimeout(function(){a.put.apply(a,b)},this.rowDelay*++c)}.bind(this)};setTimeout(function(){this.delegate.select(d,b)}.bind(this),this.initialDelay)}}});var NOT_FOUND={cost:0,execute:function(){},toString:function(){return"no-match(cost=0)"}},NO_PLAN={cost:Number.MAX_VALUE,execute:function(){},toString:function(){return"no-plan"}},ValueIndex={put:function(a,b){return b},remove:function(){return void 0},plan:function(){var a={cost:1,execute:function(a,b){b.put(a)},toString:function(){return"unique"}};return function(){return a}}(),get:function(a){return a},select:function(a,b,c){if(c){if(c.query&&!c.query.f(a))return;if("skip"in c&&c.skip-->0)return;if("limit"in c&&c.limit--<1)return}b.put(a)},selectReverse:function(a,b,c){this.select(a,b,c)},size:function(){return 1},toString:function(){return"value"}},KEY=0,VALUE=1,SIZE=2,LEVEL=3,LEFT=4,RIGHT=5,TreeIndex={create:function(a,b){return b=b||ValueIndex,{__proto__:this,prop:a,tail:b,selectCount:0}},bulkLoad:function(a){if(this.tail===ValueIndex)return a.sort(toCompare(this.prop)),this.bulkLoad_(a,0,a.length-1);for(var b=void 0,c=0;c<a.length;c++)b=this.put(b,a[c]);return b},bulkLoad_:function(a,b,c){if(b>c)return void 0;var d=b+Math.floor((c-b+1)/2),e=this.put(void 0,a[d]);return e[LEFT]=this.bulkLoad_(a,b,d-1),e[RIGHT]=this.bulkLoad_(a,d+1,c),e[SIZE]+=this.size(e[LEFT])+this.size(e[RIGHT]),e},dedup:function(a,b){a[this.prop.name]=b},maybeClone:function(a){return a&&this.selectCount>0?a.clone():a},put:function(a,b){return this.putKeyValue(a,this.prop.f(b),b)},putKeyValue:function(a,b,c){if(!a)return[b,this.tail.put(null,c),1,1];a=this.maybeClone(a);var d=this.compare(a[KEY],b);if(0===d)this.dedup(c,a[KEY]),a[SIZE]-=this.tail.size(a[VALUE]),a[VALUE]=this.tail.put(a[VALUE],c),a[SIZE]+=this.tail.size(a[VALUE]);else{var e=d>0?LEFT:RIGHT;a[e]&&(a[SIZE]-=a[e][SIZE]),a[e]=this.putKeyValue(a[e],b,c),a[SIZE]+=a[e][SIZE]}return this.split(this.skew(a))},skew:function(a){if(a&&a[LEFT]&&a[LEFT][LEVEL]===a[LEVEL]){var b=this.maybeClone(a[LEFT]);return a[LEFT]=b[RIGHT],b[RIGHT]=a,this.updateSize(a),this.updateSize(b),b}return a},updateSize:function(a){a[SIZE]=this.size(a[LEFT])+this.size(a[RIGHT])+this.tail.size(a[VALUE])},split:function(a){if(a&&a[RIGHT]&&a[RIGHT][RIGHT]&&a[LEVEL]===a[RIGHT][RIGHT][LEVEL]){var b=this.maybeClone(a[RIGHT]);return a[RIGHT]=b[LEFT],b[LEFT]=a,b[LEVEL]++,this.updateSize(a),this.updateSize(b),b}return a},remove:function(a,b){return this.removeKeyValue(a,this.prop.f(b),b)},removeKeyValue:function(a,b,c){if(!a)return a;a=this.maybeClone(a);var d=this.compare(a[KEY],b);if(0===d){if(a[SIZE]-=this.tail.size(a[VALUE]),a[VALUE]=this.tail.remove(a[VALUE],c),a[VALUE])return a[SIZE]+=this.tail.size(a[VALUE]),a;if(!a[LEFT]&&!a[RIGHT])return void 0;var e=a[LEFT]?LEFT:RIGHT,f=e===LEFT?this.predecessor(a):this.successor(a);a[KEY]=f[KEY],a[VALUE]=f[VALUE],a[e]=this.removeNode(a[e],f[KEY])}else{var e=d>0?LEFT:RIGHT;a[SIZE]-=this.size(a[e]),a[e]=this.removeKeyValue(a[e],b,c),a[SIZE]+=this.size(a[e])}return a=this.skew(this.decreaseLevel(a)),a[RIGHT]&&(a[RIGHT]=this.skew(this.maybeClone(a[RIGHT])),a[RIGHT][RIGHT]&&(a[RIGHT][RIGHT]=this.skew(this.maybeClone(a[RIGHT][RIGHT])))),a=this.split(a),a[RIGHT]=this.split(this.maybeClone(a[RIGHT])),a},removeNode:function(a,b){if(!a)return a;a=this.maybeClone(a);var c=this.compare(a[KEY],b);if(0===c)return a[LEFT]?a[LEFT]:a[RIGHT];var d=c>0?LEFT:RIGHT;return a[SIZE]-=this.size(a[d]),a[d]=this.removeNode(a[d],b),a[SIZE]+=this.size(a[d]),a},predecessor:function(a){if(!a[LEFT])return a;for(a=a[LEFT];a[RIGHT];a=a[RIGHT]);return a},successor:function(a){if(!a[RIGHT])return a;for(a=a[RIGHT];a[LEFT];a=a[LEFT]);return a},decreaseLevel:function(a){var b=Math.min(a[LEFT]?a[LEFT][LEVEL]:0,a[RIGHT]?a[RIGHT][LEVEL]:0)+1;return b<a[LEVEL]&&(a[LEVEL]=b,a[RIGHT]&&b<a[RIGHT][LEVEL]&&(a[RIGHT]=this.maybeClone(a[RIGHT]),a[RIGHT][LEVEL]=b)),a},get:function(a,b){if(!a)return void 0;var c=this.compare(a[KEY],b);return 0===c?a[VALUE]:this.get(c>0?a[LEFT]:a[RIGHT],b)},select:function(a,b,c){if(a){if(c){if("limit"in c&&c.limit<=0)return;var d=this.size(a);if(c.skip>=d&&!c.query)return void(c.skip-=d)}this.select(a[LEFT],b,c),this.tail.select(a[VALUE],b,c),this.select(a[RIGHT],b,c)}},selectReverse:function(a,b,c){if(a){if(c){if("limit"in c&&c.limit<=0)return;var d=this.size(a);if(c.skip>=d)return void(c.skip-=d)}this.selectReverse(a[RIGHT],b,c),this.tail.selectReverse(a[VALUE],b,c),this.selectReverse(a[LEFT],b,c)}},findPos:function(a,b,c){if(!a)return 0;var d=this.compare(a[KEY],b);return 0===d?c?this.size(a[LEFT]):this.size(a)-this.size(a[RIGHT]):d>0?this.findPos(a[LEFT],b,c):this.findPos(a[RIGHT],b,c)+this.size(a)-this.size(a[RIGHT])},size:function(a){return a?a[SIZE]:0},compare:function(a,b){return this.prop.compareProperty(a,b)},plan:function(a,b,c){var d=c&&c.query;if(d===FALSE)return NOT_FOUND;if(!d&&b.model_===CountExpr){var e=this.size(a);return{cost:0,execute:function(a,b){b.count+=e},toString:function(){return"short-circuit-count("+e+")"}}}var f=this.prop,g=function(a){if(d){if(d.model_===a&&d.arg1===f){var b=d.arg2;return d=void 0,b}if(d.model_===AndExpr)for(var c=0;c<d.args.length;c++){var e=d.args[c];if(e.model_===a&&e.arg1===f)return d=d.clone(),d.args[c]=TRUE,d=d.partialEval(),d===TRUE&&(d=null),e.arg2}}return void 0},h=this,i=g(InExpr);if(i&&Math.log(this.size(a))/Math.log(2)*i.length<this.size(a)){var j=i,k=[],l=[],m=1,n={};d&&(n.query=d),"limit"in c&&(n.limit=c.limit),"skip"in c&&(n.skip=c.skip),"order"in c&&(n.order=c.order);for(var o=0;o<j.length;o++){var p=this.get(a,j[o]);if(p){var q=this.tail.plan(p,b,n);m+=q.cost,k.push(q),l.push(p)}}return 0==k.length?NOT_FOUND:{cost:1+m,execute:function(a,b){for(var c=0;c<k.length;c++)k[c].execute(l[c],b,n)},toString:function(){return"IN(key="+f.name+", size="+l.length+")"}}}if(i=g(EqExpr),void 0!=i){var r=i.f(),p=this.get(a,r);if(!p)return NOT_FOUND;var n={};d&&(n.query=d),"limit"in c&&(n.limit=c.limit),"skip"in c&&(n.skip=c.skip),"order"in c&&(n.order=c.order);var q=this.tail.plan(p,b,n);return{cost:1+q.cost,execute:function(a,b){q.execute(p,b,n)},toString:function(){return"lookup(key="+f.name+", cost="+this.cost+(d&&d.toSQL?", query: "+d.toSQL():"")+") "+q.toString()}}}if(i=g(GtExpr),void 0!=i){var r=i.f(),s=this.findPos(a,r,!1),n={skip:(c&&c.skip||0)+s};d&&(n.query=d),"limit"in c&&(n.limit=c.limit),"order"in c&&(n.order=c.order),c=n}if(i=g(GteExpr),void 0!=i){var r=i.f(),s=this.findPos(a,r,!0),n={skip:(c&&c.skip||0)+s};d&&(n.query=d),"limit"in c&&(n.limit=c.limit),"order"in c&&(n.order=c.order),c=n}if(i=g(LtExpr),void 0!=i){var r=i.f(),s=this.findPos(a,r,!0),n={limit:s-(c&&c.skip)||0};d&&(n.query=d),"limit"in c&&(n.limit=Math.min(c.limit,n.limit)),"skip"in c&&(n.skip=c.skip),"order"in c&&(n.order=c.order),c=n}if(i=g(LteExpr),void 0!=i){var r=i.f(),s=this.findPos(a,r,!1),n={limit:s-(c&&c.skip)||0};d&&(n.query=d),"limit"in c&&(n.limit=Math.min(c.limit,n.limit)),"skip"in c&&(n.skip=c.skip),"order"in c&&(n.order=c.order),c=n}var m=this.size(a),t=!1,u=!1;return c&&c.order&&(c.order===f||(DescExpr.isInstance(c.order)&&c.order.arg1===f?u=!0:(t=!0,m*=Math.log(m)/Math.log(2)))),c&&!t&&(c.skip&&(m-=c.skip),c.limit&&(m=Math.min(m,c.limit))),{cost:m,execute:function(){if(t){var d=[];h.selectCount++,h.select(a,d,{query:c.query}),h.selectCount--,d.sort(toCompare(c.order));var e=c.skip||0,f=Number.isFinite(c.limit)?c.limit:d.length;f+=e,f=Math.min(d.length,f);for(var g=e;f>g;g++)b.put(d[g])}else h.selectCount++,u?h.selectReverse(a,b,c):h.select(a,b,c),h.selectCount--},toString:function(){return"scan(key="+f.name+", cost="+this.cost+(d&&d.toSQL?", query: "+d.toSQL():"")+")"}}},toString:function(){return"TreeIndex("+this.prop.name+", "+this.tail+")"}},CITreeIndex={__proto__:TreeIndex,create:function(a,b){return b=b||ValueIndex,{__proto__:this,prop:a,tail:b}},put:function(a,b){return this.putKeyValue(a,this.prop.f(b).toLowerCase(),b)},remove:function(a,b){return this.removeKeyValue(a,this.prop.f(b).toLowerCase(),b)}},SetIndex={__proto__:TreeIndex,create:function(a,b){return b=b||ValueIndex,{__proto__:this,prop:a,tail:b}},dedup:function(){},put:function(a,b){for(var c=this.prop.f(b),d=0;d<c.length;d++)a=this.putKeyValue(a,c[d],b);return a},remove:function(a,b){for(var c=this.prop.f(b),d=0;d<c.length;d++)a=this.removeKeyValue(a,c[d],b);return a}},AltIndex={GOOD_ENOUGH_PLAN:10,create:function(){return{__proto__:this,delegates:argsToArray(arguments)}},addIndex:function(a,b){var c=[];return this.plan(a,c).execute(a,c),a.push(b.bulkLoad(c)),this.delegates.push(b),this},bulkLoad:function(a){for(var b=0;b<this.delegates.length;b++)this.root[b]=this.delegates[b].bulkLoad(a)},get:function(a,b){return this.delegates[0].get(a[0],b)},put:function(a,b){a=a||[];for(var c=0;c<this.delegates.length;c++)a[c]=this.delegates[c].put(a[c],b);return a},remove:function(a,b){a=a||[];for(var c=0;c<this.delegates.length;c++)a[c]=this.delegates[c].remove(a[c],b);return a},plan:function(a,b,c){for(var d,e=0,f=0;f<this.delegates.length;f++){var g=this.delegates[f].plan(a[f],b,c);if(g.cost<=AltIndex.GOOD_ENOUGH_PLAN){e=f,d=g;break}(!d||g.cost<d.cost)&&(e=f,d=g)}return{__proto__:d,execute:function(b,c,f){d.execute(a[e],c,f)}}},size:function(a){return this.delegates[0].size(a[0])},toString:function(){return"Alt("+this.delegates.join(",")+")"}},mLangIndex={create:function(a){return{__proto__:this,mlang:a,PLAN:{cost:0,execute:function(a,b){b.copyFrom(a)},toString:function(){return"mLangIndex("+this.s+")"}}}},bulkLoad:function(a){return a.select(this.mlang),this.mlang},put:function(a,b){return a=a||this.mlang.clone(),a.put(b),a},remove:function(a,b){return a=a||this.mlang.clone(),a.remove&&a.remove(b),a},size:function(){return Number.MAX_VALUE},plan:function(a,b,c){return c&&c.query?NO_PLAN:b.model_&&a.model_===b.model_&&a.arg1===b.arg1?(this.PLAN.s=a,this.PLAN):NO_PLAN},toString:function(){return"mLangIndex("+this.mlang+")"}},AutoIndex={create:function(a){return{__proto__:this,properties:{id:!0},mdao:a}},put:function(a){return a},remove:function(a){return a},bulkLoad:function(){return"auto"},addIndex:function(a){DescExpr.isInstance(a)&&(a=a.arg1),console.log("Adding AutoIndex : ",a.name),this.properties[a.name]=!0,this.mdao.addIndex(a)},plan:function(a,b,c){return c&&(c.order&&Property.isInstance(c.order)&&!this.properties[c.order.name]?this.addIndex(c.order):c.query),NO_PLAN},toString:function(){return"AutoIndex()"}},MDAO=Model.create({extendsModel:"AbstractDAO",name:"MDAO",label:"Indexed DAO",properties:[{name:"model",type:"Model",required:!0},{model_:"BooleanProperty",name:"autoIndex",defaultValue:!1}],methods:{init:function(){this.SUPER(),this.map={},this.index=TreeIndex.create(this.model.getProperty(this.model.ids[0])),this.autoIndex&&this.addRawIndex(AutoIndex.create(this))},addIndex:function(){for(var a=argsToArray(arguments),b=0;b<this.model.ids.length;b++)if(a.push(this.model.getProperty(this.model.ids[b])),!a[a.length-1])throw"Undefined index property";return this.addUniqueIndex.apply(this,a)},addUniqueIndex:function(){for(var a=ValueIndex,b=arguments.length-1;b>=0;b--){var c=arguments[b],d="Array[]"==c.type?SetIndex:TreeIndex;a=d.create(c,a)}return this.addRawIndex(a)},addRawIndex:function(a){return this.index.delegates||(this.index=AltIndex.create(this.index),this.root=[this.root]),this.index.addIndex(this.root,a),this},bulkLoad:function(a,b){var c=this;a.select({__proto__:[],eof:function(){c.root=c.index.bulkLoad(this),b&&b.eof&&b.eof()}})},put:function(a,b){var c=this.map[a.id];c?(this.root=this.index.put(this.index.remove(this.root,c),a),this.notify_("remove",[c])):this.root=this.index.put(this.root,a),this.map[a.id]=a,this.notify_("put",[a]),b&&b.put&&b.put(a)},findObj_:function(a,b){var c=this.map[a];c?b.put&&b.put(c):b.error&&b.error("find",a)},find:function(a,b){if(!a)return void(b&&b.error&&b.error("missing key"));if(!a.f)return void this.findObj_(a,b);var c=!1;this.where(a).limit(1).select({put:function(a){c=!0,b&&b.put&&b.put(a)},eof:function(){c||b&&b.error&&b.error("find",a)}})},remove:function(a,b){if(!a)return void(b&&b.error&&b.error("missing key"));var c=void 0!==a.id&&""!==a.id?a.id:a,d=this;this.find(c,{put:function(a){d.root=d.index.remove(d.root,a),delete d.map[a.id],d.notify_("remove",[a]),b&&b.remove&&b.remove(a)},error:function(){b&&b.error&&b.error("remove",a)}})},removeAll:function(a,b){b||(b={}),b.query||(b.query=TRUE);var c=afuture();return this.where(b.query).select([])(function(b){for(var d=0;d<b.length;d++)this.root=this.index.remove(this.root,b[d]),delete this.map[b[d].id],this.notify_("remove",[b[d]]),a&&a.remove&&a.remove(b[d]);a&&a.eof&&a.eof(),c.set()}.bind(this)),c.get},select:function(a,b){if(a=a||[],b&&(b={__proto__:b}),DescribeExpr.isInstance(a)){var c=this.index.plan(this.root,a.arg1,b);a.plan="cost: "+c.cost+", "+c.toString()}else{var c=this.index.plan(this.root,a,b);c.execute(this.root,a,b)}return a&&a.eof&&a.eof(),aconstant(a)},toString:function(){return"MDAO("+this.model.name+","+this.index+")"}}});FOAModel({name:"StackView",extendsModel:"View",properties:[{name:"stack",factory:function(){return[]}},{name:"redo",factory:function(){return[]}},{name:"className",defaultValue:"stackView"},{name:"tagName",defaultValue:"div"},{model_:"BooleanProperty",name:"sliderOpen"}],actions:[{name:"back",label:"<",help:"Go to previous view",isEnabled:function(){return this.stack.length>1||this.sliderOpen},action:function(){this.sliderOpen?(this.sliderOpen=!1,this.dimmer$().style.zIndex=-1,this.dimmer$().style.opacity=-1,this.slideArea$().style.transition="left 0.2s cubic-bezier(0.4, 0.0, 1, 1)",this.slideArea$().style.left="-304px",setTimeout(function(){this.slideArea$().style.transition="",this.slideArea$().innerHTML=""}.bind(this),300)):(this.redo.push(this.stack.pop()),this.pushView(this.stack.pop(),void 0,!0),this.propertyChange("stack",this.stack,this.stack))}},{name:"forth",label:">",help:"Undo the previous back.",action:function(){this.pushView(this.redo.pop()),this.propertyChange("stack",this.stack,this.stack)}}],methods:{dimmer$:function(){return this.$.querySelector(".stackview-dimmer")},navBar$:function(){return this.$.querySelector(".stackview_navbar")},navActions$:function(){return this.$.querySelector(".stackview_navactions")},slideArea$:function(){return this.$.querySelector(".stackview-slidearea")},viewArea$:function(){return this.$.querySelector(".stackview-viewarea")},previewArea$:function(){return this.$.querySelector(".stackview-previewarea")},initHTML:function(){this.SUPER(),this.dimmer$().addEventListener("click",this.back.bind(this))},setTopView:function(a){this.stack=[],this.pushView(a)},updateNavBar:function(){for(var a=[],b=0;b<this.stack.length;b++){var c=this.stack[b];0!=a.length&&a.push(" > "),a.push(c.stackLabel)}this.navBar$().innerHTML=a.join("")},slideView:function(a){this.sliderOpen=!0,this.redo.length=0,this.setPreview(null),this.slideArea$().style.left=-2e3;
var b=this.X.window.getComputedStyle(this.slideArea$());this.slideArea$().innerHTML=a.toHTML(),a.initHTML(),this.slideArea$().style.transition="",this.slideArea$().style.left=-toNum(b.width),setTimeout(function(){this.dimmer$().style.zIndex=3,this.dimmer$().style.opacity=.4,this.slideArea$().style.transition="left 0.2s cubic-bezier(0.0, 0.0, 0.2, 1)",this.slideArea$().style.left="0"}.bind(this),10)},pushView:function(a,b,c){c||(this.redo.length=0),this.setPreview(null),a.stackLabel=b||a.stackLabel||a.label,this.stack.push(a),this.viewArea$().innerHTML=a.toHTML(),this.updateNavBar(),a.stackView=this,a.initHTML(),this.propertyChange("stack",this.stack,this.stack)},setPreview:function(a){return a?(this.viewArea$().parentNode.width="65%",this.previewArea$().innerHTML=a.toHTML(),void a.initHTML()):(this.viewArea$().parentNode.width="100%",void(this.previewArea$().innerHTML=""))}},templates:[function(){}]}),FOAModel({name:"MementoMgr",properties:[{name:"memento"},{name:"stack",factory:function(){return[]}},{name:"redo",factory:function(){return[]}}],actions:[{name:"back",label:" <-- ",help:"Go to previous view",isEnabled:function(){return this.stack.length},action:function(){this.dumpState("preBack"),this.redo.push(this.memento.value),this.restore(this.stack.pop()),this.propertyChange("stack","",this.stack),this.propertyChange("redo","",this.redo),this.dumpState("postBack")}},{name:"forth",label:" --> ",help:"Undo the previous back.",isEnabled:function(){return this.redo.length},action:function(){this.dumpState("preForth"),this.remember(this.memento.value),this.restore(this.redo.pop()),this.propertyChange("stack","",this.stack),this.propertyChange("redo","",this.redo),this.dumpState("postForth")}}],listeners:[{name:"onMementoChange",code:function(a,a,b){this.ignore_||(this.remember(b),this.redo=[],this.propertyChange("redo","",this.redo))}}],methods:{init:function(){this.SUPER(),this.memento.addListener(this.onMementoChange)},remember:function(a){this.dumpState("preRemember"),this.stack.push(a),this.propertyChange("stack","",this.stack),this.dumpState("postRemember")},restore:function(a){this.dumpState("restore"),this.ignore_=!0,this.memento.set(a),this.ignore_=!1},dumpState:function(){}}}),FOAModel({name:"DAOController",label:"DAO Controller",extendsModel:"View",properties:[{name:"selection"},{name:"model",postSet:function(a,b){this.X.model=b}},{model_:"DAOProperty",name:"dao",label:"DAO",view:"TableView",postSet:function(a,b){this.X.DAO=b}},{name:"value",help:"Alias value property to set the dao.",postSet:function(a,b){a&&a.removeListener(this.onValueChange),b.addListener(this.onValueChange),this.onValueChange()}},{model_:"BooleanProperty",name:"useSearchView",defaultValue:!1,postSet:function(a,b){b&&this.addDecorator(SearchBorder.create({model:this.model,dao:this.dao}))}}],actions:[{name:"new",help:"Create a new record.",action:function(){var a=DAOCreateController.create({model:this.model,dao:this.dao}).addDecorator(ActionBorder.create({actions:DAOCreateController.actions}));a.parentController=this,this.X.stack.pushView(a,"New")}},{name:"edit",help:"Edit the current record.","default":"true",action:function(){this.selection=this.daoView.selection.get();for(var a=this.selection,b=DAOUpdateController.actions.slice(0),c=0;c<this.model.actions.length;c++){var d=this.model.actions[c],e=Action.create(d);e.action=function(b){return function(){b.call(a)}}(d.action),b.push(e)}console.log(["selection: ",this.selection]);var f=DAOUpdateController.create({obj:this.selection,model:this.model,dao:this.dao}).addDecorator(ActionBorder.create({actions:DAOUpdateController.actions}));this.X.stack.pushView(f,"Edit")}},{name:"delete",help:"Delete the current record.",action:function(){this.selection=this.daoView.selection.get();var a=this;this.dao.remove(this.selection,{remove:function(){a.refresh()}})}}],methods:{initHTML:function(){this.SUPER(),this.daoView.unsubscribe(this.daoView.DOUBLE_CLICK,this.onDoubleClick),this.daoView.subscribe(this.daoView.DOUBLE_CLICK,this.onDoubleClick),this.daoView.selection.addListener(this.onSelection)},refresh:function(){this.dao=this.dao}},templates:[{name:"toHTML",template:"$$dao"}],listeners:[{name:"onDoubleClick",code:function(){for(var a=0;a<this.model_.actions.length;a++){var b=this.model_.actions[a];if(b.default){b.action.call(this);break}}}},{name:"onSelection",code:function(){var a=this.daoView.selection.get();a&&this.X.stack.setPreview(DetailView.create({model:this.model,value:this.daoView.selection}))}},{name:"onValueChange",code:function(){this.dao=this.value.value}}]}),FOAModel({name:"DAOCreateController",label:"DAO Create",extendsModel:"View",properties:[{name:"obj",label:"New Object"},{name:"model"},{name:"dao",label:"DAO"}],actions:[{name:"save",label:"Create",help:"Create a new record.",isAvailable:function(){return!0},isEnabled:function(){return!0},action:function(){var a=this;this.dao.put(this.obj,{put:function(b){console.log("Created: ",b),a.X.stack.back()},error:function(){console.error("Error creating value: ",arguments)}})}},{name:"cancel",help:"Cancel creation.",isAvailable:function(){return!0},isEnabled:function(){return!0},action:function(){this.X.stack.back()}},{name:"help",help:"View help.",isAvailable:function(){return!0},isEnabled:function(){return!0},action:function(){var a=this.obj.model_,b=HelpView.create(a);this.X.stack.pushView(b)}}],methods:{newObj:function(a,b){var c={__proto__:a.model_,create:function(){return a}},d=DAOCreateController.create({model:c,dao:b}).addDecorator(ActionBorder.create({actions:DAOCreateController.actions}));d.parentController=this,this.X.stack.pushView(d)},init:function(){var a=this.model;this.SUPER(),this.model=a,this.obj=this.model.create(),this.view=DetailView.create({model:this.model,value:this.propertyValue("obj")})},toHTML:function(){return this.view.toHTML()},initHTML:function(){this.SUPER(),this.view.initHTML()}}}),FOAModel({name:"DAOUpdateController",label:"DAO Update",extendsModel:"View",properties:[{name:"obj",label:"Edited Object"},{name:"model"},{name:"dao",label:"DAO"}],actions:[{name:"save",help:"Save updates.",isAvailable:function(){return!0},isEnabled:function(){return!0},action:function(){var a=this,b=this.obj;this.dao.put(b,{put:function(){console.log("Saving: ",b.toJSON()),a.X.stack.back()},error:function(){console.error("Error saving",arguments)}})}},{name:"copy",help:"Create a new object which is a copy of this one.",isAvailable:function(){return!0},isEnabled:function(){return!0},action:function(){}},{name:"cancel",help:"Cancel update.",isAvailable:function(){return!0},isEnabled:function(){return!0},action:function(){this.X.stack.back()}},{name:"help",help:"View help.",isAvailable:function(){return!0},isEnabled:function(){return!0},action:function(){var a=this.obj.model_,b=HelpView.create(a);this.X.stack.pushView(b)}}],methods:{init:function(){var a=this.model;this.SUPER(),this.model=a,this.view=FOAM({model_:"AlternateView",selection:"GUI",views:[{model_:"ViewChoice",label:"GUI",view:"DetailView"},{model_:"ViewChoice",label:"JS",view:"JSView"},{model_:"ViewChoice",label:"XML",view:"XMLView"}]}),this.view.value.set(this.obj)},toHTML:function(){return this.view.toHTML()},initHTML:function(){this.SUPER(),this.view.initHTML()}}}),FOAModel({name:"ThreePaneController",label:"ThreePaneController",extendsModel:"View",properties:[{name:"model",type:"Model",required:!0},{name:"daoListener",hidden:!0,factory:function(){return{put:this.onDaoUpdate,remove:this.onDaoUpdate}},postSet:function(a,b){this.dao&&(this.dao.unlisten(a),this.dao.listen(b))}},{name:"dao",type:"DAO",required:!0,postSet:function(a,b){a&&a.unlisten(this.daoListener),b.listen(this.daoListener)}},{name:"queryParser",factory:function(){return QueryParserFactory(this.model)}},{name:"searchField",type:"TextFieldView",factory:function(){return TextFieldView.create({name:"search",type:"search",onKeyMode:!0,displayWidth:95})},postSet:function(a,b){a&&a.value.addListener(this.performQuery),b.value.addListener(this.performQuery)}},{name:"countField",type:"TextFieldView",factory:function(){return TextFieldView.create({name:"count",mode:"read-only",displayWidth:40})}},{name:"searchChoice",type:"ListChoiceView",required:!0,postSet:function(a,b){a&&a.value.removeListener(this.performQuery),b.value.addListener(this.performQuery)}},{model_:"IntProperty",name:"width",defaultValue:500},{model_:"IntProperty",name:"height",defaultValue:500},{model_:"IntProperty",name:"headerHeight",defaultValue:119},{model_:"IntProperty",name:"footerHeight",defaultValue:30},{model_:"IntProperty",name:"maxSearchWidth",defaultValue:160},{model_:"IntProperty",name:"searchWidth",defaultValue:160},{model_:"IntProperty",name:"minThreeColumnWidth",defaultValue:1250},{name:"threeColumnLeftPaneWeight",defaultValue:.45},{name:"table",type:"View",factory:function(){return TableView.create({model:this.model,dao:this.dao,scrollEnabled:!0,rows:20})},postSet:function(a,b){a&&a.scrollbar.removeListener(this.updateCount),b.scrollbar.addListener(this.updateCount),this.addChild(b),this.removeChild(a)}},{name:"toolbar",type:"View",factory:function(){return ToolbarView.create({actions:this.model.actions,value:this.table.selection})},postSet:function(a,b){this.addChild(b),this.removeChild(a)}},{name:"editView",type:"View",factory:function(){return DetailView.create({model:this.model})},postSet:function(a,b){this.addChild(b),this.removeChild(a),a&&a.value&&a.value.removeListener(this.onValueChange),b.value.addListener(this.onValueChange)}}],methods:{init:function(){this.SUPER();var a=this;Events.dynamic(function(){a.headerHeight,a.footerHeight,a.searchWidth,a.minThreeColumnWidth,a.threeColumnLeftPaneWeight},a.layout)},setLogo:function(a){$("logo-"+this.id).src=a},toHTML:function(){return'<div style="width: 100%; height: 100%;" id="'+this.id+'">\n<table class="header" id="header-'+this.id+'">\n  <tr>\n  <td style="height: 49px; padding: 5px 0px">\n    <img id="logo-'+this.id+'" height="49" style="margin-left: 10px" src="images/logo.png">\n  </td>\n  <td width="5%"></td>\n  <td width="45"><img src="images/search-icon.png" style="vertical-align:middle;"></td>\n  <td width=65% valign2="bottom">\n  <div class="titleBar">\n'+this.searchField.toHTML()+'  </div>\n  </td>\n  <td width="5%"></td>\n  <td width="20%" align=center valign2="bottom">\n'+this.countField.toHTML()+'  </td>\n  <td width="10%"></td>\n  <td align="right">\n    <div><img id="settings-'+this.id+'" src="images/settings.svg"> &nbsp;</div>\n  </td>\n  </tr>\n</table>\n<span class="toolbar" id="toolbar-'+this.id+'">'+this.toolbar.toHTML()+'</span>\n<div id="search-'+this.id+'" style="position:absolute;background-color:#fff;overflow-y:auto;overflow-x:hidden">\n  <span class="searchChoice">'+this.searchChoice.toHTML()+'</span>\n</div>\n<div class="browse" id="browse-'+this.id+'" style="position:absolute;background-color:#FFF;float:left;">'+this.table.toHTML()+'</div>\n<div class="edit" id="edit-'+this.id+'" style="position:absolute;position:absolute;background-color:#FFF;overflow:scroll;">\n'+this.editView.toHTML()+'</div>\n<div id="footer-'+this.id+'" style="position:absolute;text-align:right;padding-top:3px;width:100%"> \n  <a href="https://code.google.com/p/foam-framework/" style="text-decoration: none" target="_blank">\n  <font size=-1 face="catull" style="padding-left:10px;text-shadow:rgba(64,64,64,0.3) 3px 3px 4px;">\n  <font color="#3333FF">F</font><font color="#FF0000">O</font><font color="#ddaa00">A</font><font color="#33CC00">M</font>\n\n  <font color2="#555555"> POWERED</font></a>\n</div>\n</div>'},initHTML:function(){var a=this,b=void 0;this.searchField.initHTML(),this.searchChoice.initHTML(),this.table.initHTML(),this.editView.initHTML(),this.countField.initHTML(),this.toolbar.initHTML(),this.searchField.$.style.display="table-cell",this.searchField.$.style.width="100%",this.table.selection.addListener(EventService.merged(function(c){{var d=c.get();a.editView.value.get()}d!==b&&a.editView.value.set(d)},200)),this.model.OPEN&&Action.isInstance(this.model.OPEN)&&this.table.hardSelection.addListener(function(a){a.get().open()})}},listeners:[{name:"onValueChange",code:function(){this.editView.initHTML()}},{name:"performQuery",code:function(){var a=AND(this.queryParser.parseString(this.searchChoice.value.get())||TRUE,this.queryParser.parseString(this.searchField.value.get())||TRUE).partialEval();console.log("query: ",a.toMQL()),this.table.scrollbar.value=0,this.table.model=this.model,this.table.dao=this.dao.where(a)}},{name:"layout",isMerged:!0,code:function(){if(this.$){var a=1==this.table.scrollbar.size,b=this.$.offsetWidth,c=this.$.offsetHeight,d=c-this.headerHeight-this.footerHeight,e=b-this.searchWidth-1;pos($("search-"+this.id),this.headerHeight,null,this.maxSearchWidth,d),b>this.minThreeColumnWidth?(pos($("browse-"+this.id),this.headerHeight,this.searchWidth+1,e*this.threeColumnLeftPaneWeight,d),pos($("edit-"+this.id),this.headerHeight,this.searchWidth+1+e*this.threeColumnLeftPaneWeight,.55*e-10,d-10)):(pos($("browse-"+this.id),this.headerHeight,this.searchWidth+1,e,d/2-4),pos($("edit-"+this.id),a?this.headerHeight:toNum($("browse-"+this.id).style.top)+toNum($("browse-"+this.id).style.height),this.searchWidth+1,e,a?d:d/2)),pos($("footer-"+this.id),c-this.footerHeight+10,null,b,this.footerHeight)}}},{name:"onDaoUpdate",isMerged:100,code:function(){var a=this;this.table.selection.get()?this.dao.find(this.table.selection.get().id,{put:function(b){a.table.selection.set(b),a.table.dao=a.table.dao}}):this.table.dao=this.table.dao}},{name:"updateCount",isMerged:!0,code:function(){var a=this;this.dao.select(COUNT())(function(b){a.countField.value.set(a.table.scrollbar.size+" of "+b.count+" selected")})}}]});var ProtoBufGrammar={__proto__:grammar,START:sym("proto"),d:range("0","9"),w:alt(sym("d"),range("a","z"),range("A","Z"),"_"),a:alt(range("a","z"),range("A","Z")),proto:repeat(alt(sym("message"),sym("extend"),sym("enum"),sym("import"),sym("package"),sym("option"),sym("syntax"),";")),syntax:seq("syntax","=",sym("strLit"),";"),"import":seq("import",sym("strLit"),";"),"package":seq("package",sym("ident"),";"),option:seq("option",sym("optionBody"),";"),optionBody:seq(sym("ident"),repeat(seq(".",sym("ident"))),"=",sym("constant")),message:seq("message",sym("ident"),sym("messageBody")),extend:seq("extend",sym("userType"),sym("messageBody")),"enum":seq("enum",sym("ident"),"{",repeat(alt(sym("option"),sym("enumField"),";")),"}"),enumField:seq(sym("ident"),"=",sym("sintLit"),";"),service:seq("service",sym("ident"),"{",repeat(seq(sym("option"),sym("rpc")),";"),"}"),rpc:seq("rpc",sym("ident"),"(",sym("userType"),")","returns","(",sym("userType"),")",";"),messageBody:seq("{",repeat(alt(sym("field"),sym("enum"),sym("message"),sym("extend"),sym("extensions"),sym("group"),sym("option"),";")),"}"),group:seq(sym("modifier"),"group",sym("camelIdent"),"=",sym("intLit"),sym("messageBody")),field:seq(sym("modifier"),sym("type"),sym("ident"),"=",sym("intLit"),optional(seq("[",sym("fieldOption"),repeat(",",sym("fieldOption")),"]")),";"),fieldOption:alt(sym("optionBody"),seq("default","=",sym("constant"))),extensions:seq("extensions",sym("intLit"),"to",alt(sym("intLit"),"max"),";"),modifier:alt("required","optional","repeated"),type:alt("double","float","int32","int64","uint32","uint64","sint32","sint64","fixed32","fixed64","sfixed32","sfixed64","bool","string","bytes",sym("userType")),userType:noskip(plus(seq(optional("."),sym("ident")))),constant:alt(sym("ident"),sym("sintLit"),sym("floatLit"),sym("strLit"),sym("boolLit")),ident:seq(sym("a"),repeat(sym("w"))),camelIdent:seq(range("A","Z"),repeat(sym("w"))),intLit:alt(sym("decInt"),sym("hexInt"),sym("octInt")),sintLit:alt(seq(optional(alt("+","-")),sym("decInt")),sym("intLit")),decInt:plus(sym("d")),hexInt:seq("/0",alt("x","X"),plus(alt(range("A","F"),range("a","f"),range("0","9")))),octInt:seq("/0",plus(range("0","7"))),floatLit:seq(seq(sym("decInt"),optional(".",sym("decInt"))),optional(seq(alt("E","e"),optional(alt("+","-")),sym("decInt")))),boolLit:alt("true","false"),strLit:noskip(seq(sym("quote"),repeat(alt(sym("hexEscape"),sym("octEscape"),sym("charEscape"),sym("quoteEscape"),not(sym("quote"),anyChar))),sym("quote"))),quote:alt('"',"'"),hexEscape:seq("\\",alt("x","X"),repeat(alt(range("A","F"),range("a","f"),range("0","9"),void 0,1,2))),octEscape:seq("\\0",repeat(range("0","7"),void 0,1,3)),charEscape:seq("\\",alt("a","b","f","n","r","t","v","?")),quoteEscape:seq('\\"')}.addActions({quoteEscape:function(){return['"']},enumField:function(a){return[a[0],a[2]]},"enum":function(a){for(var b={},c=a[1],d=a[3],e=0;e<d.length;e++){var f=d[e];b[f[0]]=f[1][1]}b.type="Enum",(this.ctx||GLOBAL)[c]=b},userType:function(a){return a[0].join("")},field:function(a){if("repeated"===a[0])return ArrayProperty.create({subType:a[1],name:a[2],prototag:a[4]});var b=Property.create({type:a[1],name:a[2],prototag:a[4],required:"required"===a[0]}),c=(this.ctx||GLOBAL)[b.type];return c&&"Enum"===c.type&&(b.outProtobuf=function(a,b){""!==this.f(a)&&outProtobufPrimitive("int32",this.prototag,this.f(a),b)}),b},message:function(a){for(var b=[],c=0;c<a[2].length;c++)a[2][c]&&Property.isInstance(a[2][c])&&b.push(a[2][c]);var d=Model.create({name:a[1],properties:b});return(this.ctx||GLOBAL)[a[1]]=d,d},messageBody:function(a){return a[1]},ident:function(a){return a[0]+a[1].join("")},decInt:function(a){return parseInt(a.join(""))}});Number.prototype.toVarintString=function(){for(var a="",b=this;b>127;){var c=(127&b|128).toString(16);1==c.length&&(c="0"+c),a+=c,b>>=7}return c=b.toString(16),1==c.length&&(c="0"+c),a+=c};var hexStringCompare=function(){var a="0123456789abcdef";return function(b,c){if(b.length!==c.length)return b.length<c.length?-1:1;for(var d=0;d<b.length;d++){var e=a.indexOf(b[d]),f=a.indexOf(c[d]);if(e!==f)return f>e?-1:1}return 0}}();Property.getPrototype().outProtobuf=function(a,b){""!==this.f(a)&&outProtobufPrimitive(this.type,this.prototag,this.f(a),b)},ArrayProperty.getPrototype().outProtobuf=function(a,b){for(var c,d=this.f(a),e=0;c=d[e];e++)outProtobufPrimitive(this.subType,this.prototag,c,b)},IntProperty.getPrototype().outProtobuf=function(a,b){b(this.prototag<<3);var c=this.f(a);c instanceof String||"string"==typeof c?b.bytestring(c):b.varint(c)};var BinaryPS={create:function(a){var b,c={};a instanceof ArrayBuffer&&(a=new Uint8Array(a));var d={create:function(a,b,e){var f={__proto__:d,pos:a,tail_:b};return f.value=e===c?f.head:e,f},clone:function(){return this.create(this.pos,this.tail_,this.value)},get itail(){return this.tail_?this.tail_:(this.pos++,this.value=this.head,this)},destroy:function(){a=void 0},limit:function(a){var c=b;return b=a,c},get head(){return b&&this.pos>=b?null:this.pos>=a.length?null:a[this.pos]},get tail(){return this.tail_||(this.tail_=this.create(this.pos+1,void 0,c))},setValue:function(a){return this.create(this.pos,this.tail,a)}};return d.create(0,void 0,c)}},BinaryProtoGrammar={__proto__:grammar,parseArrayBuffer:function(a){var b=BinaryPS.create(a),c=this.parse(this.START,b),d=c&&c.value;return b.destroy(),d},"unknown field":alt(protouint32(),protobytes0())};FOAModel({name:"Timer",properties:[{model_:"IntProperty",name:"interval",help:"Interval of time between updating time.",units:"ms",defaultValue:10},{model_:"IntProperty",name:"i",defaultValue:0},{model_:"FloatProperty",name:"timeWarp",defaultValue:1},{model_:"IntProperty",name:"duration",units:"ms",defaultValue:-1},{model_:"FloatProperty",name:"percent",defaultValue:0},{model_:"IntProperty",name:"startTime",defaultValue:0},{model_:"IntProperty",name:"time",help:"The current time in milliseconds since epoch.",preSet:function(a,b){return Math.ceil(b)},defaultValue:0},{model_:"IntProperty",name:"second",help:"The second of the current minute.",defaultValue:0},{model_:"IntProperty",name:"minute",help:"The minute of the current hour.",defaultValue:0},{model_:"IntProperty",name:"hour",help:"The hour of the current day.",defaultValue:0},{name:"isStarted",defaultValue:!1,hidden:!0}],actions:[{name:"start",help:"Start the timer.",isAvailable:function(){return!0},isEnabled:function(){return!this.isStarted},action:function(){this.isStarted=!0,this.tick()}},{name:"step",help:"Step the timer.",isAvailable:function(){return!0},action:function(){this.i++,this.time+=this.interval*this.timeWarp,this.second=this.time/1e3%60<<0,this.minute=this.time/6e4%60<<0,this.hour=this.time/36e5%24<<0}},{name:"stop",help:"Stop the timer.",isAvailable:function(){return!0},isEnabled:function(){return this.isStarted},action:function(){this.isStarted=!1,this.timeout&&(clearTimeout(this.timeout),this.timeout=void 0)}}],listeners:[{name:"tick",isAnimated:!0,code:function(){if(this.timeout=void 0,this.isStarted){var a=this.startTime_||0;this.startTime_=Date.now(),this.interval=Math.min(100,this.startTime_-a),this.step(),this.tick()}}}]}),FOAModel({name:"Binding",properties:[{name:"id",hidden:!0},{name:"value",hidden:!0}]}),FOAModel({name:"PersistentContext",properties:[{name:"dao",label:"DAO",type:"DAO",hidden:!0},{name:"context",hidden:!0},{name:"predicate",type:"Expr",defaultValueFn:function(){return TRUE},hidden:!0}],methods:{manage:function(a,b){b.addListener(EventService.merged(function(){console.log("PersistentContext","updating",a),this.dao.put(Binding.create({id:a,value:JSONUtil.compact.where(this.predicate).stringify(b)}))}.bind(this)))},bindObjects:function(){},bindObject:function(a,b,c){console.log("PersistentContext","binding",a);var d=afuture();return c=c||{},this.context[a]?d.set(this.context[a]):this.dao.find(a,{put:function(b){console.log("PersistentContext","existingInit",a);var e=JSON.parse(b.value);e.__proto__=c;var f=JSONUtil.mapToObj(e);this.context[a]=f,this.manage(a,f),d.set(f)}.bind(this),error:function(){console.log("PersistentContext","newInit",a);var e=b.create(c);this.context[a]=e,this.manage(a,e),d.set(e)}.bind(this)}),d.get}}}),FOAModel({name:"UserInfo",label:"UserInfo",properties:[{model_:"StringProperty",name:"email"}]}),FOAModel({name:"FOAMTouch",properties:["id","startX","startY","x","y",{name:"dx",getter:function(){return this.x-this.startX}},{name:"dy",getter:function(){return this.y-this.startY}},{name:"distance",getter:function(){var a=this.dx,b=this.dy;return Math.sqrt(a*a+b*b)}}],methods:{cancel:function(){},leave:function(){},move:function(a){this.x=a.clientX,this.y=a.clientY}}}),FOAModel({name:"TouchReceiver",properties:["id","element",{name:"delegate",defaultValueFn:function(){var a,b,c=this;return{onTouchStart:function(d){return Object.keys(d).length>1?{drop:!0}:(a=c.propX&&c.propX.get(),b=c.propY&&c.propY.get(),{claim:!0,weight:.8})},onTouchMove:function(d,e){var f=d[e[0]];return c.propX&&c.propX.set(a+f.dx),c.propY&&c.propY.set(b+f.dy),{claim:!0,weight:.8,preventDefault:!0}}}}},"propX","propY",{name:"activeTouches",factory:function(){return{}}}]}),FOAModel({name:"TouchManager",properties:[{name:"touches",factory:function(){return{}}},{name:"receivers",factory:function(){return[]}},{name:"attached",defautValue:!1,model_:"BooleanProperty"}],methods:{TOUCH_START:"touch-start",TOUCH_END:"touch-end",attachHandlers:function(){this.X.window.document.addEventListener("touchstart",this.onTouchStart),this.attached=!0},install:function(a){this.attached||this.attachHandlers(),this.receivers.push(a),a.element.addEventListener("touchstart",this.touchCapture.bind(a),!0)},touchCapture:function(a){for(var b=0;b<a.changedTouches.length;b++){var c=a.changedTouches[b];this.activeTouches[c.identifier]=!0}},notifyReceivers:function(a,b){for(var c=[],d=0;d<b.changedTouches.length;d++)c.push(b.changedTouches[d].identifier);var e=[];for(d=0;d<this.receivers.length;d++){for(var f=!1,g=0;g<c.length;g++)if(this.receivers[d].activeTouches[c[g]]){f=!0;break}if(f){var h=this.receivers[d].delegate,i=h[a].bind(h);i&&e.push(i(this.touches,c))}}var j=-1;for(d=0;d<e.length;d++){var k=e[d];k.drop?this.receivers[d].activeTouches={}:k.claim&&(0>j||k.weight>e[j].weight)&&(j=d)}if(j>=0){for(d=0;d<e.length;d++)d!=j&&(this.receivers[d].activeTouches={});e[j].preventDefault&&b.preventDefault()}else for(d=0;d<e.length;d++)if(!e[d].drop&&e[d].preventDefault){b.preventDefault();break}}},listeners:[{name:"onTouchStart",code:function(a){for(var b=0;b<a.changedTouches.length;b++){var c=a.changedTouches[b];this.touches[c.identifier]?console.warn("Touch start for known touch."):(console.log(c),this.touches[c.identifier]=FOAMTouch.create({id:c.identifier,startX:c.clientX,startY:c.clientY,x:c.clientX,y:c.clientY}))}a.target.addEventListener("touchmove",this.onTouchMove),a.target.addEventListener("touchend",this.onTouchEnd),a.target.addEventListener("touchcancel",this.onTouchCancel),a.target.addEventListener("touchleave",this.onTouchLeave),this.notifyReceivers("onTouchStart",a)}},{name:"onTouchMove",code:function(a){for(var b=0;b<a.changedTouches.length;b++){var c=a.changedTouches[b];this.touches[c.identifier]?this.touches[c.identifier].move(c):console.warn("Touch move for unknown touch.")}this.notifyReceivers("onTouchMove",a)}},{name:"onTouchEnd",code:function(a){for(var b=0;b<a.changedTouches.length;b++){var c=a.changedTouches[b];this.touches[c.identifier]?this.touches[c.identifier].move(c):console.warn("Touch end for unknown touch.")}for(this.notifyReceivers("onTouchEnd",a),b=0;b<a.changedTouches.length;b++)delete this.touches[a.changedTouches[b].identifier]}},{name:"onTouchCancel",code:function(a){for(this.notifyReceivers("onTouchCancel",a),i=0;i<a.changedTouches.length;i++)delete this.touches[a.changedTouches[i].identifier]}},{name:"onTouchLeave",code:function(a){for(this.notifyReceivers("onTouchLeave",a),i=0;i<a.changedTouches.length;i++)delete this.touches[a.changedTouches[i].identifier]}}]}),FOAModel({name:"PieGraph",extendsModel:"CView",properties:[{name:"r",type:"int",view:"IntFieldView",postSet:function(a,b){this.width=this.height=2*b+2},defaultValue:50},{name:"lineColor",type:"String",defaultValue:"white"},{name:"lineWidth",type:"int",defaultValue:1},{name:"colorMap",defaultValue:void 0},{name:"data",type:"Array[float]",factory:function(){return[]}},{name:"groups",label:"Group Data",defaultValue:{Apples:5,Oranges:6,Bananas:4}}],methods:{toCount:function(a){return CountExpr.isInstance(a)?a.count:a},toHSLColor:function(a,b){return"hsl("+Math.floor(360*a/b)+", 95%, 75%)"},toColor:function(a,b,c){return this.colorMap&&this.colorMap[a]||this.toHSLColor(b,c)},paint:function(){var a=this.canvas;if(a){var b=this.x,c=this.y,d=this.r;a.save(),a.translate(b,c);var e=0,f=0;for(var g in this.groups)e+=this.toCount(this.groups[g]),f++;d>10&&(a.fillStyle="lightgray",a.beginPath(),a.arc(d+2,d+2,d,0,2*Math.PI),a.fill()),a.lineWidth=this.lineWidth,a.strokeStyle=this.lineColor;var h=0,i=0;for(var g in this.groups){var j=h,k=this.toCount(this.groups[g]);h+=k/e*2*Math.PI,a.fillStyle=this.toColor(g,i++,f),a.beginPath(),e>k&&a.moveTo(d,d),a.arc(d,d,d,j,h),e>k&&a.lineTo(d,d),a.fill(),a.stroke()}a.restore()}}}}),FOAModel({name:"PieExpr",extendsModel:"GroupByExpr",methods:{toCView:function(){return this.graph_||(this.graph_=PieGraph.create({groups:this.groups,r:50,x:0}),this.graph_.copyFrom(this.opt_args)),this.graph_},toHTML:function(){return this.toCView().toHTML()},initHTML:function(){this.graph_.initHTML(),this.graph_.paint()},write:function(a){a.writeln?a.writeln(this.toHTML()):a.log(this.toHTML()),this.initHTML()},put:function(){this.SUPER.apply(this,arguments),this.graph_&&(this.graph_.groups=this.groups,this.graph_.paint())},remove:function(){this.SUPER.apply(this,arguments),this.graph_&&this.graph_.paint()},clone:function(){var a=PieExpr.create({arg1:this.arg1,arg2:this.arg2.clone()});return a.opt_args=this.opt_args,a}}});var PIE=function(a,b){var c=PieExpr.create({arg1:a,arg2:COUNT()});return c.opt_args=b,c},OAuthXhr={create:function(a,b,c){return a.responseType=b,{__proto__:this,xhr:a,agent:c}},set responseType(a){this.xhr.responseType=a},get responseType(){return this.xhr.responseType},asend:function(a,b,c,d){var e=this,f=!1,g=0;awhile(function(){return!f},aseq(function(a){e.xhr.open(b,c),e.xhr.setRequestHeader("Authorization","Bearer "+e.agent.accessToken),e.xhr.setRequestHeader("Content-Type","application/json"),e.xhr.asend(a,d)},function(a){return 401==e.xhr.status||403==e.xhr.status?g>=2?(f=!0,void a()):(g++,void e.agent.refresh(a)):(f=!0,void a(e.xhr.response,e.xhr.status))}))(a)}};if(FOAModel({name:"OAuthXhrFactory",label:"OAuthXhrFactory",properties:[{name:"authAgent",type:"AuthAgent",required:!0},{model_:"StringProperty",name:"responseType"}],methods:{make:function(){return OAuthXhr.create(new XMLHttpRequest,this.responseType,this.authAgent)}}}),FOAModel({name:"OAuth2",label:"OAuth 2.0",properties:[{name:"accessToken",help:"Token used to authenticate requests."},{name:"clientId",required:!0},{name:"clientSecret",required:!0},{model_:"StringArrayProperty",name:"scopes",required:!0},{model_:"URLProperty",name:"endpoint",defaultValue:"https://accounts.google.com/o/oauth2/"}],methods:{init:function(){this.SUPER(),this.refresh_=amerged(this.refreshNow_.bind(this))},refreshNow_:function(){},refresh:function(a,b){return this.refresh_(a,b)}}}),FOAModel({name:"OAuth2WebClient",help:"Strategy for OAuth2 when running as a web page.",extendsModel:"OAuth2",methods:{refreshNow_:function(a,b){var c,d=this,e=wrapJsonpCallback(function(b){d.accessToken=b;try{a(b)}finally{c&&c.close()}},!0),f=(location.pathname,location.origin+location.pathname.substring(0,location.pathname.lastIndexOf("/"))+"/oauth.html"),g=["?response_type=token","client_id="+encodeURIComponent(this.clientId),"redirect_uri="+encodeURIComponent(f),"scope="+encodeURIComponent(this.scopes.join(" ")),"state="+e.id,"approval_prompt="+(b?"force":"auto")];c=window.open(this.endpoint+"auth"+g.join("&"))}}}),FOAModel({name:"OAuth2ChromeApp",help:"Strategy for OAuth2 when running as a Chrome App",extendsModel:"OAuth2",properties:[{name:"refreshToken",help:"Token used to generate new access tokens."},{name:"authCode",help:"Authorization code used to generate a new refresh token."}],methods:{auth:function(a){var b=["?response_type=code","client_id="+encodeURIComponent(this.clientId),"redirect_uri=urn:ietf:wg:oauth:2.0:oob","scope="+encodeURIComponent(this.scopes.join(" "))],c=this;chrome.app.window.create("empty.html",{width:800,height:600},function(d){var e=!1;d.onClosed.addListener(function(){e||a(!1)});var f=d.contentWindow,g=d.contentWindow.document;f.addEventListener("load",function(){var f=g.createElement("webview");f.style.width="100%",f.style.height="100%",g.body.appendChild(f),f.addEventListener("contentload",function(){f.executeScript({code:"window.document.title;"},function(b){b[0]&&b[0].startsWith("Success code=")&&(c.authCode=b[0].substring(b[0].indexOf("=")+1),e=!0,d.close(),c.updateRefreshToken(a))})}),f.src=c.endpoint+"auth"+b.join("&")})})},updateRefreshToken:function(a){var b=["code="+encodeURIComponent(this.authCode),"client_id="+encodeURIComponent(this.clientId),"client_secret="+encodeURIComponent(this.clientSecret),"grant_type=authorization_code","redirect_uri=urn:ietf:wg:oauth:2.0:oob"],c=new XMLHttpRequest;c.open("POST",this.endpoint+"token"),c.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),c.responseType="json";var d=this;aseq(function(a){c.asend(a,b.join("&"))},function(a){200===c.status&&(d.accessToken=c.response.access_token,d.refreshToken=c.response.refresh_token),a&&a(200===c.status&&d.accessToken)})(a)},updateAccessToken:function(a){var b=["refresh_token="+encodeURIComponent(this.refreshToken),"client_id="+encodeURIComponent(this.clientId),"client_secret="+encodeURIComponent(this.clientSecret),"grant_type=refresh_token"],c=new XMLHttpRequest;c.open("POST",this.endpoint+"token"),c.responseType="json",c.setRequestHeader("Content-Type","application/x-www-form-urlencoded");var d=this;aseq(function(a){c.asend(a,b.join("&"))},function(a){200===c.status&&(d.accessToken=c.response.access_token),a&&a(200===c.status&&d.accessToken)})(a)},refreshNow_:function(a,b){return b?void this.auth(a):void aseq(function(a){this.updateAccessToken(a)
}.bind(this),function(a,b){return b?void(a&&a(b)):void this.auth(a)}.bind(this))(a)}}}),window.chrome&&window.chrome.runtime&&window.chrome.runtime.id)var EasyOAuth2=OAuth2ChromeApp;else EasyOAuth2=OAuth2WebClient;var LabelView=FOAM({model_:"Model",name:"LabelView",extendsModel:"View",properties:[{name:"dao",label:"DAO",type:"DAO",defaultValueFn:function(){return GLOBAL.EMailLabelDAO},hidden:!0},{name:"value",type:"Value",postSet:function(a,b){a&&a.removeListener(this.updateHTML),b.addListener(this.updateHTML),this.updateHTML()},factory:function(){return SimpleValue.create()}}],listeners:[{model_:"Method",name:"updateHTML",code:function(){var a=this.$;a&&(a.innerHTML=this.labelsToHTML())}}],methods:{getValue:function(){return this.value},setValue:function(a){this.value=a},toHTML:function(){return'<div class="labelList" id="'+this.id+'"></div>'},updateHTML:function(){},labelsToHTML:function(){var a="";EMailPreferences.find(EQ(EMailPreference.NAME,"sx_clcp"),{put:function(b){a=b.value},err:function(){console.log("error")}});for(var b=StringPS.create(a),c=CustomLabelColorMapParser.parse(CustomLabelColorMapParser.colormap,b).value,d="",e=this.value.get(),f=0;f<e.length;f++){var g=this.labelToHTML(e[f],c);g&&(d+="&nbsp;"+g)}return d},labelToHTML:function(a,b){var c;if(this.dao&&this.dao.find(EQ(EMailLabel.ID,a),{put:function(a){c=a},err:function(){console.log("error")}}),!c||!c.isRenderable())return void 0;var d=this.lookupColorPair(c,b),e="";if(d){var f=d.b,g=d.f;e=' style="',e+="background-color: "+f+"; ",e+="border-color: "+g+"; ",e+="color: "+g+'"'}var h=c.getRenderName();return"<span"+e+' class="label">'+h+"</span>"},lookupColorPair:function(a,b){var c=a.color;return a.isSystemLabel()&&!c?this.getSystemLabelColor(a):c?c>=0?this.DEFAULT_LABEL_COLORS[c]:b[c]:void 0},getSystemLabelColor:function(a){var b=a.displayName;switch(b){case a.SystemLabels.STARRED:case a.SystemLabels.IMPORTANT:return{b:"#ffd76e",f:"#80572a"};case a.SystemLabels.DRAFT:return{b:"#ffffff",f:"#ff0000"};default:return{b:"#dddddd",f:"#666666"}}},DEFAULT_LABEL_COLORS:[{b:"#f1f5ec",f:"#006633"},{b:"#dee5f2",f:"#5a6986"},{b:"#e0ecff",f:"#206cff"},{b:"#dfe2ff",f:"#0000cc"},{b:"#e0d5f9",f:"#5229a3"},{b:"#fde9f4",f:"#854f61"},{b:"#ffe3e3",f:"#cc0000"},{b:"#fff0e1",f:"#ec7000"},{b:"#fadcb3",f:"#b36d00"},{b:"#f3e7b3",f:"#ab8b00"},{b:"#ffffd4",f:"#636330"},{b:"#f9ffef",f:"#64992c"},{b:"#f1f5ec",f:"#006633"},{b:"#5a6986",f:"#dee5f2"},{b:"#206cff",f:"#e0ecff"},{b:"#0000cc",f:"#dfe2ff"},{b:"#5229a3",f:"#e0d5f9"},{b:"#854f61",f:"#fde9f4"},{b:"#cc0000",f:"#ffe3e3"},{b:"#ec7000",f:"#fff0e1"},{b:"#b36d00",f:"#fadcb3"},{b:"#ab8b00",f:"#f3e7b3"},{b:"#636330",f:"#ffffd4"},{b:"#64992c",f:"#f9ffef"},{b:"#006633",f:"#f1f5ec"}]}}),CustomLabelColorMapGrammar={__proto__:grammar,START:sym("colormap"),dig:range("0","9"),uint:plus(sym("dig")),num:seq(optional("-"),sym("uint")),hex:alt(range("0","9"),range("a","f"),range("A","F")),hex3byte:repeat(sym("hex"),void 0,6,6),colormap:repeat(sym("colorentry"),","),colorentry:seq(sym("colorindex"),":",sym("color"),":",sym("color")),colorindex:sym("num"),color:seq("#",sym("hex3byte"))},CustomLabelColorMapParser={__proto__:CustomLabelColorMapGrammar}.addActions({uint:function(a){return a.join("")},num:function(a){return Number(a.join(""))},hex3byte:function(a){return a.join("")},color:function(a){return a.join("")},colorentry:function(a){return[a[0],{b:a[2],f:a[4]}]},colormap:function(a){for(var b,c=[],d=a.length;b=a[--d];)c[b[0]]=b[1];return c}}),EMailLabel=FOAM({model_:"Model",name:"EMailLabel",label:"EMailLabel",ids:["id"],properties:[{model_:"StringProperty",name:"id",label:"Label ID"},{model_:"StringProperty",name:"displayName",label:"Display Name"},{model_:"IntProperty",name:"color",label:"color",defaultValue:0}],methods:{SystemLabels:{ALL:"^all",DRAFT:"^r",IMPORTANT:"^io_im",INBOX:"^i",MUTED:"^g",OPENED:"^o",REPLIED:"^io_re",SENT:"^f",SPAM:"^s",STARRED:"^t",TRASH:"^k",UNREAD:"^u"},RENDERABLE_SYSTEM_LABELS:lazyEval(function(){var a={},b=this.SystemLabels;return a[b.INBOX]=!0,a[b.STARRED]=!0,a[b.IMPORTANT]=!0,a[b.SPAM]=!0,a[b.TRASH]=!0,a[b.DRAFT]=!0,a[b.SENT]=!0,a[b.MUTED]=!0,a[b.UNREAD]=!0,a}),SYSTEM_LABEL_RENDER_NAMES:lazyEval(function(){var a={},b=this.SystemLabels;return a[b.ALL]="All Mail",a[b.INBOX]="Inbox",a[b.STARRED]="Starred",a[b.IMPORTANT]="Important",a[b.SPAM]="Spam",a[b.TRASH]="Trash",a[b.DRAFT]="Draft",a[b.SENT]="Sent",a[b.MUTED]="Muted",a[b.UNREAD]="Unread",a[b.REPLIED]="Replied",a[b.OPENED]="Opened",a}),SEARCHABLE_SYSTEM_LABELS:lazyEval(function(){var a={},b=this.SystemLabels;return a[b.ALL]=!0,a[b.INBOX]=!0,a[b.STARRED]=!0,a[b.IMPORTANT]=!0,a[b.SPAM]=!0,a[b.TRASH]=!0,a[b.DRAFT]=!0,a[b.SENT]=!0,a}),isSystemLabel:function(){return"^"==this.displayName.charAt(0)},isRenderable:function(){return!this.isSystemLabel()||this.RENDERABLE_SYSTEM_LABELS()[this.displayName]},getRenderName:function(){var a=this.displayName;return this.SYSTEM_LABEL_RENDER_NAMES()[a]||a},isSearchable:function(){return!this.isSystemLabel()||this.SEARCHABLE_SYSTEM_LABELS()[this.displayName]},getSearch:function(){switch(this.displayName){case this.SystemLabels.ALL:return"-label:^r,^s,^k";case this.SystemLabels.SENT:return"f:me";default:return'label:"'+this.displayName+'"'}}}}),EMailPreference=FOAM({model_:"Model",name:"EMailPreference",label:"EMailPreference",ids:["name"],properties:[{model_:"StringProperty",name:"name",label:"Preference Name"},{model_:"StringProperty",name:"value",label:"Preference Value"}]}),Attachment=FOAM({model_:"Model",name:"Attachment",plural:"Attachments",tableProperties:["type","filename","position","size"],properties:[{model_:"StringProperty",name:"id",label:"Identifier",displayWidth:50,factory:function(){return this.$UID}},{model_:"Property",name:"filename",label:"File Name",type:"String",displayWidth:50,view:"TextFieldView"},{model_:"Property",name:"type",type:"String",displayWidth:30,view:"TextFieldView"},{model_:"Property",name:"size",type:"int",displayWidth:10,view:"TextFieldView"},{model_:"Property",name:"position",type:"int",displayWidth:10,view:"TextFieldView"},{name:"file",type:"File",hidden:!0},{model_:"BooleanProperty",name:"inline",defaultValue:!1}],methods:{atoMime:function(a){if(!this.file)return void a();var b=this,c=new FileReader;c.onloadend=function(){var d=Base64Encoder.encode(new Uint8Array(c.result),78);"\n"!==d[d.length-1]&&(d+="\r\n");var e=b.filename.replace(/[\x00-\x1f]/g,"").replace(/"/g,"");a("Content-Type: "+b.type+'; name="'+e+'"\r\n'+(b.inline?"":'Content-Disposition: attachment; filename="'+e+'"\r\n')+"Content-Transfer-Encoding: base64\r\nContent-ID: <"+b.id+">\r\nX-Attachment-Id: "+b.id+"\r\n\r\n"+d)},c.readAsArrayBuffer(this.file)}},actions:[{model_:"Action",name:"view",help:"View an attachment.",action:function(){}}]}),openComposeView=function(a){DAOCreateController.getPrototype().newObj(a,EMailDAO)},EMail=FOAM({model_:"Model",name:"EMail",plural:"EMail",ids:["id"],tableProperties:["from","subject","timestamp"],properties:[{model_:"StringProperty",name:"id",label:"Message ID",mode:"read-write",required:!0,displayWidth:50,hidden:!0,compareProperty:hexStringCompare},{model_:"StringProperty",name:"convId",label:"Conversation ID",mode:"read-write",hidden:!0,displayWidth:30},{model_:"DateProperty",name:"timestamp",aliases:["time","modified","t"],label:"Date",type:"String",mode:"read-write",required:!0,displayWidth:45,displayHeight:1,view:"TextFieldView",tableWidth:"100",preSet:function(a,b){return"string"==typeof b||"number"==typeof b?new Date(b):b},factory:function(){return new Date}},{model_:"StringProperty",name:"from",shortName:"f",mode:"read-write",required:!0,displayWidth:90,tableWidth:"120",tableFormatter:function(a){var b;return b=-1!=a.search("<.*>")?a.replace(/<.*>/,"").replace(/"/g,""):a.replace(/@.*/,""),b.trim()},factory:function(){return GLOBAL.user||""}},{model_:"StringArrayProperty",name:"to",shortName:"t",required:!0,displayWidth:90,tableFormatter:function(a){return a.replace(/"/g,"").replace(/<.*/,"")}},{model_:"StringArrayProperty",name:"cc",required:!0,displayWidth:90,tableFormatter:function(a){return a.replace(/"/g,"").replace(/<.*/,"")}},{model_:"StringArrayProperty",name:"bcc",required:!0,displayWidth:90,tableFormatter:function(a){return a.replace(/"/g,"").replace(/<.*/,"")}},{model_:"StringArrayProperty",name:"replyTo"},{model_:"Property",name:"subject",shortName:"s",type:"String",mode:"read-write",required:!0,displayWidth:100,tableWidth:"45%",view:"TextFieldView"},{model_:"StringArrayProperty",name:"labels",view:"LabelView",postSet:function(a,b){for(var c=0;c<b.length;c++)b[c]=b[c].intern()},help:"Email labels."},{model_:"Property",name:"attachments",label:"Attachments",tableLabel:"@",type:"Array[Attachment]",subType:"Attachment",view:"ArrayView",factory:function(){return[]},tableWidth:"20",tableFormatter:function(a){return a.length?a.length:""},help:"Email attachments."},{model_:"StringProperty",name:"body",shortName:"b",label:"",view:"TextFieldView",displayWidth:70,displayHeight:20,help:"Email message body.",summaryFormatter:function(a){return'<div class="messageBody">'+a.replace(/\n/g,"<br/>")+"</div>"}}],methods:{updateLabelByName:function(a){var b=this;EMailLabelDAO.find(EQ(EMailLabel.DISPLAY_NAME,a),{put:function(a){var c=b.clone();c.toggleLabel(a.id),EMailDAO.put(c)}})},hasLabel:function(a){return-1!=this.labels.indexOf(a)},toggleLabel:function(a){this.hasLabel(a)?this.removeLabel(a):this.addLabel(a)},addLabel:function(a){this.labels=this.labels.deleteF(a).pushF(a)},removeLabel:function(a){this.labels=this.labels.deleteF(a)},atoMime:function(a){for(var b=[],c=[],d=0;d<this.attachments.length;d++)this.attachments[d].inline?b.push(this.attachments[d]):c.push(this.attachments[d]);var e=function(){var a=Math.floor(1e4*Math.random());return function(){return(a+=1).toString(16)}}(),f="Content-Type: text/html; charset=UTF-8\r\n\r\n",g=new DocumentFragment;g.appendChild(document.createElement("body")),g.firstChild.innerHTML=this.body;for(var h=g.querySelectorAll("img"),d=0;d<h.length;d++)h[d].id&&(h[d].src="cid:"+h[d].id,h[d].removeAttribute("id"));f+=g.firstChild.innerHTML+"\r\n";var d,i=this,j=function(a,b){return aseq(function(a){boundary=e(),f="Content-Type: multipart/"+(b?"related":"mixed")+"; boundary="+boundary+"\r\n\r\n--"+boundary+"\r\n"+f+"\r\n--"+boundary,d=0,a()},awhile(function(){return d<a.length},aseq(function(b){var c=a[d];d++,c.atoMime(b)},function(a,b){f+="\r\n"+b,f+="--"+boundary,a()})),function(a){f+="--",a()})};aseq(aif(b.length>0,j(b,!0)),aif(c.length>0,j(c,!1)))(function(){f="From: "+i.from+"\r\nTo: "+i.to.join(", ")+"\r\n"+(i.cc.length?"Cc: "+i.cc.join(", ")+"\r\n":"")+(i.bcc.length?"Bcc: "+i.bcc.join(", ")+"\r\n":"")+"Subject: "+i.subject+"\r\n"+f,a(f)})}},actions:[{model_:"Action",name:"send",help:"Send the email.",action:function(){EmailDAO.put(this),stack.back()}},{model_:"Action",name:"reply",help:"Reply to an email.",action:function(){var a=EMail.create({to:[this.from],from:ME||this.to,subject:"Re.: "+this.subject,body:this.body.replace(/^|\n/g,"\n>"),id:Math.floor(16777215*Math.random()).toVarintString()});openComposeView(a)}},{model_:"Action",name:"replyAll",help:"Reply to all recipients of an email.",action:function(){for(var a=EMail.create({to:[this.from],cc:this.cc,from:ME||this.to,subject:"Re.: "+this.subject,body:this.body.replace(/^|\n/g,"\n>"),id:Math.floor(16777215*Math.random()).toVarintString()}),b=0;b<this.to;b++)a.to.push(this.to[b]);openComposeView(a)}},{model_:"Action",name:"forward",help:"Forward an email.",action:function(){var a=EMail.create({from:ME,subject:"Fwd.: "+this.subject,body:this.body.replace(/^|\n/g,"\n>"),id:Math.floor(16777215*Math.random()).toVarintString()});openComposeView(a)}},{model_:"Action",name:"star",help:"Star an email.",action:function(){this.updateLabelByName("^t")}},{model_:"Action",name:"archive",help:"Archive an email.",action:function(){this.updateLabelByName("^i")}},{model_:"Action",name:"spam",help:"Report an email as SPAM.",action:function(){var a=this;apar(function(a){EMailLabelDAO.where(EQ(EMailLabel.DISPLAY_NAME,"^i")).select({put:function(b){a(b)}})},function(a){EMailLabelDAO.where(EQ(EMailLabel.DISPLAY_NAME,"^s")).select({put:function(b){a(b)}})})(function(b,c){a=a.clone(),a.removeLabel(b.id),a.addLabel(c.id),EmailDAO.put(a)})}},{model_:"Action",name:"trash",help:"Move an email to the trash.",action:function(){var a=this;apar(function(a){EMailLabelDAO.where(EQ(EMailLabel.DISPLAY_NAME,"^i")).select({put:function(b){a(b)}})},function(a){EMailLabelDAO.where(EQ(EMailLabel.DISPLAY_NAME,"^k")).select({put:function(b){a(b)}})})(function(b,c){a=a.clone(),a.removeLabel(b.id),a.addLabel(c.id),EMailDAO.put(a)})}},{model_:"Action",name:"open",action:function(){var a=this;apar(function(a){EMailLabelDAO.where(EQ(EMailLabel.DISPLAY_NAME,"^o")).select({put:function(b){a(b)}})},function(a){EMailLabelDAO.where(EQ(EMailLabel.DISPLAY_NAME,"^u")).select({put:function(b){a(b)}})})(function(b,c){a.hasLabel(c.id)&&(a=a.clone(),a.removeLabel(c.id),a.addLabel(b.id),EMailDAO.put(a))})}}]}),EmailAddressParser={__proto__:grammar,START:sym("address"),"until eol":repeat(notChar("\r")),"address list":repeat(sym("address"),seq(",",repeat(" "))),address:alt(sym("labelled address"),sym("simple address")),"labelled address":seq(repeat(notChars("<,")),"<",sym("simple address"),">"),"simple address":seq(repeat(notChar("@")),"@",repeat(notChars("\r>,")))}.addActions({"labelled address":function(a){return a[0].join("")+a[1]+a[2]+a[3]},"simple address":function(a){return a[0].join("")+a[1]+a[2].join("")}}),MBOXParser={__proto__:grammar,START:sym("line"),eol:literal("\n"),"until eol":repeat(notChar("\r")),line:alt(sym("start of email"),sym("id"),sym("conversation id"),sym("to"),sym("cc"),sym("bcc"),sym("from"),sym("subject"),sym("date"),sym("labels"),sym("block separator"),sym("content type"),sym("transfer encoding"),sym("empty line"),sym("start of attachment")),"empty line":literal("\r\n"),"start of email":seq("From ",sym("until eol")),id:seq("Message-ID: ",sym("until eol")),"conversation id":seq("X-GM-THRID: ",sym("until eol")),address:EmailAddressParser.export("address"),"address list":EmailAddressParser.export("address list"),to:seq("To: ",sym("until eol")),cc:seq("Cc: ",sym("until eol")),bcc:seq("Bcc: ",sym("until eol")),from:seq("From: ",sym("until eol")),labels:seq("X-Gmail-Labels: ",repeat(sym("label"),",")),label:repeat(alt(range("a","z"),range("A","Z"),range("0","9"))),subject:seq("Subject: ",sym("until eol")),date:seq("Date: ",sym("until eol")),other:sym("until eol"),"block separator":seq("--",repeat(notChars("-\r\n")),optional("--")),token:repeat(notChars(' ()<>@,;:\\"/[]?=')),type:alt(sym("multipart type"),sym("text/plain"),sym("text/html"),sym("unknown content type")),"unknown content type":seq(sym("token"),"/",sym("token")),"multipart type":seq(literal("multipart/"),sym("token")),"text/plain":literal("text/plain"),"text/html":literal("text/html"),"content type":seq("Content-Type: ",sym("type"),optional(seq("; ",sym("params")))),params:repeat(alt(sym("boundary declaration"),sym("charset declaration"),seq(sym("token"),"=",sym("token")))),"boundary declaration":seq("boundary=",sym("token")),"charset declaration":seq("charset=",alt(sym("utf-8"),sym("iso-8859-1"),sym("token"))),"utf-8":literal("UTF-8"),"iso-8859-1":literal("ISO-8859-1"),"transfer encoding":seq("Content-Transfer-Encoding: ",alt(sym("quoted printable"),sym("base64"),sym("until eol"))),"quoted printable":literal_ic("quoted-printable"),base64:literal_ic("base64"),"start of attachment":seq("Content-Type: ",repeat(notChar(";")),'; name="',sym("filename"),'"',sym("until eol")),filename:repeat(notChar('"'))},MBOXLoader={__proto__:MBOXParser,ps:StringPS.create(""),state:function(a){this.states[0].call(this,a)},PARSE_HEADERS_STATE:function(a){this.parseString(a)},IGNORE_SECTION_STATE:function(a){"From "===a.slice(0,5)?(this.states.shift(),this.state(a)):2==a.indexOf(this.blockIds[0])&&(this.states.shift(),"--"==a.slice(-4,-2)&&this.blockIds.shift())},PLAIN_BODY_STATE:function(a){return"From "===a.slice(0,5)?(this.states.shift(),void this.state(a)):2==a.indexOf(this.blockIds[0])?(this.states.shift(),void("--"==a.slice(-4,-2)&&this.blockIds.shift())):void(this.hasHtml||this.b.push(a.trimRight()))},HTML_BODY_STATE:function(a){return"From "===a.slice(0,5)?(this.states.shift(),void this.state(a)):2==a.indexOf(this.blockIds[0])?(this.states.shift(),void("--"==a.slice(-4,-2)&&this.blockIds.shift())):void this.b.push(a.trimRight())},SKIP_ATTACHMENT_STATE:function(a){var b=this.email.attachments[this.email.attachments.length-1];return"From "===a.slice(0,5)?(b.size=b.pos-b.position,this.states.shift(),void this.state(a)):2==a.indexOf(this.blockIds[0])?(this.states.shift(),void("--"==a.slice(-4,-2)&&this.blockIds.shift())):void 0},created:0,lineNo:0,pos:0,segPos:0,put:function(a){if(0==this.lineNo&&(this.segStartTime=this.startTime=Date.now(),this.states=[this.PARSE_HEADERS_STATE]),this.lineNo++,this.pos+=a.length,!(this.lineNo%1e5)){var b=Math.floor(this.lineNo/(Date.now()-this.startTime)),c=Math.floor(this.pos/(Date.now()-this.startTime)),d=Math.floor(1e5/(Date.now()-this.segStartTime)),e=Math.floor((this.pos-this.segPos)/(Date.now()-this.segStartTime));console.log("line: "+Math.floor(this.lineNo/1e3)+"k  time: "+Math.floor(Date.now()-this.startTime)+"ms  bytes: "+Math.floor(this.pos/1e3)+"k  created: "+this.created+"    SEGMENT:"," lps: "+d+"k bps: "+e+"k    TOTAL:"," lps: "+b+"k bps: "+c+"k state: "+this.states[0].name),this.segStartTime=Date.now(),this.segPos=this.pos}this.state(a)},eof:function(){this.saveCurrentEmail()},saveCurrentEmail:function(){if(this.email){if(this.b.encoding&&"quoted-printable"==this.b.encoding){var a=QuotedPrintable;if(this.b.charset&&"UTF-8"==this.b.charset)var b=IncrementalUtf8.create();else b={string:"",remaining:0,put:function(a){this.string+=String.fromCharCode(a)},reset:function(){this.string=""}};var c=a.decode(this.b.join("\n"),b)}else c=this.b.join("\n");if(this.email.body=c,this.charset="",this.encoding="",this.b=[],0==this.email.to.length)return;if(-1!=this.email.to.indexOf("<<"))return;if(-1!=this.email.from.indexOf("<<"))return;if(-1!=this.email.to.indexOf("3D"))return;if(-1!=this.email.from.indexOf("3D"))return;if(-1!=this.email.from.indexOf("="))return;if(0==this.email.from.indexOf("<"))return;if(0==this.email.from.indexOf(" "))return;this.created++,this.dao&&this.dao.put(this.email)}}}.addActions({"start of email":function(){this.saveCurrentEmail(),this.email=EMail.create(),this.b=[],this.blockIds=[],this.states=[this.PARSE_HEADERS_STATE]},id:function(){this.email.id=Math.floor(1e8*Math.random())},"conversation id":function(a){this.email.convId=a[1].join("").trim()},to:function(a){this.email.to=a[1].join("").trim();var b=this.email.to.indexOf(",");-1!=b&&(this.email.to=this.email.to.substring(0,b))},cc:function(a){for(var b=a[1].join("").split(","),c=0;c<b.length;c++)b[c]=b[c].trim();this.email.cc=b},bcc:function(a){for(var b=a[1].join("").split(","),c=0;c<b.length;c++)b[c]=b[c].trim();this.email.bcc=b},from:function(a){this.email.from=a[1].join("").trim()},subject:function(a){this.email.subject=a[1].join("").trim()},date:function(a){this.email.timestamp=new Date(a[1].join("").trim())},label:function(a){this.email.labels.push(a.join(""))},"text/plain":function(){this.nextState=this.PLAIN_BODY_STATE},"text/html":function(){this.b=[],this.nextState=this.HTML_BODY_STATE},"unknown content type":function(){this.nextState=this.IGNORE_SECTION_STATE},"multipart type":function(){this.nextState=this.PARSE_HEADERS_STATE},"empty line":function(){(this.nextState===this.PLAIN_BODY_STATE||this.nextState===this.HTML_BODY_STATE)&&(this.b.encoding=this.encoding,this.b.charset=this.charset),this.states.unshift(this.nextState)},"boundary declaration":function(a){this.blockIds.unshift(a[1].join("").trimRight())},"quoted printable":function(){this.encoding="quoted-printable"},base64:function(){this.encoding="base64"},"utf-8":function(){this.charset="UTF-8"},"iso-8859-1":function(){this.charset="ISO-8859-1"},"block separator":function(a){this.nextState=this.IGNORE_SECTION_STATE,a[2]&&(this.nextState=this.PARSE_HEADERS_STATE,this.blockIds.shift())},"start of attachment":function(a){this.nextState=this.SKIP_ATTACHMENT_STATE;var b=Attachment.create({type:a[1].join(""),filename:a[3].join(""),position:this.pos});this.email.attachments.push(b)}}),EMailBody=FOAM({model_:"Model",name:"EMailBody",label:"EMailBody",ids:["offset","size"],properties:[{name:"offset",type:"Int",required:!0},{name:"size",type:"Int",required:!0},{name:"value",type:"String",defaultValue:""}],methods:{}}),ConversationAction=FOAM({model_:"Model",extendsModel:"Action",properties:[{name:"name",defaultValueFn:function(){return this.delegate?this.delegate.name:"ConversationAction"}},{name:"iconUrl",defaultValueFn:function(){return this.delegate.iconUrl}},{name:"help",defaultValueFn:function(){return this.delegate.help}},{name:"delegate"},{name:"action",defaultValue:function(a){var b=this.emails;if(a.applyOnAll)b.forEach(function(b){a.delegate.action.call(b)});else if(b.length){var c=b[b.length-1];a.delegate.action.call(c)}}},{name:"applyOnAll",defaultValue:!0}]}),EMailsView=FOAM({model_:"Model",name:"EMailsView",extendsModel:"DetailView",properties:[{name:"value",type:"Value",postSet:function(a,b){a&&a.removeListener(this.updateHTML),b.addListener(this.updateHTML),this.updateHTML()},factory:function(){return SimpleValue.create()}}],listeners:[{model_:"Method",name:"updateHTML",code:function(){var a=this.value.get();if(a){var b="";this.children=[];var c=this;a.forEach(function(a){var d=MessageView.create({});c.addChild(d),EMailDAO.find(a.id,{put:function(a){d.value.set(a)}}),b+=d.toHTML()}),this.$.innerHTML=b,this.initChildren()}}}],methods:{toHTML:function(){return'<div id="'+this.id+'"></div>'}}}),Conversation=FOAM({model_:"Model",name:"Conversation",tableProperties:["recipients","subject","timestamp"],ids:["id"],properties:[{name:"id"},{name:"recipients",tableWidth:"100"},{model_:"StringProperty",name:"subject",shortName:"s",mode:"read-write",required:!0,displayWidth:100,tableWidth:"45%",view:"TextFieldView",tableFormatter:function(a,b,c){var d=c.strToHTML(a);return b.isUnread?"<b>"+d+"</b>":d}},{name:"timestamp",model_:"DateProperty",tableWidth:"75"},{name:"emails",view:"EMailsView"},{name:"isUnread"},{model_:"StringArrayProperty",name:"labels",view:"LabelView",help:"Email labels.",postSet:function(a,b){if(b&&b.length){var c=this;this.isUnread=!1,EMailLabelDAO.find(EQ(EMailLabel.DISPLAY_NAME,"^u"),{put:function(a){b.forEach(function(b){b==a.id&&(c.isUnread=!0)})}})}}}],listeners:[{name:"update",code:function(){if(this.emails&&0!==this.emails.length){var a=this.emails[0];this.subject=a.subject;for(var b,c=[],d={},e=0;b=this.emails[e];e++)d[b.from]||(c.push(EMail.FROM.tableFormatter(b.from)),d[b.from]=!0);this.recipients=c.join(", "),this.emails.length>1&&(this.recipients+=" ("+this.emails.length+")"),this.timestamp=a.timestamp;var b={};this.emails.forEach(function(a){a.labels.forEach(function(a){b[a]=1})}),this.labels=Object.keys(b)}}}],methods:{put:function(a){this.emails||(this.emails=[]),this.emails.put(a),this.id=a.convId,this.update()},remove:function(a){this.emails||(this.emails=[]);for(var b=0;b<this.emails.length;b++)a.id===this.emails[b].id&&this.emails.splice(b--,1);this.update()}},actions:[{model_:"ConversationAction",delegate:EMail.REPLY,applyOnAll:!1},{model_:"ConversationAction",delegate:EMail.REPLY_ALL,applyOnAll:!1},{model_:"ConversationAction",delegate:EMail.FORWARD,applyOnAll:!1},{model_:"ConversationAction",delegate:EMail.STAR,applyOnAll:!1},{model_:"ConversationAction",delegate:EMail.ARCHIVE},{model_:"ConversationAction",delegate:EMail.SPAM},{model_:"ConversationAction",delegate:EMail.TRASH},{model_:"ConversationAction",delegate:EMail.OPEN}]});FOAModel({name:"Turntable",extendsModel:"CView",properties:[{name:"r",label:"Radius",type:"int",view:"IntFieldView",defaultValue:150},{name:"width",type:"int",defaultValue:350},{name:"height",type:"int",defaultValue:350},{name:"x",type:"int",defaultValue:170},{name:"y",type:"int",defaultValue:170},{name:"rpm",label:"RPM",type:"float",view:"FloatFieldView",help:"Rotations Per Minute. Standard values: 33, 45, and 78.",defaultValue:33},{name:"internalTime",postSet:function(a,b){this.active&&(this.time=b)}},{name:"time",preSet:function(a,b){return this.active?(b!=this.internalTime&&this.propertyChange("time",b,this.internalTime),this.internalTime):b}}],listeners:{mouseDown:function(a){this.active=!0,this.internalTime=this.time,this.a=this.angle(a.offsetX,a.offsetY),this.touchX=a.offsetX,this.touchY=a.offsetY},mouseUp:function(){this.active=!1},mouseMove:function(a){if(this.active){this.touchX=a.offsetX,this.touchY=a.offsetY;var b=this.a;this.a=this.angle(a.offsetX,a.offsetY);var c=this.a-b;if(c>1.5*Math.PI&&(c-=2*Math.PI),c<1.5*-Math.PI&&(c+=2*Math.PI),0!=c){var d=c/(2*Math.PI)*36e3/this.rpm;this.time=this.internalTime=this.internalTime+d}}}},methods:{angle:function(a,b){return Math.atan2(b-this.y,a-this.x)},paintSelf:function(){this.parent.$.onmousedown=this.mouseDown,this.parent.$.onmouseup=this.mouseUp,this.parent.$.onmousemove=this.mouseMove;var a=this.canvas;a.save(),a.font="48pt Arial",a.lineWidth=12,a.globalAlpha=.25,a.beginPath(),a.fillStyle="black",a.arc(this.x,this.y,this.r,0,2*Math.PI,!0),a.stroke(),a.beginPath(),a.fillStyle="black",a.arc(this.x,this.y,5+this.r/2,0,2*Math.PI,!0),a.stroke();var b=(this.r-10)/4,c=-.25*this.rpm*this.time/36e3*Math.PI*2;a.beginPath(),a.strokeStyle="black",a.arc(this.x+(10+b)*Math.sin(c),this.y+(10+b)*Math.cos(c),b,0,2*Math.PI,!0),a.stroke();var c=-this.rpm*this.time/36e3*Math.PI*2;if(a.beginPath(),a.fillStyle="black",a.arc(this.x+(10+3*b)*Math.sin(c),this.y+(10+3*b)*Math.cos(c),b,0,2*Math.PI,!0),a.stroke(),a.beginPath(),a.fillStyle="black",a.arc(this.x,this.y,8,0,2*Math.PI,!0),a.stroke(),this.active){a.lineWidth=15,a.strokeStyle="blue",a.beginPath(),a.arc(this.touchX,this.touchY,b,0,2*Math.PI,!0),a.stroke(),a.lineWidth=3;var d=this.touchX-this.x,e=this.touchY-this.y,f=Math.sqrt(d*d+e*e),g=Math.atan2(e,d);f=20*Math.round(f/20),a.beginPath(),a.strokeStyle="blue",a.arc(this.x,this.y,f,g+.8*Math.PI,g-.8*Math.PI,!0),a.stroke()}a.restore()}}});