function MODEL(model){function defineProperty(proto,key,map){map.value&&proto!==Object.prototype&&proto!==Array.prototype?proto[key]=map.value:Object.defineProperty_.apply(this,arguments)}var proto
if(model.name?(GLOBAL[model.name]||(GLOBAL[model.name]=model.extendsModel?{__proto__:GLOBAL[model.extendsModel]}:{}),proto=GLOBAL[model.name]):proto=model.extendsProto?GLOBAL[model.extendsProto].prototype:GLOBAL[model.extendsObject],model.properties)for(var i=0;i<model.properties.length;i++){var p=model.properties[i]
defineProperty(proto,p.name,{get:p.getter,enumerable:!1})}for(key in model.constants)defineProperty(proto,key,{value:model.constants[key],writable:!0,enumerable:!1})
if(Array.isArray(model.methods))for(var i=0;i<model.methods.length;i++){var m=model.methods[i]
defineProperty(proto,m.name,{value:m,writable:!0,enumerable:!1})}else for(var key in model.methods)defineProperty(proto,key,{value:model.methods[key],writable:!0,enumerable:!1})}function WeakMap(){function del(key){delete key[id]}function get(key){return key[id]}function set(key,value){key[id]=value}function has(key){return!!key[id]}var id="__WEAK_MAP__"+this.$UID
return{__proto__:this,"delete":del,get:get,set:set,has:has}}function prep(arg){return"string"==typeof arg?literal(arg):arg}function prepArgs(args){for(var i=0;i<args.length;i++)args[i]=prep(args[i])
return args}function range(c1,c2){var f=function(ps){return ps.head?ps.head<c1||ps.head>c2?void 0:ps.tail.setValue(ps.head):void 0}
return f.toString=function(){return"range("+c1+", "+c2+")"},f}function literal(str,opt_value){var f=function(ps){for(var i=0;i<str.length;i++,ps=ps.tail)if(str.charAt(i)!==ps.head)return void 0
return ps.setValue(opt_value||str)}
return f.toString=function(){return'"'+str+'"'},f}function literal_ic(str,opt_value){str=str.toLowerCase()
var f=function(ps){for(var i=0;i<str.length;i++,ps=ps.tail)if(!ps.head||str.charAt(i)!==ps.head.toLowerCase())return void 0
return ps.setValue(opt_value||str)}
return f.toString=function(){return'"'+str+'"'},f}function anyChar(ps){return ps.head?ps.tail:void 0}function notChar(c){return function(ps){return ps.head&&ps.head!==c?ps.tail.setValue(ps.head):void 0}}function notChars(s){return function(ps){return ps.head&&-1==s.indexOf(ps.head)?ps.tail.setValue(ps.head):void 0}}function not(p,opt_else){p=prep(p),opt_else=prep(opt_else)
var f=function(ps){return this.parse(p,ps)?void 0:opt_else?this.parse(opt_else,ps):ps}
return f.toString=function(){return"not("+p+")"},f}function optional(p){p=prep(p)
var f=function(ps){return this.parse(p,ps)||ps.setValue(void 0)}
return f.toString=function(){return"optional("+p+")"},f}function copyInput(p){p=prep(p)
var f=function(ps){var res=this.parse(p,ps)
return res?res.setValue(ps.str_.toString().substring(ps.pos,res.pos)):res}
return f.toString=function(){return"copyInput("+p+")"},f}function lookahead(p){p=prep(p)
var f=function(ps){return this.parse(p,ps)&&ps}
return f.toString=function(){return"lookahead("+p+")"},f}function repeat(p,opt_delim,opt_min,opt_max){p=prep(p),opt_delim=prep(opt_delim)
var f=function(ps){for(var ret=[],i=0;!opt_max||opt_max>i;i++){var res
if(opt_delim&&0!=ret.length){if(!(res=this.parse(opt_delim,ps)))break
ps=res}if(!(res=this.parse(p,ps)))break
ret.push(res.value),ps=res}return opt_min&&ret.length<opt_min?void 0:ps.setValue(ret)}
return f.toString=function(){return"repeat("+p+", "+opt_delim+", "+opt_min+", "+opt_max+")"},f}function plus(p){return repeat(p,void 0,1)}function noskip(p){return function(ps){return this.skip_=!1,ps=this.parse(p,ps),this.skip_=!0,ps}}function repeat0(p){return p=prep(p),function(ps){for(var res;res=this.parse(p,ps);)ps=res
return ps.setValue("")}}function seq(){var args=prepArgs(arguments),f=function(ps){for(var ret=[],i=0;i<args.length;i++){if(!(ps=this.parse(args[i],ps)))return void 0
ret.push(ps.value)}return ps.setValue(ret)}
return f.toString=function(){return"seq("+argsToArray(args).join(",")+")"},f}function seq1(n){var args=prepArgs(argsToArray(arguments).slice(1)),f=function(ps){for(var ret,i=0;i<args.length;i++){if(!(ps=this.parse(args[i],ps)))return void 0
i==n&&(ret=ps.value)}return ps.setValue(ret)}
return f.toString=function(){return"seq1("+n+", "+argsToArray(args).join(",")+")"},f}function invalidateParsers(){parserVersion_++}function simpleAlt(){var args=prepArgs(arguments)
if(1==args.length)return args[0]
var f=function(ps){for(var i=0;i<args.length;i++){var res=this.parse(args[i],ps)
if(res)return res}return void 0}
return f.toString=function(){return"alt("+argsToArray(args).join(" | ")+")"},f}function alt(){function nullParser(){return void 0}function testParser(p,ps){var trapPS=TrapPStream.create(ps)
return this.parse(p,trapPS),trapPS.goodChar}function getParserForChar(ps){var c=ps.head,p=map[c]
if(!p){for(var alts=[],i=0;i<args.length;i++){var parser=args[i]
testParser.call(this,parser,ps)&&alts.push(parser)}p=0==alts.length?nullParser:1==alts.length?alts[0]:simpleAlt.apply(null,alts),map[c]=p}return p}var SIMPLE_ALT=simpleAlt.apply(null,arguments),args=prepArgs(arguments),map={},parserVersion=parserVersion_
return function(ps){parserVersion!==parserVersion_&&(map={},parserVersion=parserVersion_)
var r1=this.parse(getParserForChar.call(this,ps),ps)
return r1}}function str(p){p=prep(p)
var f=function(ps){var ps=this.parse(p,ps)
return ps?ps.setValue(ps.value.join("")):void 0}
return f.toString=function(){return"str("+p+")"},f}function pick(as,p){p=prep(p)
var f=function(ps){var ps=this.parse(p,ps)
if(!ps)return void 0
for(var ret=[],i=0;i<as.length;i++)ret.push(ps.value[as[i]])
return ps.setValue(ret)}
return f.toString=function(){return"pick("+as+", "+p+")"},f}function parsedebug(p){return function(ps){var old=DEBUG_PARSE
DEBUG_PARSE=!0
var ret=this.parse(p,ps)
return DEBUG_PARSE=old,ret}}function sym(name){var f=function(ps){var p=this[name]
return p||console.log("PARSE ERROR: Unknown Symbol <"+name+">"),this.parse(p,ps)}
return f.toString=function(){return"<"+name+">"},f}function defineTTLProperty(obj,name,ttl,f){obj.__defineGetter__(name,function(){var accessed,value=void 0
return this.__defineGetter__(name,function(){function scheduleTimer(){setTimeout(function(){accessed?scheduleTimer():value=void 0,accessed=!1},ttl)}return value?accessed=!0:(accessed=!1,value=f(),scheduleTimer()),value}),this[name]})}function lookup(key){if(!key)return void 0
if("string"!=typeof key)return key
var root=this,cache
cache=this.lookupCache_
var ret=cache[key]
if(void 0===ret){for(var path=key.split("."),i=0;root&&i<path.length;i++)root=root[path[i]]
ret=root,cache[key]=ret?ret:null}return ret}function set(key,value){Object.defineProperty(this,key,{value:value,writable:"window"!==key,configurable:!0})}function setValue(key,value){var X=this
Object.defineProperty(this,key,{get:function(){return X.set(key,value.get()),X[key]},configurable:!0})}function sub(opt_args,opt_name){var sub=Object.create(this)
if(opt_args)for(var key in opt_args)opt_args.hasOwnProperty(key)&&sub.set(key,opt_args[key])
return opt_name&&(sub.NAME=opt_name),sub}function subWindow(w,opt_name,isBackground){return w?foam.ui.Window.create({window:w,name:opt_name,isBackground:isBackground},this).Y:this.sub()}function elementFromString(str){return str.element||(str.element=HTMLParser.create().parseString(str).children[0])}function $addWindow(w){w.window.$WID=$WID__++,$documents.push(w.document)}function $removeWindow(w){for(var i=$documents.length-1;i>=0;i--)$documents[i].defaultView&&$documents[i].defaultView!==w||$documents.splice(i,1)}function packagePath(X,path){function packagePath_(Y,path,i){return i===path.length?Y:(Y[path[i]]||(Y[path[i]]={},0==i&&(GLOBAL[path[i]]=Y[path[i]])),packagePath_(Y[path[i]],path,i+1))}return path?packagePath_(X,path.split("."),0):GLOBAL}function registerModel(model,opt_name,fastMode){var root=model["package"]?this:GLOBAL,name=model.name,package=model["package"]
if(opt_name){var a=opt_name.split(".")
name=a.pop(),package=a.join(".")}var modelRegName=(package?package+".":"")+name
if(root===GLOBAL||root===X){var path=packagePath(root,package)
fastMode?path[name]=model:Object.defineProperty(path,name,{value:model,configurable:!0})}Object.hasOwnProperty.call(this,"lookupCache_")||(this.lookupCache_=Object.create(this.lookupCache_||Object.prototype)),this.lookupCache_[modelRegName]=model,this.onRegisterModel(model)}function INTERFACE(imodel){var i=JSONUtil.mapToObj(X,imodel,Interface)
packagePath(X,i["package"])[i.name]=i
var id=i["package"]?i["package"]+"."+i.name:i.name
NONMODEL_INSTANCES[id]=!0}function onRegisterModel(m){}function defineLocalProperty(cls,name,factory){Object.defineProperty(cls,name,{get:function(){console.assert(this!==cls,"Called property getter from prototype: "+name)
var value=factory.call(this)
return Object.defineProperty(this,name,{configurable:!0,value:value}),value},configurable:!0})}function override(cls,methodName,method){var super_=cls[methodName],SUPER=function(){return super_.apply(this,arguments)},slowF=function(OLD_SUPER,args){try{return method.apply(this,args)}finally{this.SUPER=OLD_SUPER}},f=function(){var OLD_SUPER=this.SUPER
if(this.SUPER=SUPER,OLD_SUPER)return slowF.call(this,OLD_SUPER,arguments)
var ret=method.apply(this,arguments)
return this.SUPER=null,ret}
f.toString=function(){return method.toString()},f.super_=super_,cls[methodName]=f}function recopyModelFeatures(m){m.model_=Model,m.relationships=m.relationships,m.properties=m.properties,m.models=m.models,DEBUG&&(m.tests=m.tests,m.issues=m.issues),m.properties&&m.properties[0]&&!Property.isInstance(m.properties[0])&&m.properties.forEach(function(p){"Property"===p.model_.name&&(p.model_=Property)}),DEBUG&&BootstrapModel.saveDefinition(m)}function toNum(p){return p.replace?parseInt(p.replace("px","")):p}function compile_(a){return a.f?a:a===!0?TRUE:a===!1?FALSE:ConstantExpr.create({arg1:a})}function compileArray_(args){for(var b=[],i=0;i<args.length;i++){var a=args[i]
null!==a&&void 0!==a&&b.push(compile_(a))}return b}function COUNT(){return CountExpr.create()}function EQ(arg1,arg2){var eq=EqExpr.create()
return eq.instance_.arg1=compile_(arg1),eq.instance_.arg2=compile_(arg2),eq}function AND(){return AndExpr.create({args:compileArray_.call(null,arguments)})}function NEQ(arg1,arg2){return NeqExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function UPPER(arg1){return UpperExpr.create({arg1:compile_(arg1)})}function EQ_IC(arg1,arg2){return EQ(UPPER(arg1),UPPER(arg2))}function IN_IC(arg1,arg2){return IN(UPPER(arg1),arg2.map(UPPER))}function MAX(expr){return MaxExpr.create({arg1:expr})}function IN(arg1,arg2){return InExpr.create({arg1:compile_(arg1),arg2:arg2})}function LT(arg1,arg2){return LtExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function GT(arg1,arg2){return GtExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function LTE(arg1,arg2){return LteExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function GTE(arg1,arg2){return GteExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function EXPLAIN(arg){return ExplainExpr.create({arg1:arg})}function SUM(expr){return SumExpr.create({arg1:expr})}function MIN(expr){return MinExpr.create({arg1:expr})}function AVG(expr){return AvgExpr.create({arg1:expr})}function SEQ(){return SeqExpr.create({args:argsToArray(arguments)})}function UPDATE(expr,dao){return UpdateExpr.create({args:compileArray_.call(null,Array.prototype.slice.call(arguments,0,-1)),dao:arguments[arguments.length-1]})}function SET(arg1,arg2){return SetExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function GROUP_BY(expr1,opt_expr2){return GroupByExpr.create({arg1:expr1,arg2:opt_expr2||[].sink})}function GRID_BY(xFunc,yFunc,acc){return GridByExpr.create({xFunc:xFunc,yFunc:yFunc,acc:acc})}function MAP(fn,opt_sink){return MapExpr.create({arg1:fn,arg2:opt_sink||[].sink})}function DISTINCT(fn,sink){return DistinctExpr.create({arg1:fn,arg2:sink})}function OR(){return OrExpr.create({args:compileArray_.call(null,arguments)})}function NOT(arg){return NotExpr.create({arg1:compile_(arg)})}function STARTS_WITH(arg1,arg2){return StartsWithExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function STARTS_WITH_IC(arg1,arg2){return StartsWithICExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function CONTAINS(arg1,arg2){return ContainsExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function CONTAINS_IC(arg1,arg2){return ContainsICExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function CONCAT(){return ConcatExpr.create({args:compileArray_.call(null,arguments)})}function TREE(parentProperty,childrenProperty){return TreeExpr.create({parentProperty:parentProperty,childrenProperty:childrenProperty})}function ADD(arg1,arg2){return AddExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function DESC(arg1){return DescExpr.isInstance(arg1)?arg1.arg1:DescExpr.create({arg1:arg1})}function MQL(mql){return MQLExpr.create({arg1:mql})}function KEYWORD(word){return KeywordExpr.create({arg1:word})}function atxn(afunc){return function(ret){if(GLOBAL.__TXN__)afunc.apply(this,arguments)
else{GLOBAL.__TXN__={}
var a=argsToArray(arguments)
a[0]=function(){GLOBAL.__TXN__=void 0,ret()},afunc.apply(this,a)}}}function dump(o){return Array.isArray(o)?"["+o.map(dump).join(",")+"]":o?o.toString():"<undefined>"}function deferJsonP(X){var future=afuture()
return X.ajsonp=function(){var args=arguments
return function(ret){future.get(function(f){f.apply(void 0,args)(ret)})}},future}Number.name||(console.log("Polyfilling Function.prototype.name"),Object.defineProperty(Function.prototype,"name",{get:function(){var text=this.toString()
return text.substring(text.indexOf("function")+9,text.indexOf("(")).trim()},configurable:!0,enumerable:!0}))
var DEBUG=DEBUG||!1,GLOBAL=GLOBAL||this
Object.defineProperty_=Object.defineProperty,Object.defineProperty=function(){this.defineProperty_.apply(this,arguments)}
var MODEL0=MODEL
MODEL({extendsObject:"GLOBAL",methods:[function memoize(f){var cache={},g=function(){var key=argsToArray(arguments).toString()
return cache.hasOwnProperty(key)||(cache[key]=f.apply(this,arguments)),cache[key]}
return g.name=f.name,g},function memoize1(f){var cache={},g=function(arg){var key=arg?arg.toString():""
return cache.hasOwnProperty(key)||(cache[key]=f.call(this,arg)),cache[key]}
return g.name=f.name,g},function constantFn(v){return function(){return v}},function latchFn(f){var tripped=!1,val
return function(){return tripped||(tripped=!0,val=f(),f=void 0),val}},function argsToArray(args){for(var array=new Array(args.length),i=0;i<args.length;i++)array[i]=args[i]
return array},function StringComparator(s1,s2){return s1==s2?0:s2>s1?-1:1},function equals(a,b){return a===b?!0:a&&b?a.equals?a.equals(b):a==b:!1},function toCompare(c){return Array.isArray(c)?CompoundComparator.apply(null,c):c.compare?c.compare.bind(c):c},function CompoundComparator(){for(var args=argsToArray(arguments),cs=[],i=0;i<args.length;i++)cs[i]=toCompare(args[i])
var f=function(o1,o2){for(var i=0;i<cs.length;i++){var r=cs[i](o1,o2)
if(0!=r)return r}return 0}
return f.toSQL=function(){return args.map(function(s){return s.toSQL()}).join(",")},f.toMQL=function(){return args.map(function(s){return s.toMQL()}).join(" ")},f.toBQL=function(){return args.map(function(s){return s.toBQL()}).join(" ")},f.toString=f.toSQL,f},function randomAct(){for(var totalWeight=0,i=0;i<arguments.length;i+=2)totalWeight+=arguments[i]
for(var r=Math.random(),i=0,weight=0;i<arguments.length;i+=2)if(weight+=arguments[i],weight/totalWeight>=r)return void arguments[i+1]()},function Object_forEach(obj,fn){for(var key in obj)obj.hasOwnProperty(key)&&fn(obj[key],key)},function predicatedSink(predicate,sink){return predicate!==TRUE&&sink?{__proto__:sink,$UID:sink.$UID,put:function(obj,s,fc){!sink.put||obj&&!predicate.f(obj)||sink.put(obj,s,fc)},remove:function(obj,s,fc){!sink.remove||obj&&!predicate.f(obj)||sink.remove(obj,s,fc)},reset:function(){sink.reset()},toString:function(){return"PredicatedSink("+sink.$UID+", "+predicate+", "+sink+")"}}:sink},function limitedSink(count,sink){var i=0
return{__proto__:sink,$UID:sink.$UID,put:function(obj,s,fc){i++>=count&&fc?fc.stop():sink.put(obj,s,fc)}}},function skipSink(skip,sink){var i=0
return{__proto__:sink,$UID:sink.$UID,put:function(obj,s,fc){i++>=skip&&sink.put(obj,s,fc)}}},function orderedSink(comparator,sink){return comparator=toCompare(comparator),{__proto__:sink,$UID:sink.$UID,i:0,arr:[],put:function(obj,s,fc){this.arr.push(obj)},eof:function(){this.arr.sort(comparator),this.arr.select(sink)}}},function defineLazyProperty(target,name,definitionFn){Object.defineProperty(target,name,{get:function(){var definition=definitionFn.call(this)
return Object.defineProperty(this,name,definition),definition.get?definition.get.call(this):definition.value},configurable:!0})},function multiline(f){var s=f.toString(),start=s.indexOf("/*"),end=s.lastIndexOf("*/")
return s.substring(start+2,end)},function findPageXY(node){for(var x=0,y=0,parent;node;)parent=node,x+=node.offsetLeft,y+=node.offsetTop,node=node.offsetParent
return[x,y,parent]},function findViewportXY(node){var rect=node.getBoundingClientRect()
return[rect.left,rect.top]},function nop(){},function stringtoutf8(str){for(var res=[],i=0;i<str.length;i++){var code=str.charCodeAt(i),count=0
128>code&&res.push(code)}return res},function createGUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=16*Math.random()|0,v="x"===c?r:3&r|8
return v.toString(16)})}]})
var labelize=memoize1(function(str){return capitalize(str.replace(/[a-z][A-Z]/g,function(a){return a.charAt(0)+" "+a.charAt(1)}))}),constantize=memoize1(function(str){return"x"===str?"X_":"y"===str?"Y_":str.replace(/[a-z_][^0-9a-z_]/g,function(a){return a.substring(0,1)+"_"+a.substring(1,2)}).toUpperCase()}),capitalize=memoize1(function(str){return str[0].toUpperCase()+str.substring(1)})
MODEL({extendsProto:"Object",properties:[{name:"$UID",getter:function(){var id=1
return function(){return Object.hasOwnProperty.call(this,"$UID__")?this.$UID__:(this.$UID__=id,id++,this.$UID__)}}()}],methods:[function become(other){for(var local=Object.getOwnPropertyNames(this),i=0;i<local.length;i++)delete this[local[i]]
var remote=Object.getOwnPropertyNames(other)
for(i=0;i<remote.length;i++)Object.defineProperty(this,remote[i],Object.getOwnPropertyDescriptor(other,remote[i]))
this.__proto__=other.__proto__}]}),MODEL({extendsProto:"Array",constants:{oldForEach_:Array.prototype.forEach},methods:[function clone(){return this.slice()},function deepClone(){for(var a=this.clone(),i=0;i<a.length;i++){var o=a[i]
o&&o.deepClone&&(a[i]=o.deepClone())}return a},function forEach(f,opt_this){if(!this||!f||opt_this)return this.oldForEach_.call(this,f,opt_this)
for(var l=this.length,i=0;l>i;i++)f(this[i],i,this)},function diff(other){for(var added=other.slice(0),removed=[],i=0;i<this.length;i++){for(var j=0;j<added.length;j++)if(0==this[i].compareTo(added[j])){added.splice(j,1),j--
break}j==added.length&&removed.push(this[i])}return{added:added,removed:removed}},function binaryInsert(item){for(var start=0,end=this.length-1;end>=start;){var m=start+Math.floor((end-start)/2),c=item.compareTo(this[m])
if(0==c)return this
0>c?end=m-1:start=m+1}return this.splice(start,0,item),this},function union(other){return this.concat(other.filter(function(o){return-1==this.indexOf(o)}.bind(this)))},function intersection(other){return this.filter(function(o){return-1!=other.indexOf(o)})},function intern(){for(var i=0;i<this.length;i++)this[i].intern&&(this[i]=this[i].intern())
return this},function compareTo(other){if(this.length!==other.length)return-1
for(var i=0;i<this.length;i++){var result=this[i].compareTo(other[i])
if(0!==result)return result}return 0},function fReduce(comparator,arr){compare=toCompare(comparator)
for(var result=[],i=0,j=0,k=0;i<this.length&&j<arr.length;){var a=compare(this[i],arr[j])
0>a?result[k++]=this[i++]:0!=a?result[k++]=arr[j++]:(result[k++]=this[i++],result[k++]=arr[j++])}return i!=this.length&&(result=result.concat(this.slice(i))),j!=arr.length&&(result=result.concat(arr.slice(j))),result},function pushAll(arr){return this.push.apply(this,arr),this.length},function mapFind(map){for(var i=0;i<this.length;i++){var result=map(this[i],i)
if(result)return result}},function mapProp(prop){return this.map(function(x){return x[prop]})},function mapCall(){var args=Array.prototype.slice.call(arguments,0),func=args.shift()
return this.map(function(x){return x[func]&&x[func].apply(x[func],args)})}],properties:[{name:"memento",getter:function(){throw"Array's can not be memorized properly as a memento."}}]}),MODEL({extendsProto:"String",methods:[function indexOfIC(a){return a.length>this.length?-1:this.toUpperCase().indexOf(a.toUpperCase())},function equals(other){return 0===this.compareTo(other)},function equalsIC(other){return other&&this.toUpperCase()===other.toUpperCase()},function capitalize(){return this.charAt(0).toUpperCase()+this.slice(1)},function labelize(){return this.replace(/[a-z][A-Z]/g,function(a){return a.charAt(0)+" "+a.charAt(1)}).capitalize()},function compareTo(o){return o==this?0:o>this?-1:1},String.prototype.startsWith||function startsWith(a){return 0==this.lastIndexOf(a,0)},String.prototype.endsWith||function endsWith(a){return this.length-a.length==this.lastIndexOf(a)},function startsWithIC(a){if(a.length>this.length)return!1
for(var l=a.length,i=0;l>i;i++)if(this[i].toUpperCase()!==a[i].toUpperCase())return!1
return!0},function put(obj){return this+obj.toJSON()},function(){var map={}
return function intern(){return map[this]||(map[this]=this.toString())}}(),function hashCode(){var hash=0
if(0==this.length)return hash
for(i=0;i<this.length;i++){var code=this.charCodeAt(i)
hash=(hash<<5)-hash+code,hash&=hash}return hash}]}),MODEL({extendsProto:"Function",methods:[function(){var oldBind=Function.prototype.bind,simpleBind=function(f,self){return function(){return f.apply(self,arguments)}}
return function bind(arg){return 1==arguments.length?simpleBind(this,arg):oldBind.apply(this,argsToArray(arguments))}}(),function equals(o){return this===o},function compareTo(o){return this===o?0:this.name.compareTo(o.name)||1},function o(f2){var f1=this
return function(){return f1.call(this,f2.apply(this,argsToArray(arguments)))}}]}),MODEL({extendsObject:"Math",methods:[function sign(n){return n>0?1:-1}]}),MODEL({extendsProto:"Date",methods:[function toRelativeDateString(){var seconds=Math.floor((Date.now()-this.getTime())/1e3)
if(60>seconds)return"moments ago"
var minutes=Math.floor(seconds/60)
if(1==minutes)return"1 minute ago"
if(60>minutes)return minutes+" minutes ago"
var hours=Math.floor(minutes/60)
if(1==hours)return"1 hour ago"
if(24>hours)return hours+" hours ago"
var days=Math.floor(hours/24)
if(1==days)return"1 day ago"
if(7>days)return days+" days ago"
if(365>days){var year=1900+this.getYear(),noyear=this.toDateString().replace(" "+year,"")
return noyear.substring(4)}return this.toDateString().substring(4)},function equals(o){return o&&o.getTime?this.getTime()===o.getTime():!1},function compareTo(o){if(o===this)return 0
if(!o)return 1
var d=this.getTime()-o.getTime()
return 0==d?0:d>0?1:-1},function toMQL(){return this.getFullYear()+"/"+(this.getMonth()+1)+"/"+this.getDate()},function toBQL(){var str=this.toISOString()
return str.substring(0,str.indexOf("."))}]}),MODEL({extendsProto:"Number",methods:[function compareTo(o){return o==this?0:o>this?-1:1}]}),MODEL({extendsProto:"Boolean",methods:[function compareTo(o){return(this.valueOf()?1:0)-(o?1:0)}]}),MODEL({extendsProto:"RegExp",methods:[function quote(str){return(str+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}]}),console.log.json=function(){for(var args=[],i=0;i<arguments.length;i++){var arg=arguments[i]
args.push(arg&&arg.toJSON?arg.toJSON():arg)}console.log.apply(console,args)},console.log.str=function(){for(var args=[],i=0;i<arguments.length;i++){var arg=arguments[i]
args.push(arg&&arg.toString?arg.toString():arg)}console.log.apply(console,args)},console.log.put=console.log.bind(console),console.log.remove=console.log.bind(console,"remove: "),console.log.error=console.log.bind(console,"error: "),console.log.json.put=console.log.json.bind(console),console.log.json.reduceI=console.log.json.bind(console,"reduceI: "),console.log.json.remove=console.log.json.bind(console,"remove: "),console.log.json.error=console.log.json.bind(console,"error: "),console.log.str.put=console.log.str.bind(console),console.log.str.remove=console.log.str.bind(console,"remove: "),console.log.str.error=console.log.str.bind(console,"error: "),document.put=function(obj){obj.write?obj.write(this):this.write(obj.toString())},window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem,window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.setImmediate,window.Blob&&(Blob.prototype.slice=Blob.prototype.slice||Blob.prototype.webkitSlice),window.XMLHttpRequest&&(XMLHttpRequest.prototype.asend=function(ret,opt_data){var xhr=this
xhr.onerror=function(){console.log("XHR Error: ",arguments)},xhr.onloadend=function(){ret(xhr.response,xhr)},xhr.send(opt_data)}),String.fromCharCode=function(){var oldLookup=String.fromCharCode,lookupTable=[]
return function(a){if(1==arguments.length)return lookupTable[a]||(lookupTable[a]=oldLookup(a))
for(var result="",i=0;i<arguments.length;i++)result+=lookupTable[arguments[i]]||(lookupTable[arguments[i]]=oldLookup(arguments[i]))
return result}}()
var MementoProto={}
Object.defineProperty(MementoProto,"equals",{enumerable:!1,configurable:!0,value:function(o){var keys=Object.keys(this),otherKeys=Object.keys(o)
if(keys.length!=otherKeys.length)return!1
for(var i=0;i<keys.length;i++)if(!equals(this[keys[i]],o[keys[i]]))return!1
return!0}}),!window.WeakMap,MODEL({extendsProto:"Function",methods:[function abind(self){return function(ret){this.apply(self,arguments),ret()}.bind(this)},function ao(f2){var f1=this
return function(ret){var args=argsToArray(arguments)
args[0]=f1.bind(this,ret),f2.apply(this,args)}},function aseq(f2){return f2.ao(this)}]}),MODEL({extendsObject:"GLOBAL",methods:[function anop(ret){ret&&ret(void 0)},function alog(){var args=arguments
return function(ret){console.log.apply(console,args),ret&&ret.apply(this,[].slice.call(arguments,1))}},function aprofile(afunc){return function(ret){var a=argsToArray(arguments)
console.profile("aprofile")
var ret2=function(){console.profileEnd(),ret&&ret(arguments)}
aapply_(afunc,ret2,a)}},function aconstant(v){return function(ret){ret&&ret(v)}},function arepeat(n,afunc){return n?function(ret){var a=argsToArray(arguments)
a.splice(1,0,0,n)
var next=atramp(function(){return a[1]==n-1?(a[0]=ret,void afunc.apply(this,a)):(afunc.apply(this,a),void a[1]++)})
a[0]=next,next.apply(this,a)}:anop},function aforEach(arr,afunc){},function awhile(cond,afunc){return function(ret){var a=argsToArray(arguments),g=function(){return cond()?void afunc.apply(this,a):void ret.apply(void 0,arguments)}
a[0]=g,g.apply(this,a)}},function aif(cond,afunc,aelse){return function(ret){("function"==typeof cond?cond():cond)?afunc.apply(this,arguments):aelse?aelse.apply(this,arguments):ret()}},function aaif(acond,afunc,aelse){return function(ret){var args=argsToArray(arguments)
args[0]=function(c){args[0]=ret,c?afunc.apply(null,args):aelse?aelse.apply(null,args):ret()},acond.apply(null,args)}},function(){var id=1,activeOps={}
return function atime(str,afunc,opt_endCallback,opt_startCallback){var name=str
return aseq(function(ret){activeOps[str]?(name+="-"+id++,activeOps[str]++):activeOps[str]=1
var start=performance.now()
opt_startCallback&&opt_startCallback(name),opt_endCallback||console.time(name),ret.apply(null,[].slice.call(arguments,1))},afunc,function(ret){if(activeOps[str]--,opt_endCallback){var end=performance.now()
opt_endCallback(name,end-start)}else console.timeEnd(name)
ret&&ret.apply(null,[].slice.call(arguments,1))})}}(),function ametric(){return this.atime.apply(this,arguments)},function asleep(ms){return function(ret){window.setTimeout(ret,ms)}},function ayield(){return function(ret){window.setTimeout(ret,0)}},function afuture(){var set=!1,values=void 0,waiters=[]
return{set:function(){if(set)return void console.log("ERROR: redundant set on future")
values=arguments,set=!0
for(var i=0;i<waiters.length;i++)waiters[i].apply(null,values)
return waiters=void 0,this},get:function(ret){return set?void ret.apply(null,values):void waiters.push(ret)}}},function aapply_(f,ret,args){args.unshift(ret),f.apply(this,args)},function arequestqueue(f,opt_lock,opt_max){var lock=opt_lock||{}
lock.q||(lock.q=[],lock.active=null)
var onExit=function(){var next=lock.active=lock.q.pop()
next&&setTimeout(function(){f(onExit,next)},0)},reduceDown=function(o,q){for(var i=q.length-1;i>=0;i--){var result=o.reduce(q[i])
if(result){q.splice(i,1),reduceDown(result,q)
break}}q.push(o)}
return function(o){if(lock.active){var first=o.reduce(lock.active)
if(first&&first.equals(lock.active))return}reduceDown(o,lock.q,lock.q.length-1),lock.q.length>opt_max&&(lock.q.length=opt_max),lock.active||onExit()}},function asynchronized(f,opt_lock){function onExit(ret){return function(){var next=lock.q.shift()
next?setTimeout(next,0):lock.active=!1,ret()}}var lock=opt_lock||{}
return lock.q||(lock.q=[],lock.active=!1),function(ret){return lock.active?void lock.q.push(function(){f(onExit(ret))}):(lock.active=!0,void f(onExit(ret)))}},function atimeout(delay,f,opt_timeoutF){return function(ret){var timedOut=!1,completed=!1
setTimeout(function(){completed||(timedOut=!0,console.log("timeout"),opt_timeoutF&&opt_timeoutF())},delay),f(aseq(function(ret){timedOut||(completed=!0),completed&&ret()},ret))}},function amemo(f,opt_ttl){var memoized=!1,values,waiters,age=0,pending=!1
return function(ret){if(memoized)return ret.apply(null,values),void(void 0!=opt_ttl&&!pending&&Date.now()>age+opt_ttl&&(pending=!0,f(function(){values=arguments,age=Date.now(),pending=!1})))
var first=!waiters
first&&(waiters=[]),waiters.push(ret),first&&f(function(){values=arguments,age=Date.now()
for(var i=0;i<waiters.length;i++)waiters[i]&&waiters[i].apply(null,values)
void 0==opt_ttl&&(f=void 0),memoized=!0,waiters=void 0})}},function amerged(f){var waiters
return function(ret){var first=!waiters
if(first){waiters=[]
var args=argsToArray(arguments)}waiters.push(ret),first&&(args[0]=function(){var calls=waiters
waiters=void 0
for(var i=0;i<calls.length;i++)calls[i]&&calls[i].apply(null,arguments)},f.apply(null,args))}},function mergeAsync(f){var active=!1,args
return function(){if(active)return void(args=argsToArray(arguments))
active=!0
var ret=function(){args?(args.unshift(ret),f.apply(null,args),args=void 0):active=!1},a=argsToArray(arguments)
a.unshift(ret),f.apply(null,a)}},function ao(){for(var ret=arguments[arguments.length-1],i=0;i<arguments.length-1;i++)ret=arguments[i].ao(ret)
return ret},function aseq(){for(var f=arguments[arguments.length-1],i=arguments.length-2;i>=0;i--)f=arguments[i].aseq(f)
return f},function apar(){var aargs=[],count=0,fs=arguments
return function(ret){if(0==fs.length)return void(ret&&ret())
for(var opt_args=Array.prototype.splice.call(arguments,1),ajoin=function(i){if(aargs[i]=Array.prototype.splice.call(arguments,1),++count==fs.length){for(var a=[],j=0;j<fs.length;j++)for(var k=0;k<aargs[j].length;k++)a.push(aargs[j][k])
ret&&ret.apply(null,a)}},i=0;i<fs.length;i++)fs[i].apply(null,[ajoin.bind(null,i)].concat(opt_args))}},function(){var active=!1,jobs=[]
return function atramp(afunc){return function(){if(jobs.push([afunc,arguments]),!active){console.assert(jobs.length<=1,"atramp with multiple jobs"),active=!0
for(var job;null!=(job=jobs.pop());)job[0].apply(this,job[1])
active=!1}}}}(),function arepeatpar(n,afunc){return function(ret){if(0===n)return void(ret&&ret())
for(var aargs=[],count=0,opt_args=Array.prototype.splice.call(arguments,1),ajoin=function(i){if(++count==n){var a=[]
ret&&ret.apply(null,a)}},i=0;n>i;i++)afunc.apply(null,[ajoin.bind(null,i)].concat([i,n]).concat(opt_args))}},function axhr(url,opt_op,opt_params){var op=opt_op||"GET",params=opt_params||[]
return function(ret){var xhr=new XMLHttpRequest
xhr.open(op,url),xhr.asend(function(json){ret(JSON.parse(json))},params&&params.join("&"))}},function futurefn(future){return function(){var args=arguments
future.get(function(f){f.apply(void 0,args)})}},function adelay(afunc,delay){function pump(){if(!timeout&&queue.length){var top=queue.shift(),f=top[0],args=top[1],ret=args[0]
args[0]=function(){ret.apply(null,arguments),pump()},timeout=setTimeout(function(){timeout=0,f.apply(null,args)},delay)}}var queue=[],timeout
return function(){var args=arguments
queue.push([afunc,args]),pump()}},function adebugger(fn){return function(ret){fn.apply(null,arguments)}}]})
var __JSONP_CALLBACKS__={},wrapJsonpCallback=function(){var nextID=0
return function(ret,opt_nonce){var id="c"+nextID++
opt_nonce&&(id+=Math.floor(16777215*Math.random()).toString(16))
var cb=__JSONP_CALLBACKS__[id]=function(data){delete __JSONP_CALLBACKS__[id],ret&&ret.call(this,data)}
return cb.id=id,cb}}(),ajsonp=function(url,params){return function(ret){var cb=wrapJsonpCallback(ret),script=document.createElement("script")
script.src=url+"?callback=__JSONP_CALLBACKS__."+cb.id+(params?"&"+params.join("&"):""),script.onload=function(){document.body.removeChild(this)},script.onerror=function(){cb(null),document.body.removeChild(this)},document.body.appendChild(script)}},StringPS={create:function(str){var o=Object.create(this)
return o.pos=0,o.str_=[str],o.tail_=[],o},set str(str){this.str_[0]=str},get head(){return this.pos>=this.str_[0].length?null:this.str_[0].charAt(this.pos)},get value(){return this.hasOwnProperty("value_")?this.value_:this.str_[0].charAt(this.pos-1)},get tail(){if(!this.tail_[0]){var tail=Object.create(this.__proto__)
tail.str_=this.str_,tail.pos=this.pos+1,tail.tail_=[],this.tail_[0]=tail}return this.tail_[0]},setValue:function(value){var ret=Object.create(this.__proto__)
return ret.str_=this.str_,ret.pos=this.pos,ret.tail_=this.tail_,ret.value_=value,ret},toString:function(){return this.str_[0].substring(this.pos)}},parserVersion_=1,TrapPStream={create:function(ps){return{__proto__:this,head:ps.head,value:ps.value,goodChar:!1}},getValue:function(){return this.value},setValue:function(v){return this.value=v,this},get tail(){return this.goodChar=!0,{value:this.value,getValue:function(){return this.value},setValue:function(v){this.value=v}}}},DEBUG_PARSE=!1,grammar={parseString:function(str){var ps=this.stringPS
ps.str=str
var res=this.parse(this.START,ps)
return res&&res.value},parse:function(parser,pstream){DEBUG_PARSE&&pstream.str_&&(console.log(new Array(pstream.pos).join("."),pstream.head),console.log(pstream.pos+"> "+pstream.str_[0].substring(0,pstream.pos)+"("+pstream.head+")"))
var ret=parser.call(this,pstream)
return DEBUG_PARSE&&console.log(parser+" ==> "+!!ret+"  "+(ret&&ret.value)),ret},"export":function(str){return this[str].bind(this)},addAction:function(sym,action){var p=this[sym]
this[sym]=function(ps){var val=ps.value,ps2=this.parse(p,ps)
return ps2&&ps2.setValue(action.call(this,ps2.value,val))},this[sym].toString=function(){return"<<"+sym+">>"}},addActions:function(map){for(var key in map)this.addAction(key,map[key])
return this}}
defineTTLProperty(grammar,"stringPS",3e4,function(){return StringPS.create("")})
var SkipGrammar={create:function(gramr,skipp){return{__proto__:gramr,skip_:!0,parse:function(parser,pstream){return this.skip_&&(pstream=this.skip.call(grammar,pstream)||pstream),this.__proto__.parse.call(this,parser,pstream)},skip:skipp}}},__ROOT__={}
MODEL({name:"EventService",extendsModel:"__ROOT__",constants:{UNSUBSCRIBE_EXCEPTION:"unsubscribe",WILDCARD:"*"},methods:{oneTime:function(listener){return function(){throw listener.apply(this,argsToArray(arguments)),EventService.UNSUBSCRIBE_EXCEPTION}},consoleLog:function(listener){return function(){var args=argsToArray(arguments)
console.log(args),listener.apply(this,args)}},merged:function(listener,opt_delay,opt_X){var setTimeoutX=opt_X&&opt_X.setTimeout||setTimeout,delay=opt_delay||16
return function(){var triggered=!1,unsubscribed=!1,lastArgs=null,f=function(){if(lastArgs=arguments,unsubscribed)throw EventService.UNSUBSCRIBE_EXCEPTION
if(!triggered){triggered=!0
try{setTimeoutX(function(){triggered=!1
var args=argsToArray(lastArgs)
lastArgs=null
try{listener.apply(this,args)}catch(x){x===EventService.UNSUBSCRIBE_EXCEPTION&&(unsubscribed=!0)}},delay)}catch(e){throw EventService.UNSUBSCRIBE_EXCEPTION}}}
return DEBUG&&(f.toString=function(){return"MERGED("+delay+", "+listener.$UID+", "+listener+")"}),f}()},framed:function(listener,opt_X){opt_X=opt_X||this.X
var requestAnimationFrameX=opt_X&&opt_X.requestAnimationFrame||requestAnimationFrame
return function(){var triggered=!1,unsubscribed=!1,lastArgs=null,f=function(){if(lastArgs=arguments,unsubscribed)throw EventService.UNSUBSCRIBE_EXCEPTION
triggered||(triggered=!0,requestAnimationFrameX(function(){triggered=!1
var args=argsToArray(lastArgs)
lastArgs=null
try{listener.apply(this,args)}catch(x){x===EventService.UNSUBSCRIBE_EXCEPTION&&(unsubscribed=!0)}}))}
return DEBUG&&(f.toString=function(){return"ANIMATE("+listener.$UID+", "+listener+")"}),f}()},async:function(listener,opt_X){return this.delay(0,listener,opt_X)},delay:function(delay,listener,opt_X){return opt_X=opt_X||this.X,function(){var args=argsToArray(arguments);(opt_X&&opt_X.setTimeout?opt_X.setTimeout:setTimeout)(function(){listener.apply(this,args)},delay)}},hasListeners:function(opt_topic){return opt_topic?(console.log("TODO: haslisteners"),!0):!!this.subs_},publish:function(topic){return this.subs_?this.pub_(this.subs_,0,topic,this.appendArguments([this,topic],arguments,1)):0},publishAsync:function(topic){var args=argsToArray(arguments),me=this
setTimeout(function(){me.publish.apply(me,args)},0)},deepPublish:function(topic){return this.publish.apply(this,arguments)},lazyPublish:function(topic,fn){return this.hasListeners(topic)?this.publish.apply(this,fn()):0},subscribe:function(topic,listener){this.subs_||(this.subs_={}),this.sub_(this.subs_,0,topic,listener)},unsubscribe:function(topic,listener){this.subs_&&this.unsub_(this.subs_,0,topic,listener)},unsubscribeAll:function(){this.sub_={}},pub_:function(map,topicIndex,topic,msg){var count=0
if(null==map)return 0
if(topicIndex<topic.length){var t=topic[topicIndex]
if(t==this.WILDCARD)return this.notifyListeners_(topic,map,msg)
t&&(count+=this.pub_(map[t],topicIndex+1,topic,msg))}return count+=this.notifyListeners_(topic,map[null],msg)},sub_:function(map,topicIndex,topic,listener){if(topicIndex==topic.length)map[null]||(map[null]=[]),map[null].push(listener)
else{var key=topic[topicIndex]
map[key]||(map[key]={}),this.sub_(map[key],topicIndex+1,topic,listener)}},unsub_:function(map,topicIndex,topic,listener){if(topicIndex==topic.length){if(!map[null])return!0
map[null].deleteI(listener)||console.warn("phantom unsubscribe, size: ",map[null].length),map[null].length||delete map[null]}else{var key=topic[topicIndex]
if(!map[key])return!1
this.unsub_(map[key],topicIndex+1,topic,listener)&&delete map[key]}return 0==Object.keys(map).length},notifyListener_:function(topic,listener,msg){try{listener.apply(null,msg)}catch(err){return err!==this.UNSUBSCRIBE_EXCEPTION&&console.error("Error delivering event (removing listener): ",topic.join("."),err),!1}return!0},notifyListeners_:function(topic,listeners,msg){if(null==listeners)return 0
if(Array.isArray(listeners)){for(var i=0;i<listeners.length;i++){var listener=listeners[i]
this.notifyListener_(topic,listener,msg)||(listeners.splice(i,1),i--)}return listeners.length}var count=0
for(var key in listeners)count+=this.notifyListeners_(topic,listeners[key],msg)
return count},appendArguments:function(a,args,start){for(var i=start;i<args.length;i++)a.push(args[i])
return a}}}),MODEL({name:"PropertyChangeSupport",extendsModel:"EventService",constants:{PROPERTY_TOPIC:"property"},methods:{propertyTopic:memoize1(function(property){return[this.PROPERTY_TOPIC,property]}),propertyChange:function(property,oldValue,newValue){this.subs_&&(null==property||oldValue!==newValue&&(oldValue===oldValue||newValue===newValue))&&this.publish(this.propertyTopic(property),oldValue,newValue)},propertyChange_:function(propertyTopic,oldValue,newValue){this.subs_&&(oldValue===newValue||oldValue!==oldValue&&newValue!==newValue||this.publish(propertyTopic,oldValue,newValue))},globalChange:function(){this.publish(this.propertyTopic(this.WILDCARD),null,null)},addListener:function(listener){console.assert(listener,"Listener cannot be null."),this.addPropertyListener(null,listener)},removeListener:function(listener){this.removePropertyListener(null,listener)},addPropertyListener:function(property,listener){this.subscribe(this.propertyTopic(property),listener)},removePropertyListener:function(property,listener){this.unsubscribe(this.propertyTopic(property),listener)},propertyValue:function(prop){if(!prop)throw"Property Name required for propertyValue()."
var props=this.props_||(this.props_={})
return Object.hasOwnProperty.call(props,prop)?props[prop]:props[prop]=PropertyValue.create(this,prop)}}})
var FunctionStack={create:function(){var stack=[!1]
return{stack:stack,push:function(f){stack.unshift(f)},pop:function(){stack.shift()}}}},PropertyValue={create:function(obj,prop){var o=Object.create(this)
return o.$UID=obj.$UID+"."+prop,o.obj=obj,o.prop=prop,o},get:function(){return this.obj[this.prop]},set:function(val){this.obj[this.prop]=val},get value(){return this.get()},set value(val){this.set(val)},addListener:function(listener){this.obj.addPropertyListener(this.prop,listener)},removeListener:function(listener){this.obj.removePropertyListener(this.prop,listener)},toString:function(){return"PropertyValue("+this.prop+")"}},Events={listeners_:new WeakMap,recordListener:function(src,dst,listener,opt_dontCallListener){var srcMap=this.listeners_.get(src)
srcMap||(srcMap=new WeakMap,this.listeners_.set(src,srcMap)),console.assert(!srcMap.get(dst),"recordListener: duplicate follow"),srcMap.set(dst,listener),src.addListener(listener),opt_dontCallListener||listener()},identity:function(x){return x},follow:function(srcValue,dstValue){srcValue&&dstValue&&this.recordListener(srcValue,dstValue,function(){var sv=srcValue.get(),dv=dstValue.get()
equals(sv,dv)||dstValue.set(sv)})},unfollow:function(src,dst){if(src&&dst){var srcMap=this.listeners_.get(src)
if(srcMap){var listener=srcMap.get(dst)
listener&&(srcMap["delete"](dst),src.removeListener(listener))}}},map:function(srcValue,dstValue,f){srcValue&&dstValue&&this.recordListener(srcValue,dstValue,function(){var s=f(srcValue.get()),d=dstValue.get()
equals(s,d)||dstValue.set(s)})},link:function(srcValue,dstValue){this.follow(srcValue,dstValue),this.follow(dstValue,srcValue)},relate:function(srcValue,dstValue,f,fprime,removeFeedback){if(srcValue&&dstValue){var feedback=!1,l=function(sv,dv,f){return function(){if(!removeFeedback||!feedback){var s=f(sv.get()),d=dv.get()
equals(s,d)||(feedback=!0,dv.set(s),feedback=!1)}}},l1=l(srcValue,dstValue,f),l2=l(dstValue,srcValue,fprime)
this.recordListener(srcValue,dstValue,l1,!0),this.recordListener(dstValue,srcValue,l2,!0),l1()}},unlink:function(value1,value2){this.unfollow(value1,value2),this.unfollow(value2,value1)},dynamic:function(fn,opt_fn,opt_X){var fn2=opt_fn?function(){opt_fn(fn())}:fn,listener=EventService.framed(fn2,opt_X),propertyValues=[]
fn(),Events.onGet.push(function(obj,name,value){obj.propertyValue(name).addListener(listener),propertyValues.push(obj.propertyValue(name))})
var ret=fn()
return Events.onGet.pop(),opt_fn&&opt_fn(ret),{destroy:function(){propertyValues.forEach(function(p){p.removeListener(listener)})}}},onSet:FunctionStack.create(),onGet:FunctionStack.create()}
MODEL({name:"Movement",methods:{distance:function(x,y){return Math.sqrt(x*x+y*y)},o:function(f1,f2){return function(x){return f1(f2(x))}},avg:function(f1,f2){return function(x){return(f1(x)+f2(x))/2}},linear:function(x){return x},back:function(x){return.5>x?2*x:2-2*x},accelerate:function(x){return(Math.sin(x*Math.PI-Math.PI/2)+1)/2},easeIn:function(a){var v=1/(1-a/2)
return function(x){var x1=Math.min(x,a),x2=Math.max(x-a,0)
return(a?.5*x1*(x1/a)*v:0)+x2*v}},reverse:function(f){return function(x){return 1-f(1-x)}},easeOut:function(b){return Movement.reverse(Movement.easeIn(b))},oscillate:function(b,a,opt_c){var c=opt_c||3
return function(x){if(1-b>x)return x/(1-b)
var t=(x-1+b)/b
return 1+2*(1-t)*a*Math.sin(2*c*Math.PI*t)}},bounce:function(b,a,opt_c){var c=opt_c||3
return function(x){if(1-b>x)return x/(1-b)
var t=(x-1+b)/b
return 1-2*(1-t)*a*Math.abs(Math.sin(2*c*Math.PI*t))}},bounce2:function(a){var v=1/(1-a)
return function(x){if(1-a>x)return v*x
var p=(x-1+a)/a
return 1-(x-1+a)*v/2}},stepBack:function(a){return function(x){return a>x?-x:-2*a+(1+2*a)*x}},ease:function(a,b){return Movement.o(Movement.easeIn(a),Movement.easeOut(b))},seq:function(f1,f2){return f1&&f2?function(){f1.apply(this,argsToArray(arguments)),f2()}:f1?f1:f2},liveAnimations_:0,animate:function(duration,fn,opt_interp,opt_onEnd,opt_X){var requestAnimationFrameX=opt_X&&opt_X.requestAnimationFrame||requestAnimationFrame
if(0==duration)return Movement.seq(fn,opt_onEnd)
var interp=opt_interp||Movement.linear
return function(){function stop(){var onEnd=opt_onEnd
if(!stopped&&(Movement.liveAnimations_--,stopped=!0,onEnd&&onEnd(),onEnd=null,0===Movement.liveAnimations_)){var tasks=Movement.idleTasks_
tasks&&tasks.length>0&&(Movement.idleTasks_=[],setTimeout(function(){var i
if(Movement.liveAnimations_>0)for(i=0;i<tasks.length;i++)Movement.idleTasks_.push(tasks[i])
else for(i=0;i<tasks.length;i++)tasks[i]()},20))}}function go(){if(!stopped){for(var now=Date.now(),p=interp((Math.min(now,startTime+duration)-startTime)/duration),last=now>=startTime+duration,i=0;i<ranges.length;i++){var r=ranges[i],obj=r[0],name=r[1],value1=r[2],value2=r[3]
obj[name]=last?value2:value1+(value2-value1)*p}last?stop():requestAnimationFrameX(go)}}var ranges=[],stopped=!1
fn&&(Events.onSet.push(function(obj,name,value2){ranges.push([obj,name,obj[name],value2])}),fn.apply(this,argsToArray(arguments)),Events.onSet.pop())
var startTime=Date.now()
if(ranges.length>0)Movement.liveAnimations_++,requestAnimationFrameX(go)
else{var setTimeoutX=opt_X&&opt_X.setTimeout||setTimeout
setTimeoutX(stop,duration)}return stop}},whenIdle:function(fn){return function(){if(Movement.liveAnimations_>0){Movement.idleTasks_||(Movement.idleTasks_=[])
var args=arguments
Movement.idleTasks_.push(function(){fn.apply(fn,args)})}else fn.apply(fn,arguments)}},compile:function(a,opt_rest){function noop(){}function isPause(op){return Array.isArray(op)&&0==op[0]}function compilePause(op,rest){return function(){document.onclick=function(){document.onclick=null,rest()}}}function isSimple(op){return Array.isArray(op)&&"number"==typeof op[0]}function compileSimple(op,rest){return op[3]=Movement.seq(op[3],rest),function(){Movement.animate.apply(null,op)()}}function isParallel(op){return Array.isArray(op)&&Array.isArray(op[0])}function compileParallel(op,rest){var join=function(num){return function(){--num||rest()}}(op.length)
return function(){for(var i=0;i<op.length;i++)isSimple(op[i])?Movement.animate(op[i][0],op[i][1],op[i][2],Movement.seq(op[i][3],join))():Movement.compile(op[i],join)()}}function compileFn(fn,rest){return Movement.seq(fn,rest)}function compile_(a,i){if(i>=a.length)return opt_rest||noop
var rest=compile_(a,i+1),op=a[i]
return isPause(op)?compilePause(op,rest):isSimple(op)?compileSimple(op,rest):isParallel(op)?compileParallel(op,rest):compileFn(op,rest)}return compile_(a,0)},onIntersect:function(o1,o2,fn){o1.model_.R?Events.dynamic(function(){o1.x,o1.y,o2.x,o2.y},function(){var dx=o1.x-o2.x,dy=o1.y-o2.y,d=dx*dx+dy*dy,r2=o1.r+o2.r
r2*r2>d&&fn.call(null,o1,o2)}):Events.dynamic(function(){o1.x,o1.y,o2.x,o2.y},function(){(o1.x<=o2.x&&o1.x+o1.width>o2.x&&o1.y<=o2.y&&o1.y+o1.height>o2.y||o2.x<=o1.x&&o2.x+o2.width>o1.x&&o2.y<=o1.y&&o2.y+o2.height>o1.y)&&fn.call(null,o1,o2)})},stepTowards:function(src,dst,maxStep){var dx=src.x-dst.x,dy=src.y-dst.y,theta=Math.atan2(dy,dx),r=Math.sqrt(dx*dx+dy*dy)
r=0>r?Math.max(-maxStep,r):Math.min(maxStep,r),dst.x+=r*Math.cos(-theta),dst.y-=r*Math.sin(-theta)},moveTowards:function(t,body,sat,v){var bodyX=body.propertyValue("x"),bodyY=body.propertyValue("y"),satX=sat.propertyValue("x"),satY=sat.propertyValue("y")
t.addListener(function(){var dx=bodyX.get()-satX.get(),dy=bodyY.get()-satY.get(),theta=Math.atan2(dy,dx),r=Math.sqrt(dx*dx+dy*dy)
r=0>r?Math.max(-v,r):Math.min(v,r),satX.set(satX.get()+r*Math.cos(-theta)),satY.set(satY.get()-r*Math.sin(-theta))})},orbit:function(t,body,sat,r,p,opt_start){var bodyX=body.x$,bodyY=body.y$,satX=sat.x$,satY=sat.y$,start=opt_start||0
t.addListener(EventService.framed(function(){var time=t.time
satX.set(bodyX.get()+r*Math.sin(time/p*Math.PI*2+start)),satY.set(bodyY.get()+r*Math.cos(time/p*Math.PI*2+start))}))},strut:function(mouse,c,dx,dy){Events.dynamic(function(){mouse.x,mouse.y},function(){c.x=mouse.x+dx,c.y=mouse.y+dy})},gravity:function(c,opt_a,opt_theta){var a=opt_a||1,theta=opt_theta||1.5*Math.PI
Events.dynamic(function(){c.vx,c.vy},function(){c.vy+=a})},friction:function(c,opt_coef){var coef=opt_coef||.9
Events.dynamic(function(){c.vx,c.vy},function(){c.vx=Math.abs(c.vx)<.001?0:c.vx*coef,c.vy=Math.abs(c.vy)<.001?0:c.vy*coef})},inertia:function(c){Events.dynamic(function(){c.vx,c.vy,c.x,c.y},function(){Math.abs(c.vx)>.001&&(c.x+=c.vx),Math.abs(c.vy)>.001&&(c.y+=c.vy)})},spring:function(mouse,c,dx,dy,opt_strength){var strength=opt_strength||6,d=Movement.distance(dx,dy)
Events.dynamic(function(){mouse.x,mouse.y,c.x,c.y,c.vx,c.vy},function(){if(0===dx&&0===dy)c.x=mouse.x,c.y=mouse.y
else{var dx2=mouse.x+dx-c.x,dy2=mouse.y+dy-c.y,d2=Movement.distance(dx2,dy2),dv=strength*d2/d
if(Math.abs(dv)<.01)return
var a=Math.atan2(dy2,dx2)
c.vx+=dv*Math.cos(a),c.vy+=dv*Math.sin(a)}})},spring2:function(c1,c2,length,opt_strength){var strength=opt_strength||4
Events.dynamic(function(){c1.x,c1.y,c2.x,c2.y},function(){var d=c1.distanceTo(c2),a=Math.atan2(c2.y-c1.y,c2.x-c1.x)
d>length?(c1.applyMomentum(strength*(d/length-1),a),c2.applyMomentum(-strength*(d/length-1),a)):length>d&&(c1.applyMomentum(-strength*(length/d-1),a),c2.applyMomentum(strength*(length/d-1),a))})},createAnimatedPropertyInstallFn:function(duration,interpolation){return function(prop){this.defineProperty({name:prop.name+"$AnimationLatch",defaultValue:0,hidden:!0,documentation:function(){}})
var actualSetter=this.__lookupSetter__(prop.name)
this.defineProperty({name:prop.name+"$AnimationSetValue",defaultValue:0,hidden:!0,documentation:function(){},postSet:function(_,nu){actualSetter.call(this,nu)}}),this.__defineSetter__(prop.name,function(nu){var latch=this[prop.name+"$AnimationLatch"]
latch&&latch()
var anim=Movement.animate(duration,function(){this[prop.name+"$AnimationSetValue"]=nu}.bind(this),interpolation)
this[prop.name+"$AnimationLatch"]=anim()})}}}})
var AbstractFormatter={keyify:function(str){return'"'+str+'"'},stringify:function(obj){var buf=""
return this.output(function(){for(var i=0;i<arguments.length;i++)buf+=arguments[i]},obj),buf},stringifyObject:function(obj,opt_defaultModel){var buf=""
return this.outputObject_(function(){for(var i=0;i<arguments.length;i++)buf+=arguments[i]},obj,opt_defaultModel),buf},where:function(p){return{__proto__:this,p:p.f&&p.f.bind(p)||p}},p:function(){return!0}},JSONUtil={escape:function(str){return str.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/[\x00-\x1f]/g,function(c){return"\\u00"+(c.charCodeAt(0)<16?"0"+c.charCodeAt(0).toString(16):c.charCodeAt(0).toString(16))})},parseToMap:function(str){return eval("("+str+")")},parse:function(X,str,seq){return this.mapToObj(X,this.parseToMap(str),void 0,seq)},arrayToObjArray:function(X,a,opt_defaultModel,seq){for(var i=0;i<a.length;i++)!DEBUG&&a[i].debug?(a.splice(i,1),i--):a[i]=this.mapToObj(X,a[i],opt_defaultModel,seq)
return a},mapToObj:function(X,obj,opt_defaultModel,seq){if(!obj||"object"==typeof obj.model_)return obj
if(Array.isArray(obj))return this.arrayToObjArray(X,obj,void 0,seq)
if(obj instanceof Function)return obj
if(obj instanceof Date)return obj
if(obj instanceof Object){var j=0
for(var key in obj)"model_"!=key&&"prototype_"!=key&&(obj[key]=this.mapToObj(X,obj[key],null,seq)),j++
if(opt_defaultModel&&!obj.model_)return opt_defaultModel.create(obj)
if(obj.model_){var newObj=X.lookup(obj.model_)
if(!newObj||!newObj.finished__){var future=afuture()
return seq&&seq.push(future.get),arequire(obj.model_,X)(function(model){if(!model)return DEBUG&&"Template"!==obj.model_&&"ArrayProperty"!==obj.model_&&"ViewFactoryProperty"!==obj.model_&&"Documentation"!==obj.model_&&"DocumentationProperty"!==obj.model_&&"CSSProperty"!==obj.model_&&"FunctionProperty"!==obj.model_&&console.warn("Failed to dynamically load: ",obj.model_),void future.set(obj)
var tmp=model.create(obj)
obj.become(tmp),future.set(obj)}),obj}return newObj?newObj.create(obj,X):obj}return obj}return obj},compact:{__proto__:AbstractFormatter,output:function(out,obj,opt_defaultModel){Array.isArray(obj)?this.outputArray_(out,obj):"string"==typeof obj?(out('"'),out(JSONUtil.escape(obj)),out('"')):obj instanceof Function?this.outputFunction_(out,obj):obj instanceof Date?out(obj.getTime()):obj instanceof RegExp?out(obj.toString()):obj instanceof Object?obj.model_?this.outputObject_(out,obj,opt_defaultModel):this.outputMap_(out,obj):"number"==typeof obj?(isFinite(obj)||(obj=null),out(obj)):out(void 0===obj?null:obj)},outputObject_:function(out,obj,opt_defaultModel){var str="",first=!0
out("{"),obj.model_.id!==opt_defaultModel&&(this.outputModel_(out,obj),first=!1)
var properties=obj.model_.getRuntimeProperties()
for(var key in properties){var prop=properties[key]
if(this.p(prop)&&prop.name in obj.instance_){var val=obj[prop.name]
if(Array.isArray(val)&&!val.length)continue
first||out(","),out(this.keyify(prop.name),": "),Array.isArray(val)&&prop.subType?this.outputArray_(out,val,prop.subType):this.output(out,val),first=!1}}out("}")},outputModel_:function(out,obj){out('model_:"'),obj.model_["package"]&&out(obj.model_["package"],"."),out(obj.model_.name,'"')},outputMap_:function(out,obj){var str="",first=!0
out("{")
for(var key in obj){var val=obj[key]
first||out(","),out(this.keyify(key),": "),this.output(out,val),first=!1}out("}")},outputArray_:function(out,a,opt_defaultModel){if(0==a.length)return out("[]"),out
var str="",first=!0
out("[")
for(var i=0;i<a.length;i++,first=!1){var obj=a[i]
first||out(","),this.output(out,obj,opt_defaultModel)}out("]")},outputFunction_:function(out,obj){out(obj)}},pretty:{__proto__:AbstractFormatter,output:function(out,obj,opt_defaultModel,opt_indent){var indent=opt_indent||""
Array.isArray(obj)?this.outputArray_(out,obj,null,indent):"string"==typeof obj?(out('"'),out(JSONUtil.escape(obj)),out('"')):obj instanceof Function?this.outputFunction_(out,obj,indent):obj instanceof Date?out(obj.getTime()):obj instanceof RegExp?out(obj.toString()):obj instanceof Object?obj.model_?this.outputObject_(out,obj,opt_defaultModel,indent):this.outputMap_(out,obj,indent):"number"==typeof obj?(isFinite(obj)||(obj=null),out(obj)):(void 0===obj&&(obj=null),out(obj))},outputObject_:function(out,obj,opt_defaultModel,opt_indent){var indent=opt_indent||"",nestedIndent=indent+"   ",str="",first=!0
out(indent,"{\n"),obj.model_.id&&obj.model_.id!==opt_defaultModel&&(this.outputModel_(out,obj,nestedIndent),first=!1)
var properties=obj.model_.getRuntimeProperties()
for(var key in properties){var prop=properties[key]
if(this.p(prop)&&"parent"!==prop.name&&prop.name in obj.instance_){var val=obj[prop.name]
if(Array.isArray(val)&&!val.length)continue
first||out(",\n"),out(nestedIndent,this.keyify(prop.name),": "),Array.isArray(val)&&prop.subType?this.outputArray_(out,val,prop.subType,nestedIndent):this.output(out,val,null,nestedIndent),first=!1}}out("\n",indent,"}")},outputModel_:function(out,obj,indent){out(indent,'"model_": "',obj.model_.id,'"')},outputMap_:function(out,obj,opt_indent){var indent=opt_indent||"",nestedIndent=indent+"   ",str="",first=!0
out(indent,"{\n",nestedIndent)
for(var key in obj){var val=obj[key]
first||out(",\n"),out(nestedIndent,this.keyify(key),": "),this.output(out,val,null,nestedIndent),first=!1}out("\n",indent,"}")},outputArray_:function(out,a,opt_defaultModel,opt_indent){if(0==a.length)return out("[]"),out
var indent=opt_indent||"",nestedIndent=indent+"   ",str="",first=!0
out("[\n")
for(var i=0;i<a.length;i++,first=!1){var obj=a[i]
first||out(",\n"),this.output(out,obj,opt_defaultModel,nestedIndent)}out("\n",indent,"]")},outputFunction_:function(out,obj,indent){var str=obj.toString(),lines=str.split("\n")
if(1==lines.length)return void out(str)
for(var minIndent=1e4,i=0;i<lines.length;i++){for(var j=0;j<lines[i].length&&" "===lines[i].charAt(j)&&minIndent>j;j++);j>0&&minIndent>j&&(minIndent=j)}if(1e4===minIndent)return void out(str)
for(var i=0;i<lines.length;i++)lines[i].length&&" "===lines[i].charAt(0)&&(lines[i]=indent+lines[i].substring(minIndent)),out(lines[i]),i<lines.length-1&&out("\n")}},moreCompact:{__proto__:AbstractFormatter},compressed:{__proto__:AbstractFormatter,stringify:function(obj){return Iuppiter.Base64.encode(Iuppiter.compress(JSONUtil.compact.stringify(obj),!0))}}}
JSONUtil.prettyModel={__proto__:JSONUtil.pretty,outputModel_:function(out,obj,indent){out(indent,'model_: "',obj.model_.id,'"')},keys_:{},keyify:function(str){return this.keys_.hasOwnProperty(str)||(this.keys_[str]=/^[a-zA-Z\$_][0-9a-zA-Z$_]*$/.test(str)?str:'"'+str+'"'),this.keys_[str]}},JSONUtil.stringify=JSONUtil.pretty.stringify.bind(JSONUtil.pretty),JSONUtil.stringifyObject=JSONUtil.pretty.stringifyObject.bind(JSONUtil.pretty),JSONUtil.output=JSONUtil.pretty.output.bind(JSONUtil.pretty),JSONUtil.where=JSONUtil.pretty.where.bind(JSONUtil.pretty)
var NOT_TRANSIENT=function(prop){return!prop["transient"]},XMLParser={__proto__:grammar,START:seq1(1,sym("whitespace"),sym("tag"),sym("whitespace")),tag:seq("<",sym("tagName"),sym("whitespace"),repeat(sym("attribute"),sym("whitespace")),sym("whitespace"),">",repeat(alt(sym("tag"),sym("text"))),"</",sym("tagName"),">"),label:str(plus(notChars(" =/	\r\n<>'\""))),tagName:sym("label"),text:str(plus(notChar("<"))),attribute:seq(sym("label"),"=",sym("value")),value:str(alt(seq1(1,'"',repeat(notChar('"')),'"'),seq1(1,"'",repeat(notChar("'")),"'"))),whitespace:repeat(alt(" ","	","\r","\n"))}
XMLParser.addActions({tag:function(xs){if(xs[1]!=xs[8])return void 0
var obj={tag:xs[1],attrs:{},children:xs[6]}
return xs[3].forEach(function(attr){obj.attrs[attr[0]]=attr[2]}),obj}})
var XMLUtil={escape:function(str){return str&&str.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},unescape:function(str){return str&&str.toString().replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")},escapeAttr:function(str){return str&&str.replace(/"/g,"&quot;")},unescapeAttr:function(str){return str&&str.replace(/&quot;/g,'"')},parse:function(str){var result=XMLParser.parseString(str)
return result?this.parseArray(result.children):result},parseObject:function(tag){var obj={},self=this
if(tag.children.forEach(function(c){if("object"==typeof c&&c.attrs&&c.attrs.name){var result
if(c.attrs.type&&"function"==c.attrs.type){var code=XMLUtil.unescape(c.children.join(""))
result=code.startsWith("function")?eval("("+code+")"):new Function(code)}else result=self.parseArray(c.children)
obj[self.unescapeAttr(c.attrs.name)]=result}}),!tag.attrs.model)return obj
var model=this.unescapeAttr(tag.attrs.model)
return GLOBAL[model]?GLOBAL[model].create(obj):obj},parseArray:function(a){var self=this,ret=[]
return a.forEach(function(x){"object"==typeof x&&ret.push("i"==x.tag?XMLUtil.unescape(x.children[0]):self.parseObject(x))}),ret.length?ret:XMLUtil.unescape(a.join(""))},compact:{stringify:function(obj){var buf=[]
return this.output(buf.push.bind(buf),obj),"<foam>"+buf.join("")+"</foam>"},output:function(out,obj){Array.isArray(obj)?this.outputArray_(out,obj):"string"==typeof obj?out(XMLUtil.escape(obj)):obj instanceof Function?this.outputFunction_(out,obj):obj instanceof Object?obj.model_?this.outputObject_(out,obj):this.outputMap_(out,obj):out(obj)},outputObject_:function(out,obj){out('<object model="',XMLUtil.escapeAttr(obj.model_.name),'">')
var properties=obj.model_.getRuntimeProperties()
for(var key in properties){var prop=properties[key]
if("parent"!==prop.name&&obj.instance_&&prop.name in obj.instance_){var val=obj[prop.name]
if(Array.isArray(val)&&0==val.length)continue
if(val==prop.defaultValue)continue
out('<property name="',XMLUtil.escapeAttr(prop.name),'" '+("function"==typeof val?'type="function"':"")+">"),this.output(out,val),out("</property>")}}out("</object>")},outputMap_:function(out,obj){out("<object>")
for(var key in obj){var val=obj[key]
out('<property name="',XMLUtil.escapeAttr(key),'">'),this.output(out,val),out("</property>")}out("</object>")},outputArray_:function(out,a){if(0==a.length)return out
for(var i=0;i<a.length;i++,first=!1){var obj=a[i]
"string"==typeof obj||"number"==typeof obj?out("<i>",XMLUtil.escape(obj),"</i>"):this.output(out,obj)}},outputFunction_:function(out,f){out(XMLUtil.escape(f.toString()))}},pretty:{stringify:function(obj){var buf=[]
return this.output(buf.push.bind(buf),obj),"<foam>\n"+buf.join("")+"</foam>\n"},output:function(out,obj,opt_indent){var indent=opt_indent||""
if(Array.isArray(obj))this.outputArray_(out,obj,indent)
else if("string"==typeof obj)out(XMLUtil.escape(obj))
else if(obj instanceof Function)this.outputFunction_(out,obj,indent)
else if(obj instanceof Object)try{obj.model_&&"string"!=typeof obj.model_?this.outputObject_(out,obj,indent):this.outputMap_(out,obj,indent)}catch(x){console.log("toXMLError: ",x)}else out(obj)},outputObject_:function(out,obj,opt_indent){var indent=opt_indent||"",nestedIndent=indent+"  "
out(indent,'<object model="',XMLUtil.escapeAttr(obj.model_.name),'">')
var properties=obj.model_.getRuntimeProperties()
for(var key in properties){var prop=properties[key]
if("parent"!==prop.name&&obj.instance_&&prop.name in obj.instance_){var val=obj[prop.name]
if(Array.isArray(val)&&0==val.length)continue
if(val==prop.defaultValue)continue
var type="function"==typeof obj[prop.name]?' type="function"':""
out("\n",nestedIndent,'<property name="',XMLUtil.escapeAttr(prop.name),'"',type,">"),this.output(out,val,nestedIndent),out("</property>")}}out("\n",indent,"</object>"),out("\n")},outputMap_:function(out,obj,opt_indent){var indent=opt_indent||"",nestedIndent=indent+"  "
out(indent,"<object>")
for(var key in obj){var val=obj[key]
out("\n",nestedIndent,'<property name="',XMLUtil.escapeAttr(key),'">'),this.output(out,val,nestedIndent),out("</property>")}out("\n",indent,"</object>\n")},outputArray_:function(out,a,opt_indent){if(0==a.length)return out
for(var indent=opt_indent||"",nestedIndent=indent+"  ",i=0;i<a.length;i++,first=!1){var obj=a[i]
out("\n"),"string"==typeof obj||"number"==typeof obj?out(nestedIndent,"<i>",XMLUtil.escape(obj),"</i>"):this.output(out,obj,nestedIndent)}out("\n",indent)},outputFunction_:function(out,f,opt_indent){out(XMLUtil.escape(f.toString())+"\n"+(opt_indent||""))}}}
XMLUtil.stringify=XMLUtil.pretty.stringify.bind(XMLUtil.pretty),XMLUtil.output=XMLUtil.pretty.output.bind(XMLUtil.pretty),GLOBAL.lookupCache_={}
var X=sub({}),foam=X.foam={},registerFactory=function(model,factory){},registerModelForModel=function(modelType,targetModel,model){},registerFactoryForModel=function(factory,targetModel,model){},JSONParser=SkipGrammar.create({__proto__:grammar,START:copyInput(sym("objAsString")),objAsString:copyInput(sym("obj")),obj:seq1(1,"{",repeat(sym("pair"),","),"}"),pair:seq(sym("key"),":",sym("value")),key:alt(sym("symbol"),sym("string")),symbol:noskip(str(seq(sym("char"),str(repeat(sym("alpha")))))),"char":alt(range("a","z"),range("A","Z"),"_","$"),alpha:alt(range("a","z"),range("A","Z"),"_","$",range("0","9")),value:simpleAlt(sym("function literal"),sym("expr"),sym("number"),sym("string"),sym("obj"),sym("bool"),sym("array")),expr:str(seq(sym("symbol"),optional(str(alt(seq(".",sym("expr")),seq("(",str(repeat(sym("value"),",")),")")))))),number:noskip(seq(optional("-"),repeat(range("0","9"),null,1),optional(seq(".",repeat(range("0","9")))))),string:noskip(alt(sym("single quoted string"),sym("double quoted string"))),"double quoted string":seq1(1,'"',str(repeat(sym("double quoted char"))),'"'),"double quoted char":alt(sym("escape char"),literal('\\"','"'),notChar('"')),"single quoted string":seq1(1,"'",str(repeat(sym("single quoted char"))),"'"),"single quoted char":alt(sym("escape char"),literal("\\'","'"),notChar("'")),"escape char":alt(literal("\\\\","\\"),literal("\\n","\n")),bool:alt(literal("true",!0),literal("false",!1)),array:seq1(1,"[",repeat(sym("value"),","),"]"),"function literal":seq("function",optional(sym("symbol")),"(",repeat(sym("symbol"),","),")","{",repeat(notChar("}")),"}")}.addActions({obj:function(v){for(var m={},i=0;i<v.length;i++)m[v[i][0]]=v[i][2]
return m}}),repeat0(alt(" ","	","\n","\r")))
MODEL({name:"TemplateParser",extendsModel:"grammar",methods:{START:sym("markup"),markup:repeat0(alt(sym("comment"),sym("foamTag"),sym("create child"),sym("simple value"),sym("live value tag"),sym("raw values tag"),sym("values tag"),sym("code tag"),sym("ignored newline"),sym("newline"),sym("single quote"),sym("text"))),comment:seq1(1,"<!--",repeat0(not("-->",anyChar)),"-->"),foamTag:sym("foamTag_"),foamTag_:function(){},"create child":seq("$$",repeat(notChars(" $\n<{")),optional(JSONParser["export"]("objAsString"))),"simple value":seq("%%",repeat(notChars(' ()-"\n><:;,')),optional("()")),"live value tag":seq("<%#",repeat(not("%>",anyChar)),"%>"),"raw values tag":alt(seq("<%=",repeat(not("%>",anyChar)),"%>"),seq("{{{",repeat(not("}}}",anyChar)),"}}}")),"values tag":seq("{{",repeat(not("}}",anyChar)),"}}"),"code tag":seq("<%",repeat(not("%>",anyChar)),"%>"),"ignored newline":literal("\\\n"),newline:literal("\n"),"single quote":literal("'"),text:anyChar}})
var TemplateOutput={create:function(obj){var buf=[],f=function templateOut(){for(var i=0;i<arguments.length;i++){var o=arguments[i]
"string"==typeof o?buf.push(o):(o&&o.toView_&&(o=o.toView_()),null!==o&&void 0!==o&&(o.appendHTML?o.appendHTML(this):buf.push(o.toHTML?o.toHTML():o),o.initHTML&&obj&&obj.addChild&&obj.addChild(o)))}}
return f.toString=function(){return 0===buf.length?"":(buf.length>1&&(buf=[buf.join("")]),buf[0])},f}},ConstantTemplate=function(str){var TemplateOutputCreate=TemplateOutput.create.bind(TemplateOutput),f=function(opt_out){var out=opt_out?opt_out:TemplateOutputCreate(this)
return out(str),out.toString()}
return f.toString=function(){return'ConstantTemplate("'+str.replace(/\n/g,"\\n").replace(/"/g,'\\"')+'")'},f},TemplateCompiler={__proto__:TemplateParser,out:[],simple:!0,push:function(){this.simple=!1,this.pushSimple.apply(this,arguments)},pushSimple:function(){this.out.push.apply(this.out,arguments)},header:"var self = this, X = this.X, Y = this.Y;var out = opt_out ? opt_out : TOC(this);out('",footer:"');return out.toString();"}.addActions({markup:function(v){var wasSimple=this.simple,ret=wasSimple?null:this.header+this.out.join("")+this.footer
return this.out=[],this.simple=!0,[wasSimple,ret]},"create child":function(v){var name=v[1].join("")
this.push("', self.createTemplateView('",name,"'",v[2]?", "+v[2]:"","),\n'")},foamTag:function(e){var fName=e.getAttribute("f")
fName?(this.push("', self.createTemplateView('",fName,"',{}).fromElement(FOAM("),this.push(JSONUtil.where(NOT_TRANSIENT).stringify(e)),this.push("))")):(this.push("', (function() { var tagView = X.foam.ui.FoamTagView.create({element: FOAM("),this.push(JSONUtil.where(NOT_TRANSIENT).stringify(e)),this.push(")}, Y); self.addDataChild(tagView); return tagView; })() ")),this.push(",\n'")},"simple value":function(v){this.push("',\n self.",v[1].join(""),v[2],",\n'")},"raw values tag":function(v){this.push("',\n",v[1].join(""),",\n'")},"values tag":function(v){this.push("',\nescapeHTML(",v[1].join(""),"),\n'")},"live value tag":function(v){this.push("',\nself.dynamicTag('span', function() { return ",v[1].join(""),"; }.bind(this)),\n'")},"code tag":function(v){this.push("');\n",v[1].join(""),";out('")},"single quote":function(){this.pushSimple("\\'")},newline:function(){this.pushSimple("\\n")},text:function(v){this.pushSimple(v)}})
MODEL({name:"TemplateUtil",methods:{lazyCompile:function(t){var delegate,f=function(){if(!delegate){if(!t.template)throw"Must arequire() template model before use for "+this.name_+"."+t.name
delegate=TemplateUtil.compile(Template.isInstance(t)?t:Template.create(t))}return delegate.apply(this,arguments)}
return f.toString=function(){return delegate?delegate.toString():t.toString()},f},compile_:function(t,code){for(var args=["opt_out"],i=0;i<t.args.length;i++)args.push(t.args[i].name)
return eval("(function() { var escapeHTML = XMLUtil.escape, TOC = TemplateOutput.create.bind(TemplateOutput); return function("+args.join(",")+"){"+code+"};})()")},compile:function(t){var code=TemplateCompiler.parseString(t.template)
if(code[0])return ConstantTemplate(t.template)
try{return this.compile_(t,code[1])}catch(err){return console.log("Template Error: ",err),console.log(code),function(){}}},stringifyTemplate:function(template){return function(){var buf=[]
return this.output(buf.push.bind(buf),obj),buf.join("")}},expandTemplate:function(self,t,opt_X){var X=opt_X||self.X
if("function"==typeof t)t=X.Template.create({name:t.name,args:t.toString().match(/\((.*?)\)/)[1].split(",").slice(1).map(function(a){return X.Arg.create({name:a.trim()})}),template:multiline(t)})
else if("string"==typeof t)t=docTemplate=X.Template.create({name:"body",template:t})
else if(t.template||t.code)"function"==typeof t.template&&(t.template=multiline(t.template))
else{var future=afuture(),path=self.sourcePath
if(t.futureTemplate=future.get,path=path.substring(0,path.lastIndexOf("/")+1),path+=self.name+"_"+t.name+".ft",window.XMLHttpRequest){var xhr=new XMLHttpRequest
xhr.open("GET",path),xhr.asend(function(data){t.template=data,future.set(Template.create(t))})}else{var fs=require("fs")
fs.readFile(path,function(err,data){t.template=data.toString(),future.set(Template.create(t))})}}return t.futureTemplate||(t.futureTemplate=aconstant(t)),t.template$||(t="undefined"!=typeof X.Template?JSONUtil.mapToObj(X,t,X.Template):t),t},expandModelTemplates:function(self){for(var templates=self.templates,i=0;i<templates.length;i++)templates[i]=TemplateUtil.expandTemplate(self,templates[i])}}})
var aeval=function(src){return aconstant(eval("("+src+")"))},aevalTemplate=function(t,model){return aseq(t.futureTemplate,function(ret,t){ret(TemplateUtil.lazyCompile(t))})},escapeHTML=XMLUtil.escape,TOC=TemplateOutput.create.bind(TemplateOutput),$documents=[]
window&&$documents.push(window.document)
var $WID__=0,$=function(id){console.log("Deprecated use of GLOBAL.$.")
for(var i=0;i<$documents.length;i++){if(document.FOAM_OBJECTS&&document.FOAM_OBJECTS[id])return document.FOAM_OBJECTS[id]
var ret=$documents[i].getElementById(id)
if(ret)return ret}return void 0},$$=function(cls){console.log("Deprecated use of GLOBAL.$$.")
for(var i=0;i<$documents.length;i++){var ret=$documents[i].getElementsByClassName(cls)
if(ret.length>0)return ret}return[]},FOAM=function(map,opt_X,seq){var obj=JSONUtil.mapToObj(opt_X||X,map,void 0,seq)
return obj}
FOAM.putFactory=function(ctx,name,factory){ctx.__defineGetter__(name,function(){return console.log("Bouncing Factory: ",name),delete ctx[name],ctx[name]=factory()})}
var USED_MODELS={},UNUSED_MODELS={},NONMODEL_INSTANCES={}
FOAM.browse=function(model,opt_dao,opt_X){var Y=opt_X||X.sub(void 0,"FOAM BROWSER")
"string"==typeof model&&(model=Y[model])
var dao=opt_dao||Y[model.name+"DAO"]||Y[model.plural]
dao||(Y[model.name+"DAO"]=[].dao)
var ctrl=Y.foam.ui.DAOController.create({model:model,dao:dao,useSearchView:!1})
if(Y.stack)Y.stack.pushView(ctrl)
else{var w=opt_X?opt_X.window:window
Y.stack=Y.foam.ui.StackView.create()
var win=Y.foam.ui.layout.Window.create({window:w,data:Y.stack},Y)
document.body.insertAdjacentHTML("beforeend",win.toHTML()),win.initHTML(),Y.stack.setTopView(ctrl)}}
var arequire=function(modelName,opt_X){var X=opt_X||GLOBAL.X,model=X.lookup(modelName)
if(!model){if(!X.ModelDAO)return aconstant()
if(X.arequire$ModelLoadsInProgress){if(X.arequire$ModelLoadsInProgress[modelName])return X.arequire$ModelLoadsInProgress[modelName]}else X.set("arequire$ModelLoadsInProgress",{})
var future=afuture()
return X.arequire$ModelLoadsInProgress[modelName]=future.get,X.ModelDAO.find(modelName,{put:function(m){m.X=X,m.arequire()(function(m){X.arequire$ModelLoadsInProgress[modelName]=!1,X.registerModel(m),future.set(m)})},error:function(){var args=argsToArray(arguments)
console.warn.apply(console,["Could not load model: ",modelName].concat(args)),X.arequire$ModelLoadsInProgress[modelName]=!1,future.set(void 0)}}),future.get}return model.arequire()},FOAM_POWERED='<a style="text-decoration:none;" href="https://github.com/foam-framework/foam/" target="_blank"><font size=+1 face="catull" style="text-shadow:rgba(64,64,64,0.3) 3px 3px 4px;"><font color="#3333FF">F</font><font color="#FF0000">O</font><font color="#FFCC00">A</font><font color="#33CC00">M</font><font color="#555555" > POWERED</font></font></a>',CLASS=function(m){function registerModelLatch(path,m){var id=m["package"]?m["package"]+"."+m.name:m.name
if(EAGER[id]){USED_MODELS[id]=!0
var work=[],model=JSONUtil.mapToObj(X,m,Model,work)
return work.length>0&&(model.extra__=aseq.apply(null,work)),X.registerModel(model,void 0,!0),model}GLOBAL.lookupCache_[id]=void 0,UNUSED_MODELS[id]=!0
var triggered=!1
Object.defineProperty(m["package"]?path:GLOBAL,m.name,{get:function triggerModelLatch(){if(triggered)return null
triggered=!0,USED_MODELS[id]=!0,UNUSED_MODELS[id]=void 0
var work=[],model=JSONUtil.mapToObj(X,m,Model,work)
return work.length>0&&(model.extra__=aseq.apply(null,work)),X.registerModel(model),model},configurable:!0})}var EAGER={Method:!0,BooleanProperty:!0,Action:!0,FunctionProperty:!0,Constant:!0,Message:!0,ArrayProperty:!0,StringArrayProperty:!0,Template:!0,Arg:!0,Relationship:!0,ViewFactoryProperty:!0,FactoryProperty:!0,"foam.ui.Window":!0,StringProperty:!0,"foam.html.Element":!0,Expr:!0,AbstractDAO:!0}
document&&document.currentScript&&(m.sourcePath=document.currentScript.src),registerModelLatch(packagePath(X,m["package"]),m)},MODEL=CLASS,FObject={__proto__:PropertyChangeSupport,name_:"FObject",get Y(){return Object.prototype.hasOwnProperty.call(this,"Y_")?this.Y_:this.Y_=DEBUG?this.X.sub({},(this.X.NAME?this.X.NAME:"")+"Y"):this.X.sub()},replaceModel_:function(model,otherModel,X){for(;otherModel;){var replacementName=(model["package"]?model["package"]+".":"")+(otherModel.name?otherModel.name:otherModel)+model.name,replacementModel=X.lookup(replacementName)
if(replacementModel)return replacementModel
otherModel=X.lookup(otherModel.extendsModel)}return void 0},create_:function(){return Object.create(this)},create:function(args,opt_X){if(args&&args.model&&(opt_X||X).Model.isInstance(args.model)){var ret=this.replaceModel_(this.model_,args.model,opt_X||X)
if(ret)return ret.create(args,opt_X)}var o=this.create_(this)
if(o.instance_={},o.X=opt_X||X,this.model_.instance_.imports_&&this.model_.instance_.imports_.length){Object.prototype.hasOwnProperty.call(this,"imports__")||(this.imports__=this.model_.instance_.imports_.map(function(e){var s=e.split(" as ")
return[s[0],s[1]||s[0]]}))
for(var i=0;i<this.imports__.length;i++){var im=this.imports__[i]
args&&args.hasOwnProperty(im[1])||"undefined"==typeof o.X[im[0]]||(o[im[1]]=o.X[im[0]])}}if(o.model_)for(var agents=this.initAgents(),i=0;i<agents.length;i++)agents[i][1](o,o.X,args)
return o.init(args),o},init:nop,xbind:function(map){var newModel={__proto__:this,create:function(args,X){var createArgs={},key
args=args?args.instance_||args:{}
for(key in args)args.hasOwnProperty(key)&&(createArgs[key]=args[key])
for(key in map)createArgs.hasOwnProperty(key)||(createArgs[key]=map[key])
return this.__proto__.create(createArgs,X)},xbind:function(m2){for(var key in map)m2.hasOwnProperty(key)||(m2[key]=map[key])
return this.__proto__.xbind(m2)}}
return this.required__&&(newModel.required__=aseq(this.required__,aconstant(newModel))),newModel},X:X,addInitAgent:function(priority,desc,agent){agent.toString=function(){return desc},this.initAgents_.push([priority,agent])},initAgents:function(){if(this.model_){if(!Object.hasOwnProperty.call(this,"initAgents_")){var agents=this.initAgents_=[],self=this
Object_forEach(this.model_.instance_.exports_,function(e){var exp=e.split("as ")
if(0!=exp.length){var key=exp[0].trim(),alias=exp[1]||exp[0]
if(key){var asValue="$"!==key&&"$$"!=key&&"$"==key.charAt(key.length-1)
asValue&&(key=key.slice(0,key.length-1))
var prop=self.model_.getProperty(key)
prop?asValue?self.addInitAgent(1,"export property value "+key,function(o,X){o.Y.set(alias,o[prop.name$_])}):self.addInitAgent(1,"export property "+key,function(o,X){o.Y.setValue(alias,o[prop.name$_])}):self.addInitAgent(0,"export other "+key,function(o,X){var out="function"==typeof o[key]?o[key].bind(o):o[key]
o.Y.set(alias,out)})}else self.addInitAgent(0,"export this",function(o,X){o.Y.set(alias,o)})}})
var fastInit={Property:!0,Method:!0}[this.name_]
if(fastInit){for(var keys={},ps=this.model_.getRuntimeProperties(),i=0;i<ps.length;i++){var prop=ps[i]
keys[prop.name]=keys[prop.name$_]=!0}this.addInitAgent(0,"fast copy args",function fastCopyArgs(o,X,m){if(m.instance_){m=m.instance_
for(var key in m)o[key]=m[key]}else for(var key in m)keys[key]&&(o[key]=m[key])})}for(var ps=this.model_.getRuntimeProperties(),i=0;i<ps.length;i++){var prop=ps[i]
prop.initPropertyAgents?prop.initPropertyAgents(self,fastInit):!function(name){self.addInitAgent(0,"set proto-property "+name,function setProtoProperty(o,X,m){m&&m.hasOwnProperty(name)&&(o[name]=m[name])})}(prop.name)}self.addInitAgent(0,"Add create() to Model",function(o,X){Model.isInstance(o)&&"Model"!=o.name&&(o.create=BootstrapModel.create)})
for(var i=0;i<agents.length;i++)agents[i][2]=i
agents.sort(CompoundComparator(function(o1,o2){return o1[0]-o2[0]},function(o1,o2){return o1[2]-o2[2]}))}return this.initAgents_}},fromElement:function(e){var RESERVED_ATTRS={id:!0,model:!0,view:!0,showactions:!0,oninit:!0},elements=this.elementMap_
if(!elements){elements={}
for(var properties=this.model_.getRuntimeProperties(),i=0;i<properties.length;i++){var p=properties[i]
RESERVED_ATTRS[p.name]||(elements[p.name]=p,elements[p.name.toUpperCase()]=p),elements["p:"+p.name]=p,elements["P:"+p.name.toUpperCase()]=p}this.elementMap_=elements}for(var i=0;i<e.attributes.length;i++){var attr=e.attributes[i],p=elements[attr.name],val=attr.value
if(p)if(val.startsWith("#")){val=val.substring(1)
var $val=this.X.$(val)
$val?this[attr.name]=this.X.$(val):p.fromString.call(this,val,p)}else p.fromString.call(this,val,p)
else RESERVED_ATTRS[attr.name]||console.warn('Unknown attribute name: "'+attr.name+'"')}for(var i=0;i<e.children.length;i++){var c=e.children[i],p=elements[c.nodeName]
p?p.fromElement.call(this,c,p):console.warn('Unknown element name: "'+c.nodeName+'"')}return this},createFOAMGetter:function(name,getter){var stack=Events.onGet.stack
return function FOAMGetter(){var value=getter.call(this,name),f=stack[0]
return f&&f(this,name,value),value}},createFOAMSetter:function(name,setter){var stack=Events.onSet.stack
return function FOAMSetter(newValue){var f=stack[0];(!f||f(this,name,newValue))&&setter.call(this,newValue,name)}},toString:function(){return this.model_.name+"Prototype"},hasOwnProperty:function(name){return"undefined"!=typeof this.instance_[name]},writeActions:function(other,out){for(var properties=this.model_.getRuntimeProperties(),i=0,property;property=properties[i];i++)if(property.actionFactory)for(var actions=property.actionFactory(this,property.f(this),property.f(other)),j=0;j<actions.length;j++)out(actions[j])},equals:function(other){return 0==this.compareTo(other)},compareTo:function(other){if(other===this)return 0
if(this.model_!==other.model_)return this.model_.id.compareTo(other.model_&&other.model_.id)||1
for(var ps=this.model_.getRuntimeProperties(),i=0;i<ps.length;i++){var r=ps[i].compare(this,other)
if(r)return r}return 0},diff:function(other){for(var diff={},properties=this.model_.getRuntimeProperties(),i=0,property;property=properties[i];i++)if(Array.isArray(property.f(this))){var subdiff=property.f(this).diff(property.f(other));(0!==subdiff.added.length||0!==subdiff.removed.length)&&(diff[property.name]=subdiff)}else 0!==property.f(this).compareTo(property.f(other))&&(diff[property.name]=property.f(other))
return diff},clearProperty:function(name){delete this.instance_[name]},defineProperty:function(prop){var name=prop.name
prop.name$_=name+"$"
var obj=DEBUG?this:__ROOT__
obj.__lookupGetter__(prop.name$_)||Object.defineProperty(obj,prop.name$_,{get:function getValue(){return this.propertyValue(name)},set:function setValue(value){Events.link(value,this.propertyValue(name))},configurable:!0})
var pgetter,psetter
if(prop.getter)pgetter=this.createFOAMGetter(name,prop.getter)
else{if(prop.lazyFactory||prop.factory){var f=prop.lazyFactory||prop.factory
getter=function factory(){if("undefined"==typeof this.instance_[name]){this.instance_[name]=null
var val=f.call(this,prop)
"undefined"==typeof val&&(val=null),this[name]=val}return this.instance_[name]}}else if(prop.defaultValueFn){var f=prop.defaultValueFn
getter=function defaultValueFn(){return"undefined"!=typeof this.instance_[name]?this.instance_[name]:f.call(this,prop)}}else{var defaultValue=prop.defaultValue
getter=function getInstanceVar(){return"undefined"!=typeof this.instance_[name]?this.instance_[name]:defaultValue}}pgetter=this.createFOAMGetter(name,getter)}if(prop.setter)psetter=this.createFOAMSetter(name,prop.setter)
else{var setter=function setInstanceValue(oldValue,newValue){this.instance_[name]=newValue};("int"===prop.type||"float"===prop.type)&&(setter=function(setter){return function numberSetter(oldValue,newValue){setter.call(this,oldValue,"number"!=typeof newValue?Number(newValue):newValue)}}(setter)),prop.onDAOUpdate&&(setter="string"==typeof prop.onDAOUpdate?function(setter,onDAOUpdate,listenerName){return function onDAOUpdateSetter(oldValue,newValue){setter.call(this,oldValue,newValue)
var listener=this[listenerName]||(this[listenerName]=this[onDAOUpdate].bind(this))
oldValue&&oldValue.unlisten(listener),newValue&&(newValue.listen(listener),listener())}}(setter,prop.onDAOUpdate,prop.name+"_onDAOUpdate"):function(setter,onDAOUpdate,listenerName){return function onDAOUpdateSetter2(oldValue,newValue){setter.call(this,oldValue,newValue)
var listener=this[listenerName]||(this[listenerName]=onDAOUpdate.bind(this))
oldValue&&oldValue.unlisten(listener),newValue&&(newValue.listen(listener),listener())}}(setter,prop.onDAOUpdate,prop.name+"_onDAOUpdate")),prop.postSet&&(setter=function(setter,postSet){return function postSetSetter(oldValue,newValue){setter.call(this,oldValue,newValue),postSet.call(this,oldValue,newValue,prop)}}(setter,prop.postSet))
var propertyTopic=PropertyChangeSupport.propertyTopic(name)
setter=function(setter){return function propertyChangeSetter(oldValue,newValue){setter.call(this,oldValue,newValue),this.propertyChange_(propertyTopic,oldValue,newValue)}}(setter),prop.preSet&&(setter=function(setter,preSet){return function preSetSetter(oldValue,newValue){setter.call(this,oldValue,preSet.call(this,oldValue,newValue,prop))}}(setter,prop.preSet)),prop.adapt&&(setter=function(setter,adapt){return function adaptSetter(oldValue,newValue){setter.call(this,oldValue,adapt.call(this,oldValue,newValue,prop))}}(setter,prop.adapt)),setter=function(setter,defaultValue){return function setInstanceVar(newValue){setter.call(this,"undefined"==typeof this.instance_[name]?defaultValue:this.instance_[name],newValue)}}(setter,prop.defaultValue),psetter=this.createFOAMSetter(name,setter)}Object.defineProperty(this,name,{get:pgetter,set:psetter,configurable:!0}),prop.install&&prop.install.call(this,prop)},addMethod:function(name,method){this.__proto__[name]?override(this,name,method):this[name]=method},hashCode:function(){for(var hash=17,properties=this.model_.getRuntimeProperties(),i=0;i<properties.length;i++){var prop=this[properties[i].name],code=prop?prop.hashCode?prop.hashCode():prop.toString().hashCode():0
hash=(hash<<5)-hash+code,hash&=hash}return hash},toProtobuf:function(){var out=ProtoWriter.create()
return this.outProtobuf(out),out.value},outProtobuf:function(out){for(var proprties=this.model_getRuntimeProperties(),i=0;i<properties.length;i++){var prop=properties[i]
Number.isFinite(prop.prototag)&&prop.outProtobuf(this,out)}},clone:function(){var c=Object.create(this.__proto__)
c.instance_={},c.X=this.X
for(var key in this.instance_){var value=this[key]
if(value){var prop=this.model_.getProperty(key)
prop&&prop.cloneProperty&&(c.instance_[key]=prop.cloneProperty.call(prop,value))}}return c},deepClone:function(){var c=Object.create(this.__proto__)
c.instance_={},c.X=this.X
for(var key in this.instance_){var value=this[key]
if(value){var prop=this.model_.getProperty(key)
prop&&prop.deepCloneProperty&&(c.instance_[key]=prop.deepCloneProperty.call(prop,value))}}return c},copyFrom:function(src){if(src&&this.model_)for(var ps=this.model_.getRuntimeProperties(),i=0;i<ps.length;i++){var prop=ps[i]
src.hasOwnProperty(prop.name)&&(this[prop.name]=src[prop.name]),src.hasOwnProperty(prop.name$_)&&(this[prop.name$_]=src[prop.name$_])}return this},output:function(out){return JSONUtil.output(out,this)},toJSON:function(){return JSONUtil.stringify(this)},toXML:function(){return XMLUtil.stringify(this)},write:function(document,opt_view){var view=(opt_view||X.foam.ui.DetailView).create({model:this.model_,data:this,showActions:!0})
view.write(document)},defaultView:function(opt_view){return(opt_view||X.foam.ui.DetailView).create({model:this.model_,data:this,showActions:!0})},decorate:function(name,func,that){var delegate=this[name]
return this[name]=function(){return func.call(this,that,delegate.bind(this),arguments)},this},addDecorator:function(decorator){decorator.decorateObject&&decorator.decorateObject(this)
for(var i=0;i<decorator.model_.methods.length;i++){var method=decorator.model_.methods[i]
"decorateObject"!==method.name&&this.decorate(method.name,method.code,decorator)}return this}}
this.Constant=null,this.Method=null,this.Action=null,this.Relationship=null
var BootstrapModel={__proto__:PropertyChangeSupport,name_:"BootstrapModel <startup only, error if you see this>",addTraitToModel_:function(traitModel,parentModel){var parentName=parentModel&&parentModel.id?parentModel.id.replace(/\./g,"__"):"",traitName=traitModel.id?traitModel.id.replace(/\./g,"__"):"",name=parentName+"_ExtendedWith_"+traitName
if(!lookup(name)){var model=traitModel.clone()
model["package"]="",model.name=name,model.extendsModel=parentModel&&parentModel.id,model.models=traitModel.models,GLOBAL.X.registerModel(model)}var ret=GLOBAL.X.lookup(name)
return console.assert(ret,"Error adding Trait to Model, unknown name: ",name),ret},buildProtoImports_:function(props){Object_forEach(this.instance_.imports_,function(i){var imp=i.split(" as "),key=imp[0],alias=imp[1]||imp[0]
if(alias.length&&"$"==alias.charAt(alias.length-1)&&(alias=alias.slice(0,alias.length-1)),!this.getProperty(alias)){var prop=Property.create({name:alias,"transient":!0,hidden:!0})
prop.cloneProperty=prop.deepCloneProperty=null,props.push(prop)}}.bind(this))},buildProtoProperties_:function(cls,extendsModel,props){for(var i=0;i<props.length;i++){var p=props[i]
if(extendsModel){var superProp=extendsModel.getProperty(p.name)
if(superProp){var p0=p
p=superProp.clone().copyFrom(p),p0.adapt&&superProp.adapt&&(p.adapt=function(a1,a2){return function(oldValue,newValue,prop){return a2.call(this,oldValue,a1.call(this,oldValue,newValue,prop),prop)}}(p0.adapt,superProp.adapt)),p0.preSet&&superProp.preSet&&(p.preSet=function(a1,a2){return function(oldValue,newValue,prop){return a2.call(this,oldValue,a1.call(this,oldValue,newValue,prop),prop)}}(p0.preSet,superProp.preSet)),p0.postSet&&superProp.postSet&&(p.postSet=function(a1,a2){return function(oldValue,newValue,prop){a2.call(this,oldValue,newValue,prop),a1.call(this,oldValue,newValue,prop)}}(p0.postSet,superProp.postSet)),props[i]=p,this[constantize(p.name)]=p}}cls.defineProperty(p)}this.propertyMap_=null},buildProtoMethods_:function(cls){for(key in this.methods){var m=this.methods[key]
Method&&Method.isInstance(m)?cls.addMethod(m.name,m.generateFunction()):cls.addMethod(key,m)}},buildPrototype:function(){if(DEBUG&&BootstrapModel.saveDefinition(this),this.extendsModel&&!this.X.lookup(this.extendsModel))throw"Unknown Model in extendsModel: "+this.extendsModel
var extendsModel=this.extendsModel&&this.X.lookup(this.extendsModel)
if(this.traits)for(var i=0;i<this.traits.length;i++){var trait=this.traits[i],traitModel=this.X.lookup(trait)
console.assert(traitModel,"Unknown trait: "+trait),traitModel?extendsModel=this.addTraitToModel_(traitModel,extendsModel):console.warn("Missing trait: ",trait,", in Model: ",this.name)}var proto=extendsModel?extendsModel.getPrototype():FObject,cls=Object.create(proto)
cls.model_=this,cls.name_=this.name,this.models&&Object_forEach(this.models,function(m){this[m.name]&&(cls[m.name]=this[m.name])}.bind(this)),Object_forEach(this.requires,function(i){var imp=i.split(" as "),m=imp[0],path=m.split("."),key=imp[1]||path[path.length-1]
defineLocalProperty(cls,key,function(){var Y=this.Y,model=this.X.lookup(m)
return console.assert(model,"Unknown Model: "+m+" in "+this.name_),{__proto__:model,create:function(args,X){return model.create(args,X||Y)}}})})
var props=this.instance_.properties_=this.properties?this.properties.clone():[]
if(this.instance_.imports_=this.imports,extendsModel&&(this.instance_.imports_=this.instance_.imports_.concat(extendsModel.instance_.imports_)),this.buildProtoImports_(props),this.buildProtoProperties_(cls,extendsModel,props),extendsModel){for(var i=0;i<extendsModel.instance_.properties_.length;i++){var p=extendsModel.instance_.properties_[i],name=constantize(p.name)
this[name]||(this[name]=p)}for(i=0;i<extendsModel.relationships.length;i++){var r=extendsModel.relationships[i],name=constantize(r.name)
this[name]||(this[name]=r)}}if(this.instance_.exports_=this.exports?this.exports.clone():[],extendsModel&&(this.instance_.exports_=this.instance_.exports_.concat(extendsModel.instance_.exports_)),this.templates&&Object_forEach(this.templates,function(t){cls.addMethod(t.name,t.code?t.code:TemplateUtil.lazyCompile(t))}),this.instance_.actions_=this.actions?this.actions.clone():[],this.actions)for(var i=0;i<this.actions.length;i++)(function(a){if(extendsModel){var superAction=extendsModel.getAction(a.name)
superAction&&(a=superAction.clone().copyFrom(a))}this.instance_.actions_[i]=a,Object.prototype.hasOwnProperty.call(cls,constantize(a.name))||(cls[constantize(a.name)]=a),this[constantize(a.name)]=a,cls.addMethod(a.name,function(opt_x){a.maybeCall(opt_x||this.X,this)})}).bind(this)(this.actions[i])
var key
if(this.constants)for(var i=0;i<this.constants.length;i++){var c=this.constants[i]
cls[c.name]=this[c.name]=c.value}this.messages&&this.messages.length>0&&Message&&Object_forEach(this.messages,function(m,key){Message.isInstance(m)||(m=this.messages[key]=Message.create(m))
var clsProps={},mdlProps={},constName=constantize(m.name)
clsProps[m.name]={get:function(){return m.value}},clsProps[constName]={value:m},mdlProps[constName]={value:m},Object.defineProperties(cls,clsProps),Object.defineProperties(this,mdlProps)}.bind(this)),this.buildProtoMethods_(cls)
var self=this
this.relationships&&this.relationships.forEach(function(r){var name=constantize(r.name)
self[name]||(self[name]=r),defineLazyProperty(cls,r.name,function(){var m=this.X.lookup(r.relatedModel),lcName=m.name[0].toLowerCase()+m.name.substring(1),dao=this.X[lcName+"DAO"]||this.X[m.name+"DAO"]||this.X[m.plural]
return dao||console.error("Relationship "+r.name+" needs "+(m.name+"DAO")+" or "+m.plural+" in the context, and neither was found."),dao=RelationshipDAO.create({delegate:dao,relatedProperty:m.getProperty(r.relatedProperty),relativeID:this.id}),{get:function(){return dao},configurable:!0}})})
var createListenerTrampoline=function(cls,name,fn,isMerged,isFramed,whenIdle){console.assert(fn,"createListenerTrampoline: fn not defined"),fn.name=name,Object.defineProperty(cls,name,{get:function(){var l=fn.bind(this)
return whenIdle&&(l=Movement.whenIdle(l)),isFramed?l=EventService.framed(l,this.X):isMerged&&(l=EventService.merged(l,isMerged===!0?void 0:isMerged,this.X)),Object.defineProperty(this,name,{configurable:!0,value:l}),l},configurable:!0})}
if(Array.isArray(this.listeners))for(var i=0;i<this.listeners.length;i++){var l=this.listeners[i]
createListenerTrampoline(cls,l.name,l.code,l.isMerged,l.isFramed,l.whenIdle)}else this.listeners&&Object_forEach(this.listeners,function(l,key){createListenerTrampoline(cls,key,l)})
if(this.topics&&Object_forEach(this.topics,function(t){}),extendsModel){this.getProperty("")
for(var ips=[],ps=extendsModel.instance_.properties_,i=0;i<ps.length;i++){var p=ps[i]
this.getProperty(p.name)||(ips.push(p),this.propertyMap_[p.name]=p)}ips.length&&(this.instance_.properties_=ips.concat(this.instance_.properties_))
for(var ias=[],as=extendsModel.instance_.actions_,i=0;i<as.length;i++){var a=as[i]
this.getAction&&this.getAction(a.name)||ias.push(a)}ias.length&&(this.instance_.actions_=ias.concat(this.instance_.actions_))}if(this.instance_.properties_.length>0&&!cls.__lookupGetter__("id")){var primaryKey=this.ids
1==primaryKey.length?(cls.__defineGetter__("id",function(){return this[primaryKey[0]]}),cls.__defineSetter__("id",function(val){this[primaryKey[0]]=val})):primaryKey.length>1&&(cls.__defineGetter__("id",function(){return primaryKey.map(function(key){return this[key]}.bind(this))}),cls.__defineSetter__("id",function(val){primaryKey.map(function(key,i){this[key]=val[i]}.bind(this))}))}return cls},getAllRequires:function(){function setModel(o){o&&o.model_&&(requires[o.model_.id]=!0)}var requires={}
return this.requires.forEach(function(r){requires[r.split(" ")[0]]=!0}),this.traits.forEach(function(t){requires[t]=!0}),this.extendsModel&&(requires[this.extendsModel]=!0),this.properties.forEach(setModel),this.actions.forEach(setModel),this.templates.forEach(setModel),this.listeners.forEach(setModel),Object.keys(requires)},getPrototype:function(){return this.instance_.prototype_?this.instance_.prototype_:this.instance_.prototype_=this.buildPrototype()},saveDefinition:function(self){self.definition_={},Array.isArray(self.methods)&&(self.definition_.methods=[].concat(self.methods)),Array.isArray(self.templates)&&(self.definition_.templates=[].concat(self.templates)),Array.isArray(self.relationships)&&(self.definition_.relationships=[].concat(self.relationships)),Array.isArray(self.properties)&&(self.definition_.properties=[].concat(self.properties)),Array.isArray(self.actions)&&(self.definition_.actions=[].concat(self.actions)),Array.isArray(self.listeners)&&(self.definition_.listeners=[].concat(self.listeners)),Array.isArray(self.models)&&(self.definition_.models=[].concat(self.models)),Array.isArray(self.tests)&&(self.definition_.tests=[].concat(self.tests)),Array.isArray(self.issues)&&(self.definition_.issues=[].concat(self.issues)),self.definition_.__proto__=FObject},create:function(args,opt_X){return this.getPrototype().create(args,opt_X)},isSubModel:function(model){if(!model||!model.getPrototype)return!1
var subModels_=this.subModels_||(this.subModels_={})
return subModels_.hasOwnProperty(model.id)||(subModels_[model.id]=model.getPrototype()===this.getPrototype()||this.isSubModel(model.getPrototype().__proto__.model_)),subModels_[model.id]},getRuntimeProperties:function(){return this.instance_.properties_||this.getPrototype(),this.instance_.properties_},getProperty:function(name){if(!this.propertyMap_){for(var m=this.propertyMap_={},properties=this.getRuntimeProperties(),i=0;i<properties.length;i++){var prop=properties[i]
m[prop.name]=prop}this.propertyMap_=m}return this.propertyMap_[name]},getAction:function(name){for(var i=0;i<this.instance_.actions_.length;i++)if(this.instance_.actions_[i].name===name)return this.instance_.actions_[i]},hashCode:function(){var string="",properties=this.getRuntimeProperties()
for(var key in properties)string+=properties[key].toString()
return string.hashCode()},isInstance:function(obj){return obj&&obj.model_&&this.isSubModel(obj.model_)},toString:function(){return"BootstrapModel("+this.name+")"},arequire:function(){if(this.required__)return this.required__
var future=afuture()
this.required__=future.get
var go=function(){var args=[]
this.extendsModel&&args.push(arequire(this.extendsModel,this.X))
var i
if(this.traits)for(i=0;i<this.traits.length;i++)args.push(arequire(this.traits[i],this.X))
var model=this
if(this.templates)for(i=0;i<this.templates.length;i++){var t=this.templates[i]
args.push(aif(!t.code,aseq(aevalTemplate(this.templates[i],this),function(t){return function(ret,m){t.code=m,ret()}}(t))))}if(args.length&&(args=[aseq.apply(null,args)]),this.requires)for(var i=0;i<this.requires.length;i++){var r=this.requires[i],m=r.split(" as ")
m[0]==this.id?console.warn("Model requires itself: "+this.id):args.push(arequire(m[0],this.X))}args.push(function(ret){this.X.i18nModel?this.X.i18nModel(ret,this,this.X):ret()}.bind(this)),aseq.apply(null,args)(function(){this.finished__=!0,future.set(this)}.bind(this))}.bind(this)
return this.extra__?this.extra__(go):go(),this.required__},getMyFeature:function(featureName){function add(a){if(a)for(var i=0;i<a.length;i++){var f=a[i]
map[f.name.toUpperCase()]=f}}if(!Object.prototype.hasOwnProperty.call(this,"featureMap_")){var map=this.featureMap_={}
add(this.getRuntimeProperties()),add(this.instance_.actions_),add(this.methods),add(this.listeners),add(this.templates),add(this.models),add(this.tests),add(this.relationships),add(this.issues)}return this.featureMap_[featureName.toUpperCase()]},getRawFeature:function(featureName){function add(a){if(a)for(var i=0;i<a.length;i++){var f=a[i]
map[f.name.toUpperCase()]=f}}if(!Object.prototype.hasOwnProperty.call(this,"rawFeatureMap_")){var map=this.featureMap_={}
add(this.properties),add(this.actions),add(this.methods),add(this.listeners),add(this.templates),add(this.models),add(this.tests),add(this.relationships),add(this.issues)}return this.featureMap_[featureName.toUpperCase()]},getAllMyRawFeatures:function(){var featureList=[],arrayOrEmpty=function(arr){return arr&&Array.isArray(arr)?arr:[]}
return[arrayOrEmpty(this.properties),arrayOrEmpty(this.actions),arrayOrEmpty(this.methods),arrayOrEmpty(this.listeners),arrayOrEmpty(this.templates),arrayOrEmpty(this.models),arrayOrEmpty(this.tests),arrayOrEmpty(this.relationships),arrayOrEmpty(this.issues)].map(function(list){featureList=featureList.concat(list)}),featureList},getFeature:function(featureName){var feature=this.getMyFeature(featureName)
if(feature||!this.extendsModel)return feature
var ext=this.X.lookup(this.extendsModel)
return ext?ext.getFeature(featureName):void 0},getAllRawFeatures:function(){var featureList=this.getAllMyRawFeatures()
if(this.extendsModel){var ext=this.X.lookup(this.extendsModel)
ext&&ext.getAllFeatures().map(function(subFeat){var subName=subFeat.name.toUpperCase()
featureList.mapFind(function(myFeat){return myFeat&&myFeat.name&&myFeat.name.toUpperCase()===subName})||featureList.push(subFeat)})}return featureList},atest:function(){for(var seq=[],allPassed=!0,i=0;i<this.tests.length;i++)seq.push(function(test,model){return function(ret){test.atest(model)(function(passed){passed||(allPassed=!1),ret()})}}(this.tests[i],this))
return seq.push(function(ret){ret(allPassed)}),aseq.apply(null,seq)}},BinaryProtoGrammar,DocumentationBootstrap={name:"documentation",type:"Documentation",view:function(){return X.foam.ui.DetailView.create({model:Documentation})},help:"Documentation associated with this entity.",documentation:"The developer documentation for this $$DOC{ref:'.'}. Use a $$DOC{ref:'DocModelView'} to view documentation.",setter:function(nu){DEBUG&&(this.instance_.documentation=nu)},getter:function(){if(!DEBUG)return""
var doc=this.instance_.documentation
return!doc||"undefined"==typeof Documentation||!Documentation||doc.model_&&doc.model_.getPrototype&&Documentation.isInstance(doc)||(this.instance_.documentation=Documentation.create(doc.body?doc:{body:doc})),this.instance_.documentation}},Model={__proto__:BootstrapModel,instance_:{},name:"Model",plural:"Models",help:"Describes the attributes and properties of an entity.",documentation:{body:function(){}},tableProperties:["package","name","label","plural"],properties:[{name:"id",hidden:!0,"transient":!0},{name:"sourcePath",help:"Source location of this Model.",defaultValue:"",mode:"read-only","transient":!0},{name:"abstract",type:"boolean",defaultValue:!1,help:"If the java class is abstract.",documentation:function(){}},{name:"package",help:"Package that this Model belongs to.",defaultValue:"",postSet:function(_,p){return this.id=p?p+"."+this.name:this.name},documentation:function(){}},{name:"name",type:"String",postSet:function(_,n){return this.id=this["package"]?this["package"]+"."+n:n},required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the entity.",documentation:function(){}},{name:"label",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return labelize(this.name)},help:"The display label for the entity.",documentation:function(){}},{name:"javaClassName",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return(this["abstract"]?"Abstract":"")+this.name},help:"The Java classname of this Model.",documentation:function(){}},{name:"extendsModel",label:"Extends",type:"String",displayWidth:70,displayHeight:1,defaultValue:"",help:"The parent model of this model.",documentation:function(){}},{name:"traits",type:"Array[String]",view:"foam.ui.StringArrayView",defaultValueFn:function(){return[]},help:"Traits to mix-into this Model.",documentation:function(){}},{name:"plural",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.name+"s"},help:"The plural form of this model's name.",documentation:function(){}},{name:"version",type:"int",defaultValue:1,help:"Version number of model.",documentation:function(){}},{name:"ids",label:"Key Properties",type:"Array[String]",view:"foam.ui.StringArrayView",defaultValueFn:function(){var id=this.getProperty("id")
return id?["id"]:[this.getRuntimeProperties()[0].name]},help:"Properties which make up unique id.",documentation:function(){}},{name:"requires",type:"Array[String]",view:"foam.ui.StringArrayView",defaultValueFn:function(){return[]},help:"Model imports.",documentation:function(){}},{name:"imports",type:"Array[String]",view:"foam.ui.StringArrayView",defaultValueFn:function(){return[]},help:"Context imports.",documentation:function(){}},{name:"exports",type:"Array[String]",view:"foam.ui.StringArrayView",defaultValueFn:function(){return[]},help:"Context exports.",documentation:function(){}},{name:"implements",type:"Array[String]",view:"foam.ui.StringArrayView",defaultValueFn:function(){return[]},help:"Interfaces implemented by this Model.",documentation:function(){}},{name:"tableProperties",type:"Array[String]",view:"foam.ui.StringArrayView",displayWidth:70,lazyFactory:function(){return(this.properties||this.properties_).filter(function(o){return!o.hidden}).map(function(o){return o.name})},help:"Properties to be displayed in table view. Defaults to all properties.",documentation:function(){}},{name:"searchProperties",type:"Array[String]",view:"foam.ui.StringArrayView",displayWidth:70,defaultValueFn:function(){return this.tableProperties},help:"Properties display in a search view. Defaults to table properties.",documentation:function(){}},{name:"properties",subType:"Property",view:"foam.ui.ArrayView",factory:function(){return[]},defaultValue:[],help:"Properties associated with the entity.",preSet:function(oldValue,newValue){for(var i=0;i<newValue.length;i++){var p=newValue[i]
"string"==typeof p&&(newValue[i]=p={name:p}),DEBUG||!p.debug||p.model_&&"string"!=typeof p.model_?(p.model_?"string"==typeof p.model_&&(p=newValue[i]=JSONUtil.mapToObj(this.X,p)):p=newValue[i]=Property.create(p),this[constantize(p.name)]=newValue[i]):(newValue.splice(i,1),i--)}return this.propertyMap_=null,newValue},documentation:function(){}},{name:"actions",type:"Array[Action]",subType:"Action",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},defaultValue:[],help:"Actions associated with the entity.",preSet:function(_,newValue){if(!Action)return newValue
for(var i=0;i<newValue.length;i++){var p=newValue[i]
p.model_?"string"==typeof p.model_&&(newValue[i]=FOAM(p)):newValue[i]=Action.create(p),p.name&&!this[constantize(p.name)]&&(this[constantize(p.name)]=newValue[i])}return newValue},documentation:function(){}},{name:"constants",type:"Array[Constant]",subType:"Constant",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},defaultValue:[],help:"Constants associated with the entity.",preSet:function(_,newValue){if(!Constant)return newValue
if(Array.isArray(newValue))return JSONUtil.arrayToObjArray(this.X,newValue,Constant)
var constants=[]
for(var key in newValue){var oldValue=newValue[key],constant=Constant.create({name:key,value:oldValue})
constants.push(constant)}return constants}},{name:"messages",type:"Array[Message]",subType:"Constant",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},defaultValue:[],help:"Messages associated with the entity.",preSet:function(_,newValue){if(!GLOBAL.Message)return newValue
if(Array.isArray(newValue))return JSONUtil.arrayToObjArray(this.X,newValue,Message)
var messages=[]
for(var key in newValue){var oldValue=newValue[key],message=Message.create({name:key,value:oldValue})
messages.push(message)}return messages}},{model_:"ArrayProperty",name:"methods",subType:"Method",help:"Methods associated with the entity.",adapt:function(_,a){function createMethod(X,name,fn){var method=Method.create({name:name,code:fn})
if(DEBUG&&Arg){var str=fn.toString()
method.args=str.match(/^function[ _$\w]*\(([ ,\w]*)/)[1].split(",").filter(function(name){return name}).map(function(name){return Arg.create({name:name.trim()})})}return method}if(!Method)return a
if(Array.isArray(a)){for(var i=0;i<a.length;i++)a[i]="function"==typeof a[i]?createMethod(this.X,a[i].name,a[i]):JSONUtil.mapToObj(this.X,a[i],Method,seq)
return a}var methods=[]
for(var key in a)methods.push(createMethod(this.X,key,a[key]))
return methods},documentation:function(){}},{name:"listeners",type:"Array[Method]",subType:"Method",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},preSet:function(_,newValue){return Array.isArray(newValue)?JSONUtil.arrayToObjArray(this.X,newValue,Method):newValue},defaultValue:[],help:"Event listeners associated with the entity.",documentation:function(){}},{name:"templates",type:"Array[Template]",subType:"Template",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},defaultValue:[],postSet:function(_,templates){TemplateUtil.expandModelTemplates(this)},help:"Templates associated with this entity.",documentation:function(){}},{name:"models",type:"Array[Model]",subType:"Model",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},adapt:function(_,newValue){return Model&&Array.isArray(newValue)?JSONUtil.arrayToObjArray(this.X,newValue,Model):newValue},postSet:function(_,models){for(var i=0;i<models.length;i++)this[models[i].name]=models[i]},defaultValue:[],help:"Sub-models embedded within this model.",documentation:function(){}},{name:"tests",label:"Unit Tests",type:"Array[Unit Test]",subType:"UnitTest",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},adapt:function(_,a){if(!a)return a
for(var i=0;i<a.length;i++)"function"==typeof a[i]&&(a[i]=UnitTest.create({name:a[i].name,code:a[i]}))
return a},defaultValue:[],help:"Unit tests associated with this model.",documentation:function(){}},{name:"relationships",subType:"Relationship",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},defaultValue:[],help:"Relationships of this model to other models.",preSet:function(_,newValue){if(!Relationship)return newValue
for(var i=0;i<newValue.length;i++){var p=newValue[i]
p.model_?"string"==typeof p.model_&&(p=newValue[i]=FOAM(p)):p=newValue[i]=Relationship.create(p),this[constantize(p.name)]=newValue[i]}return newValue},documentation:function(){}},{name:"issues",type:"Array[Issue]",subType:"Issue",debug:!0,view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},defaultValue:[],help:"Issues associated with this model.",documentation:function(){}},{name:"help",label:"Help Text",type:"String",displayWidth:70,displayHeight:6,view:"foam.ui.TextAreaView",defaultValue:"",help:"Help text associated with the entity.",documentation:function(){}},{name:"i18nComplete_",defaultValue:!1,hidden:!0,"transient":!0},{name:"translationHint",label:"Description for Translation",type:"String",defaultValueFn:function(){return this.name}},DocumentationBootstrap,{name:"notes",type:"String",displayWidth:70,displayHeight:6,view:"foam.ui.TextAreaView",defaultValue:"",help:"Internal documentation associated with this entity.",documentation:function(){}},{name:"createActionFactory",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",help:"Factory to create the action object for creating this object",documentation:function(){}},{name:"deleteActionFactory",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",help:"Factory to create the action object for deleting this object",documentation:function(){}}],toString:function(){return"Model"}},Property={__proto__:BootstrapModel,instance_:{},name:"Property",plural:"Properties",help:"Describes a properties of a modelled entity.",ids:["name"],tableProperties:["name","label","type","required","defaultValue"],documentation:function(){},properties:[{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the property.",documentation:function(){}},{name:"label",type:"String",required:!1,displayWidth:70,displayHeight:1,defaultValueFn:function(){return labelize(this.name)},help:"The display label for the property.",documentation:function(){}},{name:"speechLabel",type:"String",required:!1,displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.label},help:"The speech label for the property.",documentation:function(){}},{name:"tableLabel",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.label},help:"The table display label for the entity.",documentation:function(){}},{name:"type",type:"String",required:!0,view:{factory_:"foam.ui.ChoiceView",choices:["Array","Boolean","Color","Date","DateTime","Email","Enum","Float","Function","Image","Int","Object","Password","String","String[]","URL"]},defaultValue:"String",help:"The type of the property.",documentation:function(){}},{name:"protobufType",type:"String",required:!1,help:"The protobuf type that represents the type of this property.",defaultValueFn:function(){return this.type.toLowerCase()},documentation:function(){}},{name:"javaType",type:"String",required:!1,defaultValueFn:function(){return this.type},help:"The java type that represents the type of this property.",documentation:function(){}},{name:"javascriptType",type:"String",required:!1,defaultValueFn:function(){return this.type},help:"The javascript type that represents the type of this property.",documentation:function(){}},{name:"shortName",type:"String",required:!0,displayWidth:10,displayHeight:1,defaultValue:"",help:"A short alternate name to be used for compact encoding.",documentation:"A short alternate $$DOC{ref:'.name'} to be used for compact encoding."},{name:"singular",type:"String",required:!1,displayWidth:70},{name:"aliases",type:"Array[String]",view:"foam.ui.StringArrayView",defaultValue:[],help:"Alternate names for this property.",documentation:function(){}},{name:"mode",type:"String",defaultValue:"read-write",view:{factory_:"foam.ui.ChoiceView",choices:["read-only","read-write","final"]},documentation:function(){}},{name:"subType",label:"Sub-Type",type:"String",displayWidth:30,help:"The type of the property.",documentation:function(){}},{name:"units",type:"String",required:!0,displayWidth:70,displayHeight:1,defaultValue:"",help:"The units of the property.",documentation:function(){}},{name:"required",type:"Boolean",view:"foam.ui.BooleanView",defaultValue:!0,help:"Indicates if the property is a required field.",documentation:function(){}},{name:"hidden",type:"Boolean",view:"foam.ui.BooleanView",defaultValue:!1,help:"Indicates if the property is hidden.",documentation:function(){}},{name:"transient",type:"Boolean",view:"foam.ui.BooleanView",defaultValue:!1,help:"Indicates if the property is transient.",documentation:function(){}},{name:"displayWidth",type:"int",displayWidth:8,displayHeight:1,defaultValue:"30",help:"The display width of the property.",documentation:function(){}},{name:"displayHeight",type:"int",displayWidth:8,displayHeight:1,defaultValue:1,help:"The display height of the property.",documentation:function(){}},{model_:"ViewFactoryProperty",name:"view",type:"view",defaultValue:"foam.ui.TextFieldView",help:"View component for the property.",documentation:function(){}},{model_:"ViewFactoryProperty",name:"detailView",type:"view",defaultValueFn:function(){return this.view},help:"View component for the property when rendering within a DetailView.",documentation:function(){}},{model_:"ViewFactoryProperty",name:"citationView",type:"view",defaultValueFn:function(){return this.view},help:"View component for the property when rendering within a CitationView.",documentation:function(){}},{name:"detailViewPreRow",defaultValue:function(){return""},help:"Inject HTML before row in DetailView.",documentation:function(){}},{name:"detailViewPostRow",defaultValue:function(){return""},help:"Inject HTML before row in DetailView.",documentation:function(){}},{name:"defaultValue",type:"String",required:!1,displayWidth:70,displayHeight:1,defaultValue:"",postSet:function(old,nu){nu&&this.defaultValueFn&&(this.defaultValueFn=void 0)},help:"The property's default value.",documentation:function(){}},{name:"defaultValueFn",label:"Default Value Function",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",postSet:function(old,nu){nu&&this.defaultValue&&(this.defaultValue=void 0)},help:"The property's default value function.",documentation:function(){}},{name:"dynamicValue",label:"Value's Dynamic Function",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",help:"A dynamic function which computes the property's value.",documentation:function(){}},{name:"factory",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",help:"Factory for creating initial value when new object instantiated.",documentation:function(){}},{name:"lazyFactory",type:"Function",required:!1,view:"foam.ui.FunctionView",help:"Factory for creating the initial value. Only called when the property is accessed for the first time.",documentation:function(){}},{name:"getter",type:"Function",required:!1,displayWidth:70,displayHeight:3,view:"foam.ui.FunctionView",defaultValue:"",help:"The property's default value function.",documentation:function(){}},{name:"adapt",type:"Function",required:!1,displayWidth:70,displayHeight:3,view:"foam.ui.FunctionView",defaultValue:"",help:"An adapter function called before preSet.",documentation:function(){}},{name:"preSet",type:"Function",required:!1,displayWidth:70,displayHeight:3,view:"foam.ui.FunctionView",defaultValue:"",help:"An adapter function called before normal setter logic.",documentation:function(){}},{name:"postSet",type:"Function",required:!1,displayWidth:70,displayHeight:3,view:"foam.ui.FunctionView",defaultValue:"",help:"A function called after normal setter logic, but before property change event fired.",documentation:function(){}},{name:"setter",type:"Function",required:!1,displayWidth:70,displayHeight:3,view:"foam.ui.FunctionView",defaultValue:"",help:"The property's default value function.",documentation:function(){}},{name:"tableFormatter",label:"Table Cell Formatter",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",help:"Function to format value for display in TableView.",documentation:"A function to format the value for display in a $$DOC{ref:'foam.ui.TableView'}."},{name:"summaryFormatter",label:"Summary Formatter",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",help:"Function to format value for display in SummaryView.",documentation:"A function to format the value for display in a $$DOC{ref:'SummaryView'}."},{name:"tableWidth",type:"String",required:!1,defaultValue:"",help:"Table View Column Width.",documentation:"A Suggestion for $$DOC{ref:'foam.ui.TableView'} column width."},{name:"help",label:"Help Text",type:"String",required:!1,displayWidth:70,displayHeight:6,view:"foam.ui.TextAreaView",defaultValue:"",help:"Help text associated with the property.",documentation:function(){}},DocumentationBootstrap,{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field.",documentation:"The protobuf tag number for this field."},{name:"actionFactory",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",help:"Factory to create the action objects for taking this property from value A to value B",documentation:"Factory to create the $$DOC{ref:'Action'} objects for taking this $$DOC{ref:'Property'} from value A to value B"},{name:"compareProperty",type:"Function",view:"foam.ui.FunctionView",displayWidth:70,displayHeight:5,defaultValue:function(o1,o2){return o1===o2?0:o1||o2?o1?o2?o1.localeCompare?o1.localeCompare(o2):o1.compareTo?o1.compareTo(o2):o1.$UID.compareTo(o2.$UID):1:-1:0},help:"Comparator function.",documentation:"A comparator function two compare two instances of this $$DOC{ref:'Property'}."},{name:"fromString",defaultValue:function(s,p){this[p.name]=s},help:"Function to extract value from a String."},{name:"fromElement",defaultValue:function propertyFromElement(e,p){if(!p.type||!this.X.lookup||"String"===p.type)return void p.fromString.call(this,e.innerHTML,p)
var model=this.X.lookup(p.type)
if(!model)return void p.fromString.call(this,e.innerHTML,p)
var o=model.create()
return o.fromElement?void(this[p.name]=o.fromElement(e)):void p.fromString.call(this,e.innerHTML,p)},help:"Function to extract from a DOM Element.",documentation:"Function to extract a value from a DOM Element."},{name:"propertyToJSON",defaultValue:function(visitor,output,o){this["transient"]||(output[this.name]=visitor.visit(o[this.name]))},help:"Function to extract from a DOM Element.",documentation:"Function to extract a value from a DOM Element."},{name:"autocompleter",subType:"Autocompleter",help:"Name or model for the autocompleter for this property.",documentation:function(){}},{name:"install",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",help:"A function which installs additional features into the Model's prototype.",documentation:function(){}},{name:"exclusive",type:"Boolean",view:"foam.ui.BooleanView",defaultValue:!0,help:"Indicates if the property can only have a single value.",documentation:function(){}},{name:"memorable",type:"Boolean",help:"True if this value should be included in a memento for this object.",defaultValue:!1}],methods:{partialEval:function(){return this},f:function(obj){return obj[this.name]},compare:function(o1,o2){return this.compareProperty(this.f(o1),this.f(o2))},toSQL:function(){return this.name},toMQL:function(){return this.name},toBQL:function(){return this.name},cloneProperty:function(value){return value&&value.clone?value.clone():value},deepCloneProperty:function(value){return value&&value.deepClone?value.deepClone():value},initPropertyAgents:function(proto,fastInit){var prop=this,name=prop.name,name$_=prop.name$_
if(fastInit||proto.addInitAgent(this.postSet||this.setter?9:0,name+": "+(this.postSet||this.setter?"copy arg (postSet)":"copy arg"),function(o,X,m){m&&(m.hasOwnProperty(name)&&(o[name]=m[name]),m.hasOwnProperty(name$_)&&(o[name$_]=m[name$_]))}),this.dynamicValue){var dynamicValue=prop.dynamicValue
Array.isArray(dynamicValue)?proto.addInitAgent(10,name+": dynamicValue",function(o,X){Events.dynamic(dynamicValue[0].bind(o),function(){o[name]=dynamicValue[1].call(o)})}):proto.addInitAgent(10,name+": dynamicValue",function(o,X){Events.dynamic(dynamicValue.bind(o),function(value){o[name]=value})})}this.factory&&proto.addInitAgent(11,name+": factory",function(o,X){o.hasOwnProperty(name)||o[name]})}},toString:function(){return"Property"}}
Model.methods={getProperty:BootstrapModel.getProperty,getAction:BootstrapModel.getAction,hashCode:BootstrapModel.hashCode,buildPrototype:BootstrapModel.buildPrototype,addTraitToModel_:BootstrapModel.addTraitToModel_,buildProtoImports_:BootstrapModel.buildProtoImports_,buildProtoProperties_:BootstrapModel.buildProtoProperties_,buildProtoMethods_:BootstrapModel.buildProtoMethods_,getPrototype:BootstrapModel.getPrototype,isSubModel:BootstrapModel.isSubModel,isInstance:BootstrapModel.isInstance,getAllRequires:BootstrapModel.getAllRequires,arequire:BootstrapModel.arequire,getMyFeature:BootstrapModel.getMyFeature,getRawFeature:BootstrapModel.getRawFeature,getAllMyRawFeatures:BootstrapModel.getAllMyRawFeatures,getFeature:BootstrapModel.getFeature,getAllRawFeatures:BootstrapModel.getAllRawFeatures,atest:BootstrapModel.atest,getRuntimeProperties:BootstrapModel.getRuntimeProperties},Model=Model.create(Model),Model.model_=Model,Model.create=BootstrapModel.create,Property=Model.create(Property)
for(var ps=Property.getRuntimeProperties(),i=0;i<ps.length;i++)Property[constantize(ps[i].name)]=ps[i]=Property.create(ps[i])
if(USED_MODELS.Property=!0,USED_MODELS.Model=!0,CLASS({name:"StringProperty",extendsModel:"Property",help:"Describes a properties of type String.",properties:[{name:"displayHeight",type:"int",displayWidth:8,defaultValue:1,help:"The display height of the property."},{name:"type",type:"String",displayWidth:20,defaultValue:"String",help:"The FOAM type of this property."},{name:"adapt",defaultValue:function(_,v){return void 0===v||null===v?"":"function"==typeof v?multiline(v):v.toString()}},{name:"javaType",type:"String",displayWidth:70,defaultValue:"String",help:"The Java type of this property."},{name:"view",defaultValue:"foam.ui.TextFieldView"},{name:"pattern",help:"Regex pattern for property."},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."}]}),CLASS({name:"BooleanProperty",extendsModel:"Property",help:"Describes a properties of type Boolean.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Boolean",help:"The FOAM type of this property."},{name:"javaType",type:"String",displayWidth:70,defaultValue:"bool",help:"The Java type of this property."},{name:"view",defaultValue:"foam.ui.BooleanView"},{name:"defaultValue",defaultValue:!1},{name:"adapt",defaultValue:function(_,v){return!!v}},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."},{name:"fromString",defaultValue:function(s,p){var txt=s.trim()
this[p.name]=txt.equalsIC("y")||txt.equalsIC("yes")||txt.equalsIC("true")||txt.equalsIC("t")},help:"Function to extract value from a String."}]}),CLASS({name:"DateProperty",extendsModel:"Property",help:"Describes a properties of type Date.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Date",help:"The FOAM type of this property."},{name:"displayWidth",defaultValue:50},{name:"javaType",type:"String",defaultValue:"Date",help:"The Java type of this property."},{name:"view",defaultValue:"foam.ui.DateFieldView"},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."},{name:"adapt",defaultValue:function(_,d){return"string"==typeof d?new Date(d):d}},{name:"tableFormatter",defaultValue:function(d){return d?d.toRelativeDateString():""}},{name:"compareProperty",defaultValue:function(o1,o2){return o1?o2?o1.compareTo(o2):1:o2?-1:0}}]}),CLASS({name:"DateTimeProperty",extendsModel:"DateProperty",help:"Describes a properties of type DateTime.",properties:[{name:"type",type:"String",displayWidth:25,defaultValue:"datetime",help:"The FOAM type of this property."},{name:"adapt",defaultValue:function(_,d){return"number"==typeof d?new Date(d):"string"==typeof d?new Date(d):d}},{name:"view",defaultValue:"foam.ui.DateTimeFieldView"}]}),CLASS({name:"IntProperty",extendsModel:"Property",help:"Describes a properties of type Int.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Int",help:"The FOAM type of this property."},{name:"displayWidth",defaultValue:10},{name:"javaType",type:"String",displayWidth:10,defaultValue:"int",help:"The Java type of this property."},{name:"view",defaultValue:"foam.ui.IntFieldView"},{name:"adapt",defaultValue:function(_,v){return"number"==typeof v?Math.round(v):v?parseInt(v):0}},{name:"defaultValue",defaultValue:0},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."},{name:"compareProperty",defaultValue:function(o1,o2){return o1===o2?0:o1>o2?1:-1}}]}),CLASS({name:"FloatProperty",extendsModel:"Property",help:"Describes a properties of type Float.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Float",help:"The FOAM type of this property."},{name:"defaultValue",defaultValue:0},{name:"javaType",type:"String",displayWidth:10,defaultValue:"double",help:"The Java type of this property."},{name:"displayWidth",defaultValue:15},{name:"view",defaultValue:"foam.ui.FloatFieldView"},{name:"adapt",defaultValue:function(_,v){return"number"==typeof v?v:v?parseFloat(v):0}},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."}]}),CLASS({name:"FunctionProperty",extendsModel:"Property",help:"Describes a properties of type Function.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Function",help:"The FOAM type of this property."},{name:"javaType",type:"String",displayWidth:10,defaultValue:"Function",help:"The Java type of this property."},{name:"displayWidth",defaultValue:15},{name:"view",defaultValue:"foam.ui.FunctionView"},{name:"defaultValue",defaultValue:function(){}},{name:"fromElement",defaultValue:function(e,p){var txt=e.innerHTML.trim()
this[p.name]=txt.startsWith("function")?eval("("+txt+")"):new Function(txt)}},{name:"adapt",defaultValue:function(_,value){return"string"==typeof value?value.startsWith("function")?eval("("+value+")"):new Function(value):value}}]}),CLASS({name:"ArrayProperty",extendsModel:"Property",help:"Describes a properties of type Array.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Array",help:"The FOAM type of this property."},{name:"singular",type:"String",displayWidth:70,defaultValueFn:function(){return this.name.replace(/s$/,"")},help:"The plural form of this model's name.",documentation:function(){}},{name:"subType",type:"String",displayWidth:20,defaultValue:"",help:"The FOAM sub-type of this property."},{name:"protobufType",defaultValueFn:function(){return this.subType}},{name:"adapt",defaultValue:function(_,a,prop){var m=prop.subType_||(prop.subType_=this.X.lookup(prop.subType)||GLOBAL.lookup(prop.subType))
if(m)for(var i=0;i<a.length;i++)m.isInstance(a[i])||(a[i]=a[i].model_?FOAM(a[i]):m.create(a[i]))
return a}},{name:"postSet",defaultValue:function(oldA,a,prop){var name=prop.nameArrayRelay_||(prop.nameArrayRelay_=prop.name+"ArrayRelay_"),l=this[name]||(this[name]=function(){this.propertyChange(prop.name,null,this[prop.name])}.bind(this))
oldA&&oldA.unlisten&&oldA.unlisten(l),a&&a.listen&&a.listen(l)}},{name:"javaType",type:"String",displayWidth:10,defaultValueFn:function(p){return p.subType+"[]"},help:"The Java type of this property."},{name:"view",defaultValue:"foam.ui.ArrayView"},{name:"factory",defaultValue:function(){return[]}},{name:"propertyToJSON",defaultValue:function(visitor,output,o){!this["transient"]&&o[this.name].length&&(output[this.name]=visitor.visitArray(o[this.name]))}},{name:"install",defaultValue:function(prop){defineLazyProperty(this,prop.name+"$Proxy",function(){var proxy=this.X.lookup("foam.dao.ProxyDAO").create({delegate:this[prop.name].dao})
return this.addPropertyListener(prop.name,function(_,_,_,a){proxy.delegate=a.dao}),{get:function(){return proxy},configurable:!0}}),this.addMethod("get"+capitalize(prop.singular),function(id){for(var i=0;i<this[prop.name].length;i++)if(this[prop.name][i].id===id)return this[prop.name][i]})}},{name:"fromElement",defaultValue:function(e,p){for(var model=this.X.lookup(e.getAttribute("model")||p.subType),children=e.children,a=[],i=0;i<children.length;i++){var o=model.create(null,this.Y)
o.fromElement(children[i],p),a.push(o)}this[p.name]=a}},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."}]}),CLASS({name:"ReferenceProperty",extendsModel:"Property",help:"A foreign key reference to another Entity.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Reference",help:"The FOAM type of this property."},{name:"subType",type:"String",displayWidth:20,defaultValue:"",help:"The FOAM sub-type of this property."},{name:"subKey",type:"EXPR",displayWidth:20,defaultValue:"ID",help:"The foreign key that this property references."},{name:"javaType",type:"String",displayWidth:10,defaultValueFn:function(p){return"Object"},help:"The Java type of this property."},{name:"view",defaultValue:"foam.ui.TextFieldView"},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."}]}),CLASS({name:"StringArrayProperty",extendsModel:"Property",help:"An array of String values.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Array[]",help:"The FOAM type of this property."},{name:"singular",type:"String",displayWidth:70,defaultValueFn:function(){return this.name.replace(/s$/,"")},help:"The plural form of this model's name.",documentation:function(){}},{name:"subType",type:"String",displayWidth:20,defaultValue:"String",help:"The FOAM sub-type of this property."},{name:"displayWidth",defaultValue:50},{name:"adapt",defaultValue:function(_,v){return Array.isArray(v)?v:[v]}},{name:"factory",defaultValue:function(){return[]}},{name:"javaType",type:"String",displayWidth:10,defaultValue:"String[]",help:"The Java type of this property."},{name:"view",defaultValue:"foam.ui.StringArrayView"},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."},{name:"exclusive",defaultValue:!1},{name:"fromString",defaultValue:function(s,p){this[p.name]=s.split(",")}},{name:"fromElement",defaultValue:function(e,p){for(var val=[],name=p.singular||"item",i=0;i<e.children.length;i++)e.children[i].nodeName===name&&val.push(e.children[i].innerHTML)
this[p.name]=val}}]}),CLASS({name:"ModelProperty",extendsModel:"Property",help:"Describes a Model property.",properties:[{name:"type",defaultValue:"Model"},{name:"getter",defaultValue:function(name){var value=this.instance_[name]
if("undefined"==typeof value){var prop=this.model_.getProperty(name)
value=prop&&prop.defaultValueFn?prop.defaultValueFn.call(this,prop):prop.defaultValue}return this.X.lookup(value)}},{name:"propertyToJSON",defaultValue:function(visitor,output,o){this["transient"]||(output[this.name]=o[this.name].id)}}]}),CLASS({name:"ViewProperty",extendsModel:"Property",help:"Describes a View-Factory property.",properties:[{name:"adapt",doc:"Can be specified as either a function, a Model, a Model path, or a JSON object.",defaultValue:function(_,f){return"function"==typeof f?f:"string"==typeof f?function(d,opt_X){return(opt_X||this.X).lookup(f).create(d,opt_X||this.Y)}.bind(this):"function"==typeof f.create?f.create.bind(f):"string"==typeof f.model_?function(d,opt_X){return FOAM(f,opt_X||this.Y).copyFrom(d)}:(console.error("******* Unknown view factory: ",f),f)}},{name:"defaultValue",adapt:function(_,f){return ViewProperty.ADAPT.defaultValue.call(this,null,f)}}]}),CLASS({name:"FactoryProperty",extendsModel:"Property",help:"Describes a Factory property.",properties:[{name:"preSet",doc:"Can be specified as either a function, a Model, a Model path, or a JSON object.",defaultValue:function(_,f){return"function"==typeof f?f:"string"==typeof f?function(map,opt_X){return(opt_X||this.X).lookup(f).create(map,opt_X||this.Y)}.bind(this):Model.isInstance(f)?f.create.bind(f):f.factory_?function(map,opt_X){var X=opt_X||this.X,m=X.lookup(f.factory_)
return console.assert(m,"Unknown Factory Model: "+f.factory_),m.create(f,opt_X||this.Y)}.bind(this):(console.error("******* Invalid Factory: ",f),f)}}]}),CLASS({name:"ViewFactoryProperty",extendsModel:"FactoryProperty",help:"Describes a View Factory property.",properties:[{name:"defaultValue",preSet:function(_,f){return ViewFactoryProperty.ADAPT.defaultValue.call(this,null,f)}},{name:"defaultValueFn",preSet:function(_,f){return function(prop){return ViewFactoryProperty.ADAPT.defaultValue.call(this,null,f.call(this,prop))}}},{name:"fromElement",defaultValue:function(e,p){this[p.name]=e.innerHTML_||(e.innerHTML_=e.innerHTML)}},{name:"adapt",doc:"Can be specified as either a function, String markup, a Model, a Model path, or a JSON object.",defaultValue:function(_,f){if(!f)return f
if("function"==typeof f)return f
var ret
if("string"==typeof f){if(/[^0-9a-zA-Z$_.]/.exec(f)){var VIEW_CACHE=ViewFactoryProperty.VIEW_CACHE||(ViewFactoryProperty.VIEW_CACHE={}),viewModel=VIEW_CACHE[f]
viewModel||(viewModel=VIEW_CACHE[f]=Model.create({name:"InnerDetailView"+this.$UID,extendsModel:"foam.ui.DetailView",templates:[{name:"toHTML",template:f}]}),viewModel.arequire()),ret=function(args,X){return viewModel.create(args,X||this.Y)}}else ret=function(map,opt_X){var model=(opt_X||this.X).lookup(f)
return console.assert(!!model,"Unknown model: "+f+" in "+this.name+" property"),model.create(map,opt_X||this.Y)}.bind(this)
return ret.toString=function(){return'"'+f+'"'},ret}return Model.isInstance(f)?function(args,opt_X){return f.create(args,opt_X||this.Y)}.bind(this):f.factory_?(ret=function(map,opt_X){var m=(opt_X||this.X).lookup(f.factory_)
return console.assert(m,"Unknown ViewFactory Model: "+f.factory_),m.create(f,opt_X||this.Y).copyFrom(map)}.bind(this),ret.toString=function(){return JSON.stringify(f)},ret):this.X.lookup("foam.ui.BaseView").isInstance(f)?constantFn(f):(console.error("******* Invalid Factory: ",f),f)}}]}),CLASS({name:"ReferenceArrayProperty",extendsModel:"ReferenceProperty",properties:[{name:"type",defaultValue:"Array",displayWidth:20,help:"The FOAM type of this property."},{name:"factory",defaultValue:function(){return[]}},{name:"view",defaultValue:"foam.ui.StringArrayView"}]}),CLASS({name:"EMailProperty",extendsModel:"StringProperty"}),CLASS({name:"ImageProperty",extendsModel:"StringProperty"}),CLASS({name:"URLProperty",extendsModel:"StringProperty"}),CLASS({name:"ColorProperty",extendsModel:"StringProperty"}),CLASS({name:"PasswordProperty",extendsModel:"StringProperty"}),DEBUG&&CLASS({name:"DocumentationProperty",extendsModel:"Property",help:"Describes the documentation properties found on Models, Properties, Actions, Methods, etc.",documentation:"The developer documentation for this $$DOC{ref:'.'}. Use a $$DOC{ref:'DocModelView'} to view documentation.",properties:[{name:"type",type:"String",defaultvalue:"Documentation"},{name:"getter",type:"Function",debug:!0,defaultValue:function(name){var doc=this.instance_[name]
return!doc||"undefined"==typeof Documentation||!Documentation||doc.model_&&doc.model_.getPrototype&&Documentation.isInstance(doc)||(this.instance_[name]=Documentation.create(doc.body?doc:{body:doc})),this.instance_[name]}},{name:"view",defaultValue:"foam.ui.DetailView",debug:!0},{name:"help",defaultValue:"Documentation for this entity.",debug:!0},{name:"documentation",factory:function(){return"The developer documentation for this $$DOC{ref:'.'}. Use a $$DOC{ref:'DocModelView'} to view documentation."},debug:!0}]}),CLASS({name:"Action",plural:"Actions",tableProperties:["name","label"],documentation:function(){},properties:[{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the action.",documentation:function(){}},{name:"label",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return labelize(this.name)},help:"The display label for the action.",documentation:function(){}},{name:"speechLabel",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.label},help:"The speech label for the action.",documentation:"A speakable label for the $$DOC{ref:'.'}. Used for accessibility."},{name:"help",label:"Help Text",type:"String",displayWidth:70,displayHeight:6,defaultValue:"",help:"Help text associated with the action.",documentation:function(){}},{model_:"DocumentationProperty",name:"documentation",documentation:"The developer documentation.",debug:!0},{name:"default",type:"Boolean",view:"foam.ui.BooleanView",defaultValue:!1,help:"Indicates if this is the default action.",documentation:function(){}},{model_:"FunctionProperty",name:"isAvailable",label:"Available",displayWidth:70,displayHeight:3,defaultValue:function(){return!0},help:"Function to determine if action is available.",documentation:function(){}},{model_:"FunctionProperty",name:"isEnabled",label:"Enabled",displayWidth:70,displayHeight:3,defaultValue:function(){return!0},help:"Function to determine if action is enabled.",documentation:function(){}},{model_:"FunctionProperty",name:"labelFn",label:"Label Function",defaultValue:function(action){return action.label},help:"Function to determine label. Defaults to 'this.label'.",documentation:function(){}},{name:"iconUrl",type:"String",defaultValue:void 0,help:"Provides a url for an icon to render for this action",documentation:function(){}},{name:"showLabel",type:"String",defaultValue:!0,help:"Property indicating whether the label should be rendered alongside the icon",documentation:function(){}},{name:"children",type:"Array",factory:function(){return[]},subType:"Action",view:"foam.ui.ArrayView",help:"Child actions of this action.",persistent:!1,documentation:function(){}},{name:"parent",type:"String",help:"The parent action of this action",documentation:function(){}},{model_:"FunctionProperty",name:"action",displayWidth:80,displayHeight:20,defaultValue:"",help:"Function to implement action.",documentation:function(){}},{model_:"StringArrayProperty",name:"keyboardShortcuts",documentation:function(){}},{name:"translationHint",label:"Description for Translation",type:"String",defaultValue:""}],methods:{maybeCall:function(X,that){this.isAvailable.call(that,this)&&this.isEnabled.call(that,this)&&(this.action.call(that,X,this),that.publish(["action",this.name],this))}}}),CLASS({name:"Arg",tableProperties:["type","name","description"],documentation:function(){},properties:[{name:"type",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"Object",debug:!0,help:"The type of this argument.",documentation:function(){}},{name:"javaType",type:"String",required:!1,defaultValueFn:function(){return this.type},help:"The java type that represents the type of this property.",debug:!0,documentation:function(){}},{name:"javascriptType",type:"String",required:!1,defaultValueFn:function(){return this.type},help:"The javascript type that represents the type of this property.",debug:!0,documentation:function(){}},{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the entity.",documentation:function(){}},{model_:"BooleanProperty",name:"required",defaultValue:!0,debug:!0,documentation:function(){}},{name:"defaultValue",help:"Default Value if not required and not provided.",debug:!0,documentation:function(){}},{name:"description",type:"String",displayWidth:70,displayHeight:1,defaultValue:"",help:"A brief description of this argument.",debug:!0,documentation:function(){}},{name:"help",label:"Help Text",type:"String",displayWidth:70,displayHeight:6,defaultValue:"",help:"Help text associated with the entity.",debug:!0,documentation:function(){}},{model_:"DocumentationProperty",name:"documentation",documentation:"The developer documentation.",debug:!0}],methods:{decorateFunction:function(f,i){if("Object"===this.type)return f
var type=this.type
return this.required?function(){return console.assert(void 0!==arguments[i],"Missing required argument# "+i),console.assert(typeof arguments[i]===type,"argument# "+i+" type expected to be "+type+", but was "+typeof arguments[i]+": "+arguments[i]),f.apply(this,arguments)}:function(){return console.assert(void 0===arguments[i]||typeof arguments[i]===type,"argument# "+i+" type expected to be "+type+", but was "+typeof arguments[i]+": "+arguments[i]),f.apply(this,arguments)}}},templates:[{model_:"Template",name:"javaSource",description:"Java Source",template:"<%= this.type %> <%= this.name %>",debug:!0},{model_:"Template",name:"closureSource",description:"Closure JavaScript Source",template:"@param {<%= this.javascriptType %>} <%= this.name %> .",debug:!0},{model_:"Template",name:"webIdl",description:"Web IDL Source",template:"<%= this.type %> <%= this.name %>",debug:!0}]}),CLASS({name:"Constant",plural:"constants",tableProperties:["name","value","description"],documentation:function(){},properties:[{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the entity.",documentation:function(){}},{name:"description",type:"String",displayWidth:70,displayHeight:1,defaultValue:"",help:"A brief description of this method.",documentation:function(){}},{model_:"DocumentationProperty",name:"documentation",documentation:"The developer documentation.",debug:!0},{name:"value",help:"The value of the constant.."},{name:"type",defaultValue:"",help:"Type of the constant."},{name:"translationHint",label:"Description for Translation",type:"String",defaultValue:""}]}),CLASS({name:"Message",plural:"messages",tableProperties:["name","value","translationHint"],documentation:function(){},properties:[{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the message.",documentation:function(){}},{name:"value",type:"String",help:"The message itself."},{name:"meaning",type:"String",help:"Linguistic clarification to resolve ambiguity.",documentation:function(){}},{model_:"ArrayProperty",name:"placeholders",help:"Placeholders to inject into the message.",documentation:function(){}},{model_:"FunctionProperty",name:"replaceValues",documentation:function(){},defaultValue:function(){return this.value}},{name:"translationHint",type:"String",displayWidth:70,displayHeight:1,defaultValue:"",help:"A brief description of this message and the context in which it used.",documentation:function(){}}]}),CLASS({name:"Method",plural:"Methods",tableProperties:["name","description"],documentation:function(){},properties:[{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the entity.",documentation:function(){}},{name:"description",type:"String",displayWidth:70,displayHeight:1,defaultValue:"",help:"A brief description of this method.",documentation:function(){}},{name:"help",label:"Help Text",type:"String",displayWidth:70,displayHeight:6,defaultValue:"",debug:!0,help:"Help text associated with the entity.",documentation:function(){}},{model_:"DocumentationProperty",name:"documentation",documentation:"The developer documentation.",debug:!0},{name:"code",type:"Function",displayWidth:80,displayHeight:30,view:"foam.ui.FunctionView",help:"Javascript code to implement this method.",postSet:function(){if(DEBUG){var multilineComment=/^\s*function\s*\([\$\s\w\,]*?\)\s*{\s*\/\*([\s\S]*?)\*\/[\s\S]*$|^\s*\/\*([\s\S]*?)\*\/([\s\S]*)/.exec(this.code.toString())
if(multilineComment){var bodyFn=multilineComment[1]
this.documentation=this.Y.Documentation.create({name:this.name,body:bodyFn})}}},documentation:function(){}},{name:"returnType",defaultValue:"",help:"Return type.",documentation:function(){},debug:!0},{model_:"BooleanProperty",name:"returnTypeRequired",defaultValue:!0,documentation:function(){},debug:!0},{model_:"ArrayProperty",name:"args",type:"Array[Arg]",subType:"Arg",view:"foam.ui.ArrayView",factory:function(){return[]},defaultValue:[],help:"Method arguments.",documentation:function(){},debug:!0},{name:"whenIdle",help:"Should this listener be deferred until the system is idle (ie. not running any animations).",documentation:function(){}},{name:"isMerged",help:"As a listener, should this be merged?",documentation:function(){}},{model_:"BooleanProperty",name:"isFramed",help:"As a listener, should this be animated?",defaultValue:!1,documentation:function(){}}],templates:[{model_:"Template",name:"javaSource",description:"Java Source",template:'<%= this.returnType || "void" %> <%= this.name %>(<% for ( var i = 0 ; i < this.args.length ; i++ ) { var arg = this.args[i]; %><%= arg.javaSource() %><% if ( i < this.args.length-1 ) out(", ");%><% } %>)'},{model_:"Template",name:"closureSource",description:"Closure JavaScript Source",template:"/**\n<% for ( var i = 0; i < this.args.length ; i++ ) { var arg = this.args[i]; %> * <%= arg.closureSource() %>\n<% } %><% if (this.returnType) { %> * @return {<%= this.returnType %>} .\n<% } %> */\n<%= arguments[1] %>.prototype.<%= this.name %> = goog.abstractMethod;"},{model_:"Template",name:"webIdl",description:"Web IDL Source",template:"<%= this.returnType || 'void' %> <%= this.name %>(<% for ( var i = 0 ; i < this.args.length ; i++ ) { var arg = this.args[i]; %><%= arg.webIdl() %><% if ( i < this.args.length-1 ) out(\", \"); %><% } %>)"}]}),Method.getPrototype().decorateFunction=function(f){for(var i=0;i<this.args.length;i++){var arg=this.args[i]
f=arg.decorateFunction(f,i)}var returnType=this.returnType
return returnType?function(){var ret=f.apply(this,arguments)
return console.assert(typeof ret===returnType,"return type expected to be "+returnType+", but was "+typeof ret+": "+ret),ret}:f},Method.getPrototype().generateFunction=function(){var f=this.code
return DEBUG?this.decorateFunction(f):f},Method.methods={decorateFunction:Method.getPrototype().decorateFunction,generateFunction:Method.getPrototype().generateFunction},CLASS({name:"Template",tableProperties:["name","description"],documentation:function(){},properties:[{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The template's unique name.",documentation:function(){}},{name:"description",type:"String",required:!0,displayWidth:70,displayHeight:1,defaultValue:"",help:"The template's description.",documentation:"A human readable description of the $$DOC{ref:'.'}."},{model_:"ArrayProperty",name:"args",type:"Array[Arg]",subType:"Arg",view:"foam.ui.ArrayView",factory:function(){return[]},defaultValue:[],help:"Method arguments.",documentation:function(){}},{name:"template",type:"String",displayWidth:180,displayHeight:30,rows:30,cols:80,defaultValue:"",view:"foam.ui.TextAreaView",help:"Template text. <%= expr %> or <% out(...); %>",documentation:"The string content of the uncompiled $$DOC{ref:'Template'} body."},{name:"futureTemplate","transient":!0},{name:"code","transient":!0},{model_:"DocumentationProperty",name:"documentation",debug:!0}]}),CLASS({name:"Documentation",tableProperties:["name"],documentation:function(){},properties:[{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"documentation",help:"The Document's unique name.",documentation:"An optional name for the document. Documentation is normally referenced by the name of the containing Model."},{name:"label",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The Document's title or descriptive label.",documentation:"A human readable title to display. Used for books of documentation and chapters."},{name:"body",type:"Template",defaultValue:"",help:"The main content of the document.",documentation:"The main body text of the document. Any valid template can be used, including the $$DOC{ref:'foam.documentation.DocView'} specific $$DOC{ref:'foam.documentation.DocView',text:'$$DOC{\"ref\"}'} tag.",preSet:function(_,template){return TemplateUtil.expandTemplate(this,template)}},{model_:"ArrayProperty",name:"chapters",type:"Array[Document]",subtype:"Documentation",view:"foam.ui.ArrayView",factory:function(){return[]},defaultValue:[],help:"Sub-documents comprising the full body of this document.",documentation:"Optional sub-documents to be included in this document. A viewer may choose to provide an index or a table of contents.",debug:!0,preSet:function(old,nu){if(!DEBUG)return[]
var self=this,foamalized=[]
return nu.forEach(function(chapter){foamalized.push(!chapter||"undefined"==typeof self.Y.Documentation||!self.Y.Documentation||chapter.model_&&chapter.model_.getPrototype&&self.Y.Documentation.isInstance(chapter)?chapter:chapter.body?self.Y.Documentation.create(chapter):self.Y.Documentation.create({body:chapter}))}),foamalized}}]}),TemplateUtil.expandModelTemplates(Property),TemplateUtil.expandModelTemplates(Method),TemplateUtil.expandModelTemplates(Model),TemplateUtil.expandModelTemplates(Arg),CLASS({name:"Relationship",tableProperties:["name","label","relatedModel","relatedProperty"],documentation:function(){},properties:[{name:"name",type:"String",displayWidth:30,displayHeight:1,defaultValueFn:function(){return GLOBAL[this.relatedModel]?GLOBAL[this.relatedModel].plural:""},documentation:function(){},help:"The coding identifier for the relationship."},{name:"label",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.name.labelize()},documentation:function(){},help:"The display label for the relationship."},{name:"help",label:"Help Text",type:"String",displayWidth:70,displayHeight:6,defaultValue:"",documentation:function(){},help:"Help text associated with the relationship."},{model_:"DocumentationProperty",name:"documentation",documentation:function(){}},{name:"relatedModel",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",documentation:function(){},help:"The name of the related Model."},{name:"relatedProperty",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",documentation:function(){},help:"The join property of the related Model."}]}),function(){for(var i=0;i<Model.templates.length;i++)Model.templates[i]=JSONUtil.mapToObj(X,Model.templates[i])
Model.properties=Model.properties,delete Model.instance_.prototype_,Model=Model.create(Model)}(),recopyModelFeatures(Property),recopyModelFeatures(Model),recopyModelFeatures(Method),recopyModelFeatures(Action),recopyModelFeatures(Template),DEBUG)for(var id in UNUSED_MODELS)USED_MODELS[id]&&recopyModelFeatures(GLOBAL.lookup(id))
USED_MODELS.Model=!0,CLASS({"package":"foam.ui",name:"Window",exports:["$$","$","addStyle","animate","cancelAnimationFrame","clearInterval","clearTimeout","console","document","dynamic","error","info","installedModels","log","requestAnimationFrame","setInterval","setTimeout","warn","window","as FOAMWindow"],properties:[{name:"registeredModels",factory:function(){return{}}},{model_:"StringProperty",name:"name",defaultValue:"window"},{name:"window",postSet:function(_,w){this.X.subDocument&&this.X.subDocument(w.document),w.X=this.Y,this.document=w.document}},{name:"document"},{name:"installedModels",documentation:"Each new Window context introduces a new document and resets installedModels so models will install again in the new document.",factory:function(){return{}}},{model_:"BooleanProperty",name:"isBackground",defaultValue:!1},{name:"console",lazyFactory:function(){return this.window.console}}],methods:{addStyle:function(css){if(this.document&&this.document.createElement){var s=this.document.createElement("style")
s.innerHTML=css,this.document.head.insertBefore(s,this.document.head.firstElementChild)}},log:function(){this.console.log.apply(this.console,arguments)},warn:function(){this.console.warn.apply(this.console,arguments)},info:function(){this.console.info.apply(this.console,arguments)},error:function(){this.console.error.apply(this.console,arguments)},$:function(id){return this.document.FOAM_OBJECTS&&this.document.FOAM_OBJECTS[id]?this.document.FOAM_OBJECTS[id]:this.document.getElementById(id)},$$:function(cls){return this.document.getElementsByClassName(cls)},dynamic:function(fn,opt_fn){return Events.dynamic(fn,opt_fn,this.Y)},animate:function(duration,fn,opt_interp,opt_onEnd){return Movement.animate(duration,fn,opt_interp,opt_onEnd,this.Y)},setTimeout:function(f,t){return this.window.setTimeout.apply(this.window,arguments)},clearTimeout:function(id){this.window.clearTimeout(id)},setInterval:function(f,t){return this.window.setInterval.apply(this.window,arguments)},clearInterval:function(id){this.window.clearInterval(id)},requestAnimationFrame:function(f){return this.isBackground?this.setTimeout(f,16):(console.assert(this.window.requestAnimationFrame,"requestAnimationFrame not defined"),this.window.requestAnimationFrame(f))},cancelAnimationFrame:function(id){return this.isBackground?void this.clearTimeout(id):void(this.window.cancelAnimationFrame&&this.window.cancelAnimationFrame(id))}}}),function(){var w=foam.ui.Window.create({window:window,name:"DEFAULT WINDOW",isBackground:"object"==typeof process},X)
FObject.X=X=w.Y}(),CLASS({name:"SimpleValue",properties:[{name:"value"}],methods:{init:function(value){this.value=value||""},get:function(){return this.value},set:function(val){this.value=val},toString:function(){return"SimpleValue("+this.value+")"}}}),CLASS({name:"SimpleReadOnlyValue",extendsModel:"SimpleValue",documentation:"A simple value that can only be set during initialization.",properties:[{name:"value",preSet:function(old,nu){return"undefined"==typeof this.instance_.value?nu:old}}],methods:{set:function(val){"undefined"==typeof this.instance_.value&&this.SUPER(val)},toString:function(){return"SimpleReadOnlyValue("+this.value+")"}}})
var DOM={init:function(X){X.document.FOAM_OBJECTS||(X.document.FOAM_OBJECTS={})
for(var fs=X.document.querySelectorAll("foam"),models=[],i=0;i<fs.length;i++){var e=fs[i]
X.lookup(e.getAttribute("view")),X.lookup(e.getAttribute("model")),e.getAttribute("view")&&models.push(arequire(e.getAttribute("view"))),e.getAttribute("model")&&models.push(arequire(e.getAttribute("model")))}for(var key in USED_MODELS)models.push(arequire(key))
atime("DOMInit",aseq(apar.apply(null,models),function(ret){for(var i=0;i<fs.length;i++){for(var e=fs[i],node=e,body=X.document.body;node&&node!==body;)node=node.parentNode
node&&(this.initElement(e,X,X.document),e.innerHTML=""),ret()}}.bind(this)))()},initElementChildren:function(e,X){for(var a=[],i=0;i<e.children.length;i++){var c=e.children[i]
"FOAM"===c.tagName&&a.push(DOM.initElement(c,X))}return a},initElement:function(e,X,opt_document){arequire("foam.ui.FoamTagView")(function(t){foam.ui.FoamTagView.create({element:e},X)})},setClass:function(e,className,opt_enabled){var oldClassName=e.className||"",enabled=void 0===opt_enabled?!0:opt_enabled
e.className=oldClassName.replace(" "+className,"").replace(className,""),enabled&&(e.className=e.className+" "+className)}}
window&&window.addEventListener&&window.addEventListener("load",function(){DOM.init(X)},!1)
var DomValue={DEFAULT_EVENT:"change",DEFAULT_PROPERTY:"value",create:function(element,opt_event,opt_property){if(!element)throw"Missing Element in DomValue"
return{__proto__:this,element:element,event:opt_event||this.DEFAULT_EVENT,property:opt_property||this.DEFAULT_PROPERTY}},setElement:function(element){this.element=element},get:function(){return this.element[this.property]},set:function(value){this.element[this.property]!==value&&(this.element[this.property]=value)},addListener:function(listener){if(this.event)try{this.element.addEventListener(this.event,listener,!1)}catch(x){}},removeListener:function(listener){if(this.event)try{this.element.removeEventListener(this.event,listener,!1)}catch(x){}},toString:function(){return"DomValue("+this.event+", "+this.property+")"}}
CLASS({name:"DOMValue",properties:[{name:"element",required:!0},{name:"property",defaultValue:"value"},{name:"event",defaultValue:"change"},{name:"value",postSet:function(_,value){this.element[this.property]=value}},{name:"firstListener_",defaultValue:!0}],methods:{init:function(){this.SUPER(),this.value=this.element[this.property]},get:function(){return this.value},set:function(value){this.value=value},addListener:function(listener){this.firstListener_&&(this.event&&this.element.addEventListener(this.event,function(){},!1),this.firstListener_=!1),this.value$.addListener(listener)},removeListener:function(listener){this.value$.removeListener(listener)},toString:function(){return"DOMValue("+this.event+", "+this.property+")"}}}),CLASS({"package":"foam.ui",name:"FoamTagView",extendsModel:"foam.ui.View",requires:["foam.html.Element","foam.ui.View","foam.ui.DetailView"],imports:["document"],properties:[{name:"element"},{name:"className",defaultValue:"foam-tag"}],methods:{init:function(){this.SUPER(),this.Element.isInstance(this.element)||this.install()},install:function(){var e=this.element,models=[],style=e.getAttribute("style"),modelName=e.getAttribute("model"),viewName=e.getAttribute("view"),onInit=e.getAttribute("oninit")
modelName&&models.push(arequire(modelName,this.X)),viewName&&models.push(arequire(viewName,this.X)),aseq(apar.apply(null,models),function(ret){if(this.holder()){var model=this.X.lookup(modelName)
if(!model)return void this.error("Unknown Model: ",modelName)
model.getPrototype()
var obj=model.create(null,this.X)
obj.fromElement(e),obj.model_.DATA&&this.hasOwnProperty("data")&&(obj.data=this.data)
var view
if(viewName){var viewModel=this.X.lookup(viewName)
view=viewModel.create({model:model,data:obj},this.X)}else if(this.X.lookup("foam.ui.BaseView").isInstance(obj))view=obj
else if(obj.toView_)view=obj.toView_()
else{var a=this.element.getAttribute("showActions"),showActions=!a||a.equalsIC("y")||a.equalsIC("yes")||a.equalsIC("true")||a.equalsIC("t")
view=this.X.lookup("foam.ui.DetailView").create({model:model,data:obj,showActions:showActions},obj.Y)}e.id&&(this.document.FOAM_OBJECTS[e.id]=obj),obj.view_=view,this.holder().outerHTML=view.toHTML(),style&&view.$.setAttribute("style",style),view.initHTML(),onInit&&aeval("function() { "+onInit+" }")(function(f){f.call(obj)})}}.bind(this))()},holder:function(){return this.Element.isInstance(this.element)?this.$:this.element},error:function(msg){console.error(msg),this.holder.innerHTML=msg},initHTML:function(){this.install()}}}),CLASS({"package":"foam.html",name:"Element",constants:{OPTIONAL_CLOSE_TAGS:{HTML:!0,HEAD:!0,BODY:!0,P:!0,DT:!0,DD:!0,LI:!0,OPTION:!0,THEAD:!0,TH:!0,TBODY:!0,TR:!0,TD:!0,TFOOT:!0,COLGROUP:!0},ILLEGAL_CLOSE_TAGS:{IMG:!0,INPUT:!0,BR:!0,HR:!0,FRAME:!0,AREA:!0,BASE:!0,BASEFONT:!0,COL:!0,ISINDEX:!0,LINK:!0,META:!0,PARAM:!0}},properties:[{name:"id"},{name:"nodeName"},{name:"attributeMap_","transient":!0,factory:function(){return{}}},{name:"attributes",factory:function(){return[]},postSet:function(_,attrs){for(var i=0;i<attrs.length;i++)this.attributeMap_[attrs[i].name]=attrs[i]}},{name:"childNodes",factory:function(){return[]}},{name:"children","transient":!0,getter:function(){return this.childNodes.filter(function(c){return"string"!=typeof c})}},{name:"outerHTML","transient":!0,getter:function(){var out="<"+this.nodeName
this.id&&(out+=' id="'+this.id+'"')
for(key in this.attributeMap_){var value=this.attributeMap_[key].value
out+=void 0==value?" "+key:" "+key+'="'+this.attributeMap_[key].value+'"'}return this.ILLEGAL_CLOSE_TAGS[this.nodeName]||this.OPTIONAL_CLOSE_TAGS[this.nodeName]&&!this.childNodes.length||(out+=">",out+=this.innerHTML,out+="</"+this.nodeName),out+=">"}},{name:"innerHTML","transient":!0,getter:function(){for(var out="",i=0;i<this.childNodes.length;i++)out+=this.childNodes[i].toString()
return out}}],methods:{setAttribute:function(name,value){var attr=this.getAttributeNode(name)
attr?attr.value=value:(attr={name:name,value:value},this.attributes.push(attr),this.attributeMap_[name]=attr)},getAttributeNode:function(name){return this.attributeMap_[name]},getAttribute:function(name){var attr=this.getAttributeNode(name)
return attr&&attr.value},appendChild:function(c){this.childNodes.push(c)},removeChild:function(c){for(var i=0;i<this.childNodes.length;++i)if(this.childNodes[i]===c){this.childNodes.splice(i,1)
break}},toString:function(){return this.outerHTML}}})
var HTMLParser={__proto__:grammar,create:function(){return{__proto__:this,stack:[X.foam.html.Element.create({nodeName:"html"})]}},peek:function(){return this.stack[this.stack.length-1]},START:sym("html"),html:repeat0(sym("htmlPart")),htmlPart:simpleAlt(sym("cdata"),sym("comment"),sym("text"),sym("endTag"),sym("startTag")),tag:seq(sym("startTag"),repeat(seq1(1,sym("matchingHTML"),sym("htmlPart")))),matchingHTML:function(ps){return this.stack.length>1?ps:null},startTag:seq("<",sym("tagName"),sym("whitespace"),sym("attributes"),sym("whitespace"),optional("/"),">"),endTag:function(){var endTag_=sym("endTag_")
return function(ps){return this.stack.length>1?this.parse(endTag_,ps):void 0}}(),endTag_:seq1(1,"</",sym("tagName"),">"),cdata:seq1(1,"<![CDATA[",str(repeat(not("]]>",anyChar))),"]]>"),comment:seq("<!--",repeat0(not("-->",anyChar)),"-->"),attributes:repeat(sym("attribute"),sym("whitespace")),label:str(plus(notChars(" =/	\r\n<>'\""))),tagName:sym("label"),text:str(plus(alt("<%",notChar("<")))),attribute:seq(sym("label"),optional(seq1(1,"=",sym("value")))),value:str(alt(plus(alt(range("a","z"),range("A","Z"),range("0","9"))),seq1(1,'"',repeat(notChar('"')),'"'))),whitespace:repeat0(alt(" ","	","\r","\n"))}.addActions({START:function(xs){var ret=this.stack[0]
return this.stack=[X.foam.html.Element.create({nodeName:"html"})],ret},tag:function(xs){var ret=this.stack[0]
return this.stack=[X.foam.html.Element.create({nodeName:"html"})],ret.childNodes[0]},attribute:function(xs){return{name:xs[0],value:xs[1]}},cdata:function(xs){this.peek()&&this.peek().appendChild(xs)},text:function(xs){this.peek()&&this.peek().appendChild(xs)},startTag:function(xs){var tag=xs[1],obj=X.foam.html.Element.create({nodeName:tag,attributes:xs[3]})
return this.peek()&&this.peek().appendChild(obj),"/"!=xs[5]&&this.stack.push(obj),obj},endTag:function(tag){for(var stack=this.stack;stack.length>1;){if(this.peek().nodeName===tag)return void stack.pop()
var top=stack.pop()
this.peek().childNodes=this.peek().childNodes.concat(top.childNodes),top.childNodes=[]}}})
!function(){var registry={}
X.registerElement=function(name,model){registry[name]=model,TemplateParser.foamTag_=function(){var start=seq("<",simpleAlt.apply(null,Object.keys(registry).sort(function(o1,o2){return o2.compareTo(o1)}).map(function(k){return literal_ic(k)})),alt("/"," ",">")),html=HTMLParser.create()["export"]("tag")
return function(ps){var res=this.parse(start,ps)&&this.parse(html,ps)
if(!res)return null
var elem=res.value,model=registry[elem.nodeName]
return model&&elem.setAttribute("model",model),res.setValue(elem)}}(),invalidateParsers()},X.elementModel=function(name){return registry[name]}}(),X.registerElement("foam",null),CLASS({name:"Expr",documentation:"Parent model for all mLang expressions. Contains default implementations for many methods.",methods:[function toMQL(){return this.label_},function toSQL(){return this.label_},function toBQL(){return this.label_},function toString(){return this.toMQL()},function collectInputs(terms){terms.push(this)},function partialEval(){return this},function minterm(index,term){return!!(term>>>index[0]--&1)},function normalize(){return this
var inputs,minterms,i,terms,subterms,j,ret},function pipe(sink){var expr=this
return{__proto__:sink,put:function(obj){expr.f(obj)&&sink.put(obj)},remove:function(obj){expr.f(obj)&&sink.remove(obj)}}}]})
var TRUE=FOAM({model_:"Model",name:"TrueExpr",extendsModel:"Expr",documentation:"Model for the primitive true value.",methods:{clone:function(){return this},deepClone:function(){return this},toString:function(){return"<true>"},toSQL:function(){return"( 1 = 1 )"},toMQL:function(){return""},toBQL:function(){return""},f:function(){return!0}}}).create(),FALSE=FOAM({model_:"Model",name:"FalseExpr",extendsModel:"Expr",documentation:"Model for the primitive false value.",methods:{clone:function(){return this},deepClone:function(){return this},toSQL:function(out){return"( 1 <> 1 )"},toMQL:function(out){return"<false>"},toBQL:function(out){return"<false>"},f:function(){return!1}}}).create(),IDENTITY=FOAM({model_:"Model",name:"IdentityExpr",extendsModel:"Expr",documentation:"The identity expression, which passes through its input unchanged.",methods:{clone:function(){return this},deepClone:function(){return this},f:function(obj){return obj},toString:function(){return"IDENTITY"}}}).create()
CLASS({name:"NARY",extendsModel:"Expr","abstract":!0,documentation:"Parent model for expressions which take an arbitrary number of arguments.",properties:[{name:"args",label:"Arguments",type:"Expr[]",help:"Sub-expressions",documentation:"An array of subexpressions which are the arguments to this n-ary expression.",factory:function(){return[]}}],methods:{toString:function(){for(var s=this.name_+"(",i=0;i<this.args.length;i++){var a=this.args[i]
s+=a.toString(),i<this.args.length-1&&(s+=", ")}return s+")"},toSQL:function(){var s
s=this.model_.label,s+="("
for(var i=0;i<this.args.length;i++){var a=this.args[i]
s+=a.toSQL(),i<this.args.length-1&&out.push(",")}return s+=")"},toMQL:function(){var s
s=this.model_.label,s+="("
for(var i=0;i<this.args.length;i++){var a=this.args[i]
s+=a.toMQL(),i<this.args.length-1&&out.push(",")}return s+=")",str},toBQL:function(){var s
s=this.model_.label,s+="("
for(var i=0;i<this.args.length;i++){var a=this.args[i]
s+=a.toBQL(),i<this.args.length-1&&out.push(",")}return s+=")",str}}})
var TrueExpr={finished__:!0,arequire:function(ret){return afuture().set(this).get},create:function(){return TRUE}},FalseExpr={finished__:!0,arequire:function(ret){return afuture().set(this).get},create:function(){return FALSE}},IdentityExpr={finished__:!0,arequire:function(ret){return afuture().set(this).get},create:function(){return IDENTITY}}
CLASS({name:"UNARY",extendsModel:"Expr","abstract":!0,documentation:"Parent model for one-argument expressions.",properties:[{name:"arg1",label:"Argument",type:"Expr",help:"Sub-expression",documentation:"The first argument to the expression.",defaultValue:TRUE}],methods:{toSQL:function(){return this.label_+"("+this.arg1.toSQL()+")"},toMQL:function(){return this.label_+"("+this.arg1.toMQL()+")"},toBQL:function(){return this.label_+"("+this.arg1.toBQL()+")"}}}),CLASS({name:"BINARY",extendsModel:"UNARY","abstract":!0,documentation:'Parent model for two-argument expressions. Extends $$DOC{ref: "UNARY"} to include $$DOC{ref: ".arg2"}.',properties:[{name:"arg2",label:"Argument",type:"Expr",help:"Sub-expression",documentation:"Second argument to the expression.",defaultValue:TRUE}],methods:{toSQL:function(){return this.arg1.toSQL()+" "+this.label_+" "+this.arg2.toSQL()},toMQL:function(){return this.arg1.toMQL()+" "+this.label_+" "+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+" "+this.label_+" "+this.arg2.toBQL()}}}),CLASS({name:"CountExpr",extendsModel:"Expr",properties:[{name:"count",type:"int",defaultValue:0}],methods:{reduce:function(other){return CountExpr.create({count:this.count+other.count})},reduceI:function(other){this.count=this.count+other.count},pipe:function(sink){sink.put(this)},put:function(obj){this.count++},remove:function(obj){this.count--},toString:function(){return this.count}}}),CLASS({name:"EqExpr",extendsModel:"BINARY","abstract":!0,documentation:function(){},methods:{toSQL:function(){return this.arg1.toSQL()+"="+this.arg2.toSQL()},toMQL:function(){return this.arg1.toMQL&&this.arg2.toMQL?this.arg2===TRUE?"is:"+this.arg1.toMQL():""==this.arg2.f()?"-has:"+this.arg1.toMQL():this.arg1.toMQL()+"="+this.arg2.toMQL():""},toBQL:function(){return this.arg1.toBQL&&this.arg2.toBQL?this.arg2===TRUE?this.arg1.toBQL()+":true":this.arg1.toBQL()+":"+this.arg2.toBQL():""},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval()
return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(newArg1.f()==newArg2.f()):this.arg1!==newArg1||this.arg2!==newArg2?EqExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){var arg1=this.arg1.f(obj),arg2=this.arg2.f(obj)
return Array.isArray(arg1)?arg1.some(function(arg){return arg==arg2}):arg2===TRUE?!!arg1:arg2===FALSE?!arg1:arg1==arg2}}}),CLASS({name:"ConstantExpr",extendsModel:"UNARY",methods:{escapeSQLString:function(str){return"'"+str.replace(/\\/g,"\\\\").replace(/'/g,"\\'")+"'"},escapeMQLString:function(str){return str.length>0&&-1==str.indexOf(" ")&&-1==str.indexOf('"')&&-1==str.indexOf(",")?str:'"'+str.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'},toSQL:function(){return"string"==typeof this.arg1?this.escapeSQLString(this.arg1):this.arg1.toString()},toMQL:function(){return"string"==typeof this.arg1?this.escapeMQLString(this.arg1):this.arg1.toMQL?this.arg1.toMQL():this.arg1.toString()},toBQL:function(){return"string"==typeof this.arg1?this.escapeMQLString(this.arg1):this.arg1.toBQL?this.arg1.toBQL():this.arg1.toString()},f:function(obj){return this.arg1}}}),CLASS({name:"AndExpr",extendsModel:"NARY","abstract":!0,documentation:"N-ary expression which is true only if each of its 0 or more arguments is true. AND() === TRUE",methods:{toSQL:function(){for(var s="",i=0;i<this.args.length;i++){var a=this.args[i]
s+=a.toSQL(),i<this.args.length-1&&(s+=" AND ")}return s},toMQL:function(){for(var s="",i=0;i<this.args.length;i++){var a=this.args[i],sub=a.toMQL()
OrExpr.isInstance(a)&&(sub="("+sub+")"),s+=sub,i<this.args.length-1&&(s+=" ")}return s},toBQL:function(){for(var s="",i=0;i<this.args.length;i++){var a=this.args[i],sub=a.toBQL()
OrExpr.isInstance(a)&&(sub="("+sub+")"),s+=sub,i<this.args.length-1&&(s+=" ")}return s},collectInputs:function(terms){for(var i=0;i<this.args.length;i++)this.args[i].collectInputs(terms)},minterm:function(index,term){for(var out=!0,i=0;i<this.args.length;i++)out=this.args[i].minterm(index,term)&&out
return out}},constants:{PARTIAL_AND_RULES:[["EqExpr","EqExpr",function(e1,e2){return e1.arg1.exclusive?e1.arg2.f()==e2.arg2.f()?e1:FALSE:e1.arg2.f()==e2.arg2.f()?e1:null}],["InExpr","InExpr",function(e1,e2){var i=e1.arg1.exclusive?e1.arg2.intersection(e2.arg2):e1.arg2.union(e2.arg2)
return i.length?IN(e1.arg1,i):FALSE}],["InExpr","ContainedInICExpr",function(e1,e2){if(!e1.arg1.exclusive)return null
var i=e1.arg2.filter(function(o){return o=o.toUpperCase(),e2.arg2.some(function(o2){return-1!=o.indexOf(o2)})})
return i.length?IN(e1.arg1,i):FALSE}],["ContainedInICExpr","ContainedInICExpr",function(e1,e2){console.assert(!1,"AND.partialEval: ContainedInICExpr has no partialEval rule")}],["InExpr","ContainsICExpr",function(e1,e2){if(e1.arg1.exclusive)var i=e1.arg2.filter(function(o){return-1!==o.indexOfIC(e2.arg2.f())})}],["InExpr","ContainsExpr",function(e1,e2){if(e1.arg1.exclusive){var i=e1.arg2.filter(function(o){return-1!==o.indexOf(e2.arg2.f())})
return i.length?IN(e1.arg1,i):FALSE}}],["EqExpr","InExpr",function(e1,e2){return e1.arg1.exclusive?-1===e2.arg2.indexOf(e1.arg2.f())?FALSE:e1:void 0}]],partialAnd:function(e1,e2){if(OrExpr.isInstance(e2)){var tmp=e1
e1=e2,e2=tmp}if(OrExpr.isInstance(e1)){for(var args=[],i=0;i<e1.args.length;i++)args.push(AND(e2,e1.args[i]))
return OrExpr.create({args:args}).partialEval()}if(!BINARY.isInstance(e1))return null
if(!BINARY.isInstance(e2))return null
if(e1.arg1!=e2.arg1)return null
for(var RULES=this.PARTIAL_AND_RULES,i=0;i<RULES.length;i++){if(e1.model_.name==RULES[i][0]&&e2.model_.name==RULES[i][1])return RULES[i][2](e1,e2)
if(e2.model_.name==RULES[i][0]&&e1.model_.name==RULES[i][1])return RULES[i][2](e2,e1)}return DEBUG&&console.log("Unknown partialAnd combination: ",e1.name_,e2.name_),null},partialEval:function(){for(var newArgs=[],updated=!1,i=0;i<this.args.length;i++){var a=this.args[i],newA=this.args[i].partialEval()
if(newA===FALSE)return FALSE
if(AndExpr.isInstance(newA)){for(var j=0;j<newA.args.length;j++)newArgs.push(newA.args[j])
updated=!0}else newA===TRUE?updated=!0:(newArgs.push(newA),a!==newA&&(updated=!0))}for(var i=0;i<newArgs.length-1;i++)for(var j=i+1;j<newArgs.length;j++){var a=this.partialAnd(newArgs[i],newArgs[j])
if(a){if(console.log("***************** ",newArgs[i].toMQL()," <PartialAnd> ",newArgs[j].toMQL()," -> ",a.toMQL()),a===FALSE)return FALSE
newArgs[i]=a,newArgs.splice(j,1)}}return 0==newArgs.length?TRUE:1==newArgs.length?newArgs[0]:updated?AndExpr.create({args:newArgs}):this},f:function(obj){return this.args.every(function(arg){return arg.f(obj)})}}}),CLASS({name:"NeqExpr",extendsModel:"BINARY","abstract":!0,methods:{toSQL:function(){return this.arg1.toSQL()+"<>"+this.arg2.toSQL()},toMQL:function(){return"-"+this.arg1.toMQL()+"="+this.arg2.toMQL()},toBQL:function(){return"-"+this.arg1.toBQL()+":"+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval()
return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(newArg1.f()!=newArg2.f()):this.arg1!==newArg1||this.arg2!=newArg2?NeqExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){return this.arg1.f(obj)!=this.arg2.f(obj)}}}),CLASS({name:"UpperExpr",extendsModel:"UNARY",properties:[{name:"label_",defaultValue:"UPPER"}],methods:[function partialEval(){var newArg1=this.arg1.partialEval()
if(ConstantExpr.isInstance(newArg1)){var val=newArg1.f()
if("string"==typeof val)return compile_(val.toUpperCase())}else Array.isArray(newArg1)
return this},function f(obj){var a=this.arg1.f(obj)
return Array.isArray(a)?a.map(function(s){return s.toUpperCase?s.toUpperCase():s}):a&&a.toUpperCase?a.toUpperCase():a},function toMQL(){return ConstantExpr.isInstance(this.arg1)&&"string"==typeof this.arg1.arg1?this.arg1.arg1.toUpperCase():this.arg1.toMQL()}]}),CLASS({name:"MaxExpr",extendsModel:"UNARY",properties:[{name:"max",type:"int",help:"Maximum value.",defaultValue:void 0}],methods:{maximum:function(o1,o2){return o1.compareTo(o2)>0?o1:o2},reduce:function(other){return MaxExpr.create({max:this.maximum(this.max,other.max)})},reduceI:function(other){this.max=this.maximum(this.max,other.max)},pipe:function(sink){sink.put(this)},put:function(obj){var v=this.arg1.f(obj)
this.max=void 0===this.max?v:this.maximum(this.max,v)},remove:function(obj){},toString:function(){return this.max}}}),CLASS({name:"InExpr",extendsModel:"BINARY",documentation:"Binary expression which is true if its first argument is EQ to any element of its second argument, which is an array.",properties:[{name:"arg2",label:"Argument",type:"Expr",help:"Sub-expression",postSet:function(){this.valueSet_=void 0}}],methods:{partialEval:function(){return 1==this.arg2.length?EQ(this.arg1,this.arg2[0]):this},valueSet:function(){if(!this.valueSet_){for(var s={},i=0;i<this.arg2.length;i++)s[this.arg2[i]]=!0
this.valueSet_=s}return this.valueSet_},toSQL:function(){return this.arg1.toSQL()+" IN "+this.arg2},toMQL:function(){return this.arg1.toMQL()+"="+this.arg2.join(",")},toBQL:function(){return this.arg1.toBQL()+":("+this.arg2.join("|")+")"},f:function(obj){return this.valueSet().hasOwnProperty(this.arg1.f(obj))}}}),CLASS({name:"LtExpr",extendsModel:"BINARY","abstract":!0,methods:{toSQL:function(){return this.arg1.toSQL()+"<"+this.arg2.toSQL()},toMQL:function(){return this.arg1.toMQL()+"-before:"+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+"<"+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval()
return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(newArg1.f()<newArg2.f()):this.arg1!==newArg1||this.arg2!=newArg2?LtExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){return this.arg1.f(obj)<this.arg2.f(obj)}}}),CLASS({name:"GtExpr",extendsModel:"BINARY","abstract":!0,methods:{toSQL:function(){return this.arg1.toSQL()+">"+this.arg2.toSQL()},toMQL:function(){return this.arg1.toMQL()+"-after:"+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+">"+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval()
return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(newArg1.f()>newArg2.f()):this.arg1!==newArg1||this.arg2!=newArg2?GtExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){return this.arg1.f(obj)>this.arg2.f(obj)}}}),CLASS({name:"LteExpr",extendsModel:"BINARY","abstract":!0,methods:{toSQL:function(){return this.arg1.toSQL()+"<="+this.arg2.toSQL()},toMQL:function(){return this.arg1.toMQL()+"-before:"+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+"<="+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval()
return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(newArg1.f()<=newArg2.f()):this.arg1!==newArg1||this.arg2!=newArg2?LtExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){return this.arg1.f(obj)<=this.arg2.f(obj)}}}),CLASS({name:"GteExpr",extendsModel:"BINARY","abstract":!0,methods:{toSQL:function(){return this.arg1.toSQL()+">="+this.arg2.toSQL()},toMQL:function(){return this.arg1.toMQL()+"-after:"+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+">="+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval()
return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(newArg1.f()>=newArg2.f()):this.arg1!==newArg1||this.arg2!=newArg2?GtExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){return this.arg1.f(obj)>=this.arg2.f(obj)}}}),CLASS({name:"ExplainExpr",extendsModel:"UNARY",documentation:"Pseudo-expression which outputs a human-readable description of its subexpression, and the plan for evaluating it.",properties:[{name:"plan",help:"Execution Plan",defaultValue:""}],methods:{toString:function(){return this.plan},toSQL:function(){return this.arg1.toSQL()},toMQL:function(){return this.arg1.toMQL()},toBQL:function(){return this.arg1.toBQL()},partialEval:function(){var newArg=this.arg1.partialEval()
return this.arg1===newArg?this:EXPLAIN(newArg)},f:function(obj){return this.arg1.f(obj)}}}),CLASS({name:"OrExpr",extendsModel:"NARY",documentation:"N-ary expression which is true if any one of its 0 or more subexpressions is true. OR() === FALSE",methods:{toSQL:function(){var s
s="("
for(var i=0;i<this.args.length;i++){var a=this.args[i]
s+=a.toSQL(),i<this.args.length-1&&(s+=" OR ")}return s+=")"},toMQL:function(){for(var s="",i=0;i<this.args.length;i++){var a=this.args[i]
s+=a.toMQL(),i<this.args.length-1&&(s+=" OR ")}return s},toBQL:function(){for(var s="",i=0;i<this.args.length;i++){var a=this.args[i]
s+=a.toBQL(),i<this.args.length-1&&(s+=" | ")}return s},collectInputs:function(terms){for(var i=0;i<this.args.length;i++)this.args[i].collectInputs(terms)},minterm:function(index,term){for(var out=!1,i=0;i<this.args.length;i++)out=this.args[i].minterm(index,term)||out
return out}},constants:{PARTIAL_OR_RULES:[["InExpr","EqExpr",function(e1,e2){return IN(e1.arg1,e1.arg1.union([e2.arg2.f()]))}],["InExpr","InExpr",function(e1,e2){var i=e1.arg2.filter(function(o){return-1!==e2.arg2.indexOf(o)})
return IN(e1.arg1,e1.arg2.union(e2.arg2))}]],partialOr:function(e1,e2){if(!BINARY.isInstance(e1))return null
if(!BINARY.isInstance(e2))return null
if(e1.arg1!=e2.arg1)return null
for(var RULES=this.PARTIAL_OR_RULES,i=0;i<RULES.length;i++){if(e1.model_.name==RULES[i][0]&&e2.model_.name==RULES[i][1])return RULES[i][2](e1,e2)
if(e2.model_.name==RULES[i][0]&&e1.model_.name==RULES[i][1])return RULES[i][2](e2,e1)}return console.log("************** Unknown partialOr combination: ",e1.name_,e2.name_),null},partialEval:function(){for(var newArgs=[],updated=!1,i=0;i<this.args.length;i++){var a=this.args[i],newA=this.args[i].partialEval()
if(newA===TRUE)return TRUE
if(OrExpr.isInstance(newA)){for(var j=0;j<newA.args.length;j++)newArgs.push(newA.args[j])
updated=!0}else newA!==FALSE&&newArgs.push(newA),a!==newA&&(updated=!0)}for(var i=0;i<newArgs.length-1;i++)for(var j=i+1;j<newArgs.length;j++){var a=this.partialOr(newArgs[i],newArgs[j])
if(a){if(console.log("***************** ",newArgs[i].toMQL()," <PartialOr> ",newArgs[j].toMQL()," -> ",a.toMQL()),a===TRUE)return TRUE
newArgs[i]=a,newArgs.splice(j,1)}}return 0==newArgs.length?FALSE:1==newArgs.length?newArgs[0]:updated?OrExpr.create({args:newArgs}):this},f:function(obj){return this.args.some(function(arg){return arg.f(obj)})}}}),CLASS({name:"NotExpr",extendsModel:"UNARY","abstract":!0,documentation:"Unary expression which inverts the truth value of its argument.",methods:{toSQL:function(){return"not ( "+this.arg1.toSQL()+" )"},toMQL:function(){return"-"+this.arg1.toMQL()},toBQL:function(){return"-"+this.arg1.toBQL()},collectInputs:function(terms){this.arg1.collectInputs(terms)},minterm:function(index,term){return!this.arg1.minterm(index,term)},partialEval:function(){var newArg=this.arg1.partialEval()
return newArg===TRUE?FALSE:newArg===FALSE?TRUE:NotExpr.isInstance(newArg)?newArg.arg1:EqExpr.isInstance(newArg)?NeqExpr.create(newArg):NeqExpr.isInstance(newArg)?EqExpr.create(newArg):LtExpr.isInstance(newArg)?GteExpr.create(newArg):GtExpr.isInstance(newArg)?LteExpr.create(newArg):LteExpr.isInstance(newArg)?GtExpr.create(newArg):GteExpr.isInstance(newArg)?LtExpr.create(newArg):this.arg1===newArg?this:NOT(newArg)},f:function(obj){return!this.arg1.f(obj)}}}),CLASS({name:"ContainedInICExpr",extendsModel:"BINARY",documentation:"Checks if the first argument is contained in the array-valued right argument, ignoring case in strings.",properties:[{name:"arg2",label:"Argument",type:"Expr",help:"Sub-expression",preSet:function(_,a){return a.map(function(o){return o.toUpperCase()})}}],methods:{toSQL:function(){return this.arg1.toSQL()+" IN "+this.arg2},toMQL:function(){return this.arg1.toMQL()+":"+this.arg2.join(",")},toBQL:function(){return this.arg1.toBQL()+":("+this.arg2.join("|")+")"},f:function(obj){var v=this.arg1.f(obj)
if(Array.isArray(v)){for(var j=0;j<v.length;j++)for(var a=v[j].toUpperCase(),i=0;i<this.arg2.length;i++)if(-1!=a.indexOf(this.arg2[i]))return!0}else{v=(""+v).toUpperCase()
for(var i=0;i<this.arg2.length;i++)if(-1!=v.indexOf(this.arg2[i]))return!0}return!1}}}),CLASS({name:"ContainsExpr",extendsModel:"BINARY",methods:{toSQL:function(){return this.arg1.toSQL()+" like '%' + "+this.arg2.toSQL()+"+ '%'"},toMQL:function(){return this.arg1.toMQL()+":"+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+":"+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval()
return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(-1!=newArg1.f().indexOf(newArg2.f())):this.arg1!==newArg1||this.arg2!=newArg2?ContainsExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){var arg1=this.arg1.f(obj),arg2=this.arg2.f(obj)
return Array.isArray(arg1)?arg1.some(function(arg){return-1!=arg.indexOf(arg2)}):-1!=arg1.indexOf(arg2)}}}),CLASS({name:"ContainsICExpr",extendsModel:"BINARY",properties:[{name:"arg2",label:"Argument",type:"Expr",help:"Sub-expression",defaultValue:TRUE,postSet:function(_,value){this.pattern_=void 0}}],methods:{toSQL:function(){return this.arg1.toSQL()+" like '%' + "+this.arg2.toSQL()+"+ '%'"},toMQL:function(){return this.arg1.toMQL()+":"+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+":"+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval()
return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(-1!=newArg1.f().toLowerCase().indexOf(newArg2.f())):this.arg1!==newArg1||this.arg2!=newArg2?ContainsICExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){var arg1=this.arg1.f(obj),pattern=this.pattern_||(this.pattern_=new RegExp(this.arg2.f().toString().replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"i"))
if(Array.isArray(arg1)){var pattern=this.pattern_
return arg1.some(function(arg){return pattern.test(arg)})}return this.pattern_.test(arg1)}}}),CLASS({name:"StartsWithExpr",extendsModel:"BINARY",methods:{toSQL:function(){return this.arg1.toSQL()+" like '%' + "+this.arg2.toSQL()+"+ '%'"},toMQL:function(){return this.arg1.toMQL()+"-after:"+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+">="+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval()
return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(newArg1.f().startsWith(newArg2.f())):this.arg1!==newArg1||this.arg2!=newArg2?StartsWithExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){var arg1=this.arg1.f(obj),arg2=this.arg2.f(obj)
return Array.isArray(arg1)?arg1.some(function(arg){return arg.startsWith(arg2)}):arg1.startsWith(arg2)}}}),CLASS({name:"StartsWithICExpr",extendsModel:"BINARY",methods:{toSQL:function(){return this.arg1.toSQL()+" like '%' + "+this.arg2.toSQL()+"+ '%'"},toMQL:function(){return this.arg1.toMQL()+"-after:"+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+">="+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval()
return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(newArg1.f().startsWithIC(newArg2.f())):this.arg1!==newArg1||this.arg2!=newArg2?StartsWithICExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){return this.arg1.f(obj).startsWithIC(this.arg2.f(obj))}}}),CLASS({name:"ConcatExpr",extendsModel:"NARY",label:"concat",methods:{partialEval:function(){return this},f:function(obj){for(var str=[],i=0;i<this.args.length;i++)str.push(this.args[i].f(obj))
return str.join("")}}}),CLASS({name:"SumExpr",extendsModel:"UNARY",properties:[{name:"sum",type:"int",help:"Sum of values.",factory:function(){return 0}}],methods:{pipe:function(sink){sink.put(this)},put:function(obj){this.instance_.sum+=this.arg1.f(obj)},remove:function(obj){this.sum-=this.arg1.f(obj)},toString:function(){return this.sum}}}),CLASS({name:"AvgExpr",extendsModel:"UNARY",properties:[{name:"count",type:"int",defaultValue:0},{name:"sum",type:"int",help:"Sum of values.",defaultValue:0},{name:"avg",type:"floag",help:"Average of values.",getter:function(){return this.sum/this.count}}],methods:{pipe:function(sink){sink.put(this)},put:function(obj){this.count++,this.sum+=this.arg1.f(obj)},remove:function(obj){this.count--,this.sum-=this.arg1.f(obj)},toString:function(){return this.avg}}}),CLASS({name:"MinExpr",extendsModel:"UNARY",properties:[{name:"min",type:"int",help:"Minimum value.",defaultValue:void 0}],methods:{minimum:function(o1,o2){return o1.compareTo(o2)>0?o2:o1},reduce:function(other){return MinExpr.create({max:this.mininum(this.min,other.min)})},reduceI:function(other){this.min=this.minimum(this.min,other.min)},pipe:function(sink){sink.put(this)},put:function(obj){var v=this.arg1.f(obj)
this.min=void 0===this.min?v:this.minimum(this.min,v)},remove:function(obj){},toString:function(){return this.min}}}),CLASS({name:"DistinctExpr",extendsModel:"BINARY",properties:[{name:"values",help:"Distinct values.",factory:function(){return{}}}],methods:{reduce:function(other){},reduceI:function(other){},put:function(obj){var key=this.arg1.f(obj)
this.values.hasOwnProperty(key)||(this.values[key]=!0,this.arg2.put(obj))},remove:function(obj){},toString:function(){return this.arg2.toString()},toHTML:function(){return this.arg2.toHTML()}}}),CLASS({name:"GroupByExpr",extendsModel:"BINARY",properties:[{name:"groups",type:"Map[Expr]",help:"Groups.",factory:function(){return{}}},{name:"groupKeys",factory:function(){return[]}}],methods:{sortedGroups:function(opt_comparator){var c=opt_comparator||this.arg1.compareProperty
this.groupKeys.sort(c)
for(var ret={},i=0;i<this.groupKeys.length;i++)ret[this.groupKeys[i]]=this.groups[i]
return ret},reduce:function(other){},reduceI:function(other){for(var i in other.groups)this.groups[i]?this.groups[i].reduceI(other.groups[i]):this.groups[i]=other.groups[i].deepClone()},pipe:function(sink){for(key in this.groups)sink.push([key,this.groups[key].toString()])
return sink},putInGroup_:function(key,obj){var group=this.groups.hasOwnProperty(key)&&this.groups[key]
group||(group=this.arg2.clone(),this.groups[key]=group,this.groupKeys.push(key)),group.put(obj)},put:function(obj){var key=this.arg1.f(obj)
if(Array.isArray(key))if(key.length)for(var i=0;i<key.length;i++)this.putInGroup_(key[i],obj)
else this.putInGroup_("",obj)
else this.putInGroup_(key,obj)},clone:function(){return GroupByExpr.create({arg1:this.arg1,arg2:this.arg2})},remove:function(obj){},toString:function(){return this.groups},deepClone:function(){var cl=this.clone()
cl.groups={}
for(var i in this.groups)cl.groups[i]=this.groups[i].deepClone()
return cl},toView_:function(){return this},toHTML:function(){var out=[]
out.push("<table border=1>")
for(var key in this.groups){var value=this.groups[key],str=value.toView_?value.toView_().toHTML():value
out.push("<tr><th>",key,"</th><td>",str,"</td></tr>")}return out.push("</table>"),out.join("")},initHTML:function(){for(var key in this.groups){var value=this.groups[key]
value.toView_&&value.toView_().initHTML()}}}}),CLASS({name:"GridByExpr",extendsModel:"Expr",properties:[{name:"xFunc",label:"X-Axis Function",type:"Expr",help:"Sub-expression",defaultValue:TRUE},{name:"yFunc",label:"Y-Axis Function",type:"Expr",help:"Sub-expression",defaultValue:TRUE},{name:"acc",label:"Accumulator",type:"Expr",help:"Sub-expression",defaultValue:TRUE},{name:"rows",type:"Map[Expr]",help:"Rows.",factory:function(){return{}}},{name:"cols",label:"Columns",type:"Map[Expr]",help:"Columns.",factory:function(){return{}}},{model_:"ArrayProperty",name:"children"}],methods:{init:function(){this.SUPER()
var self=this,f=function(){self.cols=GROUP_BY(self.xFunc,COUNT()),self.rows=GROUP_BY(self.yFunc,GROUP_BY(self.xFunc,self.acc))}
self.addPropertyListener("xFunc",f),self.addPropertyListener("yFunc",f),self.addPropertyListener("acc",f),f()},reduce:function(other){},reduceI:function(other){},pipe:function(sink){},put:function(obj){this.rows.put(obj),this.cols.put(obj)},clone:function(){return this.model_.create({xFunc:this.xFunc,yFunc:this.yFunc,acc:this.acc})},remove:function(obj){},toString:function(){return this.groups},deepClone:function(){},renderCell:function(x,y,value){var str=value?value.toHTML?value.toHTML():value:""
return value&&value.toHTML&&value.initHTML&&this.children.push(value),"<td>"+str+"</td>"},sortAxis:function(values,f){return values.sort(f.compareProperty)},sortCols:function(cols,xFunc){return this.sortAxis(cols,xFunc)},sortRows:function(rows,yFunc){return this.sortAxis(rows,yFunc)},sortedCols:function(){return this.sortCols(this.cols.groupKeys,this.xFunc)},sortedRows:function(){return this.sortRows(this.rows.groupKeys,this.yFunc)},toHTML_:function(){return this},toHTML:function(){var out
this.children=[]
var cols=this.cols.groups,rows=this.rows.groups,sortedCols=this.sortedCols(),sortedRows=this.sortedRows()
out='<table border=0 cellspacing=0 class="gridBy"><tr><th></th>'
for(var i=0;i<sortedCols.length;i++){var x=sortedCols[i],str=x.toHTML?x.toHTML():x
out+="<th>"+str+"</th>"}out+="</tr>"
for(var j=0;j<sortedRows.length;j++){var y=sortedRows[j]
out+="<tr><th>"+y+"</th>"
for(var i=0;i<sortedCols.length;i++){var x=sortedCols[i],value=rows[y].groups[x]
value&&(value.x=x,value.y=y),out+=this.renderCell(x,y,value)}out+="</tr>"}return out+="</table>"},initHTML:function(){for(var i=0;i<this.children.length;i++)this.children[i].initHTML()
this.children=[]}}}),CLASS({name:"MapExpr",extendsModel:"BINARY",methods:{reduce:function(other){},reduceI:function(other){},pipe:function(sink){},put:function(obj){var val=this.arg1.f?this.arg1.f(obj):this.arg1(obj),acc=this.arg2
acc.put(val)},clone:function(){return MapExpr.create({arg1:this.arg1,arg2:this.arg2.clone()})},remove:function(obj){},toString:function(){return this.arg2.toString()},deepClone:function(){},toHTML:function(){return this.arg2.toHTML?this.arg2.toHTML():this.toString()},initHTML:function(){this.arg2.initHTML&&this.arg2.initHTML()}}}),CLASS({name:"SeqExpr",extendsModel:"NARY",methods:{pipe:function(sink){sink.put(this)},put:function(obj){for(var ret=[],i=0;i<this.args.length;i++){var a=this.args[i]
a.put(obj)}},f:function(obj){for(var ret=[],i=0;i<this.args.length;i++){var a=this.args[i]
ret.push(a.f(obj))}return ret},clone:function(){return SeqExpr.create({args:this.args.clone()})},toString:function(obj){var out=[]
out.push("(")
for(var i=0;i<this.args.length;i++){var a=this.args[i]
out.push(a.toString()),i<this.args.length-1&&out.push(",")}return out.push(")"),out.join("")},toHTML:function(obj){for(var out=[],i=0;i<this.args.length;i++){var a=this.args[i]
out.push(a.toHTML?a.toHTML():a.toString()),i<this.args.length-1&&out.push("&nbsp;")}return out.join("")}}}),CLASS({name:"UpdateExpr",extendsModel:"NARY",label:"UpdateExpr",properties:[{name:"dao",type:"DAO","transient":!0,hidden:!0}],methods:{put:function(obj){(this.objs_||(this.objs_=[])).push(obj)},eof:function(){if(this.objs_){for(var i=0;i<this.objs_.length;i++){var obj=this.objs_[i],newObj=this.f(obj)
newObj.id!==obj.id&&this.dao.remove(obj.id),this.dao.put(newObj)}this.objs_=void 0}},f:function(obj){for(var newObj=obj.clone(),i=0;i<this.args.length;i++)this.args[i].f(newObj)
return newObj},reduce:function(other){return UpdateExpr.create({args:this.args.concat(other.args),dao:this.dao})},reduceI:function(other){this.args=this.args.concat(other.args)},toString:function(){return this.toSQL()},toSQL:function(){for(var s="SET ",i=0;i<this.args.length;i++){var a=this.args[i]
s+=a.toSQL(),i<this.args.length-1&&(s+=", ")}return s}}}),CLASS({name:"SetExpr",label:"SetExpr",extendsModel:"BINARY",methods:{toSQL:function(){return this.arg1.toSQL()+" = "+this.arg2.toSQL()},f:function(obj){Property.isInstance(this.arg1)&&(obj[this.arg1.name]=this.arg2.f(obj))}}}),CLASS({name:"TreeExpr",extendsModel:"Expr",properties:[{name:"parentProperty"},{name:"childrenProperty"},{name:"items_",help:"Temporary map to store collected objects.",factory:function(){return{}},"transient":!0},{model_:"ArrayProperty",name:"roots"}],methods:{put:function(o){this.items_[o.id]=o,this.parentProperty.f(o)||this.roots.push(o)},eof:function(){var pprop=this.parentProperty,cprop=this.childrenProperty
for(var key in this.items_){var item=this.items_[key],parentId=pprop.f(item)
if(parentId){var parent=this.items_[parentId]
parent[cprop.name]=cprop.f(parent).concat(item)}}this.items_={}}}}),CLASS({name:"DescExpr",extendsModel:"UNARY",methods:{toSQL:function(){return this.arg1.toMQL()+"DESC"},toMQL:function(){return"-"+this.arg1.toMQL()},compare:function(o1,o2){return-1*this.arg1.compare(o1,o2)}}}),CLASS({name:"AddExpr",extendsModel:"BINARY",methods:{toSQL:function(){return this.arg1.toSQL()+" + "+this.arg2.toSQL()},f:function(o){return this.arg1.f(o)+this.arg2.f(o)}}})
var JOIN=function(dao,key,sink){return sink=sink||[].sink,{f:function(o){var s=sink.clone()
return dao.where(EQ(key,o.id)).select(s),[o,s]}}}
CLASS({name:"MQLExpr",extendsModel:"UNARY",documentation:"Parse an MQL query string and use it as a predicate.",properties:[{name:"specializations_",factory:function(){return{}}}],methods:{specialize:function(model){var qp=QueryParserFactory(model,!0)
return qp.parseString(this.arg1)||FALSE},specialization:function(model){return this.specializations_[model.name]||(this.specializations_[model.name]=this.specialize(model))},toSQL:function(){return this.arg1},toMQL:function(){return this.arg1},partialEval:function(){return this},f:function(obj){return this.specialization(obj.model_).f(obj)}}}),CLASS({name:"KeywordExpr",extendsModel:"UNARY",documentation:"Keyword search.",methods:{toSQL:function(){return this.arg1},toMQL:function(){return this.arg1},partialEval:function(){return this},f:function(obj){var pattern=this.pattern_||(this.pattern_=new RegExp(this.arg1.toString().replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"i"))
return this.pattern_.test(obj.toJSON())}}})
var MONTH=function(p){return{f:function(o){return p.f(o).getMonth()}}},QueryParserFactory=function(model,opt_enableKeyword){for(var g={__proto__:grammar,START:sym("query"),query:sym("or"),or:repeat(sym("and"),alt(literal_ic(" OR "),literal(" | ")),1),and:repeat(sym("expr"),alt(literal_ic("AND "),not(alt(literal_ic(" OR"),literal(" |"))," ")),1),expr:alt(sym("paren"),sym("negate"),sym("has"),sym("is"),sym("equals"),sym("before"),sym("after"),sym("id"),sym("keyword")),paren:seq1(1,"(",sym("query"),")"),negate:alt(seq("-",sym("expr")),seq("NOT ",sym("expr"))),id:sym("number"),has:seq(literal_ic("has:"),sym("fieldname")),is:seq(literal_ic("is:"),sym("fieldname")),equals:seq(sym("fieldname"),alt(":","="),sym("valueList")),before:seq(sym("fieldname"),alt("<","<=","-before:"),sym("value")),after:seq(sym("fieldname"),alt(">",">=","-after:"),sym("value")),value:alt(sym("me"),sym("date"),sym("string"),sym("number")),compoundValue:alt(sym("negateValue"),sym("orValue"),sym("andValue")),negateValue:seq("(",alt("-",literal_ic("not ")),sym("value"),")"),orValue:seq("(",repeat(sym("value"),alt("|",literal_ic(" or ")," | "),1),")"),andValue:seq("(",repeat(sym("value"),alt(literal_ic(" and ")," "),1),")"),valueList:alt(sym("compoundValue"),repeat(sym("value"),",",1)),keyword:function(){var keyword_=sym("keyword_")
return function(ps){return opt_enableKeyword&&this.parse(keyword_,ps)}}(),keyword_:str(plus(notChar(" "))),me:seq(literal_ic("me"),lookahead(not(sym("char")))),date:alt(sym("range date"),sym("literal date"),sym("relative date")),"range date":seq(sym("literal date"),"..",sym("literal date")),"literal date":alt(seq(sym("number"),"-",sym("number"),"-",sym("number"),"T",sym("number"),":",sym("number")),seq(sym("number"),"-",sym("number"),"-",sym("number"),"T",sym("number")),seq(sym("number"),"-",sym("number"),"-",sym("number")),seq(sym("number"),"-",sym("number")),seq(sym("number"),"/",sym("number"),"/",sym("number"))),"relative date":seq(literal_ic("today"),optional(seq("-",sym("number")))),string:alt(sym("word"),sym("quoted string")),"quoted string":str(seq1(1,'"',repeat(alt(literal('\\"','"'),notChar('"'))),'"')),word:str(plus(sym("char"))),"char":alt(range("a","z"),range("A","Z"),range("0","9"),"-","^","_","@","%","."),number:str(plus(range("0","9")))},fields=[],properties=model.getRuntimeProperties(),i=0;i<properties.length;i++){var prop=properties[i]
fields.push(literal_ic(prop.name,prop))
for(var j=0;j<prop.aliases.length;j++)prop.aliases[j]&&fields.push(literal_ic(prop.aliases[j],prop))
prop.shortName&&fields.push(literal_ic(prop.shortName,prop))}return fields.sort(function(a,b){var d=a.length-b.length
return 0!==d?d:a==b?0:b>a?1:-1}),g.fieldname=alt.apply(null,fields),g.addActions({id:function(v){return EQ(model.ID,v)},or:function(v){return OR.apply(OR,v)},and:function(v){return AND.apply(AND,v)},negate:function(v){return NOT(v[1])},number:function(v){return parseInt(v)},me:function(){return this.ME||this.X.ME||""},has:function(v){return NEQ(v[1],"")},is:function(v){return EQ(v[1],TRUE)},before:function(v){return Array.isArray(v[2])&&v[2][0]instanceof Date&&(v[2]="<="===v[1]?v[2][1]:v[2][0]),("<="===v[1]?LTE:LT)(v[0],v[2])},after:function(v){return Array.isArray(v[2])&&v[2][0]instanceof Date&&(v[2]=">="===v[1]?v[2][0]:v[2][1]),(">="===v[1]?GTE:GT)(v[0],v[2])},equals:function(v){var prop=v[0],values=v[2],isInt=IntProperty.isInstance(prop),isNum=isInt||FloatProperty.isInstance(prop),isDateField=DateProperty.isInstance(prop)||DateTimeProperty.isInstance(prop),isDateRange=Array.isArray(values[0])&&values[0][0]instanceof Date
if(isDateField||isDateRange){if(!isDateRange){var start=new Date(0),end=new Date(0)
start.setUTCFullYear(values[0]),end.setUTCFullYear(+values[0]+1),values=[[start,end]]}var q=AND(GTE(prop,values[0][0]),LT(prop,values[0][1]))
return q}var expr
if(isNum){for(var i=0;i<values.length;i++)values[i]=isInt?parseInt(values[i]):parseFloat(values[i])
expr=IN(v[0],values)}else expr="="===v[1]?IN_IC(v[0],values):ContainedInICExpr.create({arg1:compile_(prop),arg2:values})
return values.negated?NOT(expr):values.and?AndExpr.create({args:values.map(function(x){return expr.model_.create({arg1:expr.arg1,arg2:[x]})})}):expr},keyword:function(v){return KEYWORD(v)},negateValue:function(v){return v.negated=!0,v},orValue:function(v){return v=v[1],v.or=!0,v},andValue:function(v){return v=v[1],v.and=!0,v},"literal date":function(v){var start,end,interval
start=new Date,end=new Date
for(var ops=["FullYear","Month","Date","Hours","Minutes","Seconds"],defaults=[0,1,1,0,0,0],i=0;i<ops.length;i++){var x=2*i>v.length?defaults[i]:v[2*i]
start["setUTC"+ops[i]](x-(1==i?1:0)),end["setUTC"+ops[i]](x-(1==i?1:0))}var last=Math.floor(v.length/2),op="UTC"+ops[last]
return end["set"+op](end["get"+op]()+1),[start,end]},"relative date":function(v){var d=new Date
return v[1]&&d.setDate(d.getDate()-v[1][1]),d},"range date":function(v){return[v[0][0],v[2][1]]}}),g},Visitor={create:function(){return{__proto__:this,stack:[]}},push:function(o){this.stack.push(o)},pop:function(){return this.stack.pop()},top:function(){return this.stack.length&&this.stack[this.stack.length-1]},visit:function(o){return Array.isArray(o)?this.visitArray(o):"string"==typeof o?this.visitString(o):"number"==typeof o?this.visitNumber(o):o instanceof Function?this.visitFunction(o):o instanceof Date?this.visitDate(o):o===!0?this.visitTrue():o===!1?this.visitFalse():null===o?this.visitNull():o instanceof Object?o.model_?this.visitObject(o):this.visitMap(o):this.visitUndefined()},visitArray:function(o){for(var len=o.length,i=0;len>i;i++)this.visitArrayElement(o,i)
return o},visitArrayElement:function(arr,i){this.visit(arr[i])},visitString:function(o){return o},visitFunction:function(o){return o},visitNumber:function(o){return o},visitDate:function(o){return o},visitObject:function(o){var properties=o.model_.getRuntimeProperties()
for(var key in properties){var prop=properties[key]
prop.name in o.instance_&&this.visitProperty(o,prop)}return o},visitProperty:function(o,prop){this.visit(o[prop.name])},visitMap:function(o){for(var key in o)this.visitMapElement(key,o[key])
return o},visitMapElement:function(key,value){},visitTrue:function(){return!0},visitFalse:function(){return!1},visitNull:function(){return null},visitUndefined:function(){return void 0}}
CLASS({name:"XHR",properties:[{model_:"IntProperty",name:"delay",defaultValue:0},{model_:"IntProperty",name:"retries",defaultValue:0},{name:"authAgent"},{name:"responseType",defaultValue:"text"}],methods:{init:function(args){this.SUPER(args),this.delay&&this.addDecorator(DelayDecorator.create({delayMs:this.delay})),this.authAgent&&this.addDecorator(OAuthXhrDecorator.create({authAgent:this.authAgent})),this.retries&&this.addDecorator(RetryDecorator.create({maxAttempts:this.retries}))},makeXhr:function(){return new XMLHttpRequest},open:function(xhr,method,url){xhr.open(method,url)},setRequestHeader:function(xhr,header,value){xhr.setRequestHeader(header,value)},configure:function(xhr){xhr.responseType=this.responseType,this.setRequestHeader(xhr,"Content-Type","application/json")},bindListeners:function(xhr,ret){var self=this
xhr.onreadystatechange=function(){if(4==xhr.readyState){if("json"===self.responseType&&"string"==typeof xhr.response)var response=JSON.parse(xhr.response)
else response=xhr.response
ret(response,xhr)}}},send:function(xhr,data){xhr.send(data)},asend:function(ret,url,data,method){var xhr=this.makeXhr()
this.open(xhr,method||"GET",url),this.configure(xhr),this.bindListeners(xhr,ret),this.send(xhr,data&&data.toJSON?data.toJSON():data)}}}),CLASS({name:"OAuthXhrDecorator",properties:["authAgent"],methods:{configure:function(decorator,delegate,args){var xhr=args[0]
return xhr.setRequestHeader("Authorization","Bearer "+decorator.authAgent.accessToken),delegate.apply(this,args)},asend:function(decorator,delegate,args){var ret=args[0]
return args[0]=function(response,xhr){401===xhr.status?decorator.authAgent.refresh(function(){ret(response,xhr)}):ret(response,xhr)},delegate.apply(null,args)}}}),CLASS({name:"RetryDecorator",properties:[{model_:"IntProperty",name:"maxAttempts",defaultValue:3}],methods:{asend:function(decorator,delegate,args){var originalRet=args[0],attempts=0,self=this,response
awhile(function(){return!0},aseq(function(ret){args[0]=ret,delegate.apply(self,args)},function(ret,response,xhr){return xhr.status>=200&&xhr.status<300||404===xhr.status||++attempts>=decorator.maxAttempts?(finished=!0,void originalRet(response,xhr)):void ret()}))(function(){})}}}),CLASS({name:"DelayDecorator",properties:[{model_:"IntProperty",name:"delayMs"}],methods:{decorateObject:function(target){var asend=adelay(target.asend.bind(target),this.delayMs)
target.decorate("asend",function(_,_,args){asend.apply(null,args)})}}}),CLASS({name:"XhrMessenger",properties:[{model_:"URLProperty",name:"url"},{model_:"StringProperty",name:"method",defaultValue:"POST"}],methods:{put:function(obj,sink){var xhr=this.Y.XHR.create()
xhr.asend(function(response,xhr){return xhr.status>=200&&xhr.status<300?void(sink&&sink.put&&sink.put(response)):void(sink&&sink.error&&sink.error([response,xhr]))},this.url,obj,this.method)}}})
var LoggingDAO={create:function(){var logger,delegate
return 2==arguments.length?(logger=arguments[0],delegate=arguments[1]):(logger=console.log.bind(console),delegate=arguments[0]),{__proto__:delegate,put:function(obj,sink){logger("put",obj),delegate.put(obj,sink)},remove:function(query,sink){logger("remove",query),delegate.remove(query,sink)},select:function(sink,options){return logger("select",options||""),delegate.select(sink,options)},removeAll:function(sink,options){return logger("removeAll",options),delegate.removeAll(sink,options)}}}},TimingDAO={create:function(name,delegate){function start(op){var str=name+"-"+op,key=activeOps[op]++?str+"-"+id++:str
return console.time(id),[key,str,window.performance.now(),op]}function end(act){activeOps[act[3]]--,id--,console.timeEnd(act[0]),console.log("Timing: ",act[1]," ",(window.performance.now()-act[2]).toFixed(3)," ms")}function endSink(act,sink){return{put:function(){end(act),sink&&sink.put&&sink.put.apply(sink,arguments)},remove:function(){end(act),sink&&sink.remove&&sink.remove.apply(sink,arguments)},error:function(){end(act),sink&&sink.error&&sink.error.apply(sink,arguments)},eof:function(){end(act),sink&&sink.eof&&sink.eof.apply(sink,arguments)}}}var id,activeOps={put:0,remove:0,find:0,select:0}
return{__proto__:delegate,put:function(obj,sink){var act=start("put")
delegate.put(obj,endSink(act,sink))},remove:function(query,sink){var act=start("remove")
delegate.remove(query,endSink(act,sink))},find:function(key,sink){var act=start("find")
delegate.find(key,endSink(act,sink))},select:function(sink,options){var act=start("select"),fut=afuture()
return delegate.select(sink,options)(function(s){end(act),fut.set(s)}),fut.get}}}},ObjectToJSON={__proto__:Visitor.create(),visitFunction:function(o){return o.toString()},visitObject:function(o){return this.push({model_:(o.model_["package"]?o.model_["package"]+".":"")+o.model_.name}),this.__proto__.visitObject.call(this,o),this.pop()},visitProperty:function(o,prop){prop.propertyToJSON(this,this.top(),o)},visitMap:function(o){return this.push({}),Visitor.visitMap.call(this,o),this.pop()},visitMapElement:function(key,value){this.top()[key]=this.visit(value)},visitArray:function(o){return this.push([]),this.__proto__.visitArray.call(this,o),this.pop()},visitArrayElement:function(arr,i){this.top().push(this.visit(arr[i]))}},JSONToObject={__proto__:ObjectToJSON.create(),visitString:function(o){try{return"function("===o.substr(0,9)?eval("("+o+")"):o}catch(x){return console.log(x,o),o}},visitObject:function(o){var model=X.lookup(o.model_)
if(!model)throw new Error("Unknown Model: "+o.model_)
var obj=model.create()
return Object_forEach(o,function(value,key){"model_"!==key&&(obj[key]=this.visit(value))}.bind(this)),obj},visitArray:Visitor.visitArray,visitArrayElement:function(arr,i){arr[i]=this.visit(arr[i])}}
CLASS({name:"FilteredDAO_",extendsModel:"foam.dao.ProxyDAO",documentation:"<p>Internal use only.</p>",properties:[{name:"query",required:!0}],methods:{select:function(sink,options){return this.delegate.select(sink,options?{__proto__:options,query:options.query?AND(this.query,options.query):this.query}:{query:this.query})},removeAll:function(sink,options){return this.delegate.removeAll(sink,options?{__proto__:options,query:options.query?AND(this.query,options.query):this.query}:{query:this.query})},listen:function(sink,options){return this.SUPER(sink,options?{__proto__:options,query:options.query?AND(this.query,options.query):this.query}:{query:this.query})},toString:function(){return this.delegate+".where("+this.query+")"}}}),CLASS({name:"OrderedDAO_",extendsModel:"foam.dao.ProxyDAO",documentation:function(){},properties:[{name:"comparator",required:!0}],methods:{select:function(sink,options){return options?options.order||(options={__proto__:options,order:this.comparator}):options={order:this.comparator},this.delegate.select(sink,options)},toString:function(){return this.delegate+".orderBy("+this.comparator+")"}}}),CLASS({name:"LimitedDAO_",extendsModel:"foam.dao.ProxyDAO",documentation:function(){},properties:[{name:"count",required:!0}],methods:{select:function(sink,options){return options=options?"limit"in options?{__proto__:options,limit:Math.min(this.count,options.limit)}:{__proto__:options,limit:this.count}:{limit:this.count},this.delegate.select(sink,options)},toString:function(){return this.delegate+".limit("+this.count+")"}}}),CLASS({name:"SkipDAO_",extendsModel:"foam.dao.ProxyDAO",documentation:function(){},properties:[{name:"skip",required:!0,postSet:function(){this.skip!==Math.floor(this.skip)&&console.warn("skip() called with non-integer value: "+this.skip)}}],methods:{select:function(sink,options){return options=options?{__proto__:options,skip:this.skip}:{skip:this.skip},this.delegate.select(sink,options)},toString:function(){return this.delegate+".skip("+this.skip+")"}}}),CLASS({name:"RelationshipDAO",extendsModel:"FilteredDAO_",documentation:"Adapts a DAO based on a Relationship.",properties:[{name:"relatedProperty",required:!0},{name:"relativeID",required:!0},{name:"query",lazyFactory:function(){return AND(NEQ(this.relatedProperty,""),EQ(this.relatedProperty,this.relativeID))}}],methods:[function put(obj,sink){obj[this.relatedProperty.name]=this.relativeID,this.SUPER(obj,sink)}]}),CLASS({name:"AbstractDAO",documentation:function(){},requires:[],properties:[{name:"daoListeners_","transient":!0,hidden:!0,factory:function(){return[]}}],methods:{init:function(){arequire("FilteredDAO_"),arequire("LimitedDAO_"),arequire("SkipDAO_"),arequire("OrderedDAO_"),this.SUPER()},update:function(expr){return this.select(UPDATE(expr,this))},select:function(sink,options){},remove:function(query,sink){},pipe:function(sink,options){sink=this.decorateSink_(sink,options,!0)
var fc=this.createFlowControl_(),self=this
this.select({put:function(){sink.put&&sink.put.apply(sink,arguments)},remove:function(){sink.remove&&sink.remove.apply(sink,arguments)},error:function(){sink.error&&sink.error.apply(sink,arguments)},eof:function(){fc.stopped?sink.eof&&sink.eof():self.listen(sink,options)}},options,fc)},decorateSink_:function(sink,options,isListener,disableLimit){return options&&(disableLimit||(options.limit&&(sink=limitedSink(options.limit,sink)),options.skip&&(sink=skipSink(options.skip,sink))),options.order&&!isListener&&(sink=orderedSink(options.order,sink)),options.query&&(sink=predicatedSink(options.query.partialEval?options.query.partialEval():options.query,sink))),sink},createFlowControl_:function(){return{stop:function(){this.stopped=!0},error:function(e){this.errorEvt=e}}},where:function(query){return(this.Y||X).lookup("FilteredDAO_").create({query:query,delegate:this})},limit:function(count){return(this.Y||X).lookup("LimitedDAO_").create({count:count,delegate:this})},skip:function(skip){return(this.Y||X).lookup("SkipDAO_").create({skip:skip,delegate:this})},orderBy:function(){return(this.Y||X).lookup("OrderedDAO_").create({comparator:1==arguments.length?arguments[0]:argsToArray(arguments),delegate:this})},listen:function(sink,options){this.daoListeners_.push(this.decorateSink_(sink,options,!0))},unlisten:function(sink){for(var ls=this.daoListeners_,i=0;i<ls.length;i++)if(ls[i].$UID===sink.$UID)return ls.splice(i,1),!0
console.assert(!DEBUG,"Phantom DAO unlisten: ",this,sink)},removeAll:function(sink,options){var self=this,future=afuture()
return this.select({put:function(obj){self.remove(obj,{remove:sink&&sink.remove})}})(function(){sink&&sink.eof(),future.set()}),future.get},notify_:function(fName,args){for(var i=0;i<this.daoListeners_.length;i++){var l=this.daoListeners_[i],fn=l[fName]
if(fn){args[2]={stop:function(fn,l){return function(){fn(l)}}(this.unlisten.bind(this),l),error:function(e){}}
try{fn.apply(l,args)}catch(err){err!==this.UNSUBSCRIBE_EXCEPTION&&console.error("Error delivering event (removing listener): ",fName,err),this.unlisten(l)}}}}}}),Function.prototype.put=function(){this.apply(this,arguments)},Function.prototype.remove=function(){this.apply(this,arguments)},Function.prototype.reset=function(){this.call(this)},function(){var pmap={}
for(var key in AbstractDAO.methods)pmap[AbstractDAO.methods[key].name]=AbstractDAO.methods[key].code
for(var key in pmap)Object.defineProperty(Array.prototype,key,{value:pmap[key],configurable:!0,writable:!0})}(),defineLazyProperty(Array.prototype,"daoListeners_",function(){return{value:[],configurable:!0}})
var ArraySink={__proto__:Array.prototype,put:function(obj,sink){this.push(obj),this.notify_("put",arguments),sink&&sink.put&&sink.put(obj)},clone:function(){return this.slice().sink},deepClone:function(){return Array.prototype.call(this).sink}}
MODEL0({extendsProto:"Array",properties:[{name:"dao",getter:function(){return this.__proto__=Array.prototype,this}},{name:"sink",getter:function(){return this.__proto__=ArraySink,this}}],methods:{listen:AbstractDAO.getPrototype().listen,unlisten:AbstractDAO.getPrototype().unlisten,notify_:AbstractDAO.getPrototype().notify_,deleteF:function(v){for(var a=this.clone(),i=0;i<a.length;i++)if(a[i]===v){a.splice(i,1)
break}return a},deleteI:function(v){for(var i=0;i<this.length;i++)if(this[i]===v)return this.splice(i,1),!0
return!1},removeF:function(p){for(var a=this.clone(),i=0;i<a.length;i++)if(p.f(a[i])){a.splice(i,1)
break}return a},removeI:function(p){for(var i=0;i<this.length;i++)p.f(this[i])&&(this.splice(i,1),breeak)
return this},pushF:function(obj){var a=this.clone()
return a.push(obj),a},id:function(obj){return obj.id||obj.$UID},put:function(obj,sink){for(var idx=0;idx<this.length;idx++)if(this[idx].id===obj.id)return this[idx]=obj,sink&&sink.put&&sink.put(obj),void this.notify_("put",arguments)
this.push(obj),this.notify_("put",arguments),sink&&sink.put&&sink.put(obj)},find:function(query,sink){if(query.f){for(var idx=0;idx<this.length;idx++)if(query.f(this[idx]))return void(sink&&sink.put&&sink.put(this[idx]))}else for(var idx=0;idx<this.length;idx++)if(this[idx].id===query)return void(sink&&sink.put&&sink.put(this[idx]))
sink&&sink.error&&sink.error("find",query)},remove:function(obj,sink){if(!obj)return void(sink&&sink.error&&sink.error("missing key"))
for(var objId=obj.id,id=void 0!==objId&&""!==objId?objId:obj,idx=0;idx<this.length;idx++)if(this[idx].id===id){var rem=this.splice(idx,1)[0]
return void(sink&&sink.remove&&sink.remove(rem[0]))}sink&&sink.error&&sink.error("remove",obj)},removeAll:function(sink,options){options||(options={}),options.query||(options.query={f:function(){return!0}})
for(var i=0;i<this.length;i++){var obj=this[i]
if(options.query.f(obj)){var rem=this.splice(i,1)[0]
sink&&sink.remove&&sink.remove(rem),i--}}return sink&&sink.eof&&sink.eof(),anop()},select:function(sink,options){sink=sink||[].sink
var hasQuery=options&&(options.query||options.order),originalsink=sink
if(sink=this.decorateSink_(sink,options,!1,!hasQuery),!hasQuery&&GLOBAL.CountExpr&&CountExpr.isInstance(sink))return sink.count=this.length,aconstant(originalsink)
for(var fc=this.createFlowControl_(),start=Math.max(0,hasQuery?0:options&&options.skip||0),end=hasQuery?this.length:Math.min(this.length,start+(options&&options.limit||this.length)),i=start;end>i&&(sink.put(this[i],null,fc),!fc.stopped);i++)if(fc.errorEvt)return sink.error&&sink.error(fc.errorEvt),aconstant(originalsink,fc.errorEvt)
return sink.eof&&sink.eof(),aconstant(originalsink)}}})
var NOT_FOUND={cost:0,execute:function(_,sink,_){return anop},toString:function(){return"no-match(cost=0)"}},NO_PLAN={cost:Number.MAX_VALUE,execute:function(){return anop},toString:function(){return"no-plan"}},ValueIndex={put:function(s,newValue){return newValue},remove:function(){return void 0},plan:function(){var plan={cost:1,execute:function(s,sink){return sink.put(s),anop},toString:function(){return"unique"}}
return function(){return plan}}(),get:function(value,key){return value},select:function(value,sink,options){if(options){if(options.query&&!options.query.f(value))return
if("skip"in options&&options.skip-->0)return
if("limit"in options&&options.limit--<1)return}sink.put(value)},selectReverse:function(value,sink,options){this.select(value,sink,options)},size:function(obj){return 1},toString:function(){return"value"}},KEY=0,VALUE=1,SIZE=2,LEVEL=3,LEFT=4,RIGHT=5,TreeIndex={create:function(prop,tail){return tail=tail||ValueIndex,{__proto__:this,prop:prop,tail:tail,selectCount:0}},bulkLoad:function(a){if(this.tail===ValueIndex)return a.sort(toCompare(this.prop)),this.bulkLoad_(a,0,a.length-1)
for(var s=void 0,i=0;i<a.length;i++)s=this.put(s,a[i])
return s},bulkLoad_:function(a,start,end){if(start>end)return void 0
var m=start+Math.floor((end-start+1)/2),tree=this.put(void 0,a[m])
return tree[LEFT]=this.bulkLoad_(a,start,m-1),tree[RIGHT]=this.bulkLoad_(a,m+1,end),tree[SIZE]+=this.size(tree[LEFT])+this.size(tree[RIGHT]),tree},dedup:function(obj,value){obj[this.prop.name]=value},maybeClone:function(s){return s&&this.selectCount>0?s.clone():s},put:function(s,newValue){return this.putKeyValue(s,this.prop.f(newValue),newValue)},putKeyValue:function(s,key,value){if(!s)return[key,this.tail.put(null,value),1,1]
s=this.maybeClone(s)
var r=this.compare(s[KEY],key)
if(0===r)this.dedup(value,s[KEY]),s[SIZE]-=this.tail.size(s[VALUE]),s[VALUE]=this.tail.put(s[VALUE],value),s[SIZE]+=this.tail.size(s[VALUE])
else{var side=r>0?LEFT:RIGHT
s[side]&&(s[SIZE]-=s[side][SIZE]),s[side]=this.putKeyValue(s[side],key,value),s[SIZE]+=s[side][SIZE]}return this.split(this.skew(s))},skew:function(s){if(s&&s[LEFT]&&s[LEFT][LEVEL]===s[LEVEL]){var l=this.maybeClone(s[LEFT])
return s[LEFT]=l[RIGHT],l[RIGHT]=s,this.updateSize(s),this.updateSize(l),l}return s},updateSize:function(s){s[SIZE]=this.size(s[LEFT])+this.size(s[RIGHT])+this.tail.size(s[VALUE])},split:function(s){if(s&&s[RIGHT]&&s[RIGHT][RIGHT]&&s[LEVEL]===s[RIGHT][RIGHT][LEVEL]){var r=this.maybeClone(s[RIGHT])
return s[RIGHT]=r[LEFT],r[LEFT]=s,r[LEVEL]++,this.updateSize(s),this.updateSize(r),r}return s},remove:function(s,value){return this.removeKeyValue(s,this.prop.f(value),value)},removeKeyValue:function(s,key,value){if(!s)return s
s=this.maybeClone(s)
var r=this.compare(s[KEY],key)
if(0===r){if(s[SIZE]-=this.tail.size(s[VALUE]),s[VALUE]=this.tail.remove(s[VALUE],value),s[VALUE])return s[SIZE]+=this.tail.size(s[VALUE]),s
if(!s[LEFT]&&!s[RIGHT])return void 0
var side=s[LEFT]?LEFT:RIGHT,l=side===LEFT?this.predecessor(s):this.successor(s)
s[KEY]=l[KEY],s[VALUE]=l[VALUE],s[side]=this.removeNode(s[side],l[KEY])}else{var side=r>0?LEFT:RIGHT
s[SIZE]-=this.size(s[side]),s[side]=this.removeKeyValue(s[side],key,value),s[SIZE]+=this.size(s[side])}return s=this.skew(this.decreaseLevel(s)),s[RIGHT]&&(s[RIGHT]=this.skew(this.maybeClone(s[RIGHT])),s[RIGHT][RIGHT]&&(s[RIGHT][RIGHT]=this.skew(this.maybeClone(s[RIGHT][RIGHT])))),s=this.split(s),s[RIGHT]=this.split(this.maybeClone(s[RIGHT])),s},removeNode:function(s,key){if(!s)return s
s=this.maybeClone(s)
var r=this.compare(s[KEY],key)
if(0===r)return s[LEFT]?s[LEFT]:s[RIGHT]
var side=r>0?LEFT:RIGHT
return s[SIZE]-=this.size(s[side]),s[side]=this.removeNode(s[side],key),s[SIZE]+=this.size(s[side]),s},predecessor:function(s){if(!s[LEFT])return s
for(s=s[LEFT];s[RIGHT];s=s[RIGHT]);return s},successor:function(s){if(!s[RIGHT])return s
for(s=s[RIGHT];s[LEFT];s=s[LEFT]);return s},decreaseLevel:function(s){var expectedLevel=Math.min(s[LEFT]?s[LEFT][LEVEL]:0,s[RIGHT]?s[RIGHT][LEVEL]:0)+1
return expectedLevel<s[LEVEL]&&(s[LEVEL]=expectedLevel,s[RIGHT]&&expectedLevel<s[RIGHT][LEVEL]&&(s[RIGHT]=this.maybeClone(s[RIGHT]),s[RIGHT][LEVEL]=expectedLevel)),s},get:function(s,key){if(!s)return void 0
var r=this.compare(s[KEY],key)
return 0===r?s[VALUE]:this.get(r>0?s[LEFT]:s[RIGHT],key)},select:function(s,sink,options){if(s){if(options){if("limit"in options&&options.limit<=0)return
var size=this.size(s)
if(options.skip>=size&&!options.query)return void(options.skip-=size)}this.select(s[LEFT],sink,options),this.tail.select(s[VALUE],sink,options),this.select(s[RIGHT],sink,options)}},selectReverse:function(s,sink,options){if(s){if(options){if("limit"in options&&options.limit<=0)return
var size=this.size(s)
if(options.skip>=size)return void(options.skip-=size)}this.selectReverse(s[RIGHT],sink,options),this.tail.selectReverse(s[VALUE],sink,options),this.selectReverse(s[LEFT],sink,options)}},findPos:function(s,key,incl){if(!s)return 0
var r=this.compare(s[KEY],key)
return 0===r?incl?this.size(s[LEFT]):this.size(s)-this.size(s[RIGHT]):r>0?this.findPos(s[LEFT],key,incl):this.findPos(s[RIGHT],key,incl)+this.size(s)-this.size(s[RIGHT])},size:function(s){return s?s[SIZE]:0},compare:function(o1,o2){return this.prop.compareProperty(o1,o2)},plan:function(s,sink,options){var query=options&&options.query
if(query===FALSE)return NOT_FOUND
if(!query&&CountExpr.isInstance(sink)){var count=this.size(s)
return{cost:0,execute:function(unused,sink,options){return sink.count+=count,anop},toString:function(){return"short-circuit-count("+count+")"}}}var prop=this.prop,isExprMatch=function(model){if(!model)return void 0
if(query){if(model.isInstance(query)&&query.arg1===prop){var arg2=query.arg2
return query=void 0,arg2}if(AndExpr.isInstance(query))for(var i=0;i<query.args.length;i++){var q=query.args[i]
if(model.isInstance(q)&&q.arg1===prop)return query=query.clone(),query.args[i]=TRUE,query=query.partialEval(),query===TRUE&&(query=null),q.arg2}}return void 0},index=this,arg2=isExprMatch(GLOBAL.InExpr)
if(arg2&&Math.log(this.size(s))/Math.log(2)*arg2.length<this.size(s)){var keys=arg2,subPlans=[],results=[],cost=1,newOptions={}
query&&(newOptions.query=query),"limit"in options&&(newOptions.limit=options.limit),"skip"in options&&(newOptions.skip=options.skip),"order"in options&&(newOptions.order=options.order)
for(var i=0;i<keys.length;i++){var result=this.get(s,keys[i])
if(result){var subPlan=this.tail.plan(result,sink,newOptions)
cost+=subPlan.cost,subPlans.push(subPlan),results.push(result)}}return 0==subPlans.length?NOT_FOUND:{cost:1+cost,execute:function(s2,sink,options){for(var pars=[],i=0;i<subPlans.length;i++)pars.push(subPlans[i].execute(results[i],sink,newOptions))
return apar.apply(null,pars)},toString:function(){return"IN(key="+prop.name+", size="+results.length+")"}}}if(arg2=isExprMatch(GLOBAL.EqExpr),void 0!=arg2){var key=arg2.f(),result=this.get(s,key)
if(!result)return NOT_FOUND
var newOptions={}
query&&(newOptions.query=query),"limit"in options&&(newOptions.limit=options.limit),"skip"in options&&(newOptions.skip=options.skip),"order"in options&&(newOptions.order=options.order)
var subPlan=this.tail.plan(result,sink,newOptions)
return{cost:1+subPlan.cost,execute:function(s2,sink,options){return subPlan.execute(result,sink,newOptions)},toString:function(){return"lookup(key="+prop.name+", cost="+this.cost+(query&&query.toSQL?", query: "+query.toSQL():"")+") "+subPlan.toString()}}}if(arg2=isExprMatch(GLOBAL.GtExpr),void 0!=arg2){var key=arg2.f(),pos=this.findPos(s,key,!1),newOptions={skip:(options&&options.skip||0)+pos}
query&&(newOptions.query=query),"limit"in options&&(newOptions.limit=options.limit),"order"in options&&(newOptions.order=options.order),options=newOptions}if(arg2=isExprMatch(GLOBAL.GteExpr),void 0!=arg2){var key=arg2.f(),pos=this.findPos(s,key,!0),newOptions={skip:(options&&options.skip||0)+pos}
query&&(newOptions.query=query),"limit"in options&&(newOptions.limit=options.limit),"order"in options&&(newOptions.order=options.order),options=newOptions}if(arg2=isExprMatch(GLOBAL.LtExpr),void 0!=arg2){var key=arg2.f(),pos=this.findPos(s,key,!0),newOptions={limit:pos-(options&&options.skip)||0}
query&&(newOptions.query=query),"limit"in options&&(newOptions.limit=Math.min(options.limit,newOptions.limit)),"skip"in options&&(newOptions.skip=options.skip),"order"in options&&(newOptions.order=options.order),options=newOptions}if(arg2=isExprMatch(GLOBAL.LteExpr),void 0!=arg2){var key=arg2.f(),pos=this.findPos(s,key,!1),newOptions={limit:pos-(options&&options.skip)||0}
query&&(newOptions.query=query),"limit"in options&&(newOptions.limit=Math.min(options.limit,newOptions.limit)),"skip"in options&&(newOptions.skip=options.skip),"order"in options&&(newOptions.order=options.order),options=newOptions}var cost=this.size(s),sortRequired=!1,reverseSort=!1
return options&&options.order&&(options.order===prop||(GLOBAL.DescExpr&&DescExpr.isInstance(options.order)&&options.order.arg1===prop?reverseSort=!0:(sortRequired=!0,0!=cost&&(cost*=Math.log(cost)/Math.log(2))))),options&&!sortRequired&&(options.skip&&(cost-=options.skip),options.limit&&(cost=Math.min(cost,options.limit))),{cost:cost,execute:function(){if(sortRequired){var a=[]
index.selectCount++,index.select(s,a,{query:options.query}),index.selectCount--,a.sort(toCompare(options.order))
var skip=options.skip||0,limit=Number.isFinite(options.limit)?options.limit:a.length
limit+=skip,limit=Math.min(a.length,limit)
for(var i=skip;limit>i;i++)sink.put(a[i])}else index.selectCount++,reverseSort?index.selectReverse(s,sink,options):index.select(s,sink,options),index.selectCount--
return anop},toString:function(){return"scan(key="+prop.name+", cost="+this.cost+(query&&query.toSQL?", query: "+query.toSQL():"")+")"}}},toString:function(){return"TreeIndex("+this.prop.name+", "+this.tail+")"}},CITreeIndex={__proto__:TreeIndex,create:function(prop,tail){return tail=tail||ValueIndex,{__proto__:this,prop:prop,tail:tail}},put:function(s,newValue){return this.putKeyValue(s,this.prop.f(newValue).toLowerCase(),newValue)},remove:function(s,value){return this.removeKeyValue(s,this.prop.f(value).toLowerCase(),value)}},SetIndex={__proto__:TreeIndex,create:function(prop,tail){return tail=tail||ValueIndex,{__proto__:this,prop:prop,tail:tail}},dedup:function(obj,value){},put:function(s,newValue){var a=this.prop.f(newValue)
if(a.length)for(var i=0;i<a.length;i++)s=this.putKeyValue(s,a[i],newValue)
else s=this.putKeyValue(s,"",newValue)
return s},remove:function(s,value){var a=this.prop.f(value)
if(a.length)for(var i=0;i<a.length;i++)s=this.removeKeyValue(s,a[i],value)
else s=this.removeKeyValue(s,"",value)
return s}},PositionQuery={create:function(args){return{__proto__:this,skip:args.skip,limit:args.limit,s:args.s}},reduce:function(other){var otherFinish=other.skip+other.limit,myFinish=this.skip+this.limit
return other.skip>myFinish?null:other.skip>=this.skip?PositionQuery.create({skip:this.skip,limit:Math.max(myFinish,otherFinish)-this.skip,s:this.s}):other.reduce(this)},equals:function(other){return this.skip===other.skip&&this.limit===other.limit}},AutoPositionIndex={create:function(factory,mdao,networkdao,maxage){var obj={__proto__:this,factory:factory,maxage:maxage,dao:mdao,networkdao:networkdao,sets:[],alt:AltIndex.create()}
return obj},put:function(s,value){return this.alt.put(s,value)},remove:function(s,value){return this.alt.remove(s,value)},bulkLoad:function(a){return[]},addIndex:function(s,index){return this},addPosIndex:function(s,options){var index=PositionIndex.create(options&&options.order,options&&options.query,this.factory,this.dao,this.networkdao,this.queue,this.maxage)
this.alt.delegates.push(index),s.push(index.bulkLoad([]))},hasIndex:function(options){for(var i=0;i<this.sets.length;i++){var set=this.sets[i]
if(set[0].equals(options&&options.query||"")&&set[1].equals(options&&options.order||""))return!0}return!1},plan:function(s,sink,options){var subPlan=this.alt.plan(s,sink,options)
return subPlan!=NO_PLAN?subPlan:options&&null!=options.skip&&null!=options.limit||CountExpr.isInstance(sink)?this.hasIndex(options)?NO_PLAN:(this.sets.push([options&&options.query||"",options&&options.order||""]),this.addPosIndex(s,options),this.alt.plan(s,sink,options)):NO_PLAN}},PositionIndex={create:function(order,query,factory,dao,networkdao,queue,maxage){var obj={__proto__:this,order:order||"",query:query||"",factory:factory,dao:dao,networkdao:networkdao.where(query).orderBy(order),maxage:maxage,queue:arequestqueue(function(ret,request){var s=request.s
obj.networkdao.skip(request.skip).limit(request.limit).select()(function(objs){for(var now=Date.now(),i=0;i<objs.length;i++)s[request.skip+i]={obj:objs[i].id,timestamp:now},s.feedback=objs[i].id,obj.dao.put(objs[i]),s.feedback=null
ret()})},void 0,1)}
return obj},put:function(s,newValue){if(s.feedback===newValue.id)return s
if(this.query&&!this.query.f(newValue))return s
for(var compare=toCompare(this.order),i=0;i<s.length;i++){var entry=s[i]
if(entry){if(this.dao.find(entry.obj,{put:function(o){entry=o}}),entry.id===newValue.id)break
if(compare(entry,newValue)>0){for(var j=s.length;j>i;j--)s[j]=s[j-1];(0==i||s[i-1])&&(s[i]={obj:newValue.id,timestamp:Date.now()})
break}}}return s},remove:function(s,obj){if(s.feedback===obj.id)return s
for(var i=0;i<s.length;i++)if(s[i]&&s[i].obj===obj.id){for(var j=i;j<s.length-1;j++)s[j]=s[j+1]
break}return s},bulkLoad:function(a){return[]},plan:function(s,sink,options){var order=options&&options.order||"",query=options&&options.query||"",skip=options&&options.skip,limit=options&&options.limit,self=this
if(!order.equals(this.order)||!query.equals(this.query))return NO_PLAN
if(CountExpr.isInstance(sink))return{cost:0,execute:function(s,sink,options){return s.count||(s.count=amemo(function(ret){self.networkdao.select(COUNT())(function(c){ret(c)})},self.maxage)),function(ret,count){sink.copyFrom(count),ret()}.ao(s.count)},toString:function(){return"position-index(cost="+this.cost+", count)"}}
if(void 0==skip||void 0==limit)return NO_PLAN
var threshold=Date.now()-this.maxage
return{cost:0,toString:function(){return"position-index(cost="+this.cost+")"},execute:function(s,sink,options){for(var objs=[],min,max,i=0;limit>i;i++){var o=s[i+skip];(!o||o.timestamp<threshold)&&(void 0==min&&(min=i+skip),max=i+skip),o?self.dao.find(o.obj,{put:function(obj){objs[i]=obj}}):objs[i]=self.factory(),!objs[i]}void 0!=min&&self.queue(PositionQuery.create({skip:min,limit:max-min+1,s:s}))
for(var i=0;i<objs.length;i++)sink.put(objs[i])
return anop}}}},AltIndex={GOOD_ENOUGH_PLAN:10,create:function(){return{__proto__:this,delegates:argsToArray(arguments)}},addIndex:function(s,index){var a=[].sink
return this.plan(s,a).execute(s,a),s.push(index.bulkLoad(a)),this.delegates.push(index),this},bulkLoad:function(a){for(var i=0;i<this.delegates.length;i++)this.root[i]=this.delegates[i].bulkLoad(a)},get:function(s,key){return this.delegates[0].get(s[0],key)},put:function(s,newValue){s=s||[].sink
for(var i=0;i<this.delegates.length;i++)s[i]=this.delegates[i].put(s[i],newValue)
return s},remove:function(s,obj){s=s||[].sink
for(var i=0;i<this.delegates.length;i++)s[i]=this.delegates[i].remove(s[i],obj)
return s},plan:function(s,sink,options){for(var bestPlan,bestPlanI=0,i=0;i<this.delegates.length;i++){var plan=this.delegates[i].plan(s[i],sink,options)
if(plan.cost<=AltIndex.GOOD_ENOUGH_PLAN){bestPlanI=i,bestPlan=plan
break}(!bestPlan||plan.cost<bestPlan.cost)&&(bestPlanI=i,bestPlan=plan)}return void 0==bestPlan||bestPlan==NO_PLAN?NO_PLAN:{__proto__:bestPlan,execute:function(unused,sink,options){return bestPlan.execute(s[bestPlanI],sink,options)}}},size:function(obj){return this.delegates[0].size(obj[0])},toString:function(){return"Alt("+this.delegates.join(",")+")"}},mLangIndex={create:function(mlang){return{__proto__:this,mlang:mlang,PLAN:{cost:0,execute:function(s,sink,options){return sink.copyFrom(s),anop},toString:function(){return"mLangIndex("+this.s+")"}}}},bulkLoad:function(a){return a.select(this.mlang),this.mlang},put:function(s,newValue){return s=s||this.mlang.clone(),s.put(newValue),s},remove:function(s,obj){return s=s||this.mlang.clone(),s.remove&&s.remove(obj),s},size:function(s){return Number.MAX_VALUE},plan:function(s,sink,options){return options&&options.query?NO_PLAN:sink.model_&&sink.model_.isInstance(s)&&s.arg1===sink.arg1?(this.PLAN.s=s,this.PLAN):NO_PLAN},toString:function(){return"mLangIndex("+this.mlang+")"}},AutoIndex={create:function(mdao){return{__proto__:this,properties:{id:!0},mdao:mdao}},put:function(s,newValue){return s},remove:function(s,obj){return s},bulkLoad:function(a){return"auto"},addIndex:function(prop){GLOBAL.DescExpr&&DescExpr.isInstance(prop)&&(prop=prop.arg1),console.log("Adding AutoIndex : ",prop.name),this.properties[prop.name]=!0,this.mdao.addIndex(prop)},plan:function(s,sink,options){return options&&(options.order&&Property.isInstance(options.order)&&!this.properties[options.order.name]?this.addIndex(options.order):options.query),NO_PLAN},toString:function(){return"AutoIndex()"}},MDAO=Model.create({extendsModel:"AbstractDAO",name:"MDAO",label:"Indexed DAO",properties:[{name:"model",type:"Model",required:!0},{model_:"BooleanProperty",name:"autoIndex",defaultValue:!1}],methods:{init:function(){this.SUPER(),this.map={},this.index=TreeIndex.create(this.model.getProperty(this.model.ids[0])),this.autoIndex&&this.addRawIndex(AutoIndex.create(this))},addIndex:function(){for(var props=argsToArray(arguments),i=0;i<this.model.ids.length;i++)if(props.push(this.model.getProperty(this.model.ids[i])),!props[props.length-1])throw"Undefined index property"
return this.addUniqueIndex.apply(this,props)},addUniqueIndex:function(){for(var index=ValueIndex,i=arguments.length-1;i>=0;i--){var prop=arguments[i],proto="Array[]"==prop.type?SetIndex:TreeIndex
index=proto.create(prop,index)}return this.addRawIndex(index)},addRawIndex:function(index){return this.index.delegates||(this.index=AltIndex.create(this.index),this.root=[this.root]),this.index.addIndex(this.root,index),this},bulkLoad:function(dao,sink){var self=this
dao.select({__proto__:[].sink,eof:function(){self.root=self.index.bulkLoad(this),sink&&sink.eof&&sink.eof()}})},put:function(obj,sink){var oldValue=this.map[obj.id]
oldValue?(this.root=this.index.put(this.index.remove(this.root,oldValue),obj),this.notify_("remove",[oldValue])):this.root=this.index.put(this.root,obj),this.map[obj.id]=obj,this.notify_("put",[obj]),sink&&sink.put&&sink.put(obj)},findObj_:function(key,sink){var obj=this.map[key]
obj?sink.put&&sink.put(obj):sink.error&&sink.error("find",key)},find:function(key,sink){if(void 0==key)return void(sink&&sink.error&&sink.error("missing key"))
if(!key.f)return void this.findObj_(key,sink)
var found=!1
this.where(key).limit(1).select({put:function(obj){found=!0,sink&&sink.put&&sink.put(obj)},eof:function(){found||sink&&sink.error&&sink.error("find",key)}})},remove:function(obj,sink){if(!obj)return void(sink&&sink.error&&sink.error("missing key"))
var id=void 0!==obj.id&&""!==obj.id?obj.id:obj,self=this
this.find(id,{put:function(obj){self.root=self.index.remove(self.root,obj),delete self.map[obj.id],self.notify_("remove",[obj]),sink&&sink.remove&&sink.remove(obj)},error:function(){sink&&sink.error&&sink.error("remove",obj)}})},removeAll:function(sink,options){options||(options={}),options.query||(options.query=TRUE)
var future=afuture()
return this.where(options.query).select()(function(a){for(var i=0;i<a.length;i++)this.root=this.index.remove(this.root,a[i]),delete this.map[a[i].id],this.notify_("remove",[a[i]]),sink&&sink.remove&&sink.remove(a[i])
sink&&sink.eof&&sink.eof(),future.set(sink)}.bind(this)),future.get},select:function(sink,options){if(sink=sink||[].sink,options&&(options={__proto__:options}),GLOBAL.ExplainExpr&&GLOBAL.ExplainExpr.isInstance(sink)){var plan=this.index.plan(this.root,sink.arg1,options)
return sink.plan="cost: "+plan.cost+", "+plan.toString(),sink&&sink.eof&&sink.eof(),aconstant(sink)}var plan=this.index.plan(this.root,sink,options),future=afuture()
return plan.execute(this.root,sink,options)(function(ret){sink&&sink.eof&&sink.eof(),future.set(sink)}),future.get},toString:function(){return"MDAO("+this.model.name+","+this.index+")"}}})
CLASS({name:"Binding",documentation:function(){},properties:[{name:"id",hidden:!0},{name:"value",hidden:!0},{name:"version",defaultValue:1,hidden:!0}]}),CLASS({name:"PersistentContext",documentation:function(){},properties:[{name:"dao",label:"DAO",type:"DAO",hidden:!0},{name:"context",hidden:!0},{name:"predicate",type:"Expr",defaultValueFn:function(){return TRUE},hidden:!0}],methods:{manage:function(name,obj,version){var write=EventService.merged(function(){console.log("PersistentContext","updating",name),this.dao.put(this.Y.Binding.create({id:name,value:JSONUtil.where(this.predicate).stringify(obj),version:version}))}.bind(this),void 0,this.Y)
obj.addListener(write),write()},bindObjects:function(a){},clearBinding:function(ret,name){var self=this
self.dao.remove.ao(self.dao.find.bind(self.dao,name))(ret)},bindObject:function(name,factory,transientValues,version){version=version||1,console.log("PersistentContext","binding",name)
var future=afuture()
if(transientValues=transientValues||{},this.context[name])future.set(this.context[name])
else{var newinit=function(){console.log("PersistentContext","newInit",name)
var obj=factory.create()
obj.copyFrom(transientValues),this.context[name]=obj,this.manage(name,obj,version),future.set(obj)}.bind(this)
this.dao.find(name,{put:function(binding){if(binding.version!==version)return console.log("PersistentContext","verison mismatch",name),void newinit()
console.log("PersistentContext","existingInit",name)
try{var json=JSON.parse(binding.value),obj=JSONUtil.mapToObj(this.Y,json)
obj.copyFrom(transientValues),this.context[name]=obj,this.manage(name,obj,version),future.set(obj)}catch(e){console.log("PersistentContext","existingInit serialization error",name),newinit()}}.bind(this),error:newinit})}return future.get}}}),CLASS({name:"UserInfo",label:"UserInfo",properties:[{model_:"StringProperty",name:"email"}]}),arequire=function(modelName,opt_X){var X=opt_X||GLOBAL.X
return function(ret){var m=X.lookup(modelName)
ret(m)}},CLASS({"package":"foam.apps.ctm",name:"TaskManager",requires:["Binding","PersistentContext","foam.apps.ctm.Task","foam.apps.ctm.TaskController","foam.apps.ctm.TaskHistoriesView","foam.apps.ctm.TaskHistoryGraph","foam.apps.ctm.TaskManagerContext","foam.apps.ctm.TaskManagerDetailView","foam.dao.EasyDAO","foam.dao.IDBDAO","foam.ui.md.ActionLabel","foam.ui.md.SharedStyles","foam.ui.md.TableView"],exports:["clock$","hardSelection$","softSelection$","tasks"],properties:[{model_:"BooleanProperty",name:"clock"},{name:"persistentContext","transient":!0,lazyFactory:function(){return this.PersistentContext.create({dao:this.IDBDAO.create({model:this.Binding}),predicate:NOT_TRANSIENT,context:this})}},{name:"ctx",type:"foam.apps.ctm.TaskManagerContext","transient":!0,defaultValue:null,postSet:function(old,nu){old!==nu&&(old&&Events.unlink(old.tableColumns$,this.tableColumns$),nu&&Events.link(nu.tableColumns$,this.tableColumns$))}},{model_:"StringArrayProperty",name:"tableColumns",lazyFactory:function(){return this.Task.tableProperties}},{name:"queryParser",factory:function(){return QueryParserFactory(this.Task,!0)}},{model_:"StringProperty",name:"search","transient":!0,view:{factory_:"foam.ui.TextFieldView",placeholder:"Search",onKeyMode:!0}},{name:"hardSelection","transient":!0,defaultValue:null,postSet:function(old,nu){if(old!==nu&&nu){var controller=this.getController(nu.id)
this.memory=controller.memory.history,this.cpu=controller.cpu.history,this.network=controller.network.history}}},{name:"softSelection","transient":!0,defaultValue:null},{model_:"ArrayProperty",name:"memory","transient":!0,view:"foam.apps.ctm.TaskHistoryGraph"},{model_:"ArrayProperty",name:"cpu","transient":!0,view:"foam.apps.ctm.TaskHistoryGraph"},{model_:"ArrayProperty",name:"network","transient":!0,view:"foam.apps.ctm.TaskHistoryGraph"},{model_:"foam.core.types.DAOProperty",name:"tasks","transient":!0,lazyFactory:function(){return this.EasyDAO.create({daoType:"MDAO",model:"foam.apps.ctm.Task"})}},{model_:"foam.core.types.DAOProperty",name:"filteredTasks",view:{factory_:"foam.ui.md.TableView",scrollEnabled:!0},onDAOUpdate:function(){this.updateFilteredCount()}},{model_:"IntProperty",name:"filteredCount"},{name:"taskControllers_","transient":!0,factory:function(){return{}}}],methods:[function init(){this.SUPER.apply(this,arguments),this.X.registerModel(this.TaskManagerDetailView,"foam.ui.TaskManagerDetailView"),this.X.registerModel(this.ActionLabel.xbind({extraClassName:"material-icons"}),"foam.ui.ActionButton"),this.persistentContext.bindObject("ctx",this.TaskManagerContext,void 0,1),Events.dynamic(function(){this.search,this.tasks}.bind(this),function(){this.filteredTasks=this.tasks.where(this.search?this.queryParser.parseString(this.search)||TRUE:TRUE)}.bind(this))
for(var dao=this.filteredTasks,i=0;50>i;++i){var controller=this.TaskController.create()
this.taskControllers_[controller.task.id]=controller,dao.put(controller.task)}this.SharedStyles.create(),this.tick()},function getController(id){return this.taskControllers_[id]||null}],listeners:[{name:"tick",code:function(){this.clock=!this.clock,this.tick()},isMerged:2e3},{name:"updateFilteredCount",code:function(){this.filteredTasks.select(COUNT())(this.updateFilteredCount_)},isFramed:!0},{name:"updateFilteredCount_",code:function(c){this.filteredCount=c.count},isFramed:!0}]}),CLASS({"package":"foam.apps.ctm",name:"Task",requires:["foam.graphics.HTMLGraph"],tableProperties:["name","memory","cpu","network","processId"],properties:[{model_:"IntProperty",name:"id",hidden:!0},{model_:"StringProperty",name:"iconUrl",label:"",hidden:!0,defaultValue:"https://www.gstatic.com/images/icons/material/product/1x/chrome_16dp.png",view:"foam.ui.ImageView"},{model_:"StringProperty",name:"name",label:"Task",aliases:["t","task"],tableFormatter:function(name,obj){return'<img src="'+obj.iconUrl+'"><span>'+name+"</span>"}},{model_:"FloatProperty",name:"memory",aliases:["m","mem","mb"],units:"MB",tableFormatter:function(v,obj){return Math.round(100*v)/100+this.units}},{model_:"FloatProperty",name:"cpu",label:"CPU",aliases:["c"],units:"%",tableFormatter:function(v,obj){return Math.round(100*v)/100+this.units}},{model_:"FloatProperty",name:"network",aliases:["n","net","b","bandwidth"],units:"B/s",tableFormatter:function(v,obj){return Math.round(100*v)/100+this.units}},{model_:"IntProperty",name:"processId",label:"Process ID",aliases:["p","pid","procid"]}],actions:[{name:"open",label:"open_in_browser",action:function(){console.log("Open process",this.id)}},{name:"kill",label:"delete",action:function(){console.log("Kill process",this.id)}}]}),CLASS({"package":"foam.graphics",name:"HTMLGraph",extendsModel:"foam.ui.SimpleView",properties:[{model_:"ColorProperty",name:"graphColor",defaultValue:"green"},{model_:"ColorProperty",name:"backgroundColor",defaultValue:"transparent"},{model_:"ArrayProperty",name:"data",lazyFactory:function(){return[]},preSet:function(old,nu){return old===nu?nu:nu.length>this.width?nu.slice(-this.width):nu}},{model_:"IntProperty",name:"width",defaultValue:40},{model_:"IntProperty",name:"height",defaultValue:15},{model_:"FloatProperty",name:"min",defaultValueFn:function(){if(0===this.data.length)return 0
for(var min=Number.INFINITY,i=0;i<this.data.length;++i)min=Math.min(min,this.data[i])
return Number.isNaN(min)?0:min}},{model_:"FloatProperty",name:"max",defaultValueFn:function(){if(0===this.data.length)return 100
for(var max=Number.NEGATIVE_INFINITY,i=0;i<this.data.length;++i)max=Math.max(max,this.data[i])
return Number.isNaN(max)?100:max}}],methods:[function addData(value,opt_maxNumValues){var maxNumValues=opt_maxNumValues||this.width
this.data.length===maxNumValues&&this.data.shift(),this.data.push(value)}],templates:[{name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,out=opt_out?opt_out:TOC(this)
out('\n      <graph id="',self.id,'">\n        ')
for(var i=0;i<this.data.length;++i){var rowWidth=Math.round(1e4/this.data.length)/100,dataHeight=Math.min(100,Math.round(1e4*(this.data[i]-this.min)/this.max)/100),bgHeight=100-dataHeight
out('\n          <graph-row style="width: ',escapeHTML(rowWidth),'%">\n            <graph-row-bg style="background: ',escapeHTML(this.backgroundColor),"; flex-grow: ",escapeHTML(bgHeight),'"></graph-row-bg>\n            <graph-row-data style="background: ',escapeHTML(this.graphColor),"; flex-grow: ",escapeHTML(dataHeight),'"></graph-row-data>\n          </graph-row>\n        ')}return out("\n      </graph>\n    "),out.toString()}},{name:"CSS",code:ConstantTemplate("\ngraph {\nflex-grow: 1;\ndisplay: flex;\nalign-items: stretch;\nalign-content: stretch;\n}\ngraph-row {\ndisplay: flex;\nflex-direction: column;\nalign-items: stretch;\nalign-content: stretch;\n}\ngraph-row-bg {\ndisplay: block;\nflex-grow: 1;\n}\ngraph-row-data {\ndisplay: block;\nmin-height: 1px;\n}\n")}]}),CLASS({"package":"foam.ui",name:"SimpleView",extendsModel:"foam.ui.BaseView",traits:["foam.ui.HTMLViewTrait"],requires:["Property"],exports:["propertyViewProperty"],properties:[{name:"propertyViewProperty",type:"Property",defaultValueFn:function(){return this.Property.DETAIL_VIEW}}]}),CLASS({"package":"foam.ui",name:"HTMLViewTrait",label:"HTMLView",requires:["foam.input.touch.GestureTarget","foam.ui.ActionBorder","foam.ui.PropertyView","foam.ui.AsyncLoadingView"],properties:[{name:"id",label:"Element ID",type:"String",factory:function(){return this.instance_.id||this.nextID()}},{model_:"foam.core.types.DocumentInstallProperty",name:"installCSS",documentInstallFn:function(X){for(var i=0;i<this.model_.templates.length;i++){var t=this.model_.templates[i]
if("CSS"===t.name)return void t.futureTemplate(function(){X.addStyle(this.CSS())}.bind(this))}}},{name:"shortcuts",type:"Array[Shortcut]",factory:function(){return[]}},{name:"$",mode:"read-only",hidden:!0,getter:function(){return this.X.document.getElementById(this.id)},setter:function(){},help:"DOM Element."},{name:"tagName",defaultValue:"span"},{name:"className",defaultValue:"",help:"CSS class name(s), space separated."},{name:"tooltip"},{name:"tabIndex"},{name:"extraClassName",defaultValue:""},{name:"propertyViewProperty",type:"Property",defaultValueFn:function(){return this.X.Property.VIEW}},{name:"initializers_",factory:function(){return[]}},{name:"destructors_",factory:function(){return[]}},{model_:"BooleanProperty",name:"showActions",postSet:function(oldValue,showActions){!oldValue&&showActions&&this.addDecorator(this.ActionBorder.create())},defaultValue:!1},{name:"minWidth",defaultValue:300},{name:"minHeight",defaultValue:40},{name:"preferredWidth",defaultValue:400},{name:"preferredHeight",defaultValue:40},{name:"maxWidth",defaultValue:1e4},{name:"maxHeight",defaultValue:40}],constants:[{name:"KEYPRESS_CODES",value:{8:!0,33:!0,34:!0,37:!0,38:!0,39:!0,40:!0}},{name:"ON_HIDE",value:["onHide"]},{name:"ON_SHOW",value:["onShow"]}],methods:[function strToHTML(str){return XMLUtil.escape(str.toString())},function cssClassAttr(){if(!this.className&&!this.extraClassName)return""
var s=' class="'
return this.className&&(s+=this.className,this.extraClassName&&(s+=" ")),this.extraClassName&&(s+=this.extraClassName),s+'"'},function bindSubView(view,prop){view.setValue(this.propertyValue(prop.name))},function focus(){this.$&&this.$.focus&&this.$.focus()},function addChild(child){return child.toView_&&(child=child.toView_()),-1==this.children.indexOf(child)?this.SUPER(child):void 0},function addShortcut(key,callback,context){this.shortcuts.push([key,callback,context])},function nextID(){return"view"+(arguments.callee._nextId=(arguments.callee._nextId||0)+1)},function addInitializer(f){this.initializers_.push(f)},function addDestructor(f){this.destructors_.push(f)},function tapClick(){},function resize(){var e=this.X.document.createEvent("Event")
e.initEvent("resize",!0,!0),this.$&&this.X.window.getComputedStyle(this.$),this.X.window.dispatchEvent(e)},function on(event,listener,opt_id){if(opt_id=opt_id||this.nextID(),listener=listener.bind(this),"click"===event&&this.X.gestureManager){var self=this,manager=this.X.gestureManager,target=this.GestureTarget.create({containerID:opt_id,handler:{tapClick:function(pointMap){return listener({preventDefault:function(){},stopPropagation:function(){},pointMap:pointMap})}},gesture:"tap"})
return manager.install(target),this.addDestructor(function(){manager.uninstall(target)}),opt_id}return this.addInitializer(function(){var e=this.X.$(opt_id)
e&&e.addEventListener(event,listener,!1)}.bind(this)),opt_id},function setAttribute(attributeName,valueFn,opt_id){opt_id=opt_id||this.nextID(),valueFn=valueFn.bind(this),this.addInitializer(function(){this.X.dynamic(valueFn,function(){var e=this.X.$(opt_id)
if(!e)throw EventService.UNSUBSCRIBE_EXCEPTION
var newValue=valueFn(e.getAttribute(attributeName))
void 0==newValue?e.removeAttribute(attributeName):e.setAttribute(attributeName,newValue)}.bind(this))}.bind(this))},function setClass(className,predicate,opt_id){return opt_id=opt_id||this.nextID(),predicate=predicate.bind(this),this.addInitializer(function(){this.addDestructor(this.X.dynamic(predicate,function(){var e=this.X.$(opt_id)
if(!e)throw EventService.UNSUBSCRIBE_EXCEPTION
DOM.setClass(e,className,predicate())}.bind(this)).destroy)}.bind(this)),opt_id},function setClasses(map,opt_id){opt_id=opt_id||this.nextID()
for(var keys=Objects.keys(map),i=0;i<keys.length;i++)this.setClass(keys[i],map[keys[i]],opt_id)
return opt_id},function insertInElement(name){var e=this.X.$(name)
e.innerHTML=this.toHTML(),this.initHTML()},function write(document){var html=this.toHTML()
document.body.insertAdjacentHTML("beforeend",html),this.initHTML()},function updateHTML(){this.$&&(this.destroy(),this.construct())},function construct(){this.SUPER(),this.generateContent()},function generateContent(){this.$&&(this.$.innerHTML=this.toInnerHTML(),this.initInnerHTML())},function toInnerHTML(){return""},function toHTML(){return this.invokeDestructors(),"<"+this.tagName+' id="'+this.id+'"'+this.cssClassAttr()+">"+this.toInnerHTML()+"</"+this.tagName+">"},function initHTML(){this.initInnerHTML(),this.initKeyboardShortcuts(),this.maybeInitTooltip()},function maybeInitTooltip(){this.tooltip&&this.$&&(this.$.addEventListener("mouseenter",this.openTooltip),this.$.addEventListener("mouseleave",this.closeTooltip))},function initInnerHTML(){this.invokeInitializers(),this.initChildren()},function initChildren(){if(this.children)for(var i=0;i<this.children.length;i++)try{this.children[i].initHTML&&this.children[i].initHTML()}catch(x){console.log("Error on View.child.initHTML",x,x.stack)}},function invokeInitializers(){for(var i=0;i<this.initializers_.length;i++)this.initializers_[i]()
this.initializers_=[]},function invokeDestructors(){for(var i=0;i<this.destructors_.length;i++)this.destructors_[i]()
this.destructors_=[]},function evtToCharCode(evt){var s=""
return evt.altKey&&(s+="alt-"),evt.ctrlKey&&(s+="ctrl-"),evt.shiftKey&&"keydown"===evt.type&&(s+="shift-"),evt.metaKey&&(s+="meta-"),s+=String.fromCharCode("keydown"===evt.type?evt.which:evt.charCode)},function initKeyboardShortcuts(){function init(actions,opt_value){actions.forEach(function(action){for(var j=0;j<action.keyboardShortcuts.length;j++){var key=action.keyboardShortcuts[j]
"number"==typeof key&&(key=String.fromCharCode(key)),keyMap[key]=opt_value?function(){action.maybeCall(self.X,opt_value.get())}:action.maybeCall.bind(action,self.X,self),found=!0}})}var keyMap={},found=!1,self=this
init(this.model_.actions),this.data&&this.data.model_&&this.data.model_.actions.length&&init(this.data.model_.actions,this.data$),found&&(console.assert(this.$,"View must define outer id when using keyboard shortcuts: "+this.name_),this.keyMap_=keyMap,this.$.parentElement.addEventListener("keydown",this.onKeyboardShortcut),this.$.parentElement.addEventListener("keypress",this.onKeyboardShortcut))},function destroy(isParentDestroyed){this.invokeDestructors(),this.SUPER(isParentDestroyed),delete this.instance_.$},function close(){this.$&&this.$.remove(),this.destroy(),this.publish("closed")},function rectOnPage(){for(var node=this.$,x=0,y=0,parent,rect=this.$.getBoundingClientRect();node;)parent=node,x+=node.offsetLeft,y+=node.offsetTop,node=node.offsetParent
return{top:y,left:x,right:x+rect.width,bottom:y+rect.height,width:rect.width,height:rect.height}},function rectOnViewport(){return this.$.getBoundingClientRect()},function viewportOnPage(){var bodyRect=this.X.document.documentElement.getBoundingClientRect(),vpSize=this.viewportSize()
return{left:-bodyRect.left,top:-bodyRect.top,width:vpSize.width,height:vpSize.height,right:-bodyRect.left+vpSize.width,bottom:-bodyRect.top+vpSize.height}},function viewportSize(){return{height:window.innerHeight||this.X.document.documentElement.clientHeight,width:window.innerWidth||this.X.document.documentElement.clientWidth}},function createView(prop,opt_args){var X=opt_args&&opt_args.X||this.Y,v=this.PropertyView.create({id:(this.nextID?this.nextID():this.id)+"PROP",prop:prop,copyFrom:opt_args},X)
return this[prop.name+"View"]=v.view,v},function removeChild(child){this.PropertyView.isInstance(child)&&child.prop&&delete this[child.prop.name+"View"],this.SUPER(child)},function createRelationshipView(r,opt_args){if(opt_args.model_)return this.createView(r,opt_args)
var X=opt_args&&opt_args.X||this.Y,v=this.AsyncLoadingView.create({id:this.nextID(),name:r.name,model:"foam.ui.RelationshipView",args:{relationship:r},copyFrom:opt_args},X)
return v.view&&(v=v.view),this[r.name+"View"]=v,v},function createActionView(action,opt_args){var X=opt_args&&opt_args.X||this.Y,modelName=opt_args&&opt_args.model_?opt_args.model_:"foam.ui.ActionButton",v=this.AsyncLoadingView.create({id:this.nextID(),name:action.name,model:modelName,args:{action:action},copyFrom:opt_args},X)
return v.view&&(v=v.view),this[action.name+"View"]=v,v},function createTemplateView(name,opt_args){var args=opt_args||{},X=this.Y,myData=this.data$
if(myData&&myData.value&&myData.value.model_){var o=myData.value.model_.getFeature(name)
if(o){var v
return v=Action.isInstance(o)?this.createActionView(o,args):Relationship.isInstance(o)?this.createRelationshipView(o,args):this.createView(o,args),this.addDataChild(v),v}}var o=this.model_.getFeature(name)
if(!o)throw"Unknown View Name: "+name
var v
return v=Action.isInstance(o)?this.createActionView(o,args):Relationship.isInstance(o)?this.createRelationshipView(o,args):this.createView(o,args),this.addSelfDataChild(v),v},function dynamicTag(tagName,f){var id=this.nextID()
return this.addInitializer(function(){this.X.dynamic(function(){var html=f(),e=this.X.$(id)
e&&(e.innerHTML=html)}.bind(this))}.bind(this)),"<"+tagName+' id="'+id+'"></'+tagName+">"}],listeners:[{name:"openTooltip",code:function(e){console.assert(!this.tooltip_,"Tooltip already defined"),arequire("foam.ui.Tooltip")(function(Tooltip){this.tooltip_=Tooltip.create({text:this.tooltip,target:this.$},this.Y)}.bind(this))}},{name:"closeTooltip",code:function(e){this.tooltip_&&(this.tooltip_.close(),this.tooltip_=null)}},{name:"onKeyboardShortcut",code:function(evt){if("keydown"!==evt.type||this.KEYPRESS_CODES[evt.which]){var action=this.keyMap_[this.evtToCharCode(evt)]
action&&(action(),evt.preventDefault(),evt.stopPropagation())}}}]}),CLASS({"package":"foam.input.touch",name:"GestureTarget",properties:[{name:"id"},{name:"gesture",help:"The name of the gesture to be tracked."},{name:"containerID",help:"The containing DOM node's ID. Used for checking what inputs are within which gesture targets."},{name:"getElement",defaultValue:function(){return this.X.$(this.containerID)},help:"Function to retrieve the element this gesture is attached to. Defaults to $(containerID)."},{name:"handler",help:"The target for the gesture's events, after it has been recognized."}],help:"Created by each view that wants to receive gestures."}),CLASS({"package":"foam.ui",name:"ActionBorder",methods:[function toHTML(border,delegate,args){var str=""
str+=delegate.apply(this,args),str+='<div class="actionToolbar">'
for(var actions=this.model_.actions,i=0;i<actions.length;i++){var v=this.createActionView(actions[i])
this.addSelfDataChild(v),str+=" "+v.toView_().toHTML()+" "}if(this.X.lookup("foam.ui.DetailView").isInstance(this)){actions=this.model.actions
for(var i=0;i<actions.length;i++){var v=this.createActionView(actions[i])
this.addDataChild(v),str+=" "+v.toView_().toHTML()+" "}}return str+="</div>"}]}),CLASS({"package":"foam.ui",name:"PropertyView",extendsModel:"foam.ui.AsyncLoadingView",properties:[{name:"prop",type:"Property",postSet:function(old,nu){old&&this.bound_&&this.unbindData(this.data),nu&&!this.bound_&&this.bindData(this.data),this.args=nu,this.model=this.innerView||nu.view}},{name:"data",postSet:function(old,nu){old&&this.bound_&&this.unbindData(old),nu&&this.bindData(nu)}},{name:"childData"},{name:"innerView",postSet:function(old,nu){this.model=nu},help:"Override for prop.view"},{name:"view",type:"foam.ui.View",adapt:function(_,v){return v&&v.toView_?v.toView_():v}},{model_:"BooleanProperty",name:"bound_",defaultValue:!1},{name:"parent",type:"foam.ui.View",postSet:function(_,p){p&&(p[this.prop.name+"View"]=this.view,this.view&&(this.view.parent=p))}}],methods:[function unbindData(oldData){if(this.bound_&&oldData&&this.prop){var pValue=oldData.propertyValue(this.prop.name)
Events.unlink(pValue,this.childData$),this.bound_=!1}},function bindData(data){if(!this.bound_&&data&&this.prop){var pValue=data.propertyValue(this.prop.name)
Events.link(pValue,this.childData$),this.bound_=!0}},function toString(){return"PropertyView("+this.prop.name+", "+this.view+")"},function destroy(isParentDestroyed){this.unbindData(this.data),this.SUPER(isParentDestroyed)},function construct(){this.bindData(this.data),this.SUPER()},function finishRender(view){this.SUPER(view),this.view.prop=this.prop},function addDataChild(child){Events.link(this.childData$,child.data$),this.addChild(child)}]}),CLASS({"package":"foam.ui",name:"AsyncLoadingView",extendsModel:"foam.ui.BaseView",requires:["Model"],properties:[{name:"id",label:"Element ID",type:"String"},{name:"name",label:"The parent view's name for this"},{name:"model",label:"View model name, model definition, or JSON with a factory_ specified."},{name:"args",label:"View construction arguments",defaultValueFn:function(){return{}}},{name:"copyFrom",label:"Additional arguments to this.copyFrom(...) when ready.",lazyFactory:function(){return{}}},{name:"view",type:"foam.ui.View"}],methods:[function init(){this.SUPER(),this.construct()},function mergeWithCopyFrom(other){for(var key in other)"factory_"!=key&&(this.copyFrom[key]=other[key])},function construct(){var skipKeysArgDecorator={__proto__:this.args,__SKD_SKIP_KEYS:{factory_:!0,model_:!0,view:!0},hasOwnProperty:function(name){return this.__SKD_SKIP_KEYS[name]?!1:this.__proto__.hasOwnProperty(name)}}
if(this.copyFrom&&this.copyFrom.model&&(skipKeysArgDecorator.model=this.copyFrom.model),this.copyFrom&&this.copyFrom.model_){if("string"==typeof this.copyFrom.model_)return this.requireModelName(this.copyFrom.model_,skipKeysArgDecorator)
if(this.Model.isInstance(this.copyFrom.model_))return this.finishRender(this.copyFrom.model_.create(skipKeysArgDecorator,this.X))}return"string"==typeof this.model?this.requireModelName(this.model,skipKeysArgDecorator):this.model.model_&&"string"==typeof this.model.model_?this.requireViewInstance(FOAM(this.model)):this.model.model_?this.Model.isInstance(this.model)?this.finishRender(this.model.create(skipKeysArgDecorator,this.X)):(this.mergeWithCopyFrom(this.model),this.finishRender(this.model.model_.create(skipKeysArgDecorator,this.X))):this.model.factory_?(this.mergeWithCopyFrom(this.model),this.requireModelName(this.model.factory_,skipKeysArgDecorator)):"function"==typeof this.model?this.finishRender(this.model(skipKeysArgDecorator,this.X)):void console.warn("AsyncLoadingView: View load with invalid model. ",this.model,this.args,this.copyFrom)},function requireViewInstance(view){view.arequire(this.X)(function(m){this.finishRender(view)}.bind(this))},function requireModelName(name,args){arequire(name,this.X)(function(m){this.finishRender(m.create(args,this.X))}.bind(this))},function finishRender(view){if(this.copyFrom){var skipKeysCopyFromDecorator={__proto__:this.copyFrom,__SKD_SKIP_KEYS:{factory_:!0,model_:!0,view:!0},hasOwnProperty:function(name){return this.__SKD_SKIP_KEYS[name]?!1:this.__proto__.hasOwnProperty(name)}}
view.copyFrom(skipKeysCopyFromDecorator)}this.view=view.toView_(),this.addDataChild(this.view)
var el=this.X.$(this.id)
el&&(el.outerHTML=this.toHTML(),this.initHTML())},function toHTML(){return this.view?this.view.toHTML():'<div id="'+this.id+'"></div>'},function initHTML(){this.view&&this.view.initHTML()},function toString(){return"AsyncLoadingView("+this.model+", "+this.view+")"},function fromElement(e){return this.view.fromElement(e),this}]}),CLASS({"package":"foam.ui",name:"BaseView",extendsModel:"foam.patterns.ChildTreeTrait",properties:[{name:"data"}],methods:[function addDataChild(child){Events.link(this.data$,child.data$),this.addChild(child)},function addSelfDataChild(child){child.data=this,this.addChild(child)},function toView_(){return this}]}),CLASS({"package":"foam.patterns",name:"ChildTreeTrait",properties:[{name:"parent",type:"foam.patterns.ChildTreeTrait",hidden:!0},{name:"children",type:"Array[foam.patterns.ChildTreeTrait]",factory:function(){return[]}}],methods:[function onAncestryChange_(){Array.prototype.forEach.call(this.children,function(c){c.onAncestryChange_&&c.onAncestryChange_()})},function addChild(child){if(child.parent!==this){child.parent=this,child.onAncestryChange_&&child.onAncestryChange_()
var children=this.children
return children.push(child),this.children=children,this}},function removeChild(child){return child.destroy&&child.destroy(!0),this.children.deleteI(child),child.parent=void 0,this},function removeAllChildren(isParentDestroyed){var list=this.children
this.children=[],Array.prototype.forEach.call(list,function(child){this.removeChild(child)}.bind(this))},function addChildren(){for(var i=0;i<arguments.length;++i)this.addChild(arguments[i])
return this},function destroy(isParentDestroyed){return isParentDestroyed?Array.prototype.forEach.call(this.children,function(child){child.destroy&&child.destroy(!0)}):this.removeAllChildren(),this},function construct(){return this},function deepPublish(topic){var count=this.publish.apply(this,arguments)
if(this.children)for(var i=0;i<this.children.length;i++){var child=this.children[i]
count+=child.deepPublish.apply(child,arguments)}return count}]}),CLASS({"package":"foam.core.types",name:"DocumentInstallProperty",extendsModel:"Property",properties:[{model_:"FunctionProperty",name:"documentInstallFn"}],methods:[function initPropertyAgents(proto,fastInit){this.SUPER(proto,fastInit)
var thisProp=this,DocumentInstallProperty=thisProp.model_
if(proto.addInitAgent(12,": install in document ",function(o,X,Y){var model=o.model_
model&&X.installedModels&&!X.installedModels[model.id]&&thisProp.documentInstallFn.call(proto,X)}),proto.__proto__.model_){var recurse=function(baseProto){var baseProp=baseProto.model_.getProperty(thisProp.name)
baseProp&&(proto.addInitAgent(12,": inherited install in document ",function(o,X,Y){var model=baseProto.model_
model&&X.installedModels&&!X.installedModels[model.id]&&baseProp.documentInstallFn.call(baseProto,X)}),proto.addInitAgent(13,": completed inherited install in document ",function(o,X,Y){X.installedModels[baseProto.model_.id]=!0}),baseProto.__proto__.model_&&recurse(baseProto.__proto__))}
recurse(proto.__proto__)}proto.addInitAgent(13,": completed install in document ",function(o,X,Y){X.installedModels[o.model_.id]=!0})}],help:"Describes a function property that runs once per document"}),CLASS({"package":"foam.apps.ctm",name:"TaskController",requires:["foam.apps.ctm.History","foam.apps.ctm.Task","foam.apps.ctm.TaskSimulator"],imports:["tasks"],properties:[{model_:"foam.core.types.DAOProperty",name:"tasks"},{name:"task",type:"foam.apps.ctm.Task",factory:function(){return this.RANDOM_TASK()},postSet:function(old,nu){old!==nu&&(this.simulator.task=nu)}},{model_:"IntProperty",name:"numHistoryItems",hidden:!0,defaultValue:64},{name:"simulator",type:"foam.apps.ctm.TaskSimulator",factory:function(){return this.TaskSimulator.create({task:this.task,onTaskUpdate:this.onTaskUpdate},this.Y)}},{name:"memory",type:"foam.apps.ctm.History",factory:function(){return this.History.create({property:this.Task.MEMORY,data:this.task,numItems:this.numHistoryItems},this.Y)}},{name:"cpu",type:"foam.apps.ctm.History",factory:function(){return this.History.create({property:this.Task.CPU,data:this.task,numItems:this.numHistoryItems},this.Y)}},{name:"network",type:"foam.apps.ctm.History",factory:function(){return this.History.create({property:this.Task.NETWORK,data:this.task,numItems:this.numHistoryItems},this.Y)}}],constants:[{name:"WORDS",value:["Browser","Extension","Tab","App","Plugin","Google","GMail","Calendar","Docs","Ads","Todo","Meta"]},{name:"RANDOM_TASK",value:function(){var selfFn=arguments.callee,nextId=selfFn.nextId=(selfFn.nextId||0)+1,task=this.Task.create({id:nextId,name:this.WORDS[Math.floor(Math.random()*this.WORDS.length)]+" "+this.WORDS[Math.floor(Math.random()*this.WORDS.length)]+" "+this.WORDS[Math.floor(Math.random()*this.WORDS.length)],memory:500*Math.random(),cpu:10*Math.random(),network:10*Math.random()>7?Math.floor(500*Math.random()):0,processId:Math.floor(1e4*Math.random())})
return task}}],listeners:[{name:"onTaskUpdate",code:function(){this.tasks&&this.tasks.put(this.task)}}]}),CLASS({"package":"foam.apps.ctm",name:"History",imports:["clock$"],properties:[{name:"data"},{name:"property",postSet:function(old,nu){old!==nu&&(old&&old.removeListener(this.tick),nu&&nu.addListener(this.tick))}},{model_:"IntProperty",name:"numItems",defaultValue:64},{model_:"ArrayProperty",name:"history",preSet:function(_,nu){return nu?nu.sink:nu},factory:function(){return[].sink}}],methods:[function init(){this.SUPER(),this.clock$.addListener(this.tick)}],listeners:[{name:"tick",code:function(){var value=this.data[this.property.name]
this.history.length===this.numItems&&this.history.shift(),this.history.put(value)}}]}),CLASS({"package":"foam.apps.ctm",name:"TaskSimulator",imports:["clock$"],properties:[{name:"task",type:"foam.apps.ctm.Task",required:!0},{model_:"FunctionProperty",name:"onTaskUpdate",defaultValue:function(){}}],methods:[function init(){this.SUPER(),this.clock$.addListener(this.tick)}],listeners:[{name:"tick",code:function(){this.task.memory=Math.random()>.8?Math.random()>.5?Math.min(this.task.memory+500*Math.random(),2e3):Math.max(this.task.memory-500*Math.random(),10):this.task.memory,this.task.cpu=Math.random()>.1?Math.random()>.7?Math.min(this.task.cpu+30*Math.random(),100):Math.max(this.task.cpu-30*Math.random(),0):this.task.cpu,this.task.network=Math.random()>.1?Math.random()>.9?Math.min(this.task.network+1e3*Math.random(),2e3):Math.max(this.task.network-1e3*Math.random(),0):this.task.network,this.onTaskUpdate(this.task)}}]}),CLASS({"package":"foam.core.types",name:"DAOProperty",extendsModel:"Property",requires:["foam.dao.FutureDAO","foam.dao.ProxyDAO"],imports:["console"],properties:[{name:"type",defaultValue:"DAO",help:"The FOAM type of this property."},{model_:"ModelProperty",name:"model",help:"The model for objects stored in the DAO."},{name:"view",defaultValue:"foam.ui.DAOListView"},{name:"onDAOUpdate"},{name:"install",defaultValue:function(prop){defineLazyProperty(this,prop.name+"$Proxy",function(){if(this[prop.name])delegate=this[prop.name]
else var future=afuture(),delegate=prop.FutureDAO.create({future:future.get})
var proxy=prop.ProxyDAO.create({delegate:delegate})
return this.addPropertyListener(prop.name,function(_,_,_,dao){return future?(future.set(dao),void(future=null)):void(proxy.delegate=dao)}),{get:function(){return proxy},configurable:!0}})}},{name:"fromElement_",defaultValue:function(e,p,model){for(var children=e.children,i=0;i<children.length;i++)this[p.name].put(model.create(null,this.Y).fromElement(children[i],p))}},{name:"fromElement",defaultValue:function(e,p){var model=e.getAttribute("model")||this[p.name]&&this[p.name].model||p.model||""
return model?void("string"==typeof model?arequire(model,this.X)(function(model){p.fromElement_.call(this,e,p,model)}.bind(this)):p.fromElement_.call(this,e,p,model)):void this.console.warn("Attempt to load DAO from element without model")}}],help:"Describes a DAO property."}),CLASS({"package":"foam.dao",name:"FutureDAO",extendsModel:"foam.dao.ProxyDAO",properties:[{name:"delegate",factory:function(){return null},postSet:function(oldDAO,newDAO){this.daoListeners_.length&&(oldDAO&&oldDAO.unlisten(this.relay()),newDAO.listen(this.relay()))}},{name:"future",required:!0},{name:"model",defaultValueFn:function(){return this.delegate?this.delegate.model:""}}],methods:[function init(){this.SUPER(),this.future(function(delegate){this.delegate=delegate}.bind(this))},function put(value,sink){this.delegate?this.delegate.put(value,sink):this.future(this.put.bind(this,value,sink))},function remove(query,sink){this.delegate?this.delegate.remove(query,sink):this.future(this.remove.bind(this,query,sink))},function removeAll(){if(this.delegate)return this.delegate.removeAll.apply(this.delegate,arguments)
var a=arguments,f=afuture()
return this.future(function(delegate){this.removeAll.apply(this,a)(f.set)}.bind(this)),f.get},function find(key,sink){this.delegate?this.delegate.find(key,sink):this.future(this.find.bind(this,key,sink))},function select(sink,options){if(this.delegate)return this.delegate.select(sink,options)
var a=arguments,f=afuture()
return this.future(function(){this.select.apply(this,a)(f.set)}.bind(this)),f.get}]}),CLASS({"package":"foam.dao",name:"ProxyDAO",extendsModel:"AbstractDAO",requires:["foam.dao.NullDAO"],properties:[{name:"delegate",type:"DAO",mode:"read-only",required:!0,hidden:!0,"transient":!0,factory:function(){return this.NullDAO.create()},postSet:function(oldDAO,newDAO){this.daoListeners_.length&&(oldDAO&&oldDAO.unlisten(this.relay()),newDAO.listen(this.relay()),this.X.lookup("foam.dao.FutureDAO")&&this.X.lookup("foam.dao.FutureDAO").isInstance(oldDAO)||this.notify_("reset",[]))}},{model_:"ModelProperty",name:"model",defaultValueFn:function(){return this.delegate.model},type:"Model"}],methods:[function relay(){if(!this.relay_){var self=this
this.relay_={put:function(){self.notify_("put",arguments)},remove:function(){self.notify_("remove",arguments)},reset:function(){self.notify_("reset",arguments)},toString:function(){return"RELAY("+this.$UID+", "+self.model_.name+", "+self.delegate+")"}}}return this.relay_},function put(value,sink){this.delegate.put(value,sink)},function remove(query,sink){this.delegate.remove(query,sink)},function removeAll(){return this.delegate.removeAll.apply(this.delegate,arguments)},function find(key,sink){this.delegate.find(key,sink)},function select(sink,options){return this.delegate.select(sink,options)},function listen(sink,options){!this.daoListeners_.length&&this.delegate&&this.delegate.listen(this.relay()),this.SUPER(sink,options)},function unlisten(sink){this.SUPER(sink),0===this.daoListeners_.length&&this.delegate&&this.delegate.unlisten(this.relay())},function toString(){return this.name_+"("+this.delegate+")"}]}),CLASS({"package":"foam.dao",name:"NullDAO",methods:[function put(obj,sink){sink&&sink.put&&sink.put(obj)},function remove(obj,sink){sink&&sink.remove&&sink.remove(obj)},function select(sink){return sink&&sink.eof&&sink.eof(),aconstant(sink||[].sink)},function find(q,sink){sink&&sink.error&&sink.error("find",q)},function listen(){},function removeAll(){},function unlisten(){},function pipe(){},function where(){return this},function limit(){return this},function skip(){return this}],help:"A DAO that stores nothing and does nothing."}),CLASS({"package":"foam.apps.ctm",name:"TaskHistoriesView",extendsModel:"foam.ui.SimpleView",requires:["foam.apps.ctm.History"],properties:[{name:"data",type:"foam.apps.ctm.TaskController",postSet:function(old,nu){this.updateHTML()}},{model_:"StringArrayProperty",name:"properties"}],methods:[function toHTML(){var head='<task-histories id="'+this.id+'">',foot="</task-histories>",body=this.toInnerHTML()
return head+body+foot},function toInnerHTML(){if(!this.data)return""
this.children=[]
var i
for(i=0;i<this.properties.length;++i){var propName=this.properties[i]
this.History.isInstance(this.data[propName])&&this.createTemplateView(propName)}var str=""
for(i=0;i<this.children.length;++i)str+=this.children[i].toHTML()
return str},function updateHTML(){this.$&&(this.$.innerHTML=this.toInnerHTML(),this.initHTML())}]}),CLASS({"package":"foam.apps.ctm",name:"TaskHistoryGraph",extendsModel:"foam.ui.SimpleView",requires:["foam.graphics.Graph"],properties:[{name:"data",postSet:function(old,nu){old!==nu&&(this.graph.data=nu?nu:[].sink)}},{name:"taskManager",type:"foam.apps.ctm.TaskManager"},{name:"width",defaultValue:100},{name:"height",defaultValue:50},{name:"maxValue",defaultValue:-1},{name:"graph",type:"foam.graphics.Graph",lazyFactory:function(){return this.Graph.create({width:this.width,height:this.height,maxValue:this.maxValue,graphColor:"lightgray",axisColor:"rgb(137,137,137)",axisSize:1})}}],templates:[{name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,out=opt_out?opt_out:TOC(this)
return out(" ",self.graph," "),out.toString()}}]}),CLASS({"package":"foam.graphics",name:"Graph",extendsModel:"foam.graphics.CView",properties:[{name:"style",type:"String",view:{factory_:"foam.ui.ChoiceView",choices:["Bar","Line","Point"]},defaultValue:"Line"},{model_:"ColorProperty",name:"graphColor",defaultValue:"green"},{model_:"ColorProperty",name:"backgroundColor",defaultValue:""},{name:"lineWidth",defaultValue:6},{model_:"BooleanProperty",name:"drawShadow",defaultValue:!0},{model_:"ColorProperty",name:"capColor",defaultValue:""},{model_:"ColorProperty",name:"axisColor",defaultValue:"black"},{model_:"ColorProperty",name:"gridColor",defaultValue:"",type:"String"},{name:"axisSize",type:"int",defaultValue:2},{name:"xAxisInterval",type:"int",defaultValue:0},{name:"yAxisInterval",type:"int",defaultValue:0},{name:"maxValue",label:"Maximum Value",type:"float",defaultValue:-1},{name:"data",type:"Array[float]",factory:function(){return[]},postSet:function(old,nu){old!==nu&&(old&&old.unlisten(this.onDataChange),nu&&nu.listen(this.onDataChange),this.onDataChange())}},{model_:"FunctionProperty",name:"f",label:"Data Function",required:!1,help:"The graph's data function.",defaultValue:function(x){return x}}],methods:[function paintLineData(canvas,x,y,xs,w,h,maxValue){if(this.graphColor){canvas.fillStyle=this.graphColor,canvas.beginPath(),canvas.moveTo(x+xs,y+h-xs)
for(var i=0;i<this.data.length;i++){var d=this.f(this.data[i]),lx=x+xs+(0==i?0:w*i/(this.data.length-1)),ly=this.toY(d,maxValue)
canvas.lineTo(lx,ly)}canvas.lineTo(x+this.width-1,y+h-xs),canvas.lineTo(x+xs,y+h-xs),canvas.fill()}if(this.capColor){this.drawShadow&&(canvas.shadowOffsetX=0,canvas.shadowOffsetY=2,canvas.shadowBlur=2,canvas.shadowColor="rgba(0, 0, 0, 0.5)"),canvas.strokeStyle=this.capColor,canvas.lineWidth=this.lineWidth,canvas.lineJoin="round",canvas.beginPath()
for(var i=0;i<this.data.length;i++){var d=this.f(this.data[i]),lx=this.toX(i)+.5,ly=this.toY(d,maxValue)-5
0==i?canvas.moveTo(lx,ly):canvas.lineTo(lx,ly)}canvas.stroke()}},function paintPointData(canvas,x,y,xs,w,h,maxValue){canvas.shadowOffsetX=2,canvas.shadowOffsetY=2,canvas.shadowBlur=2,canvas.shadowColor="rgba(0, 0, 0, 0.5)",canvas.strokeStyle=this.capColor,canvas.lineWidth=2,canvas.lineJoin="round",canvas.beginPath()
for(var i=0;i<this.data.length;i++){var d=this.f(this.data[i]),lx=this.toX(i)+.5,ly=this.toY(d,maxValue)+.5
0==i?canvas.moveTo(lx,ly):canvas.lineTo(lx,ly)}canvas.stroke(),canvas.lineWidth=3
for(var i=0;i<this.data.length;i++){var d=this.f(this.data[i]),lx=this.toX(i)+.5,ly=this.toY(d,maxValue)+.5
canvas.beginPath(),canvas.arc(lx,ly,4,0,-Math.PI/2),canvas.closePath(),canvas.stroke()}},function paintBarData(canvas,x,y,xs,w,h,maxValue){canvas.fillStyle=this.graphColor
for(var i=0;i<this.data.length;i++){var d=this.f(this.data[i]),x1=x+xs+w*i/this.data.length,y1=this.toY(d,maxValue)
canvas.fillRect(x1,y1,w/this.data.length+1.5,d*h/maxValue)}},function paint(){var canvas=this.canvas,x=this.x,y=this.y,xs=this.axisSize,w=this.width-xs,h=this.height-xs,maxValue=this.maxValue
if(this.backgroundColor&&(canvas.fillStyle=this.backgroundColor,canvas.fillRect(x,y,w,h)),-1==maxValue){maxValue=.001
for(var i=0;i<this.data.length;i++){var d=this.f(this.data[i])
maxValue=Math.max(maxValue,d)}}if("Line"==this.style?this.paintLineData(canvas,x,y,xs,w,h,maxValue):"Bar"==this.style?this.paintBarData(canvas,x,y,xs,w,h,maxValue):"Point"==this.style&&this.paintPointData(canvas,x,y,xs,w,h,maxValue),this.axisColor&&0!=xs&&(canvas.fillStyle=this.axisColor,canvas.fillRect(x,y+h-1.5*xs,this.width,xs),canvas.fillRect(x,y,xs,this.height-1.5*xs)),this.xAxisInterval)for(var i=this.xAxisInterval;i<=this.data.length;i+=this.xAxisInterval){var x2=this.toX(i)
this.gridColor&&(canvas.save(),canvas.shadowOffsetX=0,canvas.shadowOffsetY=0,canvas.shadowBlur=0,canvas.fillStyle=this.gridColor,canvas.fillRect(x2+1.5,this.toY(0,1)-2*xs,.5,-this.height),canvas.restore()),canvas.fillRect(x2,this.toY(0,1)-2*xs,xs/2,-xs)}if(this.yAxisInterval)for(var i=this.yAxisInterval;maxValue>=i;i+=this.yAxisInterval){var y=this.toY(i,maxValue)
this.gridColor&&(canvas.save(),canvas.shadowOffsetX=0,canvas.shadowOffsetY=0,canvas.shadowBlur=0,canvas.fillStyle=this.gridColor,canvas.fillRect(x+xs,y+3,this.width,.5),canvas.restore()),canvas.fillRect(x+xs,y,xs,xs/2)}},function toX(val){var w=this.width-this.axisSize
return this.x+this.axisSize+(0==val?0:w*val/(this.data.length-1))},function toY(val,maxValue){var h=this.height-this.axisSize
return this.y+h-val*h/maxValue+.5},function lastValue(){return this.data[this.data.length-1]},function addData(value,opt_maxNumValues){var maxNumValues=opt_maxNumValues||this.width
this.data.length==maxNumValues&&this.data.shift(),this.data.push(value)},function watch(value,opt_maxNumValues){var graph=this
value.addListener(function(){graph.addData(value.get(),opt_maxNumValues)})}],listeners:[{name:"onDataChange",code:function(){this.view&&this.view.paint()}}]}),CLASS({"package":"foam.graphics",name:"CView",label:"CView",traits:["foam.patterns.ChildTreeTrait"],requires:["foam.graphics.PositionedCViewView","foam.graphics.CViewView"],properties:[{name:"view",type:"Canvas2",hidden:!0,"transient":!0,postSet:function(_,view){for(var key in this.children){var child=this.children[key]
child.view=view,view&&child.addListener(view.paint)}}},{name:"canvas",hidden:!0,"transient":!0,getter:function(){return this.view&&this.view.canvas}},{name:"$",hidden:!0,"transient":!0,getter:function(){return this.view&&this.view.$}},{name:"state",defaultValue:"initial"},{model_:"BooleanProperty",name:"suspended",defaultValue:!1},{name:"className",defaultValue:"",postSet:function(){this.$&&(this.$.className=this.className)},help:"CSS class name(s), space separated. Used if adapted with a CViewView."},{model_:"FloatProperty",name:"x",defaultValue:0},{model_:"FloatProperty",name:"y",defaultValue:0},{model_:"FloatProperty",name:"a",label:"Rotation",defaultValue:0},{model_:"FloatProperty",name:"scaleX",defaultValue:1},{model_:"FloatProperty",name:"scaleY",defaultValue:1},{name:"canvasX",getter:function(){return this.x+(this.parent?this.parent.canvasX:0)}},{name:"canvasY",getter:function(){return this.y+(this.parent?this.parent.canvasY:0)}},{model_:"IntProperty",name:"width",defaultValue:10},{model_:"IntProperty",name:"height",defaultValue:10},{model_:"FloatProperty",name:"alpha",defaultValue:1},{name:"color",label:"Foreground Color",type:"String",defaultValue:"black"},{name:"background",label:"Background Color",type:"String",defaultValue:"white"},{name:"font"},{model_:"BooleanProperty",name:"clipped",defaultValue:!1}],methods:[function toView_(){if(!this.view){var params={cview:this}
this.className&&(params.className=this.className),this.tooltip&&(params.tooltip=this.tooltip),this.speechLabel&&(params.speechLabel=this.speechLabel),this.tabIndex&&(params.tabIndex=this.tabIndex),this.role&&(params.role=this.role),this.data$&&(params.data$=this.data$),this.view=this.CViewView.create(params)}return this.view},function toPositionedView_(){if(!this.view){var params={cview:this}
this.className&&(params.className=this.className),this.view=this.PositionedCViewView.create(params)}return this.view},function initCView(){},function write(document){this.toView_().write(document)},function addChild(child){return this.SUPER(child),this.view&&(child.view=this.view,child.addListener(this.view.paint)),this},function removeChild(child){return this.SUPER(child),child.view=void 0,child.removeListener(this.view.paint),this},function erase(){this.canvas.clearRect(0,0,this.width,this.height),this.canvas.fillStyle=this.background,this.canvas.fillRect(0,0,this.width,this.height)},function paintChildren(){for(var i=0;i<this.children.length;i++){var child=this.children[i]
this.canvas.save(),this.canvas.beginPath(),child.paint(),this.canvas.restore()}},function paintSelf(){},function paint(){this.$&&this.width&&this.height&&("initial"===this.state&&(this.state="active",this.initCView()),this.suspended||(this.canvas.save(),this.transform(),this.clipped&&(this.canvas.rect(0,0,this.width,this.height),this.canvas.clip()),this.paintSelf(),this.paintChildren(),this.canvas.restore()))},function transform(){this.canvas.translate(this.x,this.y),this.canvas.scale(this.scaleX,this.scaleY),this.canvas.rotate(this.a)},function scale(s){this.scaleX=this.scaleY=s},function mapToParent(point){return point.x+=this.x,point.y+=this.y,point},function mapToCanvas(point){return this.mapToParent(point),this.parent&&this.parent.mapToCanvas&&this.parent.mapToCanvas(point),point},function destroy(){}]}),CLASS({"package":"foam.graphics",name:"PositionedCViewView",extendsModel:"foam.graphics.AbstractCViewView",traits:["foam.ui.layout.PositionedDOMViewTrait"],properties:[{name:"tagName",factory:function(){return"canvas"}}],methods:[function init(){this.SUPER(),this.X.dynamic(function(){this.cview,this.width,this.height}.bind(this),function(){this.cview&&(this.cview.width=this.width,this.cview.height=this.height)}.bind(this))},function toHTML(){var className=this.className?' class="'+this.className+'"':""
return'<canvas id="'+this.id+'"'+className+' width="'+this.canvasWidth()+'" height="'+this.canvasHeight()+'" '+this.layoutStyle()+"></canvas>"}],listeners:[{name:"resize",code:function(){this.$&&(this.$.width=this.canvasWidth(),this.$.style.width=this.styleWidth(),this.$.height=this.canvasHeight(),this.$.style.height=this.styleHeight(),this.cview.width=this.width,this.cview.height=this.height,this.paint())},isFramed:!0}]}),CLASS({"package":"foam.ui.layout",name:"PositionedDOMViewTrait",traits:["foam.ui.layout.PositionedViewTrait"],properties:[{name:"tagName",defaultValue:"div"}],methods:[function toHTML(){return"<"+this.tagName+' id="'+this.id+'"'+this.layoutStyle()+this.cssClassAttr()+">"+this.toInnerHTML()+"</div>"},function layoutStyle(){return' style="-webkit-transform:'+this.transform()+";width:"+this.styleWidth()+";height:"+this.styleHeight()+';position:absolute;"'},function initHTML(){this.SUPER()
var self=this
this.X.dynamic(function(){self.x,self.y,self.z},this.position),this.X.dynamic(function(){self.width,self.height},this.resize),this.$.style.position="absolute",this.position(),this.resize()},function transform(){return"translate3d("+this.x+"px,"+this.y+"px,"+this.z+"px)"},function styleWidth(){return this.width+"px"},function styleHeight(){return this.height+"px"}],listeners:[{name:"position",code:function(){this.$&&(this.$.style.webkitTransform=this.transform())}},{name:"resize",code:function(){this.$&&(this.$.style.width=this.styleWidth(),this.$.style.height=this.styleHeight())}}]}),CLASS({"package":"foam.ui.layout",name:"PositionedViewTrait",properties:[{model_:"FloatProperty",name:"x",units:"px",defaultValue:0},{model_:"FloatProperty",name:"y",units:"px",defaultValue:0},{model_:"FloatProperty",name:"z",units:"px",defaultValue:0},{model_:"IntProperty",name:"width",units:"px",defaultValue:100},{model_:"IntProperty",name:"height",units:"px",defaultValue:100},{model_:"IntProperty",name:"preferredWidth",units:"px",defaultValue:100},{model_:"IntProperty",name:"preferredHeight",units:"px",defaultValue:100}]}),CLASS({"package":"foam.graphics",name:"AbstractCViewView",extendsModel:"foam.ui.View",properties:[{name:"cview",type:"foam.graphics.CView",postSet:function(_,cview){cview.view=this,this.width=cview.x+cview.width,this.height=cview.y+cview.height}},{name:"className",defaultValue:"",help:"CSS class name(s), space separated."},{model_:"FloatProperty",name:"scalingRatio",preSet:function(_,v){return 0>=v?1:v},defaultValue:1},{name:"speechLabel"},{name:"role"},{name:"tabIndex"},{model_:"IntProperty",name:"width",defaultValue:100},{model_:"IntProperty",name:"height",defaultValue:100},{name:"canvas",getter:function(){return this.instance_.canvas?this.instance_.canvas:this.instance_.canvas=this.$&&this.$.getContext("2d")}}],methods:[function init(){this.SUPER(),this.X.dynamic(function(){this.scalingRatio,this.width,this.height}.bind(this),this.resize)},function styleWidth(){return this.width+"px"},function canvasWidth(){return this.width*this.scalingRatio},function styleHeight(){return this.height+"px"},function canvasHeight(){return this.height*this.scalingRatio},function toString(){return"CViewView("+this.cview+")"},function toHTML(){var className=this.className?' class="'+this.className+'"':"",title=this.speechLabel?' aria-role="button" aria-label="'+this.speechLabel+'"':"",tabIndex=this.tabIndex?' tabindex="'+this.tabIndex+'"':"",role=this.role?' role="'+this.role+'"':""
return'<canvas id="'+this.id+'"'+className+title+tabIndex+role+' width="'+this.canvasWidth()+'" height="'+this.canvasHeight()+'" style="width:'+this.styleWidth()+";height:"+this.styleHeight()+";min-width:"+this.styleWidth()+";min-height:"+this.styleHeight()+'"></canvas>'},function initHTML(){if(this.$){this.maybeInitTooltip(),this.canvas=this.$.getContext("2d")
var devicePixelRatio=this.X.window.devicePixelRatio||1,backingStoreRatio=this.canvas.backingStoreRatio||this.canvas.webkitBackingStorePixelRatio||1
devicePixelRatio!==backingStoreRatio&&(this.scalingRatio=devicePixelRatio/backingStoreRatio)
var style=this.X.window.getComputedStyle(this.$)
style.backgroundColor&&!this.cview.hasOwnProperty("background")&&(this.cview.background=style.backgroundColor),this.paint()}},function destroy(isParentDestroyed){this.SUPER(isParentDestroyed)}],listeners:[{name:"resize",code:function(){this.$&&(this.$.width=this.canvasWidth(),this.$.style.width=this.styleWidth(),this.$.style.minWidth=this.styleWidth(),this.$.height=this.canvasHeight(),this.$.style.height=this.styleHeight(),this.$.style.minHeight=this.styleHeight(),this.paint())},isFramed:!0},{name:"paint",code:function(){if(!this.$)throw EventService.UNSUBSCRIBE_EXCEPTION
this.canvas.save(),this.canvas.clearRect(0,0,this.canvasWidth(),this.canvasHeight()),this.canvas.fillStyle=this.cview.background,this.canvas.fillRect(0,0,this.canvasWidth(),this.canvasHeight()),this.canvas.scale(this.scalingRatio,this.scalingRatio),this.cview.paint(),this.canvas.restore()},isFramed:!0}]}),CLASS({"package":"foam.ui",name:"View",extendsModel:"foam.ui.DestructiveDataView",traits:["foam.ui.HTMLViewTrait"],requires:["Property"],exports:["propertyViewProperty"],properties:[{name:"propertyViewProperty",type:"Property",defaultValueFn:function(){return this.Property.DETAIL_VIEW}}]}),CLASS({"package":"foam.ui",name:"DestructiveDataView",extendsModel:"foam.ui.BaseView",requires:["SimpleValue"],properties:[{name:"data",preSet:function(old,nu){return this.shouldDestroy(old,nu)&&this.destroy(),nu},postSet:function(old,nu){this.shouldDestroy(old,nu)&&this.construct()}},{name:"dataLinkedChildren",type:"Array[foam.patterns.ChildTreeTrait]",factory:function(){return[]}}],methods:[function shouldDestroy(old,nu){return!0},function destroy(isParentDestroyed){isParentDestroyed||(this.dataLinkedChildren.forEach(function(child){Events.unfollow(this.data$,child.data$)}.bind(this)),this.dataLinkedChildren=[]),this.SUPER(isParentDestroyed)},function addDataChild(child){Events.follow(this.data$,child.data$),this.dataLinkedChildren.push(child),this.addChild(child)}]}),CLASS({"package":"foam.graphics",name:"CViewView",extendsModel:"foam.graphics.AbstractCViewView",properties:[{name:"cview",postSet:function(_,cview){cview.view=this,this.X.dynamic(function(){var w=cview.x+cview.width,h=cview.y+cview.height
this.width=w?Math.max(this.width,w):0,this.height=h?Math.max(this.height,h):0}.bind(this))}}],methods:[function shouldDestroy(){return!1},function destroy(){this.SUPER(),this.cview&&this.cview.destroy()}],help:"DOM wrapper for a CView, auto adjusts it size to fit the given cview."}),CLASS({"package":"foam.apps.ctm",name:"TaskManagerContext",requires:["foam.apps.ctm.Task"],properties:[{model_:"StringArrayProperty",name:"tableColumns",factory:function(){return this.Task.tableProperties}}]}),CLASS({"package":"foam.apps.ctm",name:"TaskManagerDetailView",extendsModel:"foam.ui.DetailView",requires:["foam.apps.ctm.Task","foam.apps.ctm.TaskPieGraph","foam.ui.ActionButton"],properties:[{name:"data",postSet:function(old,nu){old!==nu&&(old&&old.filteredCount$&&old.filteredCount$.removeListener(this.onFilteredCountChange),nu&&nu.filteredCount$&&nu.filteredCount$.addListener(this.onFilteredCountChange))}},{name:"hardSelection",defaultValue:null,postSet:function(old,nu){if(old!==nu){var taskLabel=this.$taskLabel
taskLabel&&(taskLabel.innerHTML=nu?nu.name:"Task")}}},{model_:"IntProperty",name:"numHistoryItems",defaultValue:64},{model_:"BooleanProperty",name:"showActions",preSet:function(){return!1},defaultValue:!1},{name:"$taskLabel",defaultValueFn:function(){return this.$&&this.$.querySelector("#"+this.id+"-task-label")}}],listeners:[{name:"onFilteredCountChange",code:function(_,__,old,nu){this.filteredTasksView&&old!==nu&&(this.filteredTasksView.title=nu+" Tasks")},isFramed:!0}],templates:[{name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,out=opt_out?opt_out:TOC(this)
return out('\n      <task-manager id="',self.id,'">\n        <tm-header class="md-card-shell" style="display: flex">\n          <header-text>Task Manager</header-text>\n          <search-box>\n            <chrome>\n              <i class="material-icons search">search</i>\n            </chrome>\n            ',self.createTemplateView("search",{height:30}),'\n          </search-box>\n        </tm-header>\n        <tm-body class="md-card-shell" style="display: flex">\n          ',self.createTemplateView("filteredTasks",{title:"Tasks",editColumnsEnabled:!0,properties$:this.data.tableColumns$}),'\n        </tm-body>\n        <tm-footer class="md-card">\n          <stats>\n            <global-stats>\n              <label>System</label>\n              <stats>\n                <stat>\n                  <label>Memory</label>\n                  <stat-data>',self.createTemplateView("tasks",{model_:this.TaskPieGraph,property:this.Task.MEMORY}),"</stat-data>\n                </stat>\n                <stat>\n                  <label>CPU</label>\n                  <stat-data>",self.createTemplateView("tasks",{model_:this.TaskPieGraph,property:this.Task.CPU}),"</stat-data>\n                </stat>\n                <stat>\n                  <label>Network</label>\n                  <stat-data>",self.createTemplateView("tasks",{model_:this.TaskPieGraph,property:this.Task.NETWORK}),'</stat-data>\n                </stat>\n              </stats>\n            </global-stats>\n            <stats-separator id="',this.setClass("hidden",function(){return!this.data||!this.data.hardSelection}.bind(this)),'"></stats-separator>\n            <local-stats id="',this.setClass("hidden",function(){return!this.data||!this.data.hardSelection}.bind(this)),'">\n              <label id="',self.id,'-task-label">Task</label>\n              <stats>\n                <stat>\n                  <label>Memory</label>\n                  <stat-data>',self.createTemplateView("memory",{width:80,height:40}),"</stat-data>\n                </stat>\n                <stat>\n                  <label>CPU</label>\n                  <stat-data>",self.createTemplateView("cpu",{width:80,height:40}),"</stat-data>\n                </stat>\n                <stat>\n                  <label>Network</label>\n                  <stat-data>",self.createTemplateView("network",{width:100,height:50}),'</stat-data>\n                </stat>\n              </stats>\n            </local-stats>\n          </stats>\n          <actions>\n          </actions>\n        </tm-footer>\n        <a id="stats-for-nerds" target="_blank" href="chrome://memory-redirect">Stats for nerds</a>\n      </task-manager>\n    '),out.toString()}},{name:"CSS",code:ConstantTemplate("\n@import url(http://fonts.googleapis.com/css?family=Roboto:400,500);\n@import url(https://fonts.googleapis.com/icon?family=Material+Icons);\nbody, task-manager {\nwidth: 100%;\nheight: 100%;\ncolor: rgba(0, 0, 0, 0.87);\nfont-family: 'Roboto', sans-serif;\nfont-size: 13px;\nfont-weight: 400;\n}\ntask-manager {\nbackground: rgb(238,238,238);\nflex-direction: column;\n}\ntask-manager .tableView:focus,\ntask-manager .mdTableView:focus {\noutline: none;\n}\ntask-manager tm-footer {\ndisplay: block;\n}\ntask-manager tm-header,\ntask-manager tm-footer {\nflex-grow: 0;\nflex-shrink: 0;\n}\ntask-manager tm-header {\nheight: 64px;\npadding: 0px 14px 0px 24px;\njustify-content: space-between;\nalign-items: center;\n}\ntask-manager tm-header header-text {\nfont-size: 30px;\nfont-weight: 500;\ncolor: rgba(0, 0, 0, 0.87);\n}\ntask-manager tm-header search-box {\nposition: relative;\n}\ntask-manager tm-header search-box input {\ncolor: rgba(0, 0, 0, 0.87);\nfont-size: 13px;\nfont-weight: 400;\npadding-left: 26px;\nheight: 26px;\nborder: 1px solid rgba(0, 0, 0, 0.27);\nborder-radius: 2px;\n}\ntask-manager tm-header search-box input:focus {\nborder: 1px solid rgba(0, 0, 0, 0.54);\noutline: none;\n}\ntask-manager tm-header search-box chrome {\nposition: absolute;\ntop: 2px;\nleft: 4px;\n}\ntask-manager tm-header search-box i,\ntask-manager tm-header search-box i.material-icons {\ncolor: rgba(0, 0, 0, 0.27);\n}\ntask-manager tm-header search-box i.material-icons {\nfont-size: 20px;\n}\ntask-manager tm-body {\nflex-grow: 1;\noverflow: hidden;\n}\ntask-manager,\ntask-manager tm-body,\ntask-manager tm-header,\ntask-manager tm-footer actions,\ntask-manager tm-footer stats,\ntask-manager tm-footer stats global-stats,\ntask-manager tm-footer stats local-stats,\ntask-manager tm-footer stats stats,\ntask-manager tm-footer stats stats stat,\ntask-manager tm-footer stats stats stat stat-data {\ndisplay: flex;\n}\ntask-manager tm-footer stats {\nalign-items: stretch;\njustify-content: space-around;\n}\ntask-manager tm-footer stats global-stats,\ntask-manager tm-footer stats local-stats {\nalign-items: stretch;\njustify-content: stretch;\n}\ntask-manager tm-footer stats label {\nflex-grow: 0;\npadding: 5px;\nfont-weight: bold;\ntext-align: center;\n}\ntask-manager tm-footer stats stats {\nflex-grow: 1;\n}\ntask-manager tm-footer stats stats stat {\nflex-grow: 1;\nalign-items: center;\njustify-content: stretch;\nflex-direction: column;\n}\ntask-manager tm-footer stats stat label {\nflex-grow: 0;\nfont-weight: normal;\n}\ntask-manager tm-footer stats global-stats,\ntask-manager tm-footer stats local-stats {\nflex-grow: 1;\nflex-direction: column;\njustify-content: stretch;\n}\ntask-manager tm-footer stats stat stat-data {\nflex-grow: 1;\nflex-direction: column;\njustify-content: center;\n}\ntask-manager tm-footer stats {\nflex-wrap: wrap;\n}\ntask-manager tm-footer stats global-stats,\ntask-manager tm-footer stats local-stats {\nflex-grow: 1;\n}\ntask-manager tm-footer stats .hidden {\ndisplay: none;\n}\ntask-manager tm-footer stats stats-separator {\ndisplay: block;\nflex-grow: 0;\nflex-shrink: 0;\nborder-left: 1px solid rgba(0, 0, 0, 0.27);\nwidth: 0px;\n}\ntask-manager tm-footer actions {\njustify-content: space-between;\nalign-items: center;\n}\ntask-manager img {\nmargin-right: 4px;\nvertical-align: text-bottom;\n}\n#stats-for-nerds {\nflex-grow: 0;\nflex-shrink: 0;\nmargin: 0px 10px 10px 10px;\n}\n")}]}),CLASS({"package":"foam.apps.ctm",name:"TaskPieGraph",extendsModel:"foam.ui.SimpleView",requires:["foam.graphics.PieGraph"],imports:["hardSelection$","softSelection$","clock$"],properties:[{name:"hardSelection",postSet:function(){this.paint()}},{name:"softSelection",postSet:function(){this.paint()}},{name:"property",required:!0},{name:"groups"},{name:"pie",type:"foam.graphics.PieGraph",lazyFactory:function(){return this.PieGraph.create({width:100,height:100,toColor:function(id,i,n){return this.hardSelection&&this.hardSelection.id==id?"rgb(72,131,239)":this.softSelection&&this.softSelection.id==id?"rgb(232,240,253)":"lightgray"}.bind(this)},this.Y)}}],methods:[function init(){this.SUPER(),this.clock$.addListener(this.tick)},function initHTML(){this.SUPER(),this.tick()},function paint(){this.pie.view&&this.pie.view.paint&&this.pie.view.paint()}],listeners:[{name:"tick",code:function(){return this.groups={},this.data.select({put:function(task){this.groups[task.id]=task[this.property.name]}.bind(this)})(function(){this.pie.groups=this.groups,this.paint()}.bind(this))},isFramed:!0}],templates:[{name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,out=opt_out?opt_out:TOC(this)
return out(" ",self.pie," "),out.toString()}}]}),CLASS({"package":"foam.graphics",name:"PieGraph",extendsModel:"foam.graphics.CView",properties:[{name:"r",type:"int",view:"foam.ui.IntFieldView",defaultValue:50,postSet:function(old,nu){old!==nu&&this.setDimensions()}},{name:"lineColor",type:"String",defaultValue:"white"},{name:"lineWidth",type:"int",defaultValue:1,postSet:function(old,nu){old!==nu&&this.setDimensions()}},{name:"colorMap",defaultValue:""},{name:"data",type:"Array[float]",factory:function(){return[]}},{name:"groups",label:"Group Data",defaultValue:{}},{model_:"FunctionProperty",name:"toColor",defaultValue:function(key,i,n){return this.colorMap&&this.colorMap[key]||this.toHSLColor(i,n)}}],methods:[function init(){this.SUPER.apply(this,arguments),this.setDimensions()},function setDimensions(){console.log("Setting dimensions"),this.width=this.height=this.getDimensions()},function getDimensions(){return 2*(this.r+this.lineWidth)},function toCount(o){return CountExpr.isInstance(o)?o.count:o},function toHSLColor(i,n){return"hsl("+Math.floor(360*i/n)+", 95%, 75%)"},function paintSelf(){var c=this.canvas
if(c){var x=this.x,y=this.y,r=this.r,sum=0,n=0
for(var key in this.groups)sum+=this.toCount(this.groups[key]),n++
r>10&&(c.fillStyle="lightgray",c.beginPath(),c.arc(r+2,r+2,r,0,2*Math.PI),c.fill()),c.lineWidth=this.lineWidth,c.strokeStyle=this.lineColor
var rads=0,i=0
for(var key in this.groups){var start=rads,count=this.toCount(this.groups[key])
rads+=count/sum*2*Math.PI,c.fillStyle=this.toColor(key,i++,n),c.beginPath(),sum>count&&c.moveTo(r,r),c.arc(r,r,r,start,rads),sum>count&&c.lineTo(r,r),c.fill(),c.stroke()}}}]}),CLASS({"package":"foam.ui",name:"ActionButton",extendsModel:"foam.ui.BaseView",traits:["foam.ui.HTMLViewTrait"],properties:[{name:"action",postSet:function(old,nu){old&&old.removeListener(this.render),nu.addListener(this.render)}},{name:"data"},{name:"className",factory:function(){return"actionButton actionButton-"+this.action.name}},{name:"tagName",defaultValue:"button"},{name:"showLabel",defaultValueFn:function(){return this.action.showLabel}},{name:"label",defaultValueFn:function(){return this.data?this.action.labelFn.call(this.data,this.action):this.action.label}},{name:"iconUrl",defaultValueFn:function(){return this.action.iconUrl}},{name:"tooltip",defaultValueFn:function(){return this.action.help}}],methods:[function toHTML(){var superResult=this.SUPER(),self=this
return this.on("click",function(){self.action.maybeCall(self.X,self.data)},this.id),this.setAttribute("disabled",function(){return self.closeTooltip(),self.action.isEnabled.call(self.data,self.action)?void 0:"disabled"},this.id),this.setClass("available",function(){return self.closeTooltip(),self.action.isAvailable.call(self.data,self.action)},this.id),this.X.dynamic(function(){self.action.labelFn.call(self.data,self.action),self.updateHTML()}),superResult},function toInnerHTML(){var out=""
return this.iconUrl&&(out+='<img src="'+XMLUtil.escapeAttr(this.iconUrl)+'">'),this.showLabel&&(out+=this.label),out},function initKeyboardShortcuts(){}],listeners:[{name:"render",code:function(){this.updateHTML()},isFramed:!0}]}),CLASS({"package":"foam.ui",name:"DetailView",extendsModel:"foam.ui.View",requires:["Property","foam.ui.TextFieldView","foam.ui.IntFieldView","foam.ui.FloatFieldView","foam.ui.DAOController"],exports:["propertyViewProperty"],properties:[{name:"className",defaultValue:"detailView"},{name:"data",preSet:function(old,nu){return nu.model_&&(this.model=nu.model_),nu}},{name:"model",type:"Model"},{name:"title",defaultValueFn:function(){return(this.data&&this.data.id?"Edit ":"New ")+this.model.label}},{model_:"StringProperty",name:"mode",defaultValue:"read-write"},{model_:"BooleanProperty",name:"showRelationships",defaultValue:!1},{name:"propertyViewProperty",type:"Property",defaultValueFn:function(){return this.Property.DETAIL_VIEW}}],methods:[function shouldDestroy(old,nu){return old&&old.model_&&nu&&nu.model_?old.model_!==nu.model_:!0},function generateContent(){this.$&&(this.$.outerHTML=this.toHTML(),this.initHTML())},function titleHTML(){var title=this.title
return title?'<tr><th colspan=2 class="heading">'+title+"</th></tr>":""},function startForm(){return"<table>"},function endForm(){return"</table>"},function startColumns(){return"<tr><td colspan=2><table valign=top><tr><td valign=top><table>"},function nextColumn(){return"</table></td><td valign=top><table valign=top>"},function endColumns(){return"</table></td></tr></table></td></tr>"},function rowToHTML(prop,view){var str=""
return prop.detailViewPreRow&&(str+=prop.detailViewPreRow(this)),str+='<tr class="detail-'+prop.name+'">',this.DAOController.isInstance(view)?(str+="<td colspan=2><div class=detailArrayLabel>"+prop.label+"</div>",str+=view.toHTML(),str+="</td>"):(str+="<td class='label'>"+prop.label+"</td>",str+="<td>",str+=view.toHTML(),str+="</td>"),str+="</tr>",prop.detailViewPostRow&&(str+=prop.detailViewPostRow(this)),str},function toHTML(){if(!this.data)return'<span id="'+this.id+'"></span>'
if(!this.model)throw"DetailView: either 'data' or 'model' must be specified."
return(this.model.getPrototype().toDetailHTML||this.defaultToHTML).call(this)},function defaultToHTML(){this.children=[]
var model=this.model,str=""
str+='<div id="'+this.id+'" '+this.cssClassAttr()+'" name="form">',str+=this.startForm(),str+=this.titleHTML()
for(var properties=model.getRuntimeProperties(),i=0;i<properties.length;i++){var prop=properties[i]
if(!prop.hidden){var view=this.createView(prop)
this.addDataChild(view),str+=this.rowToHTML(prop,view)}}if(str+=this.endForm(),this.showRelationships){var view=this.X.lookup("foam.ui.RelationshipsView").create({data:this.data})
this.addDataChild(view),str+=view.toHTML()}return str+="</div>"}],templates:[{name:"CSS",code:ConstantTemplate("\n.detailView {\nborder: solid 2px #dddddd;\nbackground: #fafafa;\nwidth: 99%;\n}\n\n.detailView .heading {\nfloat: left;\nfont-size: 14px;\nfont-weight: bold;\nmargin-bottom: 8px;\n}\n\n.detailView .propertyLabel {\nfont-size: 14px;\ndisplay: block;\nfont-weight: bold;\ntext-align: right;\nfloat: left;\n}\n\n.detailView input {\nfont-size: 12px;\npadding: 4px 2px;\nborder: solid 1px #aacfe4;\nmargin: 2px 0 0px 10px;\n}\n\n.detailView textarea {\nfloat: left;\nfont-size: 12px;\npadding: 4px 2px;\nborder: solid 1px #aacfe4;\nmargin: 2px 0 0px 10px;\nwidth: 98%;\noverflow: auto;\n}\n\n.detailView select {\nfont-size: 12px;\npadding: 4px 2px;\nborder: solid 1px #aacfe4;\nmargin: 2px 0 0px 10px;\n}\n\n.detailView .label {\nvertical-align: top;\n}\n\n.detailArrayLabel {\nfont-size: medium;\n}\n\n.detailArrayLabel .foamTable {\nmargin: 1px;\nwidth: 99%;\n}\n")}]}),CLASS({"package":"foam.ui",name:"TextFieldView",label:"Text Field",extendsModel:"foam.ui.SimpleView",requires:["foam.ui.AutocompleteView"],properties:[{model_:"StringProperty",name:"name",defaultValue:"field"},{model_:"IntProperty",name:"displayWidth",defaultValue:30},{model_:"IntProperty",name:"displayHeight",defaultValue:1},{model_:"StringProperty",name:"type",defaultValue:"text"},{model_:"StringProperty",name:"placeholder",defaultValue:""},{model_:"BooleanProperty",name:"onKeyMode",getter:function(){return this.updateMode===this.EACH_KEYSTROKE},setter:function(nu){this.updateMode=nu?this.EACH_KEYSTROKE:this.DONE_EDITING},help:"If true, value is updated on each keystroke."},{model_:"foam.core.types.StringEnumProperty",name:"updateMode",defaultValue:"DONE_EDITING",help:"Controls when the real .data is updated: on every keystroke, when the user presses enter or blurs the box, or on enter only.",choices:[["DONE_EDITING","Done editing"],["EACH_KEYSTROKE","Every keystroke"],["ENTER_ONLY","Enter only"]]},{model_:"BooleanProperty",name:"escapeHTML",help:"If true, HTML content is escaped in display mode.",defaultValue:!0},{model_:"StringProperty",name:"mode",defaultValue:"read-write",view:{factory_:"foam.ui.ChoiceView",choices:["read-only","read-write","final"]}},{model_:"BooleanProperty",name:"required"},{model_:"StringProperty",name:"pattern"},{name:"domValue",hidden:!0},{name:"data"},{model_:"StringProperty",name:"readWriteTagName",hidden:!0,defaultValueFn:function(){return 1===this.displayHeight?"input":"textarea"}},{model_:"BooleanProperty",name:"autocomplete",defaultValue:!0},{name:"autocompleter"},{name:"autocompleteView"}],constants:[{name:"ESCAPE",value:["escape"]},{name:"DONE_EDITING",value:"DONE_EDITING"},{name:"EACH_KEYSTROKE",value:"EACH_KEYSTROKE"},{name:"ENTER_ONLY",value:"ENTER_ONLY"}],methods:[function toHTML(){return"read-write"===this.mode?this.toReadWriteHTML():this.toReadOnlyHTML()},function toReadWriteHTML(){var str="<"+this.readWriteTagName+' id="'+this.id+'"'
return str+=' type="'+this.type+'" '+this.cssClassAttr(),this.on("click",this.onClick,this.id),str+="input"===this.readWriteTagName?' size="'+this.displayWidth+'"':' rows="'+this.displayHeight+'" cols="'+this.displayWidth+'"',this.required&&(str+=" required"),this.pattern&&(str+=' pattern="'+this.pattern+'"'),str+=this.extraAttributes(),str+=' name="'+this.name+'">',str+="</"+this.readWriteTagName+">"},function extraAttributes(){return""},function toReadOnlyHTML(){var self=this
return this.setClass("placeholder",function(){return""===self.data},this.id),"<"+this.tagName+' id="'+this.id+'"'+this.cssClassAttr()+' name="'+this.name+'"></'+this.tagName+">"},function setupAutocomplete(){if(this.autocomplete&&this.autocompleter){var view=this.autocompleteView=this.AutocompleteView.create({autocompleter:this.autocompleter,target:this})
this.bindAutocompleteEvents(view)}},function onAutocomplete(data){this.data=data},function bindAutocompleteEvents(view){this.$.addEventListener("blur",function(){view.publish("blur")}),this.$.addEventListener("input",function(){view.autocomplete(this.textToValue(this.$.value))}.bind(this)),this.$.addEventListener("focus",function(){view.autocomplete(this.textToValue(this.$.value))}.bind(this))},function initHTML(){this.$&&(this.SUPER(),"read-write"===this.mode?(this.placeholder&&(this.$.placeholder=this.placeholder),this.domValue=this.updateMode===this.EACH_KEYSTROKE?DomValue.create(this.$,"input"):this.updateMode===this.DONE_EDITING?DomValue.create(this.$,"change"):this.OnEnterValue.create({element:this.$}),Events.relate(this.data$,this.domValue,this.valueToText.bind(this),this.textToValue.bind(this),this.updateMode===this.EACH_KEYSTROKE),this.updateMode===this.EACH_KEYSTROKE&&this.$.addEventListener("blur",this.onBlur),this.$.addEventListener("keydown",this.onKeyDown),this.setupAutocomplete()):(this.domValue=DomValue.create(this.$,"undefined",this.escapeHTML?"textContent":"innerHTML"),Events.map(this.data$,this.domValue,this.valueToText.bind(this))))},function textToValue(text){return text},function valueToText(value){return"read-only"===this.mode&&""===value?this.placeholder:value},function destroy(isParentDestroyed){this.SUPER(isParentDestroyed),Events.unlink(this.domValue,this.data$)}],listeners:[{name:"onKeyDown",code:function(e){27==e.keyCode?(this.domValue.set(this.data),this.publish(this.ESCAPE)):this.publish(["keydown"],e)}},{name:"onBlur",code:function(e){this.domValue.get()!==this.data&&this.domValue.set(this.data)}},{name:"onClick",code:function(e){this.$&&this.$.focus()}}],models:[{name:"OnEnterValue",properties:[{name:"element"},{name:"listeners",factory:function(){return[]}}],methods:[function get(){return this.element.value},function set(value){this.get()!==value&&(this.element.value=value)},function addListener(listener){listener&&(0===this.listeners.length&&this.element.addEventListener("keydown",this.onKeyDown),this.listeners.push(listener))},function removeListener(listener){var index=this.listeners.indexOf(listener)
index>=0&&this.listeners.splice(i,1)},function fireListeners(e){for(var i=0;i<this.listeners.length;i++)this.listeners[i](e)}],listeners:[{name:"onKeyDown",code:function(e){13===e.keyCode&&this.fireListeners(e)}}]}]}),CLASS({"package":"foam.ui",name:"AutocompleteView",extendsModel:"foam.ui.PopupView",requires:["foam.ui.ChoiceListView"],properties:[{name:"closeTimeout"},{name:"autocompleter"},{name:"completer"},{name:"current"},{model_:"IntProperty",name:"closeTime",units:"ms",help:"Time to delay the actual close on a .close call.",defaultValue:200},{name:"view",postSet:function(prev,v){prev&&(prev.data$.removeListener(this.complete),prev.choices$.removeListener(this.choicesUpdate)),v.data$.addListener(this.complete),v.choices$.addListener(this.choicesUpdate)}},{name:"target",postSet:function(prev,v){prev&&prev.unsubscribe(["keydown"],this.onKeyDown),v.subscribe(["keydown"],this.onKeyDown)}},{name:"maxHeight",defaultValue:400},{name:"className",defaultValue:"autocompletePopup"}],methods:[function autocomplete(partial){if(!this.completer){var proto=this.X.lookup(this.autocompleter)
this.completer=proto.create(null,this.Y)}this.view||(this.view=this.makeView()),this.current=partial,this.open(this.target),this.completer.autocomplete(partial)},function makeView(){return this.ChoiceListView.create({dao:this.completer.autocompleteDao$Proxy,extraClassName:"autocomplete",orientation:"vertical",mode:"final",objToChoice:this.completer.f,useSelection:!0},this.Y)},function init(args){this.SUPER(args),this.subscribe("blur",function(){this.close()}.bind(this))},function open(e,opt_delay){if(this.closeTimeout&&(this.X.clearTimeout(this.closeTimeout),this.closeTimeout=0),this.$)return void this.position(this.$.firstElementChild,e.$||e)
var parentNode=e.$||e,document=parentNode.ownerDocument
console.assert(this.X.document===document,"X.document is not global document")
var div=document.createElement("div"),window=document.defaultView
console.assert(this.X.window===window,"X.window is not global window"),parentNode.insertAdjacentHTML("afterend",this.toHTML().trim()),this.position(this.$.firstElementChild,parentNode),this.initHTML()},function close(opt_now){if(opt_now)return this.closeTimeout&&(this.X.clearTimeout(this.closeTimeout),this.closeTimeout=0),void this.SUPER()
if(!this.closeTimeout){var realClose=this.SUPER,self=this
this.closeTimeout=this.X.setTimeout(function(){self.closeTimeout=0,realClose.call(self)},this.closeTime)}},function position(div,parentNode){var document=parentNode.ownerDocument,pos=findPageXY(parentNode),pageWH=[document.firstElementChild.offsetWidth,document.firstElementChild.offsetHeight]
pageWH[1]-(pos[1]+parentNode.offsetHeight)<(this.height||this.maxHeight||400)&&(div.style.bottom=parentNode.offsetHeight,document.defaultView.innerHeight-pos[1]),div.style.left=pos[2].offsetWidth-pos[0]<600?600-pos[2].offsetWidth:-parentNode.offsetWidth,this.width&&(div.style.width=this.width+"px"),this.height&&(div.style.height=this.height+"px"),this.maxWidth&&(div.style.maxWidth=this.maxWidth+"px",div.style.overflowX="auto"),this.maxHeight&&(div.style.maxHeight=this.maxHeight+"px",div.style.overflowY="auto")}],listeners:[{name:"onKeyDown",code:function(_,_,e){this.view&&(38===e.keyCode?(this.view.index--,this.view.scrollToSelection(this.$),e.preventDefault()):40===e.keyCode?(this.view.index++,this.view.scrollToSelection(this.$),e.preventDefault()):13===e.keyCode&&(this.view.commit(),e.preventDefault()))}},{name:"complete",code:function(){this.target.onAutocomplete(this.view.data),this.view=this.makeView(),this.close(!0)}},{name:"choicesUpdate",code:function(){this.view&&(0===this.view.choices.length||1===this.view.choices.length&&this.view.choices[0][1]===this.current)&&this.close(!0)}}],templates:[{name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,out=opt_out?opt_out:TOC(this)
return out('\n  <span id="',this.id,'" style="position:relative"><div ',this.cssClassAttr(),' style="position:absolute">',this.view,"</div></span>\n    "),out.toString()}}],help:"Default autocomplete popup."}),CLASS({"package":"foam.ui",name:"ChoiceListView",extendsModel:"foam.ui.AbstractChoiceView",properties:[{name:"orientation",view:{factory_:"foam.ui.ChoiceView",choices:[["horizontal","Horizontal"],["vertical","Vertical"]]},defaultValue:"horizontal",postSet:function(old,nu){this.$&&(DOM.setClass(this.$,old,!1),DOM.setClass(this.$,nu))}},{name:"className",defaultValueFn:function(){return"foamChoiceListView "+this.orientation}},{name:"tagName",defaultValue:"ul"},{name:"innerTagName",defaultValue:"li"}],methods:[function init(){this.SUPER(),this.index$.addListener(this.updateSelected),this.choices$.addListener(this.updateSelected)},function choiceToHTML(id,choice){return"<"+this.innerTagName+' id="'+id+'" class="choice">'+choice[1]+"</"+this.innerTagName+">"},function toInnerHTML(){for(var out=[],i=0;i<this.choices.length;i++){var choice=this.choices[i],id=this.nextID()
this.on("click",function(index){this.choice=this.choices[index]}.bind(this,i),id),out.push(this.choiceToHTML(id,choice))}return out.join("")},function initInnerHTML(){this.SUPER(),this.updateSelected()},function scrollToSelection(){var e=this.$.children[this.index]
if(e){for(var parent=e.parentElement;parent;){var overflow=this.X.window.getComputedStyle(parent).overflow
if("scroll"===overflow||"auto"===overflow)break
parent=parent.parentElement}parent=parent||this.X.window,e.offsetTop<parent.scrollTop?e.scrollIntoView(!0):e.offsetTop+e.offsetHeight>=parent.scrollTop+parent.offsetHeight&&e.scrollIntoView()}}],listeners:[{name:"updateSelected",code:function(){if(this.$&&this.$.children)for(var i=0;i<this.$.children.length;i++){var c=this.$.children[i]
DOM.setClass(c,"selected",i===this.index)}}}],templates:[{name:"CSS",code:ConstantTemplate("\n.foamChoiceListView {\nlist-style-type: none;\n}\n\n.foamChoiceListView .selected {\nfont-weight: bold;\n}\n\n.foamChoiceListView.vertical {\npadding: 0;\n}\n.foamChoiceListView.vertical .choice {\nmargin: 4px;\n}\n\n.foamChoiceListView.horizontal {\npadding: 0;\n}\n.foamChoiceListView.horizontal .choice {\ndisplay: inline;\nmargin: 12px;\n}")}]}),CLASS({"package":"foam.ui",name:"AbstractChoiceView",extendsModel:"foam.ui.View",properties:[{model_:"BooleanProperty",name:"autoSetData",help:"If true, this.data is set when choices update and the current data is not one of the choices.",defaultValue:!0},{name:"prop",hidden:!0},{name:"label",help:'The user-visible label for the ChoiceView. Not to be confused with $$DOC{ref:".text"}, the name of the currently selected choice.'},{name:"text",postSet:function(_,d){for(var i=0;i<this.choices.length;i++)if(this.choices[i][1]===d)return void(this.index!==i&&(this.index=i))},help:"The user-visible text of the current choice (ie. [value, text] -> text)."},{name:"choice",getter:function(){for(var value=this.data,i=0;i<this.choices.length;i++){var choice=this.choices[i]
if(value===choice[0])return choice}return void 0},setter:function(choice){var oldValue=this.choice
this.data=choice[0],this.text=choice[1],this.propertyChange("choice",oldValue,this.choice)},help:"The current choice (ie. [value, text])."},{name:"choices",type:"Array[StringField]",preSet:function(_,a){if("object"==typeof a&&!Array.isArray(a)){var out=[]
for(var key in a)a.hasOwnProperty(key)&&out.push([key,a[key]])
return out}a=a.clone()
for(var i=0;i<a.length;i++)Array.isArray(a[i])||(a[i]=[a[i],a[i]])
return a},postSet:function(oldValue,newValue){for(var value=this.data,i=0;i<newValue.length;i++){var choice=newValue[i]
if(value===choice[0]){this.useSelection?this.index=i:this.choice=choice
break}}this.autoSetData&&i===newValue.length&&(this.useSelection?this.index=0:this.data=newValue.length?newValue[0][0]:void 0)
var labelsChanged=!0
if((oldValue&&oldValue.length)==(newValue&&newValue.length)){labelsChanged=!1
for(var i=0;i<oldValue.length;++i)if(!equals(oldValue[i][1],newValue[i][1])){labelsChanged=!0
break}}labelsChanged&&this.updateHTML()}},{model_:"IntProperty",name:"index","transient":!0,preSet:function(_,i){return 0>i||0==this.choices.length?0:i>=this.choices.length?this.choices.length-1:i},postSet:function(_,i){this.useSelection||this.choices.length&&this.data!==this.choices[i][0]&&(this.data=this.choices[i][0])},help:"The index of the current choice.",defaultValue:-1},{model_:"FunctionProperty",name:"objToChoice",help:"A Function which adapts an object from the DAO to a [key, value, ...] choice."},{model_:"BooleanProperty",name:"useSelection",help:"When set, data and choice do not update until an entry is firmly selected"},{model_:"foam.core.types.DAOProperty",name:"dao",onDAOUpdate:"onDAOUpdate"},{name:"data",postSet:function(old,nu){for(var i=0;i<this.choices.length;i++)if(this.choices[i][0]===nu)return void(this.index!==i&&(this.text=this.choices[i][1],this.index=i))
nu&&this.choices.length&&console.warn("ChoiceView data set to invalid choice: ",nu)}}],methods:[function initHTML(){this.SUPER(),this.dao=this.dao},function findChoiceIC(name){name=name.toLowerCase()
for(var i=0;i<this.choices.length;i++)if(this.choices[i][1].toLowerCase()==name)return this.choices[i]},function commit(){this.useSelection&&this.choices[this.index]&&(this.choice=this.choices[this.index])}],listeners:[{name:"onDAOUpdate",code:function(){this.dao.select(MAP(this.objToChoice))(function(map){this.choices=map.arg2}.bind(this))},isMerged:100}]}),CLASS({"package":"foam.ui",name:"PopupView",extendsModel:"foam.ui.SimpleView",properties:[{name:"view",type:"foam.ui.View"},{name:"x"},{name:"y"},{name:"width",defaultValue:""},{name:"maxWidth",defaultValue:""},{name:"maxHeight",defaultValue:""},{name:"height",defaultValue:""}],methods:[function open(_,opt_delay){if(!this.$){var document=this.X.document,div=document.createElement("div")
div.style.left=this.x+"px",div.style.top=this.y+"px",this.width&&(div.style.width=this.width+"px"),this.height&&(div.style.height=this.height+"px"),this.maxWidth&&(div.style.maxWidth=this.maxWidth+"px"),this.maxHeight&&(div.style.maxHeight=this.maxHeight+"px"),div.style.position="absolute",div.id=this.id,div.innerHTML=this.view.toHTML(),document.body.appendChild(div),this.view.initHTML()}},function close(){this.$&&this.$.remove()},function destroy(isParentDestroyed){this.SUPER(isParentDestroyed),this.close(),this.view.destroy()}]}),CLASS({"package":"foam.core.types",name:"StringEnumProperty",extendsModel:"StringProperty",traits:["foam.core.types.EnumPropertyTrait"]}),CLASS({"package":"foam.core.types",name:"EnumPropertyTrait",properties:[{name:"choices",type:"Array",required:!0,preSet:function(_,a){return a.map(function(c){return Array.isArray(c)?c:[c,c]})},help:"Array of [value, label] choices."},{name:"view",defaultValue:"foam.ui.ChoiceView"}]}),CLASS({"package":"foam.ui",name:"IntFieldView",extendsModel:"foam.ui.AbstractNumberFieldView",methods:[function textToValue(text){return parseInt(text)||"0"},function valueToText(value){return value?value:"0"}]}),CLASS({"package":"foam.ui",name:"AbstractNumberFieldView",extendsModel:"foam.ui.TextFieldView",properties:[{name:"type",defaultValue:"number"},{name:"step"}],methods:[function extraAttributes(){return this.step?' step="'+this.step+'"':""}]}),CLASS({"package":"foam.ui",name:"FloatFieldView",extendsModel:"foam.ui.AbstractNumberFieldView",properties:[{name:"precision",defaultValue:""}],methods:[function formatNumber(val){if(!val)return"0"
val=val.toFixed(this.precision)
for(var i=val.length-1;i>0&&"0"===val.charAt(i);i--);return val.substring(0,"."===val.charAt(i)?i:i+1)},function valueToText(val){return this.hasOwnProperty("precision")?this.formatNumber(val):""+val},function textToValue(text){return parseFloat(text)||0}]}),CLASS({"package":"foam.ui",name:"DAOController",label:"DAO Controller",extendsModel:"foam.ui.View",properties:[{model_:"ModelProperty",name:"model"},{name:"subType",setter:function(v){this.model=v}},{name:"dao",view:"foam.ui.TableView"},{name:"data",getter:function(){return this.dao},setter:function(v){this.dao=v}},{name:"selection"},{model_:"BooleanProperty",name:"useSearchView",defaultValue:!1}],actions:[{name:"new",help:"Create a new record.",action:function(){var createView=this.X.DAOCreateController.create({model:this.model,dao:this.dao,showActions:!0})
createView.parentController=this,this.X.stack.pushView(createView,"New")}},{name:"edit",help:"Edit the current record.","default":"true",action:function(){this.selection=this.daoView.selection
for(var obj=this.selection,actions=this.X.DAOUpdateController.actions.slice(0),i=0;i<this.model.actions.length;i++){var action=this.model.actions[i],newAction=this.X.Action.create(action)
newAction.action=function(oldAction){return function(){oldAction.call(obj)}}(action.action),actions.push(newAction)}console.log(["selection: ",this.selection])
var updateView=this.X.DAOUpdateController.create({data:this.selection,model:this.model,dao:this.dao,showActions:!0})
this.X.stack.pushView(updateView,"Edit")}},{name:"delete",help:"Delete the current record.",action:function(){this.selection=this.daoView.selection
var self=this
this.dao.remove(this.selection)}}],methods:[function init(){this.SUPER(),this.showActions=!0},function initHTML(){this.SUPER(),this.daoView.subscribe(this.daoView.DOUBLE_CLICK,this.onDoubleClick),this.daoView.selection$.addListener(this.onSelection)}],listeners:[{name:"onDoubleClick",code:function(evt){for(var i=0;i<this.model_.actions.length;i++){var action=this.model_.actions[i]
if(action["default"]){action.action.call(this)
break}}}},{name:"onSelection",code:function(evt){var obj=this.daoView.selection
obj&&this.X.stack.setPreview(this.X.SummaryView.create({model:this.model,data:this.daoView.selection}))}}],templates:[{name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,out=opt_out?opt_out:TOC(this)
return out(" ",self.createTemplateView("dao",{model:this.model})," "),out.toString()}}]}),CLASS({"package":"foam.dao",name:"EasyDAO",extendsModel:"foam.dao.ProxyDAO",requires:["MDAO","foam.core.dao.CloningDAO","foam.core.dao.MigrationDAO","foam.core.dao.StorageDAO","foam.dao.CachingDAO","foam.dao.ContextualizingDAO","foam.dao.DeDupDAO","foam.dao.GUIDDAO","foam.dao.SeqNoDAO"],properties:[{name:"name",defaultValueFn:function(){return this.model.plural}},{model_:"BooleanProperty",name:"seqNo",defaultValue:!1},{model_:"BooleanProperty",name:"guid",label:"GUID",defaultValue:!1},{name:"seqProperty",type:"Property"},{model_:"BooleanProperty",name:"cache",defaultValue:!1},{model_:"BooleanProperty",name:"dedup",defaultValue:!1},{model_:"BooleanProperty",name:"logging",defaultValue:!1},{model_:"BooleanProperty",name:"timing",defaultValue:!1},{model_:"BooleanProperty",name:"contextualize",defaultValue:!1},{model_:"BooleanProperty",name:"cloning",defaultValue:!1},{name:"daoType",defaultValue:"foam.dao.IDBDAO"},{model_:"BooleanProperty",name:"autoIndex",defaultValue:!1},{model_:"ArrayProperty",name:"migrationRules",subType:"foam.core.dao.MigrationRule"}],constants:[{name:"ALIASES",value:{IDB:"foam.dao.IDBDAO",LOCAL:"foam.core.dao.StorageDAO",SYNC:"foam.core.dao.StorageDAO"}}],methods:[function init(args){this.SUPER(args),window.chrome&&chrome.storage&&(this.ALIASES.LOCAL="foam.core.dao.ChromeStorageDAO",this.ALIASES.SYNC="foam.core.dao.ChromeSyncStorageDAO")
var daoType="string"==typeof this.daoType?this.ALIASES[this.daoType]||this.daoType:this.daoType,daoModel="string"==typeof daoType?this.X.lookup(daoType):daoType,params={model:this.model,autoIndex:this.autoIndex}
this.name&&(params.name=this.name),(this.seqNo||this.guid)&&(params.property=this.seqProperty)
var dao=daoModel.create(params)
if(MDAO.isInstance(dao)?(this.mdao=dao,this.dedup&&(dao=this.DeDupDAO.create({delegate:dao}))):(this.migrationRules&&this.migrationRules.length&&(dao=this.MigrationDAO.create({delegate:dao,rules:this.migrationRules,name:this.model.name+"_"+daoModel.name+"_"+this.name},this.Y)),this.cache&&(this.mdao=this.MDAO.create(params),dao=this.CachingDAO.create({cache:this.dedup?this.mdao:this.DeDupDAO.create({delegate:this.mdao}),src:dao,model:this.model}))),this.seqNo&&this.guid)throw"EasyDAO 'seqNo' and 'guid' features are mutually exclusive."
if(this.seqNo){var args={__proto__:params,delegate:dao,model:this.model}
this.seqProperty&&(args.property=this.seqProperty),dao=this.SeqNoDAO.create(args)}if(this.guid){var args={__proto__:params,delegate:dao,model:this.model}
this.seqProperty&&(args.property=this.seqProperty),dao=this.GUIDDAO.create(args)}this.contextualize&&(dao=this.ContextualizingDAO.create({delegate:dao})),this.cloning&&(dao=this.CloningDAO.create({delegate:dao})),this.timing&&(dao=TimingDAO.create(this.name+"DAO",dao)),this.logging&&(dao=LoggingDAO.create(dao)),this.delegate=dao},function addIndex(){return this.mdao&&this.mdao.addIndex.apply(this.mdao,arguments),this},function addRawIndex(){return this.mdao&&this.mdao.addRawIndex.apply(this.mdao,arguments),this}],help:"A facade for easy DAO setup."}),CLASS({"package":"foam.core.dao",name:"CloningDAO",extendsModel:"foam.dao.ProxyDAO",properties:[{model_:"BooleanProperty",name:"onSelect",defaultValue:!1}],methods:[function select(sink,options){if(!this.onSelect)return this.SUPER(sink,options)
sink=sink||[].sink
var future=afuture()
return this.delegate.select({put:function(obj,s,fc){obj=obj.deepClone(),sink.put&&sink.put(obj,s,fc)},error:function(){sink.error&&sink.error.apply(sink,argumentS)},eof:function(){sink.eof&&sink.eof(),future.set(sink)}},options),future.get},function find(key,sink){return this.SUPER(key,{put:function(o){var clone=o.deepClone()
sink&&sink.put&&sink.put(clone)},error:sink&&sink.error&&sink.error.bind(sink)})}]}),CLASS({"package":"foam.core.dao",name:"MigrationDAO",extendsModel:"foam.dao.ProxyDAO",requires:["foam.core.dao.MigrationRule","foam.dao.FutureDAO","foam.dao.DAOVersion"],imports:["daoVersionDao"],properties:[{name:"delegate"},{model_:"ArrayProperty",name:"rules",subType:"foam.core.dao.MigrationRule"},{name:"name"}],methods:[function init(){var dao=this.delegate,future=afuture()
this.delegate=this.FutureDAO.create({future:future.get})
var self=this,version
aseq(function(ret){self.daoVersionDao.find(self.name,{put:function(c){version=c,ret()},error:function(){version=self.DAOVersion.create({name:self.name,version:0}),ret()}})},function(ret){function updateVersion(ret,v){var c=version.clone()
c.version=v,self.daoVersionDao.put(c,ret)}var rulesDAO=self.rules.dao
rulesDAO.where(AND(GT(self.MigrationRule.VERSION,version.version))).select()(function(rules){for(var seq=[],i=0;i<rules.length;i++)!function(rule){seq.push(aseq(function(ret){rule.migration(ret,dao)},function(ret){updateVersion(ret,rule.version)}))}(self.rules[i])
seq.length>0?aseq.apply(null,seq)(ret):ret()})})(function(){future.set(dao)}),this.SUPER()}]}),CLASS({"package":"foam.core.dao",name:"MigrationRule",ids:["modelName"],properties:[{model_:"StringProperty",name:"modelName"},{model_:"IntProperty",name:"version"},{model_:"FunctionProperty",name:"migration"}]}),CLASS({"package":"foam.dao",name:"DAOVersion",ids:["name"],properties:[{name:"name"},{name:"version"}]}),CLASS({"package":"foam.core.dao",name:"StorageDAO",extendsModel:"MDAO",properties:[{name:"name",label:"Store Name",type:"String",defaultValueFn:function(){return this.model.plural}}],methods:[function init(){this.SUPER()
var objs=localStorage.getItem(this.name)
objs&&JSONUtil.parse(this.Y,objs).select(this),this.addRawIndex({execute:function(){},bulkLoad:function(){},toString:function(){return"StorageDAO Update"},plan:function(){return{cost:Number.MAX_VALUE}},put:this.updated,remove:this.updated})}],listeners:[{name:"updated",code:function(){this.select()(function(a){localStorage.setItem(this.name,JSONUtil.compact.where(NOT_TRANSIENT).stringify(a))}.bind(this))},isMerged:100}]}),CLASS({"package":"foam.dao",name:"CachingDAO",extendsModel:"foam.dao.ProxyDAO",requires:["foam.dao.FutureDAO"],properties:[{name:"src"},{name:"cache",getter:function(){return this.delegate},setter:function(dao){this.delegate=dao},help:"Alias for delegate."},{name:"model",defaultValueFn:function(){return this.src.model||this.cache.model}}],methods:[function init(){this.SUPER()
var src=this.src,cache=this.cache,futureDelegate=afuture()
this.cache=this.FutureDAO.create({future:futureDelegate.get}),src.select(cache)(function(){src.listen(cache),futureDelegate.set(cache),this.cache=cache}.bind(this))},function put(obj,sink){this.src.put(obj,sink)},function remove(query,sink){this.src.remove(query,sink)},function removeAll(sink,options){return this.src.removeAll(sink,options)}]}),CLASS({"package":"foam.dao",name:"ContextualizingDAO",extendsModel:"foam.dao.ProxyDAO",methods:[function find(id,sink){var X=this.Y
this.delegate.find(id,{put:function(o){o.X=X,sink&&sink.put&&sink.put(o)},error:function(){sink&&sink.error&&sink.error.apply(sink,arguments)}})}]}),CLASS({"package":"foam.dao",name:"DeDupDAO",extendsModel:"foam.dao.ProxyDAO",methods:[function put(obj,sink){this.dedup(obj),this.delegate.put(obj,sink)},function dedup(obj){var inst=obj.instance_
for(var key in inst){var val=inst[key]
"string"==typeof val&&(inst[key]=val.intern())}}]}),CLASS({"package":"foam.dao",name:"GUIDDAO",label:"foam.dao.GUIDDAO",extendsModel:"foam.dao.ProxyDAO",properties:[{name:"property",type:"Property",required:!0,hidden:!0,"transient":!0,defaultValueFn:function(){return this.delegate.model?this.delegate.model.ID:void 0}}],methods:[function put(obj,sink){obj.hasOwnProperty(this.property.name)||(obj[this.property.name]=createGUID()),this.delegate.put(obj,sink)}]}),CLASS({"package":"foam.dao",name:"SeqNoDAO",label:"foam.dao.SeqNoDAO",extendsModel:"foam.dao.ProxyDAO",properties:[{name:"property",type:"Property",required:!0,hidden:!0,"transient":!0,defaultValueFn:function(){return this.delegate.model?this.delegate.model.ID:void 0}},{model_:"IntProperty",name:"sequenceValue",defaultValue:1}],methods:[function init(){this.SUPER()
var future=afuture()
this.WHEN_READY=future.get,this.delegate.select(MAX(this.property))(function(max){max.max&&(this.sequenceValue=max.max+1),future.set(!0)}.bind(this))},function put(obj,sink){this.WHEN_READY(function(){var val=this.property.f(obj)
val&&val!=this.property.defaultValue||(obj[this.property.name]=this.sequenceValue++),this.delegate.put(obj,sink)}.bind(this))}]}),CLASS({"package":"foam.dao",name:"IDBDAO",label:"IndexedDB DAO",extendsModel:"AbstractDAO",properties:[{name:"model",type:"Model",required:!0},{name:"name",label:"Store Name",type:"String",defaultValueFn:function(){return this.model.plural}},{model_:"BooleanProperty",name:"useSimpleSerialization",defaultValue:!0},{model_:"StringArrayProperty",name:"indicies"}],methods:[function init(){this.SUPER()
for(var propKeys=this.propKeys_={},properties=this.model.getRuntimeProperties(),i=0;i<properties.length;i++){var prop=properties[i]
propKeys[prop.name]=prop.name,prop.shortName&&(propKeys[prop.shortName]=prop.name)}this.useSimpleSerialization?(this.serialize=this.SimpleSerialize,this.deserialize=this.SimpleDeserialize):(this.serialize=this.FOAMSerialize,this.deserialize=this.FOAMDeserialize),this.withDB=amemo(this.openDB.bind(this))},function FOAMDeserialize(json){return JSONToObject.visitObject(json)},function FOAMSerialize(obj){return ObjectToJSON.visitObject(obj)},function SimpleDeserialize(json){var obj=this.model.create()
for(var key in json){var key2=this.propKeys_[key]
key2&&(obj[key2]=json[key])}return obj},function SimpleSerialize(obj){var s={}
for(var key in obj.instance_){var prop=obj.model_.getProperty(key),val=obj.instance_[key]
prop["transient"]||val===prop.defaultValue||(s[prop.shortName||prop.name]=val)}return s},function openDB(cc){var indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB,request=indexedDB.open("FOAM:"+this.name,1)
request.onupgradeneeded=function(e){for(var store=e.target.result.createObjectStore(this.name),i=0;i<this.indicies.length;i++)store.createIndex(this.indicies[i][0],this.indicies[i][0],{unique:this.indicies[i][1]})}.bind(this),request.onsuccess=function(e){cc(e.target.result)}.bind(this),request.onerror=function(e){console.log("************** failure",e)}},function withStore(mode,fn){if("readwrite"!==mode)return this.withStore_(mode,fn)
var self=this
if(this.q_)this.q_.push(fn),1e4==this.q_.length&&(this.q_=void 0)
else{var q=[fn]
this.q_=q,EventService.async(function(){self.withStore_(mode,function(store){self.q_==q&&(self.q_=void 0)
for(var i=0;i<q.length;i++)q[i](store)})},this.X)()}},function withStore_(mode,fn){if(GLOBAL.__TXN__&&GLOBAL.__TXN__.store)try{return void fn.call(this,__TXN__.store)}catch(x){GLOBAL.__TXN__=void 0}this.withDB(function(db){var tx=db.transaction([this.name],mode),os=tx.objectStore(this.name)
GLOBAL.__TXN__&&(GLOBAL.__TXN__.store=os),fn.call(this,os)}.bind(this))},function put(value,sink){var self=this
this.withStore("readwrite",function(store){var request=store.put(self.serialize(value),value[self.model.ids[0]])
request.transaction.addEventListener("complete",function(e){self.notify_("put",[value]),sink&&sink.put&&sink.put(value)}),request.transaction.addEventListener("error",function(e){sink&&sink.error&&sink.error("put",value)})})},function find(key,sink){if(Expr.isInstance(key)){var found=!1
return void this.limit(1).where(key).select({put:function(){found=!0,sink.put.apply(sink,arguments)},eof:function(){found||sink.error("find",key)}})}var self=this
this.withStore("readonly",function(store){var request=store.get(key)
request.transaction.addEventListener("complete",function(){if(!request.result)return void(sink&&sink.error&&sink.error("find",key))
var result=self.deserialize(request.result)
sink&&sink.put&&sink.put(result)}),request.onerror=function(e){sink&&sink.error&&sink.error("find",key)}})},function remove(obj,sink){var self=this,key=void 0!=obj[this.model.ids[0]]?obj[this.model.ids[0]]:obj
this.withStore("readwrite",function(store){var getRequest=store.get(key)
getRequest.onsuccess=function(e){if(!getRequest.result)return void(sink&&sink.error&&sink.error("remove",obj))
var data=self.deserialize(getRequest.result),delRequest=store["delete"](key)
delRequest.transaction.addEventListener("complete",function(e){self.notify_("remove",[data]),sink&&sink.remove&&sink.remove(data)}),delRequest.onerror=function(e){sink&&sink.error&&sink.error("remove",e)}},getRequest.onerror=function(e){sink&&sink.error&&sink.error("remove",e)}})},function removeAll(sink,options){var query=options&&options.query&&options.query.partialEval()||{f:function(){return!0}},future=afuture(),self=this
return options||sink&&sink.remove?(this.withStore("readwrite",function(store){var request=store.openCursor()
request.onsuccess=function(e){var cursor=e.target.result
if(cursor){var value=self.deserialize(cursor.value)
if(query.f(value)){var deleteReq=cursor["delete"]()
deleteReq.transaction.addEventListener("complete",function(){self.notify_("remove",[value]),sink&&sink.remove&&sink.remove(value)}),deleteReq.onerror=function(e){sink&&sink.error&&sink.error("remove",e)}}cursor["continue"]()}},request.transaction.oncomplete=function(){sink&&sink.eof&&sink.eof(),future.set(sink)},request.onerror=function(e){sink&&sink.error&&sink.error("remove",e)}}),future.get):(this.withStore("readwrite",function(store){var req=store.clear()
req.onsuccess=function(){future.set()},req.onerror=function(){future.set()}}),future.get)},function select(sink,options){sink=sink||[].sink,sink=this.decorateSink_(sink,options,!1)
var fc=this.createFlowControl_(),future=afuture(),self=this
return this.withStore("readonly",function(store){if(options&&options.query&&EqExpr.isInstance(options.query)&&store.indexNames.contains(options.query.arg1.name))var request=store.index(options.query.arg1.name).openCursor(IDBKeyRange.only(options.query.arg2.f()))
else var request=store.openCursor()
request.onsuccess=function(e){var cursor=e.target.result
if(!fc.stopped){if(fc.errorEvt)return sink.error&&sink.error(fc.errorEvt),void future.set(sink,fc.errorEvt)
if(!cursor)return sink.eof&&sink.eof(),void future.set(sink)
var value=self.deserialize(cursor.value)
sink.put(value),cursor["continue"]()}},request.onerror=function(e){sink.error&&sink.error(e)}}),future.get},function addIndex(prop){return this.indicies.push([prop.name,!1]),this}],listeners:[{name:"updated",code:function(evt){console.log("updated: ",evt),this.publish("updated")}}]}),CLASS({"package":"foam.ui.md",name:"ActionLabel",extendsModel:"foam.ui.SimpleView",properties:[{name:"action"},{name:"data"},{name:"className",factory:function(){return"actionLabel actionLabel-"+this.action.name}}],listeners:[{name:"onClick",code:function(e){this.action.maybeCall(this.X,this.data,e)}},{name:"isAvailable",code:function(){return this.action.isAvailable.call(this.data,this.action)}},{name:"isDisabled",code:function(){return!this.action.isEnabled.call(this.data,this.action)}}],templates:[{name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,out=opt_out?opt_out:TOC(this)
return out('<i id="',self.id,'" ',this.cssClassAttr(),">",escapeHTML(this.action.label),"</i>"),this.on("click",this.onClick,this.id),this.setClass("available",this.isAvailable,this.id),this.setClass("disabled",this.isDisabled,this.id),out(""),out.toString()}}]}),CLASS({"package":"foam.ui.md",name:"SharedStyles",extendsModel:"foam.ui.SimpleView",templates:[{name:"CSS",code:ConstantTemplate("\nbody {\nfont-family: Roboto, 'Helvetica Neue', Helvetica, Arial;\n}\n\ntable {\nborder-spacing: 0;\n}\n\n* {\nbox-sizing: border-box;\n}\n\nbody, tbody, tr, td {\nmargin: 0;\npadding: 0;\n}\n\nhr {\nborder-top: 1px solid rgba(0,0,0,.1);\nborder: none;\nheight: 1px;\nmargin: 0;\npadding: 0;\nbackground: rgba(0,0,0,.1);\n}\n\na {\ntext-decoration: none;\ncolor: #4285f4;\n}\n\n.mdui-app-controller {\nbackground: white;\ndisplay: flex;\ndisplay: -webkit-flex;\nflex-direction: column;\n-webkit-flex-direction: column;\nheight: 100%;\n}\n\n.mdui-app-controller .header {\ndisplay: flex;\ndisplay: -webkit-flex;\nbackground: #3e50b4;\nflex-shrink: 0;\n-webkit-flex-shrink: 0;\npadding: 0;\nheight: 56px;\n}\n\n.mdui-app-controller .header .default {\nflex: 1.0;\n-webkit-box-flex: 1.0;\ndisplay: flex;\ndisplay: -webkit-flex;\nmargin: 4px;\nflex-grow: 1.0;\n-webkit-flex-grow: 1.0;\n}\n\n.mdui-app-controller.searchMode .header {\nheight: 50px;\n}\n\n.mdui-app-controller.searchMode .header .default {\ndisplay: none;\n}\n\n.mdui-app-controller:not(.searchMode) .header .search {\ndisplay: none;\n}\n\n.mdui-app-controller.searchMode .header .search {\ndisplay: inherit;\nheight: 50px;\nwidth: 100%;\nbackground: #3e50b4;\nz-index: 2;\n}\n\n.swipeAltInner {\noverflow: hidden;\n}\n\n.mdui-app-controller.searchMode .swipeAltHeader {\ndisplay: none;\n}\n\n.mdui-app-controller .header .name {\n-webkit-align-self: center;\n-webkit-box-flex: 1.0;\n-webkit-flex-grow: 1.0;\nalign-self: center;\ncolor: white;\nflex-grow: 1.0;\nflex: 1.0;\nfont-size: 20px;\nfont-weight: 500;\nmargin-left: 16px;\noverflow-x: hidden;\ntext-overflow: ellipsis;\nvertical-align: middle;\nwhite-space: nowrap;\n}\n\ninput[name=q] {\n-webkit-align-self: center;\nalign-self: center;\nbackground: #3e50b4;\nborder: none;\ncolor: white;\nfont-size: 20px;\nheight: 30px;\nmargin: 13px 20px 13px 6px;\npadding-left: 10px;\nwidth: 100%;\n}\n\ninput[name=q]:focus {\noutline: none;\nopacity: 0.76;\n}\n\ninput[name=q]::-webkit-input-placeholder {\nfont-size: 20px;\ncolor: white;\nopacity: 0.76;\nheight: 55px;\n}\n\n.backButton {\nmargin: 3px 6px 2px 4px;\n}\n\n.header canvas {\nbackground: #3e50b4\n}\n\n.body canvas {\nbackground: white;\n}\n\n.popupChoiceView {\npadding: 0;\n}\n\n.md-floating-label-container {\nalign-items: center;\ndisplay: flex;\npadding: 36px 16px 8px;\nposition: relative;\n}\n\n.md-floating-label {\ncolor: #999;\nflex-grow: 1;\nfont-size: 12px;\nfont-weight: 500;\nposition: absolute;\ntop: 16px;\nz-index: 0;\n}\n\ncanvas.createButton {\nposition: absolute;\nbottom: 10px;\nright: 20px;\nz-index: 10;\nbackground: rgba(0,0,0,0);\nbox-shadow: 3px 3px 3px #aaa;\nborder-radius: 30px;\n}\n\n\n.md-card-shell {\ndisplay: block;\nbackground: #fff;\nmargin: 10px;\n}\n\n.md-card {\nbackground: #fff;\ndisplay: block;\nmargin: 10px;\npadding: 10px;\n}\n\n.md-card p, .md-card-shell p {\nwidth: initial;\n}\n\n.md-style-trait-standard {\npadding: 8px;\nmargin: 8px;\n}\n\n.md-style-trait-inline {\npadding: 0px;\n}\n\n\n@media not print {\n.md-card-shell, .md-card {\nbox-shadow: 0 1px 3px rgba(0, 0, 0, 0.38);\nmargin: 10px;\nborder-radius: 3px;\n}\n}\n\n@media print {\n.md-card-shell, .md-card {\nborder: 6px double #000;\nmargin: 6pt;\npage-break-inside: avoid;\n}\n}\n")}]}),CLASS({"package":"foam.ui.md",name:"TableView",extendsModel:"foam.ui.SimpleView",requires:["foam.ui.TableView","foam.ui.md.EditColumnsView"],imports:["hardSelection$"],properties:[{model_:"BooleanProperty",name:"editColumnsEnabled",defaultValue:!1},{model_:"StringProperty",name:"title",defaultValue:"Table",postSet:function(old,nu){!this.hardSelection&&this.$&&old!==nu&&this.updateTableCaption()}},{name:"data",postSet:function(old,nu){this.X.model||old===nu||nu&&nu.model&&(this.model=nu.model)}},{model_:"StringArrayProperty",name:"properties"},{name:"model",lazyFactory:function(){return this.X.model||this.data&&this.data.model}},{name:"hardSelection",defaultValue:null,postSet:function(old,nu){old!==nu&&(this.actions=nu?this.hardSelection.model_.actions.concat(this.model_.actions):this.model_.actions,this.$&&(this.updateTableCaption(),this.updateTableActions(),this.initInnerHTML()))}},{model_:"ArrayProperty",name:"actions",lazyFactory:function(){return this.hardSelection?this.hardSelection.model_.actions:this.model_.actions},subType:"Action"},{name:"table",lazyFactory:function(){return this.TableView.create({scrollEnabled:!0,className:"mdTable",ascIcon:'<i class="material-icons">keyboard_arrow_up</i>',descIcon:'<i class="material-icons">keyboard_arrow_down</i>',model$:this.model$,data$:this.data$,properties$:this.properties$})}},{name:"columnSelectionView",lazyFactory:function(){return this.EditColumnsView.create({model$:this.model$,properties$:this.properties$})}}],actions:[{name:"clearSelection",label:"clear_all",isAvailable:function(){return!!this.hardSelection},action:function(X,action,e){this.hardSelection=null}},{name:"editColumns",label:"more_vert",action:function(X,action){this.columnSelectionView.isOpen||this.columnSelectionView.open()}}],methods:[function getModel(){return this.X.model||this.data&&this.data.model},function updateTableCaption(){var out=TemplateOutput.create(this)
this.tableCaptionHTML(out),this.$.querySelector("table-caption").innerHTML=out.toString()},function updateTableActions(){for(var children=this.children,i=0;i<children.length;++i){var child=children[i]
Action.isInstance(child.action)&&this.removeChild(child)}var out=TemplateOutput.create(this)
this.tableActionsHTML(out),this.$.querySelector("table-actions").innerHTML=out.toString()},function createActionView(action,args){var view=this.SUPER(action,args)
return view.data=this.hardSelection&&!this.isViewAction(action)?this.hardSelection:this,view},function isViewAction(action){return this.model_.actions.some(function(a){return a===action})}],templates:[{name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,out=opt_out?opt_out:TOC(this)
return out('\n      <md-table id="',self.id,'">\n        <table-header id="',this.setClass("selection",function(){return!!this.hardSelection}),'">\n          <table-caption>\n            '),this.tableCaptionHTML(out),out("\n          </table-caption>\n          <table-actions>"),this.tableActionsHTML(out),out("</table-actions>\n          ",self.columnSelectionView,"\n        </table-header>\n        ",self.table,"\n      </md-table>\n    "),out.toString()}},{name:"tableCaptionHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,out=opt_out?opt_out:TOC(this)
return out("\n      "),this.title&&!this.hardSelection?out("\n        ",self.title,"\n      "):this.hardSelection&&out("\n        1 item selected\n      "),out("\n    "),out.toString()}},{name:"tableActionsHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,out=opt_out?opt_out:TOC(this)
out("")
for(var i=0;i<this.actions.length;++i){var action=this.actions[i],view=this.createActionView(action)
this.addChild(view),out(view)}return out(""),out.toString()}},{name:"CSS",code:ConstantTemplate("md-table {\ndisplay: flex;\nflex-direction: column;\n}\n\nmd-table table-caption {\ndisplay: block;\nfont-size: 20px;\nfont-weight: 500;\ncolor: rgba(0, 0, 0, 0.87);\n}\n\nmd-table table-header {\nflex-shrink: 0;\ndisplay: flex;\nalign-items: center;\njustify-content: space-between;\nheight: 64px;\nposition: relative;\n}\n\nmd-table table-header.selection {\nbackground: rgb(232,240,253);\n}\n\nmd-table table-header table-caption {\npadding-left: 24px;\n}\n\nmd-table table-header.selection table-caption {\ncolor: rgb(72,131,239);\n}\n\nmd-table table-header table-actions {\ndisplay: block;\npadding-right: 14px;\n}\n\nmd-table table-header table-actions i {\ncursor: pointer;\ndisplay: block;\nmargin-left: 24px;\nfont-size: 24px;\ncolor: rgba(0, 0, 0, 0.54);\n}\n\n.mdTable {\nborder-collapse: collapse;\nfont-family: 'Roboto', sans-serif;\ntable-layout:fixed;\ntext-align: left;\nwidth: 100%;\n}\n\n.mdTable thead {\ncolor: rgba(0, 0, 0, 0.54);\nfont-size: 12px;\nfont-weight: 500;\n}\n\n.mdTable tbody {\ncolor: rgba(0, 0, 0, 0.87);\nfont-size: 13px;\nfont-weight: 400;\n}\n\n.mdTable tbody {\nborder-top: solid 1px #DDDDDD;\n}\n\n.mdTable tbody tr {\nborder-bottom: solid 1px #DDDDDD;\ncursor: pointer;\n}\n\ntr:first-child {\npadding-left: 24px;\n}\n\n.mdTable thead tr th {\ncursor: pointer;\n}\n\n.mdTable tbody tr:hover,\n.mdTable tbody tr.rowSoftSelected {\nbackground: #EEEEEE;\n}\n\n.mdTable tr.rowSelected {\nbackground: #F5F5F5;\n}\n\n.mdTable .numeric {\ntext-align: right;\n}\n\n.mdTable thead th {\nheight: 64px;\n}\n\n.mdTable tbody tr td {\nheight: 48px;\n}\n\n.mdTable thead th,\n.mdTable tbody td {\nwhite-space: nowrap;\noverflow: hidden;\ntext-overflow: ellipsis;\n}\n\n.mdTable th.sort {\nfont-size: 12px;\nfont-weight: 500;\ncolor: rgba(0, 0, 0, 0.87);\n}\n\n.mdTable th.sort .material-icons {\nfont-size: 16px;\ncolor: rgba(0, 0, 0, 0.26);\n}\n\ni.material-icons.actionLabel.available {\ndisplay: inline-block;\n}\n\ni.material-icons.actionLabel {\ndisplay: none;\n}\n\n.mdTable thead tr th,\n.mdTable tbody tr td {\npadding-left: 24px;\npadding-right: 24px;\n}\n")}]}),CLASS({"package":"foam.ui",name:"TableView",label:"Table View",extendsModel:"foam.ui.AbstractDAOView",requires:["foam.graphics.ScrollCView","foam.ui.EditColumnsView","foam.input.touch.GestureTarget"],imports:["hardSelection$","softSelection$ as selection$"],properties:[{name:"model",type:"Model",defaultValueFn:function(){return this.X.model||this.data&&this.data.model}},{model_:"StringProperty",name:"className",lazyFactory:function(){return"foamTable "+this.model.name+"Table"}},{model_:"StringArrayProperty",name:"properties",postSet:function(){this.paintTable()}},{name:"hardSelection",postSet:function(_,v){this.publish(this.ROW_SELECTED,v)}},{name:"selection"},{name:"children",type:"Array[View]",factory:function(){return[]}},{name:"sortOrder",type:"Comparator",defaultValue:"",postSet:function(){this.paintTable()}},{name:"sortProp",defaultValue:""},{name:"ascIcon",defaultValue:"&#9650;"},{name:"descIcon",defaultValue:"&#9660;"},{name:"rows",type:"Int",defaultValue:50,postSet:function(oldValue,newValue){oldValue!==newValue&&this.paintData()}},{model_:"IntProperty",name:"height"},{model_:"BooleanProperty",name:"scrollEnabled",defaultValue:!1},{model_:"BooleanProperty",name:"columnResizeEnabled",defaultValue:!1},{model_:"BooleanProperty",name:"editColumnsEnabled",defaultValue:!1},{name:"scrollbar",type:"ScrollCView",factory:function(){return this.ScrollCView.create({height:800,width:24,x:1,y:0,size:200,extent:10})},postSet:function(old,nu){old!==nu&&(old&&old.value$.removeListener(this.paintData),nu&&nu.value$.addListener(this.paintData))}},{name:"scrollPitch",defaultValue:10,help:"Number of (CSS) pixels of touch drag required to scroll by one"},{name:"touchPrev",hidden:!0,"transient":!0,defaultValue:0},{model_:"ArrayProperty",name:"selectionListeners_",lazyFactory:function(){return[]}},{model_:"ArrayProperty",name:"hardSelectionListeners_",lazyFactory:function(){return[]}},{model_:"IntProperty",name:"mouseX",defaultValue:0},{model_:"IntProperty",name:"mouseY",defaultValue:0},{model_:"BooleanProperty",name:"mouseOverRow",defaultValue:!1},{name:"$container",defaultValueFn:function(){return this.$&&this.$.parentElement.parentElement},postSet:function(old,nu){old!==nu&&this.onResize()}},{name:"$table",defaultValueFn:function(){return this.$&&this.$.querySelector("table")}},{name:"$thead",defaultValueFn:function(){return this.$&&this.$.querySelector("thead")}},{name:"$tbody",defaultValueFn:function(){return this.$&&this.$.querySelector("tbody")}}],actions:[{name:"selectRow",action:function(){this.selection&&(this.hardSelection=this.selection),this.publish(this.CLICK,this.selection)},keyboardShortcuts:[13]},{name:"prevRow",action:function(){if(this.objs&&this.objs.length){if(!this.selection&&this.hardSelection&&(this.selection=this.hardSelection),this.selection){var i=this.objs.indexOf(this.selection)
this.scrollbar.value--,i>0&&(this.selection=this.objs[i-1])}else this.selection=this.objs[0]
this.paintData()}},keyboardShortcuts:[38,75]},{name:"nextRow",action:function(){if(this.objs&&this.objs.length){if(!this.selection&&this.hardSelection&&(this.selection=this.hardSelection),this.selection){var i=this.objs.indexOf(this.selection)
this.scrollbar.value++,i<this.objs.length-1&&(this.selection=this.objs[i+1])}else this.selection=this.objs[0]
this.paintData()}},keyboardShortcuts:[40,74]}],constants:[{name:"MIN_COLUMN_SIZE",value:5},{name:"ROW_SELECTED",value:["escape"]},{name:"CLICK",value:"click"},{name:"DOUBLE_CLICK",value:"double-click"}],methods:[function initHTML(){if(this.SUPER(),this.scrollbar.toView_().initHTML(),this.dao&&this.onDAOUpdate(),this.$table.onmousemove=this.onMouseMove,this.scrollEnabled){(this.window||window).addEventListener("resize",this.onResize,!1)
var sb=this.scrollbar
this.$.parentElement.onmousewheel=function(e){sb.value=Math.min(sb.size-sb.extent,Math.max(0,sb.value-Math.round(e.wheelDelta/20))),e.preventDefault()},this.X.gestureManager&&this.X.gestureManager.install(this.GestureTarget.create({containerID:this.id,handler:this,getElement:function(){return this.container.$.parentElement},gesture:"verticalScroll"})),this.onResize()}},function repaintTable(){if(this.$){var table=this.$table,out=TemplateOutput.create()
table?(this.tableHeadToHTML(out),this.tableDataToHTML(out),table.innerHTML=out.toString()):(this.tableToHTML(out),this.$.innerHTML=out.toString()),this.initHTML_()}},function repaintTableData(){var tbody=this.$tbody
if(!tbody)return void this.repaintTable()
var out=TemplateOutput.create()
this.tableDataToHTML(out),tbody.outerHTML=out.toString(),this.initHTML_()},function gatherObjects(ret){var dao=this.dao
dao&&(dao=dao.skip(this.scrollbar.value),this.sortOrder&&(dao=dao.orderBy(this.sortOrder)),dao.limit(this.rows).select()(function(objs){this.objs=objs,ret.call(this,objs)}.bind(this)))},function tableToHTML(out){var model=this.model
if(!model)return out("<b>ERROR: Table view without model</b>"),out
this.initializers_&&(delete this.initializers_,this.children=[]),out("<table"+this.cssClassAttr()+' style="position:relative">'),this.tableHeadToHTML(out)
var dataState=this.tableDataToHTML(out)
return out("</table>"),out},function tableHeadToHTML(out){var model=this.model
out("<thead><tr>")
for(var properties=this.getProperties(),i=0;i<properties.length;i++){var prop=properties[i]
if(prop&&!prop.hidden){out('<th style="position:relative;" scope=col '),out("id="+this.on("click",function(table,prop){return function(){table.sortProp=prop,table.sortOrder=table.sortOrder===prop?DESC(prop):prop}}(this,prop))),prop.tableWidth&&out(' width="'+prop.tableWidth+'"')
var cssClasses=[],isNumeric=IntProperty.isInstance(prop)||FloatProperty.isInstance(prop),isSorted=this.sortProp===prop
if(isNumeric&&cssClasses.push("numeric"),isSorted&&cssClasses.push("sort"),cssClasses.length>0&&out(' class="'+cssClasses.join(" ")+'"'),out(">"),isSorted){var arrow='<span class="indicator">'+(this.sortOrder===prop?this.ascIcon:this.descIcon)+"</span>"
out(isNumeric?arrow+" "+prop.tableLabel:prop.tableLabel+" "+arrow)}else out(prop.tableLabel)
this.columnResizeEnabled&&out(this.columnResizerToHTML(prop,properties[i+1])),out("</th>")}}return this.editColumnsEnabled&&out('<th width=15 id="'+this.on("click",this.onEditColumns)+'">...</th>'),out('</tr><tr style="height:2px"></tr></thead>'),out},function tableDataToHTML(out){out("<tbody>")
var props=this.getProperties(),objs=this.objs
if(objs)for(var hselect=this.hardSelection,sselect=this.selection,i=0;i<objs.length;i++){var obj=objs[i],trClassName="tr-"+this.id
hselect&&obj.id==hselect.id&&(trClassName+=" rowSelected"),sselect&&obj.id==sselect.id&&(trClassName+=" rowSoftSelected"),out('<tr class="'+trClassName+'">')
for(var j=0;j<props.length;j++){var prop=props[j],tdClassName=prop.name+(IntProperty.isInstance(prop)||FloatProperty.isInstance(prop)?" numeric":"")
out(j==props.length-1&&this.editColumnsEnabled?'<td colspan=2 class="'+tdClassName+'">':'<td class="'+tdClassName+'">')
var val=obj[prop.name]
out(prop.tableFormatter?prop.tableFormatter(val,obj,this):null==val?"&nbsp;":this.strToHTML(val)),out("</td>")}out("</tr>")}return out("</tbody>"),out},function columnResizerToHTML(prop1,prop2){var id=this.nextID()
return this.on("click",function(e){e.stopPropagation()},id),this.on("mousedown",function(e){function onMouseMove(e){var delta=e.x-startX
col1.width=w1+(prop2?Math.min(w2,delta):delta),prop2&&(col2.width=w2+Math.min(-delta,w1))}var self=this,startX=e.x,col1=self.X.$(id).parentElement,col2=self.X.$(id).parentElement.nextSibling,w1=toNum(col1.width),w2=prop2?toNum(col2.width):0
e.preventDefault()
var onMouseUp=function(e){e.preventDefault(),toNum(col1.width)<this.MIN_COLUMN_SIZE?this.properties=this.getPropertyNames().deleteF(prop1.name):prop1.tableWidth=col1.width,prop2&&(toNum(col2.width)<this.MIN_COLUMN_SIZE?this.properties=this.getPropertyNames().deleteF(prop2.name):prop2.tableWidth=col2.width),this.X.document.removeEventListener("mousemove",onMouseMove),this.X.document.removeEventListener("mouseup",onMouseUp)}.bind(this)
this.X.document.addEventListener("mousemove",onMouseMove),this.X.document.addEventListener("mouseup",onMouseUp)},id),'<div id="'+id+'" class="columnResizeHandle" style="top:0;z-index:9;cursor:ew-resize;position:absolute;right:-3px;width:6px;height:100%"><div>'},function initHTML_(){this.initHTML.super_.call(this)
var self=this,trs=argsToArray(this.X.$$("tr-"+this.id))
this.resetRowListeners_(trs),trs.forEach(function(e,i){var obj=self.objs[i]
if(e.onmouseover=function(){self.mouseOverRow=!0,self.selection=obj},e.onmouseout=function(){self.mouseOverRow=!1,self.selection=""},e.onclick=function(evt){self.hardSelection=self.selection=obj,self.publish(self.CLICK,obj)},e.ondblclick=function(){self.publish(self.DOUBLE_CLICK,obj)},self.mouseOverRow){var left=e.offsetLeft,right=left+e.offsetWidth,top=e.offsetTop,bottom=top+e.offsetHeight,x=self.mouseX,y=self.mouseY
x>=left&&right>=x&&y>=top&&bottom>=y&&(self.selection=obj)}}),delete this.initializers_,this.children=[]},function resetRowListeners_(trs){var self=this
self.selectionListeners_.forEach(function(listener){self.selection$.removeListener(listener)}),self.hardSelectionListeners_.forEach(function(listener){self.hardSelection$.removeListener(listener)}),self.selectionListeners_=[],self.hardSelectionListeners_=[],trs.forEach(function(e,i){var obj=self.objs[i],sListener=function(){DOM.setClass(e,"rowSoftSelected",self.selection===obj)},hsListener=function(){DOM.setClass(e,"rowSelected",self.hardSelection===obj)}
self.selection$.addListener(sListener),self.selectionListeners_.push(sListener),self.hardSelection$.addListener(hsListener),self.hardSelectionListeners_.push(hsListener)})},function getProperties(){var model=this.model,propNames=this.getPropertyNames()
return propNames.map(function(name){return model.getProperty(name)})},function getPropertyNames(){return this.properties.length>0?this.properties:this.model.tableProperties}],listeners:[{name:"onResize",code:function(){if(this.$){var thead=this.$thead,tbody=this.$tbody,row=tbody&&tbody.firstChild
if(row){var containerHeight=this.$container.offsetHeight,headHeight=thead.offsetHeight,rowHeight=row.offsetHeight,rows=Math.floor((containerHeight-headHeight)/rowHeight)
this.rows=rows,this.scrollbar.extent=rows-1,this.scrollbar.height=containerHeight-headHeight-1,this.scrollbar.paint()}}},isMerged:200},{name:"onDAOUpdate",code:function(){this.dao.select(COUNT())(function(c){this.scrollbar.size=c.count,this.paintData()}.bind(this))},isFramed:!0},{name:"onMouseMove",code:function(e){for(var table=this.$table,target=e.target,x=e.offsetX,y=e.offsetY;target!==table;){if(!target)return
x+=target.offsetLeft,y+=target.offsetTop,target=target.offsetParent}this.mouseX=x,this.mouseY=y},isFramed:!0},{name:"paintTable",code:function(){this.gatherObjects(this.repaintTable)},isFramed:!0},{name:"paintData",code:function(){this.gatherObjects(this.repaintTableData)},isFramed:!0},{name:"onEditColumns",code:function(evt){var v=this.EditColumnsView.create({model:this.model,properties:this.getPropertyNames(),availableProperties:this.model.getRuntimeProperties().filter(function(prop){return!prop.hidden})})
v.addPropertyListener("properties",function(){v.close(),this.properties=v.properties,v.removePropertyListener("properties",arguments.callee),this.paintTable()}.bind(this)),this.$.insertAdjacentHTML("beforebegin",v.toHTML())
var y=findViewportXY(this.$)[1],screenHeight=this.X.document.firstElementChild.offsetHeight,popupHeight=toNum(v.$.offsetHeight)
10>screenHeight-y-popupHeight&&(v.$.style.maxHeight=screenHeight-y-10+"px"),v.initHTML()}},{name:"verticalScrollStart",code:function(dy,ty,y){this.touchPrev=y}},{name:"verticalScrollMove",code:function(dy,ty,y){var delta=Math.abs(y-this.touchPrev)
if(delta>this.scrollPitch){var sb=this.scrollbar
y>this.touchPrev&&sb.value>0?sb.value--:y<this.touchPrev&&sb.value<sb.size-sb.extent&&sb.value++,this.touchPrev=y}}}],templates:[{name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,out=opt_out?opt_out:TOC(this)
return out('\n      <div tabindex="99" class="tableView" style="display:flex;width:100%;">\n        <span id="',self.id,'" style="flex:1 1 100%;overflow-x:auto;overflow-y:hidden;">\n          '),this.tableToHTML(out),out("\n        </span>\n        ",this.scrollbarEnabled?'<span style="width:19px;flex:none;overflow:hidden;">'+this.scrollbar.toView_().toHTML()+"</span>":"","\n      </div>\n    "),out.toString()}}]}),CLASS({"package":"foam.graphics",name:"ScrollCView",extendsModel:"foam.graphics.CView",properties:[{name:"vertical",type:"boolean",defaultValue:!0},{model_:"IntProperty",name:"value",preSet:function(_,value){return Math.max(0,Math.min(this.size-this.extent,value))},help:"The first element being shown, starting at zero.",defaultValue:0},{model_:"IntProperty",name:"extent",help:"Number of elements shown.",defaultValue:10},{model_:"IntProperty",name:"size",postSet:function(_,size){this.value=this.value,this.paint()},help:"Total number of elements being scrolled through.",defaultValue:0},{name:"minHandleSize",type:"int",defaultValue:10,help:"Minimum size to make the drag handle."},{name:"startY",type:"int",defaultValue:0},{name:"startValue",type:"int",defaultValue:0,help:"Starting value or current drag operation."},{name:"handleColor",type:"String",defaultValue:"rgb(107,136,173)"},{name:"borderColor",type:"String",defaultValue:"#555"}],methods:[function initCView(){this.$.addEventListener("mousedown",this.mouseDown,!1),this.$.addEventListener("touchstart",this.touchStart,!1)},function paintSelf(){if(this.size){var c=this.canvas
if(c&&(this.erase(),!(this.extent>=this.size))){c.strokeStyle=this.borderColor,c.strokeRect(this.x,this.y,this.width-7,this.height),c.fillStyle=this.handleColor
var h=this.height-8,handleSize=this.extent/this.size*h
handleSize<this.minHandleSize&&(handleSize=this.minHandleSize,h-=this.minHandleSize-handleSize),c.fillRect(this.x+2,this.y+2+this.value/this.size*h,this.width-11,this.y+4+handleSize)}}}],listeners:[{name:"mouseDown",code:function(e){this.startY=e.y-e.offsetY,e.target.ownerDocument.defaultView.addEventListener("mouseup",this.mouseUp,!0),e.target.ownerDocument.defaultView.addEventListener("mousemove",this.mouseMove,!0),e.target.ownerDocument.defaultView.addEventListener("touchstart",this.touchstart,!0),this.mouseMove(e)}},{name:"mouseUp",code:function(e){e.preventDefault(),e.target.ownerDocument.defaultView.removeEventListener("mousemove",this.mouseMove,!0),e.target.ownerDocument.defaultView.removeEventListener("mouseup",this.mouseUp,!0)}},{name:"mouseMove",code:function(e){var y=e.y-this.startY
e.preventDefault(),this.value=Math.max(0,Math.min(this.size-this.extent,Math.round((y-this.y)/(this.height-4)*this.size)))}},{name:"touchStart",code:function(e){this.startY=e.targetTouches[0].pageY,this.startValue=this.value,e.target.ownerDocument.defaultView.addEventListener("touchmove",this.touchMove,!1),this.touchMove(e)}},{name:"touchEnd",code:function(e){e.target.ownerDocument.defaultView.removeEventListener("touchmove",this.touchMove,!1),e.target.ownerDocument.defaultView.removeEventListener("touchend",this.touchEnd,!1)}},{name:"touchMove",code:function(e){var y=e.targetTouches[0].pageY
e.preventDefault(),this.value=Math.max(0,Math.min(this.size-this.extent,Math.round(this.startValue+(y-this.startY)/(this.height-4)*this.size)))}}]}),CLASS({"package":"foam.ui",name:"EditColumnsView",extendsModel:"foam.ui.View",properties:[{name:"model",type:"Model"},{model_:"StringArrayProperty",name:"properties"},{model_:"ArrayProperty",name:"availableProperties"}],methods:[function toHTML(){var s='<span id="'+this.id+'" class="editColumnView" style="overflow-y: scroll;position: absolute;right: 0.96;background: white;top: 138px;border: 1px solid black;">'
s+="Show columns:",s+="<table>"
for(var i=0;i<this.properties.length;i++){var p=this.model.getProperty(this.properties[i])
s+='<tr><td id="'+this.on("click",this.onRemoveColumn.bind(this,p.name))+'">&nbsp;&#x2666;&nbsp;'+p.label+"</td></tr>"}for(var i=0;i<this.availableProperties.length;i++){var p=this.availableProperties[i];-1==this.properties.indexOf(p.name)&&(s+='<tr><td id="'+this.on("click",this.onAddColumn.bind(this,p.name))+'">&nbsp;&nbsp;&nbsp;&nbsp;'+p.label+"</td></tr>")}return s+="</table>",s+="</span>"}],listeners:[{name:"onAddColumn",code:function(propName){this.properties=this.availableProperties.filter(function(prop){return this.properties.indexOf(prop.name)>=0||prop.name===propName}.bind(this)).map(function(prop){return prop.name})}},{name:"onRemoveColumn",code:function(prop){this.properties=this.properties.deleteF(prop)}}]}),CLASS({"package":"foam.ui",name:"AbstractDAOView",extendsModel:"foam.ui.SimpleView",exports:["dao$ as daoViewCurrentDAO$"],properties:[{name:"data",postSet:function(oldDAO,dao){this.dao!==dao&&(this.dao=dao)}},{model_:"foam.core.types.DAOProperty",name:"dao",label:"DAO",postSet:function(oldDAO,dao){dao?this.data!==dao&&(this.data=dao):this.data=""},help:"An alias for the data property.",onDAOUpdate:"onDAOUpdate"}],methods:[function onDAOUpdate(){}]}),CLASS({"package":"foam.ui.md",name:"EditColumnsView",extendsModel:"foam.ui.SimpleView",imports:["document","window"],properties:[{model_:"ModelProperty",name:"model",required:!0,postSet:function(old,nu){old!==nu&&(console.log("setting model",nu),nu&&(this.availableProperties=nu.tableProperties.map(function(propName){return nu.getProperty(propName)}.bind(this))))}},{model_:"StringArrayProperty",name:"properties",postSet:function(){this.$&&(this.$.innerHTML=this.toInnerHTML(),this.initInnerHTML())}},{model_:"ArrayProperty",name:"availableProperties",lazyFactory:function(){return[]}},{model_:"BooleanProperty",name:"isOpen",defaultValue:!1},{name:"height",defaultValue:0,postSet:function(old,nu){this.$&&old!==nu&&!Number.isNaN(nu)&&(this.$.style.height=0>nu?this.getFullHeight()+"px":nu+"px")}},{name:"showBorder",defaultValue:!1,postSet:function(old,nu){this.$&&old!==nu&&(this.$.style.border=nu?"2px solid grey":"none")}},{name:"coverPage",defaultValue:!1,postSet:function(old,nu){if(this.$&&old!==nu){var container=this.$container,style=container.style
style.top=style.bottom=style.left=style.right=nu?"0px":"initial"}}},{name:"$container",defaultValueFn:function(){return this.document.querySelector("#"+this.id+"-container")}},{name:"listeningForCancel_",defaultValue:!1}],methods:[function open(){this.$&&!this.isOpen&&(console.log("open"),this.showBorder=!0,this.height=-1,this.coverPage=!0,this.isOpen=!0,this.listenForCancel())},function close(){this.$&&this.isOpen&&(console.log("close"),this.height=0,this.coverPage=!1,this.isOpen=!1,this.unlistenForCancel())},function isPropEnabled(prop){return this.properties.indexOf(prop.name)>=0},function getPropClass(prop){return this.isPropEnabled(prop)?"enabled":""},function getPositionStyle(){return"height:"+(this.height<0?this.getFullHeight()+"px":this.height+"px")},function getFullHeight(){if(!this.$)return 0
for(var children=this.$.children,height=0,i=0;i<children.length;++i)height+=children[i].offsetHeight
return height},function onClick(prop,e){console.log("onClick"),e.stopPropagation(),this.properties=this.isPropEnabled(prop)?this.properties.filter(function(propName){return propName!==prop.name}):this.availableProperties.filter(function(p){return p.name===prop.name||this.properties.indexOf(p.name)>=0}.bind(this)).map(function(p){return p.name})},function initHTML(){this.SUPER(),this.$&&(this.$.addEventListener("transitionend",this.onTransitionEnd),this.$.addEventListener("mouseleave",this.onMouseOut))}],listeners:[{name:"listenForCancel",code:function(){this.listeningForCancel_||(console.log("listenForCancel"),this.isOpen?(this.document.body.addEventListener("click",this.onCancel),this.listeningForCancel_=!0):console.log("** NOT LISTENING"))},isFramed:!0},{name:"unlistenForCancel",code:function(){this.listeningForCancel_&&(console.log("unlistenForCancel"),this.isOpen?console.log("** NOT UNLISTENING"):(this.document.body.removeEventListener("click",this.onCancel),this.listeningForCancel_=!1))},isFramed:!0},{name:"onCancel",code:function(e){console.log("onCancel"),this.close()}},{name:"onTransitionEnd",code:function(e){console.log("transition end"),this.showBorder=this.isOpen}},{name:"onMouseOut",code:function(e){e.target===this.$&&this.close()}}],templates:[{name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,out=opt_out?opt_out:TOC(this)
return out('\n      <popup-container id="',self.id,'-container"></popup-container>\n        <popup id="',self.id,'" style="',this.getPositionStyle(),'">\n          '),this.toInnerHTML(out),out("\n        </popup>\n    "),out.toString()}},{name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,out=opt_out?opt_out:TOC(this)
if(out("\n      "),this.model){for(var i=0;i<this.availableProperties.length;++i){var prop=this.availableProperties[i]
out('\n             <item id="',this.on("click",this.onClick.bind(this,prop)),'"\n                   class="',this.getPropClass(prop),'">\n               ',escapeHTML(prop.label),"\n             </item>\n        ")}out("\n      ")}return out("\n    "),out.toString()}},{name:"CSS",code:ConstantTemplate("\npopup-container {\nposition: fixed;\nz-index: 1009;\n}\npopup {\nfont-size: 13px;\nfont-weight: 400;\ndisplay: block;\nposition: absolute;\nbackground: white;\nz-index: 1010;\noverflow: hidden;\ntransition: height 0.25s cubic-bezier(0,.3,.8,1);\nbox-shadow: 0 1px 3px rgba(0, 0, 0, 0.38);\ntop: 0px;\nright: 0px;\n}\npopup item {\ndisplay: block;\ncursor: pointer;\npadding: 12px;\n}\npopup item.enabled {\nfont-weight: bold;\n}\npopup item:hover {\nbackground: #EEEEEE;\n}\n")}]})
