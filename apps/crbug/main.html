<html>
 <head>
  <link rel="stylesheet" type="text/css" href="../../foam.css" />
  <link rel="stylesheet" type="text/css" href="crbug.css" />
  <script>var FOAM_BOOT_DIR="../../";</script>
  <script language="javascript" src="../../bootFOAM.js"></script> 
  <script language="javascript" src="SchemaImport.js"></script>
  <script language="javascript" src="issue.js"></script> 
  <script language="javascript" src="QueryParser.js"></script> 
  <script language="javascript" src="testdata.js"></script> 
  <title>Chromium Issues</title>
 </head>

 <body>
<table>
  <tr>
  <td>
    <img src="https://code.google.com/p/chromium/logo?cct=1370456375">
  </td>
  <td>
    <span class="title">cr<sup><font size=-0.5>2</font></sup>bug</span>
    <div class="subtitle">Chromium issue tracker in Chromium.</div>
  </td>
  <td width=150></td>
  <td valign="bottom">
  <div class="searchBar">
  Search <span id="searchChoice"></span> for <span id="searchField"></span> 
  </div>
  </td>
  </tr>
</table>
<hr color="#9BC0FA">
<script language="javascript">
    // var CIssueDAO = StorageDAO.create({model: CIssue});
    var CIssueDAO = issues;

    // var stack = StackView.create();
    // stack.write(document);
    //FOAM.browse(CIssue);

    var COL = {
      create: function() { return { __proto__: this, values: [] }; },
      put: function(v) { this.values.push(v); },
      toHTML: function() { return this.values.join('<br/>'); },
      clone: function() { return this.create(); }
    };

    var ItemCount = Model.create({
       extendsModel: 'CountExpr',
       methods: {
         toString: function() {
           return '<span class="idcount">' + this.count + (this.count == 1 ? ' item' : ' items') + '</span>';
         }
       }
    });

    var idFormatter = {
      f: function(i) { return '<span class=idlist>' + i.id + '</span>'; }
    };

    var altView = AlternateView.create({
      dao: issues,
      views: [
        ViewChoice.create({
          label: 'List',
          view: function() {
	    return TableView2.create({
              model: CIssue,
            });
          }
        }),
        ViewChoice.create({
          label: 'Grid',
          view: function() {
	    var g = GridView.create({
              model: CIssue,
              accChoices: [
                [ MAP(CIssueTileView.create(), COL.create()), "Tiles"  ],
                [ MAP(idFormatter, COL.create()),             "IDs"    ],
                [ ItemCount.create(),                         "Counts" ]
              ],
              grid: GridByExpr.create()
            });

            // Pre-set default values.  TODO: persist settings
	    g.row.value.set(CIssue.OWNER);
	    g.col.value.set(CIssue.STATUS);
	    g.acc.value.set(g.accChoices[0][0]);
		    
            return g;
          }
        })
      ]
    });

  /*
    From: google3/codesite/dit/constants.py
  DEFAULT_CANNED_QUERIES = [
    ('All issues', ''),
    ('Open issues', 'is:open'),
    ('Open and owned by me', 'is:open owner:me'),
    ('Open and reported by me', 'is:open reporter:me'),
    ('Open and starred by me', 'is:open is:starred'),
    ('New issues', 'status:new'),
    ('Issues to verify', 'status=fixed,done'),
    ('Open with comment by me', 'is:open commentby:me'),
    ]
  */

    var searchChoice = ChoiceView.create({
      helpText: 'Search within:',
      choices:[
        ["",                            "&nbsp;All issues"],
        ["-status=Closed",              "&nbsp;Open issues"],
        ["owner=me -status=Closed",     "&nbsp;Open and owned by me"],
        ["-status=Closed reporter=me",  "&nbsp;Open and reported by me"],
        ["-status=Closed is:starred",   "&nbsp;Open and starred by me"],
        ["-status=Closed commentby:me", "&nbsp;Open and comment by me"],
        ["status=New",                  "&nbsp;New issues"],
        ["status=Fixed,Done",           "&nbsp;Issues to verify"]
      ]
    });

    var searchField = TextFieldView.create({
      name: 'search',
      displayWidth: 90
    });

    /** Filter data with the supplied predicate, or select all data if null. **/
    function search(p) {
      if ( p ) console.log('SEARCH: ', p.toSQL());
      altView.dao = p ? issues.where(p) : issues;
    }

    function performQuery() {
      search(AND(
          QueryParser.parseString(searchChoice.value.get()) || TRUE,
          QueryParser.parseString(searchField.value.get()) || TRUE
        ).partialEval());
    }

    searchChoice.value.addListener(performQuery);
    searchField.value.addListener(performQuery);

    searchChoice.insertInElement('searchChoice');
    searchField.insertInElement('searchField');

    altView.write(document);

/*
var IssueDAO = RestDAO.create({
  url:'https://www-googleapis-staging.sandbox.google.com/projecthosting/v2/projects/chromium/issues',
  model: CrIssue
});

IssueDAO = IssueDAO.limit(10);
*/

var dv = DetailView.create(CrIssue);
dv.write(document);

  </script>
 </body>
</html>
