<html>
 <head>
  <link rel="stylesheet" type="text/css" href="../../foam.css" />
  <link rel="stylesheet" type="text/css" href="crbug.css" />
  <script>var FOAM_BOOT_DIR="../../";</script>
  <script language="javascript" src="../../bootFOAM.js"></script> 
  <script language="javascript" src="../../SyncManager.js"></script> 
  <script language="javascript" src="ImportedModels.js"></script> 
  <script language="javascript" src="Models.js"></script> 
  <script language="javascript" src="DAO.js"></script> 
  <script language="javascript" src="CIssueQueryParser.js"></script> 
  <title>Chromium Issues</title>
 </head>

 <body>
<table>
  <tr>
  <td>
    <img id="logo" src="logo.png">
  </td>
  <td>
    <span class="title">cr<sup><font size=-0.5>2</font></sup>bug</span>
    <div class="subtitle">Chromium issue tracker in Chromium.</div>
  </td>
  <td width=150></td>
  <td valign="bottom">
  <div class="searchBar">
  Search <span id="searchChoice"></span> for <span id="searchField"></span> 
  </div>
  </td>
  </tr>
</table>
<hr color="#9BC0FA">
<script language="javascript">
    var issues = IDAO.create({model: CIssue});
//    var issues = IndexedDBDAO.create({model: CIssue});
    // var CIssueDAO = StorageDAO.create({model: CIssue});
    var CIssueDAO = issues;
    var localIssueDAO = issues;

    // var stack = StackView.create();
    // stack.write(document);
    //FOAM.browse(CIssue);

    var COL = {
      create: function() { return { __proto__: this, values: [] }; },
      put: function(v) { this.values.push(v); },
      toHTML: function() { return this.values.join('<br/>'); },
      clone: function() { return this.create(); }
    };

    var ItemCount = Model.create({
       extendsModel: 'CountExpr',
       methods: {
         toString: function() {
           return '<span class="idcount">' + this.count + (this.count == 1 ? ' item' : ' items') + '</span>';
         }
       }
    });

    var idFormatter = {
      f: function(i) { return '<span class=idlist>' + i.id + '</span>'; }
    };

    var altView = AlternateView.create({
      dao: issues,
      views: [
        ViewChoice.create({
          label: 'List',
          view: function() {
	    return TableView2.create({
              model: CIssue,
            });
          }
        }),
        ViewChoice.create({
          label: 'Grid',
          view: function() {
	    var g = GridView.create({
              model: CIssue,
              accChoices: [
                [ MAP(CIssueTileView.create(), COL.create()), "Tiles"  ],
                [ MAP(idFormatter, COL.create()),             "IDs"    ],
                [ ItemCount.create(),                         "Counts" ]
              ],
              grid: GridByExpr.create()
            });

            // Pre-set default values.  TODO: persist settings
	    g.row.value.set(CIssue.OWNER);
	    g.col.value.set(CIssue.STATUS);
	    g.acc.value.set(g.accChoices[0][0]);
		    
            return g;
          }
        })
      ]
    });

    // From: google3/codesite/dit/constants.py
    var searchChoice = ChoiceView.create({
      helpText: 'Search within:',
      choices:[
        ["",                            "&nbsp;All issues"],
        ["-status=Closed",              "&nbsp;Open issues"],
        ["owner=me -status=Closed",     "&nbsp;Open and owned by me"],
        ["-status=Closed reporter=me",  "&nbsp;Open and reported by me"],
        ["-status=Closed is:starred",   "&nbsp;Open and starred by me"],
        ["-status=Closed commentby:me", "&nbsp;Open and comment by me"],
        ["status=New",                  "&nbsp;New issues"],
        ["status=Fixed,Done",           "&nbsp;Issues to verify"]
      ]
    });

    // Set initial value to 'Open issues'
    searchChoice.value.set(searchChoice.choices[1][0]);

    var searchField = TextFieldView.create({
      name: 'search',
      displayWidth: 90
    });

    /** Filter data with the supplied predicate, or select all data if null. **/
    function search(p) {
      if ( p ) console.log('SEARCH: ', p.toSQL());
      altView.dao = p ? issues.where(p) : issues;
    }

    function performQuery() {
      search(AND(
          CIssueQueryParser.parseString(searchChoice.value.get()) || TRUE,
          CIssueQueryParser.parseString(searchField.value.get()) || TRUE
        ).partialEval());
    }

    searchChoice.value.addListener(performQuery);
    searchField.value.addListener(performQuery);

    searchChoice.insertInElement('searchChoice');
    searchField.insertInElement('searchField');

    altView.write(document);

/*
var IssueDAO = RestDAO.create({
  url:'https://www-googleapis-staging.sandbox.google.com/projecthosting/v2/projects/chromium/issues',
  model: CIssue
});

IssueDAO = IssueDAO.limit(10);
*/

var dv = DetailView.create(CIssue);
dv.write(document);


var syncManager = SyncManager.create({
  srcDAO: IssueNetworkDAO,
  dstDAO: localIssueDAO,
  lastModified: new Date(2013,01,01),
  modifiedProperty: CIssue.UPDATED
});

var syncView = ActionBorder.create(SyncManager, DetailView.create(SyncManager));
document.writeln(syncView.toHTML());
syncView.set(syncManager);
syncView.initHTML();

var space = Canvas.create({width: 1300, height: 100, background:'#000'});
var graph = Graph.create({x:0,y:0,width:1300,height:100,axisColor:'white',data:[]});
space.addChild(graph);
space.write(document);
 syncManager.propertyValue('timesSynced').addListener(function() { graph.addData(syncManager.lastBatchSize); space.paint(); });
// syncManager.propertyValue('timesSynced').addListener(function() { graph.addData(syncManager.lastSyncDuration); space.paint(); });

var timer = Timer.create({});
var logo = $('logo');
syncManager.propertyValue('isSyncing').addListener(function() {
  if ( syncManager.isSyncing ) {
    timer.step();
    timer.start();
  } else {
    timer.stop();
    altView.view = altView.view;
  }
});

logo.onclick = syncManager.forceSync.bind(syncManager);

/*
timer.propertyValue('i').addListener(function() {
  logo.style.webkitTransform = 'rotate(' + -timer.i + 'deg)';
});
*/
Events.dynamic(function() {
  logo.style.webkitTransform = 'rotate(' + -timer.i + 'deg)';
});



  </script>
 </body>
</html>
