function MODEL(model){var proto;model.name?(GLOBAL[model.name]||(GLOBAL[model.name]=model.extendsModel?{__proto__:GLOBAL[model.extendsModel]}:{}),proto=GLOBAL[model.name]):proto=model.extendsProto?GLOBAL[model.extendsProto].prototype:GLOBAL[model.extendsObject],model.properties&&model.properties.forEach(function(p){Object.defineProperty(proto,p.name,{get:p.getter,enumerable:!1})});for(key in model.constants)Object.defineProperty(proto,key,{value:model.constants[key],writable:!0,enumerable:!1});if(Array.isArray(model.methods))model.methods.forEach(function(m){Object.defineProperty(proto,m.name,{value:m,writable:!0,enumerable:!1})});else for(var key in model.methods)Object.defineProperty(proto,key,{value:model.methods[key],writable:!0,enumerable:!1})}function defineProperties(proto,fns){for(var key in fns)try{Object.defineProperty(proto,key,{value:fns[key],configurable:!0,writable:!0})}catch(x){console.log("Warning: "+x)}}function WeakMap(){function del(key){delete key[id]}function get(key){return key[id]}function set(key,value){key[id]=value}function has(key){return!!key[id]}var id="__WEAK_MAP__"+this.$UID;return{__proto__:this,"delete":del,get:get,set:set,has:has}}function prep(arg){return"string"==typeof arg?literal(arg):arg}function prepArgs(args){for(var i=0;i<args.length;i++)args[i]=prep(args[i]);return args}function range(c1,c2){var f=function(ps){return ps.head?ps.head<c1||ps.head>c2?void 0:ps.tail.setValue(ps.head):void 0};return f.toString=function(){return"range("+c1+", "+c2+")"},f}function literal(str,opt_value){var f=function(ps){for(var i=0;i<str.length;i++,ps=ps.tail)if(str.charAt(i)!==ps.head)return void 0;return ps.setValue(opt_value||str)};return f.toString=function(){return'"'+str+'"'},f}function literal_ic(str,opt_value){str=str.toLowerCase();var f=function(ps){for(var i=0;i<str.length;i++,ps=ps.tail)if(!ps.head||str.charAt(i)!==ps.head.toLowerCase())return void 0;return ps.setValue(opt_value||str)};return f.toString=function(){return'"'+str+'"'},f}function anyChar(ps){return ps.head?ps.tail:void 0}function notChar(c){return function(ps){return ps.head&&ps.head!==c?ps.tail.setValue(ps.head):void 0}}function notChars(s){return function(ps){return ps.head&&-1==s.indexOf(ps.head)?ps.tail.setValue(ps.head):void 0}}function not(p,opt_else){p=prep(p),opt_else=prep(opt_else);var f=function(ps){return this.parse(p,ps)?void 0:opt_else?this.parse(opt_else,ps):ps};return f.toString=function(){return"not("+p+")"},f}function optional(p){p=prep(p);var f=function(ps){return this.parse(p,ps)||ps.setValue(void 0)};return f.toString=function(){return"optional("+p+")"},f}function copyInput(p){p=prep(p);var f=function(ps){var res=this.parse(p,ps);return res?res.setValue(ps.str_.toString().substring(ps.pos,res.pos)):res};return f.toString=function(){return"copyInput("+p+")"},f}function lookahead(p){p=prep(p);var f=function(ps){return this.parse(p,ps)&&ps};return f.toString=function(){return"lookahead("+p+")"},f}function repeat(p,opt_delim,opt_min,opt_max){p=prep(p),opt_delim=prep(opt_delim);var f=function(ps){for(var ret=[],i=0;!opt_max||opt_max>i;i++){var res;if(opt_delim&&0!=ret.length){if(!(res=this.parse(opt_delim,ps)))break;ps=res}if(!(res=this.parse(p,ps)))break;ret.push(res.value),ps=res}return opt_min&&ret.length<opt_min?void 0:ps.setValue(ret)};return f.toString=function(){return"repeat("+p+", "+opt_delim+", "+opt_min+", "+opt_max+")"},f}function plus(p){return repeat(p,void 0,1)}function noskip(p){return function(ps){return this.skip_=!1,ps=this.parse(p,ps),this.skip_=!0,ps}}function repeat0(p){return p=prep(p),function(ps){for(var res;res=this.parse(p,ps);)ps=res;return ps.setValue("")}}function seq(){var args=prepArgs(arguments),f=function(ps){for(var ret=[],i=0;i<args.length;i++){if(!(ps=this.parse(args[i],ps)))return void 0;ret.push(ps.value)}return ps.setValue(ret)};return f.toString=function(){return"seq("+argsToArray(args).join(",")+")"},f}function seq1(n){var args=prepArgs(argsToArray(arguments).slice(1)),f=function(ps){for(var ret,i=0;i<args.length;i++){if(!(ps=this.parse(args[i],ps)))return void 0;i==n&&(ret=ps.value)}return ps.setValue(ret)};return f.toString=function(){return"seq1("+n+", "+argsToArray(args).join(",")+")"},f}function invalidateParsers(){parserVersion_++}function simpleAlt(){var args=prepArgs(arguments);if(1==args.length)return args[0];var f=function(ps){for(var i=0;i<args.length;i++){var res=this.parse(args[i],ps);if(res)return res}return void 0};return f.toString=function(){return"alt("+argsToArray(args).join(" | ")+")"},f}function alt(){function nullParser(){return void 0}function testParser(p,ps){var c=ps.head,trapPS={getValue:function(){return this.value},setValue:function(v){return this.value=v,this},value:ps.value,head:c},goodChar=!1;return trapPS.__defineGetter__("tail",function(){return goodChar=!0,{value:this.value,getValue:function(){return this.value},setValue:function(v){this.value=v}}}),this.parse(p,trapPS),goodChar}function getParserForChar(ps){var c=ps.head,p=map[c];if(!p){for(var alts=[],i=0;i<args.length;i++){var parser=args[i];testParser.call(this,parser,ps)&&alts.push(parser)}p=0==alts.length?nullParser:1==alts.length?alts[0]:simpleAlt.apply(null,alts),map[c]=p}return p}var SIMPLE_ALT=simpleAlt.apply(null,arguments),args=prepArgs(arguments),map={},parserVersion=parserVersion_;return function(ps){parserVersion!==parserVersion_&&(map={},parserVersion=parserVersion_);var r1=this.parse(getParserForChar.call(this,ps),ps);return r1}}function str(p){p=prep(p);var f=function(ps){var ps=this.parse(p,ps);return ps?ps.setValue(ps.value.join("")):void 0};return f.toString=function(){return"str("+p+")"},f}function pick(as,p){p=prep(p);var f=function(ps){var ps=this.parse(p,ps);if(!ps)return void 0;for(var ret=[],i=0;i<as.length;i++)ret.push(ps.value[as[i]]);return ps.setValue(ret)};return f.toString=function(){return"pick("+as+", "+p+")"},f}function parsedebug(p){return function(ps){var old=DEBUG_PARSE;DEBUG_PARSE=!0;var ret=this.parse(p,ps);return DEBUG_PARSE=old,ret}}function sym(name){var f=function(ps){var p=this[name];return p||console.log("PARSE ERROR: Unknown Symbol <"+name+">"),this.parse(p,ps)};return f.toString=function(){return"<"+name+">"},f}function defineTTLProperty(obj,name,ttl,f){Object.defineProperty(obj,name,{get:function(){var accessed,value=void 0;return Object.defineProperty(this,name,{get:function(){function scheduleTimer(){setTimeout(function(){accessed?scheduleTimer():value=void 0,accessed=!1},ttl)}return value?accessed=!0:(accessed=!1,value=f(),scheduleTimer()),value}}),this[name]}})}function lookup(key){if(!key)return void 0;if("string"!=typeof key)return key;var root=this,cache;cache=this.hasOwnProperty("lookupCache_")?this.lookupCache_:this.lookupCache_={};var ret=cache[key];if(!ret){for(var path=key.split("."),i=0;root&&i<path.length;i++)root=root[path[i]];ret=root,ret&&(cache[key]=ret)}return ret}function set(key,value){Object.defineProperty(this,key,{value:value,writable:"window"!==key,configurable:!0})}function setValue(key,value){var X=this;Object.defineProperty(this,key,{get:function(){return X.set(key,value.get()),X[key]},configurable:!0})}function sub(opt_args,opt_name){var sub=Object.create(this);if(opt_args)for(var key in opt_args)opt_args.hasOwnProperty(key)&&sub.set(key,opt_args[key]);return opt_name&&(sub.NAME=opt_name,sub.toString=function(){return"CONTEXT("+opt_name+")"}),sub}function subWindow(w,opt_name,isBackground){return w?foam.ui.Window.create({window:w,name:opt_name,isBackground:isBackground},this).Y:this.sub()}function elementFromString(str){return str.element||(str.element=HTMLParser.create().parseString(str).children[0])}function $addWindow(w){w.window.$WID=$WID__++,$documents.push(w.document)}function $removeWindow(w){for(var i=$documents.length-1;i>=0;i--)$documents[i].defaultView&&$documents[i].defaultView!==w||$documents.splice(i,1)}function arequire(modelName,opt_X){var X=opt_X||GLOBAL.X,model=X.lookup(modelName);if(!model){if(!X.ModelDAO)return aconstant();if(X.arequire$ModelLoadsInProgress){if(X.arequire$ModelLoadsInProgress[modelName])return X.arequire$ModelLoadsInProgress[modelName]}else X.set("arequire$ModelLoadsInProgress",{});var future=afuture();return X.arequire$ModelLoadsInProgress[modelName]=future.get,X.ModelDAO.find(modelName,{put:function(m){m.X=X,m.arequire()(function(m){delete X.arequire$ModelLoadsInProgress[modelName],X.registerModel(m),future.set(m)})},error:function(){var args=argsToArray(arguments);console.warn.apply(console,["Could not load model: ",modelName].concat(args)),delete X.arequire$ModelLoadsInProgress[modelName],future.set(void 0)}}),future.get}return model.arequire()}function packagePath(X,path){function packagePath_(Y,path,i){return i===path.length?Y:(Y[path[i]]||(Y[path[i]]={},0==i&&(GLOBAL[path[i]]=Y[path[i]])),packagePath_(Y[path[i]],path,i+1))}return path?packagePath_(X,path.split("."),0):GLOBAL}function registerModel(model,opt_name){var root=model["package"]?this:GLOBAL,name=model.name,package=model["package"];if(opt_name){var a=opt_name.split(".");name=a.pop(),package=a.join(".")}var path=packagePath(root,package);if(Object.defineProperty(path,name,{value:model,configurable:!0}),root.lookupCache_){var cache=root.lookupCache_,modelRegName=(package?package+".":"")+name;cache[modelRegName]&&(cache[modelRegName]=model)}this.onRegisterModel(model)}function INTERFACE(imodel){var i=JSONUtil.mapToObj(X,imodel,Interface);packagePath(X,i["package"])[i.name]=i;var id=i["package"]?i["package"]+"."+i.name:i.name;NONMODEL_INSTANCES[id]=!0}function onRegisterModel(m){}function defineLocalProperty(cls,name,factory){Object.defineProperty(cls,name,{get:function(){console.assert(this!==cls,"Called property getter from prototype: "+name);var value=factory.call(this);return Object.defineProperty(this,name,{value:value}),value},configurable:!0})}function override(cls,methodName,method){var super_=cls[methodName],SUPER=function(){return super_.apply(this,arguments)},slowF=function(OLD_SUPER,args){try{return method.apply(this,args)}finally{this.SUPER=OLD_SUPER}},f=function(){var OLD_SUPER=this.SUPER;if(this.SUPER=SUPER,OLD_SUPER)return slowF.call(this,OLD_SUPER,arguments);var ret=method.apply(this,arguments);return this.SUPER=null,ret};f.toString=function(){return method.toString()},f.super_=super_,cls[methodName]=f}function recopyModelFeatures(m){m.model_=Model,m.methods=m.methods,m.templates=m.templates,m.relationships=m.relationships,m.properties=m.properties,m.actions=m.actions,m.listeners=m.listeners,m.models=m.models,m.tests=m.tests,m.issues=m.issues,m.properties&&m.properties[0]&&!Property.isInstance(m.properties[0])&&m.properties.forEach(function(p){"Property"==p.model_.name&&(p.model_=Property)}),DEBUG&&BootstrapModel.saveDefinition(m)}function toNum(p){return p.replace?parseInt(p.replace("px","")):p}function compile_(a){return a.f?a:a===!0?TRUE:a===!1?FALSE:ConstantExpr.create({arg1:a})}function compileArray_(args){for(var b=[],i=0;i<args.length;i++){var a=args[i];null!==a&&void 0!==a&&b.push(compile_(a))}return b}function MAX(expr){return MaxExpr.create({arg1:expr})}function EXPLAIN(arg){return ExplainExpr.create({arg1:arg})}function COUNT(){return CountExpr.create()}function IN(arg1,arg2){return InExpr.create({arg1:compile_(arg1),arg2:arg2})}function EQ(arg1,arg2){var eq=EqExpr.create();return eq.instance_.arg1=compile_(arg1),eq.instance_.arg2=compile_(arg2),eq}function LT(arg1,arg2){return LtExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function GT(arg1,arg2){return GtExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function LTE(arg1,arg2){return LteExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function GTE(arg1,arg2){return GteExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function AND(){return AndExpr.create({args:compileArray_.call(null,arguments)})}function SUM(expr){return SumExpr.create({arg1:expr})}function MIN(expr){return MinExpr.create({arg1:expr})}function AVG(expr){return AvgExpr.create({arg1:expr})}function SEQ(){return SeqExpr.create({args:argsToArray(arguments)})}function UPDATE(expr,dao){return UpdateExpr.create({args:compileArray_.call(null,Array.prototype.slice.call(arguments,0,-1)),dao:arguments[arguments.length-1]})}function SET(arg1,arg2){return SetExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function GROUP_BY(expr1,opt_expr2){return GroupByExpr.create({arg1:expr1,arg2:opt_expr2||[].sink})}function GRID_BY(xFunc,yFunc,acc){return GridByExpr.create({xFunc:xFunc,yFunc:yFunc,acc:acc})}function MAP(fn,opt_sink){return MapExpr.create({arg1:fn,arg2:opt_sink||[].sink})}function DISTINCT(fn,sink){return DistinctExpr.create({arg1:fn,arg2:sink})}function OR(){return OrExpr.create({args:compileArray_.call(null,arguments)})}function NOT(arg){return NotExpr.create({arg1:compile_(arg)})}function NEQ(arg1,arg2){return NeqExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function STARTS_WITH(arg1,arg2){return StartsWithExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function STARTS_WITH_IC(arg1,arg2){return StartsWithICExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function CONTAINS(arg1,arg2){return ContainsExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function CONTAINS_IC(arg1,arg2){return ContainsICExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function CONCAT(){return ConcatExpr.create({args:compileArray_.call(null,arguments)})}function TREE(parentProperty,childrenProperty){return TreeExpr.create({parentProperty:parentProperty,childrenProperty:childrenProperty})}function ADD(arg1,arg2){return AddExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function DESC(arg1){return DescExpr.isInstance(arg1)?arg1.arg1:DescExpr.create({arg1:arg1})}function MQL(mql){return MQLExpr.create({arg1:mql})}function KEYWORD(word){return KeywordExpr.create({arg1:word})}function atxn(afunc){return function(ret){if(GLOBAL.__TXN__)afunc.apply(this,arguments);else{GLOBAL.__TXN__={};var a=argsToArray(arguments);a[0]=function(){GLOBAL.__TXN__=void 0,ret()},afunc.apply(this,a)}}}function dump(o){return Array.isArray(o)?"["+o.map(dump).join(",")+"]":o?o.toString():"<undefined>"}function deferJsonP(X){var future=afuture();return X.ajsonp=function(){var args=arguments;return function(ret){future.get(function(f){f.apply(void 0,args)(ret)})}},future}navigator&&-1!=navigator.userAgent.indexOf("Firefox")&&(console.log("Loading Firefox Support."),Object.defineProperties(MouseEvent.prototype,{offsetX:{get:function(){return this.clientX-this.target.getBoundingClientRect().left}},offsetY:{get:function(){return this.clientY-this.target.getBoundingClientRect().top}}})),Number.name||(console.log("Polyfilling Function.prototype.name"),Object.defineProperty(Function.prototype,"name",{get:function(){var text=this.toString();return text.substring(text.indexOf("function")+9,text.indexOf("(")).trim()},configurable:!0,enumerable:!0})),navigator&&-1!=navigator.userAgent.indexOf("Safari")&&-1==navigator.userAgent.indexOf("Chrome")&&(console.log("Loading Safari Support."),function(){if("undefined"==typeof window.performance&&(window.performance={}),!window.performance.now){var nowOffset=Date.now();performance.timing&&performance.timing.navigationStart&&(nowOffset=performance.timing.navigationStart),window.performance.now=function now(){return Date.now()-nowOffset}}}(),"function"!=typeof Number.isFinite&&(Number.isFinite=function isFinite(value){return"number"!=typeof value?!1:value!==value||1/0===value||value===-1/0?!1:!0}),"function"!=typeof Number.isNaN&&(Number.isNaN=function(value){return"number"==typeof value&&value!==value}));var DEBUG=DEBUG||!1,GLOBAL=GLOBAL||this;MODEL({extendsObject:"GLOBAL",methods:[function memoize(f){var cache={},g=function(){var key=argsToArray(arguments).toString();return cache.hasOwnProperty(key)||(cache[key]=f.apply(this,arguments)),cache[key]};return g.name=f.name,g},function memoize1(f){var cache={},g=function(arg){var key=arg.toString();return cache.hasOwnProperty(key)||(cache[key]=f.call(this,arg)),cache[key]};return g.name=f.name,g},function constantFn(v){return function(){return v}},function latchFn(f){var tripped=!1,val;return function(){return tripped||(tripped=!0,val=f(),f=void 0),val}},function argsToArray(args){for(var array=new Array(args.length),i=0;i<args.length;i++)array[i]=args[i];return array},function StringComparator(s1,s2){return s1==s2?0:s2>s1?-1:1},function equals(a,b){return a===b?!0:a&&b?a.equals?a.equals(b):a==b:!1},function toCompare(c){return Array.isArray(c)?CompoundComparator.apply(null,c):c.compare?c.compare.bind(c):c},function CompoundComparator(){for(var args=argsToArray(arguments),cs=[],i=0;i<args.length;i++)cs[i]=toCompare(args[i]);var f=function(o1,o2){for(var i=0;i<cs.length;i++){var r=cs[i](o1,o2);if(0!=r)return r}return 0};return f.toSQL=function(){return args.map(function(s){return s.toSQL()}).join(",")},f.toMQL=function(){return args.map(function(s){return s.toMQL()}).join(" ")},f.toBQL=function(){return args.map(function(s){return s.toBQL()}).join(" ")},f.toString=f.toSQL,f},function randomAct(){for(var totalWeight=0,i=0;i<arguments.length;i+=2)totalWeight+=arguments[i];for(var r=Math.random(),i=0,weight=0;i<arguments.length;i+=2)if(weight+=arguments[i],weight/totalWeight>=r)return void arguments[i+1]()},function Object_forEach(obj,fn){for(var key in obj)obj.hasOwnProperty(key)&&fn(obj[key],key)},function predicatedSink(predicate,sink){return predicate!==TRUE&&sink?{__proto__:sink,$UID:sink.$UID,put:function(obj,s,fc){!sink.put||obj&&!predicate.f(obj)||sink.put(obj,s,fc)},remove:function(obj,s,fc){!sink.remove||obj&&!predicate.f(obj)||sink.remove(obj,s,fc)},reset:function(){sink.reset()},toString:function(){return"PredicatedSink("+sink.$UID+", "+predicate+", "+sink+")"}}:sink},function limitedSink(count,sink){var i=0;return{__proto__:sink,put:function(obj,s,fc){i++>=count&&fc?fc.stop():sink.put(obj,s,fc)}}},function skipSink(skip,sink){var i=0;return{__proto__:sink,put:function(obj,s,fc){i++>=skip&&sink.put(obj,s,fc)}}},function orderedSink(comparator,sink){return comparator=toCompare(comparator),{__proto__:sink,i:0,arr:[],put:function(obj,s,fc){this.arr.push(obj)},eof:function(){this.arr.sort(comparator),this.arr.select(sink)}}},function defineLazyProperty(target,name,definitionFn){Object.defineProperty(target,name,{get:function(){var definition=definitionFn.call(this);return Object.defineProperty(this,name,definition),definition.get?definition.get.call(this):definition.value},configurable:!0})},function multiline(f){var s=f.toString(),start=s.indexOf("/*"),end=s.lastIndexOf("*/");return s.substring(start+2,end)},function findPageXY(node){for(var x=0,y=0,parent;node;)parent=node,x+=node.offsetLeft,y+=node.offsetTop,node=node.offsetParent;return[x,y,parent]},function findViewportXY(node){var rect=node.getBoundingClientRect();return[rect.left,rect.top]},function nop(){},function stringtoutf8(str){for(var res=[],i=0;i<str.length;i++){var code=str.charCodeAt(i),count=0;128>code&&res.push(code)}return res},function createGUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=16*Math.random()|0,v="x"===c?r:3&r|8;return v.toString(16)})}]});var constantize=memoize1(function(str){return"x"===str?"X_":"y"===str?"Y_":str.replace(/[a-z_][^0-9a-z_]/g,function(a){return a.substring(0,1)+"_"+a.substring(1,2)}).toUpperCase()}),capitalize=memoize1(function(str){return str[0].toUpperCase()+str.substring(1)});MODEL({extendsProto:"Object",properties:[{name:"$UID",getter:function(){var id=1;return function(){return Object.hasOwnProperty.call(this,"$UID__")?this.$UID__:(this.$UID__=id,id++,this.$UID__)}}()}],methods:[function clone(){return this},function deepClone(){return this.clone()},function become(other){for(var local=Object.getOwnPropertyNames(this),i=0;i<local.length;i++)delete this[local[i]];var remote=Object.getOwnPropertyNames(other);for(i=0;i<remote.length;i++)Object.defineProperty(this,remote[i],Object.getOwnPropertyDescriptor(other,remote[i]));this.__proto__=other.__proto__}]}),MODEL({extendsProto:"Array",constants:{oldForEach_:Array.prototype.forEach},methods:[function forEach(f,opt_this){if(!this||!f||opt_this)return this.oldForEach_.call(this,f,opt_this);for(var l=this.length,i=0;l>i;i++)f(this[i],i,this)},function diff(other){for(var added=other.slice(0),removed=[],i=0;i<this.length;i++){for(var j=0;j<added.length;j++)if(0==this[i].compareTo(added[j])){added.splice(j,1),j--;break}j==added.length&&removed.push(this[i])}return{added:added,removed:removed}},function binaryInsert(item){for(var start=0,end=this.length-1;end>=start;){var m=start+Math.floor((end-start)/2),c=item.compareTo(this[m]);if(0==c)return this;0>c?end=m-1:start=m+1}return this.splice(start,0,item),this},function union(other){return this.concat(other.filter(function(o){return-1==this.indexOf(o)}.bind(this)))},function intersection(other){return this.filter(function(o){return-1!=other.indexOf(o)})},function intern(){for(var i=0;i<this.length;i++)this[i].intern&&(this[i]=this[i].intern());return this},function compareTo(other){if(this.length!==other.length)return-1;for(var i=0;i<this.length;i++){var result=this[i].compareTo(other[i]);if(0!==result)return result}return 0},function fReduce(comparator,arr){compare=toCompare(comparator);for(var result=[],i=0,j=0,k=0;i<this.length&&j<arr.length;){var a=compare(this[i],arr[j]);0>a?result[k++]=this[i++]:0!=a?result[k++]=arr[j++]:(result[k++]=this[i++],result[k++]=arr[j++])}return i!=this.length&&(result=result.concat(this.slice(i))),j!=arr.length&&(result=result.concat(arr.slice(j))),result},function pushAll(arr){return this.push.apply(this,arr),this.length},function mapFind(map){for(var i=0;i<this.length;i++){var result=map(this[i],i);if(result)return result}},function mapProp(prop){return this.map(function(x){return x[prop]})},function mapCall(){var args=Array.prototype.slice.call(arguments,0),func=args.shift();return this.map(function(x){return x[func]&&x[func].apply(x[func],args)})}],properties:[{name:"memento",getter:function(){throw"Array's can not be memorized properly as a memento."}}]}),MODEL({extendsProto:"String",methods:[function indexOfIC(a){return a.length>this.length?-1:this.toUpperCase().indexOf(a.toUpperCase())},function equals(other){return 0===this.compareTo(other)},function equalsIC(other){return other&&this.toUpperCase()===other.toUpperCase()},function capitalize(){return this.charAt(0).toUpperCase()+this.slice(1)},function labelize(){return this.replace(/[a-z][A-Z]/g,function(a){return a.charAt(0)+" "+a.charAt(1)}).capitalize()},function clone(){return this.toString()},function compareTo(o){return o==this?0:o>this?-1:1},String.prototype.startsWith||function startsWith(a){return 0==this.lastIndexOf(a,0)},function startsWithIC(a){if(a.length>this.length)return!1;for(var l=a.length,i=0;l>i;i++)if(this[i].toUpperCase()!==a[i].toUpperCase())return!1;return!0},function put(obj){return this+obj.toJSON()},function(){var map={};return function intern(){return map[this]||(map[this]=this.toString())}}(),function hashCode(){var hash=0;if(0==this.length)return hash;for(i=0;i<this.length;i++){var code=this.charCodeAt(i);hash=(hash<<5)-hash+code,hash&=hash}return hash}]}),MODEL({extendsProto:"Function",methods:[function(){var oldBind=Function.prototype.bind,simpleBind=function(f,self){return function(){return f.apply(self,arguments)}};return function bind(arg){return 1==arguments.length?simpleBind(this,arg):oldBind.apply(this,argsToArray(arguments))}}(),function equals(o){return this===o},function compareTo(o){return this===o?0:this.name.compareTo(o.name)||1},function o(f2){var f1=this;return function(){return f1.call(this,f2.apply(this,argsToArray(arguments)))}}]}),MODEL({extendsObject:"Math",methods:[function sign(n){return n>0?1:-1}]}),MODEL({extendsProto:"Date",methods:[function toRelativeDateString(){var seconds=Math.floor((Date.now()-this.getTime())/1e3);if(60>seconds)return"moments ago";var minutes=Math.floor(seconds/60);if(1==minutes)return"1 minute ago";if(60>minutes)return minutes+" minutes ago";var hours=Math.floor(minutes/60);if(1==hours)return"1 hour ago";if(24>hours)return hours+" hours ago";var days=Math.floor(hours/24);if(1==days)return"1 day ago";if(7>days)return days+" days ago";if(365>days){var year=1900+this.getYear(),noyear=this.toDateString().replace(" "+year,"");return noyear.substring(4)}return this.toDateString().substring(4)},function equals(o){return o&&o.getTime?this.getTime()===o.getTime():!1},function compareTo(o){if(o===this)return 0;if(!o)return 1;var d=this.getTime()-o.getTime();return 0==d?0:d>0?1:-1},function toMQL(){return this.getFullYear()+"/"+(this.getMonth()+1)+"/"+this.getDate()},function toBQL(){var str=this.toISOString();return str.substring(0,str.indexOf("."))}]}),MODEL({extendsProto:"Number",methods:[function compareTo(o){return o==this?0:o>this?-1:1},function clone(){return+this}]}),MODEL({extendsProto:"Boolean",methods:[function compareTo(o){return(this.valueOf()?1:0)-(o?1:0)}]}),MODEL({extendsProto:"RegExp",methods:[function quote(str){return(str+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}]}),console.log.json=function(){for(var args=[],i=0;i<arguments.length;i++){var arg=arguments[i];args.push(arg&&arg.toJSON?arg.toJSON():arg)}console.log.apply(console,args)},console.log.str=function(){for(var args=[],i=0;i<arguments.length;i++){var arg=arguments[i];args.push(arg&&arg.toString?arg.toString():arg)}console.log.apply(console,args)},console.log.put=console.log.bind(console),console.log.remove=console.log.bind(console,"remove: "),console.log.error=console.log.bind(console,"error: "),console.log.json.put=console.log.json.bind(console),console.log.json.reduceI=console.log.json.bind(console,"reduceI: "),console.log.json.remove=console.log.json.bind(console,"remove: "),console.log.json.error=console.log.json.bind(console,"error: "),console.log.str.put=console.log.str.bind(console),console.log.str.remove=console.log.str.bind(console,"remove: "),console.log.str.error=console.log.str.bind(console,"error: "),document.put=function(obj){obj.write?obj.write(this):this.write(obj.toString())},window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem,window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.setImmediate,window.Blob&&(Blob.prototype.slice=Blob.prototype.slice||Blob.prototype.webkitSlice),window.XMLHttpRequest&&(XMLHttpRequest.prototype.asend=function(ret,opt_data){var xhr=this;xhr.onerror=function(){console.log("XHR Error: ",arguments)},xhr.onloadend=function(){ret(xhr.response,xhr)},xhr.send(opt_data)}),String.fromCharCode=function(){var oldLookup=String.fromCharCode,lookupTable=[];return function(a){if(1==arguments.length)return lookupTable[a]||(lookupTable[a]=oldLookup(a));for(var result="",i=0;i<arguments.length;i++)result+=lookupTable[arguments[i]]||(lookupTable[arguments[i]]=oldLookup(arguments[i]));return result}}(),!window.WeakMap,MODEL({extendsProto:"Function",methods:[function abind(self){return function(ret){this.apply(self,arguments),ret()}.bind(this)},function ao(f2){var f1=this;return function(ret){var args=argsToArray(arguments);args[0]=f1.bind(this,ret),f2.apply(this,args)}},function aseq(f2){return f2.ao(this)}]}),MODEL({extendsObject:"GLOBAL",methods:[function anop(ret){ret&&ret(void 0)},function alog(){var args=arguments;return function(ret){console.log.apply(console,args),ret&&ret.apply(this,[].slice.call(arguments,1))}},function aprofile(afunc){return function(ret){var a=argsToArray(arguments);console.profile("aprofile");var ret2=function(){console.profileEnd(),ret&&ret(arguments)};aapply_(afunc,ret2,a)}},function aconstant(v){return function(ret){ret&&ret(v)}},function arepeat(n,afunc){return n?function(ret){var a=argsToArray(arguments);a.splice(1,0,0,n);var next=atramp(function(){return a[1]==n-1?(a[0]=ret,void afunc.apply(this,a)):(afunc.apply(this,a),void a[1]++)});a[0]=next,next.apply(this,a)}:anop},function aforEach(arr,afunc){},function awhile(cond,afunc){return function(ret){var a=argsToArray(arguments),g=function(){return cond()?void afunc.apply(this,a):void ret.apply(void 0,arguments)};a[0]=g,g.apply(this,a)}},function aif(cond,afunc,aelse){return function(ret){("function"==typeof cond?cond():cond)?afunc.apply(this,arguments):aelse?aelse.apply(this,arguments):ret()}},function aaif(acond,afunc,aelse){return function(ret){var args=argsToArray(arguments);args[0]=function(c){args[0]=ret,c?afunc.apply(null,args):aelse?aelse.apply(null,args):ret()},acond.apply(null,args)}},function(){var id=1,activeOps={};return function atime(str,afunc,opt_endCallback,opt_startCallback){var name=str;return aseq(function(ret){activeOps[str]?(name+="-"+id++,activeOps[str]++):activeOps[str]=1;var start=performance.now();opt_startCallback&&opt_startCallback(name),opt_endCallback||console.time(name),ret.apply(null,[].slice.call(arguments,1))},afunc,function(ret){if(activeOps[str]--,opt_endCallback){var end=performance.now();opt_endCallback(name,end-start)}else console.timeEnd(name);ret&&ret.apply(null,[].slice.call(arguments,1))})}}(),function ametric(){return this.atime.apply(this,arguments)},function asleep(ms){return function(ret){window.setTimeout(ret,ms)}},function ayield(){return function(ret){window.setTimeout(ret,0)}},function afuture(){var set=!1,values=void 0,waiters=[];return{set:function(){if(set)return void console.log("ERROR: redundant set on future");values=arguments,set=!0;for(var i=0;i<waiters.length;i++)waiters[i].apply(null,values);waiters=void 0},get:function(ret){return set?void ret.apply(null,values):void waiters.push(ret)}}},function aapply_(f,ret,args){args.unshift(ret),f.apply(this,args)},function arequestqueue(f,opt_lock,opt_max){var lock=opt_lock||{};lock.q||(lock.q=[],lock.active=null);var onExit=function(){var next=lock.active=lock.q.pop();next&&setTimeout(function(){f(onExit,next)},0)},reduceDown=function(o,q){for(var i=q.length-1;i>=0;i--){var result=o.reduce(q[i]);if(result){q.splice(i,1),reduceDown(result,q);break}}q.push(o)};return function(o){if(lock.active){var first=o.reduce(lock.active);if(first&&first.equals(lock.active))return}reduceDown(o,lock.q,lock.q.length-1),lock.q.length>opt_max&&(lock.q.length=opt_max),lock.active||onExit()}},function asynchronized(f,opt_lock){function onExit(ret){return function(){var next=lock.q.shift();next?setTimeout(next,0):lock.active=!1,ret()}}var lock=opt_lock||{};return lock.q||(lock.q=[],lock.active=!1),function(ret){return lock.active?void lock.q.push(function(){f(onExit(ret))}):(lock.active=!0,void f(onExit(ret)))}},function atimeout(delay,f,opt_timeoutF){return function(ret){var timedOut=!1,completed=!1;setTimeout(function(){completed||(timedOut=!0,console.log("timeout"),opt_timeoutF&&opt_timeoutF())},delay),f(aseq(function(ret){timedOut||(completed=!0),completed&&ret()},ret))}},function amemo(f,opt_ttl){var memoized=!1,values,waiters,age=0,pending=!1;return function(ret){if(memoized)return ret.apply(null,values),void(void 0!=opt_ttl&&!pending&&Date.now()>age+opt_ttl&&(pending=!0,f(function(){values=arguments,age=Date.now(),pending=!1})));var first=!waiters;first&&(waiters=[]),waiters.push(ret),first&&f(function(){values=arguments,age=Date.now();for(var i=0;i<waiters.length;i++)waiters[i]&&waiters[i].apply(null,values);void 0==opt_ttl&&(f=void 0),memoized=!0,waiters=void 0})}},function amerged(f){var waiters;return function(ret){var first=!waiters;if(first){waiters=[];var args=argsToArray(arguments)}waiters.push(ret),first&&(args[0]=function(){var calls=waiters;waiters=void 0;for(var i=0;i<calls.length;i++)calls[i]&&calls[i].apply(null,arguments)},f.apply(null,args))}},function mergeAsync(f){var active=!1,args;return function(){if(active)return void(args=argsToArray(arguments));active=!0;var ret=function(){args?(args.unshift(ret),f.apply(null,args),args=void 0):active=!1},a=argsToArray(arguments);a.unshift(ret),f.apply(null,a)}},function ao(){for(var ret=arguments[arguments.length-1],i=0;i<arguments.length-1;i++)ret=arguments[i].ao(ret);
return ret},function aseq(){for(var f=arguments[arguments.length-1],i=arguments.length-2;i>=0;i--)f=arguments[i].aseq(f);return f},function apar(){var aargs=[],count=0,fs=arguments;return function(ret){if(0==fs.length)return void(ret&&ret());for(var opt_args=Array.prototype.splice.call(arguments,1),ajoin=function(i){if(aargs[i]=Array.prototype.splice.call(arguments,1),++count==fs.length){for(var a=[],j=0;j<fs.length;j++)for(var k=0;k<aargs[j].length;k++)a.push(aargs[j][k]);ret&&ret.apply(null,a)}},i=0;i<fs.length;i++)fs[i].apply(null,[ajoin.bind(null,i)].concat(opt_args))}},function(){var active=!1,jobs=[];return function atramp(afunc){return function(){if(jobs.push([afunc,arguments]),!active){console.assert(jobs.length<=1,"atramp with multiple jobs"),active=!0;for(var job;null!=(job=jobs.pop());)job[0].apply(this,job[1]);active=!1}}}}(),function arepeatpar(n,afunc){return function(ret){if(0===n)return void(ret&&ret());for(var aargs=[],count=0,opt_args=Array.prototype.splice.call(arguments,1),ajoin=function(i){if(++count==n){var a=[];ret&&ret.apply(null,a)}},i=0;n>i;i++)afunc.apply(null,[ajoin.bind(null,i)].concat([i,n]).concat(opt_args))}},function axhr(url,opt_op,opt_params){var op=opt_op||"GET",params=opt_params||[];return function(ret){var xhr=new XMLHttpRequest;xhr.open(op,url),xhr.asend(function(json){ret(JSON.parse(json))},params&&params.join("&"))}},function futurefn(future){return function(){var args=arguments;future.get(function(f){f.apply(void 0,args)})}},function adelay(afunc,delay){function pump(){if(!timeout&&queue.length){var top=queue.shift(),f=top[0],args=top[1],ret=args[0];args[0]=function(){ret.apply(null,arguments),pump()},timeout=setTimeout(function(){timeout=0,f.apply(null,args)},delay)}}var queue=[],timeout;return function(){var args=arguments;queue.push([afunc,args]),pump()}},function adebugger(fn){return function(ret){fn.apply(null,arguments)}}]});var __JSONP_CALLBACKS__={},wrapJsonpCallback=function(){var nextID=0;return function(ret,opt_nonce){var id="c"+nextID++;opt_nonce&&(id+=Math.floor(16777215*Math.random()).toString(16));var cb=__JSONP_CALLBACKS__[id]=function(data){delete __JSONP_CALLBACKS__[id],ret&&ret.call(this,data)};return cb.id=id,cb}}(),ajsonp=function(url,params){return function(ret){var cb=wrapJsonpCallback(ret),script=document.createElement("script");script.src=url+"?callback=__JSONP_CALLBACKS__."+cb.id+(params?"&"+params.join("&"):""),script.onload=function(){document.body.removeChild(this)},script.onerror=function(){cb(null),document.body.removeChild(this)},document.body.appendChild(script)}},StringPS={create:function(str){var o=Object.create(this);return o.pos=0,o.str_=[str],o.tail_=[],o},set str(str){this.str_[0]=str},get head(){return this.pos>=this.str_[0].length?null:this.str_[0].charAt(this.pos)},get value(){return this.hasOwnProperty("value_")?this.value_:this.str_[0].charAt(this.pos-1)},get tail(){if(!this.tail_[0]){var tail=Object.create(this.__proto__);tail.str_=this.str_,tail.pos=this.pos+1,tail.tail_=[],this.tail_[0]=tail}return this.tail_[0]},setValue:function(value){var ret=Object.create(this.__proto__);return ret.str_=this.str_,ret.pos=this.pos,ret.tail_=this.tail_,ret.value_=value,ret},toString:function(){return this.str_[0].substring(this.pos)}},parserVersion_=1,DEBUG_PARSE=!1,grammar={parseString:function(str){var ps=this.stringPS;ps.str=str;var res=this.parse(this.START,ps);return res&&res.value},parse:function(parser,pstream){DEBUG_PARSE&&pstream.str_&&(console.log(new Array(pstream.pos).join("."),pstream.head),console.log(pstream.pos+"> "+pstream.str_[0].substring(0,pstream.pos)+"("+pstream.head+")"));var ret=parser.call(this,pstream);return DEBUG_PARSE&&console.log(parser+" ==> "+!!ret+"  "+(ret&&ret.value)),ret},"export":function(str){return this[str].bind(this)},addAction:function(sym,action){var p=this[sym];this[sym]=function(ps){var val=ps.value,ps2=this.parse(p,ps);return ps2&&ps2.setValue(action.call(this,ps2.value,val))},this[sym].toString=function(){return"<<"+sym+">>"}},addActions:function(map){for(var key in map)this.addAction(key,map[key]);return this}};defineTTLProperty(grammar,"stringPS",3e4,function(){return StringPS.create("")});var SkipGrammar={create:function(gramr,skipp){return{__proto__:gramr,skip_:!0,parse:function(parser,pstream){return this.skip_&&(pstream=this.skip.call(grammar,pstream)||pstream),this.__proto__.parse.call(this,parser,pstream)},skip:skipp}}},VersionParser={__proto__:grammar,START:repeat(sym("component"),optional(sym("separator"))),component:alt(sym("number"),sym("string")),digit:range("0","9"),number:plus(sym("digit")),string:str(plus(not(alt(sym("digit"),sym("separator")),anyChar))),separator:alt(".","-")}.addActions({number:function(v){return parseInt(v.join(""))}});MODEL({name:"EventService",constants:{UNSUBSCRIBE_EXCEPTION:"unsubscribe",WILDCARD:"*"},methods:{oneTime:function(listener){return function(){throw listener.apply(this,argsToArray(arguments)),EventService.UNSUBSCRIBE_EXCEPTION}},consoleLog:function(listener){return function(){var args=argsToArray(arguments);console.log(args),listener.apply(this,args)}},merged:function(listener,opt_delay,opt_X){var setTimeoutX=opt_X&&opt_X.setTimeout||setTimeout,delay=opt_delay||16;return function(){var triggered=!1,unsubscribed=!1,lastArgs=null,f=function(){if(lastArgs=arguments,unsubscribed)throw EventService.UNSUBSCRIBE_EXCEPTION;if(!triggered){triggered=!0;try{setTimeoutX(function(){triggered=!1;var args=argsToArray(lastArgs);lastArgs=null;try{listener.apply(this,args)}catch(x){x===EventService.UNSUBSCRIBE_EXCEPTION&&(unsubscribed=!0)}},delay)}catch(e){throw EventService.UNSUBSCRIBE_EXCEPTION}}};return f.toString=function(){return"MERGED("+delay+", "+listener.$UID+", "+listener+")"},f}()},framed:function(listener,opt_X){opt_X=opt_X||this.X;var requestAnimationFrameX=opt_X&&opt_X.requestAnimationFrame||requestAnimationFrame;return function(){var triggered=!1,unsubscribed=!1,lastArgs=null,f=function(){if(lastArgs=arguments,unsubscribed)throw EventService.UNSUBSCRIBE_EXCEPTION;triggered||(triggered=!0,requestAnimationFrameX(function(){triggered=!1;var args=argsToArray(lastArgs);lastArgs=null;try{listener.apply(this,args)}catch(x){x===EventService.UNSUBSCRIBE_EXCEPTION&&(unsubscribed=!0)}}))};return f.toString=function(){return"ANIMATE("+listener.$UID+", "+listener+")"},f}()},async:function(listener,opt_X){return this.delay(0,listener,opt_X)},delay:function(delay,listener,opt_X){return opt_X=opt_X||this.X,function(){var args=argsToArray(arguments);(opt_X&&opt_X.setTimeout?opt_X.setTimeout:setTimeout)(function(){listener.apply(this,args)},delay)}},hasListeners:function(topic){return console.log("TODO: haslisteners"),!0},publish:function(topic){return this.subs_?this.pub_(this.subs_,0,topic,this.appendArguments([this,topic],arguments,1)):0},publishAsync:function(topic){var args=argsToArray(arguments),me=this;setTimeout(function(){me.publish.apply(me,args)},0)},deepPublish:function(topic){return this.publish.apply(this,arguments)},lazyPublish:function(topic,fn){return this.hasListeners(topic)?this.publish.apply(this,fn()):0},subscribe:function(topic,listener){this.subs_||(this.subs_={}),this.sub_(this.subs_,0,topic,listener)},unsubscribe:function(topic,listener){this.subs_&&this.unsub_(this.subs_,0,topic,listener)},unsubscribeAll:function(){this.sub_={}},pub_:function(map,topicIndex,topic,msg){var count=0;if(null==map)return 0;if(topicIndex<topic.length){var t=topic[topicIndex];if(t==this.WILDCARD)return this.notifyListeners_(topic,map,msg);t&&(count+=this.pub_(map[t],topicIndex+1,topic,msg))}return count+=this.notifyListeners_(topic,map[null],msg)},sub_:function(map,topicIndex,topic,listener){if(topicIndex==topic.length)map[null]||(map[null]=[]),map[null].push(listener);else{var key=topic[topicIndex];map[key]||(map[key]={}),this.sub_(map[key],topicIndex+1,topic,listener)}},unsub_:function(map,topicIndex,topic,listener){if(topicIndex==topic.length){if(!map[null])return!0;map[null].deleteI(listener)||console.warn("phantom unsubscribe, size: ",map[null].length),map[null].length||delete map[null]}else{var key=topic[topicIndex];if(!map[key])return!1;this.unsub_(map[key],topicIndex+1,topic,listener)&&delete map[key]}return 0==Object.keys(map).length},notifyListener_:function(topic,listener,msg){try{listener.apply(null,msg)}catch(err){return err!==this.UNSUBSCRIBE_EXCEPTION?console.error("Error delivering event (removing listener): ",topic.join("."),err):console.warn("Unsubscribing listener: ",topic.join(".")),!1}return!0},notifyListeners_:function(topic,listeners,msg){if(null==listeners)return 0;if(Array.isArray(listeners)){for(var i=0;i<listeners.length;i++){var listener=listeners[i];this.notifyListener_(topic,listener,msg)||(listeners.splice(i,1),i--)}return listeners.length}var count=0;for(var key in listeners)count+=this.notifyListeners_(topic,listeners[key],msg);return count},appendArguments:function(a,args,start){for(var i=start;i<args.length;i++)a.push(args[i]);return a}}}),MODEL({name:"PropertyChangeSupport",extendsModel:"EventService",constants:{PROPERTY_TOPIC:"property"},methods:{propertyTopic:function(property){return[this.PROPERTY_TOPIC,property]},propertyChange:function(property,oldValue,newValue){this.subs_&&(null==property||oldValue!==newValue&&(oldValue===oldValue||newValue===newValue))&&this.publish(this.propertyTopic(property),oldValue,newValue)},propertyChange_:function(propertyTopic,oldValue,newValue){this.subs_&&(oldValue===newValue||oldValue!==oldValue&&newValue!==newValue||this.publish(propertyTopic,oldValue,newValue))},globalChange:function(){this.publish(this.propertyTopic(this.WILDCARD),null,null)},addListener:function(listener){console.assert(listener,"Listener cannot be null."),this.addPropertyListener(null,listener)},removeListener:function(listener){this.removePropertyListener(null,listener)},addPropertyListener:function(property,listener){this.subscribe(this.propertyTopic(property),listener)},removePropertyListener:function(property,listener){this.unsubscribe(this.propertyTopic(property),listener)},propertyValue:function(prop){if(!prop)throw"Property Name required for propertyValue().";var name=prop+"Value___";return Object.hasOwnProperty.call(this,name)?this[name]:this[name]=PropertyValue.create(this,prop)}}});var FunctionStack={create:function(){var stack=[!1];return{stack:stack,push:function(f){stack.unshift(f)},pop:function(){stack.shift()}}}},PropertyValue={create:function(obj,prop){var o=Object.create(this);return o.$UID=obj.$UID+"."+prop,o.obj=obj,o.prop=prop,o},get:function(){return this.obj[this.prop]},set:function(val){this.obj[this.prop]=val},get value(){return this.get()},set value(val){this.set(val)},addListener:function(listener){this.obj.addPropertyListener(this.prop,listener)},removeListener:function(listener){this.obj.removePropertyListener(this.prop,listener)},toString:function(){return"PropertyValue("+this.prop+")"}},Events={listeners_:new WeakMap,recordListener:function(src,dst,listener,opt_dontCallListener){var srcMap=this.listeners_.get(src);srcMap||(srcMap=new WeakMap,this.listeners_.set(src,srcMap)),console.assert(!srcMap.get(dst),"recordListener: duplicate follow"),srcMap.set(dst,listener),src.addListener(listener),opt_dontCallListener||listener()},identity:function(x){return x},follow:function(srcValue,dstValue){srcValue&&dstValue&&this.recordListener(srcValue,dstValue,function(){var sv=srcValue.get(),dv=dstValue.get();equals(sv,dv)||dstValue.set(sv)})},unfollow:function(src,dst){if(src&&dst){var srcMap=this.listeners_.get(src);if(srcMap){var listener=srcMap.get(dst);listener&&(srcMap["delete"](dst),src.removeListener(listener))}}},map:function(srcValue,dstValue,f){srcValue&&dstValue&&this.recordListener(srcValue,dstValue,function(){var s=f(srcValue.get()),d=dstValue.get();equals(s,d)||dstValue.set(s)})},link:function(srcValue,dstValue){this.follow(srcValue,dstValue),this.follow(dstValue,srcValue)},relate:function(srcValue,dstValue,f,fprime,removeFeedback){if(srcValue&&dstValue){var feedback=!1,l=function(sv,dv,f){return function(){if(!removeFeedback||!feedback){var s=f(sv.get()),d=dv.get();equals(s,d)||(feedback=!0,dv.set(s),feedback=!1)}}},l1=l(srcValue,dstValue,f),l2=l(dstValue,srcValue,fprime);this.recordListener(srcValue,dstValue,l1,!0),this.recordListener(dstValue,srcValue,l2,!0),l1()}},unlink:function(value1,value2){this.unfollow(value1,value2),this.unfollow(value2,value1)},dynamic:function(fn,opt_fn,opt_X){var fn2=opt_fn?function(){opt_fn(fn())}:fn,listener=EventService.framed(fn2,opt_X),destroyHelper={listener:listener,propertyValues:[].clone(),destroy:function(){this.propertyValues.forEach(function(p){p.removeListener(this.listener)}.bind(this))}};Events.onGet.push(function(obj,name,value){obj.propertyValue(name).addListener(listener),destroyHelper.propertyValues.push(obj.propertyValue(name))});var ret=fn();return Events.onGet.pop(),opt_fn&&opt_fn(ret),destroyHelper},onSet:FunctionStack.create(),onGet:FunctionStack.create()};MODEL({name:"Movement",methods:{distance:function(x,y){return Math.sqrt(x*x+y*y)},o:function(f1,f2){return function(x){return f1(f2(x))}},avg:function(f1,f2){return function(x){return(f1(x)+f2(x))/2}},linear:function(x){return x},back:function(x){return.5>x?2*x:2-2*x},accelerate:function(x){return(Math.sin(x*Math.PI-Math.PI/2)+1)/2},easeIn:function(a){var v=1/(1-a/2);return function(x){var x1=Math.min(x,a),x2=Math.max(x-a,0);return(a?.5*x1*(x1/a)*v:0)+x2*v}},reverse:function(f){return function(x){return 1-f(1-x)}},easeOut:function(b){return Movement.reverse(Movement.easeIn(b))},oscillate:function(b,a,opt_c){var c=opt_c||3;return function(x){if(1-b>x)return x/(1-b);var t=(x-1+b)/b;return 1+2*(1-t)*a*Math.sin(2*c*Math.PI*t)}},bounce:function(b,a,opt_c){var c=opt_c||3;return function(x){if(1-b>x)return x/(1-b);var t=(x-1+b)/b;return 1-2*(1-t)*a*Math.abs(Math.sin(2*c*Math.PI*t))}},bounce2:function(a){var v=1/(1-a);return function(x){if(1-a>x)return v*x;var p=(x-1+a)/a;return 1-(x-1+a)*v/2}},stepBack:function(a){return function(x){return a>x?-x:-2*a+(1+2*a)*x}},ease:function(a,b){return Movement.o(Movement.easeIn(a),Movement.easeOut(b))},seq:function(f1,f2){return f1&&f2?function(){f1.apply(this,argsToArray(arguments)),f2()}:f1?f1:f2},liveAnimations_:0,animate:function(duration,fn,opt_interp,opt_onEnd,opt_X){var requestAnimationFrameX=opt_X&&opt_X.requestAnimationFrame||requestAnimationFrame;if(0==duration)return Movement.seq(fn,opt_onEnd);var interp=opt_interp||Movement.linear;return function(){function stop(){if(!stopped&&(Movement.liveAnimations_--,stopped=!0,opt_onEnd&&opt_onEnd(),opt_onEnd=null,0===Movement.liveAnimations_)){var tasks=Movement.idleTasks_;tasks&&tasks.length>0&&(Movement.idleTasks_=[],setTimeout(function(){var i;if(Movement.liveAnimations_>0)for(i=0;i<tasks.length;i++)Movement.idleTasks_.push(tasks[i]);else for(i=0;i<tasks.length;i++)tasks[i]()},20))}}function go(){if(!stopped){for(var now=Date.now(),p=interp((Math.min(now,startTime+duration)-startTime)/duration),last=now>=startTime+duration,i=0;i<ranges.length;i++){var r=ranges[i],obj=r[0],name=r[1],value1=r[2],value2=r[3];obj[name]=last?value2:value1+(value2-value1)*p}last?stop():requestAnimationFrameX(go)}}var ranges=[],stopped=!1;fn&&(Events.onSet.push(function(obj,name,value2){ranges.push([obj,name,obj[name],value2])}),fn.apply(this,argsToArray(arguments)),Events.onSet.pop());var startTime=Date.now();if(ranges.length>0)Movement.liveAnimations_++,requestAnimationFrameX(go);else{var setTimeoutX=opt_X&&opt_X.setTimeout||setTimeout;setTimeoutX(stop,duration)}return stop}},whenIdle:function(fn){return function(){if(Movement.liveAnimations_>0){Movement.idleTasks_||(Movement.idleTasks_=[]);var args=arguments;Movement.idleTasks_.push(function(){fn.apply(fn,args)})}else fn.apply(fn,arguments)}},compile:function(a,opt_rest){function noop(){}function isPause(op){return Array.isArray(op)&&0==op[0]}function compilePause(op,rest){return function(){document.onclick=function(){document.onclick=null,rest()}}}function isSimple(op){return Array.isArray(op)&&"number"==typeof op[0]}function compileSimple(op,rest){return op[3]=Movement.seq(op[3],rest),function(){Movement.animate.apply(null,op)()}}function isParallel(op){return Array.isArray(op)&&Array.isArray(op[0])}function compileParallel(op,rest){var join=function(num){return function(){--num||rest()}}(op.length);return function(){for(var i=0;i<op.length;i++)isSimple(op[i])?Movement.animate(op[i][0],op[i][1],op[i][2],Movement.seq(op[i][3],join))():Movement.compile(op[i],join)()}}function compileFn(fn,rest){return Movement.seq(fn,rest)}function compile_(a,i){if(i>=a.length)return opt_rest||noop;var rest=compile_(a,i+1),op=a[i];return isPause(op)?compilePause(op,rest):isSimple(op)?compileSimple(op,rest):isParallel(op)?compileParallel(op,rest):compileFn(op,rest)}return compile_(a,0)},onIntersect:function(o1,o2,fn){o1.model_.R?Events.dynamic(function(){o1.x,o1.y,o2.x,o2.y},function(){var dx=o1.x-o2.x,dy=o1.y-o2.y,d=dx*dx+dy*dy,r2=o1.r+o2.r;r2*r2>d&&fn.call(null,o1,o2)}):Events.dynamic(function(){o1.x,o1.y,o2.x,o2.y},function(){(o1.x<=o2.x&&o1.x+o1.width>o2.x&&o1.y<=o2.y&&o1.y+o1.height>o2.y||o2.x<=o1.x&&o2.x+o2.width>o1.x&&o2.y<=o1.y&&o2.y+o2.height>o1.y)&&fn.call(null,o1,o2)})},stepTowards:function(src,dst,maxStep){var dx=src.x-dst.x,dy=src.y-dst.y,theta=Math.atan2(dy,dx),r=Math.sqrt(dx*dx+dy*dy);r=0>r?Math.max(-maxStep,r):Math.min(maxStep,r),dst.x+=r*Math.cos(-theta),dst.y-=r*Math.sin(-theta)},moveTowards:function(t,body,sat,v){var bodyX=body.propertyValue("x"),bodyY=body.propertyValue("y"),satX=sat.propertyValue("x"),satY=sat.propertyValue("y");t.addListener(function(){var dx=bodyX.get()-satX.get(),dy=bodyY.get()-satY.get(),theta=Math.atan2(dy,dx),r=Math.sqrt(dx*dx+dy*dy);r=0>r?Math.max(-v,r):Math.min(v,r),satX.set(satX.get()+r*Math.cos(-theta)),satY.set(satY.get()-r*Math.sin(-theta))})},orbit:function(t,body,sat,r,p,opt_start){var bodyX=body.x$,bodyY=body.y$,satX=sat.x$,satY=sat.y$,start=opt_start||0;t.addListener(EventService.framed(function(){var time=t.time;satX.set(bodyX.get()+r*Math.sin(time/p*Math.PI*2+start)),satY.set(bodyY.get()+r*Math.cos(time/p*Math.PI*2+start))}))},strut:function(mouse,c,dx,dy){Events.dynamic(function(){mouse.x,mouse.y},function(){c.x=mouse.x+dx,c.y=mouse.y+dy})},friction:function(c,opt_coef){var coef=opt_coef||.9;Events.dynamic(function(){c.vx,c.vy},function(){c.vx*=coef,c.vy*=coef})},gravity:function(c,opt_a,opt_theta){var a=opt_a||1,theta=opt_theta||1.5*Math.PI;Events.dynamic(function(){c.vx,c.vy},function(){c.vy+=a})},inertia:function(c){Events.dynamic(function(){c.vx,c.vy,c.x,c.y},function(){c.x+=c.vx,c.y+=c.vy,c.x<.1&&(c.x=0),c.y<.1&&(c.y=0)})},spring:function(mouse,c,dx,dy,opt_strength){var strength=opt_strength||8;Events.dynamic(function(){mouse.x,mouse.y,c.x,c.y},function(){if(0===dx&&0===dy)c.x=mouse.x,c.y=mouse.y;else{var d=Movement.distance(dx,dy),dx2=mouse.x+dx-c.x,dy2=mouse.y+dy-c.y,d2=Movement.distance(dx2,dy2),dv=strength*d2/d,a=Math.atan2(dy2,dx2);c.vx+=dv*Math.cos(a),c.vy+=dv*Math.sin(a)}})},spring2:function(c1,c2,length,opt_strength){var strength=opt_strength||4;Events.dynamic(function(){c1.x,c1.y,c2.x,c2.y},function(){var d=c1.distanceTo(c2),a=Math.atan2(c2.y-c1.y,c2.x-c1.x);d>length?(c1.applyMomentum(strength*(d/length-1),a),c2.applyMomentum(-strength*(d/length-1),a)):length>d&&(c1.applyMomentum(-strength*(length/d-1),a),c2.applyMomentum(strength*(length/d-1),a))})},createAnimatedPropertyInstallFn:function(duration,interpolation){return function(prop){this.defineProperty({name:prop.name+"$AnimationLatch",defaultValue:0,hidden:!0,documentation:function(){}});var actualSetter=this.__lookupSetter__(prop.name);this.defineProperty({name:prop.name+"$AnimationSetValue",defaultValue:0,hidden:!0,documentation:function(){},postSet:function(_,nu){actualSetter.call(this,nu)}}),this.__defineSetter__(prop.name,function(nu){var latch=this[prop.name+"$AnimationLatch"];latch&&latch();var anim=Movement.animate(duration,function(){this[prop.name+"$AnimationSetValue"]=nu}.bind(this),interpolation);this[prop.name+"$AnimationLatch"]=anim()})}}}});var AbstractFormatter={keyify:function(str){return'"'+str+'"'},stringify:function(obj){var buf="";return this.output(function(){for(var i=0;i<arguments.length;i++)buf+=arguments[i]},obj),buf},stringifyObject:function(obj,opt_defaultModel){var buf="";return this.outputObject_(function(){for(var i=0;i<arguments.length;i++)buf+=arguments[i]},obj,opt_defaultModel),buf},where:function(p){return{__proto__:this,p:p.f&&p.f.bind(p)||p}},p:function(){return!0}},JSONUtil={escape:function(str){return str.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/[\x00-\x1f]/g,function(c){return"\\u00"+(c.charCodeAt(0)<16?"0"+c.charCodeAt(0).toString(16):c.charCodeAt(0).toString(16))})},parseToMap:function(str){return eval("("+str+")")},parse:function(X,str,seq){return this.mapToObj(X,this.parseToMap(str),void 0,seq)},arrayToObjArray:function(X,a,opt_defaultModel,seq){for(var i=0;i<a.length;i++)a[i]=this.mapToObj(X,a[i],opt_defaultModel,seq);return a},mapToObj:function(X,obj,opt_defaultModel,seq){if(!obj||"object"==typeof obj.model_)return obj;if(Array.isArray(obj))return this.arrayToObjArray(X,obj,void 0,seq);if(obj instanceof Function)return obj;if(obj instanceof Date)return obj;if(obj instanceof Object){var j=0;for(var key in obj)"model_"!=key&&"prototype_"!=key&&(obj[key]=this.mapToObj(X,obj[key],null,seq)),j++;if(opt_defaultModel&&!obj.model_)return opt_defaultModel.create(obj);if(obj.model_){var newObj=X.lookup(obj.model_);if(!newObj||!newObj.finished__){var future=afuture();return seq&&seq.push(future.get),arequire(obj.model_)(function(model){if(!model)return"Template"!==obj.model_&&"ArrayProperty"!==obj.model_&&"ViewFactoryProperty"!==obj.model_&&"Documentation"!==obj.model_&&"DocumentationProperty"!==obj.model_&&console.warn("Failed to dynamically load: ",obj.model_),void future.set(obj);var tmp=model.create(obj);obj.become(tmp),future.set(obj)}),obj}return newObj?newObj.create(obj,X):obj}return obj}return obj},compact:{__proto__:AbstractFormatter,output:function(out,obj){Array.isArray(obj)?this.outputArray_(out,obj):"string"==typeof obj?(out('"'),out(JSONUtil.escape(obj)),out('"')):obj instanceof Function?this.outputFunction_(out,obj):obj instanceof Date?out(obj.getTime()):obj instanceof Object?obj.model_?this.outputObject_(out,obj):this.outputMap_(out,obj):"number"==typeof obj?(isFinite(obj)||(obj=null),out(obj)):(void 0===obj&&(obj=null),out(obj))},outputObject_:function(out,obj,opt_defaultModel){var str="",first=!0;out("{"),obj.model_.id!==opt_defaultModel&&(this.outputModel_(out,obj),first=!1);for(var key in obj.model_.properties_){var prop=obj.model_.properties_[key];if(this.p(prop)&&prop.name in obj.instance_){var val=obj[prop.name];if(Array.isArray(val)&&!val.length)continue;first||out(","),out(this.keyify(prop.name),": "),Array.isArray(val)&&prop.subType?this.outputArray_(out,val,prop.subType):this.output(out,val),first=!1}}out("}")},outputModel_:function(out,obj){out('model_:"'),obj.model_["package"]&&out(obj.model_["package"],"."),out(obj.model_.name,'"')},outputMap_:function(out,obj){var str="",first=!0;out("{");for(var key in obj){var val=obj[key];first||out(","),out(this.keyify(key),": "),this.output(out,val),first=!1}out("}")},outputArray_:function(out,a,opt_defaultModel){if(0==a.length)return out("[]"),out;var str="",first=!0;out("[");for(var i=0;i<a.length;i++,first=!1){var obj=a[i];first||out(","),"string"==typeof obj||"number"==typeof obj?this.output(out,obj):Array.isArray(obj)?this.outputArray_(out,obj):obj.model_?this.outputObject_(out,obj,opt_defaultModel):this.outputMap_(out,obj)}out("]")},outputFunction_:function(out,obj){out(obj)}},pretty:{__proto__:AbstractFormatter,output:function(out,obj,opt_indent){var indent=opt_indent||"";Array.isArray(obj)?this.outputArray_(out,obj,null,indent):"string"==typeof obj?(out('"'),out(JSONUtil.escape(obj)),out('"')):obj instanceof Function?this.outputFunction_(out,obj,indent):obj instanceof Date?out("new Date('",obj,"')"):obj instanceof Object?obj.model_?this.outputObject_(out,obj,null,indent):this.outputMap_(out,obj,indent):"number"==typeof obj?(isFinite(obj)||(obj=null),out(obj)):(void 0===obj&&(obj=null),out(obj))},outputObject_:function(out,obj,opt_defaultModel,opt_indent){var indent=opt_indent||"",nestedIndent=indent+"   ",str="",first=!0;out(indent,"{\n"),obj.model_.id&&obj.model_.id!==opt_defaultModel&&(this.outputModel_(out,obj,nestedIndent),first=!1);for(var key in obj.model_.properties_){var prop=obj.model_.properties_[key];if(this.p(prop)&&"parent"!==prop.name&&prop.name in obj.instance_){var val=obj[prop.name];if(Array.isArray(val)&&!val.length)continue;first||out(",\n"),out(nestedIndent,this.keyify(prop.name),": "),Array.isArray(val)&&prop.subType?this.outputArray_(out,val,prop.subType,nestedIndent):this.output(out,val,nestedIndent),first=!1}}out("\n",indent,"}")},outputModel_:function(out,obj,indent){out(indent,'"model_": "',obj.model_.id,'"')},outputMap_:function(out,obj,opt_indent){var indent=opt_indent||"",nestedIndent=indent+"   ",str="",first=!0;out(indent,"{\n",nestedIndent);for(var key in obj){var val=obj[key];first||out(",\n"),out(nestedIndent,this.keyify(key),": "),this.output(out,val,nestedIndent),first=!1}out("\n",indent,"}")},outputArray_:function(out,a,opt_defaultModel,opt_indent){if(0==a.length)return out("[]"),out;var indent=opt_indent||"",nestedIndent=indent+"   ",str="",first=!0;out("[\n");for(var i=0;i<a.length;i++,first=!1){var obj=a[i];first||out(",\n"),"string"==typeof obj||"number"==typeof obj?(out(nestedIndent),this.output(out,obj,nestedIndent)):obj.model_?this.outputObject_(out,obj,opt_defaultModel,nestedIndent):Array.isArray(obj)?this.outputArray_(out,obj,void 0,nestedIndent):this.outputMap_(out,obj,nestedIndent)}out("\n",indent,"]")},outputFunction_:function(out,obj,indent){var str=obj.toString(),lines=str.split("\n");if(1==lines.length)return void out(str);for(var minIndent=1e4,i=0;i<lines.length;i++){for(var j=0;j<lines[i].length&&" "===lines[i].charAt(j)&&minIndent>j;j++);j>0&&minIndent>j&&(minIndent=j)}if(1e4===minIndent)return void out(str);for(var i=0;i<lines.length;i++)lines[i].length&&" "===lines[i].charAt(0)&&(lines[i]=indent+lines[i].substring(minIndent)),out(lines[i]),i<lines.length-1&&out("\n")}},moreCompact:{__proto__:AbstractFormatter},compressed:{__proto__:AbstractFormatter,stringify:function(obj){return Iuppiter.Base64.encode(Iuppiter.compress(JSONUtil.compact.stringify(obj),!0))}}};JSONUtil.prettyModel={__proto__:JSONUtil.pretty,outputModel_:function(out,obj,indent){out(indent,'model_: "',obj.model_.id,'"')},keys_:{},keyify:function(str){return this.keys_.hasOwnProperty(str)||(this.keys_[str]=/^[a-zA-Z\$_][0-9a-zA-Z$_]*$/.test(str)?str:'"'+str+'"'),this.keys_[str]}},JSONUtil.stringify=JSONUtil.pretty.stringify.bind(JSONUtil.pretty),JSONUtil.stringifyObject=JSONUtil.pretty.stringifyObject.bind(JSONUtil.pretty),JSONUtil.output=JSONUtil.pretty.output.bind(JSONUtil.pretty),JSONUtil.where=JSONUtil.pretty.where.bind(JSONUtil.pretty);var NOT_TRANSIENT=function(prop){return!prop["transient"]},XMLParser={__proto__:grammar,START:seq1(1,sym("whitespace"),sym("tag"),sym("whitespace")),tag:seq("<",sym("tagName"),sym("whitespace"),repeat(sym("attribute"),sym("whitespace")),sym("whitespace"),">",repeat(alt(sym("tag"),sym("text"))),"</",sym("tagName"),">"),label:str(plus(notChars(" =/	\r\n<>'\""))),tagName:sym("label"),text:str(plus(notChar("<"))),attribute:seq(sym("label"),"=",sym("value")),value:str(alt(seq1(1,'"',repeat(notChar('"')),'"'),seq1(1,"'",repeat(notChar("'")),"'"))),whitespace:repeat(alt(" ","	","\r","\n"))};XMLParser.addActions({tag:function(xs){if(xs[1]!=xs[8])return void 0;var obj={tag:xs[1],attrs:{},children:xs[6]};return xs[3].forEach(function(attr){obj.attrs[attr[0]]=attr[2]}),obj}});var XMLUtil={escape:function(str){return str&&str.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},unescape:function(str){return str&&str.toString().replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")},escapeAttr:function(str){return str&&str.replace(/"/g,"&quot;")},unescapeAttr:function(str){return str&&str.replace(/&quot;/g,'"')},parse:function(str){var result=XMLParser.parseString(str);return result?this.parseArray(result.children):result},parseObject:function(tag){var obj={},self=this;if(tag.children.forEach(function(c){if("object"==typeof c&&c.attrs&&c.attrs.name){var result;if(c.attrs.type&&"function"==c.attrs.type){var code=XMLUtil.unescape(c.children.join(""));result=code.startsWith("function")?eval("("+code+")"):new Function(code)}else result=self.parseArray(c.children);obj[self.unescapeAttr(c.attrs.name)]=result}}),!tag.attrs.model)return obj;var model=this.unescapeAttr(tag.attrs.model);return GLOBAL[model]?GLOBAL[model].create(obj):obj},parseArray:function(a){var self=this,ret=[];return a.forEach(function(x){"object"==typeof x&&ret.push("i"==x.tag?XMLUtil.unescape(x.children[0]):self.parseObject(x))}),ret.length?ret:XMLUtil.unescape(a.join(""))},compact:{stringify:function(obj){var buf=[];return this.output(buf.push.bind(buf),obj),"<foam>"+buf.join("")+"</foam>"},output:function(out,obj){Array.isArray(obj)?this.outputArray_(out,obj):"string"==typeof obj?out(XMLUtil.escape(obj)):obj instanceof Function?this.outputFunction_(out,obj):obj instanceof Object?obj.model_?this.outputObject_(out,obj):this.outputMap_(out,obj):out(obj)},outputObject_:function(out,obj){out('<object model="',XMLUtil.escapeAttr(obj.model_.name),'">');for(var key in obj.model_.properties_){var prop=obj.model_.properties_[key];if("parent"!==prop.name&&obj.instance_&&prop.name in obj.instance_){var val=obj[prop.name];if(Array.isArray(val)&&0==val.length)continue;if(val==prop.defaultValue)continue;out('<property name="',XMLUtil.escapeAttr(prop.name),'" '+("function"==typeof val?'type="function"':"")+">"),this.output(out,val),out("</property>")}}out("</object>")},outputMap_:function(out,obj){out("<object>");for(var key in obj){var val=obj[key];out('<property name="',XMLUtil.escapeAttr(key),'">'),this.output(out,val),out("</property>")}out("</object>")},outputArray_:function(out,a){if(0==a.length)return out;for(var i=0;i<a.length;i++,first=!1){var obj=a[i];"string"==typeof obj||"number"==typeof obj?out("<i>",XMLUtil.escape(obj),"</i>"):this.output(out,obj)}},outputFunction_:function(out,f){out(XMLUtil.escape(f.toString()))}},pretty:{stringify:function(obj){var buf=[];return this.output(buf.push.bind(buf),obj),"<foam>\n"+buf.join("")+"</foam>\n"},output:function(out,obj,opt_indent){var indent=opt_indent||"";if(Array.isArray(obj))this.outputArray_(out,obj,indent);else if("string"==typeof obj)out(XMLUtil.escape(obj));else if(obj instanceof Function)this.outputFunction_(out,obj,indent);else if(obj instanceof Object)try{obj.model_&&"string"!=typeof obj.model_?this.outputObject_(out,obj,indent):this.outputMap_(out,obj,indent)}catch(x){console.log("toXMLError: ",x)}else out(obj)},outputObject_:function(out,obj,opt_indent){var indent=opt_indent||"",nestedIndent=indent+"  ";out(indent,'<object model="',XMLUtil.escapeAttr(obj.model_.name),'">');for(var key in obj.model_.properties_){var prop=obj.model_.properties_[key];if("parent"!==prop.name&&obj.instance_&&prop.name in obj.instance_){var val=obj[prop.name];if(Array.isArray(val)&&0==val.length)continue;if(val==prop.defaultValue)continue;var type="function"==typeof obj[prop.name]?' type="function"':"";out("\n",nestedIndent,'<property name="',XMLUtil.escapeAttr(prop.name),'"',type,">"),this.output(out,val,nestedIndent),out("</property>")}}out("\n",indent,"</object>"),out("\n")},outputMap_:function(out,obj,opt_indent){var indent=opt_indent||"",nestedIndent=indent+"  ";out(indent,"<object>");for(var key in obj){var val=obj[key];out("\n",nestedIndent,'<property name="',XMLUtil.escapeAttr(key),'">'),this.output(out,val,nestedIndent),out("</property>")}out("\n",indent,"</object>\n")},outputArray_:function(out,a,opt_indent){if(0==a.length)return out;
for(var indent=opt_indent||"",nestedIndent=indent+"  ",i=0;i<a.length;i++,first=!1){var obj=a[i];out("\n"),"string"==typeof obj||"number"==typeof obj?out(nestedIndent,"<i>",XMLUtil.escape(obj),"</i>"):this.output(out,obj,nestedIndent)}out("\n",indent)},outputFunction_:function(out,f,opt_indent){out(XMLUtil.escape(f.toString())+"\n"+(opt_indent||""))}}};XMLUtil.stringify=XMLUtil.pretty.stringify.bind(XMLUtil.pretty),XMLUtil.output=XMLUtil.pretty.output.bind(XMLUtil.pretty);var X=sub({}),foam=X.foam={},registerFactory=function(model,factory){},registerModelForModel=function(modelType,targetModel,model){},registerFactoryForModel=function(factory,targetModel,model){},JSONParser=SkipGrammar.create({__proto__:grammar,START:copyInput(sym("objAsString")),objAsString:copyInput(sym("obj")),obj:seq1(1,"{",repeat(sym("pair"),","),"}"),pair:seq(sym("key"),":",sym("value")),key:alt(sym("symbol"),sym("string")),symbol:noskip(str(seq(sym("char"),str(repeat(sym("alpha")))))),"char":alt(range("a","z"),range("A","Z"),"_","$"),alpha:alt(range("a","z"),range("A","Z"),"_","$",range("0","9")),value:simpleAlt(sym("function literal"),sym("expr"),sym("number"),sym("string"),sym("obj"),sym("bool"),sym("array")),expr:str(seq(sym("symbol"),optional(str(alt(seq(".",sym("expr")),seq("(",str(repeat(sym("value"),",")),")")))))),number:noskip(seq(optional("-"),repeat(range("0","9"),null,1),optional(seq(".",repeat(range("0","9")))))),string:noskip(alt(sym("single quoted string"),sym("double quoted string"))),"double quoted string":seq1(1,'"',str(repeat(sym("double quoted char"))),'"'),"double quoted char":alt(sym("escape char"),literal('\\"','"'),notChar('"')),"single quoted string":seq1(1,"'",str(repeat(sym("single quoted char"))),"'"),"single quoted char":alt(sym("escape char"),literal("\\'","'"),notChar("'")),"escape char":alt(literal("\\\\","\\"),literal("\\n","\n")),bool:alt(literal("true",!0),literal("false",!1)),array:seq1(1,"[",repeat(sym("value"),","),"]"),"function literal":seq("function",optional(sym("symbol")),"(",repeat(sym("symbol"),","),")","{",repeat(notChar("}")),"}")}.addActions({obj:function(v){for(var m={},i=0;i<v.length;i++)m[v[i][0]]=v[i][2];return m}}),repeat0(alt(" ","	","\n","\r")));MODEL({name:"TemplateParser",extendsModel:"grammar",methods:{START:sym("markup"),markup:repeat0(alt(sym("comment"),sym("foamTag"),sym("create child"),sym("simple value"),sym("live value tag"),sym("raw values tag"),sym("values tag"),sym("code tag"),sym("ignored newline"),sym("newline"),sym("single quote"),sym("text"))),comment:seq1(1,"<!--",repeat0(not("-->",anyChar)),"-->"),foamTag:sym("foamTag_"),foamTag_:function(){},"create child":seq("$$",repeat(notChars(" $\n<{")),optional(JSONParser["export"]("objAsString"))),"simple value":seq("%%",repeat(notChars(' -"\n<'))),"live value tag":seq("<%#",repeat(not("%>",anyChar)),"%>"),"raw values tag":alt(seq("<%=",repeat(not("%>",anyChar)),"%>"),seq("{{{",repeat(not("}}}",anyChar)),"}}}")),"values tag":seq("{{",repeat(not("}}",anyChar)),"}}"),"code tag":seq("<%",repeat(not("%>",anyChar)),"%>"),"ignored newline":literal("\\\n"),newline:literal("\n"),"single quote":literal("'"),text:anyChar}});var TemplateOutput={create:function(obj){var buf="",f=function(){for(var i=0;i<arguments.length;i++){var o=arguments[i];"string"==typeof o?buf+=o:(o&&o.toView_&&(o=o.toView_()),null!==o&&void 0!==o&&(o.appendHTML?o.appendHTML(this):buf+=o.toHTML?o.toHTML():o,o.initHTML&&obj.addChild&&obj.addChild(o)))}};return f.toString=function(){return buf},f}},ConstantTemplate=function(str){var f=function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out(str),out.toString()};return f.toString=function(){return'function(opt_out) { var out = opt_out ? opt_out : TemplateOutput.create(this);\n  out("'+str.replace(/\n/g,"\\n").replace(/"/g,'\\"')+'");\n  return out.toString(); }'},f},TemplateCompiler={__proto__:TemplateParser,out:[],simple:!0,push:function(){this.simple=!1,this.pushSimple.apply(this,arguments)},pushSimple:function(){this.out.push.apply(this.out,arguments)},header:"var self = this; var X = this.X; var Y = this.Y; var escapeHTML = XMLUtil.escape;var out = opt_out ? opt_out : TemplateOutput.create(this);out('",footer:"');return out.toString();"}.addActions({markup:function(v){var wasSimple=this.simple,ret=wasSimple?null:this.header+this.out.join("")+this.footer;return this.out=[],this.simple=!0,[wasSimple,ret]},"create child":function(v){var name=v[1].join("");this.push("', self.createTemplateView('",name,"'",v[2]?", "+v[2]:"","),\n'")},foamTag:function(e){var fName=e.getAttribute("f");fName?(this.push("', self.createTemplateView('",fName,"',{}).fromElement(FOAM("),this.push(JSONUtil.where(NOT_TRANSIENT).stringify(e)),this.push("))")):(this.push("', (function() { var tagView = X.foam.ui.FoamTagView.create({element: FOAM("),this.push(JSONUtil.where(NOT_TRANSIENT).stringify(e)),this.push(")}); self.addDataChild(tagView); return tagView; })() ")),this.push(",\n'")},"simple value":function(v){this.push("',\n self.",v[1].join(""),",\n'")},"raw values tag":function(v){this.push("',\n",v[1].join(""),",\n'")},"values tag":function(v){this.push("',\nescapeHTML(",v[1].join(""),"),\n'")},"live value tag":function(v){this.push("',\nself.dynamicTag('span', function() { return ",v[1].join(""),"; }.bind(this)),\n'")},"code tag":function(v){this.push("');\n",v[1].join(""),";out('")},"single quote":function(){this.pushSimple("\\'")},newline:function(){this.pushSimple("\\n")},text:function(v){this.pushSimple(v)}});MODEL({name:"TemplateUtil",methods:{lazyCompile:function(t){var delegate,f=function(){if(!delegate){if(!t.template)throw"Must arequire() template model before use for "+this.name_+"."+t.name;delegate=TemplateUtil.compile(Template.isInstance(t)?t:Template.create(t))}return delegate.apply(this,arguments)};return f.toString=function(){return delegate?delegate.toString():t},f},compile_:function(t,code){for(var args=["opt_out"],i=0;i<t.args.length;i++)args.push(t.args[i].name);return eval("(function("+args.join(",")+"){"+code+"})")},compile:function(t){var code=TemplateCompiler.parseString(t.template);if(code[0])return ConstantTemplate(t.template);try{return this.compile_(t,code[1])}catch(err){return console.log("Template Error: ",err),console.log(code),function(){}}},stringifyTemplate:function(template){return function(){var buf=[];return this.output(buf.push.bind(buf),obj),buf.join("")}},expandTemplate:function(self,t,opt_X){var X=opt_X||self.X;if("function"==typeof t)t=X.Template.create({name:t.name,args:t.toString().match(/\((.*?)\)/)[1].split(",").slice(1).map(function(a){return X.Arg.create({name:a.trim()})}),template:multiline(t)});else if("string"==typeof t)t=docTemplate=X.Template.create({name:"body",template:t});else if(t.template||t.code)"function"==typeof t.template&&(t.template=multiline(t.template));else{var future=afuture(),path=self.sourcePath;if(t.futureTemplate=future.get,path=path.substring(0,path.lastIndexOf("/")+1),path+=self.name+"_"+t.name+".ft",window.XMLHttpRequest){var xhr=new XMLHttpRequest;xhr.open("GET",path),xhr.asend(function(data){t.template=data,future.set(Template.create(t))})}else{var fs=require("fs");fs.readFile(path,function(err,data){t.template=data.toString(),future.set(Template.create(t))})}}return t.futureTemplate||(t.futureTemplate=aconstant(t)),t.template$||(t="undefined"!=typeof X.Template?JSONUtil.mapToObj(X,t,X.Template):t),t},expandModelTemplates:function(self){for(var templates=self.templates,i=0;i<templates.length;i++)templates[i]=TemplateUtil.expandTemplate(self,templates[i])}}});var aeval=function(src){return aconstant(eval("("+src+")"))},aevalTemplate=function(t,model){return aseq(t.futureTemplate,function(ret,t){ret(TemplateUtil.lazyCompile(t))})},$documents=[];window&&$documents.push(window.document);var $WID__=0,$=function(id){console.log("Deprecated use of GLOBAL.$.");for(var i=0;i<$documents.length;i++){if(document.FOAM_OBJECTS&&document.FOAM_OBJECTS[id])return document.FOAM_OBJECTS[id];var ret=$documents[i].getElementById(id);if(ret)return ret}return void 0},$$=function(cls){console.log("Deprecated use of GLOBAL.$$.");for(var i=0;i<$documents.length;i++){var ret=$documents[i].getElementsByClassName(cls);if(ret.length>0)return ret}return[]},FOAM=function(map,opt_X,seq){var obj=JSONUtil.mapToObj(opt_X||X,map,void 0,seq);return obj};FOAM.putFactory=function(ctx,name,factory){ctx.__defineGetter__(name,function(){return console.log("Bouncing Factory: ",name),delete ctx[name],ctx[name]=factory()})};var USED_MODELS={},UNUSED_MODELS={},NONMODEL_INSTANCES={};FOAM.browse=function(model,opt_dao,opt_X){var Y=opt_X||X.sub(void 0,"FOAM BROWSER");"string"==typeof model&&(model=Y[model]);var dao=opt_dao||Y[model.name+"DAO"]||Y[model.plural];dao||(Y[model.name+"DAO"]=[].dao);var ctrl=Y.DAOController.create({model:model,dao:dao,useSearchView:!1});if(Y.stack)Y.stack.pushView(ctrl);else{var w=opt_X?opt_X.window:window;Y.stack=Y.StackView.create();var win=Y.foam.ui.layout.Window.create({window:w,data:Y.stack},Y);document.body.insertAdjacentHTML("beforeend",win.toHTML()),win.initHTML(),Y.stack.setTopView(ctrl)}};var FOAM_POWERED='<a style="text-decoration:none;" href="https://github.com/foam-framework/foam/" target="_blank"><font size=+1 face="catull" style="text-shadow:rgba(64,64,64,0.3) 3px 3px 4px;"><font color="#3333FF">F</font><font color="#FF0000">O</font><font color="#FFCC00">A</font><font color="#33CC00">M</font><font color="#555555" > POWERED</font></font></a>',CLASS=function(m){function registerModelLatch(path,m){var id=m["package"]?m["package"]+"."+m.name:m.name;UNUSED_MODELS[id]=!0,m["package"]||Object.defineProperty(GLOBAL,m.name,{get:function(){return path[m.name]},configurable:!0}),Object.defineProperty(path,m.name,{get:function(){USED_MODELS[id]=!0,delete UNUSED_MODELS[id],Object.defineProperty(path,m.name,{value:null,configurable:!0});var work=[],model=JSONUtil.mapToObj(X,m,Model,work);return work.length>0&&(model.extra__=aseq.apply(null,work)),X.registerModel(model),model},configurable:!0})}document&&document.currentScript&&(m.sourcePath=document.currentScript.src),registerModelLatch(packagePath(X,m["package"]),m)},MODEL=CLASS,FObject={__proto__:PropertyChangeSupport,name_:"FObject",replaceModel_:function(model,otherModel,X){for(;otherModel;){var replacementName=(model["package"]?model["package"]+".":"")+(otherModel.name?otherModel.name:otherModel)+model.name,replacementModel=X.lookup(replacementName);if(replacementModel)return replacementModel;otherModel=X.lookup(otherModel.extendsModel)}return void 0},create_:function(){return Object.create(this)},create:function(args,opt_X){if(args&&args.model&&(opt_X||X).Model.isInstance(args.model)){var ret=this.replaceModel_(this.model_,args.model,opt_X||X);if(ret)return ret.create(args,opt_X)}var o=this.create_(this);if(o.instance_={},o.X=opt_X||X,o.Y=o.X.sub({},(o.X.NAME?o.X.NAME:"")+"Y"),this.model_.imports_&&this.model_.imports_.length){Object.prototype.hasOwnProperty.call(this,"imports__")||(this.imports__=this.model_.imports_.map(function(e){var s=e.split(" as ");return[s[0],s[1]||s[0]]}));for(var i=0;i<this.imports__.length;i++){var im=this.imports__[i];args&&args.hasOwnProperty(im[1])||"undefined"==typeof o.X[im[0]]||(o[im[1]]=o.X[im[0]])}}if(o.model_)for(var agents=this.initAgents(),i=0;i<agents.length;i++)agents[i][1](o,o.X,o.Y,args);return o.init(args),o},init:nop,xbind:function(map){return{__proto__:this,create:function(args,X){args=args||{};for(var key in map)args.hasOwnProperty(key)||(args[key]=map[key]);return this.__proto__.create(args,X)},xbind:function(m2){for(var key in map)m2.hasOwnProperty(key)||(m2[key]=map[key]);return this.__proto__.xbind(m2)}}},X:X,addInitAgent:function(priority,desc,agent){agent.toString=function(){return desc},this.initAgents_.push([priority,agent])},initAgents:function(){if(this.model_){if(!Object.hasOwnProperty.call(this,"initAgents_")){var agents=this.initAgents_=[],self=this;Object_forEach(this.model_.exports_,function(e){var exp=e.split("as ");if(0!=exp.length){var key=exp[0].trim(),alias=exp[1]||exp[0];if(key){var asValue="$"!==key&&"$$"!=key&&"$"==key.charAt(key.length-1);asValue&&(key=key.slice(0,key.length-1));var prop=self.model_.getProperty(key);prop?asValue?self.addInitAgent(1,"export property value "+key,function(o,X,Y){Y.set(alias,o[prop.name$_])}):self.addInitAgent(1,"export property "+key,function(o,X,Y){Y.setValue(alias,o[prop.name$_])}):self.addInitAgent(0,"export other "+key,function(o,X,Y){var out="function"==typeof o[key]?o[key].bind(o):o[key];Y.set(alias,out)})}else self.addInitAgent(0,"export this",function(o,X,Y){Y.set(alias,o)})}}),this.model_.properties_.forEach(function(prop){prop.initPropertyAgents?prop.initPropertyAgents(self):self.addInitAgent(0,"set proto-property "+prop.name,function(o,X,Y,m){m&&m.hasOwnProperty(prop.name)&&(o[prop.name]=m[prop.name])})}),self.addInitAgent(0,"Add create() to Model",function(o,X,Y){Model.isInstance(o)&&"Model"!=o.name&&(o.create=BootstrapModel.create)});for(var i=0;i<agents.length;i++)agents[i][2]=i;agents.sort(CompoundComparator(function(o1,o2){return o1[0]-o2[0]},function(o1,o2){return o1[2]-o2[2]}))}return this.initAgents_}},fromElement:function(e){var RESERVED_ATTRS={id:!0,model:!0,view:!0,showactions:!0,oninit:!0},elements=this.elementMap_;if(!elements){elements={};for(var i=0;i<this.model_.properties_.length;i++){var p=this.model_.properties_[i];RESERVED_ATTRS[p.name]||(elements[p.name]=p,elements[p.name.toUpperCase()]=p),elements["p:"+p.name]=p,elements["P:"+p.name.toUpperCase()]=p}this.elementMap_=elements}for(var i=0;i<e.attributes.length;i++){var attr=e.attributes[i],p=elements[attr.name],val=attr.value;if(p)if(val.startsWith("#")){val=val.substring(1);var $val=this.X.$(val);$val?this[attr.name]=this.X.$(val):p.fromString.call(this,val,p)}else p.fromString.call(this,val,p);else RESERVED_ATTRS[attr.name]||console.warn('Unknown attribute name: "'+attr.name+'"')}for(var i=0;i<e.children.length;i++){var c=e.children[i],p=elements[c.nodeName];p?p.fromElement.call(this,c,p):console.warn('Unknown element name: "'+c.nodeName+'"')}return this},installInDocument:function(X,document){for(var i=0;i<this.model_.templates.length;i++){var t=this.model_.templates[i];if("CSS"===t.name)return void t.futureTemplate(function(){X.addStyle(this.CSS())}.bind(this))}},defineFOAMGetter:function(name,getter){var stack=Events.onGet.stack;this.__defineGetter__(name,function(){var value=getter.call(this,name),f=stack[0];return f&&f(this,name,value),value})},defineFOAMSetter:function(name,setter){var stack=Events.onSet.stack;this.__defineSetter__(name,function(newValue){var f=stack[0];(!f||f(this,name,newValue))&&setter.call(this,newValue,name)})},toString:function(){return this.model_.name+"Prototype"},hasOwnProperty:function(name){return"undefined"!=typeof this.instance_[name]},writeActions:function(other,out){for(var i=0,property;property=this.model_.properties_[i];i++)if(property.actionFactory)for(var actions=property.actionFactory(this,property.f(this),property.f(other)),j=0;j<actions.length;j++)out(actions[j])},equals:function(other){return 0==this.compareTo(other)},compareTo:function(other){if(other===this)return 0;if(this.model_!==other.model_)return this.model_.name.compareTo(other.model_.name)||1;for(var ps=this.model_.properties_,i=0;i<ps.length;i++){var r=ps[i].compare(this,other);if(r)return r}return 0},diff:function(other){for(var diff={},i=0,property;property=this.model_.properties_[i];i++)if(Array.isArray(property.f(this))){var subdiff=property.f(this).diff(property.f(other));(0!==subdiff.added.length||0!==subdiff.removed.length)&&(diff[property.name]=subdiff)}else 0!==property.f(this).compareTo(property.f(other))&&(diff[property.name]=property.f(other));return diff},clearProperty:function(name){delete this.instance_[name]},defineProperty:function(prop){var name=prop.name;if(prop.name$_=name+"$",this.__lookupGetter__(prop.name$_)||Object.defineProperty(this,prop.name$_,{get:function(){return this.propertyValue(name)},set:function(value){Events.link(value,this.propertyValue(name))},configurable:!0}),prop.getter)this.defineFOAMGetter(name,prop.getter);else{if(prop.lazyFactory)var getter=function(){return"undefined"!=typeof this.instance_[name]?this.instance_[name]:(this.instance_[name]=prop.lazyFactory.call(this,prop),this.instance_[name])};else getter=prop.factory?function(){if("undefined"==typeof this.instance_[name]){this.instance_[name]=null;var val=prop.factory.call(this,prop);this[name]=val}return this.instance_[name]}:prop.defaultValueFn?function(){return"undefined"!=typeof this.instance_[name]?this.instance_[name]:prop.defaultValueFn.call(this,prop)}:function(){return"undefined"!=typeof this.instance_[name]?this.instance_[name]:prop.defaultValue};this.defineFOAMGetter(name,getter)}if(prop.setter)this.defineFOAMSetter(name,prop.setter);else{var setter=function(oldValue,newValue){this.instance_[name]=newValue};("int"===prop.type||"float"===prop.type)&&(setter=function(setter){return function(oldValue,newValue){setter.call(this,oldValue,"number"!=typeof newValue?Number(newValue):newValue)}}(setter)),prop.onDAOUpdate&&(setter="string"==typeof prop.onDAOUpdate?function(setter,onDAOUpdate,listenerName){return function(oldValue,newValue){setter.call(this,oldValue,newValue);var listener=this[listenerName]||(this[listenerName]=this[onDAOUpdate].bind(this));oldValue&&oldValue.unlisten(listener),newValue&&(newValue.listen(listener),listener())}}(setter,prop.onDAOUpdate,prop.name+"_onDAOUpdate"):function(setter,onDAOUpdate,listenerName){return function(oldValue,newValue){setter.call(this,oldValue,newValue);var listener=this[listenerName]||(this[listenerName]=onDAOUpdate.bind(this));oldValue&&oldValue.unlisten(listener),newValue&&(newValue.listen(listener),listener())}}(setter,prop.onDAOUpdate,prop.name+"_onDAOUpdate")),prop.postSet&&(setter=function(setter,postSet){return function(oldValue,newValue){setter.call(this,oldValue,newValue),postSet.call(this,oldValue,newValue,prop)}}(setter,prop.postSet));var propertyTopic=PropertyChangeSupport.propertyTopic(name);setter=function(setter){return function(oldValue,newValue){setter.call(this,oldValue,newValue),this.propertyChange_(propertyTopic,oldValue,newValue)}}(setter),prop.preSet&&(setter=function(setter,preSet){return function(oldValue,newValue){setter.call(this,oldValue,preSet.call(this,oldValue,newValue,prop))}}(setter,prop.preSet)),prop.adapt&&(setter=function(setter,adapt){return function(oldValue,newValue){setter.call(this,oldValue,adapt.call(this,oldValue,newValue,prop))}}(setter,prop.adapt)),setter=function(setter){return function(newValue){setter.call(this,"undefined"==typeof this.instance_[name]?prop.defaultValue:this.instance_[name],newValue)}}(setter),this.defineFOAMSetter(name,setter)}prop.install&&prop.install.call(this,prop)},addMethod:function(name,method){this.__proto__[name]?override(this,name,method):this[name]=method},hashCode:function(){for(var hash=17,i=0;i<this.model_.properties_.length;i++){var prop=this[this.model_.properties_[i].name],code=prop?prop.hashCode?prop.hashCode():prop.toString().hashCode():0;hash=(hash<<5)-hash+code,hash&=hash}return hash},toProtobuf:function(){var out=ProtoWriter.create();return this.outProtobuf(out),out.value},outProtobuf:function(out){for(var i=0;i<this.model_.properties_.length;i++){var prop=this.model_.properties_[i];Number.isFinite(prop.prototag)&&prop.outProtobuf(this,out)}},clone:function(){var c=Object.create(this.__proto__);c.instance_={},c.X=this.X,c.Y=this.Y;for(var key in this.instance_){var value=this[key];c.instance_[key]=Array.isArray(value)?value.clone():value}return c},deepClone:function(){var cln=this.clone();for(var key in cln.instance_){var val=cln.instance_[key];if(Array.isArray(val))for(var i=0;i<val.length;i++){var obj=val[i];val[i]=obj.deepClone()}}return cln},copyFrom:function(src){if(src&&this.model_)for(var ps=this.model_.properties_,i=0;i<ps.length;i++){var prop=ps[i];src.hasOwnProperty(prop.name)&&(this[prop.name]=src[prop.name]),src.hasOwnProperty(prop.name$_)&&(this[prop.name$_]=src[prop.name$_])}return this},output:function(out){return JSONUtil.output(out,this)},toJSON:function(){return JSONUtil.stringify(this)},toXML:function(){return XMLUtil.stringify(this)},write:function(document,opt_view){var view=(opt_view||X.foam.ui.DetailView).create({model:this.model_,data:this,showActions:!0});view.write(document)},defaultView:function(opt_view){return(opt_view||X.foam.ui.DetailView).create({model:this.model_,data:this,showActions:!0})},decorate:function(name,func,that){var delegate=this[name];return this[name]=function(){return func.call(this,that,delegate.bind(this),arguments)},this},addDecorator:function(decorator){decorator.decorateObject&&decorator.decorateObject(this);for(var i=0;i<decorator.model_.methods.length;i++){var method=decorator.model_.methods[i];"decorateObject"!==method.name&&this.decorate(method.name,method.code,decorator)}return this},getMyFeature:function(featureName){function add(a){if(a)for(var i=0;i<a.length;i++){var f=a[i];map[f.name.toUpperCase()]=f}}if(!Object.prototype.hasOwnProperty.call(this,"featureMap_")){"WebApplication"===this.name&&console.log("done");var map=this.featureMap_={};add(this.properties_),add(this.actions_),add(this.methods),add(this.listeners),add(this.templates),add(this.models),add(this.tests),add(this.relationships),add(this.issues)}return this.featureMap_[featureName.toUpperCase()]},getAllMyFeatures:function(){console.log("********************* getAllMyFeatures");var featureList=[],arrayOrEmpty=function(arr){return arr&&Array.isArray(arr)?arr:[]};return[arrayOrEmpty(this.properties),arrayOrEmpty(this.actions),arrayOrEmpty(this.methods),arrayOrEmpty(this.listeners),arrayOrEmpty(this.templates),arrayOrEmpty(this.models),arrayOrEmpty(this.tests),arrayOrEmpty(this.relationships),arrayOrEmpty(this.issues)].map(function(list){featureList=featureList.concat(list)}),featureList},getFeature:function(featureName){var feature=this.getMyFeature(featureName);if(feature||!this.extendsModel)return feature;var ext=this.X.lookup(this.extendsModel);return ext?ext.getFeature(featureName):void 0},getAllFeatures:function(){var featureList=this.getAllMyFeatures();if(this.extendsModel){var ext=this.X.lookup(this.extendsModel);ext&&ext.getAllFeatures().map(function(subFeat){var subName=subFeat.name.toUpperCase();featureList.mapFind(function(myFeat){return myFeat&&myFeat.name&&myFeat.name.toUpperCase()===subName})||featureList.push(subFeat)})}return featureList}};this.Constant=null,this.Method=null,this.Action=null,this.Relationship=null;var BootstrapModel={__proto__:PropertyChangeSupport,name_:"BootstrapModel <startup only, error if you see this>",buildPrototype:function(){function addTraitToModel(traitModel,parentModel){var parentName=parentModel&&parentModel.id?parentModel.id.replace(/\./g,"__"):"",traitName=traitModel.id?traitModel.id.replace(/\./g,"__"):"",name=parentName+"_ExtendedWith_"+traitName;if(!lookup(name)){var model=traitModel.deepClone();model["package"]="",model.name=name,model.extendsModel=parentModel&&parentModel.id,model.models=traitModel.models,GLOBAL.X.registerModel(model)}var ret=GLOBAL.X.lookup(name);return console.assert(ret,"Error adding Trait to Model, unknown name: ",name),ret}if(DEBUG&&BootstrapModel.saveDefinition(this),!this.finished__&&this["package"]&&console.warn("Building prototype of ",this.id," before being ready."),this.extendsModel&&!this.X.lookup(this.extendsModel))throw"Unknown Model in extendsModel: "+this.extendsModel;var extendsModel=this.extendsModel&&this.X.lookup(this.extendsModel);if(this.traits)for(var i=0;i<this.traits.length;i++){var trait=this.traits[i],traitModel=this.X.lookup(trait);console.assert(traitModel,"Unknown trait: "+trait),traitModel?extendsModel=addTraitToModel(traitModel,extendsModel):console.warn("Missing trait: ",trait,", in Model: ",this.name)}var proto=extendsModel?extendsModel.getPrototype():FObject,cls=Object.create(proto);cls.model_=this,cls.name_=this.name,this.models&&Object_forEach(this.models,function(m){this[m.name]&&(cls[m.name]=this[m.name])}.bind(this)),Object_forEach(this.requires,function(i){var imp=i.split(" as "),m=imp[0],path=m.split("."),key=imp[1]||path[path.length-1];defineLocalProperty(cls,key,function(){var Y=this.Y,model=this.X.lookup(m);console.assert(model,"Unknown Model: "+m+" in "+this.name_);var proto=model.getPrototype();return{__proto__:model,create:function(args,X){return proto.create(args,X||Y)}}})});var props=this.properties_=this.properties?this.properties.clone():[];this.imports_=this.imports,extendsModel&&(this.imports_=this.imports_.concat(extendsModel.imports_)),Object_forEach(this.imports_,function(i){var imp=i.split(" as "),key=imp[0],alias=imp[1]||imp[0];alias.length&&"$"==alias.charAt(alias.length-1)&&(alias=alias.slice(0,alias.length-1)),this.getProperty(alias)||props.push(Property.create({name:alias,"transient":!0,hidden:!0}))}.bind(this));for(var i=0;i<props.length;i++){var p=props[i];if(extendsModel){var superProp=extendsModel.getProperty(p.name);if(superProp){var p0=p,p=superProp.clone().copyFrom(p);p0.adapt&&superProp.adapt&&(p.adapt=function(a1,a2){return function(oldValue,newValue,prop){return a2.call(this,oldValue,a1.call(this,oldValue,newValue,prop),prop)}}(p0.adapt,superProp.adapt)),p0.preSet&&superProp.preSet&&(p.preSet=function(a1,a2){return function(oldValue,newValue,prop){return a2.call(this,oldValue,a1.call(this,oldValue,newValue,prop),prop)}}(p0.preSet,superProp.preSet)),p0.postSet&&superProp.postSet&&(p.postSet=function(a1,a2){return function(oldValue,newValue,prop){a2.call(this,oldValue,newValue,prop),a1.call(this,oldValue,newValue,prop)}}(p0.postSet,superProp.postSet)),props[i]=p,this[constantize(p.name)]=p}}cls.defineProperty(p)}if(this.propertyMap_=null,extendsModel){for(var i=0;i<extendsModel.properties_.length;i++){var p=extendsModel.properties_[i],name=constantize(p.name);this[name]||(this[name]=p)}for(i=0;i<extendsModel.relationships.length;i++){var r=extendsModel.relationships[i],name=constantize(r.name);this[name]||(this[name]=r)}}if(this.exports_=this.exports?this.exports.clone():[],extendsModel&&(this.exports_=this.exports_.concat(extendsModel.exports_)),this.templates&&Object_forEach(this.templates,function(t){cls.addMethod(t.name,t.code?t.code:TemplateUtil.lazyCompile(t))}),this.actions_=this.actions?this.actions.clone():[],this.actions)for(var i=0;i<this.actions.length;i++)(function(a){if(extendsModel){var superAction=extendsModel.getAction(a.name);superAction&&(a=superAction.clone().copyFrom(a))}this.actions_[i]=a,Object.prototype.hasOwnProperty.call(cls,constantize(a.name))||(cls[constantize(a.name)]=a),cls.addMethod(a.name,function(opt_x){a.callIfEnabled(opt_x||this.X,this)})}).bind(this)(this.actions[i]);var key;for(key in this.constants){var c=this.constants[key];Constant?(Constant.isInstance(c)||(c=this.constants[key]=Constant.create(c)),Object.defineProperty(cls,c.name,{value:c.value}),Object.defineProperty(this,c.name,{value:c.value})):console.warn("Defining constant before Constant.")}for(key in this.messages){var c=this.messages[key];Message?(Message.isInstance(c)||(c=this.messages[key]=Message.create(c)),Object.defineProperty(cls,c.name,{get:function(){return c.value}}),Object.defineProperty(this,c.name,{get:function(){return c.value}})):console.warn("Defining message before Message.")}for(key in this.methods){var m=this.methods[key];Method&&Method.isInstance(m)?cls.addMethod(m.name,m.generateFunction()):cls.addMethod(key,m)}var self=this;this.relationships&&this.relationships.forEach(function(r){var name=constantize(r.name);self[name]||(self[name]=r),defineLazyProperty(cls,r.name,function(){var m=this.X.lookup(r.relatedModel),lcName=m.name[0].toLowerCase()+m.name.substring(1),dao=this.X[lcName+"DAO"]||this.X[m.name+"DAO"]||this.X[m.plural];return dao||console.error("Relationship "+r.name+" needs "+(m.name+"DAO")+" or "+m.plural+" in the context, and neither was found."),{get:function(){return dao.where(EQ(m.getProperty(r.relatedProperty),this.id))},configurable:!0}})});var createListenerTrampoline=function(cls,name,fn,isMerged,isFramed,whenIdle){console.assert(fn,"createListenerTrampoline: fn not defined"),fn.name=name,Object.defineProperty(cls,name,{get:function(){var l=fn.bind(this);return whenIdle&&(l=Movement.whenIdle(l)),isFramed?l=EventService.framed(l,this.X):isMerged&&(l=EventService.merged(l,isMerged===!0?void 0:isMerged,this.X)),Object.defineProperty(this,name,{value:l}),l},configurable:!0})};if(Array.isArray(this.listeners))for(var i=0;i<this.listeners.length;i++){var l=this.listeners[i];createListenerTrampoline(cls,l.name,l.code,l.isMerged,l.isFramed,l.whenIdle)}else this.listeners&&Object_forEach(this.listeners,function(l,key){createListenerTrampoline(cls,key,l)});if(this.topics&&Object_forEach(this.topics,function(t){}),extendsModel){this.getProperty("");for(var i=extendsModel.properties_.length-1;i>=0;i--){var p=extendsModel.properties_[i];this.getProperty(p.name)||(this.properties_.unshift(p),this.propertyMap_[p.name]=p)}for(var i=extendsModel.actions_.length-1;i>=0;i--){var a=extendsModel.actions_[i];this.getAction&&this.getAction(a.name)||this.actions_.unshift(a)}}if(this.properties_.length>0&&!cls.__lookupGetter__("id")){var primaryKey=this.ids;1==primaryKey.length?(cls.__defineGetter__("id",function(){return this[primaryKey[0]]}),cls.__defineSetter__("id",function(val){this[primaryKey[0]]=val})):primaryKey.length>1&&(cls.__defineGetter__("id",function(){return primaryKey.map(function(key){return this[key]}.bind(this))}),cls.__defineSetter__("id",function(val){primaryKey.map(function(key,i){this[key]=val[i]}.bind(this))}))}return cls},getAllRequires:function(){function setModel(o){o&&o.model_&&(requires[o.model_.id]=!0)}var requires={};return this.requires.forEach(function(r){requires[r.split(" ")[0]]=!0}),this.traits.forEach(function(t){requires[t]=!0}),this.extendsModel&&(requires[this.extendsModel]=!0),this.properties.forEach(setModel),this.actions.forEach(setModel),this.templates.forEach(setModel),this.listeners.forEach(setModel),Object.keys(requires)},getPrototype:function(){return this.instance_.prototype_||(this.instance_.prototype_=this.buildPrototype())},saveDefinition:function(self){self.definition_={},Array.isArray(self.methods)&&(self.definition_.methods=[].concat(self.methods)),Array.isArray(self.templates)&&(self.definition_.templates=[].concat(self.templates)),Array.isArray(self.relationships)&&(self.definition_.relationships=[].concat(self.relationships)),Array.isArray(self.properties)&&(self.definition_.properties=[].concat(self.properties)),Array.isArray(self.actions)&&(self.definition_.actions=[].concat(self.actions)),Array.isArray(self.listeners)&&(self.definition_.listeners=[].concat(self.listeners)),Array.isArray(self.models)&&(self.definition_.models=[].concat(self.models)),Array.isArray(self.tests)&&(self.definition_.tests=[].concat(self.tests)),Array.isArray(self.issues)&&(self.definition_.issues=[].concat(self.issues)),self.definition_.__proto__=FObject},create:function(args,opt_X){return this.getPrototype().create(args,opt_X)},isSubModel:function(model){return model&&model.getPrototype&&(model.getPrototype()===this.getPrototype()||this.isSubModel(model.getPrototype().__proto__.model_))},getProperty:function(name){if(!this.propertyMap_){this.properties_||this.getPrototype();for(var m={},i=0;i<this.properties_.length;i++){var prop=this.properties_[i];m[prop.name]=prop}this.propertyMap_=m}return this.propertyMap_[name]},getAction:function(name){for(var i=0;i<this.actions_.length;i++)if(this.actions_[i].name===name)return this.actions_[i]},hashCode:function(){var string="";for(var key in this.properties_)string+=this.properties_[key].toString();return string.hashCode()},isInstance:function(obj){return obj&&obj.model_&&this.isSubModel(obj.model_)},toString:function(){return"BootstrapModel("+this.name+")"},arequire:function(){if(this.required__)return this.required__;
var future=afuture();this.required__=future.get;var go=function(){var args=[];this.extendsModel&&args.push(arequire(this.extendsModel,this.X));var i;if(this.traits)for(i=0;i<this.traits.length;i++)args.push(arequire(this.traits[i],this.X));var model=this;if(this.templates)for(i=0;i<this.templates.length;i++){var t=this.templates[i];args.push(aif(!t.code,aseq(aevalTemplate(this.templates[i],this),function(t){return function(ret,m){t.code=m,ret()}}(t))))}if(args.length&&(args=[aseq.apply(null,args)]),this.requires)for(var i=0;i<this.requires.length;i++){var r=this.requires[i],m=r.split(" as ");m[0]==this.id?console.warn("Model requires itself: "+this.id):args.push(arequire(m[0],this.X))}apar.apply(apar,args)(function(){this.finished__=!0,future.set(this)}.bind(this))}.bind(this);return this.extra__?this.extra__(go):go(),this.required__}},BinaryProtoGrammar,DocumentationBootstrap={name:"documentation",type:"Documentation",view:function(){return X.foam.ui.DetailView.create({model:Documentation})},help:"Documentation associated with this entity.",documentation:"The developer documentation for this $$DOC{ref:'.'}. Use a $$DOC{ref:'DocModelView'} to view documentation.",setter:function(nu){DEBUG&&(this.instance_.documentation=nu)},getter:function(){if(!DEBUG)return"";var doc=this.instance_.documentation;return!doc||"undefined"==typeof Documentation||!Documentation||doc.model_&&doc.model_.getPrototype&&Documentation.isInstance(doc)||(this.instance_.documentation=Documentation.create(doc.body?doc:{body:doc})),this.instance_.documentation}},Model={__proto__:BootstrapModel,instance_:{},name:"Model",plural:"Models",help:"Describes the attributes and properties of an entity.",documentation:{body:function(){}},tableProperties:["package","name","label","plural"],properties:[{name:"id",hidden:!0,"transient":!0},{name:"sourcePath",help:"Source location of this Model.",defaultValue:"",mode:"read-only","transient":!0},{name:"abstract",type:"boolean",defaultValue:!1,help:"If the java class is abstract.",documentation:function(){}},{name:"package",help:"Package that this Model belongs to.",defaultValue:"",postSet:function(_,p){return this.id=p?p+"."+this.name:this.name},documentation:function(){}},{name:"name",type:"String",postSet:function(_,n){return this.id=this["package"]?this["package"]+"."+n:n},required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the entity.",documentation:function(){}},{name:"label",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.name.labelize()},help:"The display label for the entity.",documentation:function(){}},{name:"javaClassName",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return(this["abstract"]?"Abstract":"")+this.name},help:"The Java classname of this Model.",documentation:function(){}},{name:"extendsModel",label:"Extends",type:"String",displayWidth:70,displayHeight:1,defaultValue:"",help:"The parent model of this model.",documentation:function(){}},{name:"traits",type:"Array[String]",view:"foam.ui.StringArrayView",defaultValueFn:function(){return[]},help:"Traits to mix-into this Model.",documentation:function(){}},{name:"plural",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.name+"s"},help:"The plural form of this model's name.",documentation:function(){}},{name:"version",type:"int",defaultValue:1,help:"Version number of model.",documentation:function(){}},{name:"ids",label:"Key Properties",type:"Array[String]",view:"foam.ui.StringArrayView",defaultValueFn:function(){var id=this.getProperty("id");return id?["id"]:this.properties_.length?[this.properties_[0].name]:[]},help:"Properties which make up unique id.",documentation:function(){}},{name:"requires",type:"Array[String]",view:"foam.ui.StringArrayView",defaultValueFn:function(){return[]},help:"Model imports.",documentation:function(){}},{name:"imports",type:"Array[String]",view:"foam.ui.StringArrayView",defaultValueFn:function(){return[]},help:"Context imports.",documentation:function(){}},{name:"exports",type:"Array[String]",view:"foam.ui.StringArrayView",defaultValueFn:function(){return[]},help:"Context exports.",documentation:function(){}},{name:"implements",type:"Array[String]",view:"foam.ui.StringArrayView",defaultValueFn:function(){return[]},help:"Interfaces implemented by this Model.",documentation:function(){}},{name:"tableProperties",type:"Array[String]",view:"foam.ui.StringArrayView",displayWidth:70,lazyFactory:function(){return this.properties_.map(function(o){return o.name})},help:"Properties to be displayed in table view. Defaults to all properties.",documentation:function(){}},{name:"searchProperties",type:"Array[String]",view:"foam.ui.StringArrayView",displayWidth:70,defaultValueFn:function(){return this.tableProperties},help:"Properties display in a search view. Defaults to table properties.",documentation:function(){}},{name:"properties",type:"Array[Property]",subType:"Property",view:"foam.ui.ArrayView",factory:function(){return[]},defaultValue:[],help:"Properties associated with the entity.",preSet:function(oldValue,newValue){if(Property){for(var i=0;i<newValue.length;i++){var p=newValue[i];"string"==typeof p&&(newValue[i]=p={name:p}),p.model_?"string"==typeof p.model_&&(p=newValue[i]=JSONUtil.mapToObj(this.X,p)):p=newValue[i]=Property.create(p),this[constantize(p.name)]=newValue[i]}return this.propertyMap_=null,newValue}},documentation:function(){}},{name:"actions",type:"Array[Action]",subType:"Action",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},defaultValue:[],help:"Actions associated with the entity.",preSet:function(_,newValue){if(!Action)return newValue;for(var i=0;i<newValue.length;i++){var p=newValue[i];p.model_?"string"==typeof p.model_&&(newValue[i]=FOAM(p)):newValue[i]=Action.create(p),p.name&&(this[constantize(p.name)]=newValue[i])}return newValue},documentation:function(){}},{name:"constants",type:"Array[Constant]",subType:"Constant",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},defaultValue:[],help:"Constants associated with the entity.",preSet:function(_,newValue){if(!Constant)return newValue;if(Array.isArray(newValue))return JSONUtil.arrayToObjArray(this.X,newValue,Constant);var constants=[];for(var key in newValue){var oldValue=newValue[key],constant=Constant.create({name:key,value:oldValue});constants.push(constant)}return constants}},{name:"messages",type:"Array[Message]",subType:"Constant",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},defaultValue:[],help:"Messages associated with the entity.",preSet:function(_,newValue){if(!GLOBAL.Message)return newValue;if(Array.isArray(newValue))return JSONUtil.arrayToObjArray(this.X,newValue,Message);var messages=[];for(var key in newValue){var oldValue=newValue[key],message=Message.create({name:key,value:oldValue});messages.push(message)}return messages}},{model_:"ArrayProperty",name:"methods",subType:"Method",help:"Methods associated with the entity.",adapt:function(_,newValue){if(!Method)return newValue;if(Array.isArray(newValue))return JSONUtil.arrayToObjArray(this.X,newValue,Method);var methods=[];for(var key in newValue){var oldValue=newValue[key],method=Method.create({name:key,code:oldValue});if("function"==typeof oldValue){if(Arg&&DEBUG){var str=oldValue.toString();method.args=str.match(/^function[ _$\w]*\(([ ,\w]*)/)[1].split(",").filter(function(name){return name}).map(function(name){return Arg.create({name:name.trim()})})}}else console.warn("Constant defined as Method: ",this.name+"."+key);methods.push(method)}return methods},documentation:function(){}},{name:"listeners",type:"Array[Method]",subType:"Method",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},preSet:function(_,newValue){return Array.isArray(newValue)?JSONUtil.arrayToObjArray(this.X,newValue,Method):newValue},defaultValue:[],help:"Event listeners associated with the entity.",documentation:function(){}},{name:"templates",type:"Array[Template]",subType:"Template",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},defaultValue:[],postSet:function(_,templates){TemplateUtil.expandModelTemplates(this)},help:"Templates associated with this entity.",documentation:function(){}},{name:"models",type:"Array[Model]",subType:"Model",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},adapt:function(_,newValue){return Model&&Array.isArray(newValue)?JSONUtil.arrayToObjArray(this.X,newValue,Model):newValue},postSet:function(){this.models.forEach(function(m){this[m.name]=m}.bind(this))},defaultValue:[],help:"Sub-models embedded within this model.",documentation:function(){}},{name:"tests",label:"Unit Tests",type:"Array[Unit Test]",subType:"UnitTest",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},defaultValue:[],help:"Unit tests associated with this model.",documentation:function(){}},{name:"relationships",subType:"Relationship",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},defaultValue:[],help:"Relationships of this model to other models.",preSet:function(_,newValue){if(!Relationship)return newValue;for(var i=0;i<newValue.length;i++){var p=newValue[i];p.model_?"string"==typeof p.model_&&(p=newValue[i]=FOAM(p)):p=newValue[i]=Relationship.create(p),this[constantize(p.name)]=newValue[i]}return newValue},documentation:function(){}},{name:"issues",type:"Array[Issue]",subType:"Issue",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},defaultValue:[],help:"Issues associated with this model.",documentation:function(){}},{name:"help",label:"Help Text",type:"String",displayWidth:70,displayHeight:6,view:"foam.ui.TextAreaView",defaultValue:"",help:"Help text associated with the entity.",documentation:function(){}},{name:"i18nComplete_",defaultValue:!1,hidden:!0,"transient":!0},{name:"translationHint",label:"Description for Translation",type:"String",defaultValueFn:function(){return this.name}},DocumentationBootstrap,{name:"notes",type:"String",displayWidth:70,displayHeight:6,view:"foam.ui.TextAreaView",defaultValue:"",help:"Internal documentation associated with this entity.",documentation:function(){}},{name:"createActionFactory",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",help:"Factory to create the action object for creating this object",documentation:function(){}},{name:"deleteActionFactory",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",help:"Factory to create the action object for deleting this object",documentation:function(){}},{name:"properties_","transient":!0,hidden:!0,help:"Runtime properties of the model."},{name:"imports_","transient":!0,hidden:!0,help:"Runtime imports of the model."},{name:"exports_","transient":!0,hidden:!0,help:"Runtime exports of the model."},{name:"actions_","transient":!0,hidden:!0,help:"Runtime actions of the model."}],toString:function(){return"Model"}},Property={__proto__:BootstrapModel,instance_:{},name:"Property",plural:"Properties",help:"Describes a properties of a modelled entity.",ids:["name"],tableProperties:["name","label","type","required","defaultValue"],documentation:function(){},properties:[{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the property.",documentation:function(){}},{name:"label",type:"String",required:!1,displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.name.labelize()},help:"The display label for the property.",documentation:function(){}},{name:"speechLabel",type:"String",required:!1,displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.label},help:"The speech label for the property.",documentation:function(){}},{name:"tableLabel",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.name.labelize()},help:"The table display label for the entity.",documentation:function(){}},{name:"type",type:"String",required:!0,view:{factory_:"foam.ui.ChoiceView",choices:["Array","Boolean","Color","Date","DateTime","Email","Enum","Float","Function","Image","Int","Object","Password","String","String[]","URL"]},defaultValue:"String",help:"The type of the property.",documentation:function(){}},{name:"protobufType",type:"String",required:!1,help:"The protobuf type that represents the type of this property.",defaultValueFn:function(){return this.type.toLowerCase()},documentation:function(){}},{name:"javaType",type:"String",required:!1,defaultValueFn:function(){return this.type},help:"The java type that represents the type of this property.",documentation:function(){}},{name:"javascriptType",type:"String",required:!1,defaultValueFn:function(){return this.type},help:"The javascript type that represents the type of this property.",documentation:function(){}},{name:"shortName",type:"String",required:!0,displayWidth:10,displayHeight:1,defaultValue:"",help:"A short alternate name to be used for compact encoding.",documentation:"A short alternate $$DOC{ref:'.name'} to be used for compact encoding."},{name:"singular",type:"String",required:!1,displayWidth:70},{name:"aliases",type:"Array[String]",view:"foam.ui.StringArrayView",defaultValue:[],help:"Alternate names for this property.",documentation:function(){}},{name:"mode",type:"String",defaultValue:"read-write",view:{factory_:"foam.ui.ChoiceView",choices:["read-only","read-write","final"]},documentation:function(){}},{name:"subType",label:"Sub-Type",type:"String",displayWidth:30,help:"The type of the property.",documentation:function(){}},{name:"units",type:"String",required:!0,displayWidth:70,displayHeight:1,defaultValue:"",help:"The units of the property.",documentation:function(){}},{name:"required",type:"Boolean",view:"foam.ui.BooleanView",defaultValue:!0,help:"Indicates if the property is a required field.",documentation:function(){}},{name:"hidden",type:"Boolean",view:"foam.ui.BooleanView",defaultValue:!1,help:"Indicates if the property is hidden.",documentation:function(){}},{name:"transient",type:"Boolean",view:"foam.ui.BooleanView",defaultValue:!1,help:"Indicates if the property is transient.",documentation:function(){}},{name:"displayWidth",type:"int",displayWidth:8,displayHeight:1,defaultValue:"30",help:"The display width of the property.",documentation:function(){}},{name:"displayHeight",type:"int",displayWidth:8,displayHeight:1,defaultValue:1,help:"The display height of the property.",documentation:function(){}},{model_:"ViewFactoryProperty",name:"view",type:"view",defaultValue:"foam.ui.TextFieldView",help:"View component for the property.",documentation:function(){}},{model_:"ViewFactoryProperty",name:"detailView",type:"view",defaultValueFn:function(){return this.view},help:"View component for the property when rendering within a DetailView.",documentation:function(){}},{model_:"ViewFactoryProperty",name:"citationView",type:"view",defaultValueFn:function(){return this.view},help:"View component for the property when rendering within a CitationView.",documentation:function(){}},{name:"detailViewPreRow",defaultValue:function(){return""},help:"Inject HTML before row in DetailView.",documentation:function(){}},{name:"detailViewPostRow",defaultValue:function(){return""},help:"Inject HTML before row in DetailView.",documentation:function(){}},{name:"defaultValue",type:"String",required:!1,displayWidth:70,displayHeight:1,defaultValue:"",postSet:function(old,nu){nu&&this.defaultValueFn&&(this.defaultValueFn=void 0)},help:"The property's default value.",documentation:function(){}},{name:"defaultValueFn",label:"Default Value Function",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",postSet:function(old,nu){nu&&this.defaultValue&&(this.defaultValue=void 0)},help:"The property's default value function.",documentation:function(){}},{name:"dynamicValue",label:"Value's Dynamic Function",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",help:"A dynamic function which computes the property's value.",documentation:function(){}},{name:"factory",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",help:"Factory for creating initial value when new object instantiated.",documentation:function(){}},{name:"lazyFactory",type:"Function",required:!1,view:"foam.ui.FunctionView",help:"Factory for creating the initial value. Only called when the property is accessed for the first time.",documentation:function(){}},{name:"getter",type:"Function",required:!1,displayWidth:70,displayHeight:3,view:"foam.ui.FunctionView",defaultValue:"",help:"The property's default value function.",documentation:function(){}},{name:"adapt",type:"Function",required:!1,displayWidth:70,displayHeight:3,view:"foam.ui.FunctionView",defaultValue:"",help:"An adapter function called before preSet.",documentation:function(){}},{name:"preSet",type:"Function",required:!1,displayWidth:70,displayHeight:3,view:"foam.ui.FunctionView",defaultValue:"",help:"An adapter function called before normal setter logic.",documentation:function(){}},{name:"postSet",type:"Function",required:!1,displayWidth:70,displayHeight:3,view:"foam.ui.FunctionView",defaultValue:"",help:"A function called after normal setter logic, but before property change event fired.",documentation:function(){}},{name:"setter",type:"Function",required:!1,displayWidth:70,displayHeight:3,view:"foam.ui.FunctionView",defaultValue:"",help:"The property's default value function.",documentation:function(){}},{name:"tableFormatter",label:"Table Cell Formatter",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",help:"Function to format value for display in TableView.",documentation:"A function to format the value for display in a $$DOC{ref:'foam.ui.TableView'}."},{name:"summaryFormatter",label:"Summary Formatter",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",help:"Function to format value for display in SummaryView.",documentation:"A function to format the value for display in a $$DOC{ref:'SummaryView'}."},{name:"tableWidth",type:"String",required:!1,defaultValue:"",help:"Table View Column Width.",documentation:"A Suggestion for $$DOC{ref:'foam.ui.TableView'} column width."},{name:"help",label:"Help Text",type:"String",required:!1,displayWidth:70,displayHeight:6,view:"foam.ui.TextAreaView",defaultValue:"",help:"Help text associated with the property.",documentation:function(){}},DocumentationBootstrap,{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field.",documentation:"The protobuf tag number for this field."},{name:"actionFactory",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",help:"Factory to create the action objects for taking this property from value A to value B",documentation:"Factory to create the $$DOC{ref:'Action'} objects for taking this $$DOC{ref:'Property'} from value A to value B"},{name:"compareProperty",type:"Function",view:"foam.ui.FunctionView",displayWidth:70,displayHeight:5,defaultValue:function(o1,o2){return o1===o2?0:o1.localeCompare?o1.localeCompare(o2):o1.compareTo?o1.compareTo(o2):o1.$UID.compareTo(o2.$UID)},help:"Comparator function.",documentation:"A comparator function two compare two instances of this $$DOC{ref:'Property'}."},{name:"fromString",defaultValue:function(s,p){this[p.name]=s},help:"Function to extract value from a String."},{name:"fromElement",defaultValue:function(e,p){if(!p.type||!this.X.lookup||"String"===p.type)return void p.fromString.call(this,e.innerHTML,p);var model=this.X.lookup(p.type);if(!model)return void p.fromString.call(this,e.innerHTML,p);var o=model.create();return o.fromElement?void(this[p.name]=o.fromElement(e)):void p.fromString.call(this,e.innerHTML,p)},help:"Function to extract from a DOM Element.",documentation:"Function to extract a value from a DOM Element."},{name:"propertyToJSON",defaultValue:function(visitor,output,o){this["transient"]||(output[this.name]=visitor.visit(o[this.name]))},help:"Function to extract from a DOM Element.",documentation:"Function to extract a value from a DOM Element."},{name:"autocompleter",subType:"Autocompleter",help:"Name or model for the autocompleter for this property.",documentation:function(){}},{name:"install",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",help:"A function which installs additional features into the Model's prototype.",documentation:function(){}},{name:"exclusive",type:"Boolean",view:"foam.ui.BooleanView",defaultValue:!0,help:"Indicates if the property can only have a single value.",documentation:function(){}},{name:"memorable",type:"Boolean",help:"True if this value should be included in a memento for this object.",defaultValue:!1}],methods:{partialEval:function(){return this},f:function(obj){return obj[this.name]},compare:function(o1,o2){return this.compareProperty(this.f(o1),this.f(o2))},toSQL:function(){return this.name},toMQL:function(){return this.name},toBQL:function(){return this.name},initPropertyAgents:function(proto){var prop=this,name=prop.name,name$_=prop.name$_;proto.addInitAgent(this.postSet||this.setter?9:0,name+": "+(this.postSet||this.setter?"copy arg (postSet)":"copy arg"),function(o,X,Y,m){m&&(m.hasOwnProperty(name)&&(o[name]=m[name]),m.hasOwnProperty(name$_)&&(o[name$_]=m[name$_]))}),this.dynamicValue&&proto.addInitAgent(10,name+": dynamicValue",function(o,X,Y){var dynamicValue=prop.dynamicValue;Events.dynamic(dynamicValue.bind(o),function(value){o[name]=value})}),this.factory&&proto.addInitAgent(11,name+": factory",function(o,X,Y){o.hasOwnProperty(name)||o[name]})}},toString:function(){return"Property"}};Model.methods={getProperty:BootstrapModel.getProperty,getAction:BootstrapModel.getAction,hashCode:BootstrapModel.hashCode,buildPrototype:BootstrapModel.buildPrototype,getPrototype:BootstrapModel.getPrototype,isSubModel:BootstrapModel.isSubModel,isInstance:BootstrapModel.isInstance,getAllRequires:BootstrapModel.getAllRequires,arequire:BootstrapModel.arequire},Model=Model.create(Model),Model.model_=Model,Model.create=BootstrapModel.create,Property=Model.create(Property);for(var i=0;i<Property.properties.length;i++)Property.properties[i]=Property.create(Property.properties[i]);for(var i=0;i<Property.properties_.length;i++)Property[constantize(Property.properties_[i].name)]=Property.properties_[i]=Property.create(Property.properties_[i]);USED_MODELS.Property=!0,USED_MODELS.Model=!0,CLASS({extendsModel:"Property",name:"StringProperty",help:"Describes a properties of type String.",properties:[{name:"displayHeight",type:"int",displayWidth:8,defaultValue:1,help:"The display height of the property."},{name:"type",type:"String",displayWidth:20,defaultValue:"String",help:"The FOAM type of this property."},{name:"adapt",defaultValue:function(_,v){return void 0===v||null===v?"":"function"==typeof v?multiline(v):v.toString()}},{name:"javaType",type:"String",displayWidth:70,defaultValue:"String",help:"The Java type of this property."},{name:"view",defaultValue:"foam.ui.TextFieldView"},{name:"pattern",help:"Regex pattern for property."},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."}]}),CLASS({extendsModel:"Property",name:"BooleanProperty",help:"Describes a properties of type Boolean.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Boolean",help:"The FOAM type of this property."},{name:"javaType",type:"String",displayWidth:70,defaultValue:"bool",help:"The Java type of this property."},{name:"view",defaultValue:"foam.ui.BooleanView"},{name:"defaultValue",defaultValue:!1},{name:"adapt",defaultValue:function(_,v){return!!v}},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."},{name:"fromString",defaultValue:function(s,p){var txt=s.trim();this[p.name]=txt.equalsIC("y")||txt.equalsIC("yes")||txt.equalsIC("true")||txt.equalsIC("t")},help:"Function to extract value from a String."}]}),CLASS({extendsModel:"Property",name:"DateProperty",help:"Describes a properties of type Date.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Date",help:"The FOAM type of this property."},{name:"displayWidth",defaultValue:50},{name:"javaType",type:"String",defaultValue:"Date",help:"The Java type of this property."},{name:"view",defaultValue:"foam.ui.DateFieldView"},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."},{name:"adapt",defaultValue:function(_,d){return"string"==typeof d?new Date(d):d}},{name:"tableFormatter",defaultValue:function(d){return d?d.toRelativeDateString():""}},{name:"compareProperty",defaultValue:function(o1,o2){return o1?o2?o1.compareTo(o2):1:o2?-1:0}}]}),CLASS({extendsModel:"DateProperty",name:"DateTimeProperty",help:"Describes a properties of type DateTime.",properties:[{name:"type",type:"String",displayWidth:25,defaultValue:"datetime",help:"The FOAM type of this property."},{name:"adapt",defaultValue:function(_,d){return"number"==typeof d?new Date(d):"string"==typeof d?new Date(d):d}},{name:"view",defaultValue:"foam.ui.DateTimeFieldView"}]}),CLASS({extendsModel:"Property",name:"IntProperty",help:"Describes a properties of type Int.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Int",help:"The FOAM type of this property."},{name:"displayWidth",defaultValue:10},{name:"javaType",type:"String",displayWidth:10,defaultValue:"int",help:"The Java type of this property."},{name:"view",defaultValue:"foam.ui.IntFieldView"},{name:"adapt",defaultValue:function(_,v){return"number"==typeof v?Math.round(v):v?parseInt(v):0}},{name:"defaultValue",defaultValue:0},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."},{name:"compareProperty",defaultValue:function(o1,o2){return o1===o2?0:o1>o2?1:-1}}]}),CLASS({extendsModel:"Property",name:"FloatProperty",help:"Describes a properties of type Float.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Float",help:"The FOAM type of this property."},{name:"defaultValue",defaultValue:0},{name:"javaType",type:"String",displayWidth:10,defaultValue:"double",help:"The Java type of this property."},{name:"displayWidth",defaultValue:15},{name:"view",defaultValue:"foam.ui.FloatFieldView"},{name:"adapt",defaultValue:function(_,v){return"number"==typeof v?v:v?parseFloat(v):0}},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."}]}),CLASS({extendsModel:"Property",name:"FunctionProperty",help:"Describes a properties of type Function.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Function",help:"The FOAM type of this property."},{name:"javaType",type:"String",displayWidth:10,defaultValue:"Function",help:"The Java type of this property."},{name:"displayWidth",defaultValue:15},{name:"view",defaultValue:"foam.ui.FunctionView"},{name:"defaultValue",defaultValue:function(){}},{name:"fromElement",defaultValue:function(e,p){var txt=e.innerHTML.trim();this[p.name]=txt.startsWith("function")?eval("("+txt+")"):new Function(txt)}},{name:"adapt",defaultValue:function(_,value){return"string"==typeof value?value.startsWith("function")?eval("("+value+")"):new Function(value):value}}]}),CLASS({extendsModel:"Property",name:"ArrayProperty",help:"Describes a properties of type Array.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Array",help:"The FOAM type of this property."},{name:"singular",type:"String",displayWidth:70,defaultValueFn:function(){return this.name.replace(/s$/,"")},help:"The plural form of this model's name.",documentation:function(){}},{name:"subType",type:"String",displayWidth:20,defaultValue:"",help:"The FOAM sub-type of this property."},{name:"protobufType",defaultValueFn:function(){return this.subType}},{name:"adapt",defaultValue:function(_,a,prop){var m=this.X.lookup(prop.subType)||GLOBAL.lookup(prop.subType);if(!m)return a;for(var i=0;i<a.length;i++)a[i]=a[i].model_?FOAM(a[i]):m.create(a[i]);return a}},{name:"postSet",defaultValue:function(oldA,a,prop){var name=prop.name+"ArrayRelay_",l=this[name]||(this[name]=function(){this.propertyChange(prop.name,null,this[prop.name])}.bind(this));oldA&&oldA.unlisten&&oldA.unlisten(l),a&&a.listen&&a.listen(l)}},{name:"javaType",type:"String",displayWidth:10,defaultValueFn:function(p){return p.subType+"[]"},help:"The Java type of this property."},{name:"view",defaultValue:"foam.ui.ArrayView"},{name:"factory",defaultValue:function(){return[]}},{name:"propertyToJSON",defaultValue:function(visitor,output,o){!this["transient"]&&o[this.name].length&&(output[this.name]=visitor.visitArray(o[this.name]))}},{name:"install",defaultValue:function(prop){defineLazyProperty(this,prop.name+"$Proxy",function(){var proxy=this.X.lookup("foam.dao.ProxyDAO").create({delegate:this[prop.name].dao});return this.addPropertyListener(prop.name,function(_,_,_,a){proxy.delegate=a.dao}),{get:function(){return proxy},configurable:!0}}),this.addMethod("get"+capitalize(prop.singular),function(id){for(var i=0;i<this[prop.name].length;i++)if(this[prop.name][i].id===id)return this[prop.name][i]})}},{name:"fromElement",defaultValue:function(e,p){for(var model=this.X.lookup(e.getAttribute("model")||p.subType),children=e.children,a=[],i=0;i<children.length;i++){var o=model.create(null,this.Y);o.fromElement(children[i],p),a.push(o)}this[p.name]=a}},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."}]}),CLASS({extendsModel:"Property",name:"ReferenceProperty",help:"A foreign key reference to another Entity.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Reference",help:"The FOAM type of this property."},{name:"subType",type:"String",displayWidth:20,defaultValue:"",help:"The FOAM sub-type of this property."},{name:"subKey",type:"EXPR",displayWidth:20,defaultValue:"ID",help:"The foreign key that this property references."},{name:"javaType",type:"String",displayWidth:10,defaultValueFn:function(p){return"Object"},help:"The Java type of this property."},{name:"view",defaultValue:"foam.ui.TextFieldView"},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."}]}),CLASS({extendsModel:"Property",name:"StringArrayProperty",help:"An array of String values.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Array[]",help:"The FOAM type of this property."},{name:"singular",type:"String",displayWidth:70,defaultValueFn:function(){return this.name.replace(/s$/,"")},help:"The plural form of this model's name.",documentation:function(){}},{name:"subType",type:"String",displayWidth:20,defaultValue:"String",help:"The FOAM sub-type of this property."},{name:"displayWidth",defaultValue:50},{name:"adapt",defaultValue:function(_,v){return Array.isArray(v)?v:[v]
}},{name:"factory",defaultValue:function(){return[]}},{name:"javaType",type:"String",displayWidth:10,defaultValue:"String[]",help:"The Java type of this property."},{name:"view",defaultValue:"foam.ui.StringArrayView"},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."},{name:"exclusive",defaultValue:!1},{name:"fromString",defaultValue:function(s,p){this[p.name]=s.split(",")}},{name:"fromElement",defaultValue:function(e,p){for(var val=[],name=p.singular||"item",i=0;i<e.children.length;i++)e.children[i].nodeName===name&&val.push(e.children[i].innerHTML);this[p.name]=val}}]}),CLASS({name:"ModelProperty",extendsModel:"Property",help:"Describes a Model property.",properties:[{name:"type",defaultValue:"Model"},{name:"getter",defaultValue:function(name){var value=this.instance_[name];if("undefined"==typeof value){var prop=this.model_.getProperty(name);value=prop&&prop.defaultValueFn?prop.defaultValueFn.call(this,prop):prop.defaultValue}return this.X.lookup(value)}},{name:"propertyToJSON",defaultValue:function(visitor,output,o){this["transient"]||(output[this.name]=o[this.name].id)}}]}),CLASS({name:"ViewProperty",extendsModel:"Property",help:"Describes a View-Factory property.",properties:[{name:"adapt",doc:"Can be specified as either a function, a Model, a Model path, or a JSON object.",defaultValue:function(_,f){return"function"==typeof f?f:"string"==typeof f?function(d,opt_X){return(opt_X||this.X).lookup(f).create(d,opt_X||this.Y)}.bind(this):"function"==typeof f.create?f.create.bind(f):"string"==typeof f.model_?function(d,opt_X){return FOAM(f,opt_X||this.Y).copyFrom(d)}:(console.error("******* Unknown view factory: ",f),f)}},{name:"defaultValue",adapt:function(_,f){return ViewProperty.ADAPT.defaultValue.call(this,null,f)}}]}),CLASS({name:"FactoryProperty",extendsModel:"Property",help:"Describes a Factory property.",properties:[{name:"preSet",doc:"Can be specified as either a function, a Model, a Model path, or a JSON object.",defaultValue:function(_,f){return"function"==typeof f?f:"string"==typeof f?function(map,opt_X){return(opt_X||this.X).lookup(f).create(map,opt_X||this.Y)}.bind(this):Model.isInstance(f)?f.create.bind(f):f.factory_?function(map,opt_X){var X=opt_X||this.X,m=X.lookup(f.factory_);return console.assert(m,"Unknown Factory Model: "+f.factory_),m.create(f,opt_X||this.Y)}.bind(this):(console.error("******* Invalid Factory: ",f),f)}}]}),CLASS({name:"ViewFactoryProperty",extendsModel:"FactoryProperty",help:"Describes a View Factory property.",properties:[{name:"defaultValue",preSet:function(_,f){return ViewFactoryProperty.ADAPT.defaultValue.call(this,null,f)}},{name:"fromElement",defaultValue:function(e,p){this[p.name]=e.innerHTML_||(e.innerHTML_=e.innerHTML)}},{name:"adapt",doc:"Can be specified as either a function, String markup, a Model, a Model path, or a JSON object.",defaultValue:function(_,f){if(!f)return f;if("function"==typeof f)return f;var ret;if("string"==typeof f){if(/[^0-9a-zA-Z$_.]/.exec(f)){var VIEW_CACHE=ViewFactoryProperty.VIEW_CACHE||(ViewFactoryProperty.VIEW_CACHE={}),viewModel=VIEW_CACHE[f];viewModel||(viewModel=VIEW_CACHE[f]=Model.create({name:"InnerDetailView"+this.$UID,extendsModel:"foam.ui.DetailView",templates:[{name:"toHTML",template:f}]}),viewModel.arequire());var ret=function(args,X){return viewModel.create(args,X||this.Y)}}else ret=function(map,opt_X){return(opt_X||this.X).lookup(f).create(map,opt_X||this.Y)}.bind(this);return ret.toString=function(){return'"'+f+'"'},ret}return Model.isInstance(f)?f.create.bind(f):f.factory_?(ret=function(map,opt_X){var m=(opt_X||this.X).lookup(f.factory_);return console.assert(m,"Unknown ViewFactory Model: "+f.factory_),m.create(f,opt_X||this.Y).copyFrom(map)}.bind(this),ret.toString=function(){return JSON.stringify(f)},ret):this.X.lookup("foam.ui.BaseView").isInstance(f)?constantFn(f):(console.error("******* Invalid Factory: ",f),f)}}]}),CLASS({name:"ReferenceArrayProperty",extendsModel:"ReferenceProperty",properties:[{name:"type",defaultValue:"Array",displayWidth:20,help:"The FOAM type of this property."},{name:"factory",defaultValue:function(){return[]}},{name:"view",defaultValue:"foam.ui.StringArrayView"}]}),CLASS({name:"EMailProperty",extendsModel:"StringProperty"}),CLASS({name:"URLProperty",extendsModel:"StringProperty"}),CLASS({name:"ColorProperty",extendsModel:"StringProperty"}),CLASS({extendsModel:"Property",name:"DocumentationProperty",help:"Describes the documentation properties found on Models, Properties, Actions, Methods, etc.",documentation:"The developer documentation for this $$DOC{ref:'.'}. Use a $$DOC{ref:'DocModelView'} to view documentation.",properties:[{name:"type",type:"String",defaultvalue:"Documentation"},{name:"getter",type:"Function",defaultValue:function(name){var doc=this.instance_[name];return!doc||"undefined"==typeof Documentation||!Documentation||doc.model_&&doc.model_.getPrototype&&Documentation.isInstance(doc)||(this.instance_[name]=Documentation.create(doc.body?doc:{body:doc})),this.instance_[name]}},{name:"view",defaultValue:"foam.ui.DetailView"},{name:"help",defaultValue:"Documentation for this entity."},{name:"documentation",factory:function(){return"The developer documentation for this $$DOC{ref:'.'}. Use a $$DOC{ref:'DocModelView'} to view documentation."}}]}),CLASS({name:"Action",plural:"Actions",tableProperties:["name","label"],documentation:function(){},properties:[{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the action.",documentation:function(){}},{name:"label",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.name.labelize()},help:"The display label for the action.",documentation:function(){}},{name:"speechLabel",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.label},help:"The speech label for the action.",documentation:"A speakable label for the $$DOC{ref:'.'}. Used for accessibility."},{name:"help",label:"Help Text",type:"String",displayWidth:70,displayHeight:6,defaultValue:"",help:"Help text associated with the action.",documentation:function(){}},{model_:"DocumentationProperty",name:"documentation",documentation:function(){}},{name:"default",type:"Boolean",view:"foam.ui.BooleanView",defaultValue:!1,help:"Indicates if this is the default action.",documentation:function(){}},{model_:"FunctionProperty",name:"isAvailable",label:"Available",displayWidth:70,displayHeight:3,defaultValue:function(){return!0},help:"Function to determine if action is available.",documentation:function(){}},{model_:"FunctionProperty",name:"isEnabled",label:"Enabled",displayWidth:70,displayHeight:3,defaultValue:function(){return!0},help:"Function to determine if action is enabled.",documentation:function(){}},{model_:"FunctionProperty",name:"labelFn",label:"Label Function",defaultValue:function(action){return action.label},help:"Function to determine label. Defaults to 'this.label'.",documentation:function(){}},{name:"iconUrl",type:"String",defaultValue:void 0,help:"Provides a url for an icon to render for this action",documentation:function(){}},{name:"showLabel",type:"String",defaultValue:!0,help:"Property indicating whether the label should be rendered alongside the icon",documentation:function(){}},{name:"children",type:"Array",factory:function(){return[]},subType:"Action",view:"foam.ui.ArrayView",help:"Child actions of this action.",persistent:!1,documentation:function(){}},{name:"parent",type:"String",help:"The parent action of this action",documentation:function(){}},{model_:"FunctionProperty",name:"action",displayWidth:80,displayHeight:20,defaultValue:"",help:"Function to implement action.",documentation:function(){}},{model_:"StringArrayProperty",name:"keyboardShortcuts",documentation:function(){}},{name:"translationHint",label:"Description for Translation",type:"String",defaultValue:""}],methods:{callIfEnabled:function(X,that){this.isEnabled.call(that,this)&&(this.action.call(that,X,this),that.publish(["action",this.name],this))}}}),CLASS({name:"Arg",tableProperties:["type","name","description"],documentation:function(){},properties:[{name:"type",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"Object",help:"The type of this argument.",documentation:function(){}},{name:"javaType",type:"String",required:!1,defaultValueFn:function(){return this.type},help:"The java type that represents the type of this property.",documentation:function(){}},{name:"javascriptType",type:"String",required:!1,defaultValueFn:function(){return this.type},help:"The javascript type that represents the type of this property.",documentation:function(){}},{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the entity.",documentation:function(){}},{model_:"BooleanProperty",name:"required",defaultValue:!0,documentation:function(){}},{name:"defaultValue",help:"Default Value if not required and not provided.",documentation:function(){}},{name:"description",type:"String",displayWidth:70,displayHeight:1,defaultValue:"",help:"A brief description of this argument.",documentation:function(){}},{name:"help",label:"Help Text",type:"String",displayWidth:70,displayHeight:6,defaultValue:"",help:"Help text associated with the entity.",documentation:function(){}},{model_:"DocumentationProperty",name:"documentation",documentation:function(){}}],methods:{decorateFunction:function(f,i){if("Object"===this.type)return f;var type=this.type;return this.required?function(){return console.assert(void 0!==arguments[i],"Missing required argument# "+i),console.assert(typeof arguments[i]===type,"argument# "+i+" type expected to be "+type+", but was "+typeof arguments[i]+": "+arguments[i]),f.apply(this,arguments)}:function(){return console.assert(void 0===arguments[i]||typeof arguments[i]===type,"argument# "+i+" type expected to be "+type+", but was "+typeof arguments[i]+": "+arguments[i]),f.apply(this,arguments)}}},templates:[{model_:"Template",name:"javaSource",description:"Java Source",template:"<%= this.type %> <%= this.name %>"},{model_:"Template",name:"closureSource",description:"Closure JavaScript Source",template:"@param {<%= this.javascriptType %>} <%= this.name %> ."},{model_:"Template",name:"webIdl",description:"Web IDL Source",template:"<%= this.type %> <%= this.name %>"}]}),CLASS({name:"Constant",plural:"constants",tableProperties:["name","value","description"],documentation:function(){},properties:[{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the entity.",documentation:function(){}},{name:"description",type:"String",displayWidth:70,displayHeight:1,defaultValue:"",help:"A brief description of this method.",documentation:function(){}},{model_:"DocumentationProperty",name:"documentation",documentation:function(){}},{name:"value",help:"The value of the constant.."},{name:"type",defaultValue:"",help:"Type of the constant."},{name:"translationHint",label:"Description for Translation",type:"String",defaultValue:""}]}),CLASS({name:"Message",plural:"messages",tableProperties:["name","value","translationHint"],documentation:function(){},properties:[{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the message.",documentation:function(){}},{name:"value",type:"String",help:"The message itself."},{name:"translationHint",type:"String",displayWidth:70,displayHeight:1,defaultValue:"",help:"A brief description of this message and the context in which it used.",documentation:function(){}}]}),CLASS({name:"Method",plural:"Methods",tableProperties:["name","description"],documentation:function(){},properties:[{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the entity.",documentation:function(){}},{name:"description",type:"String",displayWidth:70,displayHeight:1,defaultValue:"",help:"A brief description of this method.",documentation:function(){}},{name:"help",label:"Help Text",type:"String",displayWidth:70,displayHeight:6,defaultValue:"",help:"Help text associated with the entity.",documentation:function(){}},{model_:"DocumentationProperty",name:"documentation",documentation:function(){}},{name:"code",type:"Function",displayWidth:80,displayHeight:30,view:"foam.ui.FunctionView",help:"Javascript code to implement this method.",postSet:function(){if(DEBUG){var multilineComment=/^\s*function\s*\([\$\s\w\,]*?\)\s*{\s*\/\*([\s\S]*?)\*\/[\s\S]*$|^\s*\/\*([\s\S]*?)\*\/([\s\S]*)/.exec(this.code.toString());if(multilineComment){var bodyFn=multilineComment[1];this.documentation=this.Y.Documentation.create({name:this.name,body:bodyFn})}}},documentation:function(){}},{name:"returnType",defaultValue:"",help:"Return type.",documentation:function(){}},{model_:"BooleanProperty",name:"returnTypeRequired",defaultValue:!0,documentation:function(){}},{model_:"ArrayProperty",name:"args",type:"Array[Arg]",subType:"Arg",view:"foam.ui.ArrayView",factory:function(){return[]},defaultValue:[],help:"Method arguments.",documentation:function(){}},{name:"whenIdle",help:"Should this listener be deferred until the system is idle (ie. not running any animations).",documentation:function(){}},{name:"isMerged",help:"As a listener, should this be merged?",documentation:function(){}},{model_:"BooleanProperty",name:"isFramed",help:"As a listener, should this be animated?",defaultValue:!1,documentation:function(){}}],templates:[{model_:"Template",name:"javaSource",description:"Java Source",template:'<%= this.returnType || "void" %> <%= this.name %>(<% for ( var i = 0 ; i < this.args.length ; i++ ) { var arg = this.args[i]; %><%= arg.javaSource() %><% if ( i < this.args.length-1 ) out(", ");%><% } %>)'},{model_:"Template",name:"closureSource",description:"Closure JavaScript Source",template:"/**\n<% for ( var i = 0; i < this.args.length ; i++ ) { var arg = this.args[i]; %> * <%= arg.closureSource() %>\n<% } %><% if (this.returnType) { %> * @return {<%= this.returnType %>} .\n<% } %> */\n<%= arguments[1] %>.prototype.<%= this.name %> = goog.abstractMethod;"},{model_:"Template",name:"webIdl",description:"Web IDL Source",template:"<%= this.returnType || 'void' %> <%= this.name %>(<% for ( var i = 0 ; i < this.args.length ; i++ ) { var arg = this.args[i]; %><%= arg.webIdl() %><% if ( i < this.args.length-1 ) out(\", \"); %><% } %>)"}]}),Method.getPrototype().decorateFunction=function(f){for(var i=0;i<this.args.length;i++){var arg=this.args[i];f=arg.decorateFunction(f,i)}var returnType=this.returnType;return returnType?function(){var ret=f.apply(this,arguments);return console.assert(typeof ret===returnType,"return type expected to be "+returnType+", but was "+typeof ret+": "+ret),ret}:f},Method.getPrototype().generateFunction=function(){var f=this.code;return DEBUG?this.decorateFunction(f):f},Method.methods={decorateFunction:Method.getPrototype().decorateFunction,generateFunction:Method.getPrototype().generateFunction},CLASS({name:"Interface",plural:"Interfaces",tableProperties:["package","name","description"],documentation:function(){},properties:[{name:"id","transient":!0,factory:function(){return this["package"]?this["package"]+"."+this.name:this.name}},{name:"name",required:!0,help:"Interface name.",documentation:function(){}},{name:"package",help:"Interface package.",documentation:Model.PACKAGE.documentation.clone()},{name:"extends",type:"Array[String]",view:"foam.ui.StringArrayView",help:"Interfaces extended by this interface.",documentation:function(){}},{name:"description",type:"String",required:!0,displayWidth:70,displayHeight:1,defaultValue:"",help:"The interface's description.",documentation:function(){}},{name:"help",label:"Help Text",displayWidth:70,displayHeight:6,view:"foam.ui.TextAreaView",help:"Help text associated with the argument.",documentation:function(){}},{model_:"DocumentationProperty",name:"documentation"},{model_:"ArrayProperty",name:"methods",type:"Array[Method]",subType:"Method",view:"foam.ui.ArrayView",factory:function(){return[]},defaultValue:[],help:"Methods associated with the interface.",documentation:function(){}}],templates:[{model_:"Template",name:"javaSource",description:"Java Source",template:'public interface <% out(this.name); %>\n<% if ( this.extends.length ) { %>   extends <%= this.extends.join(", ") %>\n<% } %>{\n<% for ( var i = 0 ; i < this.methods.length ; i++ ) { var meth = this.methods[i]; %>   <%= meth.javaSource() %>;\n<% } %>}'},{model_:"Template",name:"closureSource",description:"Closure JavaScript Source",template:"goog.provide('<%= this.name %>');\n\n/**\n * @interface\n<% for ( var i = 0 ; i < this.extends.length ; i++ ) { var ext = this.extends[i]; %> * @extends {<%= ext %>}\n<% } %> */\n<%= this.name %> = function() {};\n<% for ( var i = 0 ; i <  this.methods.length ; i++ ) { var meth = this.methods[i]; %>\n<%= meth.closureSource(undefined, this.name) %>\n<% } %>"},{model_:"Template",name:"webIdl",description:"Web IDL Source",template:"interface <%= this.name %> <% if (this.extends.length) { %>: <%= this.extends[0] %> <% } %>{\n<% for ( var i = 0 ; i < this.methods.length ; i++ ) { var meth = this.methods[i]; %>  <%= meth.webIdl() %>;\n<% } %>}"}]}),CLASS({name:"Template",tableProperties:["name","description"],documentation:function(){},properties:[{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The template's unique name.",documentation:function(){}},{name:"description",type:"String",required:!0,displayWidth:70,displayHeight:1,defaultValue:"",help:"The template's description.",documentation:"A human readable description of the $$DOC{ref:'.'}."},{model_:"ArrayProperty",name:"args",type:"Array[Arg]",subType:"Arg",view:"foam.ui.ArrayView",factory:function(){return[]},defaultValue:[],help:"Method arguments.",documentation:function(){}},{name:"template",type:"String",displayWidth:180,displayHeight:30,rows:30,cols:80,defaultValue:"",view:"foam.ui.TextAreaView",help:"Template text. <%= expr %> or <% out(...); %>",documentation:"The string content of the uncompiled $$DOC{ref:'Template'} body."},{name:"futureTemplate","transient":!0},{name:"code","transient":!0},{model_:"DocumentationProperty",name:"documentation"}]}),CLASS({name:"Documentation",tableProperties:["name"],documentation:function(){},properties:[{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"documentation",help:"The Document's unique name.",documentation:"An optional name for the document. Documentation is normally referenced by the name of the containing Model."},{name:"label",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The Document's title or descriptive label.",documentation:"A human readable title to display. Used for books of documentation and chapters."},{name:"body",type:"Template",defaultValue:"",help:"The main content of the document.",documentation:"The main body text of the document. Any valid template can be used, including the $$DOC{ref:'foam.documentation.DocView'} specific $$DOC{ref:'foam.documentation.DocView',text:'$$DOC{\"ref\"}'} tag.",preSet:function(_,template){return TemplateUtil.expandTemplate(this,template)}},{model_:"ArrayProperty",name:"chapters",type:"Array[Document]",subtype:"Documentation",view:"foam.ui.ArrayView",factory:function(){return[]},defaultValue:[],help:"Sub-documents comprising the full body of this document.",documentation:"Optional sub-documents to be included in this document. A viewer may choose to provide an index or a table of contents.",preSet:function(old,nu){if(!DEBUG)return[];var self=this,foamalized=[];return nu.forEach(function(chapter){foamalized.push(!chapter||"undefined"==typeof self.Y.Documentation||!self.Y.Documentation||chapter.model_&&chapter.model_.getPrototype&&self.Y.Documentation.isInstance(chapter)?chapter:chapter.body?self.Y.Documentation.create(chapter):self.Y.Documentation.create({body:chapter}))}),foamalized}}]}),TemplateUtil.expandModelTemplates(Property),TemplateUtil.expandModelTemplates(Method),TemplateUtil.expandModelTemplates(Model),TemplateUtil.expandModelTemplates(Arg),CLASS({name:"UnitTest",plural:"Unit Tests",documentation:function(){},tableProperties:["description","passed","failed"],properties:[{model_:"Property",name:"name",type:"String",required:!0,displayWidth:50,documentation:"The unit test's name."},{model_:"Property",name:"description",type:"String",displayWidth:70,displayHeight:5,defaultValue:"",documentation:"A multi-line description of the unit test."},{model_:"BooleanProperty",name:"disabled",documentation:"When true, this test is ignored. Test runners should exclude disabled tests from their DAOs.",defaultValue:!1},{model_:"IntProperty",name:"passed",required:!0,"transient":!0,displayWidth:8,displayHeight:1,view:"foam.ui.IntFieldView",documentation:"Number of assertions which have passed."},{model_:"IntProperty",name:"failed",required:!0,"transient":!0,displayWidth:8,displayHeight:1,documentation:"Number of assertions which have failed."},{model_:"BooleanProperty",name:"async",defaultValue:!1,documentation:'Set to make this test asynchronoous. Async tests receive a <tt>ret</tt> parameter as their first argument, and $$DOC{ref: ".atest"} will not return until <tt>ret</tt> is called by the test code.'},{model_:"FunctionProperty",name:"code",label:"Test Code",displayWidth:80,displayHeight:30,documentation:'The code for the test. Should not include the <tt>function() { ... }</tt>, just the body. Should expect a <tt>ret</tt> parameter when the test is async, see $$DOC{ref: ".async", text: "above"}.',fromElement:function(e,p){var txt=e.innerHTML;txt=txt.trim().startsWith("function")?txt:this.async?"function(ret) {\n"+txt+"\n}":"function() {\n"+txt+"\n}",this[p.name]=eval("("+txt+")")},adapt:function(_,value){if("string"==typeof value&&(value=value.startsWith("function")?eval("("+value+")"):new Function(value)),"function"==typeof value&&this.async&&0===value.length){var str=value.toString();return eval("(function(ret)"+str.substring(str.indexOf("{"))+")")}return value}},{model_:"BooleanProperty",name:"hasRun","transient":!0,hidden:!0,defaultValue:!1,documentation:"Set after the test has finished executing. Prevents the test from running twice."},{model_:"Property",name:"results",type:"String",mode:"read-only",view:"foam.ui.UnitTestResultView","transient":!0,required:!0,displayWidth:80,displayHeight:20,documentation:'Log output for this test. Written to by $$DOC{ref: ".log"}, as well as $$DOC{ref: ".assert"} and its friends $$DOC{ref: ".fail"} and $$DOC{ref: ".ok"}.'},{model_:"StringArrayProperty",name:"tags",label:"Tags",documentation:"A list of tags for this test. Gives the environment(s) in which a test can be run. Currently in use: node, web."},{model_:"ArrayProperty",name:"tests",subType:"UnitTest",label:"Tests",view:"foam.ui.DAOListView",documentation:"An array of child tests. Will be run in order after the parent test."},{model_:"BooleanProperty",name:"runChildTests",documentation:"Whether the nested child tests should be run when this test is. Defaults to <tt>true</tt>, but some test runners set it to <tt>false</tt> so they can integrate with displaying the results.","transient":!0,defaultValue:!0}],actions:[{name:"test",documentation:'Synchronous helper to run the tests. Simply calls $$DOC{ref: ".atest"}.',action:function(obj){asynchronized(this.atest(),this.LOCK)(function(){})}}],constants:{LOCK:{}},methods:{atest:function(){var self=this;if(this.hasRun)return anop;this.hasRun=!0,this.Y=this.Y.sub({},this.name),this.Y.log=this.log.bind(this),this.Y.jlog=this.jlog.bind(this),this.Y.assert=this.assert.bind(this),this.Y.fail=this.fail.bind(this),this.Y.ok=this.ok.bind(this),this.Y.append=this.append.bind(this),this.Y.test=this,this.results="",this.passed=0,this.failed=0;var code;code=eval("("+this.code.toString()+")");var afuncs=[],oldLog;if(afuncs.push(function(ret){oldLog=console.log,console.log=self.log.bind(self.Y),ret()}),afuncs.push(this.async?code.bind(this.Y):code.abind(this.Y)),afuncs.push(function(ret){console.log=oldLog,ret()}),this.runChildTests){var query=this.X.childTestsFilter||TRUE,future=this.tests.dao.where(query).select([].sink);afuncs.push(function(ret){future(function(innerTests){var afuncsInner=[];innerTests.forEach(function(test){afuncsInner.push(function(ret){test.X=self.Y.sub(),test.atest()(ret)})}),afuncsInner.length?aseq.apply(this,afuncsInner)(ret):ret()})})}return afuncs.push(function(ret){self.hasRun=!0,self.X.onTestFailure&&self.hasFailed()&&self.X.onTestFailure(self),ret()}),aseq.apply(this,afuncs)},append:function(s){this.results+=s},log:function(){for(var i=0;i<arguments.length;i++)this.append(arguments[i]);this.append("\n")},jlog:function(){for(var i=0;i<arguments.length;i++)this.append(JSONUtil.stringify(arguments[i]));this.append("\n")},addHeader:function(name){this.log('<tr><th colspan=2 class="resultHeader">'+name+"</th></tr>")},assert:function(condition,comment){condition?this.passed++:this.failed++,this.log((comment?comment:"(no message)")+" "+(condition?"<font color=green>OK</font>":"<font color=red>ERROR</font>"))},fail:function(comment){this.assert(!1,comment)},ok:function(comment){this.assert(!0,comment)},hasFailed:function(){return this.failed>0}}}),CLASS({name:"RegressionTest",label:"Regression Test",documentation:'A $$DOC{ref: "UnitTest"} with a "gold master", which is compared with the output of the live test.',extendsModel:"UnitTest",properties:[{name:"master",documentation:'The "gold" version of the output. Compared with the $$DOC{ref: ".results"} using <tt>.equals()</tt>, and the test passes if they match.'},{name:"results",view:"foam.ui.RegressionTestResultView"},{model_:"BooleanProperty",name:"regression",hidden:!0,"transient":!0,defaultValue:!1,documentation:'Set after $$DOC{ref: ".atest"}: <tt>true</tt> if $$DOC{ref: ".master"} and $$DOC{ref: ".results"} match, <tt>false</tt> if they don\'t.'}],methods:{atest:function(){var sup=this.SUPER();return aseq(sup,function(ret){this.regression=this.hasRun&&!this.results.equals(this.master),ret()}.bind(this))},hasFailed:function(){return this.regression||this.hasRun&&!this.results.equals(this.master)}}}),CLASS({name:"UITest",label:"UI Test",extendsModel:"UnitTest",properties:[{name:"results",view:"foam.ui.UITestResultView"},{name:"runChildTests",help:"Don't run child tests by default for UITests; they need a view to be run properly.",defaultValue:!1}]}),CLASS({name:"Relationship",tableProperties:["name","label","relatedModel","relatedProperty"],documentation:function(){},properties:[{name:"name",type:"String",displayWidth:30,displayHeight:1,defaultValueFn:function(){return GLOBAL[this.relatedModel]?GLOBAL[this.relatedModel].plural:""},documentation:function(){},help:"The coding identifier for the relationship."},{name:"label",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.name.labelize()},documentation:function(){},help:"The display label for the relationship."},{name:"help",label:"Help Text",type:"String",displayWidth:70,displayHeight:6,defaultValue:"",documentation:function(){},help:"Help text associated with the relationship."},{model_:"DocumentationProperty",name:"documentation",documentation:function(){}},{name:"relatedModel",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",documentation:function(){},help:"The name of the related Model."},{name:"relatedProperty",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",documentation:function(){},help:"The join property of the related Model."}]}),CLASS({name:"Issue",plural:"Issues",help:"An issue describes a question, feature request, or defect.",ids:["id"],tableProperties:["id","severity","status","summary","assignedTo"],documentation:function(){},properties:[{model_:"IntProperty",name:"id",label:"Issue ID",displayWidth:12,documentation:function(){},help:"Issue's unique sequence number."},{name:"severity",view:{factory_:"foam.ui.ChoiceView",choices:["Feature","Minor","Major","Question"]},defaultValue:"String",documentation:function(){},help:"The severity of the issue."},{name:"status",type:"String",required:!0,view:{factory_:"foam.ui.ChoiceView",choices:["Open","Accepted","Complete","Closed"]},defaultValue:"String",documentation:function(){},help:"The status of the issue."},{model_:"Property",name:"summary",type:"String",required:!0,displayWidth:70,displayHeight:1,documentation:function(){},help:"A one line summary of the issue."},{model_:"Property",name:"created",type:"DateTime",required:!0,displayWidth:50,displayHeight:1,factory:function(){return new Date},documentation:function(){},help:"When this issue was created."},{model_:"Property",name:"createdBy",type:"String",defaultValue:"kgr",required:!0,displayWidth:30,displayHeight:1,documentation:function(){},help:"Who created the issue."},{model_:"Property",name:"assignedTo",type:"String",defaultValue:"kgr",displayWidth:30,displayHeight:1,documentation:function(){},help:"Who the issue is currently assigned to."},{model_:"Property",name:"notes",displayWidth:75,displayHeight:20,view:"foam.ui.TextAreaView",documentation:function(){},help:"Notes describing issue."}],tests:[{model_:"UnitTest",description:"test1",code:function(){this.addHeader("header"),this.ok("pass"),this.fail("fail")}}]}),function(){for(var i=0;i<Model.templates.length;i++)Model.templates[i]=JSONUtil.mapToObj(X,Model.templates[i]);Model.properties=Model.properties,delete Model.instance_.prototype_,Model=Model.create(Model)}();for(var id in USED_MODELS)recopyModelFeatures(GLOBAL.lookup(id));for(var id in UNUSED_MODELS)recopyModelFeatures(GLOBAL.lookup(id));USED_MODELS.Model=!0,CLASS({"package":"foam.ui",name:"Window",exports:["$$","$","addStyle","animate","cancelAnimationFrame","clearInterval","clearTimeout","console","document","dynamic","error","info","log","lookup","memento","onRegisterModel","requestAnimationFrame","setInterval","setTimeout","warn","window"],properties:[{name:"registeredModels",factory:function(){return{}}},{model_:"StringProperty",name:"name",defaultValue:"window"},{name:"window",postSet:function(_,w){this.X.subDocument&&this.X.subDocument(w.document),w.X=this.Y,this.document=w.document}},{name:"document"},{name:"installedModels",lazyFactory:function(){return this.document.installedModels||(this.document.installedModels={})}},{model_:"BooleanProperty",name:"isBackground",defaultValue:!1},{name:"console",lazyFactory:function(){return this.window.console}},{name:"memento",lazyFactory:function(){this.window.WindowHashValue.create({window:this.window})}}],methods:{lookup:function(key){var ret=GLOBAL.lookup.call(this.Y,key);return ret&&!this.registeredModels[key]&&(this.registeredModels[key]=!0,this.onRegisterModel(ret)),ret},onRegisterModel:function(model){for(var Y=this.Y,document=this.document,m=model;m&&m.getPrototype;m=m.extendsModel&&this[m.extendsModel]){if(this.installedModels[m.id])return;this.installedModels[m.id]=!0,m.arequire()(function(m){m.getPrototype().installInDocument(Y,document)})}},addStyle:function(css){if(this.document&&this.document.createElement){var s=this.document.createElement("style");s.innerHTML=css,this.document.head.appendChild(s)}},log:function(){this.console.log.apply(this.console,arguments)},warn:function(){this.console.warn.apply(this.console,arguments)},info:function(){this.console.info.apply(this.console,arguments)},error:function(){this.console.error.apply(this.console,arguments)},$:function(id){return this.document.FOAM_OBJECTS&&this.document.FOAM_OBJECTS[id]?this.document.FOAM_OBJECTS[id]:this.document.getElementById(id)},$$:function(cls){return this.document.getElementsByClassName(cls)},dynamic:function(fn,opt_fn){Events.dynamic(fn,opt_fn,this.Y)},animate:function(duration,fn,opt_interp,opt_onEnd){return Movement.animate(duration,fn,opt_interp,opt_onEnd,this.Y)},setTimeout:function(f,t){return this.window.setTimeout.apply(this.window,arguments)
},clearTimeout:function(id){this.window.clearTimeout(id)},setInterval:function(f,t){return this.window.setInterval.apply(this.window,arguments)},clearInterval:function(id){this.window.clearInterval(id)},requestAnimationFrame:function(f){return this.isBackground?this.setTimeout(f,16):(console.assert(this.window.requestAnimationFrame,"requestAnimationFrame not defined"),this.window.requestAnimationFrame(f))},cancelAnimationFrame:function(id){return this.isBackground?void this.clearTimeout(id):void(this.window.cancelAnimationFrame&&this.window.cancelAnimationFrame(id))}}}),function(){var w=foam.ui.Window.create({window:window,name:"DEFAULT WINDOW",isBackground:"object"==typeof process},X);FObject.X=X=w.Y}(),CLASS({name:"SimpleValue",properties:[{name:"value"}],methods:{init:function(value){this.value=value||""},get:function(){return this.value},set:function(val){this.value=val},toString:function(){return"SimpleValue("+this.value+")"}}}),CLASS({name:"SimpleReadOnlyValue",extendsModel:"SimpleValue",documentation:"A simple value that can only be set during initialization.",properties:[{name:"value",preSet:function(old,nu){return"undefined"==typeof this.instance_.value?nu:old}}],methods:{set:function(val){"undefined"==typeof this.instance_.value&&this.SUPER(val)},toString:function(){return"SimpleReadOnlyValue("+this.value+")"}}});var DOM={init:function(X){X.document.FOAM_OBJECTS||(X.document.FOAM_OBJECTS={});for(var fs=X.document.querySelectorAll("foam"),models=[],i=0;i<fs.length;i++){var e=fs[i];X.lookup(e.getAttribute("view")),X.lookup(e.getAttribute("model")),e.getAttribute("view")&&models.push(arequire(e.getAttribute("view"))),e.getAttribute("model")&&models.push(arequire(e.getAttribute("model")))}for(var key in USED_MODELS)models.push(arequire(key));atime("DOMInit",aseq(apar.apply(null,models),function(ret){for(var i=0;i<fs.length;i++){for(var e=fs[i],node=e,body=X.document.body;node&&node!==body;)node=node.parentNode;node&&(this.initElement(e,X,X.document),e.innerHTML=""),ret()}}.bind(this)))()},initElementChildren:function(e,X){for(var a=[],i=0;i<e.children.length;i++){var c=e.children[i];"FOAM"===c.tagName&&a.push(DOM.initElement(c,X))}return a},initElement:function(e,X,opt_document){arequire("foam.ui.FoamTagView")(function(t){foam.ui.FoamTagView.create({element:e},X)})},setClass:function(e,className,opt_enabled){var oldClassName=e.className||"",enabled=void 0===opt_enabled?!0:opt_enabled;e.className=oldClassName.replace(" "+className,"").replace(className,""),enabled&&(e.className=e.className+" "+className)}};window&&window.addEventListener&&window.addEventListener("load",function(){DOM.init(X)},!1);var DomValue={DEFAULT_EVENT:"change",DEFAULT_PROPERTY:"value",create:function(element,opt_event,opt_property){if(!element)throw"Missing Element in DomValue";return{__proto__:this,element:element,event:opt_event||this.DEFAULT_EVENT,property:opt_property||this.DEFAULT_PROPERTY}},setElement:function(element){this.element=element},get:function(){return this.element[this.property]},set:function(value){this.element[this.property]!==value&&(this.element[this.property]=value)},addListener:function(listener){if(this.event)try{this.element.addEventListener(this.event,listener,!1)}catch(x){}},removeListener:function(listener){if(this.event)try{this.element.removeEventListener(this.event,listener,!1)}catch(x){}},toString:function(){return"DomValue("+this.event+", "+this.property+")"}};CLASS({name:"DOMValue",properties:[{name:"element",required:!0},{name:"property",defaultValue:"value"},{name:"event",defaultValue:"change"},{name:"value",postSet:function(_,value){this.element[this.property]=value}},{name:"firstListener_",defaultValue:!0}],methods:{init:function(){this.SUPER(),this.value=this.element[this.property]},get:function(){return this.value},set:function(value){this.value=value},addListener:function(listener){this.firstListener_&&(this.event&&this.element.addEventListener(this.event,function(){},!1),this.firstListener_=!1),this.value$.addListener(listener)},removeListener:function(listener){this.value$.removeListener(listener)},toString:function(){return"DOMValue("+this.event+", "+this.property+")"}}}),CLASS({"package":"foam.ui",name:"FoamTagView",extendsModel:"foam.ui.View",requires:["foam.html.Element","foam.ui.View","foam.ui.DetailView"],imports:["document"],properties:[{name:"element"},{name:"className",defaultValue:"foam-tag"}],methods:{init:function(){this.SUPER(),this.Element.isInstance(this.element)||this.install()},install:function(){var e=this.element,models=[],style=e.getAttribute("style"),modelName=e.getAttribute("model"),viewName=e.getAttribute("view"),onInit=e.getAttribute("oninit");modelName&&models.push(arequire(modelName,this.X)),viewName&&models.push(arequire(viewName,this.X)),aseq(apar.apply(null,models),function(ret){var model=this.X.lookup(modelName);if(!model)return void this.error("Unknown Model: ",modelName);model.getPrototype();var obj=model.create(null,this.X);obj.fromElement(e),obj.model_.DATA&&this.hasOwnProperty("data")&&(obj.data=this.data);var view;if(viewName){var viewModel=this.X.lookup(viewName);view=viewModel.create({model:model,data:obj},this.X)}else if(this.X.lookup("foam.ui.BaseView").isInstance(obj))view=obj;else if(obj.toView_)view=obj.toView_();else{var a=this.element.getAttribute("showActions"),showActions=!a||a.equalsIC("y")||a.equalsIC("yes")||a.equalsIC("true")||a.equalsIC("t");view=this.X.lookup("foam.ui.DetailView").create({model:model,data:obj,showActions:showActions},this.X)}e.id&&(this.document.FOAM_OBJECTS[e.id]=obj),obj.view_=view,this.holder().outerHTML=view.toHTML(),style&&view.$.setAttribute("style",style),view.initHTML(),onInit&&aeval("function() { "+onInit+" }")(function(f){f.call(obj)})}.bind(this))()},holder:function(){return this.Element.isInstance(this.element)?this.$:this.element},error:function(msg){console.error(msg),this.holder.innerHTML=msg},initHTML:function(){this.install()}},templates:[function CSS(){}]}),CLASS({"package":"foam.html",name:"Element",constants:{OPTIONAL_CLOSE_TAGS:{HTML:!0,HEAD:!0,BODY:!0,P:!0,DT:!0,DD:!0,LI:!0,OPTION:!0,THEAD:!0,TH:!0,TBODY:!0,TR:!0,TD:!0,TFOOT:!0,COLGROUP:!0},ILLEGAL_CLOSE_TAGS:{IMG:!0,INPUT:!0,BR:!0,HR:!0,FRAME:!0,AREA:!0,BASE:!0,BASEFONT:!0,COL:!0,ISINDEX:!0,LINK:!0,META:!0,PARAM:!0}},properties:[{name:"id"},{name:"nodeName"},{name:"attributeMap_","transient":!0,factory:function(){return{}}},{name:"attributes",factory:function(){return[]},postSet:function(_,attrs){for(var i=0;i<attrs.length;i++)this.attributeMap_[attrs[i].name]=attrs[i]}},{name:"childNodes",factory:function(){return[]}},{name:"children","transient":!0,getter:function(){return this.childNodes.filter(function(c){return"string"!=typeof c})}},{name:"outerHTML","transient":!0,getter:function(){var out="<"+this.nodeName;this.id&&(out+=' id="'+this.id+'"');for(key in this.attributeMap_){var value=this.attributeMap_[key].value;out+=void 0==value?" "+key:" "+key+'="'+this.attributeMap_[key].value+'"'}return this.ILLEGAL_CLOSE_TAGS[this.nodeName]||this.OPTIONAL_CLOSE_TAGS[this.nodeName]&&!this.childNodes.length||(out+=">",out+=this.innerHTML,out+="</"+this.nodeName),out+=">"}},{name:"innerHTML","transient":!0,getter:function(){for(var out="",i=0;i<this.childNodes.length;i++)out+=this.childNodes[i].toString();return out}}],methods:{setAttribute:function(name,value){var attr=this.getAttributeNode(name);attr?attr.value=value:(attr={name:name,value:value},this.attributes.push(attr),this.attributeMap_[name]=attr)},getAttributeNode:function(name){return this.attributeMap_[name]},getAttribute:function(name){var attr=this.getAttributeNode(name);return attr&&attr.value},appendChild:function(c){this.childNodes.push(c)},removeChild:function(c){for(var i=0;i<this.childNodes.length;++i)if(this.childNodes[i]===c){this.childNodes.splice(i,1);break}},toString:function(){return this.outerHTML}}});var HTMLParser={__proto__:grammar,create:function(){return{__proto__:this,stack:[X.foam.html.Element.create({nodeName:"html"})]}},peek:function(){return this.stack[this.stack.length-1]},START:sym("html"),html:repeat0(sym("htmlPart")),htmlPart:simpleAlt(sym("comment"),sym("text"),sym("endTag"),sym("startTag")),tag:seq(sym("startTag"),repeat(seq1(1,sym("matchingHTML"),sym("htmlPart")))),matchingHTML:function(ps){return this.stack.length>1?ps:null},startTag:seq("<",sym("tagName"),sym("whitespace"),sym("attributes"),sym("whitespace"),optional("/"),">"),endTag:function(){var endTag_=sym("endTag_");return function(ps){return this.stack.length>1?this.parse(endTag_,ps):void 0}}(),endTag_:seq1(1,"</",sym("tagName"),">"),comment:seq("<!--",repeat0(not("-->",anyChar)),"-->"),attributes:repeat(sym("attribute"),sym("whitespace")),label:str(plus(notChars(" =/	\r\n<>'\""))),tagName:sym("label"),text:str(plus(alt("<%",notChar("<")))),attribute:seq(sym("label"),optional(seq1(1,"=",sym("value")))),value:str(alt(plus(alt(range("a","z"),range("A","Z"),range("0","9"))),seq1(1,'"',repeat(notChar('"')),'"'))),whitespace:repeat0(alt(" ","	","\r","\n"))}.addActions({START:function(xs){var ret=this.stack[0];return this.stack=[X.foam.html.Element.create({nodeName:"html"})],ret},tag:function(xs){var ret=this.stack[0];return this.stack=[X.foam.html.Element.create({nodeName:"html"})],ret.childNodes[0]},attribute:function(xs){return{name:xs[0],value:xs[1]}},text:function(xs){this.peek()&&this.peek().appendChild(xs)},startTag:function(xs){var tag=xs[1],obj=X.foam.html.Element.create({nodeName:tag,attributes:xs[3]});return this.peek()&&this.peek().appendChild(obj),"/"!=xs[5]&&this.stack.push(obj),obj},endTag:function(tag){for(var stack=this.stack;stack.length>1;){if(this.peek().nodeName===tag)return void stack.pop();var top=stack.pop();this.peek().childNodes=this.peek().childNodes.concat(top.childNodes),top.childNodes=[]}}});!function(){var registry={};X.registerElement=function(name,model){registry[name]=model,TemplateParser.foamTag_=function(){var start=seq("<",simpleAlt.apply(null,Object.keys(registry).sort(function(o1,o2){return o2.compareTo(o1)}).map(function(k){return literal_ic(k)})),alt("/"," ",">")),html=HTMLParser.create()["export"]("tag");return function(ps){var res=this.parse(start,ps)&&this.parse(html,ps);if(!res)return null;var elem=res.value,model=registry[elem.nodeName];return model&&elem.setAttribute("model",model),res.setValue(elem)}}(),invalidateParsers()},X.elementModel=function(name){return registry[name]}}(),X.registerElement("foam",null),CLASS({name:"Expr",documentation:"Parent model for all mLang expressions. Contains default implementations for many methods.",methods:{toMQL:function(){return this.label_},toSQL:function(){return this.label_},toBQL:function(){return this.label_},toString:function(){return this.toMQL()},collectInputs:function(terms){terms.push(this)},partialEval:function(){return this},minterm:function(index,term){return!!(term>>>index[0]--&1)},normalize:function(){return this;var inputs,minterms,i,terms,subterms,j,ret},pipe:function(sink){var expr=this;return{__proto__:sink,put:function(obj){expr.f(obj)&&sink.put(obj)},remove:function(obj){expr.f(obj)&&sink.remove(obj)}}}}});var TRUE=FOAM({model_:"Model",name:"TrueExpr",extendsModel:"Expr",documentation:"Model for the primitive true value.",methods:{toString:function(){return"<true>"},toSQL:function(){return"( 1 = 1 )"},toMQL:function(){return""},toBQL:function(){return""},f:function(){return!0}}}).create(),FALSE=FOAM({model_:"Model",name:"FalseExpr",extendsModel:"Expr",documentation:"Model for the primitive false value.",methods:{toSQL:function(out){return"( 1 <> 1 )"},toMQL:function(out){return"<false>"},toBQL:function(out){return"<false>"},f:function(){return!1}}}).create(),IDENTITY=FOAM({model_:"Model",name:"IDENTITY",extendsModel:"Expr",documentation:"The identity expression, which passes through its input unchanged.",methods:{f:function(obj){return obj},toString:function(){return"IDENTITY"}}}).create();CLASS({name:"NARY",extendsModel:"Expr","abstract":!0,documentation:"Parent model for expressions which take an arbitrary number of arguments.",properties:[{name:"args",label:"Arguments",type:"Expr[]",help:"Sub-expressions",documentation:"An array of subexpressions which are the arguments to this n-ary expression.",factory:function(){return[]}}],methods:{toString:function(){for(var s=this.name_+"(",i=0;i<this.args.length;i++){var a=this.args[i];s+=a.toString(),i<this.args.length-1&&(s+=", ")}return s+")"},toSQL:function(){var s;s=this.model_.label,s+="(";for(var i=0;i<this.args.length;i++){var a=this.args[i];s+=a.toSQL(),i<this.args.length-1&&out.push(",")}return s+=")"},toMQL:function(){var s;s=this.model_.label,s+="(";for(var i=0;i<this.args.length;i++){var a=this.args[i];s+=a.toMQL(),i<this.args.length-1&&out.push(",")}return s+=")",str},toBQL:function(){var s;s=this.model_.label,s+="(";for(var i=0;i<this.args.length;i++){var a=this.args[i];s+=a.toBQL(),i<this.args.length-1&&out.push(",")}return s+=")",str}}}),CLASS({name:"UNARY",extendsModel:"Expr","abstract":!0,documentation:"Parent model for one-argument expressions.",properties:[{name:"arg1",label:"Argument",type:"Expr",help:"Sub-expression",documentation:"The first argument to the expression.",defaultValue:TRUE}],methods:{toSQL:function(){return this.label_+"("+this.arg1.toSQL()+")"},toMQL:function(){return this.label_+"("+this.arg1.toMQL()+")"},toBQL:function(){return this.label_+"("+this.arg1.toBQL()+")"}}}),CLASS({name:"BINARY",extendsModel:"UNARY","abstract":!0,documentation:'Parent model for two-argument expressions. Extends $$DOC{ref: "UNARY"} to include $$DOC{ref: ".arg2"}.',properties:[{name:"arg2",label:"Argument",type:"Expr",help:"Sub-expression",documentation:"Second argument to the expression.",defaultValue:TRUE}],methods:{toSQL:function(){return this.arg1.toSQL()+" "+this.label_+" "+this.arg2.toSQL()},toMQL:function(){return this.arg1.toMQL()+" "+this.label_+" "+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+" "+this.label_+" "+this.arg2.toBQL()}}}),CLASS({name:"MaxExpr",extendsModel:"UNARY",properties:[{name:"max",type:"int",help:"Maximum value.",defaultValue:void 0}],methods:{maximum:function(o1,o2){return o1.compareTo(o2)>0?o1:o2},reduce:function(other){return MaxExpr.create({max:this.maximum(this.max,other.max)})},reduceI:function(other){this.max=this.maximum(this.max,other.max)},pipe:function(sink){sink.put(this)},put:function(obj){var v=this.arg1.f(obj);this.max=void 0===this.max?v:this.maximum(this.max,v)},remove:function(obj){},toString:function(){return this.max}}}),CLASS({name:"ExplainExpr",extendsModel:"UNARY",documentation:"Pseudo-expression which outputs a human-readable description of its subexpression, and the plan for evaluating it.",properties:[{name:"plan",help:"Execution Plan",defaultValue:""}],methods:{toString:function(){return this.plan},toSQL:function(){return this.arg1.toSQL()},toMQL:function(){return this.arg1.toMQL()},toBQL:function(){return this.arg1.toBQL()},partialEval:function(){var newArg=this.arg1.partialEval();return this.arg1===newArg?this:EXPLAIN(newArg)},f:function(obj){return this.arg1.f(obj)}}}),CLASS({name:"CountExpr",extendsModel:"Expr",properties:[{name:"count",type:"int",defaultValue:0}],methods:{reduce:function(other){return CountExpr.create({count:this.count+other.count})},reduceI:function(other){this.count=this.count+other.count},pipe:function(sink){sink.put(this)},put:function(obj){this.count++},remove:function(obj){this.count--},toString:function(){return this.count}}}),CLASS({name:"InExpr",extendsModel:"BINARY",documentation:"Binary expression which is true if its first argument is EQ to any element of its second argument, which is an array.",properties:[{name:"arg2",label:"Argument",type:"Expr",help:"Sub-expression",postSet:function(){this.valueSet_=void 0}}],methods:{partialEval:function(){return 1==this.arg2.length?EQ(this.arg1,this.arg2[0]):this},valueSet:function(){if(!this.valueSet_){for(var s={},i=0;i<this.arg2.length;i++)s[this.arg2[i]]=!0;this.valueSet_=s}return this.valueSet_},toSQL:function(){return this.arg1.toSQL()+" IN "+this.arg2},toMQL:function(){return this.arg1.toMQL()+"="+this.arg2.join(",")},toBQL:function(){return this.arg1.toBQL()+":("+this.arg2.join("|")+")"},f:function(obj){return this.valueSet().hasOwnProperty(this.arg1.f(obj))}}}),CLASS({name:"EqExpr",extendsModel:"BINARY","abstract":!0,documentation:function(){},methods:{toSQL:function(){return this.arg1.toSQL()+"="+this.arg2.toSQL()},toMQL:function(){return this.arg1.toMQL&&this.arg2.toMQL?this.arg2===TRUE?"is:"+this.arg1.toMQL():""==this.arg2.f()?"-has:"+this.arg1.toMQL():this.arg1.toMQL()+"="+this.arg2.toMQL():""},toBQL:function(){return this.arg1.toBQL&&this.arg2.toBQL?this.arg2===TRUE?this.arg1.toBQL()+":true":this.arg1.toBQL()+":"+this.arg2.toBQL():""},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval();return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(newArg1.f()==newArg2.f()):this.arg1!==newArg1||this.arg2!==newArg2?EqExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){var arg1=this.arg1.f(obj),arg2=this.arg2.f(obj);return Array.isArray(arg1)?arg1.some(function(arg){return arg==arg2}):arg2===TRUE?!!arg1:arg2===FALSE?!arg1:arg1==arg2}}}),CLASS({name:"LtExpr",extendsModel:"BINARY","abstract":!0,methods:{toSQL:function(){return this.arg1.toSQL()+"<"+this.arg2.toSQL()},toMQL:function(){return this.arg1.toMQL()+"-before:"+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+"<"+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval();return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(newArg1.f()<newArg2.f()):this.arg1!==newArg1||this.arg2!=newArg2?LtExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){return this.arg1.f(obj)<this.arg2.f(obj)}}}),CLASS({name:"GtExpr",extendsModel:"BINARY","abstract":!0,methods:{toSQL:function(){return this.arg1.toSQL()+">"+this.arg2.toSQL()},toMQL:function(){return this.arg1.toMQL()+"-after:"+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+">"+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval();return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(newArg1.f()>newArg2.f()):this.arg1!==newArg1||this.arg2!=newArg2?GtExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){return this.arg1.f(obj)>this.arg2.f(obj)}}}),CLASS({name:"LteExpr",extendsModel:"BINARY","abstract":!0,methods:{toSQL:function(){return this.arg1.toSQL()+"<="+this.arg2.toSQL()},toMQL:function(){return this.arg1.toMQL()+"-before:"+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+"<="+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval();return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(newArg1.f()<=newArg2.f()):this.arg1!==newArg1||this.arg2!=newArg2?LtExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){return this.arg1.f(obj)<=this.arg2.f(obj)}}}),CLASS({name:"GteExpr",extendsModel:"BINARY","abstract":!0,methods:{toSQL:function(){return this.arg1.toSQL()+">="+this.arg2.toSQL()},toMQL:function(){return this.arg1.toMQL()+"-after:"+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+">="+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval();return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(newArg1.f()>=newArg2.f()):this.arg1!==newArg1||this.arg2!=newArg2?GtExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){return this.arg1.f(obj)>=this.arg2.f(obj)}}}),CLASS({name:"ConstantExpr",extendsModel:"UNARY",methods:{escapeSQLString:function(str){return"'"+str.replace(/\\/g,"\\\\").replace(/'/g,"\\'")+"'"},escapeMQLString:function(str){return str.length>0&&-1==str.indexOf(" ")&&-1==str.indexOf('"')&&-1==str.indexOf(",")?str:'"'+str.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'},toSQL:function(){return"string"==typeof this.arg1?this.escapeSQLString(this.arg1):this.arg1.toString()},toMQL:function(){return"string"==typeof this.arg1?this.escapeMQLString(this.arg1):this.arg1.toMQL?this.arg1.toMQL():this.arg1.toString()},toBQL:function(){return"string"==typeof this.arg1?this.escapeMQLString(this.arg1):this.arg1.toBQL?this.arg1.toBQL():this.arg1.toString()},f:function(obj){return this.arg1}}}),CLASS({name:"AndExpr",extendsModel:"NARY","abstract":!0,documentation:"N-ary expression which is true only if each of its 0 or more arguments is true. AND() === TRUE",methods:{toSQL:function(){for(var s="",i=0;i<this.args.length;i++){var a=this.args[i];s+=a.toSQL(),i<this.args.length-1&&(s+=" AND ")}return s},toMQL:function(){for(var s="",i=0;i<this.args.length;i++){var a=this.args[i],sub=a.toMQL();OrExpr.isInstance(a)&&(sub="("+sub+")"),s+=sub,i<this.args.length-1&&(s+=" ")}return s},toBQL:function(){for(var s="",i=0;i<this.args.length;i++){var a=this.args[i],sub=a.toBQL();OrExpr.isInstance(a)&&(sub="("+sub+")"),s+=sub,i<this.args.length-1&&(s+=" ")}return s},collectInputs:function(terms){for(var i=0;i<this.args.length;i++)this.args[i].collectInputs(terms)},minterm:function(index,term){for(var out=!0,i=0;i<this.args.length;i++)out=this.args[i].minterm(index,term)&&out;return out}},constants:{PARTIAL_AND_RULES:[["EqExpr","EqExpr",function(e1,e2){return e1.arg1.exclusive?e1.arg2.f()==e2.arg2.f()?e1:FALSE:e1.arg2.f()==e2.arg2.f()?e1:null}],["InExpr","InExpr",function(e1,e2){var i=e1.arg1.exclusive?e1.arg2.intersection(e2.arg2):e1.arg2.union(e2.arg2);return i.length?IN(e1.arg1,i):FALSE}],["InExpr","ContainedInICExpr",function(e1,e2){if(!e1.arg1.exclusive)return null;var i=e1.arg2.filter(function(o){return o=o.toUpperCase(),e2.arg2.some(function(o2){return-1!=o.indexOf(o2)})});return i.length?IN(e1.arg1,i):FALSE}],["ContainedInICExpr","ContainedInICExpr",function(e1,e2){console.assert(!1,"AND.partialEval: ContainedInICExpr has no partialEval rule")}],["InExpr","ContainsICExpr",function(e1,e2){if(e1.arg1.exclusive)var i=e1.arg2.filter(function(o){return-1!==o.indexOfIC(e2.arg2.f())})}],["InExpr","ContainsExpr",function(e1,e2){if(e1.arg1.exclusive){var i=e1.arg2.filter(function(o){return-1!==o.indexOf(e2.arg2.f())});return i.length?IN(e1.arg1,i):FALSE}}],["EqExpr","InExpr",function(e1,e2){return e1.arg1.exclusive?-1===e2.arg2.indexOf(e1.arg2.f())?FALSE:e1:void 0}]],partialAnd:function(e1,e2){if(OrExpr.isInstance(e2)){var tmp=e1;e1=e2,e2=tmp}if(OrExpr.isInstance(e1)){for(var args=[],i=0;i<e1.args.length;i++)args.push(AND(e2,e1.args[i]));return OrExpr.create({args:args}).partialEval()}if(!BINARY.isInstance(e1))return null;if(!BINARY.isInstance(e2))return null;if(e1.arg1!=e2.arg1)return null;for(var RULES=this.PARTIAL_AND_RULES,i=0;i<RULES.length;i++){if(e1.model_.name==RULES[i][0]&&e2.model_.name==RULES[i][1])return RULES[i][2](e1,e2);if(e2.model_.name==RULES[i][0]&&e1.model_.name==RULES[i][1])return RULES[i][2](e2,e1)}return DEBUG&&console.log("Unknown partialAnd combination: ",e1.name_,e2.name_),null},partialEval:function(){for(var newArgs=[],updated=!1,i=0;i<this.args.length;i++){var a=this.args[i],newA=this.args[i].partialEval();if(newA===FALSE)return FALSE;if(AndExpr.isInstance(newA)){for(var j=0;j<newA.args.length;j++)newArgs.push(newA.args[j]);updated=!0}else newA===TRUE?updated=!0:(newArgs.push(newA),a!==newA&&(updated=!0))}for(var i=0;i<newArgs.length-1;i++)for(var j=i+1;j<newArgs.length;j++){var a=this.partialAnd(newArgs[i],newArgs[j]);if(a){if(console.log("***************** ",newArgs[i].toMQL()," <PartialAnd> ",newArgs[j].toMQL()," -> ",a.toMQL()),a===FALSE)return FALSE;newArgs[i]=a,newArgs.splice(j,1)}}return 0==newArgs.length?TRUE:1==newArgs.length?newArgs[0]:updated?AndExpr.create({args:newArgs}):this},f:function(obj){return this.args.every(function(arg){return arg.f(obj)})}}}),CLASS({name:"OrExpr",extendsModel:"NARY",documentation:"N-ary expression which is true if any one of its 0 or more subexpressions is true. OR() === FALSE",methods:{toSQL:function(){var s;s="(";for(var i=0;i<this.args.length;i++){var a=this.args[i];s+=a.toSQL(),i<this.args.length-1&&(s+=" OR ")}return s+=")"},toMQL:function(){for(var s="",i=0;i<this.args.length;i++){var a=this.args[i];s+=a.toMQL(),i<this.args.length-1&&(s+=" OR ")}return s},toBQL:function(){for(var s="",i=0;i<this.args.length;i++){var a=this.args[i];s+=a.toBQL(),i<this.args.length-1&&(s+=" | ")}return s},collectInputs:function(terms){for(var i=0;i<this.args.length;i++)this.args[i].collectInputs(terms)},minterm:function(index,term){for(var out=!1,i=0;i<this.args.length;i++)out=this.args[i].minterm(index,term)||out;return out}},constants:{PARTIAL_OR_RULES:[["InExpr","EqExpr",function(e1,e2){return IN(e1.arg1,e1.arg1.union([e2.arg2.f()]))}],["InExpr","InExpr",function(e1,e2){var i=e1.arg2.filter(function(o){return-1!==e2.arg2.indexOf(o)});return IN(e1.arg1,e1.arg2.union(e2.arg2))}]],partialOr:function(e1,e2){if(!BINARY.isInstance(e1))return null;if(!BINARY.isInstance(e2))return null;if(e1.arg1!=e2.arg1)return null;for(var RULES=this.PARTIAL_OR_RULES,i=0;i<RULES.length;i++){if(e1.model_.name==RULES[i][0]&&e2.model_.name==RULES[i][1])return RULES[i][2](e1,e2);if(e2.model_.name==RULES[i][0]&&e1.model_.name==RULES[i][1])return RULES[i][2](e2,e1)}return console.log("************** Unknown partialOr combination: ",e1.name_,e2.name_),null},partialEval:function(){for(var newArgs=[],updated=!1,i=0;i<this.args.length;i++){var a=this.args[i],newA=this.args[i].partialEval();if(newA===TRUE)return TRUE;if(OrExpr.isInstance(newA)){for(var j=0;j<newA.args.length;j++)newArgs.push(newA.args[j]);updated=!0}else newA!==FALSE&&newArgs.push(newA),a!==newA&&(updated=!0)}for(var i=0;i<newArgs.length-1;i++)for(var j=i+1;j<newArgs.length;j++){var a=this.partialOr(newArgs[i],newArgs[j]);if(a){if(console.log("***************** ",newArgs[i].toMQL()," <PartialOr> ",newArgs[j].toMQL()," -> ",a.toMQL()),a===TRUE)return TRUE;newArgs[i]=a,newArgs.splice(j,1)}}return 0==newArgs.length?FALSE:1==newArgs.length?newArgs[0]:updated?OrExpr.create({args:newArgs}):this},f:function(obj){return this.args.some(function(arg){return arg.f(obj)})}}}),CLASS({name:"NotExpr",extendsModel:"UNARY","abstract":!0,documentation:"Unary expression which inverts the truth value of its argument.",methods:{toSQL:function(){return"not ( "+this.arg1.toSQL()+" )"},toMQL:function(){return"-"+this.arg1.toMQL()},toBQL:function(){return"-"+this.arg1.toBQL()},collectInputs:function(terms){this.arg1.collectInputs(terms)},minterm:function(index,term){return!this.arg1.minterm(index,term)},partialEval:function(){var newArg=this.arg1.partialEval();return newArg===TRUE?FALSE:newArg===FALSE?TRUE:NotExpr.isInstance(newArg)?newArg.arg1:EqExpr.isInstance(newArg)?NeqExpr.create(newArg):NeqExpr.isInstance(newArg)?EqExpr.create(newArg):LtExpr.isInstance(newArg)?GteExpr.create(newArg):GtExpr.isInstance(newArg)?LteExpr.create(newArg):LteExpr.isInstance(newArg)?GtExpr.create(newArg):GteExpr.isInstance(newArg)?LtExpr.create(newArg):this.arg1===newArg?this:NOT(newArg)},f:function(obj){return!this.arg1.f(obj)}}}),CLASS({name:"ContainedInICExpr",extendsModel:"BINARY",documentation:"Checks if the first argument is contained in the array-valued right argument, ignoring case in strings.",properties:[{name:"arg2",label:"Argument",type:"Expr",help:"Sub-expression",preSet:function(_,a){return a.map(function(o){return o.toUpperCase()})}}],methods:{toSQL:function(){return this.arg1.toSQL()+" IN "+this.arg2},toMQL:function(){return this.arg1.toMQL()+":"+this.arg2.join(",")},toBQL:function(){return this.arg1.toBQL()+":("+this.arg2.join("|")+")"},f:function(obj){var v=this.arg1.f(obj);if(Array.isArray(v)){for(var j=0;j<v.length;j++)for(var a=v[j].toUpperCase(),i=0;i<this.arg2.length;i++)if(-1!=a.indexOf(this.arg2[i]))return!0}else{v=(""+v).toUpperCase();for(var i=0;i<this.arg2.length;i++)if(-1!=v.indexOf(this.arg2[i]))return!0}return!1}}}),CLASS({name:"ContainsExpr",extendsModel:"BINARY",methods:{toSQL:function(){return this.arg1.toSQL()+" like '%' + "+this.arg2.toSQL()+"+ '%'"},toMQL:function(){return this.arg1.toMQL()+":"+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+":"+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval();return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(-1!=newArg1.f().indexOf(newArg2.f())):this.arg1!==newArg1||this.arg2!=newArg2?ContainsExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){var arg1=this.arg1.f(obj),arg2=this.arg2.f(obj);return Array.isArray(arg1)?arg1.some(function(arg){return-1!=arg.indexOf(arg2)}):-1!=arg1.indexOf(arg2)}}}),CLASS({name:"ContainsICExpr",extendsModel:"BINARY",properties:[{name:"arg2",label:"Argument",type:"Expr",help:"Sub-expression",defaultValue:TRUE,postSet:function(_,value){this.pattern_=void 0}}],methods:{toSQL:function(){return this.arg1.toSQL()+" like '%' + "+this.arg2.toSQL()+"+ '%'"},toMQL:function(){return this.arg1.toMQL()+":"+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+":"+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval();return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(-1!=newArg1.f().toLowerCase().indexOf(newArg2.f())):this.arg1!==newArg1||this.arg2!=newArg2?ContainsICExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){var arg1=this.arg1.f(obj),pattern=this.pattern_||(this.pattern_=new RegExp(this.arg2.f().toString().replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"i"));if(Array.isArray(arg1)){var pattern=this.pattern_;return arg1.some(function(arg){return pattern.test(arg)})}return this.pattern_.test(arg1)}}}),CLASS({name:"NeqExpr",extendsModel:"BINARY","abstract":!0,methods:{toSQL:function(){return this.arg1.toSQL()+"<>"+this.arg2.toSQL()},toMQL:function(){return"-"+this.arg1.toMQL()+"="+this.arg2.toMQL()},toBQL:function(){return"-"+this.arg1.toBQL()+":"+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval();return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(newArg1.f()!=newArg2.f()):this.arg1!==newArg1||this.arg2!=newArg2?NeqExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){return this.arg1.f(obj)!=this.arg2.f(obj)}}}),CLASS({name:"StartsWithExpr",extendsModel:"BINARY",methods:{toSQL:function(){return this.arg1.toSQL()+" like '%' + "+this.arg2.toSQL()+"+ '%'"},toMQL:function(){return this.arg1.toMQL()+"-after:"+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+">="+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval();return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(newArg1.f().startsWith(newArg2.f())):this.arg1!==newArg1||this.arg2!=newArg2?StartsWithExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){var arg1=this.arg1.f(obj),arg2=this.arg2.f(obj);return Array.isArray(arg1)?arg1.some(function(arg){return arg.startsWith(arg2)}):arg1.startsWith(arg2)}}}),CLASS({name:"StartsWithICExpr",extendsModel:"BINARY",methods:{toSQL:function(){return this.arg1.toSQL()+" like '%' + "+this.arg2.toSQL()+"+ '%'"},toMQL:function(){return this.arg1.toMQL()+"-after:"+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+">="+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval();return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(newArg1.f().startsWithIC(newArg2.f())):this.arg1!==newArg1||this.arg2!=newArg2?StartsWithICExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){return this.arg1.f(obj).startsWithIC(this.arg2.f(obj))}}}),CLASS({name:"ConcatExpr",extendsModel:"NARY",label:"concat",methods:{partialEval:function(){return this},f:function(obj){for(var str=[],i=0;i<this.args.length;i++)str.push(this.args[i].f(obj));
return str.join("")}}}),CLASS({name:"SumExpr",extendsModel:"UNARY",properties:[{name:"sum",type:"int",help:"Sum of values.",factory:function(){return 0}}],methods:{pipe:function(sink){sink.put(this)},put:function(obj){this.instance_.sum+=this.arg1.f(obj)},remove:function(obj){this.sum-=this.arg1.f(obj)},toString:function(){return this.sum}}}),CLASS({name:"AvgExpr",extendsModel:"UNARY",properties:[{name:"count",type:"int",defaultValue:0},{name:"sum",type:"int",help:"Sum of values.",defaultValue:0},{name:"avg",type:"floag",help:"Average of values.",getter:function(){return this.sum/this.count}}],methods:{pipe:function(sink){sink.put(this)},put:function(obj){this.count++,this.sum+=this.arg1.f(obj)},remove:function(obj){this.count--,this.sum-=this.arg1.f(obj)},toString:function(){return this.avg}}}),CLASS({name:"MinExpr",extendsModel:"UNARY",properties:[{name:"min",type:"int",help:"Minimum value.",defaultValue:void 0}],methods:{minimum:function(o1,o2){return o1.compareTo(o2)>0?o2:o1},reduce:function(other){return MinExpr.create({max:this.mininum(this.min,other.min)})},reduceI:function(other){this.min=this.minimum(this.min,other.min)},pipe:function(sink){sink.put(this)},put:function(obj){var v=this.arg1.f(obj);this.min=void 0===this.min?v:this.minimum(this.min,v)},remove:function(obj){},toString:function(){return this.min}}}),CLASS({name:"DistinctExpr",extendsModel:"BINARY",properties:[{name:"values",help:"Distinct values.",factory:function(){return{}}}],methods:{reduce:function(other){},reduceI:function(other){},put:function(obj){var key=this.arg1.f(obj);this.values.hasOwnProperty(key)||(this.values[key]=!0,this.arg2.put(obj))},remove:function(obj){},toString:function(){return this.arg2.toString()},toHTML:function(){return this.arg2.toHTML()}}}),CLASS({name:"GroupByExpr",extendsModel:"BINARY",properties:[{name:"groups",type:"Map[Expr]",help:"Groups.",factory:function(){return{}}},{name:"groupKeys",factory:function(){return[]}}],methods:{reduce:function(other){},reduceI:function(other){for(var i in other.groups)this.groups[i]?this.groups[i].reduceI(other.groups[i]):this.groups[i]=other.groups[i].deepClone()},pipe:function(sink){for(key in this.groups)sink.push([key,this.groups[key].toString()]);return sink},putInGroup_:function(key,obj){var group=this.groups.hasOwnProperty(key)&&this.groups[key];group||(group=this.arg2.clone(),this.groups[key]=group,this.groupKeys.push(key)),group.put(obj)},put:function(obj){var key=this.arg1.f(obj);if(Array.isArray(key))if(key.length)for(var i=0;i<key.length;i++)this.putInGroup_(key[i],obj);else this.putInGroup_("",obj);else this.putInGroup_(key,obj)},clone:function(){return GroupByExpr.create({arg1:this.arg1,arg2:this.arg2})},remove:function(obj){},toString:function(){return this.groups},deepClone:function(){var cl=this.clone();cl.groups={};for(var i in this.groups)cl.groups[i]=this.groups[i].deepClone();return cl},toView_:function(){return this},toHTML:function(){var out=[];out.push("<table border=1>");for(var key in this.groups){var value=this.groups[key],str=value.toView_?value.toView_().toHTML():value;out.push("<tr><th>",key,"</th><td>",str,"</td></tr>")}return out.push("</table>"),out.join("")},initHTML:function(){for(var key in this.groups){var value=this.groups[key];value.toView_&&value.toView_().initHTML()}}}}),CLASS({name:"GridByExpr",extendsModel:"Expr",properties:[{name:"xFunc",label:"X-Axis Function",type:"Expr",help:"Sub-expression",defaultValue:TRUE},{name:"yFunc",label:"Y-Axis Function",type:"Expr",help:"Sub-expression",defaultValue:TRUE},{name:"acc",label:"Accumulator",type:"Expr",help:"Sub-expression",defaultValue:TRUE},{name:"rows",type:"Map[Expr]",help:"Rows.",factory:function(){return{}}},{name:"cols",label:"Columns",type:"Map[Expr]",help:"Columns.",factory:function(){return{}}},{model_:"ArrayProperty",name:"children"}],methods:{init:function(){this.SUPER();var self=this,f=function(){self.cols=GROUP_BY(self.xFunc,COUNT()),self.rows=GROUP_BY(self.yFunc,GROUP_BY(self.xFunc,self.acc))};self.addPropertyListener("xFunc",f),self.addPropertyListener("yFunc",f),self.addPropertyListener("acc",f),f()},reduce:function(other){},reduceI:function(other){},pipe:function(sink){},put:function(obj){this.rows.put(obj),this.cols.put(obj)},clone:function(){return this.model_.create({xFunc:this.xFunc,yFunc:this.yFunc,acc:this.acc})},remove:function(obj){},toString:function(){return this.groups},deepClone:function(){},renderCell:function(x,y,value){var str=value?value.toHTML?value.toHTML():value:"";return value&&value.toHTML&&value.initHTML&&this.children.push(value),"<td>"+str+"</td>"},sortAxis:function(values,f){return values.sort(f.compareProperty)},sortCols:function(cols,xFunc){return this.sortAxis(cols,xFunc)},sortRows:function(rows,yFunc){return this.sortAxis(rows,yFunc)},sortedCols:function(){return this.sortCols(this.cols.groupKeys,this.xFunc)},sortedRows:function(){return this.sortRows(this.rows.groupKeys,this.yFunc)},toHTML_:function(){return this},toHTML:function(){var out;this.children=[];var cols=this.cols.groups,rows=this.rows.groups,sortedCols=this.sortedCols(),sortedRows=this.sortedRows();out='<table border=0 cellspacing=0 class="gridBy"><tr><th></th>';for(var i=0;i<sortedCols.length;i++){var x=sortedCols[i],str=x.toHTML?x.toHTML():x;out+="<th>"+str+"</th>"}out+="</tr>";for(var j=0;j<sortedRows.length;j++){var y=sortedRows[j];out+="<tr><th>"+y+"</th>";for(var i=0;i<sortedCols.length;i++){var x=sortedCols[i],value=rows[y].groups[x];value&&(value.x=x,value.y=y),out+=this.renderCell(x,y,value)}out+="</tr>"}return out+="</table>"},initHTML:function(){for(var i=0;i<this.children.length;i++)this.children[i].initHTML();this.children=[]}}}),CLASS({name:"MapExpr",extendsModel:"BINARY",methods:{reduce:function(other){},reduceI:function(other){},pipe:function(sink){},put:function(obj){var val=this.arg1.f?this.arg1.f(obj):this.arg1(obj),acc=this.arg2;acc.put(val)},clone:function(){return MapExpr.create({arg1:this.arg1,arg2:this.arg2.clone()})},remove:function(obj){},toString:function(){return this.arg2.toString()},deepClone:function(){},toHTML:function(){return this.arg2.toHTML?this.arg2.toHTML():this.toString()},initHTML:function(){this.arg2.initHTML&&this.arg2.initHTML()}}}),CLASS({name:"SeqExpr",extendsModel:"NARY",methods:{pipe:function(sink){sink.put(this)},put:function(obj){for(var ret=[],i=0;i<this.args.length;i++){var a=this.args[i];a.put(obj)}},f:function(obj){for(var ret=[],i=0;i<this.args.length;i++){var a=this.args[i];ret.push(a.f(obj))}return ret},clone:function(){return SeqExpr.create({args:this.args.clone()})},toString:function(obj){var out=[];out.push("(");for(var i=0;i<this.args.length;i++){var a=this.args[i];out.push(a.toString()),i<this.args.length-1&&out.push(",")}return out.push(")"),out.join("")},toHTML:function(obj){for(var out=[],i=0;i<this.args.length;i++){var a=this.args[i];out.push(a.toHTML?a.toHTML():a.toString()),i<this.args.length-1&&out.push("&nbsp;")}return out.join("")}}}),CLASS({name:"UpdateExpr",extendsModel:"NARY",label:"UpdateExpr",properties:[{name:"dao",type:"DAO","transient":!0,hidden:!0}],methods:{put:function(obj){(this.objs_||(this.objs_=[])).push(obj)},eof:function(){if(this.objs_){for(var i=0;i<this.objs_.length;i++){var obj=this.objs_[i],newObj=this.f(obj);newObj.id!==obj.id&&this.dao.remove(obj.id),this.dao.put(newObj)}this.objs_=void 0}},f:function(obj){for(var newObj=obj.clone(),i=0;i<this.args.length;i++)this.args[i].f(newObj);return newObj},reduce:function(other){return UpdateExpr.create({args:this.args.concat(other.args),dao:this.dao})},reduceI:function(other){this.args=this.args.concat(other.args)},toString:function(){return this.toSQL()},toSQL:function(){for(var s="SET ",i=0;i<this.args.length;i++){var a=this.args[i];s+=a.toSQL(),i<this.args.length-1&&(s+=", ")}return s}}}),CLASS({name:"SetExpr",label:"SetExpr",extendsModel:"BINARY",methods:{toSQL:function(){return this.arg1.toSQL()+" = "+this.arg2.toSQL()},f:function(obj){Property.isInstance(this.arg1)&&(obj[this.arg1.name]=this.arg2.f(obj))}}}),CLASS({name:"ExpandableGroupByExpr",extendsModel:"BINARY",properties:[{name:"groups",type:"Map[Expr]",help:"Groups.",factory:function(){return{}}},{name:"expanded",type:"Map",help:"Expanded.",factory:function(){return{}}},{name:"values",type:"Object",help:"Values",factory:function(){return[]}}],methods:{reduce:function(other){},reduceI:function(other){},select:function(sink,options){var self=this;return this.values.select({put:function(o){sink.put(o);var key=self.arg1.f(o),a=o.children;if(a)for(var i=0;i<a.length;i++)sink.put(a[i])}},options),aconstant(sink)},putKeyValue_:function(key,value){var group=this.groups.hasOwnProperty(key)&&this.groups[key];group?group.count++:(group=value.clone(),this.expanded[key]&&(group.children=[]),this.groups[key]=group,group.count=1,this.values.push(group)),group.children&&group.children.push(obj)},put:function(obj){var key=this.arg1.f(obj);if(Array.isArray(key))for(var i=0;i<key.length;i++)this.putKeyValue_(key[i],obj);else this.putKeyValue_(key,obj)},where:function(query){return(this.Y||X).FilteredDAO_.create({query:query,delegate:this})},limit:function(count){return(this.Y||X).LimitedDAO_.create({count:count,delegate:this})},skip:function(skip){return(this.Y||X).SkipDAO_.create({skip:skip,delegate:this})},orderBy:function(){return(this.Y||X).OrderedDAO_.create({comparator:1==arguments.length?arguments[0]:argsToArray(arguments),delegate:this})},listen:function(){},unlisten:function(){},remove:function(obj){},toString:function(){return this.groups},deepClone:function(){return this}}}),CLASS({name:"TreeExpr",extendsModel:"Expr",properties:[{name:"parentProperty"},{name:"childrenProperty"},{name:"items_",help:"Temporary map to store collected objects.",factory:function(){return{}},"transient":!0},{model_:"ArrayProperty",name:"roots"}],methods:{put:function(o){this.items_[o.id]=o,this.parentProperty.f(o)||this.roots.push(o)},eof:function(){var pprop=this.parentProperty,cprop=this.childrenProperty;for(var key in this.items_){var item=this.items_[key],parentId=pprop.f(item);if(parentId){var parent=this.items_[parentId];parent[cprop.name]=cprop.f(parent).concat(item)}}this.items_={}}}}),CLASS({name:"DescExpr",extendsModel:"UNARY",methods:{toSQL:function(){return this.arg1.toMQL()+"DESC"},toMQL:function(){return"-"+this.arg1.toMQL()},compare:function(o1,o2){return-1*this.arg1.compare(o1,o2)}}}),CLASS({name:"AddExpr",extendsModel:"BINARY",methods:{toSQL:function(){return this.arg1.toSQL()+" + "+this.arg2.toSQL()},f:function(o){return this.arg1.f(o)+this.arg2.f(o)}}});var JOIN=function(dao,key,sink){return sink=sink||[].sink,{f:function(o){var s=sink.clone();return dao.where(EQ(key,o.id)).select(s),[o,s]}}};CLASS({name:"MQLExpr",extendsModel:"UNARY",documentation:"Parse an MQL query string and use it as a predicate.",properties:[{name:"specializations_",factory:function(){return{}}}],methods:{specialize:function(model){var qp=QueryParserFactory(model,!0);return qp.parseString(this.arg1)||FALSE},specialization:function(model){return this.specializations_[model.name]||(this.specializations_[model.name]=this.specialize(model))},toSQL:function(){return this.arg1},toMQL:function(){return this.arg1},partialEval:function(){return this},f:function(obj){return this.specialization(obj.model_).f(obj)}}}),CLASS({name:"KeywordExpr",extendsModel:"UNARY",documentation:"Keyword search.",methods:{toSQL:function(){return this.arg1},toMQL:function(){return this.arg1},partialEval:function(){return this},f:function(obj){var pattern=this.pattern_||(this.pattern_=new RegExp(this.arg1.toString().replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"i"));return this.pattern_.test(obj.toJSON())}}});var MONTH=function(p){return{f:function(o){return p.f(o).getMonth()}}},QueryParserFactory=function(model,opt_enableKeyword){for(var g={__proto__:grammar,START:sym("query"),query:sym("or"),or:repeat(sym("and"),alt(literal_ic(" OR "),literal(" | ")),1),and:repeat(sym("expr"),alt(literal_ic("AND "),not(alt(literal_ic(" OR"),literal(" |"))," ")),1),expr:alt(sym("paren"),sym("negate"),sym("has"),sym("is"),sym("equals"),sym("before"),sym("after"),sym("id"),sym("keyword")),paren:seq1(1,"(",sym("query"),")"),negate:alt(seq("-",sym("expr")),seq("NOT ",sym("expr"))),id:sym("number"),has:seq(literal_ic("has:"),sym("fieldname")),is:seq(literal_ic("is:"),sym("fieldname")),equals:seq(sym("fieldname"),alt(":","="),sym("valueList")),before:seq(sym("fieldname"),alt("<","<=","-before:"),sym("value")),after:seq(sym("fieldname"),alt(">",">=","-after:"),sym("value")),value:alt(sym("me"),sym("date"),sym("string"),sym("number")),compoundValue:alt(sym("negateValue"),sym("orValue"),sym("andValue")),negateValue:seq("(",alt("-",literal_ic("not ")),sym("value"),")"),orValue:seq("(",repeat(sym("value"),alt("|",literal_ic(" or ")," | "),1),")"),andValue:seq("(",repeat(sym("value"),alt(literal_ic(" and ")," "),1),")"),valueList:alt(sym("compoundValue"),repeat(sym("value"),",",1)),keyword:function(){var keyword_=sym("keyword_");return function(ps){return opt_enableKeyword&&this.parse(keyword_,ps)}}(),keyword_:str(plus(notChar(" "))),me:seq(literal_ic("me"),lookahead(not(sym("char")))),date:alt(sym("range date"),sym("literal date"),sym("relative date")),"range date":seq(sym("literal date"),"..",sym("literal date")),"literal date":alt(seq(sym("number"),"-",sym("number"),"-",sym("number"),"T",sym("number"),":",sym("number")),seq(sym("number"),"-",sym("number"),"-",sym("number"),"T",sym("number")),seq(sym("number"),"-",sym("number"),"-",sym("number")),seq(sym("number"),"-",sym("number")),seq(sym("number"),"/",sym("number"),"/",sym("number"))),"relative date":seq(literal_ic("today"),optional(seq("-",sym("number")))),string:alt(sym("word"),sym("quoted string")),"quoted string":str(seq1(1,'"',repeat(alt(literal('\\"','"'),notChar('"'))),'"')),word:str(plus(sym("char"))),"char":alt(range("a","z"),range("A","Z"),range("0","9"),"-","^","_","@","%","."),number:str(plus(range("0","9")))},fields=[],i=0;i<model.properties_.length;i++){var prop=model.properties_[i];fields.push(literal_ic(prop.name,prop))}for(var i=0;i<model.properties_.length;i++)for(var prop=model.properties_[i],j=0;j<prop.aliases.length;j++)prop.aliases[j]&&fields.push(literal_ic(prop.aliases[j],prop));for(var i=0;i<model.properties_.length;i++){var prop=model.properties_[i];prop.shortName&&fields.push(literal_ic(prop.shortName,prop))}return fields.sort(function(a,b){var d=a.length-b.length;return 0!==d?d:a==b?0:b>a?1:-1}),g.fieldname=alt.apply(null,fields),g.addActions({id:function(v){return EQ(model.ID,v)},or:function(v){return OR.apply(OR,v)},and:function(v){return AND.apply(AND,v)},negate:function(v){return NOT(v[1])},number:function(v){return parseInt(v)},me:function(){return this.ME||this.X.ME||""},has:function(v){return NEQ(v[1],"")},is:function(v){return EQ(v[1],TRUE)},before:function(v){return Array.isArray(v[2])&&v[2][0]instanceof Date&&(v[2]="<="===v[1]?v[2][1]:v[2][0]),("<="===v[1]?LTE:LT)(v[0],v[2])},after:function(v){return Array.isArray(v[2])&&v[2][0]instanceof Date&&(v[2]=">="===v[1]?v[2][0]:v[2][1]),(">="===v[1]?GTE:GT)(v[0],v[2])},equals:function(v){var prop=v[0],values=v[2],isInt=IntProperty.isInstance(prop),isNum=isInt||FloatProperty.isInstance(prop),isDateField=DateProperty.isInstance(prop)||DateTimeProperty.isInstance(prop),isDateRange=Array.isArray(values[0])&&values[0][0]instanceof Date;if(isDateField||isDateRange){if(!isDateRange){var start=new Date(0),end=new Date(0);start.setUTCFullYear(values[0]),end.setUTCFullYear(+values[0]+1),values=[[start,end]]}var q=AND(GTE(prop,values[0][0]),LT(prop,values[0][1]));return q}if(isNum)for(var i=0;i<values.length;i++)values[i]=isInt?parseInt(values[i]):parseFloat(values[i]);var expr="="===v[1]||isNum?IN(v[0],values):ContainedInICExpr.create({arg1:compile_(prop),arg2:values});return values.negated?NOT(expr):values.and?AndExpr.create({args:values.map(function(x){return expr.model_.create({arg1:expr.arg1,arg2:[x]})})}):expr},keyword:function(v){return KEYWORD(v)},negateValue:function(v){return v.negated=!0,v},orValue:function(v){return v=v[1],v.or=!0,v},andValue:function(v){return v=v[1],v.and=!0,v},"literal date":function(v){var start,end,interval;start=new Date,end=new Date;for(var ops=["FullYear","Month","Date","Hours","Minutes","Seconds"],defaults=[0,1,1,0,0,0],i=0;i<ops.length;i++){var x=2*i>v.length?defaults[i]:v[2*i];start["setUTC"+ops[i]](x-(1==i?1:0)),end["setUTC"+ops[i]](x-(1==i?1:0))}var last=Math.floor(v.length/2),op="UTC"+ops[last];return end["set"+op](end["get"+op]()+1),[start,end]},"relative date":function(v){var d=new Date;return v[1]&&d.setDate(d.getDate()-v[1][1]),d},"range date":function(v){return[v[0][0],v[2][1]]}}),g},Visitor={create:function(){return{__proto__:this,stack:[]}},push:function(o){this.stack.push(o)},pop:function(){return this.stack.pop()},top:function(){return this.stack.length&&this.stack[this.stack.length-1]},visit:function(o){return Array.isArray(o)?this.visitArray(o):"string"==typeof o?this.visitString(o):"number"==typeof o?this.visitNumber(o):o instanceof Function?this.visitFunction(o):o instanceof Date?this.visitDate(o):o===!0?this.visitTrue():o===!1?this.visitFalse():null===o?this.visitNull():o instanceof Object?o.model_?this.visitObject(o):this.visitMap(o):this.visitUndefined()},visitArray:function(o){for(var len=o.length,i=0;len>i;i++)this.visitArrayElement(o,i);return o},visitArrayElement:function(arr,i){this.visit(arr[i])},visitString:function(o){return o},visitFunction:function(o){return o},visitNumber:function(o){return o},visitDate:function(o){return o},visitObject:function(o){for(var key in o.model_.properties_){var prop=o.model_.properties_[key];prop.name in o.instance_&&this.visitProperty(o,prop)}return o},visitProperty:function(o,prop){this.visit(o[prop.name])},visitMap:function(o){for(var key in o)this.visitMapElement(key,o[key]);return o},visitMapElement:function(key,value){},visitTrue:function(){return!0},visitFalse:function(){return!1},visitNull:function(){return null},visitUndefined:function(){return void 0}};CLASS({name:"XHR",properties:[{model_:"IntProperty",name:"delay",defaultValue:0},{model_:"IntProperty",name:"retries",defaultValue:0},{name:"authAgent"},{name:"responseType",defaultValue:"text"}],methods:{init:function(args){this.SUPER(args),this.delay&&this.addDecorator(DelayDecorator.create({delayMs:this.delay})),this.authAgent&&this.addDecorator(OAuthXhrDecorator.create({authAgent:this.authAgent})),this.retries&&this.addDecorator(RetryDecorator.create({maxAttempts:this.retries}))},makeXhr:function(){return new XMLHttpRequest},open:function(xhr,method,url){xhr.open(method,url)},setRequestHeader:function(xhr,header,value){xhr.setRequestHeader(header,value)},configure:function(xhr){xhr.responseType=this.responseType,this.setRequestHeader(xhr,"Content-Type","application/json")},bindListeners:function(xhr,ret){var self=this;xhr.onreadystatechange=function(){if(4==xhr.readyState){if("json"===self.responseType&&"string"==typeof xhr.response)var response=JSON.parse(xhr.response);else response=xhr.response;ret(response,xhr)}}},send:function(xhr,data){xhr.send(data)},asend:function(ret,url,data,method){var xhr=this.makeXhr();this.open(xhr,method||"GET",url),this.configure(xhr),this.bindListeners(xhr,ret),this.send(xhr,data&&data.toJSON?data.toJSON():data)}}}),CLASS({name:"OAuthXhrDecorator",properties:["authAgent"],methods:{configure:function(decorator,delegate,args){var xhr=args[0];return xhr.setRequestHeader("Authorization","Bearer "+decorator.authAgent.accessToken),delegate.apply(this,args)},asend:function(decorator,delegate,args){var ret=args[0];return args[0]=function(response,xhr){401===xhr.status?decorator.authAgent.refresh(function(){ret(response,xhr)}):ret(response,xhr)},delegate.apply(null,args)}}}),CLASS({name:"RetryDecorator",properties:[{model_:"IntProperty",name:"maxAttempts",defaultValue:3}],methods:{asend:function(decorator,delegate,args){var originalRet=args[0],attempts=0,self=this,response;awhile(function(){return!0},aseq(function(ret){args[0]=ret,delegate.apply(self,args)},function(ret,response,xhr){return xhr.status>=200&&xhr.status<300||404===xhr.status||++attempts>=decorator.maxAttempts?(finished=!0,void originalRet(response,xhr)):void ret()}))(function(){})}}}),CLASS({name:"DelayDecorator",properties:[{model_:"IntProperty",name:"delayMs"}],methods:{decorateObject:function(target){var asend=adelay(target.asend.bind(target),this.delayMs);target.decorate("asend",function(_,_,args){asend.apply(null,args)})}}}),CLASS({name:"XhrMessenger",properties:[{model_:"URLProperty",name:"url"},{model_:"StringProperty",name:"method",defaultValue:"POST"}],methods:{put:function(obj,sink){var xhr=this.Y.XHR.create();xhr.asend(function(response,xhr){return xhr.status>=200&&xhr.status<300?void(sink&&sink.put&&sink.put(response)):void(sink&&sink.error&&sink.error([response,xhr]))},this.url,obj,this.method)}}});var LoggingDAO={create:function(){var logger,delegate;return 2==arguments.length?(logger=arguments[0],delegate=arguments[1]):(logger=console.log.bind(console),delegate=arguments[0]),{__proto__:delegate,put:function(obj,sink){logger("put",obj),delegate.put(obj,sink)},remove:function(query,sink){logger("remove",query),delegate.remove(query,sink)},select:function(sink,options){return logger("select",options||""),delegate.select(sink,options)},removeAll:function(sink,options){return logger("removeAll",options),delegate.removeAll(sink,options)}}}},TimingDAO={create:function(name,delegate){function start(op){var str=name+"-"+op,key=activeOps[op]++?str+"-"+id++:str;return console.time(id),[key,str,window.performance.now(),op]}function end(act){activeOps[act[3]]--,id--,console.timeEnd(act[0]),console.log("Timing: ",act[1]," ",(window.performance.now()-act[2]).toFixed(3)," ms")}function endSink(act,sink){return{put:function(){end(act),sink&&sink.put&&sink.put.apply(sink,arguments)},remove:function(){end(act),sink&&sink.remove&&sink.remove.apply(sink,arguments)},error:function(){end(act),sink&&sink.error&&sink.error.apply(sink,arguments)},eof:function(){end(act),sink&&sink.eof&&sink.eof.apply(sink,arguments)}}}var id,activeOps={put:0,remove:0,find:0,select:0};return{__proto__:delegate,put:function(obj,sink){var act=start("put");delegate.put(obj,endSink(act,sink))},remove:function(query,sink){var act=start("remove");delegate.remove(query,endSink(act,sink))},find:function(key,sink){var act=start("find");delegate.find(key,endSink(act,sink))},select:function(sink,options){var act=start("select"),fut=afuture();return delegate.select(sink,options)(function(s){end(act),fut.set(s)}),fut.get}}}},ObjectToJSON={__proto__:Visitor.create(),visitFunction:function(o){return o.toString()},visitObject:function(o){return this.push({model_:(o.model_["package"]?o.model_["package"]+".":"")+o.model_.name}),this.__proto__.visitObject.call(this,o),this.pop()},visitProperty:function(o,prop){prop.propertyToJSON(this,this.top(),o)},visitMap:function(o){return this.push({}),Visitor.visitMap.call(this,o),this.pop()},visitMapElement:function(key,value){this.top()[key]=this.visit(value)},visitArray:function(o){return this.push([]),this.__proto__.visitArray.call(this,o),this.pop()},visitArrayElement:function(arr,i){this.top().push(this.visit(arr[i]))}},JSONToObject={__proto__:ObjectToJSON.create(),visitString:function(o){try{return"function("===o.substr(0,9)?eval("("+o+")"):o}catch(x){return console.log(x,o),o}},visitObject:function(o){var model=X.lookup(o.model_);if(!model)throw new Error("Unknown Model: "+o.model_);var obj=model.create();return Object_forEach(o,function(value,key){"model_"!==key&&(obj[key]=this.visit(value))}.bind(this)),obj},visitArray:Visitor.visitArray,visitArrayElement:function(arr,i){arr[i]=this.visit(arr[i])}};CLASS({name:"FilteredDAO_",extendsModel:"foam.dao.ProxyDAO",documentation:function(){},properties:[{name:"query",required:!0}],methods:{select:function(sink,options){return this.delegate.select(sink,options?{__proto__:options,query:options.query?AND(this.query,options.query):this.query}:{query:this.query})},removeAll:function(sink,options){return this.delegate.removeAll(sink,options?{__proto__:options,query:options.query?AND(this.query,options.query):this.query}:{query:this.query})},listen:function(sink,options){return this.delegate.listen(sink,options?{__proto__:options,query:options.query?AND(this.query,options.query):this.query}:{query:this.query})},toString:function(){return this.delegate+".where("+this.query+")"}}}),CLASS({name:"OrderedDAO_",extendsModel:"foam.dao.ProxyDAO",documentation:function(){},properties:[{name:"comparator",required:!0}],methods:{select:function(sink,options){return options?options.order||(options={__proto__:options,order:this.comparator}):options={order:this.comparator},this.delegate.select(sink,options)},toString:function(){return this.delegate+".orderBy("+this.comparator+")"}}}),CLASS({name:"LimitedDAO_",extendsModel:"foam.dao.ProxyDAO",documentation:function(){},properties:[{name:"count",required:!0}],methods:{select:function(sink,options){return options=options?"limit"in options?{__proto__:options,limit:Math.min(this.count,options.limit)}:{__proto__:options,limit:this.count}:{limit:this.count},this.delegate.select(sink,options)},toString:function(){return this.delegate+".limit("+this.count+")"}}}),CLASS({name:"SkipDAO_",extendsModel:"foam.dao.ProxyDAO",documentation:function(){},properties:[{name:"skip",required:!0,postSet:function(){this.skip!==Math.floor(this.skip)&&console.warn("skip() called with non-integer value: "+this.skip)}}],methods:{select:function(sink,options){return options=options?{__proto__:options,skip:this.skip}:{__proto__:options,skip:this.skip},this.delegate.select(sink,options)},toString:function(){return this.delegate+".skip("+this.skip+")"}}}),CLASS({name:"AbstractDAO",documentation:function(){},requires:[],properties:[{name:"daoListeners_","transient":!0,hidden:!0,factory:function(){return[]}}],methods:{init:function(){arequire("FilteredDAO_"),arequire("LimitedDAO_"),arequire("SkipDAO_"),arequire("OrderedDAO_"),this.SUPER()},update:function(expr){return this.select(UPDATE(expr,this))},listen:function(sink,options){sink=this.decorateSink_(sink,options,!0),this.daoListeners_.push(sink)},select:function(sink,options){},remove:function(query,sink){},pipe:function(sink,options){sink=this.decorateSink_(sink,options,!0);var fc=this.createFlowControl_(),self=this;this.select({put:function(){sink.put&&sink.put.apply(sink,arguments)},remove:function(){sink.remove&&sink.remove.apply(sink,arguments)},error:function(){sink.error&&sink.error.apply(sink,arguments)},eof:function(){fc.stopped?sink.eof&&sink.eof():self.listen(sink,options)}},options,fc)},decorateSink_:function(sink,options,isListener,disableLimit){return options&&(disableLimit||(options.limit&&(sink=limitedSink(options.limit,sink)),options.skip&&(sink=skipSink(options.skip,sink))),options.order&&!isListener&&(sink=orderedSink(options.order,sink)),options.query&&(sink=predicatedSink(options.query.partialEval?options.query.partialEval():options.query,sink))),sink},createFlowControl_:function(){return{stop:function(){this.stopped=!0},error:function(e){this.errorEvt=e}}},where:function(query){return(this.Y||X).lookup("FilteredDAO_").create({query:query,delegate:this})},limit:function(count){return(this.Y||X).lookup("LimitedDAO_").create({count:count,delegate:this})},skip:function(skip){return(this.Y||X).lookup("SkipDAO_").create({skip:skip,delegate:this})},orderBy:function(){return(this.Y||X).lookup("OrderedDAO_").create({comparator:1==arguments.length?arguments[0]:argsToArray(arguments),delegate:this})},unlisten:function(sink){for(var ls=this.daoListeners_,i=0;i<ls.length;i++)if(ls[i].$UID===sink.$UID)return ls.splice(i,1),!0},removeAll:function(sink,options){var self=this,future=afuture();return this.select({put:function(obj){self.remove(obj,{remove:sink&&sink.remove})}})(function(){sink&&sink.eof(),future.set()}),future.get},notify_:function(fName,args){for(var i=0;i<this.daoListeners_.length;i++){var l=this.daoListeners_[i],fn=l[fName];if(fn){args[2]={stop:function(fn,l){return function(){fn(l)}}(this.unlisten.bind(this),l),error:function(e){}};try{fn.apply(l,args)}catch(err){err!==this.UNSUBSCRIBE_EXCEPTION&&console.error("Error delivering event (removing listener): ",fName,err),this.unlisten(l)}}}}}}),Function.prototype.put=function(){this.apply(this,arguments)},Function.prototype.remove=function(){this.apply(this,arguments)},Function.prototype.reset=function(){this.call(this)},function(){var pmap={};for(var key in AbstractDAO.methods)pmap[AbstractDAO.methods[key].name]=AbstractDAO.methods[key].code;defineProperties(Array.prototype,pmap)}(),defineLazyProperty(Array.prototype,"daoListeners_",function(){return{value:[],configurable:!0}});var ArraySink={__proto__:Array.prototype,put:function(obj,sink){this.push(obj),this.notify_("put",arguments),sink&&sink.put&&sink.put(obj)},clone:function(){return this.slice(0).sink},deepClone:function(){for(var a=this.slice(0),i=0;i<a.length;i++)a[i]=a[i].deepClone();return a.sink}};Object.defineProperty(Array.prototype,"dao",{get:function(){return this.__proto__=Array.prototype,this},writeable:!0}),Object.defineProperty(Array.prototype,"sink",{get:function(){return this.__proto__=ArraySink,this},writeable:!0}),defineProperties(Array.prototype,{listen:AbstractDAO.getPrototype().listen,unlisten:AbstractDAO.getPrototype().unlisten,notify_:AbstractDAO.getPrototype().notify_,deleteF:function(v){for(var a=this.clone(),i=0;i<a.length;i++)if(a[i]===v){a.splice(i,1);break}return a},deleteI:function(v){for(var i=0;i<this.length;i++)if(this[i]===v)return this.splice(i,1),!0;return!1},removeF:function(p){for(var a=this.clone(),i=0;i<a.length;i++)if(p.f(a[i])){a.splice(i,1);break}return a},removeI:function(p){for(var i=0;i<this.length;i++)p.f(this[i])&&(this.splice(i,1),breeak);return this},pushF:function(obj){var a=this.clone();return a.push(obj),a},clone:function(){return this.slice(0)},deepClone:function(){for(var a=this.slice(0),i=0;i<a.length;i++)a[i]=a[i].deepClone();return a},id:function(obj){return obj.id||obj.$UID},put:function(obj,sink){for(var idx=0;idx<this.length;idx++)if(this[idx].id===obj.id)return this[idx]=obj,sink&&sink.put&&sink.put(obj),void this.notify_("put",arguments);this.push(obj),this.notify_("put",arguments),sink&&sink.put&&sink.put(obj)},find:function(query,sink){if(query.f){for(var idx=0;idx<this.length;idx++)if(query.f(this[idx]))return void(sink&&sink.put&&sink.put(this[idx]))}else for(var idx=0;idx<this.length;idx++)if(this[idx].id===query)return void(sink&&sink.put&&sink.put(this[idx]));sink&&sink.error&&sink.error("find",query)},remove:function(obj,sink){if(!obj)return void(sink&&sink.error&&sink.error("missing key"));for(var objId=obj.id,id=void 0!==objId&&""!==objId?objId:obj,idx=0;idx<this.length;idx++)if(this[idx].id===id){var rem=this.splice(idx,1)[0];return void(sink&&sink.remove&&sink.remove(rem[0]))}sink&&sink.error&&sink.error("remove",obj)},removeAll:function(sink,options){options||(options={}),options.query||(options.query={f:function(){return!0}});for(var i=0;i<this.length;i++){var obj=this[i];if(options.query.f(obj)){var rem=this.splice(i,1)[0];sink&&sink.remove&&sink.remove(rem),i--}}return sink&&sink.eof&&sink.eof(),anop()},select:function(sink,options){sink=sink||[].sink;var hasQuery=options&&(options.query||options.order),originalsink=sink;if(sink=this.decorateSink_(sink,options,!1,!hasQuery),!hasQuery&&GLOBAL.CountExpr&&CountExpr.isInstance(sink))return sink.count=this.length,aconstant(originalsink);for(var fc=this.createFlowControl_(),start=Math.max(0,hasQuery?0:options&&options.skip||0),end=hasQuery?this.length:Math.min(this.length,start+(options&&options.limit||this.length)),i=start;end>i&&(sink.put(this[i],null,fc),!fc.stopped);i++)if(fc.errorEvt)return sink.error&&sink.error(fc.errorEvt),aconstant(originalsink,fc.errorEvt);return sink.eof&&sink.eof(),aconstant(originalsink)}});var NOT_FOUND={cost:0,execute:function(_,sink,_){return anop
},toString:function(){return"no-match(cost=0)"}},NO_PLAN={cost:Number.MAX_VALUE,execute:function(){return anop},toString:function(){return"no-plan"}},ValueIndex={put:function(s,newValue){return newValue},remove:function(){return void 0},plan:function(){var plan={cost:1,execute:function(s,sink){return sink.put(s),anop},toString:function(){return"unique"}};return function(){return plan}}(),get:function(value,key){return value},select:function(value,sink,options){if(options){if(options.query&&!options.query.f(value))return;if("skip"in options&&options.skip-->0)return;if("limit"in options&&options.limit--<1)return}sink.put(value)},selectReverse:function(value,sink,options){this.select(value,sink,options)},size:function(obj){return 1},toString:function(){return"value"}},KEY=0,VALUE=1,SIZE=2,LEVEL=3,LEFT=4,RIGHT=5,TreeIndex={create:function(prop,tail){return tail=tail||ValueIndex,{__proto__:this,prop:prop,tail:tail,selectCount:0}},bulkLoad:function(a){if(this.tail===ValueIndex)return a.sort(toCompare(this.prop)),this.bulkLoad_(a,0,a.length-1);for(var s=void 0,i=0;i<a.length;i++)s=this.put(s,a[i]);return s},bulkLoad_:function(a,start,end){if(start>end)return void 0;var m=start+Math.floor((end-start+1)/2),tree=this.put(void 0,a[m]);return tree[LEFT]=this.bulkLoad_(a,start,m-1),tree[RIGHT]=this.bulkLoad_(a,m+1,end),tree[SIZE]+=this.size(tree[LEFT])+this.size(tree[RIGHT]),tree},dedup:function(obj,value){obj[this.prop.name]=value},maybeClone:function(s){return s&&this.selectCount>0?s.clone():s},put:function(s,newValue){return this.putKeyValue(s,this.prop.f(newValue),newValue)},putKeyValue:function(s,key,value){if(!s)return[key,this.tail.put(null,value),1,1];s=this.maybeClone(s);var r=this.compare(s[KEY],key);if(0===r)this.dedup(value,s[KEY]),s[SIZE]-=this.tail.size(s[VALUE]),s[VALUE]=this.tail.put(s[VALUE],value),s[SIZE]+=this.tail.size(s[VALUE]);else{var side=r>0?LEFT:RIGHT;s[side]&&(s[SIZE]-=s[side][SIZE]),s[side]=this.putKeyValue(s[side],key,value),s[SIZE]+=s[side][SIZE]}return this.split(this.skew(s))},skew:function(s){if(s&&s[LEFT]&&s[LEFT][LEVEL]===s[LEVEL]){var l=this.maybeClone(s[LEFT]);return s[LEFT]=l[RIGHT],l[RIGHT]=s,this.updateSize(s),this.updateSize(l),l}return s},updateSize:function(s){s[SIZE]=this.size(s[LEFT])+this.size(s[RIGHT])+this.tail.size(s[VALUE])},split:function(s){if(s&&s[RIGHT]&&s[RIGHT][RIGHT]&&s[LEVEL]===s[RIGHT][RIGHT][LEVEL]){var r=this.maybeClone(s[RIGHT]);return s[RIGHT]=r[LEFT],r[LEFT]=s,r[LEVEL]++,this.updateSize(s),this.updateSize(r),r}return s},remove:function(s,value){return this.removeKeyValue(s,this.prop.f(value),value)},removeKeyValue:function(s,key,value){if(!s)return s;s=this.maybeClone(s);var r=this.compare(s[KEY],key);if(0===r){if(s[SIZE]-=this.tail.size(s[VALUE]),s[VALUE]=this.tail.remove(s[VALUE],value),s[VALUE])return s[SIZE]+=this.tail.size(s[VALUE]),s;if(!s[LEFT]&&!s[RIGHT])return void 0;var side=s[LEFT]?LEFT:RIGHT,l=side===LEFT?this.predecessor(s):this.successor(s);s[KEY]=l[KEY],s[VALUE]=l[VALUE],s[side]=this.removeNode(s[side],l[KEY])}else{var side=r>0?LEFT:RIGHT;s[SIZE]-=this.size(s[side]),s[side]=this.removeKeyValue(s[side],key,value),s[SIZE]+=this.size(s[side])}return s=this.skew(this.decreaseLevel(s)),s[RIGHT]&&(s[RIGHT]=this.skew(this.maybeClone(s[RIGHT])),s[RIGHT][RIGHT]&&(s[RIGHT][RIGHT]=this.skew(this.maybeClone(s[RIGHT][RIGHT])))),s=this.split(s),s[RIGHT]=this.split(this.maybeClone(s[RIGHT])),s},removeNode:function(s,key){if(!s)return s;s=this.maybeClone(s);var r=this.compare(s[KEY],key);if(0===r)return s[LEFT]?s[LEFT]:s[RIGHT];var side=r>0?LEFT:RIGHT;return s[SIZE]-=this.size(s[side]),s[side]=this.removeNode(s[side],key),s[SIZE]+=this.size(s[side]),s},predecessor:function(s){if(!s[LEFT])return s;for(s=s[LEFT];s[RIGHT];s=s[RIGHT]);return s},successor:function(s){if(!s[RIGHT])return s;for(s=s[RIGHT];s[LEFT];s=s[LEFT]);return s},decreaseLevel:function(s){var expectedLevel=Math.min(s[LEFT]?s[LEFT][LEVEL]:0,s[RIGHT]?s[RIGHT][LEVEL]:0)+1;return expectedLevel<s[LEVEL]&&(s[LEVEL]=expectedLevel,s[RIGHT]&&expectedLevel<s[RIGHT][LEVEL]&&(s[RIGHT]=this.maybeClone(s[RIGHT]),s[RIGHT][LEVEL]=expectedLevel)),s},get:function(s,key){if(!s)return void 0;var r=this.compare(s[KEY],key);return 0===r?s[VALUE]:this.get(r>0?s[LEFT]:s[RIGHT],key)},select:function(s,sink,options){if(s){if(options){if("limit"in options&&options.limit<=0)return;var size=this.size(s);if(options.skip>=size&&!options.query)return void(options.skip-=size)}this.select(s[LEFT],sink,options),this.tail.select(s[VALUE],sink,options),this.select(s[RIGHT],sink,options)}},selectReverse:function(s,sink,options){if(s){if(options){if("limit"in options&&options.limit<=0)return;var size=this.size(s);if(options.skip>=size)return void(options.skip-=size)}this.selectReverse(s[RIGHT],sink,options),this.tail.selectReverse(s[VALUE],sink,options),this.selectReverse(s[LEFT],sink,options)}},findPos:function(s,key,incl){if(!s)return 0;var r=this.compare(s[KEY],key);return 0===r?incl?this.size(s[LEFT]):this.size(s)-this.size(s[RIGHT]):r>0?this.findPos(s[LEFT],key,incl):this.findPos(s[RIGHT],key,incl)+this.size(s)-this.size(s[RIGHT])},size:function(s){return s?s[SIZE]:0},compare:function(o1,o2){return this.prop.compareProperty(o1,o2)},plan:function(s,sink,options){var query=options&&options.query;if(query===FALSE)return NOT_FOUND;if(!query&&CountExpr.isInstance(sink)){var count=this.size(s);return{cost:0,execute:function(unused,sink,options){return sink.count+=count,anop},toString:function(){return"short-circuit-count("+count+")"}}}var prop=this.prop,isExprMatch=function(model){if(query){if(model.isInstance(query)&&query.arg1===prop){var arg2=query.arg2;return query=void 0,arg2}if(AndExpr.isInstance(query))for(var i=0;i<query.args.length;i++){var q=query.args[i];if(model.isInstance(q)&&q.arg1===prop)return query=query.clone(),query.args[i]=TRUE,query=query.partialEval(),query===TRUE&&(query=null),q.arg2}}return void 0},index=this,arg2=isExprMatch(InExpr);if(arg2&&Math.log(this.size(s))/Math.log(2)*arg2.length<this.size(s)){var keys=arg2,subPlans=[],results=[],cost=1,newOptions={};query&&(newOptions.query=query),"limit"in options&&(newOptions.limit=options.limit),"skip"in options&&(newOptions.skip=options.skip),"order"in options&&(newOptions.order=options.order);for(var i=0;i<keys.length;i++){var result=this.get(s,keys[i]);if(result){var subPlan=this.tail.plan(result,sink,newOptions);cost+=subPlan.cost,subPlans.push(subPlan),results.push(result)}}return 0==subPlans.length?NOT_FOUND:{cost:1+cost,execute:function(s2,sink,options){for(var pars=[],i=0;i<subPlans.length;i++)pars.push(subPlans[i].execute(results[i],sink,newOptions));return apar.apply(null,pars)},toString:function(){return"IN(key="+prop.name+", size="+results.length+")"}}}if(arg2=isExprMatch(EqExpr),void 0!=arg2){var key=arg2.f(),result=this.get(s,key);if(!result)return NOT_FOUND;var newOptions={};query&&(newOptions.query=query),"limit"in options&&(newOptions.limit=options.limit),"skip"in options&&(newOptions.skip=options.skip),"order"in options&&(newOptions.order=options.order);var subPlan=this.tail.plan(result,sink,newOptions);return{cost:1+subPlan.cost,execute:function(s2,sink,options){return subPlan.execute(result,sink,newOptions)},toString:function(){return"lookup(key="+prop.name+", cost="+this.cost+(query&&query.toSQL?", query: "+query.toSQL():"")+") "+subPlan.toString()}}}if(arg2=isExprMatch(GtExpr),void 0!=arg2){var key=arg2.f(),pos=this.findPos(s,key,!1),newOptions={skip:(options&&options.skip||0)+pos};query&&(newOptions.query=query),"limit"in options&&(newOptions.limit=options.limit),"order"in options&&(newOptions.order=options.order),options=newOptions}if(arg2=isExprMatch(GteExpr),void 0!=arg2){var key=arg2.f(),pos=this.findPos(s,key,!0),newOptions={skip:(options&&options.skip||0)+pos};query&&(newOptions.query=query),"limit"in options&&(newOptions.limit=options.limit),"order"in options&&(newOptions.order=options.order),options=newOptions}if(arg2=isExprMatch(LtExpr),void 0!=arg2){var key=arg2.f(),pos=this.findPos(s,key,!0),newOptions={limit:pos-(options&&options.skip)||0};query&&(newOptions.query=query),"limit"in options&&(newOptions.limit=Math.min(options.limit,newOptions.limit)),"skip"in options&&(newOptions.skip=options.skip),"order"in options&&(newOptions.order=options.order),options=newOptions}if(arg2=isExprMatch(LteExpr),void 0!=arg2){var key=arg2.f(),pos=this.findPos(s,key,!1),newOptions={limit:pos-(options&&options.skip)||0};query&&(newOptions.query=query),"limit"in options&&(newOptions.limit=Math.min(options.limit,newOptions.limit)),"skip"in options&&(newOptions.skip=options.skip),"order"in options&&(newOptions.order=options.order),options=newOptions}var cost=this.size(s),sortRequired=!1,reverseSort=!1;return options&&options.order&&(options.order===prop||(DescExpr.isInstance(options.order)&&options.order.arg1===prop?reverseSort=!0:(sortRequired=!0,0!=cost&&(cost*=Math.log(cost)/Math.log(2))))),options&&!sortRequired&&(options.skip&&(cost-=options.skip),options.limit&&(cost=Math.min(cost,options.limit))),{cost:cost,execute:function(){if(sortRequired){var a=[];index.selectCount++,index.select(s,a,{query:options.query}),index.selectCount--,a.sort(toCompare(options.order));var skip=options.skip||0,limit=Number.isFinite(options.limit)?options.limit:a.length;limit+=skip,limit=Math.min(a.length,limit);for(var i=skip;limit>i;i++)sink.put(a[i])}else index.selectCount++,reverseSort?index.selectReverse(s,sink,options):index.select(s,sink,options),index.selectCount--;return anop},toString:function(){return"scan(key="+prop.name+", cost="+this.cost+(query&&query.toSQL?", query: "+query.toSQL():"")+")"}}},toString:function(){return"TreeIndex("+this.prop.name+", "+this.tail+")"}},CITreeIndex={__proto__:TreeIndex,create:function(prop,tail){return tail=tail||ValueIndex,{__proto__:this,prop:prop,tail:tail}},put:function(s,newValue){return this.putKeyValue(s,this.prop.f(newValue).toLowerCase(),newValue)},remove:function(s,value){return this.removeKeyValue(s,this.prop.f(value).toLowerCase(),value)}},SetIndex={__proto__:TreeIndex,create:function(prop,tail){return tail=tail||ValueIndex,{__proto__:this,prop:prop,tail:tail}},dedup:function(obj,value){},put:function(s,newValue){var a=this.prop.f(newValue);if(a.length)for(var i=0;i<a.length;i++)s=this.putKeyValue(s,a[i],newValue);else s=this.putKeyValue(s,"",newValue);return s},remove:function(s,value){var a=this.prop.f(value);if(a.length)for(var i=0;i<a.length;i++)s=this.removeKeyValue(s,a[i],value);else s=this.removeKeyValue(s,"",value);return s}},PositionQuery={create:function(args){return{__proto__:this,skip:args.skip,limit:args.limit,s:args.s}},reduce:function(other){var otherFinish=other.skip+other.limit,myFinish=this.skip+this.limit;return other.skip>myFinish?null:other.skip>=this.skip?PositionQuery.create({skip:this.skip,limit:Math.max(myFinish,otherFinish)-this.skip,s:this.s}):other.reduce(this)},equals:function(other){return this.skip===other.skip&&this.limit===other.limit}},AutoPositionIndex={create:function(factory,mdao,networkdao,maxage){var obj={__proto__:this,factory:factory,maxage:maxage,dao:mdao,networkdao:networkdao,sets:[],alt:AltIndex.create()};return obj},put:function(s,value){return this.alt.put(s,value)},remove:function(s,value){return this.alt.remove(s,value)},bulkLoad:function(a){return[]},addIndex:function(s,index){return this},addPosIndex:function(s,options){var index=PositionIndex.create(options&&options.order,options&&options.query,this.factory,this.dao,this.networkdao,this.queue,this.maxage);this.alt.delegates.push(index),s.push(index.bulkLoad([]))},hasIndex:function(options){for(var i=0;i<this.sets.length;i++){var set=this.sets[i];if(set[0].equals(options&&options.query||"")&&set[1].equals(options&&options.order||""))return!0}return!1},plan:function(s,sink,options){var subPlan=this.alt.plan(s,sink,options);return subPlan!=NO_PLAN?subPlan:options&&null!=options.skip&&null!=options.limit||CountExpr.isInstance(sink)?this.hasIndex(options)?NO_PLAN:(this.sets.push([options&&options.query||"",options&&options.order||""]),this.addPosIndex(s,options),this.alt.plan(s,sink,options)):NO_PLAN}},PositionIndex={create:function(order,query,factory,dao,networkdao,queue,maxage){var obj={__proto__:this,order:order||"",query:query||"",factory:factory,dao:dao,networkdao:networkdao.where(query).orderBy(order),maxage:maxage,queue:arequestqueue(function(ret,request){var s=request.s;obj.networkdao.skip(request.skip).limit(request.limit).select()(function(objs){for(var now=Date.now(),i=0;i<objs.length;i++)s[request.skip+i]={obj:objs[i].id,timestamp:now},s.feedback=objs[i].id,obj.dao.put(objs[i]),s.feedback=null;ret()})},void 0,1)};return obj},put:function(s,newValue){if(s.feedback===newValue.id)return s;if(this.query&&!this.query.f(newValue))return s;for(var compare=toCompare(this.order),i=0;i<s.length;i++){var entry=s[i];if(entry){if(this.dao.find(entry.obj,{put:function(o){entry=o}}),entry.id===newValue.id)break;if(compare(entry,newValue)>0){for(var j=s.length;j>i;j--)s[j]=s[j-1];(0==i||s[i-1])&&(s[i]={obj:newValue.id,timestamp:Date.now()});break}}}return s},remove:function(s,obj){if(s.feedback===obj.id)return s;for(var i=0;i<s.length;i++)if(s[i]&&s[i].obj===obj.id){for(var j=i;j<s.length-1;j++)s[j]=s[j+1];break}return s},bulkLoad:function(a){return[]},plan:function(s,sink,options){var order=options&&options.order||"",query=options&&options.query||"",skip=options&&options.skip,limit=options&&options.limit,self=this;if(!order.equals(this.order)||!query.equals(this.query))return NO_PLAN;if(CountExpr.isInstance(sink))return{cost:0,execute:function(s,sink,options){return s.count||(s.count=amemo(function(ret){self.networkdao.select(COUNT())(function(c){ret(c)})},self.maxage)),function(ret,count){sink.copyFrom(count),ret()}.ao(s.count)},toString:function(){return"position-index(cost="+this.cost+", count)"}};if(void 0==skip||void 0==limit)return NO_PLAN;var threshold=Date.now()-this.maxage;return{cost:0,toString:function(){return"position-index(cost="+this.cost+")"},execute:function(s,sink,options){for(var objs=[],min,max,i=0;limit>i;i++){var o=s[i+skip];(!o||o.timestamp<threshold)&&(void 0==min&&(min=i+skip),max=i+skip),o?self.dao.find(o.obj,{put:function(obj){objs[i]=obj}}):objs[i]=self.factory(),!objs[i]}void 0!=min&&self.queue(PositionQuery.create({skip:min,limit:max-min+1,s:s}));for(var i=0;i<objs.length;i++)sink.put(objs[i]);return anop}}}},AltIndex={GOOD_ENOUGH_PLAN:10,create:function(){return{__proto__:this,delegates:argsToArray(arguments)}},addIndex:function(s,index){var a=[];return this.plan(s,a).execute(s,a),s.push(index.bulkLoad(a)),this.delegates.push(index),this},bulkLoad:function(a){for(var i=0;i<this.delegates.length;i++)this.root[i]=this.delegates[i].bulkLoad(a)},get:function(s,key){return this.delegates[0].get(s[0],key)},put:function(s,newValue){s=s||[].sink;for(var i=0;i<this.delegates.length;i++)s[i]=this.delegates[i].put(s[i],newValue);return s},remove:function(s,obj){s=s||[].sink;for(var i=0;i<this.delegates.length;i++)s[i]=this.delegates[i].remove(s[i],obj);return s},plan:function(s,sink,options){for(var bestPlan,bestPlanI=0,i=0;i<this.delegates.length;i++){var plan=this.delegates[i].plan(s[i],sink,options);if(plan.cost<=AltIndex.GOOD_ENOUGH_PLAN){bestPlanI=i,bestPlan=plan;break}(!bestPlan||plan.cost<bestPlan.cost)&&(bestPlanI=i,bestPlan=plan)}return void 0==bestPlan||bestPlan==NO_PLAN?NO_PLAN:{__proto__:bestPlan,execute:function(unused,sink,options){return bestPlan.execute(s[bestPlanI],sink,options)}}},size:function(obj){return this.delegates[0].size(obj[0])},toString:function(){return"Alt("+this.delegates.join(",")+")"}},mLangIndex={create:function(mlang){return{__proto__:this,mlang:mlang,PLAN:{cost:0,execute:function(s,sink,options){return sink.copyFrom(s),anop},toString:function(){return"mLangIndex("+this.s+")"}}}},bulkLoad:function(a){return a.select(this.mlang),this.mlang},put:function(s,newValue){return s=s||this.mlang.clone(),s.put(newValue),s},remove:function(s,obj){return s=s||this.mlang.clone(),s.remove&&s.remove(obj),s},size:function(s){return Number.MAX_VALUE},plan:function(s,sink,options){return options&&options.query?NO_PLAN:sink.model_&&sink.model_.isInstance(s)&&s.arg1===sink.arg1?(this.PLAN.s=s,this.PLAN):NO_PLAN},toString:function(){return"mLangIndex("+this.mlang+")"}},AutoIndex={create:function(mdao){return{__proto__:this,properties:{id:!0},mdao:mdao}},put:function(s,newValue){return s},remove:function(s,obj){return s},bulkLoad:function(a){return"auto"},addIndex:function(prop){DescExpr.isInstance(prop)&&(prop=prop.arg1),console.log("Adding AutoIndex : ",prop.name),this.properties[prop.name]=!0,this.mdao.addIndex(prop)},plan:function(s,sink,options){return options&&(options.order&&Property.isInstance(options.order)&&!this.properties[options.order.name]?this.addIndex(options.order):options.query),NO_PLAN},toString:function(){return"AutoIndex()"}},MDAO=Model.create({extendsModel:"AbstractDAO",name:"MDAO",label:"Indexed DAO",properties:[{name:"model",type:"Model",required:!0},{model_:"BooleanProperty",name:"autoIndex",defaultValue:!1}],methods:{init:function(){this.SUPER(),this.map={},this.index=TreeIndex.create(this.model.getProperty(this.model.ids[0])),this.autoIndex&&this.addRawIndex(AutoIndex.create(this))},addIndex:function(){for(var props=argsToArray(arguments),i=0;i<this.model.ids.length;i++)if(props.push(this.model.getProperty(this.model.ids[i])),!props[props.length-1])throw"Undefined index property";return this.addUniqueIndex.apply(this,props)},addUniqueIndex:function(){for(var index=ValueIndex,i=arguments.length-1;i>=0;i--){var prop=arguments[i],proto="Array[]"==prop.type?SetIndex:TreeIndex;index=proto.create(prop,index)}return this.addRawIndex(index)},addRawIndex:function(index){return this.index.delegates||(this.index=AltIndex.create(this.index),this.root=[this.root]),this.index.addIndex(this.root,index),this},bulkLoad:function(dao,sink){var self=this;dao.select({__proto__:[].sink,eof:function(){self.root=self.index.bulkLoad(this),sink&&sink.eof&&sink.eof()}})},put:function(obj,sink){var oldValue=this.map[obj.id];oldValue?(this.root=this.index.put(this.index.remove(this.root,oldValue),obj),this.notify_("remove",[oldValue])):this.root=this.index.put(this.root,obj),this.map[obj.id]=obj,this.notify_("put",[obj]),sink&&sink.put&&sink.put(obj)},findObj_:function(key,sink){var obj=this.map[key];obj?sink.put&&sink.put(obj):sink.error&&sink.error("find",key)},find:function(key,sink){if(void 0==key)return void(sink&&sink.error&&sink.error("missing key"));if(!key.f)return void this.findObj_(key,sink);var found=!1;this.where(key).limit(1).select({put:function(obj){found=!0,sink&&sink.put&&sink.put(obj)},eof:function(){found||sink&&sink.error&&sink.error("find",key)}})},remove:function(obj,sink){if(!obj)return void(sink&&sink.error&&sink.error("missing key"));var id=void 0!==obj.id&&""!==obj.id?obj.id:obj,self=this;this.find(id,{put:function(obj){self.root=self.index.remove(self.root,obj),delete self.map[obj.id],self.notify_("remove",[obj]),sink&&sink.remove&&sink.remove(obj)},error:function(){sink&&sink.error&&sink.error("remove",obj)}})},removeAll:function(sink,options){options||(options={}),options.query||(options.query=TRUE);var future=afuture();return this.where(options.query).select()(function(a){for(var i=0;i<a.length;i++)this.root=this.index.remove(this.root,a[i]),delete this.map[a[i].id],this.notify_("remove",[a[i]]),sink&&sink.remove&&sink.remove(a[i]);sink&&sink.eof&&sink.eof(),future.set(sink)}.bind(this)),future.get},select:function(sink,options){if(sink=sink||[].sink,options&&(options={__proto__:options}),ExplainExpr.isInstance(sink)){var plan=this.index.plan(this.root,sink.arg1,options);return sink.plan="cost: "+plan.cost+", "+plan.toString(),sink&&sink.eof&&sink.eof(),aconstant(sink)}var plan=this.index.plan(this.root,sink,options),future=afuture();return plan.execute(this.root,sink,options)(function(ret){sink&&sink.eof&&sink.eof(),future.set(sink)}),future.get},toString:function(){return"MDAO("+this.model.name+","+this.index+")"}}});CLASS({name:"Timer",properties:[{model_:"IntProperty",name:"interval",help:"Interval of time between updating time.",units:"ms",defaultValue:10},{model_:"IntProperty",name:"i",defaultValue:0},{model_:"FloatProperty",name:"timeWarp",defaultValue:1},{model_:"IntProperty",name:"duration",units:"ms",defaultValue:-1},{model_:"FloatProperty",name:"percent",defaultValue:0},{model_:"IntProperty",name:"startTime",defaultValue:0},{model_:"IntProperty",name:"time",help:"The current time in milliseconds since epoch.",preSet:function(_,t){return Math.ceil(t)},defaultValue:0},{model_:"IntProperty",name:"second",help:"The second of the current minute.",defaultValue:0},{model_:"IntProperty",name:"minute",help:"The minute of the current hour.",defaultValue:0},{model_:"IntProperty",name:"hour",help:"The hour of the current day.",defaultValue:0},{name:"isStarted",defaultValue:!1,hidden:!0}],actions:[{name:"start",help:"Start the timer.",isAvailable:function(){return!0},isEnabled:function(){return!this.isStarted},action:function(){this.isStarted=!0,this.tick()}},{name:"step",help:"Step the timer.",isAvailable:function(){return!0},action:function(){this.i++,this.time+=this.interval*this.timeWarp,this.second=this.time/1e3%60<<0,this.minute=this.time/6e4%60<<0,this.hour=this.time/36e5%24<<0}},{name:"stop",help:"Stop the timer.",isAvailable:function(){return!0},isEnabled:function(){return this.isStarted},action:function(){this.isStarted=!1,this.timeout&&(clearTimeout(this.timeout),this.timeout=void 0)}}],listeners:[{name:"tick",isFramed:!0,code:function(e){if(this.timeout=void 0,this.isStarted){var prevTime=this.startTime_||0;this.startTime_=Date.now(),this.interval=Math.min(100,this.startTime_-prevTime),this.step(),this.tick()}}}]}),CLASS({name:"Binding",documentation:function(){},properties:[{name:"id",hidden:!0},{name:"value",hidden:!0},{name:"version",defaultValue:1,hidden:!0}]}),CLASS({name:"PersistentContext",documentation:function(){},properties:[{name:"dao",label:"DAO",type:"DAO",hidden:!0},{name:"context",hidden:!0},{name:"predicate",type:"Expr",defaultValueFn:function(){return TRUE},hidden:!0}],methods:{manage:function(name,obj,version){var write=EventService.merged(function(){console.log("PersistentContext","updating",name),this.dao.put(this.Y.Binding.create({id:name,value:JSONUtil.where(this.predicate).stringify(obj),version:version}))}.bind(this),void 0,this.Y);obj.addListener(write),write()},bindObjects:function(a){},clearBinding:function(ret,name){var self=this;self.dao.remove.ao(self.dao.find.bind(self.dao,name))(ret)},bindObject:function(name,factory,transientValues,version){version=version||1,console.log("PersistentContext","binding",name);var future=afuture();if(transientValues=transientValues||{},this.context[name])future.set(this.context[name]);else{var newinit=function(){console.log("PersistentContext","newInit",name);var obj=factory.create();obj.copyFrom(transientValues),this.context[name]=obj,this.manage(name,obj,version),future.set(obj)}.bind(this);this.dao.find(name,{put:function(binding){if(binding.version!==version)return console.log("PersistentContext","verison mismatch",name),void newinit();console.log("PersistentContext","existingInit",name);try{var json=JSON.parse(binding.value),obj=JSONUtil.mapToObj(this.Y,json);obj.copyFrom(transientValues),this.context[name]=obj,this.manage(name,obj,version),future.set(obj)}catch(e){console.log("PersistentContext","existingInit serialization error",name),newinit()}}.bind(this),error:newinit})}return future.get}}}),CLASS({name:"UserInfo",label:"UserInfo",properties:[{model_:"StringProperty",name:"email"}]}),CLASS({"package":"foam.apps.mbug",name:"MBug",extendsModel:"foam.ui.View",traits:["foam.ui.layout.PositionedDOMViewTrait"],requires:["com.google.analytics.AnalyticsDAO","foam.apps.mbug.ui.ChangeProjectView","foam.apps.mbug.ui.IssueCitationView","foam.apps.mbug.ui.IssueView","foam.apps.quickbug.model.DefaultQuery","foam.apps.quickbug.model.QBug","foam.core.dao.CloningDAO","foam.core.dao.KeywordDAO","foam.core.dao.SplitDAO","foam.dao.ContextualizingDAO","foam.dao.DAOVersion","foam.dao.IDBDAO","foam.graphics.ActionButtonCView","foam.input.touch.GestureManager","foam.input.touch.TouchManager","foam.metrics.Metric","foam.oauth2.AutoOAuth2","foam.oauth2.OAuth2WebClient","foam.ui.DetailView","foam.ui.layout.CSSStackView as StackView","foam.ui.md.AppController","foam.ui.md.ResponsiveAppControllerView"],exports:["daoVersionDao","metricDAO"],properties:[{model_:"Property",name:"daoVersionDao",lazyFactory:function(){return this.IDBDAO.create({model:this.DAOVersion})}},{model_:"Property",name:"autoOAuth2",factory:function(){return this.AutoOAuth2.create()}},{model_:"Property",name:"metricDAO",factory:function(){return this.AnalyticsDAO.create({propertyId:"UA-47217230-4",appName:"MBug",appVersion:"1.1.0"})}},{model_:"BooleanProperty",name:"opening",defaultValue:!1},{model_:"Property",name:"qbug",label:"QBug",subType:"foam.apps.quickbug.model.QBug",view:function(){return this.DetailView.create({model:this.QBug})},factory:function(){return this.QBug.create({authClientId:"18229540903-cojf1q6g154dk5kpim4jnck3cfdvqe3u.apps.googleusercontent.com",authClientSecret:"HkwDwjSekPBL5Oybq1NsDeZj"})}},{model_:"Property",name:"project",subType:"foam.apps.quickbug.model.QProject",postSet:function(_,project){var Y=project.Y;Y.project=project,Y.projectName=project.projectName,project.IssueNetworkDAO.batchSize=25,Y.issueDAO=this.SplitDAO.create({model:Y.QIssue,remote:project.IssueNetworkDAO,placeholderFactory:constantFn(Y.QIssue.create({status:"OPEN",id:0,summary:"Loading...",starred:!1}))},Y),Y.issueDAO=this.ContextualizingDAO.create({delegate:this.CloningDAO.create({delegate:this.KeywordDAO.create({delegate:Y.issueDAO,DefaultQuery:this.DefaultQuery},Y)},Y)},Y),this.metricDAO.put(this.Metric.create({name:"launchApp"}));var pc=this.AppController.create({name:project.projectName,model:Y.QIssue,dao:Y.issueDAO,editableCitationViews:!0,queryParser:Y.QueryParser,citationView:"foam.apps.mbug.ui.IssueCitationView",sortChoices:project.defaultSortChoices,filterChoices:project.defaultFilterChoices,menuFactory:function(){return this.X.lookup("foam.apps.mbug.ui.ChangeProjectView").create({data:project.user},this.Y)}},Y);this.stack.setTopView(this.DetailView.create({data:pc},pc.Y))}},{model_:"Property",name:"stack",subType:"foam.ui.StackView",factory:function(){return this.StackView.create()},postSet:function(old,v){old&&(Events.unfollow(this.width$,old.width$),Events.unfollow(this.height$,old.height$)),Events.follow(this.width$,v.width$),Events.follow(this.height$,v.height$)}}],methods:{init:function(){this.SUPER(),this.X.touchManager=this.TouchManager.create(),this.X.gestureManager=this.GestureManager.create(),this.Y.registerModel(this.ActionButtonCView.xbind({haloColor:"rgb(255,255,255)"}),"foam.graphics.ActionButtonCView")},toHTML:function(){return this.stack.toHTML()},projectContext:function(){return this.qbug.Y.sub({mbug:this,baseURL:this.qbug.baseURL,user:this.qbug.user,persistentContext:this.qbug.persistentContext,ProjectDAO:this.qbug.ProjectDAO,stack:this.stack,DontSyncProjectData:!0},"MBUG CONTEXT")},initHTML:function(){this.stack.initHTML();var self=this;this.qbug.userReady.get(function(user){self.qbug.findProject(user.defaultProject,{put:function(p){self.project=p}},self.projectContext())})},editIssue:function(id){this.opening||0!=id&&(this.opening=!0,this.project.Y.issueDAO.find(id,{put:function(issue){this.opening=!1;var v=this.IssueView.create({dao:this.project.Y.issueDAO,data:issue},this.project.Y);this.stack.pushView(v,"")}.bind(this),error:function(){this.opening=!1}}))},setProject:function(projectName){var self=this;this.qbug.findProject(projectName,function(project){self.project=project,self.qbug.userFuture.get(function(user){user.defaultProject=projectName})},this.projectContext()),this.stack.back()}},templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("html, body { overflow: initial; }\n\n.actionButton-enterSearchMode {\n  margin: 4px 0;\n}\n\n.issue-citation {\n  display: flex;\n  margin: 0;\n  padding: 16px 4px 10px 16px;\n}\n\n.issue-citation .priority {\n  margin-top: 16px;\n}\n\n.issue-citation .middle {\n  flex: 1;\n  margin-right: 10px;\n  overflow: hidden;\n  line-height: 20px;\n}\n\n.issue-citation .priority-0 {\n  color: #DB4437;\n}\n\n.issue-citation .priority-1 {\n  color: #F4B400;\n}\n\n.issue-citation .priority-2 {\n  color: #4285F4;\n}\n\n.issue-citation .priority-3 {\n  color: #0F9D58;\n}\n\n.issue-citation .id {\n  font-size: 1.5em;\n  font-weight: 400;\n}\n\n.issue-edit {\n  background: white;\n  display: flex;\n  flex-direction: column;\n  height: 100%;\n}\n\n.issue-edit .priority {\n  border-radius: 2px;\n  color: white;\n  font-size: 11px;\n  font-weight: 700;\n  margin: 4px 24px 4px 2px;\n  margin-right: 24px;\n  padding: 2px 2px 0 0;\n  text-align: center;\n  width: 20px;\n  height: 20px;\n}\n\n.issue-edit .priority-0 {\n   background: #DB4437;\n}\n\n.issue-edit .priority-1 {\n   background: #F4B400;\n}\n\n.issue-edit .priority-2 {\n   background: #4285F4;\n}\n\n.issue-edit .priority-3 {\n   background: #0F9D58;\n}\n\n.issue-edit span[name=id] {\n  font-weight: bold;\n}\n\n.issue-edit .popupChoiceView {\n  display: flex;\n  flex: 1 0 auto;\n  align-items: center;\n}\n\n.issue-edit .header {\n  background: #3e50b4;\n  display: block;\n  height: initial;\n  flex-shrink: 0;\n  width: 100%;\n  -webkit-transform: translate3d(0,0,10px);\n  box-shadow: 0 1px 1px rgba(0,0,0,.15), 0 1px 3px rgba(0,0,0,.15);\n}\n\n.issue-edit .body, .issue-edit .md-autocomplete-list-body {\n  flex-grow: 1;\n  overflow: hidden;\n  display: flex;\n  flex-direction: column;\n}\n\n.issue-edit .body-scroller {\n  height: 100%;\n  width: 100%;\n  overflow-y: scroll;\n  flex-grow: 1;\n}\n\n.issue-edit .title {\n  color: #fff;\n  font-size: 20px;\n  line-height: 28px;\n  margin-bottom: 8px;\n  min-height: 80px;\n  padding: 0px 16px;\n  word-wrap: break-word;\n}\n\n.issue-edit .toolbar {\n  display: flex;\n  padding: 4px;\n}\n\n.issue-edit .actionButton-cancel, .issue-edit .actionButton-back, .issue-edit .actionButton-save {\n  padding: 0;\n}\n\n.issue-edit .separator {\n  border-top: 1px solid rgba(0,0,0,.1);\n  margin-bottom: 16px;\n}\n\n.issue-edit .separator1 {\n  margin-top: 8px;\n}\n\n.issue-edit .choice {\n  font-size: 32px;\n  display: flex;\n  align-items: center;\n  padding-left: 16px;\n}\n\n.email-photo {\n  overflow: hidden;\n  width: 80px;\n  height: 80px;\n  border-radius: 50px;\n  border: 1px solid;\n}\n\n.actionButton-back {\n  width: 48px;\n  height: 48px;\n}\n\n.actionButton {\n  padding: 8px;\n  vertical-align: middle;\n  background: #3e50b4;\n  border: none;\n  -webkit-box-shadow: none;\n  box-shadown: none;\n  opacity: 0.76;\n  outline: none;\n}\n\n.actionButton:hover, .popupChoiceView:hover img, .mbug .header .popupChoiceView:hover {\n  background: #0F9D58;\n  border-radius:100px;\n}\n\n.popupChoiceView {\n  padding: 0;\n  margin-left: 0;\n  outline: none;\n  opacity: 0.76;\n  background: transparent;\n}\n\n.popupChoiceView .value {\n  align-items: center;\n  color: #222;\n  display: flex;\n  flex: 1 0 auto;\n  font-family: Roboto;\n  font-size: 16px;\n  margin-left: 0;\n  text-align: left;\n}\n\n.popupChoiceView img, .actionButton img {\n  height: 24px;\n  opacity: 0.76;\n  width: 24px;\n}\n\n.popupChoiceList {\n  box-shadow: 0 0 2px 2px rgba(0,0,0,.1), 0 0 3px 1px rgba(0,0,0,.1);\n  border: none;\n  border-radius: 2px;\n  padding: 8px 0;\n  min-width: 190px;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: -moz-none;\n  -o-user-select: none;\n  user-select: none;\n\n}\n\n.popupChoiceList li {\n  color: rgba(0, 0, 0, 0.54);\n  font-size: 16px;\n  padding: 16px;\n  margin: 0;\n  line-height: 16px;\n}\n\n.popupChoiceList li.selected {\n  color: #3e50b4;\n}\n\n.star {\n  vertical-align: middle;\n  opacity: 0.76;\n  width: 24px;\n  height: 24px;\n  margin: 12px;\n}\n\n.owner-name.placeholder {\n  color: #b2b2b2\n}\n\n.issue-edit .owner-name {\n  font-size: 16px;\n  line-height: 32px;\n  margin-left: 0;\n  flex: 1 0 auto;\n}\n\n.issue-citation span[name=id] {\n  font-size: larger;\n  color: #444;\n  font-size: 16px;\n}\n\n.issue-citation .priority {\n  font-size: larger;\n  font-size: 16px;\n  margin-left: 8px;\n}\n\n.issue-citation span[name=summary] {\n  color: #999;\n  display: block;\n  font-size: 14px;\n  height: 40px;\n  margin-top: 0;\n  overflow: hidden;\n}\n\ninput[name=q]:focus {\n  outline: none;\n  opacity: 0.76;\n}\n\ninput[name=q]::-webkit-input-placeholder {\n  font-size: 20px;\n  color: white;\n  opacity: 0.76;\n  height: 55px;\n}\n\n::-webkit-search-cancel-button {\n  -webkit-appearance: none;\n}\n\n.actionButton-leaveSearchMode {\n  margin: 4px;\n}\n\n.actionButton-leaveSearchMode img {\n  margin: 4px;\n  opacity: 0.76;\n}\n\nselect[name=sortOrder] {\n  align-self: center;\n  margin: 20px;\n}\n\n.mbug {\n  display: flex;\n  flex-direction: column;\n  height: 100%;\n}\n\n.mbug .header {\n  display: flex;\n  background: #3e50b4;\n  padding: 0;\n}\n\n.mbug .header .default {\n  flex: 1.0;\n  display: flex;\n}\n\n.mbug.searchMode .header .default {\n  display: none;\n}\n\n.mbug:not(.searchMode) .header .search {\n  display: none;\n}\n\n.mbug.searchMode .header .search {\n  display: inherit;\n  height: 56px;\n}\n\n.swipeAltOuter {\n  flex-grow: 1;\n}\n\n.stackview {\n  height: 100%;\n}\n\n.stackview table {\n  height: 100%;\n}\n\n.stackview_navbar {\n  display: none;\n}\n\n.stackview_navactions {\n  display: none;\n}\n\n.stackview-previewarea-td {\n  display: none;\n}\n\n.stackview-viewarea {\n  height: 100%;\n}\n\n.actionButton-back:hover, .actionButton-cancel:hover, .actionButton-save:hover {\n  background: #0F9D58;\n  border-radius:100px;\n}\n\n.actionButton-save:disabled, .actionButton-back:disabled, .actionButton-cancel:disabled {\n  display: none;\n}\n\n.actionButton-save {\n  border: none;\n  margin-right: 40px;\n}\n\n.status-icon {\n  height: 24px;\n  margin: 0 24px 0 0;\n  opacity: 0.54;\n  padding: 2px;\n  width: 24px;\n}\n\nselect[name=pri], select[name=status] {\n  background: white;\n  border-color: white;\n  width: 250px;\n  height: 30px;\n  margin-left: 30px;\n  margin-top: 16px;\n  outline: none;\n}\n\n.comment-view .published {\n  color: #999;\n}\n\n.comment-view {\n  display: flex;\n  margin-right: 35px;\n  margin-bottom: 25px;\n}\n\n.comment-view .content {\n  color: #444;\n  flex: 1;\n  font-size: 14px;\n  line-height: 20px;\n  overflow: hidden;\n}\n\n.actionButton-changeProject {\n  margin: 4px;\n}\n\n.mbug.searchMode .swipeAltHeader {\n  display: none;\n}\n\n.swipeAltHeader {\n  padding-left: 3px !important;\n  height: 36px;\n}\n\n.swipeAltHeader li {\n  font-size: 14px;\n  opacity: 0.8;\n  line-height: 46px;\n  padding-bottom: 14px;\n}\n\n.swipeAltHeader .selected {\n  border-bottom: 2px solid #ff3f80;\n  color: white;\n  font-weight: 500;\n  opacity: 1;\n}\n\nul.swipeAltHeader {\n  background: #3e50b4;\n  box-shadow: 0 1px 1px rgba(0,0,0,.25);\n  color: white;\n  height: 45px;\n  margin: 0;\n  overflow: hidden;\n  padding: 0 0 0 56px;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: -moz-none;\n  -o-user-select: none;\n  user-select: none;\n}\n\n.popupChoiceView, .actionButton {\n  width: 48px;\n  height: 48px;\n  background: transparent;\n}\n\n.foamChoiceListView.horizontal .choice {\n  padding: 14px 16px;\n  margin: 0;\n}\n\n.stackview-slidearea {\n   box-shadow: 1px 0px 1px 1px rgba(0,0,0,.2);\n}\n\n.issueOwnerEditView {\n  height: 100%;\n  background: #e1e1e1;\n}\n\n.issueOwnerEditView .header {\n  display: flex;\n  align-items: center;\n  border-bottom: 1px solid #d2d2d2;\n  background: #fff;\n}\n\n.issueOwnerEditView input {\n  border: none;\n  font-size: 17px;\n  flex-grow: 1;\n  margin: 0 0 0 12px;\n  padding: 0;\n}\n\n.issueOwnerEditView input:focus {\n  outline: none;\n}\n\n.issuePersonAutocompleteView {\n  background: #fafafa;\n  box-shadow: 2px 2px 1px grey;\n}\n\n.issuePersonAutocompleteView .row {\n  padding: 6px 0 6px 12px;\n}\n\n.issueOwnerEditView .header .actionButton {\n  flex-grow: 0;\n  flex-shrink: 0;\n}\n\n.comment-view {\n  margin-left: 16px;\n}\n"),out.toString()
}}]}),CLASS({"package":"com.google.analytics",name:"AnalyticsDAO",extendsModel:"foam.dao.ProxyDAO",requires:["com.google.analytics.WebMetricsReportingDAO","PersistentContext","Binding","foam.dao.IDBDAO","foam.dao.FutureDAO"],properties:[{model_:"StringProperty",name:"propertyId"},{model_:"StringProperty",name:"appName"},{model_:"StringProperty",name:"appId"},{model_:"StringProperty",name:"appVersion"},{model_:"StringProperty",name:"endpoint",defaultValue:"http://www.google-analytics.com/collect"},{model_:"Property",name:"persistentContext",factory:function(){var context={};return this.PersistentContext.create({dao:this.IDBDAO.create({model:this.Binding,name:"AnalyticsDAO-Bindings"}),predicate:NOT_TRANSIENT,context:context})}},{model_:"Property",name:"delegate",factory:function(){return this.FutureDAO.create({future:this.persistentContext.bindObject("analyticsDAO",this.WebMetricsReportingDAO,{propertyId:this.propertyId,appName:this.appName,appId:this.appId,appVersion:this.appVersion,endpoint:this.endpoint})})}}]}),CLASS({"package":"com.google.analytics",name:"WebMetricsReportingDAO",extendsModel:"com.google.analytics.AbstractMetricsReportingDAO",imports:["document"],methods:{send_:function(o,data,sink){var e=this.document.createElement("img");e.src=this.endpoint+"?"+data}}}),CLASS({"package":"com.google.analytics",name:"AbstractMetricsReportingDAO",extendsModel:"AbstractDAO",properties:[{model_:"StringProperty",name:"propertyId","transient":!0},{model_:"StringProperty",name:"clientId",factory:function(){return createGUID()}},{model_:"StringProperty",name:"appName","transient":!0},{model_:"StringProperty",name:"appId","transient":!0},{model_:"StringProperty",name:"appVersion","transient":!0},{model_:"StringProperty",name:"endpoint","transient":!0,defaultValue:"http://www.google-analytics.com/collect"}],methods:{put:function(o,sink){var data=["v=1","tid="+this.propertyId,"cid="+this.clientId];this.appName&&data.push("an="+this.appName),this.appId&&data.push("aid="+this.appId),this.appVersion&&data.push("av="+this.appVersion),"timing"===o.type?(data.push("t=timing"),data.push("utc="+encodeURIComponent(o.subType)),data.push("utv="+encodeURIComponent(o.name)),data.push("utt="+o.value)):"error"===o.type?(data.push("t=exception"),data.push("exd="+o.name)):(data.push("t=event"),data.push("ec="+encodeURIComponent(o.subType)),data.push("ea="+encodeURIComponent(o.name)),data.push("ev="+o.value)),o.interactive||data.push("ni=1"),data.push("z="+Math.floor(1e4*Math.random()).toString(10)),data=data.join("&"),this.send_(o,data,sink)}}}),CLASS({"package":"foam.dao",name:"IDBDAO",label:"IndexedDB DAO",extendsModel:"AbstractDAO",properties:[{model_:"Property",name:"model",type:"Model",required:!0},{model_:"Property",name:"name",label:"Store Name",type:"String",defaultValueFn:function(){return this.model.plural}},{model_:"BooleanProperty",name:"useSimpleSerialization",defaultValue:!0},{model_:"StringArrayProperty",name:"indicies"}],methods:{init:function(){this.SUPER(),this.useSimpleSerialization?(this.serialize=this.SimpleSerialize,this.deserialize=this.SimpleDeserialize):(this.serialize=this.FOAMSerialize,this.deserialize=this.FOAMDeserialize),this.withDB=amemo(this.openDB.bind(this))},FOAMDeserialize:function(json){return JSONToObject.visitObject(json)},FOAMSerialize:function(obj){return ObjectToJSON.visitObject(obj)},SimpleDeserialize:function(json){return this.model.create(json)},SimpleSerialize:function(obj){var s={};for(var key in obj.instance_){var prop=obj.model_.getProperty(key);prop["transient"]||(s[key]=obj.instance_[key])}return s},openDB:function(cc){var indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB,request=indexedDB.open("FOAM:"+this.name,1);request.onupgradeneeded=function(e){for(var store=e.target.result.createObjectStore(this.name),i=0;i<this.indicies.length;i++)store.createIndex(this.indicies[i][0],this.indicies[i][0],{unique:this.indicies[i][1]})}.bind(this),request.onsuccess=function(e){cc(e.target.result)}.bind(this),request.onerror=function(e){console.log("************** failure",e)}},withStore:function(mode,fn){if("readwrite"!==mode)return this.withStore_(mode,fn);var self=this;if(this.q_)this.q_.push(fn),1e4==this.q_.length&&(this.q_=void 0);else{var q=[fn];this.q_=q,EventService.async(function(){self.withStore_(mode,function(store){self.q_==q&&(self.q_=void 0);for(var i=0;i<q.length;i++)q[i](store)})},this.X)()}},withStore_:function(mode,fn){if(GLOBAL.__TXN__&&GLOBAL.__TXN__.store)try{return void fn.call(this,__TXN__.store)}catch(x){GLOBAL.__TXN__=void 0}this.withDB(function(db){var tx=db.transaction([this.name],mode),os=tx.objectStore(this.name);GLOBAL.__TXN__&&(GLOBAL.__TXN__.store=os),fn.call(this,os)}.bind(this))},put:function(value,sink){var self=this;this.withStore("readwrite",function(store){var request=store.put(self.serialize(value),value[self.model.ids[0]]);request.transaction.addEventListener("complete",function(e){self.notify_("put",[value]),sink&&sink.put&&sink.put(value)}),request.transaction.addEventListener("error",function(e){sink&&sink.error&&sink.error("put",value)})})},find:function(key,sink){if(Expr.isInstance(key)){var found=!1;return void this.limit(1).where(key).select({put:function(){found=!0,sink.put.apply(sink,arguments)},eof:function(){found||sink.error("find",key)}})}var self=this;this.withStore("readonly",function(store){var request=store.get(key);request.transaction.addEventListener("complete",function(){if(!request.result)return void(sink&&sink.error&&sink.error("find",key));var result=self.deserialize(request.result);sink&&sink.put&&sink.put(result)}),request.onerror=function(e){sink&&sink.error&&sink.error("find",key)}})},remove:function(obj,sink){var self=this,key=void 0!=obj[this.model.ids[0]]?obj[this.model.ids[0]]:obj;this.withStore("readwrite",function(store){var getRequest=store.get(key);getRequest.onsuccess=function(e){if(!getRequest.result)return void(sink&&sink.error&&sink.error("remove",obj));var data=self.deserialize(getRequest.result),delRequest=store["delete"](key);delRequest.transaction.addEventListener("complete",function(e){self.notify_("remove",[data]),sink&&sink.remove&&sink.remove(data)}),delRequest.onerror=function(e){sink&&sink.error&&sink.error("remove",e)}},getRequest.onerror=function(e){sink&&sink.error&&sink.error("remove",e)}})},removeAll:function(sink,options){var query=options&&options.query&&options.query.partialEval()||{f:function(){return!0}},future=afuture(),self=this;return options||sink&&sink.remove?(this.withStore("readwrite",function(store){var request=store.openCursor();request.onsuccess=function(e){var cursor=e.target.result;if(cursor){var value=self.deserialize(cursor.value);if(query.f(value)){var deleteReq=cursor["delete"]();deleteReq.transaction.addEventListener("complete",function(){self.notify_("remove",[value]),sink&&sink.remove&&sink.remove(value)}),deleteReq.onerror=function(e){sink&&sink.error&&sink.error("remove",e)}}cursor["continue"]()}},request.transaction.oncomplete=function(){sink&&sink.eof&&sink.eof(),future.set(sink)},request.onerror=function(e){sink&&sink.error&&sink.error("remove",e)}}),future.get):(this.withStore("readwrite",function(store){var req=store.clear();req.onsuccess=function(){future.set()},req.onerror=function(){future.set()}}),future.get)},select:function(sink,options){sink=sink||[].sink,sink=this.decorateSink_(sink,options,!1);var fc=this.createFlowControl_(),future=afuture(),self=this;return this.withStore("readonly",function(store){if(options&&options.query&&EqExpr.isInstance(options.query)&&store.indexNames.contains(options.query.arg1.name))var request=store.index(options.query.arg1.name).openCursor(IDBKeyRange.only(options.query.arg2.f()));else var request=store.openCursor();request.onsuccess=function(e){var cursor=e.target.result;if(!fc.stopped){if(fc.errorEvt)return sink.error&&sink.error(fc.errorEvt),void future.set(sink,fc.errorEvt);if(!cursor)return sink.eof&&sink.eof(),void future.set(sink);var value=self.deserialize(cursor.value);sink.put(value),cursor["continue"]()}},request.onerror=function(e){sink.error&&sink.error(e)}}),future.get},addIndex:function(prop){return this.indicies.push([prop.name,!1]),this}},listeners:[{model_:"Method",name:"updated",code:function(evt){console.log("updated: ",evt),this.publish("updated")}}]}),CLASS({"package":"foam.dao",name:"FutureDAO",extendsModel:"foam.dao.ProxyDAO",properties:[{model_:"Property",name:"delegate",factory:function(){return null},postSet:function(oldDAO,newDAO){this.daoListeners_.length&&(oldDAO&&oldDAO.unlisten(this.relay()),newDAO.listen(this.relay()))}},{model_:"Property",name:"future",required:!0},{model_:"Property",name:"model",defaultValueFn:function(){return this.delegate?this.delegate.model:""}}],methods:{init:function(){this.SUPER(),this.future(function(delegate){this.delegate=delegate}.bind(this))},put:function(value,sink){this.delegate?this.delegate.put(value,sink):this.future(this.put.bind(this,value,sink))},remove:function(query,sink){this.delegate?this.delegate.remove(query,sink):this.future(this.remove.bind(this,query,sink))},removeAll:function(){if(this.delegate)return this.delegate.removeAll.apply(this.delegate,arguments);var a=arguments,f=afuture();return this.future(function(delegate){this.removeAll.apply(this,a)(f.set)}.bind(this)),f.get},find:function(key,sink){this.delegate?this.delegate.find(key,sink):this.future(this.find.bind(this,key,sink))},select:function(sink,options){if(this.delegate)return this.delegate.select(sink,options);var a=arguments,f=afuture();return this.future(function(){this.select.apply(this,a)(f.set)}.bind(this)),f.get}}}),CLASS({"package":"foam.dao",name:"ProxyDAO",extendsModel:"AbstractDAO",requires:["foam.dao.NullDAO"],properties:[{model_:"Property",name:"delegate",type:"DAO",mode:"read-only",required:!0,hidden:!0,"transient":!0,factory:function(){return this.NullDAO.create()},postSet:function(oldDAO,newDAO){this.daoListeners_.length&&(oldDAO&&oldDAO.unlisten(this.relay()),newDAO.listen(this.relay()),this.X.lookup("foam.dao.FutureDAO")&&this.X.lookup("foam.dao.FutureDAO").isInstance(oldDAO)||this.notify_("reset",[]))}},{model_:"ModelProperty",name:"model",defaultValueFn:function(){return this.delegate.model},type:"Model"}],methods:{relay:function(){if(!this.relay_){var self=this;this.relay_={put:function(){self.notify_("put",arguments)},remove:function(){self.notify_("remove",arguments)},reset:function(){self.notify_("reset",arguments)},toString:function(){return"RELAY("+this.$UID+", "+self.model_.name+", "+self.delegate+")"}}}return this.relay_},put:function(value,sink){this.delegate.put(value,sink)},remove:function(query,sink){this.delegate.remove(query,sink)},removeAll:function(){return this.delegate.removeAll.apply(this.delegate,arguments)},find:function(key,sink){this.delegate.find(key,sink)},select:function(sink,options){return this.delegate.select(sink,options)},listen:function(sink,options){!this.daoListeners_.length&&this.delegate&&this.delegate.listen(this.relay()),this.SUPER(sink,options)},unlisten:function(sink){this.SUPER(sink),!this.daoListeners_.length&&this.delegate&&this.delegate.unlisten(this.relay())},toString:function(){return this.name_+"("+this.delegate+")"}}}),CLASS({"package":"foam.dao",name:"NullDAO",methods:{put:function(obj,sink){sink&&sink.put&&sink.put(obj)},remove:function(obj,sink){sink&&sink.remove&&sink.remove(obj)},select:function(sink){return sink&&sink.eof&&sink.eof(),aconstant(sink||[].sink)},find:function(q,sink){sink&&sink.error&&sink.error("find",q)},listen:function(){},removeAll:function(){},unlisten:function(){},pipe:function(){},where:function(){return this},limit:function(){return this},skip:function(){return this}},help:"A DAO that stores nothing and does nothing."}),CLASS({"package":"foam.apps.mbug.ui",name:"ChangeProjectView",extendsModel:"foam.ui.DetailView",traits:["foam.ui.layout.PositionedDOMViewTrait"],requires:["foam.ui.md.AppController","foam.ui.ImageView"],properties:[{model_:"Property",name:"preferredWidth",defaultValue:304},{model_:"Property",name:"className",defaultValue:"change-project-view"}],templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .change-project-view {\n        margin: 0;\n        padding: 0;\n        box-shadow: 1px 0 1px rgba(0,0,0,.1);\n        font-size: 14px;\n        font-weight: 500;\n        background: white;\n        display: flex;\n        flex-direction: column;\n        height: 100%;\n      }\n\n      .change-project-view .header {\n        width: 100%;\n        height: 172px;\n        margin-bottom: 0;\n        background-image: url('images/projectBackground.png');\n      }\n\n      .change-project-view span[name=email] {\n        color: white;\n        display: block;\n        margin-top: 40;\n        padding-left: 16px;\n        font-weight: 500;\n        font-size: 16px;\n      }\n\n      .change-project-view .projectList {\n        flex: 1;\n        overflow-y: auto;\n        padding: 8px 0;\n      }\n\n      .change-project-view .monogram-string-view {\n        width: 64px;\n        height: 64px;\n        border-radius: 32px;\n        margin: 16px;\n      }\n\n      .project-citation {\n        margin-top: 0;\n        height: 48px;\n      }\n\n      .project-citation img {\n        margin-right: 0;\n        width: 24px;\n        height: 24px;\n        margin: 12px 16px;\n        vertical-align: middle;\n      }\n\n      .project-citation .project-name {\n        color: rgba(0,0,0,.8);\n        font-size: 14px;\n        margin-left: 16px;\n        vertical-align: middle;\n      }\n\n      .project-citation .project-name.selected {\n        color: #3e50b4;\n      }\n    "),out.toString()}},{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);out('\n      <div class="header">\n        ',self.createTemplateView("email",{model_:"foam.ui.md.MonogramStringView"}),"\n        ",self.createTemplateView("email",{mode:"display-only"}),'\n        <br><br>\n      </div>\n      <div class="projectList">\n      ');var projects=this.data.preferredProjects;return-1==projects.indexOf("chromium")&&projects.push("chromium"),-1==projects.indexOf("foam-framework")&&projects.push("foam-framework"),projects.forEach(function(project){out("\n        "),-1==" chromium-os chromedriver cinc crwm chrome-os-partner ee-testers-external ".indexOf(" "+project+" ")&&out('\n        <div id="',self.on("click",function(){self.X.stack.back(),self.X.mbug.setProject(project)},self.nextID()),'" class="project-citation">\n          ',self.ImageView.create({backupImage:"images/defaultlogo.png",data:self.X.baseURL+project+"/logo"}),'\n          <span class="project-name ',self.X.projectName===project?"selected":"",'">',project,"</span>\n        </div>\n        ")}),out("\n      </div>\n    "),out.toString()}}]}),CLASS({"package":"foam.ui.md",name:"AppController",requires:["foam.graphics.ActionButtonCView","foam.ui.md.SharedStyles","foam.ui.DAOListView","foam.ui.PopupChoiceView","foam.ui.PredicatedView","foam.ui.ScrollView","foam.ui.SpinnerView","foam.ui.SwipeAltView","foam.ui.ViewChoice"],properties:[{model_:"Property",name:"model"},{model_:"Property",name:"installStyles_",hidden:!0,factory:function(){return this.SharedStyles.create()},help:"Forces the Material Design global CSS styles to be installed."},{model_:"Property",name:"name",defaultValueFn:function(){return this.model.plural}},{model_:"Property",name:"dao"},{model_:"Property",name:"sortChoices",help:"Possible sorting options for the view."},{model_:"Property",name:"citationView",defaultValueFn:function(){return this.model.name+"CitationView"}},{model_:"Property",name:"citationRenderer",defaultValueFn:function(){return this.model.name+"CitationRenderer"}},{model_:"Property",name:"sortOrder",defaultValueFn:function(){return this.sortChoices?this.sortChoices[0][0]:""}},{model_:"Property",name:"sortOrderView",lazyFactory:function(){return this.sortChoices?this.PopupChoiceView.create({iconUrl:"images/ic_sort_24dp.png",data$:this.sortOrder$,choices:this.sortChoices}):""}},{model_:"Property",name:"filterChoices"},{model_:"foam.core.types.DAOProperty",name:"filteredDAO",help:"Top-level filtered DAO. Further filtered by each canned query."},{model_:"Property",name:"queryParser",lazyFactory:function(){return QueryParserFactory(this.model)}},{model_:"BooleanProperty",name:"editableCitationViews",help:"True if you want to allow the citation views to be editable.",defaultValue:!1},{model_:"Property",name:"filteredDAOView",lazyFactory:function(){var DAOListView=this.ScrollView.xbind({model:this.model,mode:this.editableCitationViews?"read-write":"read-only",rowView:this.citationView,runway:500});if(!this.filterChoices)return DAOListView.create({dao:this.filteredDAO$Proxy});var self=this,views=this.filterChoices.map(function(filter){return self.ViewChoice.create({view:self.PredicatedView.create({predicate:("string"==typeof filter[0]?self.queryParser.parseString(filter[0]):filter[0])||TRUE,dao:self.filteredDAO$Proxy,view:DAOListView.create()}),label:filter[1]})});return this.SwipeAltView.create({views:views})}},{model_:"BooleanProperty",name:"searchMode",defaultValue:!1},{model_:"Property",name:"q",displayWidth:25,view:{factory_:"foam.ui.TextFieldView",onKeyMode:!0,placeholder:"Search"}},{model_:"FunctionProperty",name:"menuFactory"},{model_:"Property",name:"busyStatus"},{model_:"Property",name:"spinner",factory:function(){return this.busyStatus?this.SpinnerView.create({data$:this.busyStatus.busy$,color:"#fff"}):void 0}},{model_:"Property",name:"refreshAction",type:"Action"},{model_:"Property",name:"createAction",type:"Action"}],actions:[{model_:"Action",name:"menu",label:"",iconUrl:"images/ic_menu_24dp.png",action:function(){this.X.stack.slideView(this.menuFactory())}},{model_:"Action",name:"previousQuery"},{model_:"Action",name:"enterSearchMode",label:"",iconUrl:"images/ic_search_24dp.png",action:function(){this.previousQuery=this.q,this.searchMode=!0}},{model_:"Action",name:"leaveSearchMode",label:"",iconUrl:"images/ic_arrow_back_24dp.png",action:function(){this.q=this.previousQuery,this.searchMode=!1}}],methods:{init:function(){this.SUPER(),this.Y.registerModel(this.ActionButtonCView.xbind({alpha:1,width:48,height:44,iconWidth:24,iconHeight:24}),"foam.ui.ActionButton");var self=this;Events.dynamic(function(){self.sortOrder,self.q},function(){var query=(self.queryParser.parseString(self.q)||TRUE).partialEval();self.filteredDAO=self.dao.where(query).orderBy(self.sortOrder)})}},templates:[{model_:"Template",name:"toDetailHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('\n    <div id="',this.id,'"  class="mdui-app-controller">\n       <div class="header">\n         <span class="default">\n           ',self.createTemplateView("menu"),"\n           ",self.createTemplateView("name",{mode:"read-only",className:"name"}),"\n           "),this.data.refreshAction&&out(this.createActionView(this.data.refreshAction,{data:this.data})),out("\n           "),this.data.spinner&&out('\n             <span class="mdui-app-controller-spinner">\n               ',this.data.spinner,"\n             </span>\n           "),out("\n           ",self.createTemplateView("enterSearchMode",{halo:""})," ",self.data.sortOrderView,'\n         </span>\n         <span class="search">\n           ',self.createTemplateView("leaveSearchMode",{className:"backButton",halo:""})," ",self.createTemplateView("q"),"\n         </span>\n       </div>\n       ",self.data.filteredDAOView,"\n       "),this.data.createAction&&out(this.createActionView(this.data.createAction,{data:this.data,className:"createButton",color:"white",font:"30px Roboto Arial",alpha:1,width:44,height:44,radius:22,background:"#e51c23"})),out("\n    </div>\n    "),this.addInitializer(function(){if(self.filterChoices){var v=self.data.filteredDAOView;v.index$.addListener(function(){self.qView.$.placeholder="Search "+v.views[v.index].label.toLowerCase()})}self.data.searchMode$.addListener(function(){DOM.setClass(self.X.$(self.id),"searchMode",self.data.searchMode),self.data.searchMode&&self.qView.focus()},100)}),this.on("touchstart",function(){self.qView.$&&self.qView.$.blur()},this.data.filteredDAOView.id),this.on("click",function(){self.qView.focus()},this.qView.id),out("\n  "),out.toString()}},{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      body { background: white; }\n\n      .floatingView { background: white; }\n\n      .mdui-app-controller-spinner {\n        display: inline-block;\n        height: 42px;\n        width: 42px;\n        overflow: hidden;\n      }\n      .mdui-app-controller-spinner .spinner-fixed-box {\n        height: 26px;\n        width: 26px;\n      }\n      .mdui-app-controller-spinner .spinner-circle {\n        border-width: 3px;\n      }\n   "),out.toString()}}]}),CLASS({"package":"foam.graphics",name:"ActionButtonCView",extendsModel:"foam.graphics.CView",requires:["foam.ui.md.Halo","foam.input.touch.GestureTarget"],imports:["gestureManager"],properties:[{model_:"Property",name:"action",postSet:function(oldValue,action){this.bindIsAvailable()}},{model_:"Property",name:"font",type:"String",defaultValue:""},{model_:"Property",name:"data",postSet:function(){this.bindIsAvailable()}},{model_:"Property",name:"label",defaultValue:""},{model_:"Property",name:"showLabel",defaultValueFn:function(){return this.action.showLabel}},{model_:"Property",name:"iconUrl",defaultValueFn:function(){return this.action.iconUrl},postSet:function(_,v){this.image_&&(this.image_.src=v)}},{model_:"Property",name:"haloColor",defaultValue:"rgb(241, 250, 65)"},{model_:"Property",name:"halo",factory:function(){return this.Halo.create({alpha:0,r:10,color:this.haloColor})},postSet:function(old,nu){old&&this.removeChild(old),nu&&this.addChild(nu)}},{model_:"Property",name:"iconWidth",type:"int",defaultValue:0},{model_:"Property",name:"iconHeight",type:"int",defaultValue:0},{model_:"Property",name:"radius",type:"int",defaultValue:0,postSet:function(_,r){r&&(this.width=this.height=2*r)}},{model_:"Property",name:"tapGesture",hidden:!0,"transient":!0,lazyFactory:function(){return this.GestureTarget.create({containerID:this.view.id,handler:this,gesture:"tap"})}},{model_:"Property",name:"className",defaultValueFn:function(){return"actionButtonCView actionButtonCView-"+this.action.name},help:"CSS class name(s), space separated."},{model_:"Property",name:"tooltip",defaultValueFn:function(){return this.action.help}},{model_:"Property",name:"speechLabel",defaultValueFn:function(){return this.action.speechLabel}},{model_:"Property",name:"tabIndex"},{model_:"Property",name:"role"},{model_:"Property",name:"state_",defaultValue:"default"}],methods:{init:function(){this.SUPER(),this.iconUrl&&(this.image_=new Image,this.image_.onload=function(){this.iconWidth||(this.iconWidth=this.image_.width),this.iconHeight||(this.iconHeight=this.image_.height),this.view.$&&this.view.paint()}.bind(this),this.image_.src=this.iconUrl)},bindIsAvailable:function(){if(this.action&&this.data){var self=this;Events.dynamic(function(){self.action.isAvailable.call(self.data,self.action)},function(){self.action.isAvailable.call(self.data,self.action)?self.oldWidth_&&self.oldHeight_&&(self.x=self.oldX_,self.y=self.oldY_,self.width=self.oldWidth_,self.height=self.oldHeight_):(self.width||self.height)&&(self.oldX_=self.x,self.oldY_=self.y,self.oldWidth_=self.width,self.oldHeight_=self.height,self.width=0,self.height=0,self.x=0,self.y=0)})}},initCView:function(){this.halo&&(this.halo.view=this.view,this.halo.addListener(this.view.paint)),this.gestureManager&&this.gestureManager.install(this.tapGesture),this.$.addEventListener("keypress",function(e){32!=e.charCode||e.altKey||e.ctrlKey||e.shiftKey||(e.preventDefault(),e.stopPropagation(),this.tapClick())}.bind(this)),this.$.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),e.x||e.y||this.tapClick()}.bind(this))},destroy:function(isParentDestroyed){this.SUPER(isParentDestroyed),this.gestureManager&&this.gestureManager.uninstall(this.tapGesture)},erase:function(){var c=this.canvas;c.clearRect(0,0,this.width,this.height);var r=Math.min(this.width,this.height)/2;c.fillStyle=this.background,c.beginPath(),c.arc(this.width/2,this.height/2,r,0,2*Math.PI,!0),c.closePath(),c.fill()},paintSelf:function(){var c=this.canvas;this.halo&&this.halo.paint(),this.font&&(c.font=this.font),c.globalAlpha=this.alpha,c.textAlign="center",c.textBaseline="middle",c.fillStyle=this.color,this.image_&&this.image_.complete?c.drawImage(this.image_,this.x+(this.width-this.iconWidth)/2,this.y+(this.height-this.iconHeight)/2,this.iconWidth,this.iconHeight):c.fillText(this.label||this.action.labelFn.call(this.data,this.action),this.x+this.width/2,this.y+this.height/2)}},listeners:[{model_:"Method",name:"tapClick",code:function(){this.action.callIfEnabled(this.X,this.data)}}]}),CLASS({"package":"foam.ui.md",name:"Halo",extendsModel:"foam.graphics.Circle",properties:[{model_:"Property",name:"style",defaultValue:"solid",postSet:function(_,style){style!==this.RING_INNER_COLOR&&this.setColorAndBorder()}},{model_:"Property",name:"state_",defaultValue:"default"},{model_:"Property",name:"nextColor_",defaultValueFn:function(){return this.color}},{model_:"Property",name:"color",preSet:function(old,nu){return"default"!==this.state_?(this.nextColor_=nu,old):nu}},{model_:"Property",name:"easeInTime",defaultValue:200},{model_:"Property",name:"easeOutTime",defaultValue:150},{model_:"Property",name:"startAlpha",defaultValue:.8},{model_:"Property",name:"pressedAlpha",defaultValue:.4},{model_:"Property",name:"finishAlpha",defaultValue:0},{model_:"Property",name:"alpha",defaultValue:0},{model_:"Property",name:"recentering",defaultValue:!0}],methods:{setColorAndBorder:function(){if("ring"===this.style){var color=this.color;this.border=color,this.borderWidth=12,this.color=this.RING_INNER_COLOR}},initCView:function(){this.$.addEventListener("mousedown",this.onMouseDown),this.$.addEventListener("mouseup",this.onMouseUp),this.$.addEventListener("mouseleave",this.onMouseUp),this.$.addEventListener("touchstart",this.onMouseDown),this.$.addEventListener("touchend",this.onMouseUp),this.$.addEventListener("touchleave",this.onMouseUp),this.$.addEventListener("touchcancel",this.onMouseUp)},isTouchInRect:function(t,rect){return t.clientX>=rect.left&&t.clientX<=rect.right&&t.clientY>=rect.top&&t.clientY<=rect.bottom}},listeners:[{model_:"Method",name:"onMouseDown",code:function(evt){if("default"===this.state_){if(this.state_="pressing","touchstart"===evt.type){for(var rect=this.$.getBoundingClientRect(),touchFound=!1,t,i=0;i<evt.touches.length;++i)if(t=evt.touches[i],this.isTouchInRect(t,rect)){touchFound=!0;break}touchFound?(this.x=t.clientX-rect.left,this.y=t.clientY-rect.top):(console.warn("No touches",evt.touches,"in element rect",rect),this.x=rect.width/2,this.y=rect.height/2)}else this.x=evt.offsetX,this.y=evt.offsetY;this.r=2,this.alpha=this.startAlpha;var recentering=this.recentering;this.X.animate(this.easeInTime,function(){recentering?(this.x=this.parent.width/2,this.y=this.parent.height/2,this.r=Math.min(28,Math.min(this.$.clientWidth,this.parent.height)/2)):this.r=Math.max(28,Math.max(this.$.clientWidth,this.parent.height)),this.alpha=this.pressedAlpha}.bind(this),void 0,function(){"cancelled"===this.state_?(this.state_="pressed",this.onMouseUp()):this.state_="pressed"}.bind(this))()}}},{model_:"Method",name:"onMouseUp",code:function(evt){return"default"!==this.state_?"pressing"===this.state_?void(this.state_="cancelled"):void("cancelled"!==this.state_&&(this.state_="released",this.X.animate(this.easeOutTime,function(){this.alpha=this.finishAlpha}.bind(this),Movement.easeIn(.5),function(){"released"===this.state_&&(this.state_="default",this.color=this.nextColor_)}.bind(this))())):void 0}}]}),CLASS({"package":"foam.graphics",name:"Circle",extendsModel:"foam.graphics.CView",properties:[{model_:"Property",name:"border",label:"Border Color",type:"String",defaultValue:""},{model_:"Property",name:"borderWidth",type:"int",defaultValue:1},{model_:"Property",name:"r",label:"Radius",type:"int",defaultValue:20},{model_:"Property",name:"startAngle",defaultValue:0},{model_:"Property",name:"endAngle",defaultValue:6.283185307179586},{model_:"Property",name:"width",defaultValueFn:function(){return 2*this.r}},{model_:"Property",name:"height",defaultValueFn:function(){return 2*this.r}}],methods:{paintSelf:function(){var c=this.canvas;c&&(c.globalAlpha=this.alpha,this.r&&(this.color&&(c.beginPath(),c.moveTo(0,0),c.arc(0,0,this.r,-this.endAngle,-this.startAngle,!1),c.closePath(),c.fillStyle=this.color,c.fill()),this.border&&(c.lineWidth=this.borderWidth,c.beginPath(),c.arc(0,0,this.r+this.borderWidth/2-.1,-this.endAngle,-this.startAngle,!1),c.closePath(),c.strokeStyle=this.border,c.stroke())))}}}),CLASS({"package":"foam.graphics",name:"CView",label:"CView",traits:["foam.patterns.ChildTreeTrait"],requires:["foam.graphics.PositionedCViewView","foam.graphics.CViewView"],properties:[{model_:"Property",name:"view",type:"Canvas2",hidden:!0,"transient":!0,postSet:function(_,view){for(var key in this.children){var child=this.children[key];child.view=view,view&&child.addListener(view.paint)}}},{model_:"Property",name:"canvas",hidden:!0,"transient":!0,getter:function(){return this.view&&this.view.canvas}},{model_:"Property",name:"$",hidden:!0,"transient":!0,getter:function(){return this.view&&this.view.$}},{model_:"Property",name:"state",defaultValue:"initial"},{model_:"BooleanProperty",name:"suspended",defaultValue:!1},{model_:"Property",name:"className",defaultValue:"",postSet:function(){this.$&&(this.$.className=this.className)},help:"CSS class name(s), space separated. Used if adapted with a CViewView."},{model_:"FloatProperty",name:"x",defaultValue:0},{model_:"FloatProperty",name:"y",defaultValue:0},{model_:"FloatProperty",name:"a",label:"Rotation",defaultValue:0},{model_:"FloatProperty",name:"scaleX",defaultValue:1},{model_:"FloatProperty",name:"scaleY",defaultValue:1},{model_:"Property",name:"canvasX",getter:function(){return this.x+(this.parent?this.parent.canvasX:0)}},{model_:"Property",name:"canvasY",getter:function(){return this.y+(this.parent?this.parent.canvasY:0)}},{model_:"IntProperty",name:"width",defaultValue:10},{model_:"IntProperty",name:"height",defaultValue:10},{model_:"FloatProperty",name:"alpha",defaultValue:1},{model_:"Property",name:"color",label:"Foreground Color",type:"String",defaultValue:"black"},{model_:"Property",name:"background",label:"Background Color",type:"String",defaultValue:"white"},{model_:"Property",name:"font"},{model_:"BooleanProperty",name:"clipped",defaultValue:!1}],methods:{toView_:function(){if(!this.view){var params={cview:this};this.className&&(params.className=this.className),this.tooltip&&(params.tooltip=this.tooltip),this.speechLabel&&(params.speechLabel=this.speechLabel),this.tabIndex&&(params.tabIndex=this.tabIndex),this.role&&(params.role=this.role),this.data$&&(params.data$=this.data$),this.view=this.CViewView.create(params)}return this.view},toPositionedView_:function(){if(!this.view){var params={cview:this};this.className&&(params.className=this.className),this.view=this.PositionedCViewView.create(params)}return this.view},initCView:function(){},write:function(document){this.toView_().write(document)},addChild:function(child){return this.SUPER(child),this.view&&(child.view=this.view,child.addListener(this.view.paint)),this},removeChild:function(child){return this.SUPER(child),child.view=void 0,child.removeListener(this.view.paint),this},erase:function(){this.canvas.clearRect(0,0,this.width,this.height),this.canvas.fillStyle=this.background,this.canvas.fillRect(0,0,this.width,this.height)
},paintChildren:function(){for(var i=0;i<this.children.length;i++){var child=this.children[i];this.canvas.save(),this.canvas.beginPath(),child.paint(),this.canvas.restore()}},paintSelf:function(){},paint:function(){this.$&&this.width&&this.height&&("initial"===this.state&&(this.state="active",this.initCView()),this.suspended||(this.canvas.save(),this.transform(),this.clipped&&(this.canvas.rect(0,0,this.width,this.height),this.canvas.clip()),this.paintSelf(),this.paintChildren(),this.canvas.restore()))},transform:function(){this.canvas.translate(this.x,this.y),this.canvas.scale(this.scaleX,this.scaleY),this.canvas.rotate(this.a)},scale:function(s){this.scaleX=this.scaleY=s},mapToParent:function(point){return point.x+=this.x,point.y+=this.y,point},mapToCanvas:function(point){return this.mapToParent(point),this.parent&&this.parent.mapToCanvas&&this.parent.mapToCanvas(point),point}}}),CLASS({"package":"foam.graphics",name:"PositionedCViewView",extendsModel:"foam.graphics.AbstractCViewView",traits:["foam.ui.layout.PositionedDOMViewTrait"],properties:[{model_:"Property",name:"tagName",factory:function(){return"canvas"}}],methods:{init:function(){this.SUPER(),this.X.dynamic(function(){this.cview,this.width,this.height}.bind(this),function(){this.cview&&(this.cview.width=this.width,this.cview.height=this.height)}.bind(this))},toHTML:function(){var className=this.className?' class="'+this.className+'"':"";return'<canvas id="'+this.id+'"'+className+' width="'+this.canvasWidth()+'" height="'+this.canvasHeight()+'" '+this.layoutStyle()+"></canvas>"}},listeners:[{model_:"Method",name:"resize",code:function(){this.$&&(this.$.width=this.canvasWidth(),this.$.style.width=this.styleWidth(),this.$.height=this.canvasHeight(),this.$.style.height=this.styleHeight(),this.cview.width=this.width,this.cview.height=this.height,this.paint())},isFramed:!0}]}),CLASS({"package":"foam.ui.layout",name:"PositionedDOMViewTrait",traits:["foam.ui.layout.PositionedViewTrait"],properties:[{model_:"Property",name:"tagName",defaultValue:"div"}],methods:{toHTML:function(){return"<"+this.tagName+' id="'+this.id+'"'+this.layoutStyle()+this.cssClassAttr()+">"+this.toInnerHTML()+"</div>"},layoutStyle:function(){return' style="-webkit-transform:'+this.transform()+";width:"+this.styleWidth()+";height:"+this.styleHeight()+';position:absolute;"'},initHTML:function(){this.SUPER();var self=this;this.X.dynamic(function(){self.x,self.y,self.z},this.position),this.X.dynamic(function(){self.width,self.height},this.resize),this.$.style.position="absolute",this.position(),this.resize()},transform:function(){return"translate3d("+this.x+"px,"+this.y+"px,"+this.z+"px)"},styleWidth:function(){return this.width+"px"},styleHeight:function(){return this.height+"px"}},listeners:[{model_:"Method",name:"position",code:function(){this.$&&(this.$.style.webkitTransform=this.transform())}},{model_:"Method",name:"resize",code:function(){this.$&&(this.$.style.width=this.styleWidth(),this.$.style.height=this.styleHeight())}}]}),CLASS({"package":"foam.ui.layout",name:"PositionedViewTrait",properties:[{model_:"FloatProperty",name:"x",units:"px",defaultValue:0},{model_:"FloatProperty",name:"y",units:"px",defaultValue:0},{model_:"FloatProperty",name:"z",units:"px",defaultValue:0},{model_:"IntProperty",name:"width",units:"px",defaultValue:100},{model_:"IntProperty",name:"height",units:"px",defaultValue:100},{model_:"IntProperty",name:"preferredWidth",units:"px",defaultValue:100},{model_:"IntProperty",name:"preferredHeight",units:"px",defaultValue:100}]}),CLASS({"package":"foam.graphics",name:"AbstractCViewView",extendsModel:"foam.ui.View",properties:[{model_:"Property",name:"cview",type:"foam.graphics.CView",postSet:function(_,cview){cview.view=this,this.width=cview.x+cview.width,this.height=cview.y+cview.height}},{model_:"Property",name:"className",defaultValue:"",help:"CSS class name(s), space separated."},{model_:"FloatProperty",name:"scalingRatio",preSet:function(_,v){return 0>=v?1:v},defaultValue:1},{model_:"Property",name:"speechLabel"},{model_:"Property",name:"role"},{model_:"Property",name:"tabIndex"},{model_:"IntProperty",name:"width",defaultValue:100},{model_:"IntProperty",name:"height",defaultValue:100},{model_:"Property",name:"canvas",getter:function(){return this.instance_.canvas?this.instance_.canvas:this.instance_.canvas=this.$&&this.$.getContext("2d")}}],methods:{init:function(){this.SUPER(),this.X.dynamic(function(){this.scalingRatio,this.width,this.height}.bind(this),this.resize)},styleWidth:function(){return this.width+"px"},canvasWidth:function(){return this.width*this.scalingRatio},styleHeight:function(){return this.height+"px"},canvasHeight:function(){return this.height*this.scalingRatio},toString:function(){return"CViewView("+this.cview+")"},toHTML:function(){var className=this.className?' class="'+this.className+'"':"",title=this.speechLabel?' aria-role="button" aria-label="'+this.speechLabel+'"':"",tabIndex=this.tabIndex?' tabindex="'+this.tabIndex+'"':"",role=this.role?' role="'+this.role+'"':"";return'<canvas id="'+this.id+'"'+className+title+tabIndex+role+' width="'+this.canvasWidth()+'" height="'+this.canvasHeight()+'" style="width:'+this.styleWidth()+";height:"+this.styleHeight()+";min-width:"+this.styleWidth()+";min-height:"+this.styleHeight()+'"></canvas>'},initHTML:function(){if(this.$){this.maybeInitTooltip(),this.canvas=this.$.getContext("2d");var devicePixelRatio=this.X.window.devicePixelRatio||1,backingStoreRatio=this.canvas.backingStoreRatio||this.canvas.webkitBackingStorePixelRatio||1;devicePixelRatio!==backingStoreRatio&&(this.scalingRatio=devicePixelRatio/backingStoreRatio);var style=this.X.window.getComputedStyle(this.$);style.backgroundColor&&!this.cview.hasOwnProperty("background")&&(this.cview.background=style.backgroundColor),this.paint()}},destroy:function(isParentDestroyed){this.SUPER(isParentDestroyed)}},listeners:[{model_:"Method",name:"resize",code:function(){this.$&&(this.$.width=this.canvasWidth(),this.$.style.width=this.styleWidth(),this.$.style.minWidth=this.styleWidth(),this.$.height=this.canvasHeight(),this.$.style.height=this.styleHeight(),this.$.style.minHeight=this.styleHeight(),this.paint())},isFramed:!0},{model_:"Method",name:"paint",code:function(){if(!this.$)throw EventService.UNSUBSCRIBE_EXCEPTION;this.canvas.save(),this.canvas.clearRect(0,0,this.canvasWidth(),this.canvasHeight()),this.canvas.fillStyle=this.cview.background,this.canvas.fillRect(0,0,this.canvasWidth(),this.canvasHeight()),this.canvas.scale(this.scalingRatio,this.scalingRatio),this.cview.paint(),this.canvas.restore()},isFramed:!0}]}),CLASS({"package":"foam.ui",name:"View",extendsModel:"foam.ui.DestructiveDataView",traits:["foam.ui.HTMLViewTrait","foam.ui.ViewActionsTrait","foam.ui.TemplateSupportTrait"],requires:["Property"],exports:["propertyViewProperty"],properties:[{model_:"Property",name:"propertyViewProperty",type:"Property",defaultValueFn:function(){return this.Property.DETAIL_VIEW}}]}),CLASS({"package":"foam.ui",name:"HTMLViewTrait",label:"HTMLView",requires:["foam.input.touch.GestureTarget"],properties:[{model_:"Property",name:"id",label:"Element ID",type:"String",factory:function(){return this.instance_.id||this.nextID()}},{model_:"Property",name:"shortcuts",type:"Array[Shortcut]",factory:function(){return[]}},{model_:"Property",name:"$",mode:"read-only",hidden:!0,getter:function(){return this.X.document.getElementById(this.id)},setter:function(){},help:"DOM Element."},{model_:"Property",name:"tagName",defaultValue:"span"},{model_:"Property",name:"className",defaultValue:"",postSet:function(){this.$&&(this.$.className=this.cssClassAttr().slice(7,-1))},help:"CSS class name(s), space separated."},{model_:"Property",name:"tooltip"},{model_:"Property",name:"tabIndex"},{model_:"Property",name:"extraClassName",defaultValue:"",postSet:function(){this.$&&(this.$.className=this.cssClassAttr().slice(7,-1))}},{model_:"Property",name:"propertyViewProperty",type:"Property",defaultValueFn:function(){return this.X.Property.VIEW}},{model_:"Property",name:"initializers_",factory:function(){return[]}},{model_:"Property",name:"destructors_",factory:function(){return[]}}],constants:[{model_:"Constant",name:"KEYPRESS_CODES",value:{8:!0,37:!0,38:!0,39:!0,40:!0}},{model_:"Constant",name:"ON_HIDE",value:["onHide"]},{model_:"Constant",name:"ON_SHOW",value:["onShow"]}],methods:{toView_:function(){return this},strToHTML:function(str){return XMLUtil.escape(str.toString())},cssClassAttr:function(){if(!this.className&&!this.extraClassName)return"";var s=' class="';return this.className&&(s+=this.className,this.extraClassName&&(s+=" ")),this.extraClassName&&(s+=this.extraClassName),s+'"'},bindSubView:function(view,prop){view.setValue(this.propertyValue(prop.name))},focus:function(){this.$&&this.$.focus&&this.$.focus()},addChild:function(child){return child.toView_&&(child=child.toView_()),-1==this.children.indexOf(child)?this.SUPER(child):void 0},addShortcut:function(key,callback,context){this.shortcuts.push([key,callback,context])},nextID:function(){return"view"+(arguments.callee._nextId=(arguments.callee._nextId||0)+1)},addInitializer:function(f){this.initializers_.push(f)},addDestructor:function(f){this.destructors_.push(f)},tapClick:function(){},on:function(event,listener,opt_id){if(opt_id=opt_id||this.nextID(),listener=listener.bind(this),"click"===event&&this.X.gestureManager){var self=this,manager=this.X.gestureManager,target=this.GestureTarget.create({containerID:opt_id,handler:{tapClick:function(pointMap){return listener({preventDefault:function(){},stopPropagation:function(){},pointMap:pointMap})}},gesture:"tap"});return manager.install(target),this.addDestructor(function(){manager.uninstall(target)}),opt_id}return this.addInitializer(function(){var e=this.X.$(opt_id);e&&e.addEventListener(event,listener,!1)}.bind(this)),opt_id},setAttribute:function(attributeName,valueFn,opt_id){opt_id=opt_id||this.nextID(),valueFn=valueFn.bind(this),this.addInitializer(function(){this.X.dynamic(valueFn,function(){var e=this.X.$(opt_id);if(!e)throw EventService.UNSUBSCRIBE_EXCEPTION;var newValue=valueFn(e.getAttribute(attributeName));void 0==newValue?e.removeAttribute(attributeName):e.setAttribute(attributeName,newValue)}.bind(this))}.bind(this))},setClass:function(className,predicate,opt_id){return opt_id=opt_id||this.nextID(),predicate=predicate.bind(this),this.addInitializer(function(){this.X.dynamic(predicate,function(){var e=this.X.$(opt_id);if(!e)throw EventService.UNSUBSCRIBE_EXCEPTION;DOM.setClass(e,className,predicate())}.bind(this))}.bind(this)),opt_id},setClasses:function(map,opt_id){opt_id=opt_id||this.nextID();for(var keys=Objects.keys(map),i=0;i<keys.length;i++)this.setClass(keys[i],map[keys[i]],opt_id);return opt_id},insertInElement:function(name){var e=this.X.$(name);e.innerHTML=this.toHTML(),this.initHTML()},write:function(document){var html=this.toHTML();document.body.insertAdjacentHTML("beforeend",html),this.initHTML()},updateHTML:function(){this.$&&(this.destroy(),this.construct())},construct:function(){this.SUPER(),this.generateContent()},generateContent:function(){this.$&&(this.$.innerHTML=this.toInnerHTML(),this.initInnerHTML())},toInnerHTML:function(){return""},toHTML:function(){return this.invokeDestructors(),"<"+this.tagName+' id="'+this.id+'"'+this.cssClassAttr()+">"+this.toInnerHTML()+"</"+this.tagName+">"},initHTML:function(){this.initInnerHTML(),this.initKeyboardShortcuts(),this.maybeInitTooltip()},maybeInitTooltip:function(){this.tooltip&&this.$&&(this.$.addEventListener("mouseenter",this.openTooltip),this.$.addEventListener("mouseleave",this.closeTooltip))},initInnerHTML:function(){this.invokeInitializers(),this.initChildren()},initChildren:function(){if(this.children)for(var i=0;i<this.children.length;i++)try{this.children[i].initHTML()}catch(x){console.log("Error on View.child.initHTML",x,x.stack)}},invokeInitializers:function(){for(var i=0;i<this.initializers_.length;i++)this.initializers_[i]();this.initializers_=[]},invokeDestructors:function(){for(var i=0;i<this.destructors_.length;i++)this.destructors_[i]();this.destructors_=[]},evtToCharCode:function(evt){var s="";return evt.altKey&&(s+="alt-"),evt.ctrlKey&&(s+="ctrl-"),evt.shiftKey&&"keydown"===evt.type&&(s+="shift-"),evt.metaKey&&(s+="meta-"),s+=String.fromCharCode("keydown"===evt.type?evt.which:evt.charCode)},initKeyboardShortcuts:function(){function init(actions,opt_value){actions.forEach(function(action){for(var j=0;j<action.keyboardShortcuts.length;j++){var key=action.keyboardShortcuts[j];"number"==typeof key&&(key=String.fromCharCode(key)),keyMap[key]=opt_value?function(){action.callIfEnabled(self.X,opt_value.get())}:action.callIfEnabled.bind(action,self.X,self),found=!0}})}var keyMap={},found=!1,self=this;init(this.model_.actions),this.data&&this.data.model_&&this.data.model_.actions&&init(this.data.model_.actions,this.data$),found&&(console.assert(this.$,"View must define outer id when using keyboard shortcuts: "+this.name_),this.keyMap_=keyMap,this.$.parentElement.addEventListener("keydown",this.onKeyboardShortcut),this.$.parentElement.addEventListener("keypress",this.onKeyboardShortcut))},destroy:function(isParentDestroyed){this.invokeDestructors(),this.SUPER(isParentDestroyed),delete this.instance_.$},close:function(){this.$&&this.$.remove(),this.destroy(),this.publish("closed")}},listeners:[{model_:"Method",name:"openTooltip",code:function(e){console.assert(!this.tooltip_,"Tooltip already defined"),arequire("foam.ui.Tooltip")(function(Tooltip){this.tooltip_=Tooltip.create({text:this.tooltip,target:this.$},this.Y)}.bind(this))}},{model_:"Method",name:"closeTooltip",code:function(e){this.tooltip_&&(this.tooltip_.close(),this.tooltip_=null)}},{model_:"Method",name:"onKeyboardShortcut",code:function(evt){if("keydown"!==evt.type||this.KEYPRESS_CODES[evt.which]){var action=this.keyMap_[this.evtToCharCode(evt)];action&&(action(),evt.preventDefault(),evt.stopPropagation())}}}]}),CLASS({"package":"foam.input.touch",name:"GestureTarget",properties:[{model_:"Property",name:"id"},{model_:"Property",name:"gesture",help:"The name of the gesture to be tracked."},{model_:"Property",name:"containerID",help:"The containing DOM node's ID. Used for checking what inputs are within which gesture targets."},{model_:"Property",name:"getElement",defaultValue:function(){return this.X.$(this.containerID)},help:"Function to retrieve the element this gesture is attached to. Defaults to $(containerID)."},{model_:"Property",name:"handler",help:"The target for the gesture's events, after it has been recognized."}],help:"Created by each view that wants to receive gestures."}),CLASS({"package":"foam.ui",name:"ViewActionsTrait",requires:["foam.ui.ActionButton","foam.ui.ActionBorder"],properties:[{model_:"BooleanProperty",name:"showActions",postSet:function(oldValue,showActions){!oldValue&&showActions&&this.addDecorator(this.ActionBorder.create())},defaultValue:!1}],methods:{createActionView:function(action,opt_args){var X=opt_args&&opt_args.X||this.Y,modelName=opt_args&&opt_args.model_?opt_args.model_:"foam.ui.ActionButton",v=X.lookup(modelName,X).create({action:action},X).copyFrom(opt_args);return this[action.name+"View"]=v,v}}}),CLASS({"package":"foam.ui",name:"ActionButton",extendsModel:"foam.ui.BaseView",traits:["foam.ui.HTMLViewTrait"],properties:[{model_:"Property",name:"action",postSet:function(old,nu){old&&old.removeListener(this.render),nu.addListener(this.render)}},{model_:"Property",name:"data"},{model_:"Property",name:"className",factory:function(){return"actionButton actionButton-"+this.action.name}},{model_:"Property",name:"tagName",defaultValue:"button"},{model_:"Property",name:"showLabel",defaultValueFn:function(){return this.action.showLabel}},{model_:"Property",name:"label",defaultValueFn:function(){return this.data?this.action.labelFn.call(this.data,this.action):this.action.label}},{model_:"Property",name:"iconUrl",defaultValueFn:function(){return this.action.iconUrl}},{model_:"Property",name:"tooltip",defaultValueFn:function(){return this.action.help}}],methods:{toHTML:function(){var superResult=this.SUPER(),self=this;return this.on("click",function(){self.action.callIfEnabled(self.X,self.data)},this.id),this.setAttribute("disabled",function(){return self.closeTooltip(),self.action.isEnabled.call(self.data,self.action)?void 0:"disabled"},this.id),this.setClass("available",function(){return self.closeTooltip(),self.action.isAvailable.call(self.data,self.action)},this.id),this.X.dynamic(function(){self.action.labelFn.call(self.data,self.action),self.updateHTML()}),superResult},toInnerHTML:function(){var out="";return this.iconUrl&&(out+='<img src="'+XMLUtil.escapeAttr(this.iconUrl)+'">'),this.showLabel&&(out+=this.label),out},initKeyboardShortcuts:function(){}},listeners:[{model_:"Method",name:"render",code:function(){this.updateHTML()},isFramed:!0}]}),CLASS({"package":"foam.ui",name:"BaseView",extendsModel:"foam.patterns.ChildTreeTrait",properties:[{model_:"Property",name:"data"}],methods:{addDataChild:function(child){Events.link(this.data$,child.data$),this.addChild(child)},addSelfDataChild:function(child){child.data=this,this.addChild(child)}}}),CLASS({"package":"foam.patterns",name:"ChildTreeTrait",properties:[{model_:"Property",name:"parent",type:"foam.patterns.ChildTreeTrait",hidden:!0},{model_:"Property",name:"children",type:"Array[foam.patterns.ChildTreeTrait]",factory:function(){return[]}}],methods:{onAncestryChange_:function(){Array.prototype.forEach.call(this.children,function(c){c.onAncestryChange_&&c.onAncestryChange_()})},addChild:function(child){if(-1==this.children.indexOf(child)){try{child.parent=this}catch(x){console.log(x)}child.onAncestryChange_&&child.onAncestryChange_();var children=this.children;return children.push(child),this.children=children,this}},removeChild:function(child){return child.destroy(!0),this.children.deleteI(child),child.parent=void 0,this},removeAllChildren:function(isParentDestroyed){var list=this.children.slice();Array.prototype.forEach.call(list,function(child){this.removeChild(child)}.bind(this))},addChildren:function(){if(Array.isArray(arguments))Array.prototype.forEach.call(arguments,this.addChild.bind(this));else for(var key in arguments)this.addChild(arguments[key]);return this},destroy:function(isParentDestroyed){return isParentDestroyed?Array.prototype.forEach.call(this.children,function(child){child.destroy(!0)}):this.removeAllChildren(),this},construct:function(){return this},deepPublish:function(topic){var count=this.publish.apply(this,arguments);if(this.children)for(var i=0;i<this.children.length;i++){var child=this.children[i];count+=child.deepPublish.apply(child,arguments)}return count}}}),CLASS({"package":"foam.ui",name:"ActionBorder",methods:{toHTML:function(border,delegate,args){var str="";str+=delegate.apply(this,args),str+='<div class="actionToolbar">';for(var actions=this.model_.actions,i=0;i<actions.length;i++){var v=this.createActionView(actions[i]);this.addSelfDataChild(v),str+=" "+v.toView_().toHTML()+" "}if(this.X.lookup("foam.ui.DetailView").isInstance(this)){actions=this.model.actions;for(var i=0;i<actions.length;i++){var v=this.createActionView(actions[i]);this.addDataChild(v),str+=" "+v.toView_().toHTML()+" "}}return str+="</div>"}}}),CLASS({"package":"foam.ui",name:"TemplateSupportTrait",requires:["foam.ui.PropertyView","foam.ui.ActionButton","SimpleReadOnlyValue"],methods:{init:function(){this.SUPER(),arequire("foam.ui.RelationshipView")},createView:function(prop,opt_args){var X=opt_args&&opt_args.X||this.Y,v=this.PropertyView.create({prop:prop,args:opt_args},X);return this[prop.name+"View"]=v.view,v},removeChild:function(child){this.PropertyView.isInstance(child)&&child.prop&&delete this[child.prop.name+"View"],this.SUPER(child)},createRelationshipView:function(r,opt_args){var X=opt_args&&opt_args.X||this.Y;return this[r.name+"View"]=X.foam.ui.RelationshipView.create({relationship:r,args:opt_args},X),this[r.name+"View"]},createTemplateView:function(name,opt_args){var args=opt_args||{},X=this.Y,myData=this.data$;if(myData&&myData.value&&myData.value.model_){var o=myData.value.model_.getFeature(name);if(o){var v;return v=Action.isInstance(o)?this.createActionView(o,args):Relationship.isInstance(o)?this.createRelationshipView(o,args):this.createView(o,args),this.addDataChild(v),v}}var o=this.model_.getFeature(name);if(!o)throw"Unknown View Name: "+name;if(Action.isInstance(o))var v=this.createActionView(o,args);else v=Relationship.isInstance(o)?this.createRelationshipView(o,args):this.createView(o,args);return this.addSelfDataChild(v),v},dynamicTag:function(tagName,f){var id=this.nextID();return this.addInitializer(function(){this.X.dynamic(function(){var html=f(),e=this.X.$(id);e&&(e.innerHTML=html)}.bind(this))}.bind(this)),"<"+tagName+' id="'+id+'"></'+tagName+">"}}}),CLASS({"package":"foam.ui",name:"PropertyView",extendsModel:"foam.ui.BasePropertyView",traits:["foam.ui.HTMLViewTrait","foam.ui.HTMLPropertyViewTrait"]}),CLASS({"package":"foam.ui",name:"HTMLPropertyViewTrait",properties:[{model_:"Property",name:"id",label:"Element ID",type:"String",factory:function(){return this.instance_.id||this.nextID()+"PROP"}}],methods:{finishPropertyRender:function(){this.SUPER(),this.$&&(this.$.outerHTML=this.toInnerHTML(),this.initInnerHTML())},toInnerHTML:function(){return this.view?this.view.toHTML():""},toHTML:function(){return this.invokeDestructors(),this.view?this.toInnerHTML():this.SUPER()},initHTML:function(){this.view&&this.view.initHTML()}}}),CLASS({"package":"foam.ui",name:"BasePropertyView",extendsModel:"foam.ui.BaseView",requires:["foam.ui.TextFieldView"],properties:[{model_:"Property",name:"prop",type:"Property",postSet:function(old,nu){old&&this.bound_&&this.unbindData(this.data),nu&&!this.bound_&&this.bindData(this.data)}},{model_:"Property",name:"data",postSet:function(old,nu){old&&this.bound_&&this.unbindData(old),nu&&this.bindData(nu)}},{model_:"Property",name:"childData"},{model_:"Property",name:"parent",type:"foam.ui.View",postSet:function(_,p){p&&(p[this.prop.name+"View"]=this.view,this.view&&(this.view.parent=p))}},{model_:"Property",name:"innerView",help:"Override for prop.view"},{model_:"Property",name:"view",type:"foam.ui.View"},{model_:"Property",name:"args"},{model_:"BooleanProperty",name:"bound_",defaultValue:!1}],methods:{init:function(){this.SUPER(),this.construct()},fromElement:function(e){return this.view.fromElement(e),this},createViewFromProperty:function(prop,ret){var viewName=this.innerView||prop.view;if(viewName)if("string"==typeof viewName)arequire(viewName,this.X)(function(m){ret(m.create(prop,this.Y))}.bind(this));else if(viewName.model_&&"string"==typeof viewName.model_){var m=FOAM(prop.view);m.arequire()(ret)}else if(viewName.model_){var v=viewName.model_.create(viewName,this.X),vId=v.id;v.copyFrom(prop),v.id=vId,ret(v)}else if(viewName.factory_){var v=this.X.lookup(viewName.factory_).create(viewName,this.X),vId=v.id;v.copyFrom(prop),v.id=vId,ret(v)}else ret("function"==typeof viewName?viewName(prop,this):viewName.create(prop));else ret(this.TextFieldView.create(prop,this.Y))},unbindData:function(oldData){if(this.bound_&&oldData&&this.prop){var pValue=oldData.propertyValue(this.prop.name);Events.unlink(pValue,this.childData$),this.bound_=!1}},bindData:function(data){if(!this.bound_&&data&&this.prop){var pValue=data.propertyValue(this.prop.name);Events.link(pValue,this.childData$),this.bound_=!0}},toString:function(){return"PropertyView("+this.prop.name+", "+this.view+")"},destroy:function(isParentDestroyed){this.unbindData(this.data),this.SUPER(isParentDestroyed)},finishPropertyRender:function(){},construct:function(){if(this.bindData(this.data),this.args&&this.args.model_){var model=this.Y.lookup(this.args.model_);console.assert(model,"Unknown View: "+this.args.model_),this.args.model&&(this.prop.model=this.args.model);var view=model.create(this.prop,this.Y);delete this.args.model_,this.finishConstruct(view,this.finishPropertyRender.bind(this))}else view=this.createViewFromProperty(this.prop,function(v){this.finishConstruct(v,this.finishPropertyRender.bind(this))}.bind(this))},finishConstruct:function(view,ret){view.copyFrom(this.args),view.parent=this.parent,view.prop=this.prop,this.view=view,this.addDataChild(view),ret&&ret()},addDataChild:function(child){Events.link(this.childData$,child.data$),this.addChild(child)}}}),CLASS({"package":"foam.ui",name:"TextFieldView",label:"Text Field",extendsModel:"foam.ui.BaseView",traits:["foam.ui.HTMLViewTrait","foam.ui.ViewActionsTrait"],properties:[{model_:"StringProperty",name:"name",defaultValue:"field"},{model_:"IntProperty",name:"displayWidth",defaultValue:30},{model_:"IntProperty",name:"displayHeight",defaultValue:1},{model_:"StringProperty",name:"type",defaultValue:"text"},{model_:"StringProperty",name:"placeholder",defaultValue:""},{model_:"BooleanProperty",name:"onKeyMode",help:"If true, value is updated on each keystroke."},{model_:"BooleanProperty",name:"escapeHTML",help:"If true, HTML content is escaped in display mode.",defaultValue:!0},{model_:"StringProperty",name:"mode",defaultValue:"read-write",view:{factory_:"foam.ui.ChoiceView",choices:["read-only","read-write","final"]}},{model_:"BooleanProperty",name:"required"},{model_:"StringProperty",name:"pattern"},{model_:"Property",name:"domValue",hidden:!0},{model_:"Property",name:"data"},{model_:"StringProperty",name:"readWriteTagName",hidden:!0,defaultValueFn:function(){return 1===this.displayHeight?"input":"textarea"}},{model_:"BooleanProperty",name:"autocomplete",defaultValue:!0},{model_:"Property",name:"autocompleter"},{model_:"Property",name:"autocompleteView"}],constants:[{model_:"Constant",name:"ESCAPE",value:["escape"]}],methods:{toHTML:function(){return"read-write"===this.mode?this.toReadWriteHTML():this.toReadOnlyHTML()},toReadWriteHTML:function(){var str="<"+this.readWriteTagName+' id="'+this.id+'"';return str+=' type="'+this.type+'" '+this.cssClassAttr(),this.on("click",this.onClick,this.id),str+="input"===this.readWriteTagName?' size="'+this.displayWidth+'"':' rows="'+this.displayHeight+'" cols="'+this.displayWidth+'"',this.required&&(str+=" required"),this.pattern&&(str+=' pattern="'+this.pattern+'"'),str+=this.extraAttributes(),str+=' name="'+this.name+'">',str+="</"+this.readWriteTagName+">"},extraAttributes:function(){return""},toReadOnlyHTML:function(){var self=this;return this.setClass("placeholder",function(){return""===self.data},this.id),"<"+this.tagName+' id="'+this.id+'"'+this.cssClassAttr()+' name="'+this.name+'"></'+this.tagName+">"},setupAutocomplete:function(){if(this.autocomplete&&this.autocompleter){var view=this.autocompleteView=this.X.AutocompleteView.create({autocompleter:this.autocompleter,target:this});this.bindAutocompleteEvents(view)}},onAutocomplete:function(data){this.data=data},bindAutocompleteEvents:function(view){this.$.addEventListener("blur",function(){view.publish("blur")}),this.$.addEventListener("input",function(){view.autocomplete(this.textToValue(this.$.value))}.bind(this)),this.$.addEventListener("focus",function(){view.autocomplete(this.textToValue(this.$.value))}.bind(this))},initHTML:function(){this.$&&(this.SUPER(),"read-write"===this.mode?(this.placeholder&&(this.$.placeholder=this.placeholder),this.domValue=DomValue.create(this.$,this.onKeyMode?"input":"change"),Events.relate(this.data$,this.domValue,this.valueToText.bind(this),this.textToValue.bind(this),this.onKeyMode),this.onKeyMode&&this.$.addEventListener("blur",this.onBlur),this.$.addEventListener("keydown",this.onKeyDown),this.setupAutocomplete()):(this.domValue=DomValue.create(this.$,"undefined",this.escapeHTML?"textContent":"innerHTML"),Events.map(this.data$,this.domValue,this.valueToText.bind(this))))},textToValue:function(text){return text},valueToText:function(value){return"read-only"===this.mode&&""===value?this.placeholder:value},destroy:function(isParentDestroyed){this.SUPER(isParentDestroyed),Events.unlink(this.domValue,this.data$)}},listeners:[{model_:"Method",name:"onKeyDown",code:function(e){27==e.keyCode?(this.domValue.set(this.data),this.publish(this.ESCAPE)):this.publish(["keydown"],e)}},{model_:"Method",name:"onBlur",code:function(e){this.domValue.get()!==this.data&&this.domValue.set(this.data)}},{model_:"Method",name:"onClick",code:function(e){this.$&&this.$.focus()}}]}),CLASS({"package":"foam.ui",name:"DestructiveDataView",extendsModel:"foam.ui.BaseView",requires:["SimpleValue"],properties:[{model_:"Property",name:"data",preSet:function(old,nu){return this.shouldDestroy(old,nu)&&this.destroy(),nu},postSet:function(old,nu){this.shouldDestroy(old,nu)&&this.construct()}},{model_:"Property",name:"dataLinkedChildren",type:"Array[foam.patterns.ChildTreeTrait]",factory:function(){return[]}}],methods:{shouldDestroy:function(old,nu){return!0},destroy:function(isParentDestroyed){isParentDestroyed||(this.dataLinkedChildren.forEach(function(child){Events.unfollow(this.data$,child.data$)}.bind(this)),this.dataLinkedChildren=[]),this.SUPER(isParentDestroyed)},addDataChild:function(child){Events.follow(this.data$,child.data$),this.dataLinkedChildren.push(child),this.addChild(child)}}}),CLASS({"package":"foam.graphics",name:"CViewView",extendsModel:"foam.graphics.AbstractCViewView",properties:[{model_:"Property",name:"cview",postSet:function(_,cview){cview.view=this,this.X.dynamic(function(){var w=cview.x+cview.width,h=cview.y+cview.height;this.width=w?Math.max(this.width,w):0,this.height=h?Math.max(this.height,h):0}.bind(this))}}],help:"DOM wrapper for a CView, auto adjusts it size to fit the given cview."}),CLASS({"package":"foam.ui.md",name:"SharedStyles",templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n@import url(https://fonts.googleapis.com/css?family=Roboto:400,500,700);\n\nbody {\n  font-family: Roboto, 'Helvetica Neue', Helvetica, Arial;\n}\n\ntable {\n  border-spacing: 0;\n}\n\n* {\n  box-sizing: border-box;\n}\n\nbody, tbody, tr, td {\n  margin: 0;\n  padding: 0;\n}\n\nhr {\n  border-top: 1px solid rgba(0,0,0,.1);\n  border: none;\n  height: 1px;\n  margin: 0;\n  padding: 0;\n  background: rgba(0,0,0,.1);\n}\n\na {\n  text-decoration: none;\n  color: #4285f4;\n}\n\n.mdui-app-controller {\n  background: white;\n  display: flex;\n  display: -webkit-flex;\n  flex-direction: column;\n  -webkit-flex-direction: column;\n  height: 100%;\n}\n\n.mdui-app-controller .header {\n  display: flex;\n  display: -webkit-flex;\n  background: #3e50b4;\n  flex-shrink: 0;\n  -webkit-flex-shrink: 0;\n  padding: 0;\n  height: 56px;\n}\n\n.mdui-app-controller .header .default {\n  flex: 1.0;\n  -webkit-box-flex: 1.0;\n  display: flex;\n  display: -webkit-flex;\n  margin: 4px;\n  flex-grow: 1.0;\n  -webkit-flex-grow: 1.0;\n}\n\n.mdui-app-controller.searchMode .header {\n  height: 50px;\n}\n\n.mdui-app-controller.searchMode .header .default {\n  display: none;\n}\n\n.mdui-app-controller:not(.searchMode) .header .search {\n  display: none;\n}\n\n.mdui-app-controller.searchMode .header .search {\n  display: inherit;\n  height: 50px;\n  width: 100%;\n  background: #3e50b4;\n  z-index: 2;\n}\n\n.swipeAltInner {\n  overflow: hidden;\n}\n\n.mdui-app-controller.searchMode .swipeAltHeader {\n  display: none;\n}\n\n.mdui-app-controller .header .name {\n  -webkit-align-self: center;\n  -webkit-box-flex: 1.0;\n  -webkit-flex-grow: 1.0;\n  align-self: center;\n  color: white;\n  flex-grow: 1.0;\n  flex: 1.0;\n  font-size: 20px;\n  font-weight: 500;\n  margin-left: 16px;\n  overflow-x: hidden;\n  text-overflow: ellipsis;\n  vertical-align: middle;\n  white-space: nowrap;\n}\n\ninput[name=q] {\n  -webkit-align-self: center;\n  align-self: center;\n  background: #3e50b4;\n  border: none;\n  color: white;\n  font-size: 20px;\n  height: 30px;\n  margin: 13px 20px 13px 6px;\n  padding-left: 10px;\n  width: 100%;\n}\n\ninput[name=q]:focus {\n  outline: none;\n  opacity: 0.76;\n}\n\ninput[name=q]::-webkit-input-placeholder {\n  font-size: 20px;\n  color: white;\n  opacity: 0.76;\n  height: 55px;\n}\n\n.backButton {\n  margin: 3px 6px 2px 4px;\n}\n\n.header canvas {\n  background: #3e50b4\n}\n\n.body canvas {\n  background: white;\n}\n\n.popupChoiceView {\n  padding: 0;\n}\n\n.md-floating-label-container {\n  align-items: center;\n  display: flex;\n  padding: 36px 16px 8px;\n  position: relative;\n}\n\n.md-floating-label {\n  color: #999;\n  flex-grow: 1;\n  font-size: 12px;\n  font-weight: 500;\n  position: absolute;\n  top: 16px;\n  z-index: 0;\n}\n\ncanvas.createButton {\n  position: absolute;\n  bottom: 10px;\n  right: 20px;\n  z-index: 10;\n  background: rgba(0,0,0,0);\n  box-shadow: 3px 3px 3px #aaa;\n  border-radius: 30px;\n}\n"),out.toString()
}}]}),CLASS({"package":"foam.ui",name:"DAOListView",extendsModel:"foam.ui.View",traits:["foam.ui.DAODataViewTrait"],requires:["SimpleValue"],properties:[{model_:"BooleanProperty",name:"isHidden",postSet:function(_,isHidden){this.dao&&!isHidden&&this.onDAOUpdate()},defaultValue:!1},{model_:"ViewFactoryProperty",name:"rowView",defaultValue:"foam.ui.DetailView"},{model_:"Property",name:"mode",view:{factory_:"foam.ui.ChoiceView",choices:["read-only","read-write","final"]},defaultValue:"read-write"},{model_:"Property",name:"useSelection",postSet:function(old,nu){this.useSelection&&!this.X.selection$&&(this.X.selection$=this.SimpleValue.create()),this.selection$=this.X.selection$},help:"Backward compatibility for selection mode. Create a X.selection$ value in your context instead."},{model_:"Property",name:"selection",factory:function(){return this.SimpleValue.create()},help:"Backward compatibility for selection mode. Create a X.selection$ value in your context instead."},{model_:"Property",name:"scrollContainer",help:"Containing element that is responsible for scrolling."},{model_:"Property",name:"chunkSize",defaultValue:0,help:"Number of entries to load in each infinite scroll chunk."},{model_:"Property",name:"chunksLoaded",defaultValue:1,help:"The number of chunks currently loaded."},{model_:"BooleanProperty",name:"painting","transient":!0,defaultValue:!1},{model_:"BooleanProperty",name:"repaintRequired","transient":!0,defaultValue:!1}],methods:{init:function(){this.SUPER();var self=this;this.subscribe(this.ON_HIDE,function(){self.isHidden=!0}),this.subscribe(this.ON_SHOW,function(){self.isHidden=!1}),this.X.selection$&&(this.selection$=this.X.selection$)},initHTML:function(){if(this.SUPER(),this.chunkSize>0){for(var e=this.$;e&&"scroll"!==window.getComputedStyle(e).overflow;)e=e.parentElement;this.scrollContainer=e||window,this.scrollContainer.addEventListener("scroll",this.onScroll,!1)}this.isHidden||this.updateHTML()},construct:function(){if(this.dao&&this.$){if(this.painting)return void(this.repaintRequired=!0);this.painting=!0;var out=[];this.children=[],this.initializers_=[];var doneFirstItem=!1,d=this.dao;this.chunkSize&&(d=d.limit(this.chunkSize*this.chunksLoaded)),d.select({put:function(o){"read-write"===this.mode&&(o=o.model_.create(o,this.Y));var view=this.rowView({data:o,model:o.model_},this.Y);view.DAO=this.dao,"read-write"===this.mode&&o.addListener(function(){this.dao.put(o.deepClone())}.bind(this,o)),this.addChild(view),doneFirstItem?this.separatorToHTML(out):doneFirstItem=!0,this.X.selection$&&out.push('<div class="'+this.className+'-row" id="'+this.on("click",function(){this.selection=o}.bind(this))+'">'),out.push(view.toHTML()),this.X.selection$&&out.push("</div>")}.bind(this)})(function(){if(this.repaintRequired)return this.repaintRequired=!1,this.painting=!1,void this.realDAOUpdate();var e=this.$;e&&(e.innerHTML=out.join(""),this.initInnerHTML(),this.painting=!1)}.bind(this))}},fromElement:function(e){var children=e.children;1==children.length&&"rowView"===children[0].nodeName?this.SUPER(e):this.rowView=e.innerHTML},separatorToHTML:function(out){}},listeners:[{model_:"Method",name:"onDAOUpdate",code:function(){this.realDAOUpdate()}},{model_:"Method",name:"realDAOUpdate",code:function(){this.isHidden||this.updateHTML()},isFramed:!0},{model_:"Method",name:"onScroll",code:function(){var e=this.scrollContainer;this.chunkSize>0&&e.scrollTop+e.offsetHeight>=e.scrollHeight&&(this.chunksLoaded++,this.updateHTML())}}]}),CLASS({"package":"foam.ui",name:"DAODataViewTrait",exports:["dao$ as daoViewCurrentDAO$"],properties:[{model_:"Property",name:"data",preSet:function(old,nu){return this.dao!==nu&&(this.dao=nu),nu}},{model_:"foam.core.types.DAOProperty",name:"dao",label:"DAO",postSet:function(oldDAO,dao){dao?equals(this.data,dao)||(this.data=dao):this.data=""},help:"An alias for the data property.",onDAOUpdate:"onDAOUpdate"}],methods:{onDAOUpdate:function(){}}}),CLASS({"package":"foam.core.types",name:"DAOProperty",extendsModel:"Property",requires:["foam.dao.FutureDAO","foam.dao.ProxyDAO"],imports:["console"],properties:[{model_:"Property",name:"type",defaultValue:"DAO",help:"The FOAM type of this property."},{model_:"ModelProperty",name:"model",help:"The model for objects stored in the DAO."},{model_:"Property",name:"view",defaultValue:"foam.ui.DAOListView"},{model_:"Property",name:"onDAOUpdate"},{model_:"Property",name:"install",defaultValue:function(prop){defineLazyProperty(this,prop.name+"$Proxy",function(){if(this[prop.name])delegate=this[prop.name];else var future=afuture(),delegate=prop.FutureDAO.create({future:future.get});var proxy=prop.ProxyDAO.create({delegate:delegate});return this.addPropertyListener(prop.name,function(_,_,_,dao){return future?(future.set(dao),void(future=null)):void(proxy.delegate=dao)}),{get:function(){return proxy},configurable:!0}})}},{model_:"Property",name:"fromElement_",defaultValue:function(e,p,model){for(var children=e.children,i=0;i<children.length;i++)this[p.name].put(model.create(null,this.Y).fromElement(children[i],p))}},{model_:"Property",name:"fromElement",defaultValue:function(e,p){var model=e.getAttribute("model")||this[p.name]&&this[p.name].model||p.model||"";return model?void("string"==typeof model?arequire(model,this.X)(function(model){p.fromElement_.call(this,e,p,model)}.bind(this)):p.fromElement_.call(this,e,p,model)):void this.console.warn("Attempt to load DAO from element without model")}}],help:"Describes a DAO property."}),CLASS({"package":"foam.ui",name:"PopupChoiceView",extendsModel:"foam.ui.AbstractChoiceView",traits:["foam.input.touch.VerticalScrollNativeTrait"],requires:["foam.ui.ChoiceListView"],properties:[{model_:"Property",name:"linkLabel"},{model_:"Property",name:"iconUrl"},{model_:"Property",name:"tagName",defaultValue:"span"},{model_:"Property",name:"className",defaultValue:"popupChoiceView"},{model_:"BooleanProperty",name:"showValue"},{model_:"BooleanProperty",name:"opened","transient":!0},{model_:"FunctionProperty",name:"updateListener"},{model_:"Property",name:"mode",defaultValue:"read-write"},{model_:"Property",name:"scrollerID",factory:function(){return this.id+"-popup-list-scroller"}}],actions:[{model_:"Action",name:"open",labelFn:function(){return this.linkLabel},action:function(){function mouseMove(evt){if(!view.$.contains(evt.target)){var margin=50,left=view.$.offsetLeft-margin,right=view.$.offsetWidth+left+2*margin,top=view.$.offsetTop-margin,bottom=view.$.offsetHeight+top+2*margin;left<evt.pageX&&evt.pageX<right&&top<evt.pageY&&evt.pageY<bottom||remove()}}function remove(){self.opened=!1,self.X.document.removeEventListener("touchstart",removeListener),self.X.document.removeEventListener("mousemove",mouseMove),view.$&&(view.$.outerHTML="")}if(!this.opened){var self=this,view=this.ChoiceListView.create({id:this.scrollerID,className:"popupChoiceList",data:this.data,choices:this.choices,autoSetData:this.autoSetData});self.opened=!0;var pos=findViewportXY(this.$.querySelector(".action")),e=this.X.document.body.insertAdjacentHTML("beforeend",view.toHTML()),s=this.X.window.getComputedStyle(view.$),removeListener;removeListener=function(evt){view&&view.$&&view.$.contains(evt.target)||remove()},view.data$.addListener(EventService.framed(function(){self.data=view.data,remove()},this.X)),view.$.style.top=pos[1]-2+"px";var left=Math.max(0,pos[0]-toNum(s.width)+30);view.$.style.left=left+"px",view.$.style.maxHeight=Math.max(200,this.X.window.innerHeight-pos[1]-10)+"px",view.initHTML(),this.X.document.addEventListener("touchstart",removeListener),this.X.document.addEventListener("mousemove",mouseMove)}}}],methods:{toHTML:function(){return"read-only"===this.mode?'<span id="'+this.id+'" class="popupChoiceView-readonly">'+(this.choice&&this.choice[1]||"")+"</span>":this.SUPER()},toInnerHTML:function(){if("read-only"===this.mode)return this.choice&&this.choice[1]||"";var out="";if(this.showValue){var id=this.nextID();out+='<span id="'+id+'" class="value">'+(this.choice&&this.choice[1]||"")+"</span>",this.updateListener&&this.data$.removeListener(this.updateListener),this.updateListener=function(){var e=this.X.$(id);e&&(e.innerHTML=this.choice[1])}.bind(this),this.data$.addListener(this.updateListener)}out+='<span class="action">';var action=this.model_.getAction("open");action.iconUrl=this.iconUrl;var button=this.createActionView(action).toView_();return this.addSelfDataChild(button),out+=button.toHTML(),out+="</span>"}},templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .popupChoiceList {\n        border: 2px solid grey;\n        background: white;\n        display: table-footer-group;\n        overflow-y: auto;\n        position: absolute;\n        top: 20;\n        left: 50;\n        margin: 0;\n      }\n\n      .popupChoiceList li {\n        display: block;\n        margin: 15px;\n        margin-left: -20px;\n      }\n    "),out.toString()}}]}),CLASS({"package":"foam.ui",name:"ChoiceListView",extendsModel:"foam.ui.AbstractChoiceView",properties:[{model_:"Property",name:"orientation",view:{factory_:"foam.ui.ChoiceView",choices:[["horizontal","Horizontal"],["vertical","Vertical"]]},defaultValue:"horizontal",postSet:function(old,nu){this.$&&(DOM.setClass(this.$,old,!1),DOM.setClass(this.$,nu))}},{model_:"Property",name:"className",defaultValueFn:function(){return"foamChoiceListView "+this.orientation}},{model_:"Property",name:"tagName",defaultValue:"ul"},{model_:"Property",name:"innerTagName",defaultValue:"li"}],methods:{init:function(){this.SUPER(),this.index$.addListener(this.updateSelected),this.choices$.addListener(this.updateSelected)},choiceToHTML:function(id,choice){return"<"+this.innerTagName+' id="'+id+'" class="choice">'+choice[1]+"</"+this.innerTagName+">"},toInnerHTML:function(){for(var out=[],i=0;i<this.choices.length;i++){var choice=this.choices[i],id=this.nextID();this.on("click",function(index){this.choice=this.choices[index]}.bind(this,i),id),out.push(this.choiceToHTML(id,choice))}return out.join("")},initInnerHTML:function(){this.SUPER(),this.updateSelected()},scrollToSelection:function(){var e=this.$.children[this.index];if(e){for(var parent=e.parentElement;parent;){var overflow=this.X.window.getComputedStyle(parent).overflow;if("scroll"===overflow||"auto"===overflow)break;parent=parent.parentElement}parent=parent||this.X.window,e.offsetTop<parent.scrollTop?e.scrollIntoView(!0):e.offsetTop+e.offsetHeight>=parent.scrollTop+parent.offsetHeight&&e.scrollIntoView()}}},listeners:[{model_:"Method",name:"updateSelected",code:function(){if(this.$&&this.$.children)for(var i=0;i<this.$.children.length;i++){var c=this.$.children[i];DOM.setClass(c,"selected",i===this.index)}}}],templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n.foamChoiceListView {\n  list-style-type: none;\n}\n\n.foamChoiceListView .selected {\n  font-weight: bold;\n}\n\n.foamChoiceListView.vertical {\n  padding: 0;\n}\n.foamChoiceListView.vertical .choice {\n  margin: 4px;\n}\n\n.foamChoiceListView.horizontal {\n  padding: 0;\n}\n.foamChoiceListView.horizontal .choice {\n  display: inline;\n  margin: 12px;\n}"),out.toString()}}]}),CLASS({"package":"foam.ui",name:"AbstractChoiceView",extendsModel:"foam.ui.View",properties:[{model_:"BooleanProperty",name:"autoSetData",help:"If true, this.data is set when choices update and the current data is not one of the choices.",defaultValue:!0},{model_:"Property",name:"text",postSet:function(_,d){for(var i=0;i<this.choices.length;i++)if(this.choices[i][1]===d)return void(this.index!==i&&(this.index=i))},help:"The user-visible text of the current choice (ie. [value, text] -> text)."},{model_:"Property",name:"choice",getter:function(){for(var value=this.data,i=0;i<this.choices.length;i++){var choice=this.choices[i];if(value===choice[0])return choice}return void 0},setter:function(choice){var oldValue=this.choice;this.data=choice[0],this.text=choice[1],this.propertyChange("choice",oldValue,this.choice)},help:"The current choice (ie. [value, text])."},{model_:"Property",name:"choices",type:"Array[StringField]",preSet:function(_,a){if("object"==typeof a&&!Array.isArray(a)){var out=[];for(var key in a)a.hasOwnProperty(key)&&out.push([key,a[key]]);return out}a=a.clone();for(var i=0;i<a.length;i++)Array.isArray(a[i])||(a[i]=[a[i],a[i]]);return a},postSet:function(_,newValue){for(var value=this.data,i=0;i<newValue.length;i++){var choice=newValue[i];if(value===choice[0]){this.useSelection?this.index=i:this.choice=choice;break}}this.autoSetData&&i===newValue.length&&(this.useSelection?this.index=0:this.data=newValue.length?newValue[0][0]:void 0),this.updateHTML()}},{model_:"IntProperty",name:"index",preSet:function(_,i){return 0>i||0==this.choices.length?0:i>=this.choices.length?this.choices.length-1:i},postSet:function(_,i){this.useSelection||this.data!==this.choices[i][0]&&(this.data=this.choices[i][0])},help:"The index of the current choice."},{model_:"FunctionProperty",name:"objToChoice",help:"A Function which adapts an object from the DAO to a [key, value, ...] choice."},{model_:"BooleanProperty",name:"useSelection",help:"When set, data and choice do not update until an entry is firmly selected"},{model_:"foam.core.types.DAOProperty",name:"dao",onDAOUpdate:"onDAOUpdate"},{model_:"Property",name:"data",postSet:function(old,nu){for(var i=0;i<this.choices.length;i++)if(this.choices[i][0]===nu)return void(this.index!==i&&(this.text=this.choices[i][1],this.index=i));nu&&this.choices.length&&console.warn("ChoiceView data set to invalid choice: ",nu)}}],methods:{initHTML:function(){this.SUPER(),this.dao=this.dao},findChoiceIC:function(name){name=name.toLowerCase();for(var i=0;i<this.choices.length;i++)if(this.choices[i][1].toLowerCase()==name)return this.choices[i]},commit:function(){this.useSelection&&this.choices[this.index]&&(this.choice=this.choices[this.index])}},listeners:[{model_:"Method",name:"onDAOUpdate",code:function(){this.dao.select(MAP(this.objToChoice))(function(map){this.choices=map.arg2}.bind(this))},isMerged:100}]}),CLASS({"package":"foam.input.touch",name:"VerticalScrollNativeTrait",requires:["foam.input.touch.GestureTarget"],properties:[{model_:"Property",name:"scroller$",getter:function(){return this.X.$(this.scrollerID)}},{model_:"Property",name:"scrollGesture",hidden:!0,"transient":!0,lazyFactory:function(){return this.scrollerID?this.GestureTarget.create({containerID:this.scrollerID,handler:this,gesture:"verticalScrollNative"}):(console.warn("VerticalScrollNativeTrait attached to View without a scrollerID property set."),"")}}],methods:{initHTML:function(){this.SUPER(),this.X.gestureManager&&this.X.gestureManager.install(this.scrollGesture),this.onScroll&&this.scroller$.addEventListener("scroll",this.onScroll)},destroy:function(isParentDestroyed){this.SUPER(isParentDestroyed),this.X.gestureManager&&this.X.gestureManager.uninstall(this.scrollGesture),this.onScroll&&this.scroller$&&this.scroller$.removeEventListener("scroll",this.onScroll)}}}),CLASS({"package":"foam.ui",name:"PredicatedView",extendsModel:"foam.ui.View",properties:[{model_:"Property",name:"dao",help:"Payload of the view; assumed to be a DAO."},{model_:"Property",name:"predicate",defaultValueFn:function(){return TRUE},postSet:function(_,p){this.predicatedDAO=this.dao.where(p)}},{model_:"foam.core.types.DAOProperty",name:"predicatedDAO"},{model_:"Property",name:"view",required:!0,preSet:function(_,v){return"string"==typeof v&&(v=this.Y.lookup(v)),this.children=[v],v.data=v.dao=this.predicatedDAO$Proxy,v}}],methods:{init:function(){this.SUPER(),this.Y=this.Y.sub({DAO:this.predicatedDAO$Proxy})},toHTML:function(){return this.view.toHTML()},initHTML:function(){this.view.initHTML()}}}),CLASS({"package":"foam.ui",name:"ScrollView",extendsModel:"foam.ui.AbstractDAOView",traits:["foam.input.touch.VerticalScrollNativeTrait"],requires:["foam.util.busy.BusyStatus","foam.ui.SpinnerView","foam.ui.ScrollViewRow"],properties:[{model_:"Property",name:"model",defaultValueFn:function(){return this.dao.model}},{model_:"Property",name:"runway",defaultValue:800},{model_:"Property",name:"count",defaultValue:0,postSet:function(old,nu){this.scrollHeight=nu*this.rowHeight}},{model_:"Property",name:"scrollHeight",postSet:function(old,nu){this.$&&(this.container$().style.height=nu+"px")}},{model_:"Property",name:"scrollTop",defaultValue:0},{model_:"Property",name:"rowHeight",defaultValue:-1},{model_:"Property",name:"rowSizeView",hidden:!0},{model_:"Property",name:"rowView",postSet:function(_,nu){var view=this.Y.lookup(nu);view.PREFERRED_HEIGHT&&this.rowHeight<0&&(this.rowHeight=view.create({model:this.dao.model}).preferredHeight)}},{model_:"Property",name:"viewportHeight"},{model_:"Property",name:"visibleRows",factory:function(){return{}}},{model_:"Property",name:"extraRows",factory:function(){return[]}},{model_:"ArrayProperty",name:"cache",factory:function(){return[]}},{model_:"Property",name:"scrollerID",factory:function(){return this.nextID()}},{model_:"Property",name:"containerID",factory:function(){return this.nextID()}},{model_:"Property",name:"loadedTop",defaultValue:-1},{model_:"Property",name:"loadedBottom",defaultValue:-1},{model_:"Property",name:"visibleTop",defaultValue:0},{model_:"Property",name:"visibleBottom",defaultValue:0},{model_:"Property",name:"daoUpdateNumber",hidden:!0,"transient":!0,defaultValue:0},{model_:"Property",name:"mode",view:{factory_:"foam.ui.ChoiceView",choices:["read-only","read-write","final"]},defaultValue:"read-write"},{model_:"Property",name:"oldVisibleTop",defaultValue:-1},{model_:"Property",name:"oldVisibleBottom",defaultValue:-1},{model_:"Property",name:"spinnerBusyStatus",factory:function(){return this.BusyStatus.create()}},{model_:"Property",name:"busyComplete_"},{model_:"Property",name:"spinnerContainerID",factory:function(){return this.nextID()}},{model_:"Property",name:"spinner",factory:function(){return this.SpinnerView.create({data$:this.spinnerBusyStatus.busy$})}}],methods:{initHTML:function(){if(this.SUPER(),this.$.style.height||(this.$.style.height="100%"),this.addScrollListener(),this.onResize(),this.rowHeight<0){var outer=this.X.$(this.id+"-rowsize"),style=this.X.window.getComputedStyle(outer.children[0]);this.rowHeight=this.X.parseFloat(style.height),this.rowSizeView.destroy(),this.rowSizeView="",outer.outerHTML=""}this.onDAOUpdate()},container$:function(){return this.X.document.getElementById(this.containerID)},allocateVisible:function(){if(this.visibleTop!==this.oldVisibleTop||this.visibleBottom!==this.oldVisibleBottom){for(var homeless=[],foundIDs={},self=this,i=this.visibleTop;i<=this.visibleBottom;i++)this.visibleRows[i]?foundIDs[i]=!0:homeless.push(i);for(var keys=Object.keys(this.visibleRows),i=0;i<keys.length&&0!==homeless.length;i++)if(!foundIDs[keys[i]]){var h=homeless.shift(),r=self.visibleRows[keys[i]];delete self.visibleRows[keys[i]],self.visibleRows[h]=r,r.data=self.cache[h],r.y=h*self.rowHeight}if(homeless.length){for(var html=[],newViews=[],rowView=this.Y.lookup(this.rowView),i=0;i<homeless.length;i++){var h=homeless[i],x=self.cache[h];if(x)if(this.extraRows.length){var r=this.extraRows.shift();self.visibleRows[h]=r,r.data=x,r.y=h*self.rowHeight}else{var v=rowView.create({model:x.model_,data:x},this.Y),svr=self.ScrollViewRow.create({data:x,id:v.nextID()});self.visibleRows[h]=svr,html.push('<div style="width: 100%; position: absolute; height: '+self.rowHeight+'px; overflow: visible" id="'+svr.id+'">'),html.push(v.toHTML()),html.push("</div>"),newViews.push([h,svr]),svr.view=v}}html.length&&this.container$().insertAdjacentHTML("beforeend",html.join(""));for(var i=0;i<newViews.length;i++){var r=newViews[i];r[1].view.initHTML(),r[1].y=r[0]*self.rowHeight}}for(var i=0;i<this.extraRows.length;i++)this.extraRows[i].y=-1e4;this.oldVisibleTop=this.visibleTop,this.oldVisibleBottom=this.visibleBottom}},destroy:function(isParentDestroyed){this.SUPER(isParentDestroyed);for(var keys=Object.keys(this.visibleRows),i=0;i<keys.length;i++)this.visibleRows[keys[i]].destroy();for(this.visibleRows={},i=0;i<this.extraRows.length;i++)this.extraRows[i].destroy();this.extraRows=[],this.cache=[],this.loadedTop=-1,this.loadedBottom=-1,this.oldVisibleBottom=-1,this.oldVisibleTop=-1,this.removeScrollListener()},invalidate:function(){if(this.visibleRows){for(var keys=Object.keys(this.visibleRows),i=0;i<keys.length;i++)this.extraRows.push(this.visibleRows[keys[i]]);this.visibleRows={}}this.cache=[],this.loadedTop=-1,this.loadedBottom=-1,this.oldVisibleBottom=-1,this.oldVisibleTop=-1},addScrollListener:function(){this.$&&this.$.ownerDocument.defaultView.addEventListener("resize",this.onResize)},removeScrollListener:function(){this.$&&this.$.ownerDocument.defaultView.removeEventListener("resize",this.onResize)}},listeners:[{model_:"Method",name:"onResize",code:function(){this.viewportHeight=this.$.offsetHeight},isMerged:100},{model_:"Method",name:"onScroll",code:function(){this.scrollTop=this.scroller$.scrollTop,this.update()}},{model_:"Method",name:"onDAOUpdate",code:function(){this.invalidate();var oldComplete=this.busyComplete_;this.busyComplete_=this.spinnerBusyStatus.start(),oldComplete&&oldComplete(),this.dao.select(COUNT())(function(c){this.count=c.count;var s=this.scroller$;s&&(s.scrollTop=this.scrollTop),this.X.setTimeout(this.update.bind(this),0)}.bind(this))},isFramed:!0},{model_:"Method",name:"update",code:function(){if(this.$&&!(this.rowHeight<0)){var runwayCount=Math.ceil(this.runway/this.rowHeight);this.visibleIndex=Math.floor(this.scrollTop/this.rowHeight),this.visibleTop=Math.max(0,this.visibleIndex-runwayCount),this.visibleBottom=Math.min(this.count-1,this.visibleIndex+Math.ceil((this.runway+this.viewportHeight)/this.rowHeight));var maxVisible=Math.ceil((2*this.runway+this.viewportHeight)/this.rowHeight);this.visibleBottom-this.visibleTop+1<maxVisible&&(0===this.visibleTop?this.visibleBottom=Math.min(maxVisible-1,this.count-1):this.visibleTop=Math.max(0,this.visibleBottom-maxVisible+1));var toLoadTop,toLoadBottom;if(this.visibleTop>=this.loadedTop&&this.visibleBottom<=this.loadedBottom||(this.visibleTop<this.loadedTop&&this.visibleBottom>=this.loadedTop?(toLoadBottom=this.loadedTop-1,toLoadTop=Math.max(0,this.visibleTop-2*runwayCount)):this.visibleBottom>this.loadedBottom&&this.visibleTop<=this.loadedBottom?(toLoadTop=this.loadedBottom+1,toLoadBottom=Math.min(this.count-1,this.visibleBottom+2*runwayCount)):(this.invalidate(),toLoadTop=Math.max(0,this.visibleTop-2*runwayCount),toLoadBottom=Math.min(this.count,this.visibleBottom+2*runwayCount))),toLoadTop>=0&&toLoadBottom>=0&&toLoadBottom>=toLoadTop){var self=this,updateNumber=++this.daoUpdateNumber;this.dao.skip(toLoadTop).limit(toLoadBottom-toLoadTop+1).select()(function(a){if(updateNumber===self.daoUpdateNumber&&a&&a.length){self.busyComplete_();for(var i=0;i<a.length;i++){var o=a[i];"read-write"===self.mode&&(o=a[i].clone(),o.addListener(function(x){this.dao.put(x.deepClone())}.bind(self,o))),self.cache[toLoadTop+i]=o}self.loadedTop=self.loadedTop>=0?Math.min(toLoadTop,self.loadedTop):toLoadTop,self.loadedBottom=Math.max(toLoadBottom,self.loadedBottom),self.allocateVisible()}})}else this.allocateVisible(),this.busyComplete_()}}}],templates:[{model_:"Template",name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      "),this.destroy(),out('\n      <div id="',self.id,'" style="overflow:hidden;position:relative">\n        '),this.rowHeight<0&&(out('\n          <div id="',this.id+"-rowsize",'" style="visibility: hidden">\n            '),this.rowSizeView=this.Y.lookup(this.rowView).create({data:this.dao.model.create()},this.Y),out(this.rowSizeView.toHTML()),this.addChild(this.rowSizeView),out("\n          </div>\n        ")),out('\n        <div id="',self.spinnerContainerID,'" style="display: none; width: 100%; height: 100%">\n          ',this.spinner,"\n        </div>\n        "),this.addInitializer(function(){self.spinnerBusyStatus.busy$.addListener(function(){var e=this.X.$(self.spinnerContainerID);e&&(e.style.display=self.spinnerBusyStatus.busy?"block":"none")})}),out('\n        <div id="',self.scrollerID,'" style="-webkit-overflow-scrolling: touch; overflow-y: scroll; width:100%; height: 100%;">\n          <div id="',self.containerID,'" style="position:relative;width:100%;height:100%; -webkit-transform: translate3d(0px, 0px, 0px);">\n          </div>\n        </div>\n      </div>\n    '),out.toString()}}]}),CLASS({"package":"foam.util.busy",name:"BusyStatus",imports:["clearTimeout","setTimeout"],properties:[{model_:"Property",name:"busy",defaultValue:!1},{model_:"Property",name:"minPreSpinnerWait",units:"ms",defaultValue:500},{model_:"Property",name:"minSpinnerShowTime",units:"ms",defaultValue:500},{model_:"Property",name:"waiting_",hidden:!0,getter:function(){return Object.keys(this.processes_).length>0}},{model_:"Property",name:"processes_",factory:function(){return{}}},{model_:"Property",name:"nextProcessId_",defaultValue:0},{model_:"Property",name:"timer_"}],methods:{start:function(){var alreadyWaiting=this.waiting_,pid=this.nextProcessId_++;this.processes_[pid]=!0;var completeFunc=this.done_.bind(this,pid);return alreadyWaiting?completeFunc:(this.timer_&&this.clearTimeout(this.timer_),this.timer_=this.setTimeout(this.onTimer,this.minPreSpinnerWait),completeFunc)},done_:function(pid){this.processes_[pid]&&(delete this.processes_[pid],this.waiting_||(this.timer_&&!this.busy?(this.clearTimeout(this.timer_),this.timer_=""):this.busy&&(this.busy=!1)))}},listeners:[{model_:"Method",name:"onTimer",code:function(){var waiting=this.waiting_;this.timer_="",this.busy&&!waiting?this.busy=!1:!this.busy&&waiting&&(this.busy=!0)}}]}),CLASS({"package":"foam.ui",name:"SpinnerView",extendsModel:"foam.ui.View",properties:[{model_:"Property",name:"data",defaultValue:!0,postSet:function(old,nu){this.$&&(nu?!old&&nu&&(this.$.innerHTML=this.toInnerHTML(),this.initInnerHTML()):this.$.innerHTML="")}},{model_:"Property",name:"color",defaultValue:"#4285F4"},{model_:"Property",name:"extraClassName",defaultValue:"spinner-container"}],constants:[{model_:"Constant",name:"DURATION",value:"1333"}],methods:{initHTML:function(){this.SUPER(),this.data=this.data}},templates:[{model_:"Template",name:"CSS",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);out("\n      ");var prefixes=["-webkit-","-moz-",""];out("\n      ");var bezier="cubic-bezier(0.4, 0.0, 0.2, 1)";out("\n      .spinner-container {\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        height: 100%;\n        width: 100%;\n      }\n      .spinner-fixed-box {\n        position: relative;\n        height: 64px;\n        width: 64px;\n        ");for(var i=0;i<prefixes.length;i++)out("\n          ",prefixes[i],"transform: translate3d(0px, 0px, 0px);\n        ");out("\n      }\n\n      .spinner-turning-box {\n        ");for(var i=0;i<prefixes.length;i++)out("\n          ",prefixes[i],"animation: container-rotate 1568ms linear infinite;\n        ");out("\n        width: 100%;\n        height: 100%;\n      }\n\n      .spinner-layer {\n        position: absolute;\n        height: 100%;\n        width: 100%;\n        ");for(var j=0;j<prefixes.length;j++)out("\n          ",prefixes[j],"animation: fill-unfill-rotate ",4*this.DURATION,"ms ",bezier," infinite both;\n        ");out("\n      }\n\n      .spinner-circle-clipper {\n        overflow: hidden;\n        border-color: inherit;\n        display: inline-block;\n        height: 100%;\n        position: relative;\n        width: 50%;\n      }\n\n      .spinner-circle-clipper.spinner-clipper-left .spinner-circle {\n        ");for(var i=0;i<prefixes.length;i++)out("\n          ",prefixes[i],"animation: left-spin ",this.DURATION,"ms ",bezier," infinite;\n          ",prefixes[i],"transform: rotate(129deg);\n        ");out("\n        border-right-color: transparent !important;\n      }\n\n      .spinner-circle-clipper.spinner-clipper-right .spinner-circle {\n        ");for(var i=0;i<prefixes.length;i++)out("\n          ",prefixes[i],"animation: right-spin ",this.DURATION,"ms ",bezier," infinite;\n          ",prefixes[i],"transform: rotate(-129deg);\n        ");out("\n        border-left-color: transparent !important;\n        left: -100%\n      }\n\n      .spinner-circle-clipper .spinner-circle {\n        width: 200%;\n      }\n\n      .spinner-circle {\n        position: absolute;\n        top: 0;\n        bottom: 0;\n        left: 0;\n        right: 0;\n        box-sizing: border-box;\n        height: 100%;\n        border-width: 4px;\n        border-style: solid;\n        border-color: inherit;\n        border-bottom-color: transparent !important;\n        border-radius: 50%;\n        ");for(var i=0;i<prefixes.length;i++)out("\n          ",prefixes[i],"animation: none;\n        ");out("\n      }\n\n      .spinner-gap-patch {\n        position: absolute;\n        box-sizing: border-box;\n        top: 0;\n        left: 45%;\n        width: 10%;\n        height: 100%;\n        overflow: hidden;\n        border-color: inherit;\n      }\n\n      .spinner-gap-patch .spinner-circle {\n        width: 1000%;\n        left: -450%;\n      }\n\n      ");for(var i=0;i<prefixes.length;i++)out("\n        @",prefixes[i],"keyframes fill-unfill-rotate {\n          12.5% { ",prefixes[i],"transform: rotate(135deg); }\n          25%   { ",prefixes[i],"transform: rotate(270deg); }\n          37.5% { ",prefixes[i],"transform: rotate(405deg); }\n          50%   { ",prefixes[i],"transform: rotate(540deg); }\n          62.5% { ",prefixes[i],"transform: rotate(675deg); }\n          75%   { ",prefixes[i],"transform: rotate(810deg); }\n          87.5% { ",prefixes[i],"transform: rotate(945deg); }\n          to    { ",prefixes[i],"transform: rotate(1080deg); }\n        }\n\n        @",prefixes[i],"keyframes left-spin {\n          from { ",prefixes[i],"transform: rotate(130deg); }\n          50%  { ",prefixes[i],"transform: rotate(-5deg); }\n          to   { ",prefixes[i],"transform: rotate(130deg); }\n        }\n\n        @",prefixes[i],"keyframes right-spin {\n          from { ",prefixes[i],"transform: rotate(-130deg); }\n          50%  { ",prefixes[i],"transform: rotate(5deg); }\n          to   { ",prefixes[i],"transform: rotate(-130deg); }\n        }\n\n        @",prefixes[i],"keyframes container-rotate {\n          to { ",prefixes[i],"transform: rotate(360deg);\n        }\n      ");return out("\n    "),out.toString()}},{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('\n      <div class="spinner-fixed-box">\n        <div class="spinner-turning-box">\n          <div class="spinner-layer" style="border-color: ',this.color,'">\n            <div class="spinner-circle-clipper spinner-clipper-left"><div class="spinner-circle"></div></div><div class="spinner-gap-patch"><div class="spinner-circle"></div></div><div class="spinner-circle-clipper spinner-clipper-right"><div class="spinner-circle"></div></div>\n          </div>\n        </div>\n      </div>\n    '),out.toString()}}]}),CLASS({"package":"foam.ui",name:"ScrollViewRow",requires:["foam.ui.DetailView"],properties:[{model_:"Property",name:"data",postSet:function(old,nu){if(this.view&&(this.view.data=nu,!this.DetailView.isInstance(this.view))){var e=this.X.$(this.id);e.innerHTML=this.view.toHTML(),this.view.initHTML()}}},{model_:"Property",name:"view",postSet:function(old,nu){nu&&(nu.data=this.data)}},{model_:"Property",name:"id"},{model_:"Property",name:"y",postSet:function(old,nu){this.view&&this.id&&old!==nu&&(this.X.$(this.id).style.webkitTransform="translate3d(0px,"+nu+"px, 0px)")}}],methods:{destroy:function(isParentDestroyed){this.view.destroy(isParentDestroyed)
}}}),CLASS({"package":"foam.ui",name:"DetailView",extendsModel:"foam.ui.View",requires:["Property","foam.ui.TextFieldView","foam.ui.IntFieldView","foam.ui.FloatFieldView","foam.ui.DAOController"],exports:["propertyViewProperty"],properties:[{model_:"Property",name:"className",defaultValue:"detailView"},{model_:"Property",name:"data",preSet:function(old,nu){return nu.model_&&(this.model=nu.model_),nu}},{model_:"Property",name:"model",type:"Model"},{model_:"Property",name:"title",defaultValueFn:function(){return"Edit "+this.model.label}},{model_:"StringProperty",name:"mode",defaultValue:"read-write"},{model_:"BooleanProperty",name:"showRelationships",defaultValue:!1},{model_:"Property",name:"propertyViewProperty",type:"Property",defaultValueFn:function(){return this.Property.DETAIL_VIEW}}],methods:{shouldDestroy:function(old,nu){return old&&old.model_&&nu&&nu.model_?old.model_!==nu.model_:!0},generateContent:function(){this.$&&(this.$.outerHTML=this.toHTML(),this.initHTML())},titleHTML:function(){var title=this.title;return title?'<tr><th colspan=2 class="heading">'+title+"</th></tr>":""},startForm:function(){return"<table>"},endForm:function(){return"</table>"},startColumns:function(){return"<tr><td colspan=2><table valign=top><tr><td valign=top><table>"},nextColumn:function(){return"</table></td><td valign=top><table valign=top>"},endColumns:function(){return"</table></td></tr></table></td></tr>"},rowToHTML:function(prop,view){var str="";return prop.detailViewPreRow&&(str+=prop.detailViewPreRow(this)),str+='<tr class="detail-'+prop.name+'">',this.DAOController.isInstance(view)?(str+="<td colspan=2><div class=detailArrayLabel>"+prop.label+"</div>",str+=view.toHTML(),str+="</td>"):(str+="<td class='label'>"+prop.label+"</td>",str+="<td>",str+=view.toHTML(),str+="</td>"),str+="</tr>",prop.detailViewPostRow&&(str+=prop.detailViewPostRow(this)),str},toHTML:function(){if(!this.data)return'<span id="'+this.id+'"></span>';if(!this.model)throw"DetailView: either 'data' or 'model' must be specified.";return(this.model.getPrototype().toDetailHTML||this.defaultToHTML).call(this)},defaultToHTML:function(){this.children=[];var model=this.model,str="";str+='<div id="'+this.id+'" '+this.cssClassAttr()+'" name="form">',str+=this.startForm(),str+=this.titleHTML();for(var i=0;i<model.properties_.length;i++){var prop=model.properties_[i];if(!prop.hidden){var view=this.createView(prop);this.addDataChild(view),str+=this.rowToHTML(prop,view)}}if(str+=this.endForm(),this.showRelationships){var view=this.X.lookup("foam.ui.RelationshipsView").create({data:this.data});this.addDataChild(view),str+=view.toHTML()}return str+="</div>"}},templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n          .detailView {\n            border: solid 2px #dddddd;\n            background: #fafafa;\n            width: 99%;\n          }\n\n          .detailView .heading {\n            float: left;\n            font-size: 14px;\n            font-weight: bold;\n            margin-bottom: 8px;\n          }\n\n          .detailView .propertyLabel {\n            font-size: 14px;\n            display: block;\n            font-weight: bold;\n            text-align: right;\n            float: left;\n          }\n\n          .detailView input {\n            font-size: 12px;\n            padding: 4px 2px;\n            border: solid 1px #aacfe4;\n            margin: 2px 0 0px 10px;\n          }\n\n          .detailView textarea {\n            float: left;\n            font-size: 12px;\n            padding: 4px 2px;\n            border: solid 1px #aacfe4;\n            margin: 2px 0 0px 10px;\n            width: 98%;\n            overflow: auto;\n          }\n\n          .detailView select {\n            font-size: 12px;\n            padding: 4px 2px;\n            border: solid 1px #aacfe4;\n            margin: 2px 0 0px 10px;\n          }\n\n          .detailView .label {\n            vertical-align: top;\n          }\n\n          .detailArrayLabel {\n            font-size: medium;\n          }\n\n          .detailArrayLabel .foamTable {\n            margin: 1px;\n            width: 99%;\n          }\n      "),out.toString()}}]}),CLASS({"package":"foam.ui",name:"IntFieldView",extendsModel:"foam.ui.AbstractNumberFieldView",methods:{textToValue:function(text){return parseInt(text)||"0"},valueToText:function(value){return value?value:"0"}}}),CLASS({"package":"foam.ui",name:"AbstractNumberFieldView",extendsModel:"foam.ui.TextFieldView",properties:[{model_:"Property",name:"type",defaultValue:"number"},{model_:"Property",name:"step"}],methods:{extraAttributes:function(){return this.step?' step="'+this.step+'"':""}}}),CLASS({"package":"foam.ui",name:"FloatFieldView",extendsModel:"foam.ui.AbstractNumberFieldView",properties:[{model_:"Property",name:"precision",defaultValue:""}],methods:{formatNumber:function(val){if(!val)return"0";val=val.toFixed(this.precision);for(var i=val.length-1;i>0&&"0"===val.charAt(i);i--);return val.substring(0,"."===val.charAt(i)?i:i+1)},valueToText:function(val){return this.hasOwnProperty("precision")?this.formatNumber(val):""+val},textToValue:function(text){return parseFloat(text)||0}}}),CLASS({"package":"foam.ui",name:"DAOController",label:"DAO Controller",extendsModel:"foam.ui.View",requires:["SearchBorder"],properties:[{model_:"ModelProperty",name:"model"},{model_:"Property",name:"subType",setter:function(v){this.model=v}},{model_:"Property",name:"dao",view:"foam.ui.TableView"},{model_:"Property",name:"data",getter:function(){return this.dao},setter:function(v){this.dao=v}},{model_:"Property",name:"selection"},{model_:"BooleanProperty",name:"useSearchView",postSet:function(_,value){value&&this.addDecorator(this.SearchBorder.create({model:this.model,data:this.data}))},defaultValue:!1}],actions:[{model_:"Action",name:"new",help:"Create a new record.",action:function(){var createView=this.X.DAOCreateController.create({model:this.model,dao:this.dao,showActions:!0});createView.parentController=this,this.X.stack.pushView(createView,"New")}},{model_:"Action",name:"edit",help:"Edit the current record.","default":"true",action:function(){this.selection=this.daoView.selection;for(var obj=this.selection,actions=this.X.DAOUpdateController.actions.slice(0),i=0;i<this.model.actions.length;i++){var action=this.model.actions[i],newAction=this.X.Action.create(action);newAction.action=function(oldAction){return function(){oldAction.call(obj)}}(action.action),actions.push(newAction)}console.log(["selection: ",this.selection]);var updateView=this.X.DAOUpdateController.create({data:this.selection,model:this.model,dao:this.dao,showActions:!0});this.X.stack.pushView(updateView,"Edit")}},{model_:"Action",name:"delete",help:"Delete the current record.",action:function(){this.selection=this.daoView.selection;var self=this;this.dao.remove(this.selection)}}],methods:{init:function(){this.SUPER(),this.showActions=!0},initHTML:function(){this.SUPER(),this.daoView.subscribe(this.daoView.DOUBLE_CLICK,this.onDoubleClick),this.daoView.selection$.addListener(this.onSelection)}},listeners:[{model_:"Method",name:"onDoubleClick",code:function(evt){for(var i=0;i<this.model_.actions.length;i++){var action=this.model_.actions[i];if(action["default"]){action.action.call(this);break}}}},{model_:"Method",name:"onSelection",code:function(evt){var obj=this.daoView.selection;obj&&this.X.stack.setPreview(this.X.SummaryView.create({model:this.model,data:this.daoView.selection}))}}],templates:[{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out(" ",self.createTemplateView("dao",{model:this.model})," "),out.toString()}}]}),CLASS({"package":"foam.ui",name:"AbstractDAOView",extendsModel:"foam.ui.View",exports:["dao$ as daoViewCurrentDAO$"],properties:[{model_:"Property",name:"data",postSet:function(oldDAO,dao){this.dao!==dao&&(this.dao=dao)}},{model_:"foam.core.types.DAOProperty",name:"dao",label:"DAO",postSet:function(oldDAO,dao){dao?this.data!==dao&&(this.data=dao):this.data=""},help:"An alias for the data property.",onDAOUpdate:"onDAOUpdate"}],methods:{onDAOUpdate:function(){}}}),CLASS({"package":"foam.ui",name:"SwipeAltView",extendsModel:"foam.ui.View",requires:["foam.input.touch.GestureTarget","foam.ui.ChoiceListView"],properties:[{model_:"Property",name:"views",type:"Array",subType:"foam.ui.ViewChoice",view:"foam.ui.ArrayView",factory:function(){return[]},help:"View Choices"},{model_:"Property",name:"index",hidden:!0,defaultValue:0,preSet:function(old,nu){return 0>nu?0:nu>=this.views.length?this.views.length-1:nu},postSet:function(oldValue,viewChoice){this.views[oldValue].view().deepPublish(this.ON_HIDE),this.snapToCurrent(Math.abs(oldValue-viewChoice))},help:"The index of the currently selected view"},{model_:"Property",name:"headerView",factory:function(){return this.ChoiceListView.create({choices:this.views.map(function(x){return x.label}),index$:this.index$,className:"swipeAltHeader foamChoiceListView horizontal"},this.Y)},help:"Optional View to be displayed in header."},{model_:"Property",name:"slider",hidden:!0,help:"Internal element which gets translated around"},{model_:"Property",name:"width",hidden:!0,getter:function(){return this.$.clientWidth},help:"Set when we know the width"},{model_:"Property",name:"x",hidden:!0,postSet:function(old,nu){this.slider.style["-webkit-transform"]="translate3d(-"+nu+"px, 0, 0)"},help:"X coordinate of the translation"},{model_:"Property",name:"swipeGesture",hidden:!0,"transient":!0,factory:function(){return this.GestureTarget.create({containerID:this.id,handler:this,gesture:"horizontalScroll"})}}],methods:{init:function(){this.SUPER();var self=this;this.views.forEach(function(choice,index){index!=self.index&&choice.view().deepPublish(self.ON_HIDE)}),this.views[this.index].view().deepPublish(this.ON_SHOW)},toHTML:function(){var str=[],viewChoice=this.views[this.index];return this.headerView&&(str.push(this.headerView.toHTML()),this.addChild(this.headerView)),str.push('<div id="'+this.id+'" class="swipeAltOuter">'),str.push('<div class="swipeAltSlider" style="width: 100%">'),str.push('<div class="swipeAltInner" style="left: 0px">'),str.push(viewChoice.view().toHTML()),str.push("</div>"),str.push("</div>"),str.push("</div>"),str.join("")},initHTML:function(){if(this.$){this.SUPER(),this.slider=this.$.children[0];for(var str=[],i=0;i<this.views.length;i++)str.push('<div class="swipeAltInner"'+(i?' style="visibility:hidden;"':"")+">"),str.push(this.views[i].view().toHTML()),str.push("</div>");this.slider.innerHTML=str.join(""),window.addEventListener("resize",this.resize,!1),this.X.gestureManager.install(this.swipeGesture);var self=this;window.setTimeout(function(){self.resize(),self.views.forEach(function(choice){choice.view().initHTML()});for(var vs=self.slider.querySelectorAll(".swipeAltInner"),i=0;i<vs.length;i++)vs[i].style.visibility=""},0)}},destroy:function(isParentDestroyed){this.SUPER(isParentDestroyed),this.X.gestureManager.uninstall(this.swipeGesture),this.views.forEach(function(c){c.view().destroy()})},snapToCurrent:function(sizeOfMove){var self=this,time=150+150*sizeOfMove;Movement.animate(time,function(evt){self.x=self.index*self.width},Movement.ease(150/time,150/time),function(){self.views[self.index].view().deepPublish(self.ON_SHOW)})()}},listeners:[{model_:"Method",name:"resize",code:function(){if(!this.$)return void window.removeEventListener("resize",this.resize,!1);var self=this,frame=window.requestAnimationFrame(function(){self.x=self.index*self.width;for(var i=0;i<self.slider.children.length;i++)self.slider.children[i].style.left=100*i+"%",self.slider.children[i].style.visibility="";window.cancelAnimationFrame(frame)})},isMerged:100},{model_:"Method",name:"horizontalScrollMove",code:function(dx,tx,x){var x=this.index*this.width-tx;0>x&&(x=0);var maxWidth=(this.views.length-1)*this.width;x>maxWidth&&(x=maxWidth),this.x=x}},{model_:"Method",name:"horizontalScrollEnd",code:function(dx,tx,x){Math.abs(tx)>this.width/3?0>tx?this.index++:this.index--:this.snapToCurrent(1)}}],templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .swipeAltInner {\n        position: absolute;\n        top: 0px;\n        height: 100%;\n        width: 100%;\n      }\n\n      .swipeAltOuter {\n        display: flex;\n        overflow: hidden;\n        min-width: 240px;\n        width: 100%;\n      }\n\n      .swipeAltSlider {\n        position: relative;\n        width: 100%;\n        top: 0px;\n        -webkit-transform: translate3d(0,0,0);\n      }\n\n    "),out.toString()}}]}),CLASS({"package":"foam.ui",name:"ViewChoice",tableProperties:["label","view"],properties:[{model_:"Property",name:"label",type:"String",displayWidth:20,defaultValue:"",help:"View's label."},{model_:"ViewFactoryProperty",name:"view",type:"view",help:"View factory.",defaultValue:"foam.ui.DetailView"}]}),CLASS({"package":"foam.ui",name:"ImageView",extendsModel:"foam.ui.View",properties:[{model_:"Property",name:"className",defaultValue:"imageView"},{model_:"Property",name:"backupImage"},{model_:"Property",name:"domValue",postSet:function(oldValue,newValue){oldValue&&Events.unfollow(this.data$,oldValue),newValue&&Events.follow(this.data$,newValue)}},{model_:"Property",name:"displayWidth",postSet:function(_,newValue){this.$&&(this.$.style.width=newValue)}},{model_:"Property",name:"displayHeight",postSet:function(_,newValue){this.$&&(this.$.style.height=newValue)}}],methods:{toHTML:function(){var src=window.IS_CHROME_APP?this.backupImage?' src="'+this.backupImage+'"':"":' src="'+this.data+'"';return"<img "+this.cssClassAttr()+' id="'+this.id+'"'+src+">"},isSupportedUrl:function(url){return url=url.trim().toLowerCase(),url.startsWith("data:")||url.startsWith("blob:")||url.startsWith("filesystem:")},initHTML:function(){if(this.SUPER(),this.backupImage&&this.$.addEventListener("error",function(){this.data=this.backupImage}.bind(this)),window.IS_CHROME_APP&&!this.isSupportedUrl(this.data)){var self=this,xhr=new XMLHttpRequest;xhr.open("GET",this.data),xhr.responseType="blob",xhr.asend(function(blob){blob&&(self.$.src=URL.createObjectURL(blob))})}else this.domValue=DomValue.create(this.$,void 0,"src"),this.displayHeight=this.displayHeight,this.displayWidth=this.displayWidth}}}),CLASS({"package":"foam.apps.mbug.ui",name:"IssueCitationView",extendsModel:"foam.ui.DetailView",requires:["foam.ui.ImageBooleanView","foam.ui.md.MonogramStringView","foam.apps.mbug.ui.PriorityCitationView"],imports:["mbug"],templates:[{model_:"Template",name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out(" \n      <div id=",this.id,' >\n        <div id="',this.on("click",function(){this.mbug.editIssue(this.data.id)}),'" class="issue-citation">\n          ',self.createTemplateView("owner",{model_:"foam.ui.md.MonogramStringView"}),'\n          <div class="middle">\n            ',self.createTemplateView("id",{mode:"read-only",className:"id"}),"\n            ",self.createTemplateView("metaPriority",{model_:"foam.apps.mbug.ui.PriorityCitationView"}),"\n            ",self.createTemplateView("summary",{mode:"read-only"}),"\n          </div>\n          ",self.createTemplateView("starred",{model_:"foam.ui.ImageBooleanView",className:"star",trueImage:"images/ic_star_24dp.png",falseImage:"images/ic_star_outline_24dp.png"}),"\n        </div>\n      </div>\n    "),out.toString()}}]}),CLASS({"package":"foam.ui",name:"ImageBooleanView",extendsModel:"foam.ui.SimpleView",properties:[{model_:"Property",name:"data",postSet:function(old,nu){this.updateHTML()}},{model_:"Property",name:"name",label:"Name",type:"String",defaultValue:""},{model_:"Property",name:"trueImage"},{model_:"Property",name:"falseImage"},{model_:"Property",name:"trueClass"},{model_:"Property",name:"falseClass"}],methods:{image:function(){return this.data?this.trueImage:this.falseImage},toHTML:function(){var id=this.id;return this.on("click",this.onClick,id),this.name?'<img id="'+id+'" '+this.cssClassAttr()+'" name="'+this.name+'">':'<img id="'+id+'" '+this.cssClassAttr()+">"},initHTML:function(){this.$&&(this.SUPER(),this.updateHTML())},updateHTML:function(){this.$&&(this.$.src=this.image(),this.data?(this.trueClass&&this.$.classList.add(this.trueClass),this.falseClass&&this.$.classList.remove(this.falseClass)):(this.trueClass&&this.$.classList.remove(this.trueClass),this.falseClass&&this.$.classList.add(this.falseClass)))}},listeners:[{model_:"Method",name:"onClick",code:function(e){e.stopPropagation(),this.data=!this.data}}]}),CLASS({"package":"foam.ui",name:"SimpleView",extendsModel:"foam.ui.BaseView",traits:["foam.ui.HTMLViewTrait","foam.ui.TemplateSupportTrait","foam.ui.ViewActionsTrait"],requires:["Property"],exports:["propertyViewProperty"],properties:[{model_:"Property",name:"propertyViewProperty",type:"Property",defaultValueFn:function(){return this.Property.DETAIL_VIEW}}]}),CLASS({"package":"foam.ui.md",name:"MonogramStringView",extendsModel:"foam.ui.View",traits:["foam.ui.md.ColoredBackgroundTrait"],properties:[{model_:"Property",name:"className",defaultValue:"monogram-string-view"},{model_:"Property",name:"tooltip",defaultValueFn:function(){return this.data}},{model_:"Property",name:"data",postSet:function(old,nu){this.updateHTML()}}],methods:{generateColor:function(data){return data?this.SUPER(data):"url(images/silhouette.png) center no-repeat #e0e0e0"},updateHTML:function(){return this.$&&(this.$.style.background=this.generateColor(this.data)),this.SUPER()}},templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .monogram-string-view {\n        -webkit-align-items: center;\n        -webkit-flex-grow: 0;\n        -webkit-justify-content: center;\n        align-items: center;\n        border-radius: 20px;\n        border: 1px solid rgba(0,0,0,.1);\n        box-sizing: border-box;\n        color: #fff;\n        display: -webkit-inline-flex;\n        display: inline-flex;\n        flex-grow: 0;\n        font-size: 20px;\n        height: 40px;\n        justify-content: center;\n        margin-right: 16px;\n        overflow: hidden;\n        padding-bottom: 2px;\n        width: 40px;\n      }\n    "),out.toString()}},{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out(" ",this.data[0]&&this.data[0].toUpperCase()||"&nbsp;"," "),out.toString()}},{model_:"Template",name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('\n      <div id="',this.id,'" ',this.cssClassAttr(),' style="background: ',this.generateColor(this.data),'">\n        ',this.toInnerHTML(),"\n      </div>\n    "),out.toString()}}]}),CLASS({"package":"foam.ui.md",name:"ColoredBackgroundTrait",properties:[{model_:"Property",name:"colors",defaultValue:["e8ad62","9b26af","6639b6","4184f3","02a8f3","00bbd3","009587","0e9c57","9e9c57","8ac249","ccdb38","ffea3a","f3b300","ff9700","ff5621","785447"]}],methods:{generateColor:function(data){return"#"+this.colors[Math.abs(data.hashCode())%this.colors.length]},generateColorStyle:function(data){return' style="background:'+this.generateColor(data)+';"'}}}),CLASS({"package":"foam.apps.mbug.ui",name:"PriorityCitationView",extendsModel:"foam.apps.mbug.ui.PriorityView",methods:{updateHTML:function(){this.$&&(this.invokeDestructors(),this.$.outerHTML=this.toHTML(),this.initHTML())}},templates:[{model_:"Template",name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('\n      <span id="',self.id,'" class="priority priority-',this.dataToPriority(this.data),'">Pri ',this.dataToPriority(this.data),"</span>\n    "),out.toString()}}]}),CLASS({"package":"foam.apps.mbug.ui",name:"PriorityView",extendsModel:"foam.ui.View",properties:[{model_:"Property",name:"data",postSet:function(){this.updateHTML()}},{model_:"Property",name:"map",defaultValue:{Low:3,Medium:2,High:1,Critical:0}}],methods:{dataToPriority:function(data){var numeric=parseInt(data);return Number.isNaN(numeric)?void 0!==this.map[data]?this.map[data]:(data&&console.warn('Unknown priority "'+data+'".'),3):numeric}},templates:[{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('\n      <div class="priority priority-',this.dataToPriority(this.data),'">P',this.dataToPriority(this.data),"</div>\n    "),out.toString()}}]}),CLASS({"package":"foam.apps.mbug.ui",name:"IssueView",extendsModel:"foam.ui.UpdateDetailView",traits:["foam.input.touch.VerticalScrollNativeTrait"],requires:["foam.apps.mbug.ui.CitationRowView","foam.apps.mbug.ui.CitationView","foam.apps.mbug.ui.CommentView","foam.apps.mbug.ui.LabelCitationView","foam.apps.mbug.ui.LabelView","foam.apps.mbug.ui.PersonView","foam.apps.mbug.ui.PriorityView","foam.apps.quickbug.model.QIssueComment","foam.apps.quickbug.model.QIssueLabel","foam.apps.quickbug.model.imported.IssuePerson","foam.ui.DAOListView","foam.ui.ImageBooleanView","foam.ui.PopupChoiceView","foam.ui.md.AddRowView","foam.ui.md.AutocompleteListView","foam.ui.md.TextFieldView"],imports:["PersonDAO","issueLabelDAO","stack"],properties:[{model_:"Property",name:"scrollerID",getter:function(){return this.id+"-scroller"}}],actions:[{model_:"Action",name:"back",label:"",iconUrl:"images/ic_arrow_back_24dp.png"},{model_:"Action",name:"cancel",label:"",iconUrl:"images/ic_clear_24dp.png"},{model_:"Action",name:"save",label:"",iconUrl:"images/ic_done_24dp.png"}],listeners:[{model_:"Method",name:"onOwnerClick",code:function(){this.stack.pushView(this.AddRowView.create({dao:this.PersonDAO,data$:this.data.owner$,subType:this.IssuePerson,subKey:this.IssuePerson.NAME,rowView:"foam.apps.mbug.ui.PersonView"}),void 0,void 0,"none")}}],templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .content-view {\n        margin-top: -24px;\n      }\n      .expand {\n        flex: 1 1 auto;\n      }\n    "),out.toString()}},{model_:"Template",name:"headerToHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('\n      <div class="header">\n        <div class="toolbar">\n          ',self.createTemplateView("back"),"\n          ",self.createTemplateView("cancel"),'\n          <span class="expand"></span>\n          ',self.createTemplateView("save"),"\n          ",self.createTemplateView("starred",{model_:"foam.ui.ImageBooleanView",className:"star",trueImage:"images/ic_star_white_24dp.png",falseImage:"images/ic_star_outline_white_24dp.png"}),'\n        </div>\n        <div class="title">\n          #&nbsp;',self.createTemplateView("id",{mode:"read-only"})," ",self.createTemplateView("summary",{mode:"read-only"}),"\n        </div>\n      </div>\n    "),out.toString()}},{model_:"Template",name:"bodyToHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('\n      <div class="body">\n        <div id="',this.id,'-scroller" class="body-scroller">\n          <div class="choice">\n          '),this.data.pri?out("\n            ",self.createTemplateView("pri",{model_:"foam.apps.mbug.ui.PriorityView"}),"\n            ",self.createTemplateView("pri",{model_:"foam.ui.PopupChoiceView",iconUrl:"images/ic_arrow_drop_down_24dp.png",showValue:!0}),"\n          "):out("\n            ",self.createTemplateView("priority",{model_:"foam.apps.mbug.ui.PriorityView"}),"\n            ",self.createTemplateView("priority",{model_:"foam.ui.PopupChoiceView",iconUrl:"images/ic_arrow_drop_down_24dp.png",showValue:!0}),"\n          "),out('\n          </div>\n          <div class="choice">\n            <img src="images/ic_keep_24dp.png" class="status-icon">\n            ',self.createTemplateView("status",{model_:"foam.ui.PopupChoiceView",iconUrl:"images/ic_arrow_drop_down_24dp.png",showValue:!0,dao:this.X.StatusDAO,objToChoice:function(o){return[o.status,o.status]}}),'\n          </div>\n\n          <div class="separator separator1"></div>\n          <div id="',this.on("click",this.onOwnerClick),'" class="owner">\n            ',self.createTemplateView("owner",{model_:"foam.apps.mbug.ui.CitationView"}),'\n          </div>\n\n          <div class="separator separator1"></div>\n          '),out(this.AutocompleteListView.create({data$:this.data.cc$,inline:!0,srcDAO:this.PersonDAO,rowView:"foam.apps.mbug.ui.CitationRowView",acRowView:"foam.apps.mbug.ui.PersonView",prop:X.ReferenceArrayProperty.create({name:"cc",subType:this.IssuePerson,subKey:this.IssuePerson.NAME}),queryFactory:function(q){return STARTS_WITH_IC(self.IssuePerson.NAME,q)}})),out('\n\n          <div class="separator separator1"></div>\n          '),out(this.AutocompleteListView.create({data$:this.data.labels$,srcDAO:this.issueLabelDAO,inline:!0,rowView:"foam.apps.mbug.ui.LabelCitationView",acRowView:"foam.apps.mbug.ui.LabelView",prop:X.ReferenceArrayProperty.create({name:"labels",subType:this.QIssueLabel,subKey:this.QIssueLabel.LABEL}),queryFactory:function(q){return STARTS_WITH_IC(self.QIssueLabel.LABEL,q)}})),out('\n\n          <div class="separator separator1"></div>\n          ',self.createTemplateView("content",{model_:"foam.ui.md.TextFieldView",label:"Add Comment",onKeyMode:!0,extraClassName:"content-view"}),"\n          ",self.createTemplateView("comments",{model_:"foam.ui.DAOListView",dao:this.data.comments.orderBy(DESC(this.QIssueComment.PUBLISHED)),mode:"read-only",rowView:"foam.apps.mbug.ui.CommentView"}),"\n        </div>\n      </div>\n    "),out.toString()}},{model_:"Template",name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('\n      <div id="',this.id,'" class="issue-edit">\n        ',this.headerToHTML(),"\n        ",this.bodyToHTML(),"\n      </div>\n    "),out.toString()}}]}),CLASS({"package":"foam.apps.mbug.ui",name:"CitationRowView",extendsModel:"foam.ui.md.DefaultRowView",requires:["foam.ui.md.MonogramStringView"],properties:[{model_:"Property",name:"className",defaultValue:"CitationRowView"}],templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .CitationRowView {\n        padding: 0 0 12px 16px;\n        display: flex;\n        flex-direction: row;\n        align-items: center;\n        color: #575757;\n      }\n    "),out.toString()}},{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      ",this.MonogramStringView.create({data:this.data}),'\n      <div class="owner-name">',escapeHTML(this.data),'</div>\n      <span class="removeRow">',self.createTemplateView("removeRow"),"</span>\n    "),out.toString()}}]}),CLASS({"package":"foam.ui.md",name:"DefaultRowView",extendsModel:"foam.ui.View",imports:["removeRowFromList"],properties:[{model_:"ViewFactoryProperty",name:"innerView",defaultValue:"foam.ui.DetailView"},{model_:"Property",name:"data"},{model_:"Property",name:"className",defaultValue:"DefaultRowView"}],actions:[{model_:"Action",name:"removeRow",label:"",iconUrl:"images/ic_clear_black_24dp.png",action:function(){this.removeRowFromList(this.data)}}],templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .DefaultRowView {\n        align-items: center;\n        display: flex;\n        height: 72px;\n        justify-content: space-between;\n        line-height: 48px;\n        overflow: hidden;\n        padding: 4px 0 4px 8px;\n        white-space: nowrap;\n      }\n    "),out.toString()}},{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      ",this.innerView({data:this.data},this.Y),"\n      ",self.createTemplateView("removeRow"),"\n    "),out.toString()}}]}),CLASS({"package":"foam.apps.mbug.ui",name:"CitationView",extendsModel:"foam.ui.SimpleView",requires:["foam.ui.md.MonogramStringView"],properties:[{model_:"Property",name:"prop"},{model_:"Property",name:"tagName",defaultValue:"div"},{model_:"Property",name:"className",defaultValue:"CitationView"},{model_:"Property",name:"data",postSet:function(){this.updateHTML()}}],actions:[{model_:"Action",name:"clear",label:"",iconUrl:"images/ic_clear_black_24dp.png",action:function(){this.data=""}}],templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .CitationView {\n        padding: 0 0 0 16px;\n      }\n\n      .CitationView .contents {\n        display: flex;\n        flex-direction: row;\n        align-items: center;\n        color: #575757;\n      }\n\n      .CitationView .label {\n        color: #999;\n        font-size: 14px;\n        padding-bottom: 12px;\n        font-weight: 500;\n      }\n    "),out.toString()}},{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('\n      <div class="label">',escapeHTML(this.prop.label),'</div>\n      <div class="contents">\n        ',this.MonogramStringView.create({data:this.data}),'\n        <div class="owner-name">',escapeHTML(this.data),"</div>\n      </div>\n    "),out.toString()}}]}),CLASS({"package":"foam.apps.mbug.ui",name:"CommentView",extendsModel:"foam.ui.DetailView",requires:["foam.ui.md.MonogramStringView","foam.apps.quickbug.ui.QIssueCommentAuthorView"],templates:[{model_:"Template",name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('\n    <div class="separator"></div>\n    <div id="',this.id,'" class="comment-view">\n       <span class="owner">\n         ',this.MonogramStringView.create({data:this.data.author.name}),'\n       </span>\n       <span class="content">\n         Commented by ',self.createTemplateView("author"),'<br>\n         <span class="published">',this.data.published.toRelativeDateString(),"</span> <br><br>\n         ",self.createTemplateView("content",{mode:"read-only",escapeHTML:!1}),"\n       </span>\n    </div>\n  "),out.toString()}}]}),CLASS({"package":"foam.apps.quickbug.ui",name:"QIssueCommentAuthorView",extendsModel:"foam.ui.DetailView",methods:{updateSubViews:function(){this.SUPER(),this.$&&(this.$.firstElementChild.href=this.data.htmlLink)}},templates:[{model_:"Template",name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('\n    <span id="',this.id,'" class="qissuecommentauthor">\n      <a>',self.createTemplateView("name",{mode:"read-only"}),"</a>\n    </span>\n  "),out.toString()}}]}),CLASS({"package":"foam.apps.mbug.ui",name:"LabelCitationView",extendsModel:"foam.ui.md.DefaultRowView",traits:["foam.ui.md.ColoredBackgroundTrait"],properties:[{model_:"Property",name:"className",defaultValue:"LabelCitationView"}],templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .IssueLabel {\n        align-items: center;\n        border-radius: 50px;\n        border: 1px solid rgba(0,0,0,.1);\n        color: white;\n        display: flex;\n        flex-direction: row;\n        font-size: 14px;\n        margin-right: 12px;\n        margin-top: 12px;\n        padding: 10px;\n        padding-left: 28px;\n      }\n      .IssueLabel canvas {\n        background: rgba(0,0,0,0) !important;\n      }\n      .LabelCitationView {\n        margin-left: 16px;\n      }\n    "),out.toString()
}},{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('\n      <div class="IssueLabel" ',this.generateColorStyle(this.data.match(/[^-]+/)[0]),'>\n        <div style="flex: 1 0 auto;">',escapeHTML(this.data),"</div>\n        ",self.createTemplateView("removeRow",{width:20,height:20,iconUrl:"images/ic_clear_24dp.png"}),"\n      </div>\n    "),out.toString()}}]}),CLASS({"package":"foam.apps.mbug.ui",name:"LabelView",extendsModel:"foam.ui.DetailView",traits:["foam.ui.md.ColoredBackgroundTrait"],templates:[{model_:"Template",name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('\n    <div id="',self.id,'" ',this.generateColorStyle(this.data.label.match(/[^-]+/)[0]),' class="IssueLabel">',escapeHTML(this.data.label),"</div>\n  "),out.toString()}}]}),CLASS({"package":"foam.apps.mbug.ui",name:"PersonView",extendsModel:"foam.ui.DetailView",requires:["foam.ui.md.MonogramStringView"],templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n.PersonView {\n  padding: 12px 0;\n  display: flex;\n  flex-direction: row;\n  align-items: center;\n  color: #575757;\n}\n"),out.toString()}},{model_:"Template",name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('\n      <div id="',self.id,'" class="PersonView">\n        ',self.createTemplateView("name",{model_:"foam.ui.md.MonogramStringView"}),'\n        <div class="owner-name">',escapeHTML(this.data.name),"</div>\n      </div>\n  "),out.toString()}}]}),CLASS({"package":"foam.apps.quickbug.model",name:"QIssueComment",extendsModel:"foam.apps.quickbug.model.imported.IssueComment",ids:["id"],properties:[{model_:"StringProperty",name:"id",defaultValue:"0",preSet:function(_,v){return v}},{model_:"Property",name:"author",subType:"foam.apps.quickbug.model.imported.IssuePerson",view:"foam.apps.quickbug.ui.QIssueCommentAuthorView",preSet:function(_,newValue,prop){return newValue.model_?newValue:this.X.lookup(prop.subType).create(newValue)}},{model_:"Property",name:"updates",subType:"foam.apps.quickbug.model.QIssueCommentUpdate",view:"foam.apps.quickbug.ui.QIssueCommentUpdateView",preSet:function(_,newValue,prop){return newValue.model_?newValue:this.X.lookup(prop.subType).create(newValue)}},{model_:"Property",name:"published",view:"foam.ui.RelativeDateTimeFieldView"},{model_:"ReferenceProperty",name:"issueId",hidden:!0,subType:"foam.apps.quickbug.model.imported.Issue"},{model_:"StringProperty",name:"content",displayWidth:85,displayHeight:8},{model_:"IntProperty",name:"seqNo",help:"The sequence number for this comment, indicating where it shows in the comment list for a particular issue."}]}),CLASS({"package":"foam.apps.quickbug.model.imported",name:"IssueComment",properties:[{model_:"ReferenceProperty",name:"author",help:"Person who authored this comment.",subType:"IssuePerson"},{model_:"BooleanProperty",name:"canDelete",help:"Whether the authenticated user can delete this comment."},{model_:"StringProperty",name:"content",help:"Content of this issue comment."},{model_:"ReferenceProperty",name:"deletedBy",help:"Person who deleted this comment.",subType:"IssuePerson"},{model_:"IntProperty",name:"id",help:"0-based sequence number of this comment, unique to this issue."},{model_:"StringProperty",name:"kind",help:"Comment on an issue tracked by Google Project Hosting."},{model_:"DateProperty",name:"published",help:"Date and time the issue was last updated."},{model_:"ReferenceProperty",name:"updates",subType:"IssueCommentUpdate"}]}),CLASS({"package":"foam.apps.quickbug.model",name:"QIssueLabel",ids:["label"],properties:[{model_:"Property",name:"label"},{model_:"Property",name:"description"}]}),CLASS({"package":"foam.apps.quickbug.model.imported",name:"IssuePerson",properties:[{model_:"StringProperty",name:"htmlLink",help:"Link to this user's page."},{model_:"StringProperty",name:"kind"},{model_:"StringProperty",name:"name",help:"User's name."}]}),CLASS({"package":"foam.ui.md",name:"AddRowView",extendsModel:"foam.ui.SimpleView",traits:["foam.ui.layout.PositionedDOMViewTrait","foam.input.touch.VerticalScrollNativeTrait"],requires:["foam.ui.md.ToolbarCSS"],imports:["dao","hideListOnSingle","queryFactory","returnOnSelect","rowView","stack"],exports:["selection$"],properties:[{model_:"ViewFactoryProperty",name:"rowView",defaultValue:"foam.ui.md.TextFieldView"},{model_:"Property",name:"data"},{model_:"Property",name:"softData",factory:function(){var found=!1;return this.dao.find(this.data,{put:function(x){found=!0,this.softData=x}.bind(this)}),found?this.softData:""},postSet:function(old,nu){nu&&(this.q=this.objectToQuery(nu),this.selected=!0)}},{model_:"Property",name:"q",label:"Search",view:{factory_:"foam.ui.md.TextFieldView",onKeyMode:!0,darkBackground:!0,floatingLabel:!1},postSet:function(old,nu){this.selected=!1}},{model_:"Property",name:"selected",defaultValue:!1},{model_:"Property",name:"subType"},{model_:"Property",name:"subKey",factory:function(){return"ID"},preSet:function(old,nu){return"string"==typeof nu?this.X.lookup(this.subType+"."+constantize(nu)):nu}},{model_:"foam.core.types.DAOProperty",name:"dao",factory:function(){var basename=this.subType.split(".").pop(),name=basename[0].toLowerCase()+basename.substring(1),daoName=name+"DAO";return this.X[daoName]}},{model_:"Property",name:"wrappedDAO",factory:function(){return this.hideListOnSingle?this.SingleEntryHidingDAO.create({delegate:this.dao}):this.dao}},{model_:"foam.core.types.DAOProperty",name:"filteredDAO",dynamicValue:function(){this.q,this.wrappedDAO,this.limit;var q=this.q?this.queryFactory(this.q):TRUE,dao=this.wrappedDAO.where(q).limit(this.limit);return dao},view:{factory_:"foam.ui.DAOListView",className:"rows",tagName:"div",useSelection:!0}},{model_:"Property",name:"queryFactory",defaultValue:function(q){return STARTS_WITH_IC(this.subKey,q)}},{model_:"Property",name:"objectToQuery",factory:function(){return function(obj){return this.subKey.f(obj)}.bind(this)}},{model_:"Property",name:"limit",defaultValue:40},{model_:"Property",name:"className",defaultValue:"AddRowView"},{model_:"Property",name:"scrollerID",factory:function(){return this.nextID()}},{model_:"Property",name:"hideListOnSingle",defaultValue:!1},{model_:"Property",name:"returnOnSelect",defaultValue:!0},{model_:"Property",name:"allowFocus",defaultValue:!1},{model_:"Property",name:"selection",postSet:function(old,nu){nu&&(this.returnOnSelect?(this.data=this.subKey?this.subKey.f(nu):nu,this.doClose()):this.softData=nu)}}],actions:[{model_:"Action",name:"cancel",label:"",isAvailable:function(){return!this.selected},iconUrl:"images/ic_clear_24dp.png",action:function(){this.doClose()}},{model_:"Action",name:"accept",label:"",isAvailable:function(){return this.selected},iconUrl:"images/ic_done_24dp.png",action:function(){var key=this.subKey?this.subKey.f(this.softData):this.softData;this.data=key,this.doClose()}}],methods:{doClose:function(){this.closed_||(this.closed_=!0,this.qView.blur(),this.stack.back())},focus:function(){this.allowFocus&&this.qView.focus()}},templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .AddRowView {\n        display: flex;\n        flex-direction: column;\n        width: 100%;\n        height: 100%;\n        background: #fff;\n        overflow: hidden;\n      }\n      .AddRowView .arvBody {\n        flex-grow: 1;\n        overflow-y: auto;\n      }\n      .AddRowView .rows {\n        width: 100%;\n        border: none;\n      }\n      .AddRowView .rows-row {\n        padding: 0 12px 0 16px;\n      }\n    "),out.toString()}},{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('\n      <div class="header">\n        ',self.createTemplateView("cancel")," ",self.createTemplateView("accept"),"\n        ",self.createTemplateView("q",{extraClassName:"grow",clearAction:!0}),'\n      </div>\n      <div class="arvBody" id="',self.scrollerID,'">\n        ',self.createTemplateView("filteredDAO",{rowView:this.rowView}),"\n      </div>\n      "),this.addInitializer(function(){self.allowFocus&&self.qView.focus()}),out("\n    "),out.toString()}}],models:[{model_:"Model",name:"SingleEntryHidingDAO",extendsModel:"foam.dao.ProxyDAO",methods:{select:function(sink,options){var firstEntry,seen=0;sink=sink||[];var mySink={put:sink&&sink.put&&function(x){seen++,1===seen?firstEntry=x:2===seen?(sink.put(firstEntry),sink.put(x)):sink.put(x)},error:sink&&sink.error&&sink.error.bind(sink),eof:sink&&sink.eof&&sink.eof.bind(sink)};return this.delegate.select(mySink,options)}}}]}),CLASS({"package":"foam.ui.md",name:"ToolbarCSS",templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .header {\n        align-items: center;\n        background-color: #3e50b4;\n        box-shadow: 0 1px 1px rgba(0,0,0,0.15), 0 1px 3px rgba(0,0,0,0.15);\n        display: flex;\n        flex-grow: 0;\n        flex-shrink: 0;\n        height: 56px;\n        padding: 4px;\n        width: 100%;\n\n        color: #fff;\n        font-size: 20px;\n        font-weight: 500;\n        line-height: 28px;\n      }\n\n      .header canvas {\n        flex-grow: 0;\n        flex-shrink: 0;\n      }\n      .header img {\n        flex-grow: 0;\n        flex-shrink: 0;\n      }\n\n      .header .grow {\n        flex-grow: 1;\n        flex-shrink: 1;\n      }\n\n      .header .actionButton {\n        -webkit-box-shadow: none;\n        background: #3e50b4;\n        border: none;\n        box-shadow: none;\n        display: none;\n        opacity: 0.76;\n        outline: none;\n        vertical-align: middle;\n      }\n\n      .header .actionButton.available {\n        display: block;\n      }\n\n      .header .header-text {\n        overflow: hidden;\n        padding: 0px 16px;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n      }\n\n      .header input {\n        color: #fff;\n      }\n    "),out.toString()}}]}),CLASS({"package":"foam.ui.md",name:"AutocompleteListView",extendsModel:"foam.ui.BaseView",traits:["foam.ui.HTMLViewTrait","foam.ui.TemplateSupportTrait","foam.ui.ViewActionsTrait"],requires:["foam.ui.md.AddRowView","foam.ui.md.ToolbarCSS"],imports:["stack"],exports:["acRowView as rowView","removeRowFromList"],properties:[{model_:"Property",name:"data",postSet:function(oldValue,newValue){this.updateHTML()}},{model_:"Property",name:"srcDAO"},{model_:"Property",name:"queryFactory"},{model_:"Property",name:"prop"},{model_:"Property",name:"label",defaultValueFn:function(){return this.prop?this.prop.label:""}},{model_:"ViewFactoryProperty",name:"acRowView",defaultValue:"foam.ui.md.DefaultACRowView"},{model_:"ViewFactoryProperty",name:"rowView",defaultValue:"DefaultRowView"},{model_:"Property",name:"inline",defaultValue:!1},{model_:"Property",name:"className",defaultValueFn:function(){return"md-autocomplete-list "+(Array.isArray(this.data)?"array":"single")}},{model_:"Property",name:"tagName",defaultValue:"div"}],actions:[{model_:"Action",name:"back",label:"",iconUrl:"images/ic_arrow_back_24dp.png",action:function(){this.stack.back()}},{model_:"Action",name:"addRow",label:"",iconUrl:"images/ic_add_24dp.png",action:function(){var subY=this.srcDAO?this.Y.sub({dao:this.srcDAO}):this.Y,view=this.AddRowView.create(this.prop,subY);view.data$.addListener(function(obj,topic,old,nu){this.addRowToList(nu)}.bind(this)),this.stack.pushView(view),view.focus()}}],methods:{addRowToList:function(d){d&&(this.data=Array.isArray(this.data)?this.data.union([d]):d)},removeRowFromList:function(d){this.data=this.data.deleteF(d)}},templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .md-autocomplete-list {\n      }\n      .md-autocomplete-list-row {\n        align-items: center;\n        display: flex;\n        height: 72px;\n        justify-content: space-between;\n        line-height: 48px;\n        padding: 4px 0 4px 8px;\n      }\n\n      .md-autocomplete-list-inline-header {\n        align-items: center;\n        display: flex;\n      }\n      .md-autocomplete-list-inline-header .text {\n        color: #999;\n        flex-grow: 1;\n        flex-shrink: 0;\n        font-size: 14px;\n        font-weight: 500;\n        padding: 0 16px;\n      }\n      .md-autocomplete-list-inline-header .actionButtonCView-addRow {\n        opacity: 0.76;\n      }\n      .md-autocomplete-list-body {\n        display: flex;\n        flex-wrap: wrap;\n      }\n    "),out.toString()}},{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);out("\n      ");var isArray=Array.isArray(this.data);if(out("\n      "),this.inline?(out('\n        <div class="md-autocomplete-list-inline-header">\n          <span class="text">',self.label,"</span>\n          "),isArray&&out(" ",self.createTemplateView("addRow",{iconUrl:"images/ic_add_black_24dp.png"})," "),out("\n        </div>\n      ")):(out('\n        <div class="md-autocomplete-list-header">\n          ',self.createTemplateView("back"),'\n          <span class="grow header-text">',self.label,"</span>\n          "),isArray&&out(" ",self.createTemplateView("addRow")," "),out("\n        </div>\n      ")),out('\n      <div id="',this.scrollerID,'" class="md-autocomplete-list-body"\n          '),this.inline||out(' style="overflow-y: auto" '),out("\n          >\n        "),isArray){out("\n          ");for(var i=0;i<this.data.length;i++)out("\n            ",this.rowView({data:this.data[i]},this.Y),"\n          ");out("\n        ")}else out('\n          <div id="',this.on("click",function(){self.addRow()}),'" ',this.rowView({data:this.data},this.Y),"</div>\n        ");return out("\n      </div>\n    "),out.toString()}}]}),CLASS({"package":"foam.ui.md",name:"TextFieldView",extendsModel:"foam.ui.SimpleView",properties:[{model_:"Property",name:"className",defaultValueFn:function(){return"md-text-field-container"+(this.floatingLabel?"":" md-text-field-no-label")+("read-only"==this.mode?" disabled":"")}},{model_:"Property",name:"data"},{model_:"Property",name:"softData"},{model_:"Property",name:"inputId"},{model_:"Property",name:"$input",getter:function(){return this.X.$(this.inputId)}},{model_:"Property",name:"labelId"},{model_:"Property",name:"$label",getter:function(){return this.X.$(this.labelId)}},{model_:"BooleanProperty",name:"focused",defaultValue:!1},{model_:"Property",name:"prop"},{model_:"Property",name:"label",defaultValueFn:function(){return this.prop.label}},{model_:"BooleanProperty",name:"onKeyMode"},{model_:"IntProperty",name:"displayHeight"},{model_:"IntProperty",name:"displayWidth"},{model_:"BooleanProperty",name:"floatingLabel",defaultValue:!0},{model_:"BooleanProperty",name:"growable",defaultValue:!1},{model_:"Property",name:"clearAction",defaultValue:!1},{model_:"Property",name:"darkBackground",defaultValue:!1},{model_:"Property",name:"clearIcon",defaultValueFn:function(){return this.darkBackground?"images/ic_cancel_24dp.png":"images/ic_cancel_black_24dp.png"}},{model_:"Property",name:"underline",defaultValue:!0},{model_:"StringProperty",name:"mode",defaultValue:"read-write",view:{factory_:"foam.ui.ChoiceView",choices:["read-only","read-write"]}}],actions:[{model_:"Action",name:"clear",label:"",isAvailable:function(){return!!this.softData.length},iconUrl:"images/ic_cancel_24dp.png",action:function(){this.softData=""}}],methods:{initHTML:function(){this.SUPER(),this.softValue=DomValue.create(this.$input,"input",this.growable?"textContent":"value"),this.softValue.set(this.data),Events.link(this.softValue,this.softData$),this.onKeyMode?Events.link(this.data$,this.softData$):Events.follow(this.data$,this.softData$)},focus:function(){this.$input.focus()},blur:function(){this.$input&&this.$input.blur()}},listeners:[{model_:"Method",name:"onFocus",code:function(){this.focused=!0}},{model_:"Method",name:"onBlur",code:function(){this.focused=!1,this.growable&&(this.data=this.softData)}},{model_:"Method",name:"onInput",code:function(){}},{model_:"Method",name:"onChange",code:function(){this.data=this.softData}},{model_:"Method",name:"onKeyDown",code:function(){}},{model_:"Method",name:"onClick",code:function(){this.$input.focus()}}],templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .md-text-field-container {\n        align-items: center;\n        width: 100%;\n        display: flex;\n        position: relative;\n      }\n      .md-text-field-label {\n        position: absolute;\n        top: 40px;\n        font-size: 14px;\n        font-weight: 500;\n        color: #999;\n        transition: font-size 0.5s, top 0.5s;\n        flex-grow: 1;\n        margin-left: 16px;\n        z-index: 0;\n      }\n      .md-text-field-input {\n        background: transparent;\n        border-bottom: 1px solid #e0e0e0;\n        border-left: none;\n        border-right: none;\n        border-top: none;\n        color: #444;\n        flex-grow: 1;\n        font-family: Roboto, RobotoDraft;\n        font-size: 14px;\n        margin: 40px 16px 8px;\n        padding: 0 0 7px 0;\n        resize: none;\n        z-index: 1;\n      }\n      .disabled .md-text-field-input {\n        border-bottom: none;\n      }\n      .md-text-field-container.md-text-field-no-label .md-text-field-input {\n        font-size: 16px;\n        margin: 8px 0;\n        padding: 8px 2px;\n      }\n\n      .md-text-field-borderless {\n        border-bottom: none !important;\n      }\n\n      .md-text-field-input:focus {\n        border-bottom: 2px solid #4285f4;\n        padding: 0 0 6px 0;\n        outline: none;\n      }\n      .md-text-field-label-offset {\n        font-size: 12px;\n        top: 16px;\n      }\n    "),out.toString()}},{model_:"Template",name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);out("\n      ");var input=this.inputId=this.nextID(),label=this.labelId=this.nextID();return this.on("focus",this.onFocus,input),this.on("blur",this.onBlur,input),this.on("input",this.onInput,input),this.on("change",this.onChange,input),this.on("click",this.onClick,input),this.on("keydown",this.onKeyDown,input),this.floatingLabel&&this.setClass("md-text-field-label-offset",function(){var focused=self.focused,data=self.data;return focused||(""+data).length>0},label),out("\n      <div ",self.cssClassAttr(),' id="',self.id,'">\n        '),this.floatingLabel&&out('\n          <label id="',label,'" class="md-text-field-label">',self.label,"</label>\n        "),out("\n        "),this.growable?out('\n          <div id="',input,'" class="md-text-field-input"',"read-write"==this.mode?" contenteditable":"",">\n          </div>\n        "):this.displayHeight>1?out('\n          <textarea id="',input,'" type="text" class="md-text-field-input" rows="',this.displayHeight,'"',"read-only"==this.mode?" disabled":"","></textarea>\n        "):(out('\n          <input id="',input,'" type="text"\n              class="md-text-field-input ',this.underline?"":"md-text-field-borderless",'"\n              ',this.floatingLabel?"":'placeholder="'+this.label+'"',"","read-only"==this.mode?" disabled":""," />\n          "),this.clearAction&&out("\n            ",self.createTemplateView("clear",{iconUrl:this.clearIcon}),"\n          "),out("\n        ")),out("\n      </div>\n    "),out.toString()}}]}),CLASS({"package":"foam.ui",name:"UpdateDetailView",extendsModel:"foam.ui.DetailView",imports:["DAO as dao","stack"],properties:[{model_:"Property",name:"rawData",postSet:function(old,nu){old&&old.removeListener(this.rawUpdate),nu&&nu.addListener(this.rawUpdate)}},{model_:"Property",name:"originalData"},{model_:"Property",name:"data",preSet:function(_,v){return v?(this.rawData=v,v.deepClone()):void 0},postSet:function(_,data){data&&(this.originalData=data.deepClone(),data&&data.model_&&(this.model=data.model_),data.addListener(function(){this.version++,this.rawData=""}.bind(this)))}},{model_:"Property",name:"view"},{model_:"IntProperty",name:"version"}],actions:[{model_:"Action",name:"save",help:"Save updates.",isAvailable:function(){return this.version,!this.originalData.equals(this.data)},action:function(){var self=this,obj=this.data;this.stack.back(),this.dao.put(obj,{put:function(){console.log("Saving: ",obj.toJSON()),self.originalData.copyFrom(obj)},error:function(){console.error("Error saving",arguments)}})}},{model_:"Action",name:"cancel",help:"Cancel update.",isAvailable:function(){return this.version,!this.originalData.equals(this.data)},action:function(){this.stack.back()}},{model_:"Action",name:"back",isAvailable:function(){return this.version,this.originalData.equals(this.data)},action:function(){this.stack.back()}},{model_:"Action",name:"reset",isAvailable:function(){return this.version,!this.originalData.equals(this.data)},action:function(){this.data.copyFrom(this.originalData)}}],listeners:[{model_:"Method",name:"rawUpdate",code:function(){this.data=this.rawData}}]}),CLASS({"package":"foam.apps.quickbug.model",name:"DefaultQuery",extendsModel:"UNARY",properties:[{model_:"Property",name:"arg1",preSet:function(_,value){var pattern=value.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");return this.pattern_=new RegExp(pattern,"i"),this.prefixPattern_=new RegExp("^"+pattern,"i"),this.labelPattern_=new RegExp(-1==pattern.indexOf(":")?"(^|-)"+pattern:"^"+pattern.replace(/:/,"-"),"i"),value.toLowerCase()}}],methods:{toSQL:function(){return this.arg1},toMQL:function(){return this.arg1},f:function(obj){if(this.pattern_.test(obj.summary))return!0;if(this.prefixPattern_.test(obj.owner))return!0;for(var i=0;i<obj.cc.length;i++)if(this.prefixPattern_.test(obj.cc[i]))return!0;for(var i=0;i<obj.labels.length;i++)if(this.labelPattern_.test(obj.labels[i]))return!0;return!1}}}),CLASS({"package":"foam.apps.quickbug.model",name:"QBug",label:"Quick Bug",requires:["PersistentContext","foam.dao.IDBDAO","foam.core.dao.MigrationDAO","foam.core.dao.MigrationRule","Binding","foam.core.dao.RestDAO","foam.dao.LazyCacheDAO","foam.apps.quickbug.dao.ProjectNetworkDAO","foam.apps.quickbug.model.imported.Project","foam.apps.quickbug.model.QUser","foam.apps.quickbug.model.QProject","foam.metrics.Metric"],imports:["metricDAO"],properties:[{model_:"Property",name:"baseURL",defaultValue:"https://code.google.com/p/"},{model_:"Property",name:"jsonpFuture","transient":!0,factory:function(){return deferJsonP(this.X)}},{model_:"Property",name:"user",type:"foam.apps.quickbug.model.QUser",postSet:function(oldValue,newValue){oldValue&&oldValue.removePropertyListener("email",this.onUserUpdate),newValue.addPropertyListener("email",this.onUserUpdate),this.onUserUpdate()}},{model_:"Property",name:"userFuture","transient":!0,factory:function(){return afuture()}},{model_:"Property",name:"userReady",factory:function(){return afuture()}},{model_:"Property",name:"persistentContext","transient":!0,factory:function(){return this.PersistentContext.create({dao:this.IDBDAO.create({model:this.Binding}),context:this})}},{model_:"Property",name:"projectNetworkDAO","transient":!0,factory:function(){return this.ProjectNetworkDAO.create()}},{model_:"Property",name:"ProjectDAO","transient":!0,factory:function(){return this.LazyCacheDAO.create({cache:this.MigrationDAO.create({name:"project-dao",delegate:this.IDBDAO.create({model:this.Project,useSimpleSerialization:!1}),rules:[this.MigrationRule.create({modelName:"QProject",version:3,migration:function(ret,dao){dao.removeAll()(ret)}})]}),delegate:this.projectNetworkDAO})}},{model_:"Property",name:"projects_","transient":!0,factory:function(){return{}}},{model_:"Property",name:"defaultProjectName",defaultValue:"chromium"},{model_:"Property",name:"authAgent2"},{model_:"StringArrayProperty",name:"scopes",factory:function(){return["https://www.googleapis.com/auth/userinfo.email","https://www.googleapis.com/auth/projecthosting"]}}],methods:{init:function(args){this.X.foam.apps.quickbug.model.imported.Issue.properties.forEach(function(p){p.tableFormatter||(p.tableFormatter=function(v){return v||"----"}),p.tableWidth||(p.tableWidth="80px;")}),this.X.foam.apps.quickbug.model.imported.IssuePerson.ids=["name"],this.SUPER(args);var self=this;this.initOAuth(args&&args.authClientId,args&&args.authClientSecret),this.persistentContext.bindObject("user",this.QUser,void 0,2)(function(user){self.userFuture.set(user),user.email?self.userReady.set(user):self.refreshUser()})},initOAuth:function(opt_clientId,opt_clientSecret){var self=this,model=this.X.lookup("foam.oauth2.EasyOAuth2");this.persistentContext.bindObject("authAgent2",model.xbind({clientId:opt_clientId||"18229540903-ajaqivrvb8vu3c1viaq4drg3847vt9nq.apps.googleusercontent.com",clientSecret:opt_clientSecret||"mbxy7-eZlosojSZgHTRT15o9"}),{scopes:self.scopes},2)(function(oauth2){oauth2.setJsonpFuture(self.X,self.jsonpFuture)})},refreshUser:function(){var self=this;this.userFuture.get(function(user){apar(self.X.ajsonp("https://www.googleapis.com/oauth2/v1/userinfo",["alt=json"]),self.X.ajsonp("https://www.googleapis.com/projecthosting/v2/users/me"))(function(resp1,status1,resp2,status2){resp1&&(user.email=resp1.email),resp2&&user.copyFrom(resp2),self.userReady.set(user)})})},findProject:function(projectName,sink,opt_X){if(this.projects_[projectName])return void sink.put(this.projects_[projectName]);var self=this;this.ProjectDAO.find(projectName,{__proto__:sink,put:function(project){var p=self.QProject.create({qbug:self,project:project},opt_X||self.Y);self.projects_[projectName]=p,sink.put(p)},error:function(){sink.error&&sink.error()}})},getDefaultProject:function(sink,opt_X){this.findProject(this.defaultProjectName,sink,opt_X)},launchBrowser:function(opt_projectName,opt_url,opt_X){var self=this;this.userReady.get(function(user){self.findProject(opt_projectName||user.defaultProject,{put:function(p){console.log("launch: ",p),p.launchBrowser(opt_url)},error:function(){return self.metricDAO.put(self.Metric.create({type:"error",name:"defaultProjectNotFound"})),console.warn("Couldn't find default project, default to ",self.defaultProjectName),opt_projectName===self.defaultProjectName?(console.error("Couldn't find a project, you're probably offline."),void self.metricDAO.put(self.Metric.create({type:"error",name:"noProjectFound"}))):void self.launchBrowser(self.defaultProjectName,void 0,opt_X)}},opt_X)})}},listeners:[{model_:"Method",name:"onUserUpdate",code:function(){this.X.ME=this.user.email}}]}),CLASS({"package":"foam.core.dao",name:"MigrationDAO",extendsModel:"foam.dao.ProxyDAO",requires:["foam.core.dao.MigrationRule","foam.dao.FutureDAO","foam.dao.DAOVersion"],imports:["daoVersionDao"],properties:[{model_:"Property",name:"delegate"},{model_:"ArrayProperty",name:"rules",subType:"foam.core.dao.MigrationRule"},{model_:"Property",name:"name"}],methods:{init:function(){var dao=this.delegate,future=afuture();this.delegate=this.FutureDAO.create({future:future.get});var self=this,version;aseq(function(ret){self.daoVersionDao.find(self.name,{put:function(c){version=c,ret()},error:function(){version=self.DAOVersion.create({name:self.name,version:0}),ret()}})},function(ret){function updateVersion(ret,v){var c=version.clone();c.version=v,self.daoVersionDao.put(c,ret)}var rulesDAO=self.rules.dao;rulesDAO.where(AND(GT(self.MigrationRule.VERSION,version.version))).select()(function(rules){for(var seq=[],i=0;i<rules.length;i++)!function(rule){seq.push(aseq(function(ret){rule.migration(ret,dao)},function(ret){updateVersion(ret,rule.version)}))}(self.rules[i]);seq.length>0?aseq.apply(null,seq)(ret):ret()})})(function(){future.set(dao)}),this.SUPER()}}}),CLASS({"package":"foam.core.dao",name:"MigrationRule",ids:["modelName"],properties:[{model_:"StringProperty",name:"modelName"},{model_:"IntProperty",name:"version"},{model_:"FunctionProperty",name:"migration"}]}),CLASS({"package":"foam.dao",name:"DAOVersion",ids:["name"],properties:[{model_:"Property",name:"name"},{model_:"Property",name:"version"}]}),CLASS({"package":"foam.core.dao",name:"RestDAO",extendsModel:"AbstractDAO",imports:["ajsonp"],properties:[{model_:"Property",name:"model",label:"Type of data stored in this DAO."},{model_:"Property",name:"url",label:"REST API URL."},{model_:"ArrayProperty",name:"paramProperties",help:"Properties that are handled as separate parameters rather than in the query.",subType:"Property"},{model_:"IntProperty",name:"batchSize",defaultValue:200},{model_:"IntProperty",name:"skipThreshold",defaultValue:1e3}],methods:{jsonToObj:function(json){return this.model.create(json)},objToJson:function(obj){return JSONUtil.compact.stringify(obj)},buildURL:function(query){return this.url},buildFindURL:function(key){return this.url+"/"+key},buildPutURL:function(obj){return this.url},buildPutParams:function(obj){return[]},buildSelectParams:function(sink,query){return[]},put:function(value,sink){var self=this,extra={};this.ajsonp(this.buildPutURL(value),this.buildPutParams(value),"POST",this.objToJson(value,extra))(function(resp,status){var obj;return void 0!==status&&200!==status||!(obj=self.jsonToObj(resp,extra))?void(sink&&sink.error&&sink.error([resp,status])):(sink&&sink.put&&sink.put(obj),void self.notify_("put",[obj]))})},remove:function(query,sink){},select:function(sink,options){sink=sink||[].sink;var fut=afuture(),self=this,limit,skipped=0,index=0,fc=this.createFlowControl_(),extra={},params=[];if(options){index+=options.skip||0;var query=options.query.partialEval(),url;if(query){var origQuery=query;query=query.normalize();var outquery=[query,origQuery.deepClone()];params=this.buildSelectParams(sink,outquery),url=this.buildURL(outquery,extra),query=outquery[0],origQuery=outquery[1];var mql=query.toMQL();mql&&params.push("q="+encodeURIComponent(query.toMQL()))}else url=this.buildURL();if(options.order){var sort=options.order.toMQL();params.push("sort="+sort)}options.limit&&(limit=options.limit)}var finished=!1;return awhile(function(){return!finished},function(ret){var batch=self.batchSize;if(Number.isFinite(limit))var batch=Math.min(batch,limit);CountExpr.isInstance(sink)&&(batch=0);var myparams=params.slice();myparams.push("maxResults="+batch),myparams.push("startIndex="+index),self.ajsonp(url,myparams)(Movement.whenIdle(function(data){if(CountExpr.isInstance(sink))return sink.count=data.totalResults,finished=!0,void ret();var items=data&&data.items?data.items:[];0==items.length&&(finished=!0),index+=items.length;for(var i=0;i<items.length;i++){var item=self.jsonToObj(items[i],extra);if(!origQuery||origQuery.f(item)){if(Number.isFinite(limit)){if(0>=limit){finished=!0;break}limit--}if(fc.stopped){finished=!0;break}if(fc.errorEvt){sink.error&&sink.error(fc.errorEvt),finished=!0;break}sink&&sink.put&&sink.put(item,null,fc)}else skipped++}0>=limit&&(finished=!0),(!data||index>=data.totalResults)&&(finished=!0),skipped>=self.skipThreshold&&(finished=!0),ret()}))})(function(){sink&&sink.eof&&sink.eof(),fut.set(sink)}),fut.get},buildFindParams:function(key){return[]},find:function(key,sink){var self=this;this.ajsonp(this.buildFindURL(key),this.buildFindParams())(function(data,status){var deserialized;return 200===status&&(deserialized=self.jsonToObj(data))?void(sink&&sink.put&&sink.put(deserialized)):void(sink&&sink.error&&sink.error("Network error"))})}}}),CLASS({"package":"foam.dao",name:"LazyCacheDAO",extendsModel:"foam.dao.ProxyDAO",properties:[{model_:"Property",name:"cache",postSet:function(old,nu){old&&this.unlisten(old),nu&&this.listen(nu)
}},{model_:"BooleanProperty",name:"refreshOnCacheHit",defaultValue:!1},{model_:"BooleanProperty",name:"cacheOnSelect",defaultValue:!1},{model_:"IntProperty",name:"staleTimeout",units:"ms",defaultValue:500},{model_:"Property",name:"finds",factory:function(){return{}}},{model_:"Property",name:"selects",factory:function(){return{}}},{model_:"Property",name:"selectKey",defaultValue:function(sink,options){var query=options&&options.query&&options.query.toSQL()||"",limit=options&&options.limit,skip=options&&options.skip,order=options&&options.order&&options.order.toSQL()||"";return[query,limit,skip,order]}}],methods:{find:function(id,sink){var self=this;if(this.finds[id])return void this.finds[id].push(sink);var mysink={put:this.refreshOnCacheHit?function(){self.cache.put.apply(self.cache,arguments),sink.put.apply(sink,arguments)}:sink.put.bind(sink),error:function(){return self.finds[id]?void self.finds[id].push(sink):(self.finds[id]=[sink],void self.delegate.find(id,{put:function(obj){var args=arguments;self.cache.put(obj,{put:function(){for(var finds=self.finds[id],i=0;i<finds.length;i++){var s=finds[i];s&&s.put&&s.put.apply(s,args)}delete self.finds[id]}})},error:function(){var finds=self.finds[id];if(finds){for(var i=0;i<finds.length;i++){var s=finds[i];s&&s.error&&s.error.apply(sink,arguments)}delete self.finds[id]}}}))}};this.cache.find(id,mysink)},select:function(sink,options){function readFromCache(){self.cache.select(sink,options)(future.set)}if(!this.cacheOnSelect)return this.SUPER(sink,options);sink=sink||[].sink;var key=this.selectKey(sink,options),future=afuture(),self=this,entry=this.selects[key];return(!entry||Date.now()-this.selects[key][1]>this.staleTimeout)&&(this.selects[key]=entry=[afuture(),Date.now()],this.delegate.select(this.cache,options)(function(sink){self.notify_("reset",[]),entry[0].set(sink)})),self.cache.select(COUNT(),options)(function(c){c.count>0?readFromCache():entry[0].get(readFromCache)}),future.get}}}),CLASS({"package":"foam.apps.quickbug.dao",name:"ProjectNetworkDAO",extendsModel:"foam.core.dao.RestDAO",requires:["foam.apps.quickbug.model.imported.Project","foam.apps.quickbug.model.imported.IssuePerson","foam.apps.quickbug.model.QIssueStatus","foam.apps.quickbug.model.QIssueLabel"],properties:[{model_:"Property",name:"url",defaultValue:"https://www.googleapis.com/projecthosting/v2/projects/"},{model_:"Property",name:"model",defaultValueFn:function(){return this.X.lookup("foam.apps.quickbug.model.imported.Project")}}],methods:{buildFindURL:function(key){return this.url+key},jsonToObj:function(json){if(json.members)for(var i=0;i<json.members.length;i++)json.members[i]=this.IssuePerson.create(json.members[i]);if(json.issuesConfig){if(json.issuesConfig.statuses)for(i=0;i<json.issuesConfig.statuses.length;i++)json.issuesConfig.statuses[i]=this.QIssueStatus.create(json.issuesConfig.statuses[i]);if(json.issuesConfig.labels)for(i=0;i<json.issuesConfig.labels.length;i++)json.issuesConfig.labels[i]=this.QIssueLabel.create(json.issuesConfig.labels[i])}return this.model.create(json)}}}),CLASS({"package":"foam.apps.quickbug.model.imported",name:"Project",tableProperties:["description","domain","externalId","htmlLink","issuesConfig","kind","labels","members","name","repositoryUrls","role","summary","versionControlSystem"],properties:[{model_:"StringProperty",name:"externalId",help:"Single string identifier of the project, encoding the name and domain."},{model_:"StringProperty",name:"description",help:"Description of the project."},{model_:"StringProperty",name:"domain",help:"Domain in which this project exists."},{model_:"StringProperty",name:"htmlLink",help:"URL of the project home page."},{model_:"ReferenceProperty",name:"issuesConfig",help:"Information about how issues are handled for this project.",subType:"ProjectIssueConfig"},{model_:"StringProperty",name:"kind",help:"Project hosted by Google Code Project Hosting."},{model_:"StringArrayProperty",name:"labels",help:"Labels that have been applied to this project by the project's owners."},{model_:"StringArrayProperty",name:"members",help:"List of members of this project."},{model_:"StringProperty",name:"name",help:"Name of the project."},{model_:"StringArrayProperty",name:"repositoryUrls",help:"URLs where the source for the project can be checked out."},{model_:"StringProperty",name:"role",help:"The user's role in the project, if there is one."},{model_:"StringProperty",name:"summary",help:"Short summary of the project."},{model_:"StringProperty",name:"versionControlSystem",help:"Version control system used by the project."}]}),CLASS({"package":"foam.apps.quickbug.model",name:"QIssueStatus",ids:["status"],properties:[{model_:"Property",name:"status"},{model_:"Property",name:"description"},{model_:"BooleanProperty",name:"meansOpen"}]}),CLASS({"package":"foam.apps.quickbug.model",name:"QUser",extendsModel:"foam.apps.quickbug.model.imported.User",properties:[{model_:"StringProperty",name:"email"},{model_:"Property",name:"projects",postSet:function(_,newValue){0==this.preferredProjects.length&&(this.preferredProjects=newValue.map(function(p){return p.name}))}},{model_:"StringArrayProperty",name:"preferredProjects",preSet:function(_,a){return a.map(function(i){return Array.isArray(i)?i[0]:i})},view:"foam.ui.MultiLineStringArrayView"},{model_:"StringProperty",name:"defaultProject",defaultValue:"chromium"}]}),CLASS({"package":"foam.apps.quickbug.model.imported",name:"User",tableProperties:["id","kind","projects"],properties:[{model_:"StringProperty",name:"id",help:"User identifier."},{model_:"StringProperty",name:"kind",help:"User on Google Code Project Hosting."},{model_:"ArrayProperty",name:"projects",help:"Projects of which this user is a member.",subType:"Project"}]}),CLASS({"package":"foam.apps.quickbug.model",name:"QProject",requires:["Binding","foam.dao.CachingDAO","foam.dao.EasyDAO","foam.dao.IDBDAO","foam.dao.LazyCacheDAO","MDAO","PersistentContext","Timer","foam.apps.quickbug.dao.IssueRestDAO","foam.apps.quickbug.dao.QIssueCommentNetworkDAO","foam.apps.quickbug.dao.QIssueCommentUpdateDAO","foam.apps.quickbug.dao.SyncManager","foam.apps.quickbug.model.DefaultQuery","foam.apps.quickbug.model.LabelArrayProperty","foam.apps.quickbug.model.LabelStringEnumProperty","foam.apps.quickbug.model.LabelStringProperty","foam.apps.quickbug.model.QIssueComment","foam.apps.quickbug.model.QIssueCommentUpdate","foam.apps.quickbug.model.QIssueLabel","foam.apps.quickbug.model.QIssueStatus","foam.apps.quickbug.model.imported.Issue","foam.apps.quickbug.model.imported.IssuePerson","foam.core.dao.MigrationRule","foam.lib.bookmarks.Bookmark","foam.core.dao.WhenIdleDAO","foam.metrics.Metric"],imports:["metricDAO"],exports:["IssueCommentDAO as qIssueCommentDAO","StatusDAO as issueStatusDAO","StatusDAO as StatusDAO","LabelDAO as issueLabelDAO","LabelDAO as LabelDAO","PersonDAO as issuePersonDAO","PersonDAO as PersonDAO","openPredicate","QueryParser"],tableProperties:["projectName","baseURL"],properties:[{model_:"Property",name:"qbug"},{model_:"Property",name:"project"},{model_:"Property",name:"baseURL",defaultValue:"https://code.google.com/p/"},{model_:"Property",name:"projectName",defaultValueFn:function(){return this.project.name}},{model_:"Property",name:"summary",defaultValueFn:function(){return this.project.summary}},{model_:"Property",name:"user",defaultValueFn:function(){return this.qbug.user}},{model_:"Property",name:"openPredicate",lazyFactory:function(){for(var ss=this.project.issuesConfig.statuses,os=[],i=0;i<ss.length;i++){var s=ss[i];s.meansOpen||os.push(s.status)}return"-status="+os.join(",")}},{model_:"Property",name:"LabelDAO",factory:function(){var dao=this.MDAO.create({model:this.QIssueLabel});return this.project.issuesConfig&&this.project.issuesConfig.labels.select(dao),dao},help:"DAO of known labels."},{model_:"Property",name:"StatusDAO",factory:function(){var dao=this.MDAO.create({model:this.QIssueStatus});return this.project.issuesConfig&&this.project.issuesConfig.statuses.select(dao),dao},help:"DAO of known statuses."},{model_:"Property",name:"PersonDAO",factory:function(){var dao=this.MDAO.create({model:this.IssuePerson});return this.project.members.select(dao),dao},help:"DAO of known people."},{model_:"Property",name:"IssueMDAO",lazyFactory:function(){var dao=this.MDAO.create({model:this.QIssueModel},this.Y),auto=this.X.AutoIndex.create(dao,this.Y);return auto.addIndex(this.QIssueModel.STATUS),dao.addRawIndex(auto),dao}},{model_:"Property",name:"IssueIDBDAO","transient":!0,lazyFactory:function(){return this.EasyDAO.create({model:this.QIssueModel,name:this.projectName+"_"+this.QIssueModel.plural,migrationRules:[this.MigrationRule.create({modelName:"QIssue",version:120,migration:function(ret,dao){console.log("Migrating to ",this.version),dao.removeAll()(ret)}})]})}},{model_:"Property",name:"IssueCachingDAO","transient":!0,lazyFactory:function(){return console.log("Creating IssueCachingDAO."),this.CachingDAO.create({cache:this.IssueMDAO,src:this.IssueIDBDAO},this.Y)}},{model_:"Property",name:"IssueCommentNetworkDAO",lazyFactory:function(){return this.LazyCacheDAO.create({model:this.QIssueComment,cacheOnSelect:!0,cache:this.IDBDAO.create({model:this.QIssueComment,name:this.projectName+"_"+this.QIssueComment.plural,useSimpleSerialization:!1}).addIndex(this.QIssueComment.ISSUE_ID),delegate:this.QIssueCommentNetworkDAO.create({model:this.QIssueComment,url:"https://www.googleapis.com/projecthosting/v2/projects/"+this.projectName+"/issues"})})}},{model_:"foam.core.types.DAOProperty",name:"IssueCommentDAO",factory:function(){return this.WhenIdleDAO.create({delegate:this.QIssueCommentUpdateDAO.create({delegate:this.IssueCommentNetworkDAO})})}},{model_:"Property",name:"IssueNetworkDAO","transient":!0,lazyFactory:function(){return this.IssueRestDAO.create({url:"https://www.googleapis.com/projecthosting/v2/projects/"+this.projectName+"/issues",IssueCommentDAO:this.IssueCommentNetworkDAO,model:this.QIssueModel,batchSize:500})},postSet:function(_,v){this.IssueCommentDAO.delegate.IssueNetworkDAO=v}},{model_:"Property",name:"IssueDAO","transient":!0,lazyFactory:function(){return this.IssueCachingDAO}},{model_:"Property",name:"bookmarkDAO","transient":!0,lazyFactory:function(){var newDAO=this.EasyDAO.create({model:this.Bookmark,name:this.projectName+"_"+this.Bookmark.plural,cache:!0,guid:!0,daoType:"SYNC"}).orderBy(this.Bookmark.ID),oldDAO=this.EasyDAO.create({model:this.Bookmark,name:this.projectName+"_"+this.Bookmark.plural,cache:!0});return oldDAO.select({put:function(bookmark){bookmark.id="",newDAO.put(bookmark)}})(function(){oldDAO.removeAll()}),newDAO}},{model_:"Property",name:"issueCount"},{model_:"Property",name:"url",defaultValueFn:function(){return this.baseURL+this.projectName}},{model_:"Property",name:"timer","transient":!0,factory:function(){return this.Timer.create()}},{model_:"Property",name:"persistentContext",lazyFactory:function(){return this.PersistentContext.create({dao:this.IDBDAO.create({model:this.Binding,name:"QProject-"+this.projectName+"-Bindings"}),predicate:NOT_TRANSIENT,context:this})}},{model_:"Property",name:"syncManager"},{model_:"Property",name:"syncManagerFuture",factory:function(){return afuture()}},{model_:"Property",name:"defaultSortChoices",lazyFactory:function(){return[[DESC(this.QIssueModel.MODIFIED),"Last modified"],[this.QIssueModel.PRI,"Priority"],[DESC(this.QIssueModel.ID),"Issue ID"]]}},{model_:"Property",name:"defaultFilterChoices",factory:function(){var open="status=Accepted,Assigned,Available,New,Started,Unconfirmed,Untriaged";return[[open,"OPEN ISSUES"],[open+" is:starred","STARRED"],[open+" owner=me","OWNED BY ME"]]}},{model_:"Property",name:"QIssueModel",factory:function(){function isPropertyLabel(l){if(l in propertyLabels_)return propertyLabels_[l];var keyValue=l.match(/([^\-]*)\-(.*)/)||l.match(/(\D*)(.*)/);if(keyValue){var key=labelToProperty[keyValue[1]],value=keyValue[2];if(key){var kv=[key,value.intern()];return propertyLabels_[l]=kv,kv}}return propertyLabels_[l]=!1}var labelToProperty={App:"app",Type:"type",Milestone:"m",Mstone:"m",M:"m",Cr:"cr",Iteration:"iteration",Week:"week",ReleaseBlock:"releaseBlock",OS:"OS",MovedFrom:"movedFrom",Pri:"pri",Priority:"priority"},propertyLabels_={},model=Model.create({extendsModel:"foam.apps.quickbug.model.imported.Issue",name:"QIssue",tableProperties:["starred","id","priority","m","iteration","releaseBlock","cr","status","owner","summary","OS","modified"],ids:["id"],properties:[{model_:"IntProperty",name:"id",shortName:"i",label:"ID",required:!0,tableWidth:"48px",tableFormatter:function(value,row,table){var id=table.nextID();return table.on("mouseover",function(e){table.browser.preview(e,value)},id),'<div id="'+id+'">'+value+"</div>"}},{name:"labels",shortName:"l",aliases:["label"],type:"String",view:"foam.apps.quickbug.ui.QIssueLabelsView",autocompleter:"foam.apps.quickbug.model.LabelCompleter",tableFormatter:function(a,row){for(var s="",i=0;i<a.length;i++)isPropertyLabel(a[i])||(s+=' <span class="label">'+a[i]+"</span>");return s},preSet:function(_,a){for(var i=0;i<a.length;i++)a[i]=a[i].intern();return a.sort()},postSet:function(_,a){for(var newValues={},i=0;i<this.model_.properties_.length;i++){var p=this.model_.properties_[i];"LabelArrayProperty"===p.name_?newValues[p.name]=[]:"LabelStringProperty"===p.name_&&(newValues[p.name]="")}for(var i=0;i<a.length;i++){var kv=isPropertyLabel(a[i]);kv&&("movedFrom"===kv[0]&&(kv[1]="string"==typeof kv[1]?parseInt("M"===kv[1].charAt(0)?kv[1].substring(1):kv[1]):kv[1]),newValues[kv[0]]=Array.isArray(newValues[kv[0]])?newValues[kv[0]].binaryInsert(kv[1]):kv[1])}for(var key in newValues){var value=newValues[key];this[key].compareTo(value)&&(this[key]=value)}}},{name:"author",preSet:function(_,a){return a.intern()},aliases:["reporter"]},{model_:"foam.apps.quickbug.model.LabelStringEnumProperty",name:"priority",tableLabel:"Priority",tableWidth:"60px",compareProperty:function(p1,p2){var priorities=["Low","Medium","High","Critical"],i1=priorities.indexOf(p1),i2=priorities.indexOf(p2);if(0>i1&&0>i2)return p1===p2?0:p2>p1?-1:1;if(0>i1)return 1;if(0>i2)return-1;var r=i2-i1;return 0===r?0:0>r?-1:1},choices:["Low","Medium","High","Critical"]},{model_:"foam.apps.quickbug.model.LabelStringEnumProperty",name:"pri",tableLabel:"Pri",tableWidth:"60px",compareProperty:function(p1,p2){return 0===p1.length&&0!=p2.length?1:0===p2.length&&0!=p1.length?-1:p1.compareTo(p2)},choices:[["0","Priority 0 -- Critical"],["1","Priority 1 -- High"],["2","Priority 2 -- Medium"],["3","Priority 3 -- Low"]]},{model_:"StringProperty",name:"metaPriority",compareProperty:"chromium"==this.projectName?function(p1,p2){return 0===p1.length&&0!=p2.length?1:0===p2.length&&0!=p1.length?-1:p1.compareTo(p2)}:function(p1,p2){var priorities=["Low","Medium","High","Critical"],i1=priorities.indexOf(p1),i2=priorities.indexOf(p2);if(0>i1&&0>i2)return p1===p2?0:p2>p1?-1:1;if(0>i1)return 1;if(0>i2)return-1;var r=i2-i1;return 0===r?0:0>r?-1:1},getter:"chromium"==this.projectName?function(){return this.pri}:function(){return this.priority},setter:"chromium"==this.projectName?function(value){this.pri=value}:function(value){this.priority=value}},{model_:"foam.apps.quickbug.model.LabelArrayProperty",name:"app",tableWidth:"70px"},{model_:"foam.apps.quickbug.model.LabelArrayProperty",name:"type",tableWidth:"70px"},{model_:"foam.apps.quickbug.model.LabelArrayProperty",name:"m",label:"Milestone",aliases:["mstone","milestone"],tableLabel:"M",tableWidth:"70px"},{model_:"foam.apps.quickbug.model.LabelArrayProperty",name:"iteration",shortName:"it",aliases:["iter"],tableWidth:"69px"},{model_:"foam.apps.quickbug.model.LabelArrayProperty",name:"week",tableWidth:"69px"},{model_:"foam.apps.quickbug.model.LabelArrayProperty",name:"releaseBlock",shortName:"rb",aliases:["rBlock","release"],type:"String",tableWidth:"103px",defaultValue:""},{model_:"foam.apps.quickbug.model.LabelArrayProperty",name:"cr",shortName:"c",aliases:["cat","cr"],label:"Cr",tableWidth:"87px"},{model_:"StringProperty",name:"status",shortName:"s",aliases:["stat"],type:"String",preSet:function(_,s){return s.capitalize()},tableWidth:"58px",autocompleter:"foam.apps.quickbug.model.StatusCompleter",defaultValue:""},{model_:"StringArrayProperty",name:"cc",autocompleter:"foam.apps.quickbug.model.PersonCompleter",displayWidth:70},{name:"owner",shortName:"o",tableWidth:"181px",type:"String",autocompleter:"foam.apps.quickbug.model.PersonCompleter",preSet:function(_,a){return a.intern()}},{name:"summary",shortName:"su",label:"Summary",type:"String",tableWidth:"350px",displayWidth:70,tableFormatter:function(value,row,tableView){return tableView.strToHTML(value)}},{name:"description",displayHeight:20,displayWidth:70},{name:"summaryPlusLabels",label:"Summary + Labels",tableLabel:"Summary + Labels",type:"String",tableWidth:"100%",tableFormatter:function(value,row,tableView){return tableView.strToHTML(row.summary)+value.model_.LABELS.tableFormatter(row.labels,row)}},{model_:"foam.apps.quickbug.model.LabelArrayProperty",name:"OS",tableWidth:"61px",type:"String"},{model_:"BooleanProperty",name:"blocked",tableWidth:"20px",getter:function(){return!!this.blockedOn.length}},{model_:"DateTimeProperty",name:"modified",shortName:"mod",mode:"read-write",required:!0,tableWidth:"100px",factory:function(){return new Date}},{name:"updated",hidden:!0,setter:function(v){this.modified=v}},{model_:"BooleanProperty",name:"starred",tableLabel:"",tableWidth:"18px",tableFormatter:function(val,obj,tableView){var view=CSSImageBooleanView.create({className:"star-image",data:obj.starred});return view.data$.addListener(function(){var tmp=obj.clone();tmp.starred=view.data,tableView.browser.IssueDAO.put(tmp)}),tableView.addChild(view),view.toHTML()},view:{factory_:"CSSImageBooleanView",className:"star-image"},help:"Whether the authenticated user has starred this issue."},{model_:"IntProperty",name:"stars",tableWidth:"20px",help:"Number of stars this issue has.",compareProperty:function(o2,o1){return o1===o2?0:o1>o2?1:-1}},{model_:"foam.apps.quickbug.model.LabelArrayProperty",name:"movedFrom",tableWidth:"100px"},{name:"movedTo",preSet:function(_,v){return[]}},{model_:"StringProperty",name:"content",displayHeight:4}],methods:{replaceLabels:function(label,values){var prefix=label+"-",labels=this.labels.filter(function(l){return!l.startsWith(prefix)});if(Array.isArray(values))for(var i=0;i<values.length;i++)labels.binaryInsert(label+"-"+values[i]);else labels.binaryInsert(label+"-"+values);this.labels.compareTo(labels)&&(this.labels=labels)},isOpen:function(){return!!{New:!0,Accepted:!0,Started:!0,Untriaged:!0}[this.status]},writeActions:function(other,out){function convertArray(key){if(!diff[key])return void(diff[key]=[]);for(var delta=diff[key].added,i=0;i<diff[key].removed.length;i++)delta.push("-"+diff[key].removed[i]);diff[key]=delta}var diff=this.diff(other);if(delete diff.starred,0!=Object.keys(diff).length){delete diff.stars,convertArray("blockedOn"),convertArray("blocking"),convertArray("cc"),convertArray("labels"),convertArray("m"),convertArray("iteration"),convertArray("week");var empty=!0;for(var key in diff)if(!Array.isArray(diff[key])||diff[key].length>0){empty=!1;break}if(!empty){var comment=this.X.lookup("foam.apps.quickbug.model.QIssueComment").create({issueId:this.id,content:other.content,updates:this.X.lookup("foam.apps.quickbug.model.QIssueCommentUpdate").create(diff)},this.Y);out(comment)}}},newComment:function(){return this.X.lookup("foam.apps.quickbug.model.QIssueComment").create({issueId:this.id,updates:this.X.lookup("foam.apps.quickbug.model.QIssueCommentUpdate").create({labels:this.labels.clone(),owner:this.owner,blockedOn:this.blockedOn.clone(),blocking:this.blocking.clone(),cc:this.cc.clone(),mergedInto:this.mergedInto,status:this.status,summary:this.summary})},this.Y)}},relationships:[{name:"comments",label:"Comments on this issue.",relatedModel:"foam.apps.quickbug.model.QIssueComment",relatedProperty:"issueId"}]});return model.getPrototype(),model.properties_.forEach(function(p){p.tableFormatter||(p.tableFormatter=function(v){return v||"----"})}),model.LABELS.toMQL=function(){return"label"},model.AUTHOR.toMQL=function(){return"reporter"},model},postSet:function(_,m){this.X.registerModel(m)}},{model_:"Property",name:"QueryParser",factory:function(){var parser={X:this.Y,__proto__:QueryParserFactory(this.QIssueModel),isOpen:literal_ic("is:open"),stars:seq(literal_ic("stars:"),sym("number")),labelMatch:seq(sym("fieldname"),alt(":","="),sym("valueList")),summary:str(plus(notChar(" ")))}.addActions({isOpen:function(v){return this.X.QueryParser.parseString(this.X.openPredicate)},stars:function(v){return GTE({f:function(i){return i.stars},partialEval:function(){return this},toSQL:function(){return"stars > "+v[1]},toMQL:function(){return"stars > "+v[1]}},v[1])},labelMatch:function(v){for(var a=[],i=2;i<v.length;i++)a.push(v[0]+"-"+v[i]);return IN(this.X.QIssue.LABELS,a).partialEval()},summary:function(v){return this.X.lookup("foam.apps.quickbug.model.DefaultQuery").create({arg1:v})}});return parser.expr=alt(sym("isOpen"),parser["export"]("expr"),sym("stars"),sym("labelMatch"),sym("summary")),parser}}],methods:{init:function(args){this.SUPER(args),"chromium"!==this.projectName&&(this.defaultSortChoices=[[DESC(this.QIssueModel.MODIFIED),"Last modified"],[this.QIssueModel.PRIORITY,"Priority"],[DESC(this.QIssueModel.ID),"Issue ID"]]),this.X.DontSyncProjectData||(this.IssueDAO.listen(this.onDAOUpdate),this.persistentContext.bindObject("syncManager",this.SyncManager.xbind({syncInterval:300,batchSize:500}),{queryParser:this.QueryParser,srcDAO:this.IssueNetworkDAO,dstDAO:this.IssueCachingDAO,modifiedProperty:this.QIssueModel.MODIFIED},2)(function(manager){this.syncManager=manager,this.syncManagerFuture.set(manager),manager.start()}.bind(this)))},launchBrowser:function(opt_url){var self=this;chrome.app.window.create("empty.html",{width:1e3,height:800},function(w){w.contentWindow.onload=function(){var window=self.window=w.contentWindow;arequire("foam.apps.quickbug.ui.ChromeAppBrowser")(function(model){$addWindow(window);var Y=self.Y.subWindow(window,"Browser Window"),b=model.create({project:self},Y);Y.touchManager=Y.foam.input.touch.TouchManager.create({},Y),window.document.firstChild.innerHTML=b.toHTML(),b.initHTML(),opt_url&&b.maybeSetLegacyUrl(opt_url),w.focus(),self.metricDAO.put(self.Metric.create({name:"browserLaunched"}))})},w.onClosed.addListener(function(){$removeWindow(window)})})},createBrowser:function(window){var b=this.X.Browser.create({project:this,window:window},this.Y);return window.browser=b,b},launchSync:function(){var self=this;this.syncManagerFuture.get(function(syncManager){chrome.app.window.create("empty.html",{width:600,height:600},function(w){var window=w.contentWindow;w.contentWindow.onload=function(){$addWindow(window);var Y=self.Y.subWindow(window,"Sync Config"),b=Y.DetailView.create({model:Y.SyncManager,title:'<img style="vertical-align:bottom;" src="images/refresh.png"> Sync Config: '+self.projectName,data:syncManager,showActions:!0});window.document.body.innerHTML="<div>"+b.toHTML()+"</div>",b.initHTML();var extrax=window.outerWidth-window.innerWidth+16,extray=window.outerHeight-window.innerHeight+16;window.resizeTo(window.document.body.firstChild.firstChild.firstChild.offsetWidth+extrax,window.document.body.firstChild.offsetHeight+extray),window.resizeTo(window.document.body.firstChild.firstChild.firstChild.offsetWidth+extrax,window.document.body.firstChild.offsetHeight+extray),w.focus()},w.onClosed.addListener(function(){$removeWindow(window)})})}.bind(this))},launchConfigProjects:function(){var self=this;chrome.app.window.create("empty.html",{width:430,height:440},function(w){var window=w.contentWindow;w.contentWindow.onload=function(){$addWindow(window);var view=ConfigureProjectsView.create({model:QUser});view.data=self.user,window.document.body.innerHTML=view.toHTML(),view.initHTML(),w.focus()},w.onClosed.addListener(function(){$removeWindow(window)})})}},listeners:[{model_:"Method",name:"onDAOUpdate",code:function(){this.IssueMDAO.select(COUNT())(function(c){this.issueCount=c.count}.bind(this));var self=this;this.IssueMDAO.select(GROUP_BY(this.QIssueModel.CC,COUNT()))(function(g){Object.keys(g.groups).forEach(function(key){self.PersonDAO.find(key,{error:function(){self.PersonDAO.put(self.IssuePerson.create({name:key}))}})})})},isMerged:16}]}),CLASS({"package":"foam.dao",name:"CachingDAO",extendsModel:"foam.dao.ProxyDAO",requires:["foam.dao.FutureDAO"],properties:[{model_:"Property",name:"src"},{model_:"Property",name:"cache",getter:function(){return this.delegate},setter:function(dao){this.delegate=dao},help:"Alias for delegate."},{model_:"Property",name:"model",defaultValueFn:function(){return this.src.model||this.cache.model}}],methods:{init:function(){this.SUPER();var src=this.src,cache=this.cache,futureDelegate=afuture();this.cache=this.FutureDAO.create({future:futureDelegate.get}),src.select(cache)(function(){src.listen(cache),futureDelegate.set(cache),this.cache=cache}.bind(this))},put:function(obj,sink){this.src.put(obj,sink)},remove:function(query,sink){this.src.remove(query,sink)},removeAll:function(sink,options){return this.src.removeAll(sink,options)}}}),CLASS({"package":"foam.dao",name:"EasyDAO",extendsModel:"foam.dao.ProxyDAO",requires:["MDAO","foam.core.dao.MigrationDAO","foam.core.dao.StorageDAO","foam.dao.CachingDAO","foam.dao.GUIDDAO","foam.dao.SeqNoDAO","foam.dao.ContextualizingDAO","foam.core.dao.CloningDAO"],properties:[{model_:"Property",name:"name",defaultValueFn:function(){return this.model.plural}},{model_:"BooleanProperty",name:"seqNo",defaultValue:!1},{model_:"BooleanProperty",name:"guid",label:"GUID",defaultValue:!1},{model_:"Property",name:"seqProperty",type:"Property"},{model_:"BooleanProperty",name:"cache",defaultValue:!1},{model_:"BooleanProperty",name:"logging",defaultValue:!1},{model_:"BooleanProperty",name:"timing",defaultValue:!1},{model_:"BooleanProperty",name:"contextualize",defaultValue:!1},{model_:"BooleanProperty",name:"cloning",defaultValue:!1},{model_:"Property",name:"daoType",defaultValue:"foam.dao.IDBDAO"},{model_:"BooleanProperty",name:"autoIndex",defaultValue:!1},{model_:"ArrayProperty",name:"migrationRules",subType:"foam.core.dao.MigrationRule"}],constants:[{model_:"Constant",name:"ALIASES",value:{IDB:"foam.dao.IDBDAO",LOCAL:"foam.core.dao.StorageDAO",SYNC:"foam.core.dao.StorageDAO"}}],methods:{init:function(args){this.SUPER(args),window.chrome&&chrome.storage&&(this.ALIASES.LOCAL="foam.core.dao.ChromeStorageDAO",this.ALIASES.SYNC="foam.core.dao.ChromeSyncStorageDAO");var daoType="string"==typeof this.daoType?this.ALIASES[this.daoType]||this.daoType:this.daoType,daoModel="string"==typeof daoType?this.X.lookup(daoType):daoType,params={model:this.model,autoIndex:this.autoIndex};this.name&&(params.name=this.name),(this.seqNo||this.guid)&&(params.property=this.seqProperty);var dao=daoModel.create(params);if(MDAO.isInstance(dao)?this.mdao=dao:(this.migrationRules&&this.migrationRules.length&&(dao=this.MigrationDAO.create({delegate:dao,rules:this.migrationRules,name:this.model.name+"_"+daoModel.name+"_"+this.name},this.Y)),this.cache&&(this.mdao=this.MDAO.create(params),dao=this.CachingDAO.create({cache:this.mdao,src:dao,model:this.model}))),this.seqNo&&this.guid)throw"EasyDAO 'seqNo' and 'guid' features are mutually exclusive.";if(this.seqNo){var args={__proto__:params,delegate:dao,model:this.model};this.seqProperty&&(args.property=this.seqProperty),dao=this.SeqNoDAO.create(args)}if(this.guid){var args={__proto__:params,delegate:dao,model:this.model};this.seqProperty&&(args.property=this.seqProperty),dao=this.GUIDDAO.create(args)}this.contextualize&&(dao=this.ContextualizingDAO.create({delegate:dao})),this.cloning&&(dao=this.CloningDAO.create({delegate:dao})),this.timing&&(dao=TimingDAO.create(this.name+"DAO",dao)),this.logging&&(dao=LoggingDAO.create(dao)),this.delegate=dao},addIndex:function(){return this.mdao&&this.mdao.addIndex.apply(this.mdao,arguments),this},addRawIndex:function(){return this.mdao&&this.mdao.addRawIndex.apply(this.mdao,arguments),this}},help:"A facade for easy DAO setup."}),CLASS({"package":"foam.core.dao",name:"StorageDAO",extendsModel:"MDAO",properties:[{model_:"Property",name:"name",label:"Store Name",type:"String",defaultValueFn:function(){return this.model.plural}}],methods:{init:function(){this.SUPER();var objs=localStorage.getItem(this.name);objs&&JSONUtil.parse(this.Y,objs).select(this),this.addRawIndex({execute:function(){},bulkLoad:function(){},toString:function(){return"StorageDAO Update"},plan:function(){return{cost:Number.MAX_VALUE}},put:this.updated,remove:this.updated})}},listeners:[{model_:"Method",name:"updated",code:function(){this.select()(function(a){localStorage.setItem(this.name,JSONUtil.compact.where(NOT_TRANSIENT).stringify(a))}.bind(this))},isMerged:100}]}),CLASS({"package":"foam.dao",name:"GUIDDAO",label:"foam.dao.GUIDDAO",extendsModel:"foam.dao.ProxyDAO",properties:[{model_:"Property",name:"property",type:"Property",required:!0,hidden:!0,"transient":!0,defaultValueFn:function(){return this.delegate.model?this.delegate.model.ID:void 0}}],methods:{put:function(obj,sink){obj.hasOwnProperty(this.property.name)||(obj[this.property.name]=createGUID()),this.delegate.put(obj,sink)}}}),CLASS({"package":"foam.dao",name:"SeqNoDAO",label:"foam.dao.SeqNoDAO",extendsModel:"foam.dao.ProxyDAO",properties:[{model_:"Property",name:"property",type:"Property",required:!0,hidden:!0,"transient":!0,defaultValueFn:function(){return this.delegate.model?this.delegate.model.ID:void 0}},{model_:"IntProperty",name:"sequenceValue",defaultValue:1}],methods:{init:function(){this.SUPER();var future=afuture();this.WHEN_READY=future.get,this.delegate.select(MAX(this.property))(function(max){max.max&&(this.sequenceValue=max.max+1),future.set(!0)}.bind(this))},put:function(obj,sink){this.WHEN_READY(function(){var val=this.property.f(obj);val==this.property.defaultValue&&(obj[this.property.name]=this.sequenceValue++),this.delegate.put(obj,sink)}.bind(this))}}}),CLASS({"package":"foam.dao",name:"ContextualizingDAO",extendsModel:"foam.dao.ProxyDAO",methods:{find:function(id,sink){var X=this.Y;this.delegate.find(id,{put:function(o){o.X=X,sink&&sink.put&&sink.put(o)},error:function(){sink&&sink.error&&sink.error.apply(sink,arguments)}})}}}),CLASS({"package":"foam.core.dao",name:"CloningDAO",extendsModel:"foam.dao.ProxyDAO",properties:[{model_:"BooleanProperty",name:"onSelect",defaultValue:!1}],methods:{select:function(sink,options){if(!this.onSelect)return this.SUPER(sink,options);sink=sink||[].sink;var future=afuture();return this.delegate.select({put:function(obj,s,fc){obj=obj.deepClone(),sink.put&&sink.put(obj,s,fc)},error:function(){sink.error&&sink.error.apply(sink,argumentS)},eof:function(){sink.eof&&sink.eof(),future.set(sink)}},options),future.get},find:function(key,sink){return this.SUPER(key,{put:function(o){var clone=o.deepClone();sink&&sink.put&&sink.put(clone)},error:sink&&sink.error&&sink.error.bind(sink)})}}}),CLASS({"package":"foam.apps.quickbug.dao",name:"IssueRestDAO",extendsModel:"foam.core.dao.RestDAO",requires:["foam.apps.quickbug.model.DefaultQuery"],properties:[{model_:"Property",name:"QIssue",factory:function(){return this.X.QIssue}},{model_:"Property",name:"IssueCommentDAO",help:"The associated IssueCommentDAO.  Required for updates to work."}],methods:{jsonToObj:function(json){if(json.cc)for(var i=0;i<json.cc.length;i++)json.cc[i]=json.cc[i].name;return json.owner&&(json.owner=json.owner.name),json.author&&(json.author=json.author.name),json.blocking&&(json.blocking=json.blocking.map(function(b){return b.issueId})),json.blockedOn&&(json.blockedOn=json.blockedOn.map(function(b){return b.issueId})),json.mergedInto&&(json.mergedInto=json.mergedInto.issueId),json.state&&(json.state=json.state.intern()),json.status&&(json.status=json.status.intern()),json.summary==json.title&&(json.summary=json.title),delete json.kind,delete json.projectId,delete json.movedFrom,json.labels&&(json.labels=json.labels.intern()),json.closed&&(json.closed=new Date(json.closed)),json.updated&&(json.updated=new Date(json.updated)),json.published&&(json.published=new Date(json.published)),this.model.create(json)
},objToJson:function(obj,extra){var data=JSON.parse(this.SUPER(obj));return data.owner&&(data.owner={name:data.owner}),JSON.stringify(data)},buildSelectParams:function(sink,outquery){function stripDefaultQuery(m){if(defaultQuery.isInstance(m))return TRUE;if(m.args)for(var i=0;i<m.args.length;i++)m.args[i]=stripDefaultQuery(m.args[i]);return m}var query=outquery[0];if(!query)return[];var candidates=[],updatedMin,required=1;if(GtExpr.isInstance(query)&&query.arg1===this.QIssue.MODIFIED)updatedMin=query.arg2.arg1.getTime(),query=TRUE;else if(AndExpr.isInstance(query))for(var j=0;j<query.args.length;j++){var arg=query.args[j];GtExpr.isInstance(arg)&&arg.arg1===this.QIssue.MODIFIED&&candidates.push([arg.arg2.arg1.getTime(),[[query,j]]])}else if(OrExpr.isInstance(query)){required=query.args.length;for(var i=0;i<query.args.length;i++){var arg=query.args[i];if(AndExpr.isInstance(arg))for(j=0;j<arg.args.length;j++){var subarg=arg.args[j];if(GtExpr.isInstance(subarg)&&subarg.arg1===this.QIssue.MODIFIED){for(var k=0;k<candidates.length;k++)candidates[k][0]===subarg.arg2.arg1.getTime()&&candidates[k][1].push([arg,j]);k===candidates.length&&candidates.push([subarg.arg2.arg1.getTime(),[[arg,j]]])}}else if(GtExpr.isInstance(arg)&&arg.arg1===this.QIssue.MODIFIED){for(k=0;k<candidates.length;k++)candidates[k][0]===arg.arg2.arg1.getTime()&&candidates[k][1].push([query,i]);k===candidates.length&&candidates.push([arg.arg2.arg1.getTime(),[[query,i]]])}}}for(k=0;k<candidates.length;k++)if(candidates[k][1].length===required){for(updatedMin=candidates[k][0],i=0;i<candidates[k][1].length;i++)candidates[k][1][i][0].args[candidates[k][1][i][1]]=TRUE;break}outquery[0]=query.partialEval();var defaultQuery=this.DefaultQuery;return outquery[1]=stripDefaultQuery(outquery[1]).partialEval(),updatedMin?["updatedMin="+Math.floor(updatedMin/1e3)]:[]},put:function(issue,sink){var self=this,super_=this.SUPER;aseq(apar(function(ret){issue.id?self.find(issue.id,ret):ret()},function(ret){if(!issue.id)return void ret();var star=issue.starred?"/star":"/unstar";self.X.ajsonp(self.url+"/"+issue.id+star,void 0,"POST")(ret)}),function(ret,existing){aif(!existing,function(ret){super_.call(self,issue,sink),ret()},aseq(function(ret){var actions=[];existing.writeActions(issue,function(a){actions.push(function(ret){self.IssueCommentDAO.put(a,ret)})}),actions.length?aseq.apply(null,actions)(ret):ret()},function(ret){self.find(issue.id,ret)},function(ret,result){sink&&(result?sink.put&&sink.put(result):sink.error&&sink.error("put",issue)),result&&self.notify_("put",[result]),ret()}))(ret)})(function(){})},invalidate:function(id){var self=this;this.find(id,{put:function(issue){self.notify_("put",[issue])}})}}}),CLASS({"package":"foam.apps.quickbug.dao",name:"QIssueCommentNetworkDAO",extendsModel:"foam.core.dao.RestDAO",requires:["foam.apps.quickbug.model.QIssueComment"],properties:[{model_:"Property",name:"IssueDAO"}],methods:{buildURL:function(outquery,extra){var query=outquery[0];if(!query)return this.url;var id;if(EqExpr.isInstance(query)&&query.arg1===this.QIssueComment.ISSUE_ID&&(id=query.arg2.arg1,query=TRUE),OrExpr.isInstance(query))for(var i=0;i<query.args.length;i++){var arg=query.args[i];if(AndExpr.isInstance(arg))for(var j=0;j<arg.args.length;j++){var subarg=arg.args[j];EqExpr.isInstance(subarg)&&subarg.arg1===this.X.QIssue.ISSUE_ID&&(id&&subarg.arg2.arg1===id&&(id=subarg.arg2.arg1),arg.args[j]=TRUE)}else EqExpr.isInstance(arg)&&arg.arg1===this.X.QIssue.ISSUE_ID&&(id=arg.arg2.arg1,query.args[i]=TRUE)}return extra.issueId=id,outquery[0]=query.partialEval(),this.url+"/"+id+"/comments"},jsonToObj:function(obj,extra){var obj=this.SUPER(obj);return obj.issueId=extra.issueId,obj.seqNo=obj.id,obj.id=obj.id+"_"+extra.issueId,obj},objToJson:function(obj,extra){obj.content||(obj.content="(No comment was entered for this change.)"),extra.issueId=obj.issueId;var json=JSONUtil.where(IN(Property.NAME,["author","content","published","updates","cc","labels","owner","status","summary"])).stringify(obj);return json},buildPutURL:function(obj){return this.url+"/"+obj.issueId+"/comments"}}}),CLASS({"package":"foam.apps.quickbug.dao",name:"QIssueCommentUpdateDAO",extendsModel:"foam.dao.ProxyDAO",properties:[{model_:"Property",name:"IssueNetworkDAO"}],methods:{put:function(obj,sink){var issueDAO=this.IssueNetworkDAO;this.SUPER(obj,{put:function(o){issueDAO.invalidate(obj.issueId),sink&&sink.put&&sink.put(o)},error:function(){sink&&sink.error&&sink.error.apply(sink,arguments)}})}},help:"Decorates a comment dao, and on put, updates an associated issue dao."}),CLASS({"package":"foam.apps.quickbug.dao",name:"SyncManager",properties:[{model_:"Property",name:"queryParser",hidden:!0,"transient":!0},{model_:"Property",name:"srcDAO",label:"Source DAO",type:"DAO",hidden:!0,"transient":!0},{model_:"Property",name:"dstDAO",label:"Destination DAO",type:"DAO",hidden:!0,"transient":!0},{model_:"Property",name:"modifiedProperty",type:"Property",hidden:!0,"transient":!0},{model_:"IntProperty",name:"itemsSynced",help:"Number of items synced."},{model_:"IntProperty",name:"timesSynced",help:"Number of times sync has been performed."},{model_:"IntProperty",name:"syncInterval",units:"s",help:"Delay after empty sync response.",defaultValue:60},{model_:"IntProperty",name:"delay",label:"Delay",units:"s",help:"Delay after a non-empty sync response.",defaultValue:0},{model_:"IntProperty",name:"batchSize",help:"Maximum number of items per sync request; 0 for unlimited.",defaultValue:0},{model_:"StringProperty",name:"syncStatus","transient":!0,displayWidth:40,help:"Current status of the sync process."},{model_:"IntProperty",name:"lastBatchSize","transient":!0,help:"Number of item updates returned in last sync response."},{model_:"DateTimeProperty",name:"lastSync",factory:function(){return new Date},help:"The time of the last sync."},{model_:"DateTimeProperty",name:"lastModified","transient":!0,factory:function(){return new Date},help:"The time of the last sync."},{model_:"IntProperty",name:"lastSyncDuration",units:"ms","transient":!0,help:"Duration of last sync request."},{model_:"BooleanProperty",name:"enabled","transient":!0,help:"If the Sync Manager is currently enabled to perform periodic sync requests."},{model_:"BooleanProperty",name:"isSyncing","transient":!0,help:"If the Sync Manager is currently syncing."},{model_:"StringProperty",name:"lastId","transient":!0,help:"The id of the last item synced."},{model_:"StringProperty",name:"query",displayWidth:33,help:"Only sync items which match this query.",displayHeight:4},{model_:"IntProperty",name:"maxSyncAge",help:"How old our database is allowed to be before we just toss it and start over.",defaultValue:5184e5}],actions:[{model_:"Action",name:"start",help:"Start the Sync Manager.",isEnabled:function(){var enabled=this.enabled;return!this.enabled},action:function(){this.enabled=!0,this.sync()}},{model_:"Action",name:"forceSync",help:"Perform a single sync request.",isEnabled:function(){var isSyncing=this.isSyncing;return!isSyncing},action:function(){clearTimeout(this.timer),this.sync()}},{model_:"Action",name:"stop",help:"Stop the timer.",isEnabled:function(){var enabled=this.enabled,isSyncing=this.isSyncing;return enabled||isSyncing},action:function(){this.enabled=!1,this.abortRequest_=!0,clearTimeout(this.timer)}},{model_:"Action",name:"reset",help:"Reset the Sync Manager to force a re-sync of all data.",isEnabled:function(){return!this.enabled},action:function(ret){this.itemsSynced=0,this.timesSynced=0,this.lastSyncDuration=0,this.lastId="",this.lastSync=this.model_.LAST_SYNC.factory.call(this),this.lastModified=this.model_.LAST_MODIFIED.factory.call(this)}}],methods:{init:function(){this.SUPER();var self=this},doReset:function(ret){console.log("Doing reset..."),this.reset(),this.dstDAO.removeAll()(ret)},sync:function(ret){var self=this;this.isSyncing||aseq(function(ret){Date.now()-self.lastSync.getTime()>self.maxSyncAge?self.doReset(ret):ret()},function(ret){var batchSize=this.batchSize,startTime=Date.now(),lastBatchSize=0;this.abortRequest_=!1,this.isSyncing=!0,this.syncStatus="Syncing...";var dao=this.srcDAO;this.batchSize>0&&(dao=dao.limit(batchSize));var delay=this.syncInterval;if(this.queryParser&&this.query){var p=this.queryParser.parseString(this.query.replace(/\s+/g," "));p&&(p=p.partialEval(),dao=dao.where(p))}dao.where(GT(this.modifiedProperty,this.lastModified)).orderBy(this.modifiedProperty).select({put:function(item,_,fc){self.abortRequest_&&(fc.stop(),self.abortRequest_=!1),self.itemsSynced++,self.lastId=item.id,item[self.modifiedProperty.name].compareTo(self.lastModified)>0&&(self.lastModified=item[self.modifiedProperty.name],delay=self.delay),lastBatchSize++,self.dstDAO.find(item.id,{put:function(){self.dstDAO.put(item)}}),self.dstDAO.put(item)},error:function(){console.assert(!1,"SyncManager: sync error")}})(function(){self.timesSynced++,self.lastSyncDuration=Date.now()-startTime,self.lastBatchSize=lastBatchSize,self.syncStatus="",self.lastSync=new Date,self.isSyncing=!1,self.schedule(delay),ret()})}.bind(this))(ret||function(){})},schedule:function(syncInterval){this.enabled&&(this.timer=setTimeout(this.sync.bind(this),1e3*syncInterval))}}}),CLASS({"package":"foam.apps.quickbug.model",name:"LabelArrayProperty",extendsModel:"StringArrayProperty",properties:[{model_:"Property",name:"postSet",defaultValue:function(_,v,prop){console.assert(Array.isArray(v),"LabelArrayProperty.postSet: new value is not an array");for(var i=0;i<v.length;i++)v[i]=v[i].intern();v.sort(),this.replaceLabels(prop.name.capitalize(),v)}},{model_:"Property",name:"compareProperty",defaultValue:function(o1,o2){return o1=Array.isArray(o1)?o1.length?o1[o1.length-1]:0:o1,o2=Array.isArray(o2)?o2.length?o2[o2.length-1]:0:o2,o1.compareTo(o2)}},{model_:"Property",name:"transient",defaultValue:!0}],help:"An array of String values, taken from labels."}),CLASS({"package":"foam.apps.quickbug.model",name:"LabelStringEnumProperty",extendsModel:"foam.apps.quickbug.model.LabelStringProperty",traits:["foam.core.types.EnumPropertyTrait"],properties:[{model_:"Property",name:"postSet",defaultValue:function(o,n,prop){this.replaceLabels(prop.name.capitalize(),n)}}]}),CLASS({"package":"foam.core.types",name:"EnumPropertyTrait",properties:[{model_:"Property",name:"choices",type:"Array",required:!0,preSet:function(_,a){return a.map(function(c){return Array.isArray(c)?c:[c,c]})},help:"Array of [value, label] choices."},{model_:"Property",name:"view",defaultValue:"foam.ui.ChoiceView"}]}),CLASS({"package":"foam.apps.quickbug.model",name:"LabelStringProperty",extendsModel:"StringProperty",properties:[{model_:"Property",name:"preSet",defaultValue:function(o,n,prop){return n?n.intern():n}},{model_:"Property",name:"postSet",defaultValue:function(o,n,prop){this.replaceLabels(prop.name.capitalize(),n)}},{model_:"Property",name:"transient",defaultValue:!0}],help:"A String value, taken from labels."}),CLASS({"package":"foam.apps.quickbug.model",name:"QIssueCommentUpdate",extendsModel:"foam.apps.quickbug.model.imported.IssueCommentUpdate",properties:[{model_:"Property",name:"summary",displayWidth:120},{model_:"Property",name:"status",autocompleter:"foam.apps.quickbug.model.StatusCompleter"},{model_:"Property",name:"owner",autocompleter:"foam.apps.quickbug.model.PersonCompleter"},{model_:"Property",name:"labels",view:"GriddedStringArrayView",autocompleter:"foam.apps.quickbug.LabelCompleter"},{model_:"Property",name:"cc",displayWidth:120,view:"foam.ui.StringArrayView",autocompleter:"foam.apps.quickbug.model.PersonCompleter"},{model_:"Property",name:"blockedOn",view:"foam.ui.MultiLineStringArrayView"}],methods:{f:function(issue){function updateField(field){for(var i=0;i<comment[field].length;i++)issue[field]="-"===comment[field][i][0]?issue[field].removeF({f:function(s){return s===comment[field][i].substr(1)}}):issue[field].pushF(comment[field][i])}var comment=this;["blockedOn","cc","labels"].forEach(updateField),comment.owner&&(issue.owner=comment.owner),comment.status&&(issue.status=comment.status),comment.summary&&(issue.summary=comment.summary)}}}),CLASS({"package":"foam.apps.quickbug.model.imported",name:"IssueCommentUpdate",tableProperties:["blockedOn","blocking","cc","kind","labels","mergedInto","owner","status","summary"],properties:[{model_:"StringArrayProperty",name:"blockedOn",help:"Changes made to the list of issues blocked on this issue."},{model_:"StringArrayProperty",name:"blocking",help:"Changes made to the list of issues blocking this issue."},{model_:"StringArrayProperty",name:"cc",help:"Changes made to the issue's cc list."},{model_:"StringProperty",name:"kind",help:"Metadata updates made as part of a comment."},{model_:"StringArrayProperty",name:"labels",help:"Changes made to the issue's labels."},{model_:"StringProperty",name:"mergedInto",help:"ID of the issue this issue has been merged into."},{model_:"StringProperty",name:"owner",help:"Updated owner of the issue."},{model_:"StringProperty",name:"status",help:"Updated status of the issue."},{model_:"StringProperty",name:"summary",help:"Updated summary of the issue."}]}),CLASS({"package":"foam.apps.quickbug.model.imported",name:"Issue",properties:[{model_:"IntProperty",name:"id",help:"ID of the issue, unique to this project."},{model_:"ReferenceProperty",name:"author",help:"Person who originally filed this issue.",subType:"IssuePerson"},{model_:"StringArrayProperty",name:"blockedOn",help:"References to issues this issue is blocked on."},{model_:"StringArrayProperty",name:"blocking",help:"References to issues blocking on this issue."},{model_:"StringArrayProperty",name:"cc",help:"List of people who are CC'ed on updates to this issue."},{model_:"DateTimeProperty",name:"closed",help:"Date and time the issue was closed."},{model_:"StringProperty",name:"description",help:"Description of the issue."},{model_:"StringArrayProperty",name:"labels",help:"Labels for this issue."},{model_:"ReferenceProperty",name:"mergedInto",help:"Reference to the issue this issue was merged into.",subType:"Issue"},{model_:"ReferenceProperty",name:"movedFrom",help:"Reference to the issue this issue was moved from.",subType:"Issue"},{model_:"StringArrayProperty",name:"movedTo",help:"Reference to the issue(s) this issue was moved to."},{model_:"ReferenceProperty",name:"owner",help:"Person to whom this issue is currently assigned.",subType:"IssuePerson"},{model_:"DateProperty",name:"published",help:"Date and time the issue was originally published."},{model_:"BooleanProperty",name:"starred",help:"Whether the authenticated user has starred this issue."},{model_:"IntProperty",name:"stars",help:"Number of stars this issue has."},{model_:"StringProperty",name:"state",help:"State of this issue (open or closed)."},{model_:"StringProperty",name:"status",help:"Status of this issue."},{model_:"StringProperty",name:"summary",help:"One-line summary of the issue."},{model_:"DateProperty",name:"updated",help:"Date and time the issue was last updated."}]}),CLASS({"package":"foam.lib.bookmarks",name:"Bookmark",tableProperties:["icon","title","url"],properties:[{model_:"Property",name:"id"},{model_:"Property",name:"icon",getter:function(){var i=this.url?this.url.lastIndexOf("/"):-1,img=-1==i?"download.png":this.url.substr(i+1);return""==img&&(img="undefined"),"<img src='images/16/"+img+".png'/>"}},{model_:"Property",name:"title",displayWidth:40,help:"Bookmarked page's title."},{model_:"URLProperty",name:"url",label:"URL",displayWidth:40,help:"Bookmarked page's URL."}],actions:[{model_:"Action",name:"visit",help:"Visit Bookmark.",action:function(){window.location=this.url}}]}),CLASS({"package":"foam.core.dao",name:"WhenIdleDAO",extendsModel:"foam.dao.ProxyDAO",methods:{select:function(sink,options){var future=afuture();return this.delay(0,function(){Movement.whenIdle(function(){this.delegate.select(sink,options)(future.set)}.bind(this))()}.bind(this))(),future.get}},help:"Defers operations using Movement.whenIdle"}),CLASS({"package":"foam.metrics",name:"Metric",properties:[{model_:"IntProperty",name:"id"},{model_:"StringProperty",name:"name"},{model_:"IntProperty",name:"value",defaultValue:1},{model_:"BooleanProperty",name:"interactive",defaultValue:!0},{model_:"StringProperty",name:"subType",defaultValue:"metrics"},{model_:"foam.core.types.StringEnumProperty",name:"type",defaultValue:"event",help:"Optional hint as to what type of metric this is.",choices:[["event","event"],["count","count"],["timing","timing"],["error","error"]]}],methods:{start:function(){var startTime=Date.now();return function(ret){var endTime=Date.now();this.value=endTime-startTime,ret&&ret.apply(null,arguments)}}}}),CLASS({"package":"foam.core.types",name:"StringEnumProperty",extendsModel:"StringProperty",traits:["foam.core.types.EnumPropertyTrait"]}),CLASS({"package":"foam.core.dao",name:"KeywordDAO",extendsModel:"foam.dao.ProxyDAO",properties:[{model_:"Property",name:"idMap",factory:function(){return{}}},{model_:"Property",name:"DefaultQuery"}],methods:{init:function(){this.SUPER();var keywords=this,oldF=this.DefaultQuery.getPrototype().f;this.DefaultQuery.getPrototype().f=function(obj){return keywords.match(obj.id,this.arg1)||oldF.call(this,obj)}},addKeyword:function(id,keyword){var map=this.idMap[id]||(this.idMap[id]={});map[keyword]=!0},removeKeywords:function(id){delete this.idMap[id]},match:function(id,keyword){var map=this.idMap[id];return map&&map[keyword]},select:function(sink,options){var query=options&&options.query;if(!query)return this.delegate.select(sink,options);sink=sink||[].sink;var arg1,keywords=this,newSink={__proto__:sink,put:function(obj){query.f(obj)||keywords.addKeyword(obj.id,arg1),sink.put.apply(sink,arguments)}};this.DefaultQuery.getPrototype().partialEval=function(){var q=keywords.DefaultQuery.create(this);return arg1=this.arg1.intern(),q};var newQuery=query.partialEval();delete this.DefaultQuery.getPrototype().partialEval;var newOptions={__proto__:options,query:newQuery};return this.delegate.select(newSink,newOptions)},remove:function(query,sink){var key=void 0!=obj[this.model.ids[0]]?obj[this.model.ids[0]]:obj;this.removeKeywords(key),this.delegate.remove(query,sink)}}}),CLASS({"package":"foam.core.dao",name:"SplitDAO",extendsModel:"foam.dao.ProxyDAO",requires:["MDAO"],properties:[{model_:"Property",name:"remote",required:!0,hidden:!0},{model_:"FunctionProperty",name:"placeholderFactory"},{model_:"IntProperty",name:"staleTimeout",defaultValue:5e3},{model_:"Property",name:"delegate",factory:function(){var dao=this.MDAO.create({model:this.model});return dao.index=AltIndex.create(AutoPositionIndex.create(this.placeholderFactory,dao,this.remote,this.staleTimeout),TreeIndex.create(this.model.getProperty(this.model.ids[0]))),dao.root=[[]],dao}}],methods:{init:function(){this.SUPER();var self=this;this.remote.listen({put:function(obj){self.delegate.put(obj)},remove:function(obj){self.delegate.remove(obj)}})},put:function(obj,sink){this.remote.put(obj,sink)},remove:function(obj,sink){this.remote.remove(obj,sink)},find:function(key,sink){var remote=this.remote,delegate=this.delegate;this.SUPER(key,{put:function(obj){sink&&sink.put&&sink.put(obj)},error:function(){remote.find(key,{put:function(obj){sink&&sink.put&&sink.put(obj),delegate.put(obj)},error:sink&&sink.error?sink.error.bind(sink):void 0})}})}}}),CLASS({"package":"foam.input.touch",name:"GestureManager",requires:["foam.input.touch.DragGesture","foam.input.touch.Gesture","foam.input.touch.GestureTarget","foam.input.touch.PinchTwistGesture","foam.input.touch.ScrollGesture","foam.input.touch.TapGesture","foam.input.touch.InputPoint"],imports:["document","touchManager"],properties:[{model_:"Property",name:"gestures",factory:function(){return{verticalScroll:this.ScrollGesture.create(),verticalScrollMomentum:this.ScrollGesture.create({momentumEnabled:!0}),verticalScrollNative:this.ScrollGesture.create({nativeScrolling:!0}),horizontalScroll:this.ScrollGesture.create({direction:"horizontal"}),horizontalScrollMomentum:this.ScrollGesture.create({direction:"horizontal",momentumEnabled:!0}),horizontalScrollNative:this.ScrollGesture.create({direction:"horizontal",nativeScrolling:!0}),tap:this.TapGesture.create(),drag:this.DragGesture.create(),pinchTwist:this.PinchTwistGesture.create()}}},{model_:"Property",name:"targets",factory:function(){return{}}},{model_:"Property",name:"active",factory:function(){return{}},help:"Gestures that are active right now and should be checked for recognition. This is the gestures active on the FIRST touch. Rectangles are not checked for subsequent touches."},{model_:"Property",name:"recognized",help:"Set to the recognized gesture. Cleared when all points are lifted."},{model_:"Property",name:"points",factory:function(){return{}}},{model_:"Property",name:"wheelTimer"},{model_:"Property",name:"scrollWheelTimeout",defaultValue:300},{model_:"Property",name:"scrollViewTargets",defaultValue:0}],methods:{init:function(){this.SUPER(),this.touchManager.subscribe(this.touchManager.TOUCH_START,this.onTouchStart),this.touchManager.subscribe(this.touchManager.TOUCH_MOVE,this.onTouchMove),this.touchManager.subscribe(this.touchManager.TOUCH_END,this.onTouchEnd),this.document.addEventListener("mousedown",this.onMouseDown),this.document.addEventListener("mousemove",this.onMouseMove),this.document.addEventListener("mouseup",this.onMouseUp),this.document.addEventListener("wheel",this.onWheel),this.document.addEventListener("contextmenu",this.onContextMenu)},install:function(target){target.containerID?(this.targets[target.containerID]||(this.targets[target.containerID]=[]),this.targets[target.containerID].push(target)):console.warn("no container ID on touch target")},uninstall:function(target){var arr=this.targets[target.containerID];if(arr){for(var i=0;i<arr.length;i++)if(arr[i]===target){arr.splice(i,1);break}0===arr.length&&delete this.targets[target.containerID]}},purge:function(){for(var keys=Object.keys(this.targets),count=0,i=0;i<keys.length;i++)this.document.getElementById(keys[i])||(delete this.targets[keys[i]],count++);return console.log("Purged "+count+" targets"),count},activateContainingGestures:function(x,y,opt_predicate){for(var e=this.X.document.elementFromPoint(x,y);e;){if(e.id){var matches=this.targets[e.id];if(matches&&matches.length)for(var i=0;i<matches.length;i++){var t=matches[i],g=this.gestures[t.gesture];!g||opt_predicate&&!opt_predicate(g)||(this.active[g.name]||(this.active[g.name]=[]),this.active[g.name].push(t))}}e=e.parentNode}},checkRecognition:function(){if(!this.recognized){var self=this,matches=[];if(Object.keys(this.active).forEach(function(name){var answer=self.gestures[name].recognize(self.points);answer>=self.Gesture.WAIT&&matches.push([name,answer])}),0!==matches.length){var i,lastYes=-1;for(i=0;i<matches.length;i++)matches[i][1]===this.Gesture.YES&&(lastYes=i);var lastMaybe=-1;for(i=0;i<matches.length;i++)matches[i][1]===this.Gesture.MAYBE&&(lastMaybe=i);var match;if(0>lastYes){if(matches.length>1||0>lastMaybe)return;match=matches[lastMaybe][0]}else match=matches[lastYes][0];var matched=this.active[match],legal=[];for(i=0;i<matched.length;i++){for(var m=matched[i].getElement(),contained=0,j=0;j<matched.length;j++){var n=matched[j].getElement();m!==n&&m.contains(n)&&contained++}0===contained&&legal.push(matched[i].handler)}this.gestures[match].attach(this.points,legal),this.recognized=this.gestures[match]}}},resetState:function(){this.active={},this.recognized=null,this.points={}}},listeners:[{model_:"Method",name:"onTouchStart",code:function(_,__,touch){if(this.recognized)return void(this.recognized.addPoint&&this.recognized.addPoint(touch));var pointCount=Object.keys(this.points).length;pointCount||this.activateContainingGestures(touch.x,touch.y),this.points[touch.id]=touch,this.checkRecognition()}},{model_:"Method",name:"onMouseDown",code:function(event){var point=this.InputPoint.create({id:"mouse",type:"mouse",x:event.clientX,y:event.clientY});if(this.recognized)return void(this.recognized.addPoint&&this.recognized.addPoint(point));var pointCount=Object.keys(this.points).length;pointCount||this.activateContainingGestures(point.x,point.y),this.points[point.id]=point,this.checkRecognition()}},{model_:"Method",name:"onTouchMove",code:function(_,__,touch){this.recognized||this.checkRecognition()}},{model_:"Method",name:"onMouseMove",code:function(event){this.points.mouse&&(this.points.mouse.x=event.clientX,this.points.mouse.y=event.clientY,this.checkRecognition())}},{model_:"Method",name:"onTouchEnd",code:function(_,__,touch){this.recognized||this.checkRecognition(),delete this.points[touch.id],this.active={},this.recognized=void 0}},{model_:"Method",name:"onMouseUp",code:function(event){this.points.mouse&&(this.points.mouse.x=event.clientX,this.points.mouse.y=event.clientY,this.points.mouse.done=!0,this.recognized||this.checkRecognition(),delete this.points.mouse,this.active={},this.recognized=void 0)}},{model_:"Method",name:"onWheel",code:function(event){if(this.wheelTimer)this.points.wheel.x-=event.deltaX,this.points.wheel.y-=event.deltaY,this.X.window.clearTimeout(this.wheelTimer),this.wheelTimer=this.X.window.setTimeout(this.onWheelDone,this.scrollWheelTimeout);else{if(this.recognized||Object.keys(this.points).length>0)return;var wheel=this.InputPoint.create({id:"wheel",type:"wheel",x:event.clientX,y:event.clientY}),dir=Math.abs(event.deltaX)>Math.abs(event.deltaY)?"horizontal":"vertical",gestures=[dir+"Scroll",dir+"ScrollMomentum",dir+"ScrollNative"];this.activateContainingGestures(wheel.x,wheel.y,function(g){return gestures.indexOf(g.name)>=0}),wheel.x-=event.deltaX,wheel.y-=event.deltaY;for(var i=0;i<gestures.length;i++){var gesture=gestures[i];if(this.active[gesture]&&this.active[gesture].length){this.points.wheel||(this.points.wheel=wheel),this.gestures[gesture].attach(this.points,this.active[gesture].map(function(gt){return gt.handler})),this.recognized=this.gestures[gesture],this.wheelTimer=this.X.window.setTimeout(this.onWheelDone,this.scrollWheelTimeout);break}}}}},{model_:"Method",name:"onWheelDone",code:function(){this.wheelTimer=void 0,this.points.wheel.done=!0,delete this.points.wheel,this.recognized=void 0}},{model_:"Method",name:"onContextMenu",code:function(){this.resetState()}}]}),CLASS({"package":"foam.input.touch",name:"DragGesture",extendsModel:"foam.input.touch.Gesture",properties:[{model_:"Property",name:"name",defaultValue:"drag"}],methods:{recognize:function(map){var keys=Object.keys(map);if(keys.length>1)return this.NO;var point=map[keys[0]];if(point.done)return this.NO;var delta=Math.max(Math.abs(point.totalX),Math.abs(point.totalY)),r=delta>=20?this.YES:this.MAYBE;return r!=this.NO&&(point.shouldPreventDefault=!0),r},attach:function(map,handlers){var point=map[Object.keys(map)[0]];this.handlers=handlers||[],point.done$.addListener(this.onDone),this.pingHandlers("dragStart",point)},pingHandlers:function(method,point){for(var i=0;i<this.handlers.length;i++){var h=this.handlers[i];h&&h[method]&&h[method](point)}}},listeners:[{model_:"Method",name:"onDone",code:function(obj,prop,old,nu){obj.done$.removeListener(this.onDone),this.pingHandlers("dragEnd",obj)}}],help:"Gesture that understands a hold and drag with mouse or one touch point."}),CLASS({"package":"foam.input.touch",name:"Gesture",properties:[{model_:"Property",name:"name",required:!0}],constants:[{model_:"Constant",name:"YES",value:3},{model_:"Constant",name:"MAYBE",value:2},{model_:"Constant",name:"WAIT",value:1},{model_:"Constant",name:"NO",value:0}],methods:{recognize:function(map){return this.NO},attach:function(handlers){},newPoint:function(point){}},help:"Installed in the GestureManager to watch for a particular kind of gesture"}),CLASS({"package":"foam.input.touch",name:"PinchTwistGesture",extendsModel:"foam.input.touch.Gesture",properties:[{model_:"Property",name:"name",defaultValue:"pinchTwist"},{model_:"Property",name:"handlers"},{model_:"Property",name:"points"}],methods:{getPoints:function(map){var keys=Object.keys(map);return[map[keys[0]],map[keys[1]]]},recognize:function(map){if(2!==Object.keys(map).length)return this.NO;var points=this.getPoints(map);if(points[0].done||points[1].done)return this.NO;var moved=!(0===points[0].dx&&0===points[0].dy||0===points[1].dx&&0===points[1].dy);return moved?this.YES:this.MAYBE},attach:function(map,handlers){Object_forEach(map,function(p){p.shouldPreventDefault=!0}),this.points=this.getPoints(map),this.handlers=handlers||[],this.points.forEach(function(p){p.x$.addListener(this.onMove),p.y$.addListener(this.onMove),p.done$.addListener(this.onDone)}.bind(this)),this.pingHandlers("pinchStart"),this.onMove()},pingHandlers:function(method,scale,rotation){for(var i=0;i<this.handlers.length;i++){var h=this.handlers[i];h&&h[method]&&h[method](scale,rotation)}},distance:function(x1,y1,x2,y2){var dx=x2-x1,dy=y2-y1;return Math.sqrt(dx*dx+dy*dy)}},listeners:[{model_:"Method",name:"onMove",code:function(){for(var oldDist=this.distance(this.points[0].x0,this.points[0].y0,this.points[1].x0,this.points[1].y0),newDist=this.distance(this.points[0].x,this.points[0].y,this.points[1].x,this.points[1].y),scale=newDist/oldDist,oldAngle=Math.atan2(this.points[1].y0-this.points[0].y0,this.points[1].x0-this.points[0].x0),newAngle=Math.atan2(this.points[1].y-this.points[0].y,this.points[1].x-this.points[0].x),rotation=newAngle-oldAngle;rotation<-Math.PI;)rotation+=2*Math.PI;for(;rotation>Math.PI;)rotation-=2*Math.PI;rotation*=360,rotation/=2*Math.PI,this.pingHandlers("pinchMove",scale,rotation)}},{model_:"Method",name:"onDone",code:function(obj,prop,old,nu){this.points.forEach(function(p){p.x$.removeListener(this.onMove),p.y$.removeListener(this.onMove),p.done$.removeListener(this.onDone)}),this.pingHandlers("pinchEnd")}}],help:"Gesture that understands a two-finger pinch/stretch and rotation"}),CLASS({"package":"foam.input.touch",name:"ScrollGesture",extendsModel:"foam.input.touch.Gesture",properties:[{model_:"Property",name:"name",factory:function(){return this.direction+"Scroll"+(this.momentumEnabled?"Momentum":this.nativeScrolling?"Native":"")}},{model_:"Property",name:"direction",defaultValue:"vertical"},{model_:"Property",name:"isVertical",factory:function(){return"vertical"===this.direction}},{model_:"Property",name:"momentumEnabled",defaultValue:!1,help:'Set me to true (usually by attaching the "verticalScrollMomentum" gesture) to enable momentum'},{model_:"Property",name:"nativeScrolling",defaultValue:!1,help:'Set me to true (usually by attaching the "verticalScrollNative" gesture) to enable native browser scrolling'},{model_:"Property",name:"dragCoefficient",defaultValue:.94,help:"Each frame, the momentum will be multiplied by this coefficient. Higher means LESS drag."},{model_:"Property",name:"dragClamp",defaultValue:.05,help:"The speed threshold (pixels/millisecond) below which the momentum drops to 0."},{model_:"Property",name:"momentum",defaultValue:0,help:"The current speed, in pixels/millisecond, at which the scroller is sliding."},{model_:"Property",name:"lastTime",hidden:!0,defaultValue:0,help:"The performance.now() value for the last time we computed the momentum slide."},{model_:"Property",name:"tickRunning",hidden:!0,defaultValue:!1,help:"True when the physics tick should run."},{model_:"Property",name:"handlers"}],methods:{recognize:function(map){if(1!==Object.keys(map).length)return this.NO;var point=map[Object.keys(map)[0]];if("mouse"===point.type||point.done)return this.NO;if(Math.abs(this.momentum)>0)return this.YES;var delta=Math.abs(this.isVertical?point.totalY:point.totalX);return delta>10?this.YES:this.MAYBE},attach:function(map,handlers){var point=map[Object.keys(map)[0]];this.handlers=handlers||[],this.nativeScrolling||(Object_forEach(map,function(p){p.shouldPreventDefault=!0}),(this.isVertical?point.y$:point.x$).addListener(this.onDelta),point.done$.addListener(this.onDone),0===this.momentum?this.pingHandlers(this.direction+"ScrollStart",0,0,this.isVertical?point.y0:point.x0):this.tickRunning=!1)},pingHandlers:function(method,d,t,c){for(var i=0;i<this.handlers.length;i++){var h=this.handlers[i];
h&&h[method]&&h[method](d,t,c,this.stopMomentum)}},sendEndEvent:function(point){var delta=this.isVertical?point.dy:point.dx,total=this.isVertical?point.totalY:point.totalX,current=this.isVertical?point.y:point.x;this.pingHandlers(this.direction+"ScrollEnd",delta,total,current)},calculateInstantaneousVelocity:function(point){var now=this.X.performance.now(),lastTime=this.tickRunning?this.lastTime:point.lastTime,velocity=(this.isVertical?point.dy:point.dx)/(now-point.lastTime);return this.tickRunning&&(this.lastTime=now),velocity}},listeners:[{model_:"Method",name:"onDelta",code:function(obj,prop,old,nu){if(this.momentumEnabled){var velocity=this.calculateInstantaneousVelocity(obj),delta=velocity-this.momentum;this.momentum+=delta}var delta=this.isVertical?obj.dy:obj.dx,total=this.isVertical?obj.totalY:obj.totalX,current=this.isVertical?obj.y:obj.x;this.pingHandlers(this.direction+"ScrollMove",delta,total,current)}},{model_:"Method",name:"onDone",code:function(obj,prop,old,nu){(this.isVertical?obj.y$:obj.x$).removeListener(this.onDelta),obj.done$.removeListener(this.onDone),this.momentumEnabled?Math.abs(this.momentum)<this.dragClamp?(this.momentum=0,this.sendEndEvent(obj)):(this.tickRunning=!0,this.lastTime=this.X.performance.now(),this.tick(obj)):this.sendEndEvent(obj)}},{model_:"Method",name:"tick",code:function(touch){if(this.tickRunning){var xy=this.isVertical?"y":"x",now=this.X.performance.now(),elapsed=now-this.lastTime;this.lastTime=now;var distance=this.momentum*elapsed;touch[xy]+=distance;var delta,total,current;this.isVertical?(delta=touch.dy,total=touch.totalY,current=touch.y):(delta=touch.dx,total=touch.totalX,current=touch.x),0!=delta&&this.pingHandlers(this.direction+"ScrollMove",delta,total,current),this.momentum*=this.dragCoefficient,Math.abs(this.momentum)<this.dragClamp?(this.momentum=0,this.tickRunning=!1,this.sendEndEvent(touch)):this.tick(touch)}},isFramed:!0},{model_:"Method",name:"stopMomentum",code:function(){this.momentum=0}}],help:"Gesture that understands vertical or horizontal scrolling."}),CLASS({"package":"foam.input.touch",name:"TapGesture",extendsModel:"foam.input.touch.Gesture",properties:[{model_:"Property",name:"name",defaultValue:"tap"},{model_:"Property",name:"handlers"}],methods:{recognize:function(map){for(var response,doneCount=0,self=this,keys=Object.keys(map),i=0;i<keys.length;i++){var key=keys[i],p=map[key];if(Math.abs(p.totalX)>=10||Math.abs(p.totalY)>=10)return this.NO;p.done&&doneCount++}return response===this.NO?response:doneCount===keys.length?this.YES:this.WAIT},attach:function(map,handlers){if(handlers&&handlers.length){var points=0;Object_forEach(map,function(point){points++,point.shouldPreventDefault=!0}),handlers.forEach(function(h){h&&h.tapClick&&h.tapClick(map)})}}},help:"Gesture that understands a quick, possible multi-point tap. Calls into the handler: tapClick(numberOfPoints)."}),CLASS({"package":"foam.input.touch",name:"InputPoint",properties:[{model_:"Property",name:"id"},{model_:"Property",name:"type"},{model_:"BooleanProperty",name:"done"},{model_:"Property",name:"x",postSet:function(old,nu){this.lastX=old}},{model_:"Property",name:"y",postSet:function(old,nu){this.lastY=old}},{model_:"Property",name:"x0",factory:function(){return this.x}},{model_:"Property",name:"y0",factory:function(){return this.y}},{model_:"Property",name:"lastX",factory:function(){return this.x}},{model_:"Property",name:"lastY",factory:function(){return this.y}},{model_:"Property",name:"dx",getter:function(){return this.x-this.lastX}},{model_:"Property",name:"dy",getter:function(){return this.y-this.lastY}},{model_:"Property",name:"totalX",getter:function(){return this.x-this.x0}},{model_:"Property",name:"totalY",getter:function(){return this.y-this.y0}},{model_:"Property",name:"lastTime"},{model_:"Property",name:"shouldPreventDefault",defaultValue:!1}]}),CLASS({"package":"foam.input.touch",name:"TouchManager",requires:["foam.input.touch.InputPoint"],properties:[{model_:"Property",name:"touches",factory:function(){return{}}}],constants:[{model_:"Constant",name:"TOUCH_START",value:["touch-start"]},{model_:"Constant",name:"TOUCH_END",value:["touch-end"]},{model_:"Constant",name:"TOUCH_MOVE",value:["touch-move"]}],methods:{init:function(){this.SUPER(),this.X.document&&this.install(this.X.document)},install:function(d){d.addEventListener("touchstart",this.onTouchStart)},attach:function(e){e.addEventListener("touchmove",this.onTouchMove),e.addEventListener("touchend",this.onTouchEnd),e.addEventListener("touchcancel",this.onTouchCancel),e.addEventListener("touchleave",this.onTouchEnd)},detach:function(e){e.removeEventListener("touchmove",this.onTouchMove),e.removeEventListener("touchend",this.onTouchEnd),e.removeEventListener("touchcancel",this.onTouchCancel),e.removeEventListener("touchleave",this.onTouchEnd)},touchStart:function(i,t,e){this.touches[i]=this.InputPoint.create({id:i,type:"touch",x:t.pageX,y:t.pageY}),this.publish(this.TOUCH_START,this.touches[i])},touchMove:function(i,t,e){var touch=this.touches[i];touch.x=t.pageX,touch.y=t.pageY,touch.lastTime=this.X.performance.now(),touch.shouldPreventDefault&&e.preventDefault(),this.publish(this.TOUCH_MOVE,this.touch)},touchEnd:function(i,t,e){var touch=this.touches[i];touch.x=t.pageX,touch.y=t.pageY,touch.done=!0,this.publish(this.TOUCH_END,touch),touch.shouldPreventDefault&&e.cancelable&&e.preventDefault(),delete this.touches[i]},touchCancel:function(i,t,e){this.touches[i].done=!0,this.publish(this.TOUCH_END,this.touches[i])},touchLeave:function(i,t,e){this.touches[i].done=!0,this.publish(this.TOUCH_END,this.touches[i])}},listeners:[{model_:"Method",name:"onTouchStart",code:function(e){this.attach(e.target);for(var i=0;i<e.changedTouches.length;i++){var t=e.changedTouches[i];this.touchStart(t.identifier,t,e)}}},{model_:"Method",name:"onTouchMove",code:function(e){for(var i=0;i<e.changedTouches.length;i++){var t=e.changedTouches[i],id=t.identifier;this.touches[id]?this.touchMove(id,t,e):console.warn("Touch move for unknown touch.")}}},{model_:"Method",name:"onTouchEnd",code:function(e){this.detach(e.target);for(var i=0;i<e.changedTouches.length;i++){var t=e.changedTouches[i],id=t.identifier;this.touches[id]?this.touchEnd(id,t,e):console.warn("Touch end for unknown touch "+id,Object.keys(this.touches))}}},{model_:"Method",name:"onTouchCancel",code:function(e){this.detach(e.target);for(var i=0;i<e.changedTouches.length;i++){var t=e.changedTouches[i],id=t.identifier;this.touches[id]?this.touchCancel(id,t,e):console.warn("Touch cancel for unknown touch.")}}},{model_:"Method",name:"onTouchLeave",code:function(e){this.detach(e.target);for(var i=0;i<e.changedTouches.length;i++){var t=e.changedTouches[i],id=t.identifier;this.touches[id]?this.touchLeave(id,t,e):console.warn("Touch cancel for unknown touch.")}}}]}),CLASS({"package":"foam.oauth2",name:"AutoOAuth2",imports:["window"],methods:{init:function(args){this.SUPER(args);var model;model=this.X.lookup(this.window.cordova||this.window.PhoneGap||this.window.phonegap?"foam.oauth2.OAuth2ChromeIdentity":window.chrome&&window.chrome.runtime&&window.chrome.runtime.id?"foam.oauth2.OAuth2ChromeApp":"foam.oauth2.OAuth2WebClient"),this.X.registerModel(model,"foam.oauth2.EasyOAuth2")}},help:"Registers an EasyOAuth2 model in the context based on the current environment."}),CLASS({"package":"foam.oauth2",name:"OAuth2WebClient",extendsModel:"foam.oauth2.OAuth2",methods:{refreshNow_:function(ret,opt_forceInteractive){var self=this,w,cb=wrapJsonpCallback(function(code){self.accessToken=code;try{ret(code)}finally{w&&w.close()}},!0),path=location.pathname,returnPath=location.origin+location.pathname.substring(0,location.pathname.lastIndexOf("/"))+"/oauth2callback.html",queryparams=["?response_type=token","client_id="+encodeURIComponent(this.clientId),"redirect_uri="+encodeURIComponent(returnPath),"scope="+encodeURIComponent(this.scopes.join(" ")),"state="+cb.id,"approval_prompt="+(opt_forceInteractive?"force":"auto")];w=window.open(this.endpoint+"auth"+queryparams.join("&"))}},help:"Strategy for OAuth2 when running as a web page."}),CLASS({"package":"foam.oauth2",name:"OAuth2",label:"OAuth 2.0",requires:["XHR"],properties:[{model_:"Property",name:"accessToken",help:"Token used to authenticate requests."},{model_:"Property",name:"clientId",required:!0,"transient":!0},{model_:"Property",name:"clientSecret",required:!0,"transient":!0},{model_:"StringArrayProperty",name:"scopes",required:!0,"transient":!0},{model_:"URLProperty",name:"endpoint",defaultValue:"https://accounts.google.com/o/oauth2/"}],methods:{init:function(){this.SUPER(),this.refresh_=amerged(this.refreshNow_.bind(this))},refreshNow_:function(){},refresh:function(ret,opt_forceInteractive){return this.refresh_(ret,opt_forceInteractive)},setJsonpFuture:function(X,future){var agent=this;future.set(function(){var factory=agent.XHR.xbind({authAgent:agent,responseType:"json",retries:3});return function(url,params,opt_method,opt_payload){return function(ret){var xhr=factory.create();xhr.asend(function(data,xhr){ret(data,xhr.status)},url+(params?"?"+params.join("&"):""),opt_payload,opt_method?opt_method:"GET")}}}())}}}),CLASS({"package":"foam.ui.layout",name:"CSSStackView",extendsModel:"foam.ui.View",traits:["foam.ui.layout.PositionedDOMViewTrait"],requires:["foam.ui.layout.CSSOverlaySlider as OverlaySlider","foam.ui.layout.FloatingView"],imports:["dynamic"],properties:[{model_:"Property",name:"stack",factory:function(){return[]}},{model_:"IntProperty",name:"currentView",preSet:function(_,v){return Math.min(Math.max(v,0),this.stack.length-1)},defaultValue:0},{model_:"Property",name:"animating",defaultValue:!1},{model_:"IntProperty",name:"direction",defaultValue:-1},{model_:"Property",name:"overlaySlider",factory:function(){return this.OverlaySlider.create()},postSet:function(old,v){old&&old.unsubscribe(["click"],this.overlayBack),v.subscribe(["click"],this.overlayBack)}},{model_:"BooleanProperty",name:"sliderOpen",defaultValue:!1},{model_:"foam.core.types.DOMElementProperty",name:"innerContainer"},{model_:"foam.core.types.DOMElementProperty",name:"containerViewport"}],actions:[{model_:"Action",name:"back",action:function(){this.sliderOpen?(this.overlaySlider.close(),this.sliderOpen=!1):(this.animating=!0,this.currentView=this.currentView-1)}}],methods:{init:function(){this.SUPER();var self=this;this.dynamic(function(){self.width,self.height,self.sliderOpen},this.layout),this.dynamic(function(){self.currentView,self.width},this.transform),this.dynamic(function(){self.width,self.height},this.resizeContainer)},setTopView:function(view){view.model_.Z||(view=this.FloatingView.create({view:view}));for(var i=0;i<this.stack.length;i++)this.stack[i].destroy();this.stack=[view],this.currentView=0,this.layout(),this.resizeContainer(),this.innerContainer&&(this.innerContainer.innerHTML=view.toHTML(),view.initHTML())},setPreview:function(){},slideView:function(view,opt_label,opt_side,opt_delay){view.model_.Z||(view=this.FloatingView.create({view:view})),this.sliderOpen&&(this.overlaySlider.close(!0),this.sliderOpen=!1),this.sliderOpen=!0,this.overlaySlider.open(view)},pushView:function(view,opt_label,opt_back,opt_transition){view.model_.Z||(view=this.FloatingView.create({view:view}));var nextView=this.currentView+1;this.stack[nextView]&&(this.stack[nextView].$.remove(),this.stack[nextView].destroy()),this.stack[nextView]=view,this.propertyChange("stack",this.stack,this.stack),this.layout(),this.resizeContainer(),this.innerContainer.insertAdjacentHTML("beforeend",view.toHTML()),view.initHTML(),this.currentView=nextView,this.animating="none"==opt_transition?!1:!0}},listeners:[{model_:"Method",name:"overlayBack",code:function(){this.sliderOpen&&this.back()}},{model_:"Method",name:"resizeContainer",code:function(){this.innerContainer&&(this.innerContainer.style.width=this.stack.length*this.width+"px",this.innerContainer.style.height=this.height+"px",this.containerViewport.style.width=this.styleWidth(),this.containerViewport.style.height=this.styleHeight())},isFramed:!0},{model_:"Method",name:"updateContents",code:function(){},isFramed:!0},{model_:"Method",name:"fixLayout",code:function(){this.containerViewport&&(this.containerViewport.scrollLeft=0)},isMerged:100},{model_:"Method",name:"layout",code:function(){this.fixLayout(),this.overlaySlider.x=0,this.overlaySlider.y=0,this.overlaySlider.z=this.sliderOpen?1:0,this.overlaySlider.width=this.width,this.overlaySlider.height=this.height;for(var i=0;i<this.stack.length;i++)this.stack[i].x=i*this.width,this.stack[i].y=0,this.stack[i].z=0,this.stack[i].width=this.width,this.stack[i].height=this.height}},{model_:"Method",name:"transform",code:function(){this.innerContainer&&(this.innerContainer.style.webkitTransform="translate3d("+-1*this.currentView*this.width+"px, 0px, 0px)")},isFramed:!0}],templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n.cssslider-animate {\n  -webkit-transition: -webkit-transform 300ms cubic-bezier(0.4, 0.0, 0.2, 1);\n}\n"),out.toString()}},{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out("",this.overlaySlider,'<div id="',this.containerViewport=this.nextID(),'" style="overflow:hidden;position:absolute"><div id="',this.innerContainer=this.setClass("cssslider-animate",function(){self.animating}),'">',this.stack[0]||"","</div></div>"),out.toString()}}]}),CLASS({"package":"foam.ui.layout",name:"CSSOverlaySlider",extendsModel:"foam.ui.View",traits:["foam.ui.layout.PositionedDOMViewTrait"],requires:["foam.ui.layout.FloatingView"],properties:[{model_:"Property",name:"view"},{model_:"BooleanProperty",name:"isOpen",defaultValue:!1},{model_:"BooleanProperty",name:"animating",defaultValue:!1},{model_:"foam.core.types.DOMElementProperty",name:"overlaySlider"},{model_:"foam.core.types.DOMElementProperty",name:"viewContainer"}],methods:{init:function(args){this.SUPER(args);var self=this;this.X.dynamic(function(){self.width,self.height},this.layout)},open:function(view){view.model_.Z||(view=this.FloatingView.create({view:view})),this.view&&this.view.$&&(this.view.$.remove(),this.view.destroy()),this.view=view,this.isOpen=!1,this.animating=!1,this.layout(),this.viewContainer.innerHTML=view.toHTML(),view.initHTML(),this.animating=!0,this.isOpen=!0,this.layout()},close:function(rightNow){this.isOpen=!1,this.animating=!rightNow,this.layout()}},listeners:[{model_:"Method",name:"onClick",code:function(){this.publish(["click"])}},{model_:"Method",name:"layout",code:function(){var width=Math.min(this.view.preferredWidth||this.width,this.width);if(this.view&&(this.view.width=width,this.view.height=this.height,this.view.x=0,this.view.y=0,this.view.z=1),this.$){var overlay=this.overlaySlider;overlay.style.webkitTransition=this.animating?"opacity 300ms "+(this.isOpen?"cubic-bezier(0.4, 0.0, 0.2, 1)":"cubic-bezier(0.4, 0.0, 1, 1)"):"",overlay.style.webkitTransform="translate3d(0px,0px,0px)",overlay.style.width=this.width+"px",overlay.style.height=this.height+"px",overlay.style.opacity=this.isOpen?.4:0;var container=this.viewContainer;container.style.webkitTransition=this.animating?"-webkit-transform 300ms "+(this.isOpen?"cubic-bezier(0.4, 0.0, 0.2, 1)":"cubic-bezier(0.4, 0.0, 1, 1)"):"",container.style.webkitTransform="translate3d("+(this.isOpen?0:-width)+"px,0px,0px)",container.style.width=width+"px",container.style.height=this.styleHeight()}}}],templates:[{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('<div id="',this.overlaySlider=this.on("click",this.onClick),'" class="overlay-slider"></div>\n<div id="',this.viewContainer=this.nextID(),'" class="overlay-container"></div>\n  '),out.toString()}},{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n.overlay-slider {\n  position: absolute;\n  background: black;\n}\n\n.overlay-conatiner {\n  position: absolute;\n}\n\n* {\n  transform-style: preserve-3d;\n  -webkit-transform-style: preserve-3d;\n}\n"),out.toString()}}]}),CLASS({"package":"foam.ui.layout",name:"FloatingView",extendsModel:"foam.ui.View",traits:["foam.ui.layout.PositionedDOMViewTrait"],properties:[{model_:"Property",name:"view"},{model_:"Property",name:"width",defaultValue:300},{model_:"Property",name:"preferredWidth",defaultValueFn:function(){return this.view.preferredWidth}},{model_:"Property",name:"height",defaultValue:300},{model_:"Property",name:"className",defaultValue:"floatingView"}],methods:{destroy:function(){this.SUPER(),this.view.destroy()}},templates:[{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out(" ",self.view," "),out.toString()}}]}),CLASS({"package":"foam.core.types",name:"DOMElementProperty",extendsModel:"StringProperty",properties:[{model_:"Property",name:"getter",defaultValue:function(name){return this.X.document.getElementById(this.instance_[name])}}]}),CLASS({"package":"foam.ui.md",name:"ResponsiveAppControllerView",extendsModel:"foam.ui.layout.ResponsiveView",requires:["foam.ui.layout.ResponsiveViewOption","foam.ui.md.TwoPane","foam.ui.DetailView"],properties:[{model_:"Property",name:"options",factory:function(){return[this.ResponsiveViewOption.create({data$:this.data$,controller:"foam.ui.DetailView",minWidth:0}),this.ResponsiveViewOption.create({data$:this.data$,controller:"foam.ui.md.TwoPane",minWidth:600})]}}]}),CLASS({"package":"foam.ui.layout",name:"ResponsiveViewOption",properties:[{model_:"Property",name:"data"},{model_:"ViewFactoryProperty",name:"controller"},{model_:"IntProperty",name:"minWidth"}]}),CLASS({"package":"foam.ui.md",name:"TwoPane",extendsModel:"foam.ui.DetailView",requires:["foam.ui.layout.DOMPanel"],properties:[{model_:"ModelProperty",name:"model",defaultValue:"AppController"}],templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .panes {\n      display: flex;\n      }\n      .right-pane {\n        flex-grow: 1;\n      }\n      .left-pane {\n        display: flex;\n        flex-direction: column;\n        width: 300px;\n      }\n    "),out.toString()}},{model_:"Template",name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('\n    <div id="',this.setClass("searchMode",function(){return self.data.searchMode},this.id),'"  class="mdui-app-controller">\n       <div class="header">\n         <span class="default">\n           ',self.createTemplateView("name",{mode:"read-only",className:"name"}),"\n           "),this.data.refreshAction&&out(this.createActionView(this.data.refreshAction,{data:this.data})),out("\n           "),this.data.spinner&&out('\n             <span class="mdui-app-controller-spinner">\n               ',this.data.spinner,"\n             </span>\n           "),out("\n           ",self.createTemplateView("enterSearchMode")," ",self.data.sortOrderView,'\n         </span>\n         <span class="search">\n           ',self.createTemplateView("leaveSearchMode",{className:"backButton"})," ",self.createTemplateView("q"),'\n         </span>\n       </div>\n       <div class="panes">\n         ',this.DOMPanel.create({className:"left-pane",data:this.data.menuFactory()}),'\n         <div class="right-pane">\n           ',self.data.filteredDAOView,"\n           "),this.data.createAction&&out(this.createActionView(this.data.createAction,{data:this.data,className:"createButton",color:"white",font:"30px Roboto Arial",alpha:1,width:44,height:44,radius:22,background:"#e51c23"})),out("\n         </div>\n       </div>\n    </div>\n    "),this.addInitializer(function(){if(self.filterChoices){var v=self.data.filteredDAOView;v.index$.addListener(function(){self.qView.$.placeholder="Search "+v.views[v.index].label.toLowerCase()})}self.data.searchMode$.addListener(EventService.merged(function(){self.qView.$.focus()},100))}),this.on("touchstart",function(){console.log("blurring"),self.qView.$.blur()},this.data.filteredDAOView.id),this.on("click",function(){console.log("focusing"),self.qView.$.focus()},this.qView.id),out("\n    "),out.toString()}}]}),CLASS({"package":"foam.ui.layout",name:"DOMPanel",extendsModel:"foam.ui.BaseView",traits:["foam.ui.HTMLViewTrait","foam.ui.TemplateSupportTrait","foam.ui.ViewActionsTrait"],imports:["window"],properties:[{model_:"IntProperty",name:"width"},{model_:"IntProperty",name:"height"},{model_:"Property",name:"tagName",defaultValue:"div"},{model_:"Property",name:"data",postSet:function(){this.updateHTML()}}],methods:{init:function(){this.SUPER();var self=this;this.X.dynamic(function(){self.width,self.height},this.layout)},initHTML:function(){this.SUPER(),this.window.addEventListener("resize",this.onResize),this.width=this.$.clientWidth,this.height=this.$.clientHeight,this.onResize()},destroy:function(isParentDestroyed){this.SUPER(isParentDestroyed),this.window&&this.window.removeEventListener("resize",this.onResize)}},listeners:[{model_:"Method",name:"layout",code:function(){this.data&&(this.data.x=0,this.data.y=0,this.data.z=0,this.data.width=this.width,this.data.height=this.height)},isFramed:!0},{model_:"Method",name:"onResize",code:function(){this.$&&(this.width=this.$.clientWidth,this.height=this.$.clientHeight)},isMerged:100}],templates:[{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out("",this.data,""),out.toString()}}]}),CLASS({"package":"foam.ui.layout",name:"ResponsiveView",extendsModel:"foam.ui.View",requires:["foam.ui.layout.ResponsiveViewOption"],imports:["window"],properties:[{model_:"ArrayProperty",name:"options",preSet:function(_,v){return v.slice().sort(toCompare(this.ResponsiveViewOption.MIN_WIDTH))},subType:"foam.ui.layout.ResponsiveViewOption"},{model_:"Property",name:"current",type:"foam.ui.layout.ResponsiveViewOption",postSet:function(old,v){old!==v&&this.updateHTML()}},{model_:"Property",name:"tagName",defaultValue:"div"}],methods:{initInnerHTML:function(){this.SUPER(),this.window.addEventListener("resize",this.onResize),this.onResize_()},destroy:function(isParentDestroyed){this.SUPER(isParentDestroyed),this.window.removeEventListener("resize",this.onResize)},onResize_:function(){if(this.$){for(var width=this.$.clientWidth,i=0;i<this.options.length;i++){var option=this.options[i];if(option.minWidth>width)break}i=Math.max(i-1,0),this.current=this.options[i]}}},listeners:[{model_:"Method",name:"onResize",code:function(){this.onResize_()},isMerged:100}],templates:[{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out(""),this.destroy(),out("",this.current?this.current.controller({data$:this.data$}):"",""),out.toString()}}]}),CLASS({"package":"foam.ui.layout",name:"Window",extendsModel:"foam.ui.BaseView",traits:["foam.ui.HTMLViewTrait","foam.ui.TemplateSupportTrait","foam.ui.ViewActionsTrait"],imports:["dynamic","window"],properties:[{model_:"IntProperty",name:"width"},{model_:"IntProperty",name:"height"},{model_:"Property",name:"window",hidden:!0,postSet:function(o,w){o&&o.removeEventListener("resize",this.onResize),w.addEventListener("resize",this.onResize),this.onResize(),this.window.setTimeout(this.onResize,0)}},{model_:"Property",name:"data",postSet:function(_,v){var self=this;v.x=0,v.y=0,this.dynamic(function(){self.width,self.height},function(){v.width=self.width,v.height=self.height}),this.rendered&&this.updateHTML()}},{model_:"BooleanProperty",name:"rendered",defaultValue:!1}],methods:{init:function(args){this.SUPER(args);var self=this;this.dynamic(function(){self.height},function(){self.window.document.body.style.height=self.height+"px"})},updateHTML:function(){this.window.document.body.innerHTML=this.toHTML(),this.initHTML()},toHTML:function(){return this.rendered=!0,this.children=[this.data],this.data&&this.data.toHTML()}},listeners:[{model_:"Method",name:"onResize",code:function(){this.height=this.window.innerHeight,this.width=this.window.innerWidth}}],templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .body {\n        padding: 0px;\n        margin: 0px;\n        border: 0px\n      }\n    "),out.toString()}}]}),CLASS({"package":"foam.ui",name:"RelationshipView",extendsModel:"foam.ui.BaseView",traits:["foam.ui.HTMLViewTrait","foam.ui.TemplateSupportTrait","foam.ui.ViewActionsTrait"],properties:[{model_:"Property",name:"data",postSet:function(old,nu){this.destroy(),this.construct()}},{model_:"Property",name:"relationship",required:!0},{model_:"Property",name:"args"},{model_:"ViewFactoryProperty",name:"viewModel",defaultValue:"foam.ui.DAOController"},{model_:"Property",name:"view"}],methods:{init:function(args){this.SUPER(args),this.args&&this.args.model_&&(this.viewModel=this.args.model_)},construct:function(){this.SUPER(),this.view=this.viewModel({dao:this.data[this.relationship.name],model:this.relationship.relatedModel},this.X).copyFrom(this.args),this.addChild(this.view)}},templates:[{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out(" ",self.view," "),out.toString()}}]});