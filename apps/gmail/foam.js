function lm(m){for(var i=0;i<LANGUAGE.length;i++)if(m.hasOwnProperty(LANGUAGE[i]))return m[LANGUAGE[i]];console.log("No language match for: ",m)}function MODEL(model){var proto;model.name?(GLOBAL[model.name]||(GLOBAL[model.name]=model.extendsModel?{__proto__:GLOBAL[model.extendsModel]}:{}),proto=GLOBAL[model.name]):proto=model.extendsProto?GLOBAL[model.extendsProto].prototype:GLOBAL[model.extendsObject],model.properties&&model.properties.forEach(function(p){Object.defineProperty(proto,p.name,{get:p.getter,enumerable:!1})});for(key in model.constants)Object.defineProperty(proto,key,{value:model.constants[key],writable:!0,enumerable:!1});if(Array.isArray(model.methods))model.methods.forEach(function(m){Object.defineProperty(proto,m.name,{value:m,writable:!0,enumerable:!1})});else for(var key in model.methods)Object.defineProperty(proto,key,{value:model.methods[key],writable:!0,enumerable:!1})}function defineProperties(proto,fns){for(var key in fns)try{Object.defineProperty(proto,key,{value:fns[key],configurable:!0,writable:!0})}catch(x){console.log("Warning: "+x)}}function prep(arg){return"string"==typeof arg?literal(arg):arg}function prepArgs(args){for(var i=0;i<args.length;i++)args[i]=prep(args[i]);return args}function range(c1,c2){var f=function(ps){return ps.head?ps.head<c1||ps.head>c2?void 0:ps.tail.setValue(ps.head):void 0};return f.toString=function(){return"range("+c1+", "+c2+")"},f}function literal(str,opt_value){var f=function(ps){for(var i=0;i<str.length;i++,ps=ps.tail)if(str.charAt(i)!==ps.head)return void 0;return ps.setValue(opt_value||str)};return f.toString=function(){return'"'+str+'"'},f}function literal_ic(str,opt_value){str=str.toLowerCase();var f=function(ps){for(var i=0;i<str.length;i++,ps=ps.tail)if(!ps.head||str.charAt(i)!==ps.head.toLowerCase())return void 0;return ps.setValue(opt_value||str)};return f.toString=function(){return'"'+str+'"'},f}function anyChar(ps){return ps.head?ps.tail:void 0}function notChar(c){return function(ps){return ps.head&&ps.head!==c?ps.tail.setValue(ps.head):void 0}}function notChars(s){return function(ps){return ps.head&&-1==s.indexOf(ps.head)?ps.tail.setValue(ps.head):void 0}}function not(p,opt_else){p=prep(p),opt_else=prep(opt_else);var f=function(ps){return this.parse(p,ps)?void 0:opt_else?this.parse(opt_else,ps):ps};return f.toString=function(){return"not("+p+")"},f}function optional(p){p=prep(p);var f=function(ps){return this.parse(p,ps)||ps.setValue(void 0)};return f.toString=function(){return"optional("+p+")"},f}function copyInput(p){p=prep(p);var f=function(ps){var res=this.parse(p,ps);return res?res.setValue(ps.str_.toString().substring(ps.pos,res.pos)):res};return f.toString=function(){return"copyInput("+p+")"},f}function lookahead(p){p=prep(p);var f=function(ps){return this.parse(p,ps)&&ps};return f.toString=function(){return"lookahead("+p+")"},f}function repeat(p,opt_delim,opt_min,opt_max){p=prep(p),opt_delim=prep(opt_delim);var f=function(ps){for(var ret=[],i=0;!opt_max||opt_max>i;i++){var res;if(opt_delim&&0!=ret.length){if(!(res=this.parse(opt_delim,ps)))break;ps=res}if(!(res=this.parse(p,ps)))break;ret.push(res.value),ps=res}return opt_min&&ret.length<opt_min?void 0:ps.setValue(ret)};return f.toString=function(){return"repeat("+p+", "+opt_delim+", "+opt_min+", "+opt_max+")"},f}function plus(p){return repeat(p,void 0,1)}function noskip(p){return function(ps){return this.skip_=!1,ps=this.parse(p,ps),this.skip_=!0,ps}}function repeat0(p){return p=prep(p),function(ps){for(var res;res=this.parse(p,ps);)ps=res;return ps.setValue("")}}function seq(){var args=prepArgs(arguments),f=function(ps){for(var ret=[],i=0;i<args.length;i++){if(!(ps=this.parse(args[i],ps)))return void 0;ret.push(ps.value)}return ps.setValue(ret)};return f.toString=function(){return"seq("+argsToArray(args).join(",")+")"},f}function seq1(n){var args=prepArgs(argsToArray(arguments).slice(1)),f=function(ps){for(var ret,i=0;i<args.length;i++){if(!(ps=this.parse(args[i],ps)))return void 0;i==n&&(ret=ps.value)}return ps.setValue(ret)};return f.toString=function(){return"seq1("+n+", "+argsToArray(args).join(",")+")"},f}function invalidateParsers(){parserVersion_++}function simpleAlt(){var args=prepArgs(arguments);if(1==args.length)return args[0];var f=function(ps){for(var i=0;i<args.length;i++){var res=this.parse(args[i],ps);if(res)return res}return void 0};return f.toString=function(){return"alt("+argsToArray(args).join(" | ")+")"},f}function alt(){function nullParser(){return void 0}function testParser(p,ps){var c=ps.head,trapPS={getValue:function(){return this.value},setValue:function(v){return this.value=v,this},value:ps.value,head:c},goodChar=!1;return trapPS.__defineGetter__("tail",function(){return goodChar=!0,{value:this.value,getValue:function(){return this.value},setValue:function(v){this.value=v}}}),this.parse(p,trapPS),goodChar}function getParserForChar(ps){var c=ps.head,p=map[c];if(!p){for(var alts=[],i=0;i<args.length;i++){var parser=args[i];testParser.call(this,parser,ps)&&alts.push(parser)}p=0==alts.length?nullParser:1==alts.length?alts[0]:simpleAlt.apply(null,alts),map[c]=p}return p}var SIMPLE_ALT=simpleAlt.apply(null,arguments),args=prepArgs(arguments),map={},parserVersion=parserVersion_;return function(ps){parserVersion!==parserVersion_&&(map={},parserVersion=parserVersion_);var r1=this.parse(getParserForChar.call(this,ps),ps);return r1}}function str(p){p=prep(p);var f=function(ps){var ps=this.parse(p,ps);return ps?ps.setValue(ps.value.join("")):void 0};return f.toString=function(){return"str("+p+")"},f}function pick(as,p){p=prep(p);var f=function(ps){var ps=this.parse(p,ps);if(!ps)return void 0;for(var ret=[],i=0;i<as.length;i++)ret.push(ps.value[as[i]]);return ps.setValue(ret)};return f.toString=function(){return"pick("+as+", "+p+")"},f}function parsedebug(p){return function(ps){var old=DEBUG_PARSE;DEBUG_PARSE=!0;var ret=this.parse(p,ps);return DEBUG_PARSE=old,ret}}function sym(name){var f=function(ps){var p=this[name];return p||console.log("PARSE ERROR: Unknown Symbol <"+name+">"),this.parse(p,ps)};return f.toString=function(){return"<"+name+">"},f}function defineTTLProperty(obj,name,ttl,f){Object.defineProperty(obj,name,{get:function(){var accessed,value=void 0;return Object.defineProperty(this,name,{get:function(){function scheduleTimer(){setTimeout(function(){accessed?scheduleTimer():value=void 0,accessed=!1},ttl)}return value?accessed=!0:(accessed=!1,value=f(),scheduleTimer()),value}}),this[name]}})}function lookup(key){if(!key)return void 0;if("string"!=typeof key)return key;var root=this,cache;cache=this.hasOwnProperty("lookupCache_")?this.lookupCache_:this.lookupCache_={};var ret=cache[key];if(!ret){for(var path=key.split("."),i=0;root&&i<path.length;i++)root=root[path[i]];ret=root,ret&&(cache[key]=ret)}return ret}function set(key,value){Object.defineProperty(this,key,{value:value,writable:"window"!==key,configurable:!0})}function setValue(key,value){var X=this;Object.defineProperty(this,key,{get:function(){return X.set(key,value.get()),X[key]},configurable:!0})}function sub(opt_args,opt_name){var sub=Object.create(this);if(opt_args)for(var key in opt_args)opt_args.hasOwnProperty(key)&&sub.set(key,opt_args[key]);return opt_name&&(sub.NAME=opt_name,sub.toString=function(){return"CONTEXT("+opt_name+")"}),sub}function subWindow(w,opt_name,isBackground){return w?foam.ui.Window.create({window:w,name:opt_name,isBackground:isBackground},this).Y:this.sub()}function elementFromString(str){return str.element||(str.element=HTMLParser.create().parseString(str).children[0])}function $addWindow(w){w.window.$WID=$WID__++,$documents.push(w.document)}function $removeWindow(w){for(var i=$documents.length-1;i>=0;i--)$documents[i].defaultView&&$documents[i].defaultView!==w||$documents.splice(i,1)}function arequire(modelName,opt_X){var X=opt_X||GLOBAL.X,model=X.lookup(modelName);if(!model){if(!X.ModelDAO)return aconstant();if(X.arequire$ModelLoadsInProgress){if(X.arequire$ModelLoadsInProgress[modelName])return X.arequire$ModelLoadsInProgress[modelName]}else X.set("arequire$ModelLoadsInProgress",{});var future=afuture();return X.ModelDAO.find(modelName,{put:function(m){var m=X.lookup(modelName);delete X.arequire$ModelLoadsInProgress[modelName],arequireModel(m,X)(future.set)},error:function(){var args=argsToArray(arguments);console.warn.apply(console,["Could not load model: ",modelName].concat(args)),delete X.arequire$ModelLoadsInProgress[modelName],future.set(void 0)}}),X.arequire$ModelLoadsInProgress[modelName]=future.get,future.get}return model?arequireModel(model,X):void console.log(modelName,"not found")}function arequireModel(model,param_X){if(model.required__)opt_X&&opt_X.i18nModel&&opt_X.i18nModel(model,opt_X);else{var args=[],future=afuture();model.required__=future.get;var opt_X=param_X||X;model.extendsModel&&args.push(arequire(model.extendsModel,opt_X));var i;if(model.traits)for(i=0;i<model.traits.length;i++)args.push(arequire(model.traits[i],opt_X));if(model.templates)for(i=0;i<model.templates.length;i++){var t=model.templates[i];args.push(aevalTemplate(model.templates[i],model),function(t){return function(ret,m){model.getPrototype()[t.name]=m,ret()}}(t))}if(args.length&&(args=[aseq.apply(null,args)]),model.requires)for(var i=0;i<model.requires.length;i++){var r=model.requires[i],m=r.split(" as ");m[0]==model.id?console.warn("Model requires itself: "+model.id):args.push(arequire(m[0],opt_X))}aseq(apar.apply(apar,args),opt_X&&opt_X.i18nModel&&opt_X.i18nModel.bind(this,model,opt_X)||aconstant(model))(function(m){m.finished__=!0,future.set(m)})}return model.required__}function packagePath(X,path){function packagePath_(Y,path,i){return i===path.length?Y:(Y[path[i]]||(Y[path[i]]={},0==i&&(GLOBAL[path[i]]=Y[path[i]])),packagePath_(Y[path[i]],path,i+1))}return path?packagePath_(X,path.split("."),0):GLOBAL}function registerModel(model,opt_name){var root=model["package"]?this:GLOBAL,name=model.name,package=model["package"];if(opt_name){var a=opt_name.split(".");name=a.pop(),package=a.join(".")}var path=packagePath(root,package);if(Object.defineProperty(path,name,{value:model,configurable:!0}),root.lookupCache_){var cache=root.lookupCache_,modelRegName=(package?package+".":"")+name;cache[modelRegName]&&(cache[modelRegName]=model)}this.onRegisterModel(model)}function CLASS(m){function registerModelLatch(path,m){var id=m["package"]?m["package"]+"."+m.name:m.name;UNUSED_MODELS[id]=!0,m["package"]||Object.defineProperty(GLOBAL,m.name,{get:function(){return path[m.name]},configurable:!0}),Object.defineProperty(path,m.name,{get:function(){USED_MODELS[id]=!0,delete UNUSED_MODELS[id],Object.defineProperty(path,m.name,{value:null,configurable:!0});var work=[],model=JSONUtil.mapToObj(X,m,Model,work);return work.length>0&&model.required__&&(model.required__=aseq(aseq.apply(null,work),model.required__)),X.registerModel(model),model},configurable:!0})}document&&document.currentScript&&(m.sourcePath=document.currentScript.src),registerModelLatch(packagePath(X,m["package"]),m)}function INTERFACE(imodel){var i=JSONUtil.mapToObj(X,imodel,Interface);packagePath(X,i["package"])[i.name]=i;var id=i["package"]?i["package"]+"."+i.name:i.name;NONMODEL_INSTANCES[id]=!0}function onRegisterModel(m){}function defineLocalProperty(cls,name,factory){Object.defineProperty(cls,name,{get:function(){console.assert(this!==cls,"Called property getter from prototype: "+name);var value=factory.call(this);return Object.defineProperty(this,name,{value:value}),value},configurable:!0})}function override(cls,methodName,method){var super_=cls[methodName],SUPER=function(){return super_.apply(this,arguments)},slowF=function(OLD_SUPER,args){try{return method.apply(this,args)}finally{this.SUPER=OLD_SUPER}},f=function(){var OLD_SUPER=this.SUPER;if(this.SUPER=SUPER,OLD_SUPER)return slowF.call(this,OLD_SUPER,arguments);var ret=method.apply(this,arguments);return this.SUPER=null,ret};f.toString=function(){return method.toString()},f.super_=super_,cls[methodName]=f}function recopyModelFeatures(m){m.model_=Model,m.methods=m.methods,m.templates=m.templates,m.relationships=m.relationships,m.properties=m.properties,m.actions=m.actions,m.listeners=m.listeners,m.models=m.models,m.tests=m.tests,m.issues=m.issues,DEBUG&&BootstrapModel.saveDefinition(m)}function toNum(p){return p.replace?parseInt(p.replace("px","")):p}function compile_(a){return a.f?a:a===!0?TRUE:a===!1?FALSE:ConstantExpr.create({arg1:a})}function compileArray_(args){for(var b=[],i=0;i<args.length;i++){var a=args[i];null!==a&&void 0!==a&&b.push(compile_(a))}return b}function MAX(expr){return MaxExpr.create({arg1:expr})}function EXPLAIN(arg){return ExplainExpr.create({arg1:arg})}function COUNT(){return CountExpr.create()}function IN(arg1,arg2){return InExpr.create({arg1:compile_(arg1),arg2:arg2})}function EQ(arg1,arg2){var eq=EqExpr.create();return eq.instance_.arg1=compile_(arg1),eq.instance_.arg2=compile_(arg2),eq}function LT(arg1,arg2){return LtExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function GT(arg1,arg2){return GtExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function LTE(arg1,arg2){return LteExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function GTE(arg1,arg2){return GteExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function AND(){return AndExpr.create({args:compileArray_.call(null,arguments)})}function SUM(expr){return SumExpr.create({arg1:expr})}function MIN(expr){return MinExpr.create({arg1:expr})}function AVG(expr){return AvgExpr.create({arg1:expr})}function SEQ(){return SeqExpr.create({args:argsToArray(arguments)})}function UPDATE(expr,dao){return UpdateExpr.create({args:compileArray_.call(null,Array.prototype.slice.call(arguments,0,-1)),dao:arguments[arguments.length-1]})}function SET(arg1,arg2){return SetExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function GROUP_BY(expr1,opt_expr2){return GroupByExpr.create({arg1:expr1,arg2:opt_expr2||[].sink})}function GRID_BY(xFunc,yFunc,acc){return GridByExpr.create({xFunc:xFunc,yFunc:yFunc,acc:acc})}function MAP(fn,opt_sink){return MapExpr.create({arg1:fn,arg2:opt_sink||[].sink})}function DISTINCT(fn,sink){return DistinctExpr.create({arg1:fn,arg2:sink})}function OR(){return OrExpr.create({args:compileArray_.call(null,arguments)})}function NOT(arg){return NotExpr.create({arg1:compile_(arg)})}function NEQ(arg1,arg2){return NeqExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function STARTS_WITH(arg1,arg2){return StartsWithExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function STARTS_WITH_IC(arg1,arg2){return StartsWithICExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function CONTAINS(arg1,arg2){return ContainsExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function CONTAINS_IC(arg1,arg2){return ContainsICExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function CONCAT(){return ConcatExpr.create({args:compileArray_.call(null,arguments)})}function TREE(parentProperty,childrenProperty){return TreeExpr.create({parentProperty:parentProperty,childrenProperty:childrenProperty})}function ADD(arg1,arg2){return AddExpr.create({arg1:compile_(arg1),arg2:compile_(arg2)})}function DESC(arg1){return DescExpr.isInstance(arg1)?arg1.arg1:DescExpr.create({arg1:arg1})}function MQL(mql){return MQLExpr.create({arg1:mql})}function KEYWORD(word){return KeywordExpr.create({arg1:word})}function atxn(afunc){return function(ret){if(GLOBAL.__TXN__)afunc.apply(this,arguments);else{GLOBAL.__TXN__={};var a=argsToArray(arguments);a[0]=function(){GLOBAL.__TXN__=void 0,ret()},afunc.apply(this,a)}}}function dump(o){return Array.isArray(o)?"["+o.map(dump).join(",")+"]":o?o.toString():"<undefined>"}function deferJsonP(X){var future=afuture();return X.ajsonp=function(){var args=arguments;return function(ret){future.get(function(f){f.apply(void 0,args)(ret)})}},future}var LANGUAGE="en";navigator&&navigator.language&&(LANGUAGE=navigator.language),function(){var m=/[?&]hl=([^&]*)/.exec(window.location.search);m&&(LANGUAGE=m[1]);var a=LANGUAGE.split("-");LANGUAGE=[];for(var ls=[],i=a.length-1;i>=0;i--)LANGUAGE.push(a.slice(0,i+1).join("-"));"en"!==LANGUAGE[LANGUAGE.length-1]&&LANGUAGE.push("en")}();var DEBUG=DEBUG||!1,GLOBAL=GLOBAL||this;MODEL({extendsObject:"GLOBAL",methods:[function memoize(f){var cache={},g=function(){var key=argsToArray(arguments).toString();return cache.hasOwnProperty(key)||(cache[key]=f.apply(this,arguments)),cache[key]};return g.name=f.name,g},function memoize1(f){var cache={},g=function(arg){var key=arg.toString();return cache.hasOwnProperty(key)||(cache[key]=f.call(this,arg)),cache[key]};return g.name=f.name,g},function constantFn(v){return function(){return v}},function latchFn(f){var tripped=!1,val;return function(){return tripped||(tripped=!0,val=f(),f=void 0),val}},function argsToArray(args){for(var array=new Array(args.length),i=0;i<args.length;i++)array[i]=args[i];return array},function StringComparator(s1,s2){return s1==s2?0:s2>s1?-1:1},function equals(a,b){return a===b||a!==a&&b!==b},function toCompare(c){return Array.isArray(c)?CompoundComparator.apply(null,c):c.compare?c.compare.bind(c):c},function CompoundComparator(){for(var args=argsToArray(arguments),cs=[],i=0;i<args.length;i++)cs[i]=toCompare(args[i]);var f=function(o1,o2){for(var i=0;i<cs.length;i++){var r=cs[i](o1,o2);if(0!=r)return r}return 0};return f.toSQL=function(){return args.map(function(s){return s.toSQL()}).join(",")},f.toMQL=function(){return args.map(function(s){return s.toMQL()}).join(" ")},f.toBQL=function(){return args.map(function(s){return s.toBQL()}).join(" ")},f.toString=f.toSQL,f},function randomAct(){for(var totalWeight=0,i=0;i<arguments.length;i+=2)totalWeight+=arguments[i];for(var r=Math.random(),i=0,weight=0;i<arguments.length;i+=2)if(weight+=arguments[i],weight/totalWeight>=r)return void arguments[i+1]()},function Object_forEach(obj,fn){for(var key in obj)obj.hasOwnProperty(key)&&fn(obj[key],key)},function predicatedSink(predicate,sink){return predicate!==TRUE&&sink?{__proto__:sink,$UID:sink.$UID,put:function(obj,s,fc){!sink.put||obj&&!predicate.f(obj)||sink.put(obj,s,fc)},remove:function(obj,s,fc){!sink.remove||obj&&!predicate.f(obj)||sink.remove(obj,s,fc)},reset:function(){sink.reset()},toString:function(){return"PredicatedSink("+sink.$UID+", "+predicate+", "+sink+")"}}:sink},function limitedSink(count,sink){var i=0;return{__proto__:sink,put:function(obj,s,fc){i++>=count&&fc?fc.stop():sink.put(obj,s,fc)}}},function skipSink(skip,sink){var i=0;return{__proto__:sink,put:function(obj,s,fc){i++>=skip&&sink.put(obj,s,fc)}}},function orderedSink(comparator,sink){return comparator=toCompare(comparator),{__proto__:sink,i:0,arr:[],put:function(obj,s,fc){this.arr.push(obj)},eof:function(){this.arr.sort(comparator),this.arr.select(sink)}}},function defineLazyProperty(target,name,definitionFn){Object.defineProperty(target,name,{get:function(){var definition=definitionFn.call(this);return Object.defineProperty(this,name,definition),definition.get?definition.get.call(this):definition.value},configurable:!0})},function multiline(f){var s=f.toString(),start=s.indexOf("/*"),end=s.lastIndexOf("*/");return s.substring(start+2,end)},function findPageXY(node){for(var x=0,y=0,parent;node;)parent=node,x+=node.offsetLeft,y+=node.offsetTop,node=node.offsetParent;return[x,y,parent]},function findViewportXY(node){var rect=node.getBoundingClientRect();return[rect.left,rect.top]},function nop(){},function stringtoutf8(str){for(var res=[],i=0;i<str.length;i++){var code=str.charCodeAt(i),count=0;128>code&&res.push(code)}return res}]});var constantize=memoize1(function(str){return"x"===str?"X_":"y"===str?"Y_":str.replace(/[a-z_][^0-9a-z_]/g,function(a){return a.substring(0,1)+"_"+a.substring(1,2)}).toUpperCase()}),capitalize=memoize1(function(str){return str[0].toUpperCase()+str.substring(1)});MODEL({extendsProto:"Object",properties:[{name:"$UID",getter:function(){var id=1;return function(){return Object.hasOwnProperty.call(this,"$UID__")?this.$UID__:(this.$UID__=id,id++,this.$UID__)}}()}],methods:[function clone(){return this},function deepClone(){return this.clone()},function become(other){for(var local=Object.getOwnPropertyNames(this),i=0;i<local.length;i++)delete this[local[i]];var remote=Object.getOwnPropertyNames(other);for(i=0;i<remote.length;i++)Object.defineProperty(this,remote[i],Object.getOwnPropertyDescriptor(other,remote[i]));this.__proto__=other.__proto__}]}),MODEL({extendsProto:"Array",constants:{oldForEach_:Array.prototype.forEach},methods:[function forEach(f,opt_this){if(!this||!f||opt_this)return this.oldForEach_.call(this,f,opt_this);for(var l=this.length,i=0;l>i;i++)f(this[i],i,this)},function diff(other){for(var added=other.slice(0),removed=[],i=0;i<this.length;i++){for(var j=0;j<added.length;j++)if(0==this[i].compareTo(added[j])){added.splice(j,1),j--;break}j==added.length&&removed.push(this[i])}return{added:added,removed:removed}},function binaryInsert(item){for(var start=0,end=this.length-1;end>=start;){var m=start+Math.floor((end-start)/2),c=item.compareTo(this[m]);if(0==c)return this;0>c?end=m-1:start=m+1}return this.splice(start,0,item),this},function union(other){return this.concat(other.filter(function(o){return-1==this.indexOf(o)}.bind(this)))},function intersection(other){return this.filter(function(o){return-1!=other.indexOf(o)})},function intern(){for(var i=0;i<this.length;i++)this[i].intern&&(this[i]=this[i].intern());return this},function compareTo(other){if(this.length!==other.length)return-1;for(var i=0;i<this.length;i++){var result=this[i].compareTo(other[i]);if(0!==result)return result}return 0},function fReduce(comparator,arr){compare=toCompare(comparator);for(var result=[],i=0,j=0,k=0;i<this.length&&j<arr.length;){var a=compare(this[i],arr[j]);0>a?result[k++]=this[i++]:0!=a?result[k++]=arr[j++]:(result[k++]=this[i++],result[k++]=arr[j++])}return i!=this.length&&(result=result.concat(this.slice(i))),j!=arr.length&&(result=result.concat(arr.slice(j))),result},function pushAll(arr){return this.push.apply(this,arr),this.length},function mapFind(map){for(var i=0;i<this.length;i++){var result=map(this[i],i);if(result)return result}},function mapProp(prop){return this.map(function(x){return x[prop]})},function mapCall(){var args=Array.prototype.slice.call(arguments,0),func=args.shift();return this.map(function(x){return x[func]&&x[func].apply(x[func],args)})}],properties:[{name:"memento",getter:function(){throw"Array's can not be memorized properly as a memento."}}]}),MODEL({extendsProto:"String",methods:[function indexOfIC(a){return a.length>this.length?-1:this.toUpperCase().indexOf(a.toUpperCase())},function equals(other){return 0===this.compareTo(other)},function equalsIC(other){return other&&this.toUpperCase()===other.toUpperCase()},function capitalize(){return this.charAt(0).toUpperCase()+this.slice(1)},function labelize(){return this.replace(/[a-z][A-Z]/g,function(a){return a.charAt(0)+" "+a.charAt(1)}).capitalize()},function clone(){return this.toString()},function compareTo(o){return o==this?0:o>this?-1:1},String.prototype.startsWith||function startsWith(a){return 0==this.lastIndexOf(a,0)},function startsWithIC(a){if(a.length>this.length)return!1;for(var l=a.length,i=0;l>i;i++)if(this[i].toUpperCase()!==a[i].toUpperCase())return!1;return!0},function put(obj){return this+obj.toJSON()},function(){var map={};return function intern(){return map[this]||(map[this]=this.toString())}}(),function hashCode(){var hash=0;if(0==this.length)return hash;for(i=0;i<this.length;i++){var code=this.charCodeAt(i);hash=(hash<<5)-hash+code,hash&=hash}return hash}]}),MODEL({extendsProto:"Function",methods:[function(){var oldBind=Function.prototype.bind,simpleBind=function(f,self){return function(){return f.apply(self,arguments)}};return function bind(arg){return 1==arguments.length?simpleBind(this,arg):oldBind.apply(this,argsToArray(arguments))}}(),function equals(o){return this===o},function compareTo(o){return this===o?0:this.name.compareTo(o.name)||1},function o(f2){var f1=this;return function(){return f1.call(this,f2.apply(this,argsToArray(arguments)))}}]}),MODEL({extendsObject:"Math",methods:[function sign(n){return n>0?1:-1}]}),MODEL({extendsProto:"Date",methods:[function toRelativeDateString(){var seconds=Math.floor((Date.now()-this.getTime())/1e3);if(60>seconds)return"moments ago";var minutes=Math.floor(seconds/60);if(1==minutes)return"1 minute ago";if(60>minutes)return minutes+" minutes ago";var hours=Math.floor(minutes/60);if(1==hours)return"1 hour ago";if(24>hours)return hours+" hours ago";var days=Math.floor(hours/24);if(1==days)return"1 day ago";if(7>days)return days+" days ago";if(365>days){var year=1900+this.getYear(),noyear=this.toDateString().replace(" "+year,"");return noyear.substring(4)}return this.toDateString().substring(4)},function compareTo(o){if(o===this)return 0;if(!o)return 1;var d=this.getTime()-o.getTime();return 0==d?0:d>0?1:-1},function toMQL(){return this.getFullYear()+"/"+(this.getMonth()+1)+"/"+this.getDate()},function toBQL(){var str=this.toISOString();return str.substring(0,str.indexOf("."))}]}),MODEL({extendsProto:"Number",methods:[function compareTo(o){return o==this?0:o>this?-1:1},function clone(){return+this}]}),MODEL({extendsProto:"Boolean",methods:[function compareTo(o){return(this.valueOf()?1:0)-(o?1:0)}]}),MODEL({extendsProto:"RegExp",methods:[function quote(str){return(str+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}]}),console.log.json=function(){for(var args=[],i=0;i<arguments.length;i++){var arg=arguments[i];args.push(arg&&arg.toJSON?arg.toJSON():arg)}console.log.apply(console,args)},console.log.str=function(){for(var args=[],i=0;i<arguments.length;i++){var arg=arguments[i];args.push(arg&&arg.toString?arg.toString():arg)}console.log.apply(console,args)},console.log.put=console.log.bind(console),console.log.remove=console.log.bind(console,"remove: "),console.log.error=console.log.bind(console,"error: "),console.log.json.put=console.log.json.bind(console),console.log.json.reduceI=console.log.json.bind(console,"reduceI: "),console.log.json.remove=console.log.json.bind(console,"remove: "),console.log.json.error=console.log.json.bind(console,"error: "),console.log.str.put=console.log.str.bind(console),console.log.str.remove=console.log.str.bind(console,"remove: "),console.log.str.error=console.log.str.bind(console,"error: "),document.put=function(obj){obj.write?obj.write(this):this.write(obj.toString())},window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem,window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.setImmediate,window.Blob&&(Blob.prototype.slice=Blob.prototype.slice||Blob.prototype.webkitSlice),window.XMLHttpRequest&&(XMLHttpRequest.prototype.asend=function(ret,opt_data){var xhr=this;xhr.onerror=function(){console.log("XHR Error: ",arguments)},xhr.onloadend=function(){ret(xhr.response,xhr)},xhr.send(opt_data)}),String.fromCharCode=function(){var oldLookup=String.fromCharCode,lookupTable=[];return function(a){if(1==arguments.length)return lookupTable[a]||(lookupTable[a]=oldLookup(a));for(var result="",i=0;i<arguments.length;i++)result+=lookupTable[arguments[i]]||(lookupTable[arguments[i]]=oldLookup(arguments[i]));return result}}();var ProtoWriter={create:function(){return{__proto__:this,value_:[]}},get value(){return new Uint8Array(this.value_)},varint:function(i){for(;i>127;)this.value_.push(127&i|128),i=Math.floor(i/Math.pow(2,7));this.value_.push(i)},bytes:function(b){this.value_=this.value_.concat(b)},varintstring:function(str){for(var bytes=[],i=str.length-2;i>-2;i-=2){var sub=0>i?str.substr(0,1):str.substr(i,2);bytes.push(parseInt(sub,16))}for(var buf=0,i=0;i<bytes.length-1;i++)buf>>>=7,buf|=bytes[i]<<i,this.value_.push(127&buf|128);buf>>>=7,buf|=bytes[i]<<i,this.varint(buf)},bytestring:function(str){for(var bytes=[],i=0;i<str.length;i+=2)bytes.push(parseInt(str.substr(i,2),16));this.bytes(bytes)},message:function(m){var temp=ProtoWriter.create(),data=m.outProtobuf(temp);temp=temp.value_,this.varint(temp.length),this.bytes(temp)}},SocketManager={create:function(){return{__proto__:this}},get:function(address){var parts=address.split(":"),type=parts[0],host=parts[1],port=parseInt(parts[2]);return amemo(function(cb){chrome.socket.create(type,{},function(info){chrome.socket.connect(info.socketId,host,port,function(result){return 0==result?void cb({socketId:info.socketId}):void cb(null)})})})}};MODEL({extendsProto:"Function",methods:[function abind(self){return function(ret){this.apply(self,arguments),ret()}.bind(this)},function ao(f2){var f1=this;return function(ret){var args=argsToArray(arguments);args[0]=f1.bind(this,ret),f2.apply(this,args)}},function aseq(f2){return f2.ao(this)}]}),MODEL({extendsObject:"GLOBAL",methods:[function anop(ret){ret&&ret(void 0)},function alog(){var args=arguments;return function(ret){console.log.apply(console,args),ret&&ret.apply(this,[].slice.call(arguments,1))}},function aprofile(afunc){return function(ret){var a=argsToArray(arguments);console.profile("aprofile");var ret2=function(){console.profileEnd(),ret&&ret(arguments)};aapply_(afunc,ret2,a)}},function aconstant(v){return function(ret){ret&&ret(v)}},function arepeat(n,afunc){return n?function(ret){var a=argsToArray(arguments);a.splice(1,0,0,n);var next=atramp(function(){return a[1]==n-1?(a[0]=ret,void afunc.apply(this,a)):(afunc.apply(this,a),void a[1]++)});a[0]=next,next.apply(this,a)}:anop},function aforEach(arr,afunc){},function awhile(cond,afunc){return function(ret){var a=argsToArray(arguments),g=function(){return cond()?void afunc.apply(this,a):void ret.apply(void 0,arguments)};a[0]=g,g.apply(this,a)}},function aif(cond,afunc,aelse){return function(ret){("function"==typeof cond?cond():cond)?afunc.apply(this,arguments):aelse?aelse.apply(this,arguments):ret()}},function aaif(acond,afunc,aelse){return function(ret){var args=argsToArray(arguments);args[0]=function(c){args[0]=ret,c?afunc.apply(null,args):aelse?aelse.apply(null,args):ret()},acond.apply(null,args)}},function(){var id=1,activeOps={};return function atime(str,afunc,opt_endCallback,opt_startCallback){var name=str;return aseq(function(ret){activeOps[str]?(name+="-"+id++,activeOps[str]++):activeOps[str]=1;var start=performance.now();opt_startCallback&&opt_startCallback(name),opt_endCallback||console.time(name),ret.apply(null,[].slice.call(arguments,1))},afunc,function(ret){if(activeOps[str]--,opt_endCallback){var end=performance.now();opt_endCallback(name,end-start)}else console.timeEnd(name);ret&&ret.apply(null,[].slice.call(arguments,1))})}}(),function ametric(){return this.atime.apply(this,arguments)},function asleep(ms){return function(ret){window.setTimeout(ret,ms)}},function ayield(){return function(ret){window.setTimeout(ret,0)}},function afuture(){var set=!1,values=void 0,waiters=[];return{set:function(){if(set)return void console.log("ERROR: redundant set on future");values=arguments,set=!0;for(var i=0;i<waiters.length;i++)waiters[i].apply(null,values);waiters=void 0},get:function(ret){return set?void ret.apply(null,values):void waiters.push(ret)}}},function aapply_(f,ret,args){args.unshift(ret),f.apply(this,args)},function arequestqueue(f,opt_lock,opt_max){var lock=opt_lock||{};lock.q||(lock.q=[],lock.active=null);var onExit=function(){var next=lock.active=lock.q.pop();next&&setTimeout(function(){f(onExit,next)},0)},reduceDown=function(o,q){for(var i=q.length-1;i>=0;i--){var result=o.reduce(q[i]);if(result){q.splice(i,1),reduceDown(result,q);break}}q.push(o)};return function(o){if(lock.active){var first=o.reduce(lock.active);if(first&&first.equals(lock.active))return}reduceDown(o,lock.q,lock.q.length-1),lock.q.length>opt_max&&(lock.q.length=opt_max),lock.active||onExit()}},function asynchronized(f,opt_lock){function onExit(ret){return function(){var next=lock.q.shift();next?setTimeout(next,0):lock.active=!1,ret()}}var lock=opt_lock||{};return lock.q||(lock.q=[],lock.active=!1),function(ret){return lock.active?void lock.q.push(function(){f(onExit(ret))}):(lock.active=!0,void f(onExit(ret)))
}},function atimeout(delay,f,opt_timeoutF){return function(ret){var timedOut=!1,completed=!1;setTimeout(function(){completed||(timedOut=!0,console.log("timeout"),opt_timeoutF&&opt_timeoutF())},delay),f(aseq(function(ret){timedOut||(completed=!0),completed&&ret()},ret))}},function amemo(f,opt_ttl){var memoized=!1,values,waiters,age=0,pending=!1;return function(ret){if(memoized)return ret.apply(null,values),void(void 0!=opt_ttl&&!pending&&Date.now()>age+opt_ttl&&(pending=!0,f(function(){values=arguments,age=Date.now(),pending=!1})));var first=!waiters;first&&(waiters=[]),waiters.push(ret),first&&f(function(){values=arguments,age=Date.now();for(var i=0;i<waiters.length;i++)waiters[i]&&waiters[i].apply(null,values);void 0==opt_ttl&&(f=void 0),memoized=!0,waiters=void 0})}},function amerged(f){var waiters;return function(ret){var first=!waiters;if(first){waiters=[];var args=argsToArray(arguments)}waiters.push(ret),first&&(args[0]=function(){var calls=waiters;waiters=void 0;for(var i=0;i<calls.length;i++)calls[i]&&calls[i].apply(null,arguments)},f.apply(null,args))}},function mergeAsync(f){var active=!1,args;return function(){if(active)return void(args=argsToArray(arguments));active=!0;var ret=function(){args?(args.unshift(ret),f.apply(null,args),args=void 0):active=!1},a=argsToArray(arguments);a.unshift(ret),f.apply(null,a)}},function ao(){for(var ret=arguments[arguments.length-1],i=0;i<arguments.length-1;i++)ret=arguments[i].ao(ret);return ret},function aseq(){for(var f=arguments[arguments.length-1],i=arguments.length-2;i>=0;i--)f=arguments[i].aseq(f);return f},function apar(){var aargs=[],count=0,fs=arguments;return function(ret){if(0==fs.length)return void(ret&&ret());for(var opt_args=Array.prototype.splice.call(arguments,1),join=function(i){if(aargs[i]=Array.prototype.splice.call(arguments,1),++count==fs.length){for(var a=[],j=0;j<fs.length;j++)for(var k=0;k<aargs[j].length;k++)a.push(aargs[j][k]);ret&&ret.apply(null,a)}},i=0;i<fs.length;i++)fs[i].apply(null,[join.bind(null,i)].concat(opt_args))}},function(){var active=!1,jobs=[];return function atramp(afunc){return function(){if(jobs.push([afunc,arguments]),!active){console.assert(jobs.length<=1,"atramp with multiple jobs"),active=!0;for(var job;null!=(job=jobs.pop());)job[0].apply(this,job[1]);active=!1}}}}(),function arepeatpar(n,afunc){return function(ret){if(0===n)return void(ret&&ret());for(var aargs=[],count=0,opt_args=Array.prototype.splice.call(arguments,1),join=function(i){if(++count==n){var a=[];ret&&ret.apply(null,a)}},i=0;n>i;i++)afunc.apply(null,[join.bind(null,i)].concat([i,n]).concat(opt_args))}},function axhr(url,opt_op,opt_params){var op=opt_op||"GET",params=opt_params||[];return function(ret){var xhr=new XMLHttpRequest;xhr.open(op,url),xhr.asend(function(json){ret(JSON.parse(json))},params&&params.join("&"))}},function futurefn(future){return function(){var args=arguments;future.get(function(f){f.apply(void 0,args)})}},function adelay(afunc,delay){function pump(){if(!timeout&&queue.length){var top=queue.shift(),f=top[0],args=top[1],ret=args[0];args[0]=function(){ret.apply(null,arguments),pump()},timeout=setTimeout(function(){timeout=0,f.apply(null,args)},delay)}}var queue=[],timeout;return function(){var args=arguments;queue.push([afunc,args]),pump()}}]});var __JSONP_CALLBACKS__={},wrapJsonpCallback=function(){var nextID=0;return function(ret,opt_nonce){var id="c"+nextID++;opt_nonce&&(id+=Math.floor(16777215*Math.random()).toString(16));var cb=__JSONP_CALLBACKS__[id]=function(data){delete __JSONP_CALLBACKS__[id],ret&&ret.call(this,data)};return cb.id=id,cb}}(),ajsonp=function(url,params){return function(ret){var cb=wrapJsonpCallback(ret),script=document.createElement("script");script.src=url+"?callback=__JSONP_CALLBACKS__."+cb.id+(params?"&"+params.join("&"):""),script.onload=function(){document.body.removeChild(this)},script.onerror=function(){cb(null),document.body.removeChild(this)},document.body.appendChild(script)}},StringPS={create:function(str){var o=Object.create(this);return o.pos=0,o.str_=[str],o.tail_=[],o},set str(str){this.str_[0]=str},get head(){return this.pos>=this.str_[0].length?null:this.str_[0].charAt(this.pos)},get value(){return this.hasOwnProperty("value_")?this.value_:this.str_[0].charAt(this.pos-1)},get tail(){if(!this.tail_[0]){var tail=Object.create(this.__proto__);tail.str_=this.str_,tail.pos=this.pos+1,tail.tail_=[],this.tail_[0]=tail}return this.tail_[0]},setValue:function(value){var ret=Object.create(this.__proto__);return ret.str_=this.str_,ret.pos=this.pos,ret.tail_=this.tail_,ret.value_=value,ret},toString:function(){return this.str_[0].substring(this.pos)}},parserVersion_=1,DEBUG_PARSE=!1,grammar={parseString:function(str){var ps=this.stringPS;ps.str=str;var res=this.parse(this.START,ps);return res&&res.value},parse:function(parser,pstream){DEBUG_PARSE&&pstream.str_&&(console.log(new Array(pstream.pos).join("."),pstream.head),console.log(pstream.pos+"> "+pstream.str_[0].substring(0,pstream.pos)+"("+pstream.head+")"));var ret=parser.call(this,pstream);return DEBUG_PARSE&&console.log(parser+" ==> "+!!ret+"  "+(ret&&ret.value)),ret},"export":function(str){return this[str].bind(this)},addAction:function(sym,action){var p=this[sym];this[sym]=function(ps){var val=ps.value,ps2=this.parse(p,ps);return ps2&&ps2.setValue(action.call(this,ps2.value,val))},this[sym].toString=function(){return"<<"+sym+">>"}},addActions:function(map){for(var key in map)this.addAction(key,map[key]);return this}};defineTTLProperty(grammar,"stringPS",3e4,function(){return StringPS.create("")});var SkipGrammar={create:function(gramr,skipp){return{__proto__:gramr,skip_:!0,parse:function(parser,pstream){return this.skip_&&(pstream=this.skip.call(grammar,pstream)||pstream),this.__proto__.parse.call(this,parser,pstream)},skip:skipp}}},VersionParser={__proto__:grammar,START:repeat(sym("component"),optional(sym("separator"))),component:alt(sym("number"),sym("string")),digit:range("0","9"),number:plus(sym("digit")),string:str(plus(not(alt(sym("digit"),sym("separator")),anyChar))),separator:alt(".","-")}.addActions({number:function(v){return parseInt(v.join(""))}});MODEL({name:"EventService",constants:{UNSUBSCRIBE_EXCEPTION:"unsubscribe",WILDCARD:"*"},methods:{oneTime:function(listener){return function(){throw listener.apply(this,argsToArray(arguments)),EventService.UNSUBSCRIBE_EXCEPTION}},consoleLog:function(listener){return function(){var args=argsToArray(arguments);console.log(args),listener.apply(this,args)}},merged:function(listener,opt_delay,opt_X){var setTimeoutX=opt_X&&opt_X.setTimeout||setTimeout,delay=opt_delay||16;return function(){var triggered=!1,unsubscribed=!1,lastArgs=null,f=function(){if(lastArgs=arguments,unsubscribed)throw EventService.UNSUBSCRIBE_EXCEPTION;if(!triggered){triggered=!0;try{setTimeoutX(function(){triggered=!1;var args=argsToArray(lastArgs);lastArgs=null;try{listener.apply(this,args)}catch(x){x===EventService.UNSUBSCRIBE_EXCEPTION&&(unsubscribed=!0)}},delay)}catch(e){throw EventService.UNSUBSCRIBE_EXCEPTION}}};return f.toString=function(){return"MERGED("+delay+", "+listener.$UID+", "+listener+")"},f}()},framed:function(listener,opt_X){opt_X=opt_X||this.X;var requestAnimationFrameX=opt_X&&opt_X.requestAnimationFrame||requestAnimationFrame;return function(){var triggered=!1,unsubscribed=!1,lastArgs=null,f=function(){if(lastArgs=arguments,unsubscribed)throw EventService.UNSUBSCRIBE_EXCEPTION;triggered||(triggered=!0,requestAnimationFrameX(function(){triggered=!1;var args=argsToArray(lastArgs);lastArgs=null;try{listener.apply(this,args)}catch(x){x===EventService.UNSUBSCRIBE_EXCEPTION&&(unsubscribed=!0)}}))};return f.toString=function(){return"ANIMATE("+listener.$UID+", "+listener+")"},f}()},async:function(listener,opt_X){return this.delay(0,listener,opt_X)},delay:function(delay,listener,opt_X){return opt_X=opt_X||this.X,function(){var args=argsToArray(arguments);(opt_X&&opt_X.setTimeout?opt_X.setTimeout:setTimeout)(function(){listener.apply(this,args)},delay)}},hasListeners:function(topic){return console.log("TODO: haslisteners"),!0},publish:function(topic){return this.subs_?this.pub_(this.subs_,0,topic,this.appendArguments([this,topic],arguments,1)):0},publishAsync:function(topic){var args=argsToArray(arguments),me=this;setTimeout(function(){me.publish.apply(me,args)},0)},deepPublish:function(topic){return this.publish.apply(this,arguments)},lazyPublish:function(topic,fn){return this.hasListeners(topic)?this.publish.apply(this,fn()):0},subscribe:function(topic,listener){this.subs_||(this.subs_={}),this.sub_(this.subs_,0,topic,listener)},unsubscribe:function(topic,listener){this.subs_&&this.unsub_(this.subs_,0,topic,listener)},unsubscribeAll:function(){this.sub_={}},pub_:function(map,topicIndex,topic,msg){var count=0;if(null==map)return 0;if(topicIndex<topic.length){var t=topic[topicIndex];if(t==this.WILDCARD)return this.notifyListeners_(topic,map,msg);t&&(count+=this.pub_(map[t],topicIndex+1,topic,msg))}return count+=this.notifyListeners_(topic,map[null],msg)},sub_:function(map,topicIndex,topic,listener){if(topicIndex==topic.length)map[null]||(map[null]=[]),map[null].push(listener);else{var key=topic[topicIndex];map[key]||(map[key]={}),this.sub_(map[key],topicIndex+1,topic,listener)}},unsub_:function(map,topicIndex,topic,listener){if(topicIndex==topic.length){if(!map[null])return!0;map[null].deleteI(listener)||console.warn("phantom unsubscribe, size: ",map[null].length),map[null].length||delete map[null]}else{var key=topic[topicIndex];if(!map[key])return!1;this.unsub_(map[key],topicIndex+1,topic,listener)&&delete map[key]}return 0==Object.keys(map).length},notifyListener_:function(topic,listener,msg){try{listener.apply(null,msg)}catch(err){return err!==this.UNSUBSCRIBE_EXCEPTION?console.error("Error delivering event (removing listener): ",topic.join("."),err):console.warn("Unsubscribing listener: ",topic.join(".")),!1}return!0},notifyListeners_:function(topic,listeners,msg){if(null==listeners)return 0;if(Array.isArray(listeners)){for(var i=0;i<listeners.length;i++){var listener=listeners[i];this.notifyListener_(topic,listener,msg)||(listeners.splice(i,1),i--)}return listeners.length}var count=0;for(var key in listeners)count+=this.notifyListeners_(topic,listeners[key],msg);return count},appendArguments:function(a,args,start){for(var i=start;i<args.length;i++)a.push(args[i]);return a}}}),MODEL({name:"PropertyChangeSupport",extendsModel:"EventService",constants:{PROPERTY_TOPIC:"property"},methods:{propertyTopic:function(property){return[this.PROPERTY_TOPIC,property]},propertyChange:function(property,oldValue,newValue){this.subs_&&(null==property||oldValue!==newValue&&(oldValue===oldValue||newValue===newValue))&&this.publish(this.propertyTopic(property),oldValue,newValue)},propertyChange_:function(propertyTopic,oldValue,newValue){this.subs_&&(oldValue===newValue||oldValue!==oldValue&&newValue!==newValue||this.publish(propertyTopic,oldValue,newValue))},globalChange:function(){this.publish(this.propertyTopic(this.WILDCARD),null,null)},addListener:function(listener){console.assert(listener,"Listener cannot be null."),this.addPropertyListener(null,listener)},removeListener:function(listener){this.removePropertyListener(null,listener)},addPropertyListener:function(property,listener){this.subscribe(this.propertyTopic(property),listener)},removePropertyListener:function(property,listener){this.unsubscribe(this.propertyTopic(property),listener)},propertyValue:function(prop){if(!prop)throw"Property Name required for propertyValue().";var name=prop+"Value___";return Object.hasOwnProperty.call(this,name)?this[name]:this[name]=PropertyValue.create(this,prop)}}});var FunctionStack={create:function(){var stack=[!1];return{stack:stack,push:function(f){stack.unshift(f)},pop:function(){stack.shift()}}}},PropertyValue={create:function(obj,prop){var o=Object.create(this);return o.$UID=obj.$UID+"."+prop,o.obj=obj,o.prop=prop,o},get:function(){return this.obj[this.prop]},set:function(val){this.obj[this.prop]=val},asDAO:function(){return console.warn("ProperytValue.asDAO() deprecated.  Use property$Proxy instead."),this.proxy||(this.proxy=ProxyDAO.create({delegate:this.get()}),this.addListener(function(){proxy.delegate=this.get()}.bind(this))),this.proxy},get value(){return this.get()},set value(val){this.set(val)},addListener:function(listener){this.obj.addPropertyListener(this.prop,listener)},removeListener:function(listener){this.obj.removePropertyListener(this.prop,listener)},toString:function(){return"PropertyValue("+this.prop+")"}},Events={listeners_:new WeakMap,recordListener:function(src,dst,listener,opt_dontCallListener){var srcMap=this.listeners_.get(src);srcMap||(srcMap=new WeakMap,this.listeners_.set(src,srcMap)),console.assert(!srcMap.get(dst),"recordListener: duplicate follow"),srcMap.set(dst,listener),src.addListener(listener),opt_dontCallListener||listener()},identity:function(x){return x},follow:function(srcValue,dstValue){srcValue&&dstValue&&this.recordListener(srcValue,dstValue,function(){var sv=srcValue.get(),dv=dstValue.get();sv!==dv&&dstValue.set(sv)})},unfollow:function(src,dst){if(src&&dst){var srcMap=this.listeners_.get(src);if(srcMap){var listener=srcMap.get(dst);listener&&(srcMap["delete"](dst),src.removeListener(listener))}}},map:function(srcValue,dstValue,f){srcValue&&dstValue&&this.recordListener(srcValue,dstValue,function(){var s=f(srcValue.get()),d=dstValue.get();s!==d&&dstValue.set(s)})},link:function(srcValue,dstValue){this.follow(srcValue,dstValue),this.follow(dstValue,srcValue)},relate:function(srcValue,dstValue,f,fprime,removeFeedback){if(srcValue&&dstValue){var feedback=!1,l=function(sv,dv,f){return function(){if(!removeFeedback||!feedback){var s=f(sv.get()),d=dv.get();s!==d&&(feedback=!0,dv.set(s),feedback=!1)}}},l1=l(srcValue,dstValue,f),l2=l(dstValue,srcValue,fprime);this.recordListener(srcValue,dstValue,l1,!0),this.recordListener(dstValue,srcValue,l2,!0),l1()}},unlink:function(value1,value2){this.unfollow(value1,value2),this.unfollow(value2,value1)},dynamic:function(fn,opt_fn,opt_X){var fn2=opt_fn?function(){opt_fn(fn())}:fn,listener=EventService.framed(fn2,opt_X),destroyHelper={listener:listener,propertyValues:[].clone(),destroy:function(){this.propertyValues.forEach(function(p){p.removeListener(this.listener)}.bind(this))}};Events.onGet.push(function(obj,name,value){obj.propertyValue(name).addListener(listener),destroyHelper.propertyValues.push(obj.propertyValue(name))});var ret=fn();return Events.onGet.pop(),opt_fn&&opt_fn(ret),destroyHelper},onSet:FunctionStack.create(),onGet:FunctionStack.create()};MODEL({name:"Movement",methods:{distance:function(x,y){return Math.sqrt(x*x+y*y)},o:function(f1,f2){return function(x){return f1(f2(x))}},avg:function(f1,f2){return function(x){return(f1(x)+f2(x))/2}},linear:function(x){return x},back:function(x){return.5>x?2*x:2-2*x},accelerate:function(x){return(Math.sin(x*Math.PI-Math.PI/2)+1)/2},easeIn:function(a){var v=1/(1-a/2);return function(x){var x1=Math.min(x,a),x2=Math.max(x-a,0);return(a?.5*x1*(x1/a)*v:0)+x2*v}},reverse:function(f){return function(x){return 1-f(1-x)}},easeOut:function(b){return Movement.reverse(Movement.easeIn(b))},oscillate:function(b,a,opt_c){var c=opt_c||3;return function(x){if(1-b>x)return x/(1-b);var t=(x-1+b)/b;return 1+2*(1-t)*a*Math.sin(2*c*Math.PI*t)}},bounce:function(b,a,opt_c){var c=opt_c||3;return function(x){if(1-b>x)return x/(1-b);var t=(x-1+b)/b;return 1-2*(1-t)*a*Math.abs(Math.sin(2*c*Math.PI*t))}},bounce2:function(a){var v=1/(1-a);return function(x){if(1-a>x)return v*x;var p=(x-1+a)/a;return 1-(x-1+a)*v/2}},stepBack:function(a){return function(x){return a>x?-x:-2*a+(1+2*a)*x}},ease:function(a,b){return Movement.o(Movement.easeIn(a),Movement.easeOut(b))},seq:function(f1,f2){return f1&&f2?function(){f1.apply(this,argsToArray(arguments)),f2()}:f1?f1:f2},liveAnimations_:0,animate:function(duration,fn,opt_interp,opt_onEnd,opt_X){var requestAnimationFrameX=opt_X&&opt_X.requestAnimationFrame||requestAnimationFrame;if(0==duration)return Movement.seq(fn,opt_onEnd);var interp=opt_interp||Movement.linear;return function(){function stop(){if(!stopped&&(Movement.liveAnimations_--,stopped=!0,opt_onEnd&&opt_onEnd(),opt_onEnd=null,0===Movement.liveAnimations_)){var tasks=Movement.idleTasks_;tasks&&tasks.length>0&&(Movement.idleTasks_=[],setTimeout(function(){var i;if(Movement.liveAnimations_>0)for(i=0;i<tasks.length;i++)Movement.idleTasks_.push(tasks[i]);else for(i=0;i<tasks.length;i++)tasks[i]()},20))}}function go(){if(!stopped){for(var now=Date.now(),p=interp((Math.min(now,startTime+duration)-startTime)/duration),last=now>=startTime+duration,i=0;i<ranges.length;i++){var r=ranges[i],obj=r[0],name=r[1],value1=r[2],value2=r[3];obj[name]=last?value2:value1+(value2-value1)*p}last?stop():requestAnimationFrameX(go)}}var ranges=[],stopped=!1;fn&&(Events.onSet.push(function(obj,name,value2){ranges.push([obj,name,obj[name],value2])}),fn.apply(this,argsToArray(arguments)),Events.onSet.pop());var startTime=Date.now();if(ranges.length>0)Movement.liveAnimations_++,requestAnimationFrameX(go);else{var setTimeoutX=opt_X&&opt_X.setTimeout||setTimeout;setTimeoutX(stop,duration)}return stop}},whenIdle:function(fn){return function(){if(Movement.liveAnimations_>0){Movement.idleTasks_||(Movement.idleTasks_=[]);var args=arguments;Movement.idleTasks_.push(function(){fn.apply(fn,args)})}else fn.apply(fn,arguments)}},compile:function(a,opt_rest){function noop(){}function isPause(op){return Array.isArray(op)&&0==op[0]}function compilePause(op,rest){return function(){document.onclick=function(){document.onclick=null,rest()}}}function isSimple(op){return Array.isArray(op)&&"number"==typeof op[0]}function compileSimple(op,rest){return op[3]=Movement.seq(op[3],rest),function(){Movement.animate.apply(null,op)()}}function isParallel(op){return Array.isArray(op)&&Array.isArray(op[0])}function compileParallel(op,rest){var join=function(num){return function(){--num||rest()}}(op.length);return function(){for(var i=0;i<op.length;i++)isSimple(op[i])?Movement.animate(op[i][0],op[i][1],op[i][2],Movement.seq(op[i][3],join))():Movement.compile(op[i],join)()}}function compileFn(fn,rest){return Movement.seq(fn,rest)}function compile_(a,i){if(i>=a.length)return opt_rest||noop;var rest=compile_(a,i+1),op=a[i];return isPause(op)?compilePause(op,rest):isSimple(op)?compileSimple(op,rest):isParallel(op)?compileParallel(op,rest):compileFn(op,rest)}return compile_(a,0)},onIntersect:function(o1,o2,fn){o1.model_.R?Events.dynamic(function(){o1.x,o1.y,o2.x,o2.y},function(){var dx=o1.x-o2.x,dy=o1.y-o2.y,d=dx*dx+dy*dy,r2=o1.r+o2.r;r2*r2>d&&fn.call(null,o1,o2)}):Events.dynamic(function(){o1.x,o1.y,o2.x,o2.y},function(){(o1.x<=o2.x&&o1.x+o1.width>o2.x&&o1.y<=o2.y&&o1.y+o1.height>o2.y||o2.x<=o1.x&&o2.x+o2.width>o1.x&&o2.y<=o1.y&&o2.y+o2.height>o1.y)&&fn.call(null,o1,o2)})},stepTowards:function(src,dst,maxStep){var dx=src.x-dst.x,dy=src.y-dst.y,theta=Math.atan2(dy,dx),r=Math.sqrt(dx*dx+dy*dy);r=0>r?Math.max(-maxStep,r):Math.min(maxStep,r),dst.x+=r*Math.cos(-theta),dst.y-=r*Math.sin(-theta)},moveTowards:function(t,body,sat,v){var bodyX=body.propertyValue("x"),bodyY=body.propertyValue("y"),satX=sat.propertyValue("x"),satY=sat.propertyValue("y");t.addListener(function(){var dx=bodyX.get()-satX.get(),dy=bodyY.get()-satY.get(),theta=Math.atan2(dy,dx),r=Math.sqrt(dx*dx+dy*dy);r=0>r?Math.max(-v,r):Math.min(v,r),satX.set(satX.get()+r*Math.cos(-theta)),satY.set(satY.get()-r*Math.sin(-theta))})},orbit:function(t,body,sat,r,p,opt_start){var bodyX=body.x$,bodyY=body.y$,satX=sat.x$,satY=sat.y$,start=opt_start||0;t.addListener(EventService.framed(function(){var time=t.time;satX.set(bodyX.get()+r*Math.sin(time/p*Math.PI*2+start)),satY.set(bodyY.get()+r*Math.cos(time/p*Math.PI*2+start))}))},strut:function(mouse,c,dx,dy){Events.dynamic(function(){mouse.x,mouse.y},function(){c.x=mouse.x+dx,c.y=mouse.y+dy})},friction:function(c,opt_coef){var coef=opt_coef||.9;Events.dynamic(function(){c.vx,c.vy},function(){c.vx*=coef,c.vy*=coef})},gravity:function(c,opt_a,opt_theta){var a=opt_a||1,theta=opt_theta||1.5*Math.PI;Events.dynamic(function(){c.vx,c.vy},function(){c.vy+=a})},inertia:function(c){Events.dynamic(function(){c.vx,c.vy,c.x,c.y},function(){c.x+=c.vx,c.y+=c.vy,c.x<.1&&(c.x=0),c.y<.1&&(c.y=0)})},spring:function(mouse,c,dx,dy,opt_strength){var strength=opt_strength||8;Events.dynamic(function(){mouse.x,mouse.y,c.x,c.y},function(){if(0===dx&&0===dy)c.x=mouse.x,c.y=mouse.y;else{var d=Movement.distance(dx,dy),dx2=mouse.x+dx-c.x,dy2=mouse.y+dy-c.y,d2=Movement.distance(dx2,dy2),dv=strength*d2/d,a=Math.atan2(dy2,dx2);c.vx+=dv*Math.cos(a),c.vy+=dv*Math.sin(a)}})},spring2:function(c1,c2,length,opt_strength){var strength=opt_strength||4;Events.dynamic(function(){c1.x,c1.y,c2.x,c2.y},function(){var d=c1.distanceTo(c2),a=Math.atan2(c2.y-c1.y,c2.x-c1.x);d>length?(c1.applyMomentum(strength*(d/length-1),a),c2.applyMomentum(-strength*(d/length-1),a)):length>d&&(c1.applyMomentum(-strength*(length/d-1),a),c2.applyMomentum(strength*(length/d-1),a))})},createAnimatedPropertyInstallFn:function(duration,interpolation){return function(prop){this.defineProperty({name:prop.name+"$AnimationLatch",defaultValue:0,hidden:!0,documentation:function(){}});var actualSetter=this.__lookupSetter__(prop.name);this.defineProperty({name:prop.name+"$AnimationSetValue",defaultValue:0,hidden:!0,documentation:function(){},postSet:function(_,nu){actualSetter.call(this,nu)}}),this.__defineSetter__(prop.name,function(nu){var latch=this[prop.name+"$AnimationLatch"];latch&&latch();var anim=Movement.animate(duration,function(){this[prop.name+"$AnimationSetValue"]=nu}.bind(this),interpolation);this[prop.name+"$AnimationLatch"]=anim()})}}}});var AbstractFormatter={keyify:function(str){return'"'+str+'"'},where:function(p){return{__proto__:this,p:p.f&&p.f.bind(p)||p}},p:function(){return!0}},JSONUtil={escape:function(str){return str.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/[\x00-\x1f]/g,function(c){return"\\u00"+(c.charCodeAt(0)<16?"0"+c.charCodeAt(0).toString(16):c.charCodeAt(0).toString(16))})},parseToMap:function(str){return eval("("+str+")")},parse:function(X,str,seq){return this.mapToObj(X,this.parseToMap(str),void 0,seq)},arrayToObjArray:function(X,a,opt_defaultModel,seq){for(var i=0;i<a.length;i++)a[i]=this.mapToObj(X,a[i],opt_defaultModel,seq);return a},mapToObj:function(X,obj,opt_defaultModel,seq){if(!obj||"object"==typeof obj.model_)return obj;if(Array.isArray(obj))return this.arrayToObjArray(X,obj,void 0,seq);if(obj instanceof Function)return obj;if(obj instanceof Date)return obj;if(obj instanceof Object){var j=0;for(var key in obj)"model_"!=key&&"prototype_"!=key&&(obj[key]=this.mapToObj(X,obj[key],null,seq)),j++;if(opt_defaultModel&&!obj.model_)return opt_defaultModel.create(obj);if(obj.model_){var newObj=X.lookup(obj.model_);if(!newObj||!newObj.finished__){var future=afuture();return seq&&seq.push(future.get),arequire(obj.model_)(function(model){if(!model)return"Template"!==obj.model_&&"ArrayProperty"!==obj.model_&&"ViewFactoryProperty"!==obj.model_&&"Documentation"!==obj.model_&&console.warn("Failed to dynamically load: ",obj.model_),void future.set(obj);var tmp=model.create(obj);obj.become(tmp),future.set(obj)}),obj}return newObj?newObj.create(obj,X):obj}return obj}return obj},compact:{__proto__:AbstractFormatter,stringify:function(obj){var buf="";return this.output(function(){for(var i=0;i<arguments.length;i++)buf+=arguments[i]},obj),buf},output:function(out,obj){Array.isArray(obj)?this.outputArray_(out,obj):"string"==typeof obj?(out('"'),out(JSONUtil.escape(obj)),out('"')):obj instanceof Function?this.outputFunction_(out,obj):obj instanceof Date?out(obj.getTime()):obj instanceof Object?obj.model_?this.outputObject_(out,obj):this.outputMap_(out,obj):"number"==typeof obj?(isFinite(obj)||(obj=null),out(obj)):(void 0===obj&&(obj=null),out(obj))},outputObject_:function(out,obj,opt_defaultModel){var str="",first=!0;out("{"),obj.model_.id!==opt_defaultModel&&(this.outputModel_(out,obj),first=!1);for(var key in obj.model_.properties_){var prop=obj.model_.properties_[key];if(this.p(prop)&&prop.name in obj.instance_){var val=obj[prop.name];if(Array.isArray(val)&&!val.length)continue;first||out(","),out(this.keyify(prop.name),": "),this.output(out,val),first=!1}}out("}")},outputModel_:function(out,obj){out('model_:"'),obj.model_["package"]&&out(obj.model_["package"],"."),out(obj.model_.name,'"')},outputMap_:function(out,obj){var str="",first=!0;out("{");for(var key in obj){var val=obj[key];first||out(","),out(this.keyify(key),": "),this.output(out,val),first=!1}out("}")},outputArray_:function(out,a,opt_defaultModel){if(0==a.length)return out("[]"),out;var str="",first=!0;out("[");for(var i=0;i<a.length;i++,first=!1){var obj=a[i];first||out(","),this.output(out,obj)}out("]")},outputFunction_:function(out,obj){out(obj)}},pretty:{__proto__:AbstractFormatter,stringify:function(obj){var buf="";return this.output(function(){for(var i=0;i<arguments.length;i++)buf+=arguments[i]},obj),buf},output:function(out,obj,opt_indent){var indent=opt_indent||"";Array.isArray(obj)?this.outputArray_(out,obj,null,indent):"string"==typeof obj?(out('"'),out(JSONUtil.escape(obj)),out('"')):obj instanceof Function?this.outputFunction_(out,obj,indent):obj instanceof Date?out("new Date('",obj,"')"):obj instanceof Object?obj.model_?this.outputObject_(out,obj,null,indent):this.outputMap_(out,obj,indent):"number"==typeof obj?(isFinite(obj)||(obj=null),out(obj)):(void 0===obj&&(obj=null),out(obj))},outputObject_:function(out,obj,opt_defaultModel,opt_indent){var indent=opt_indent||"",nestedIndent=indent+"   ",str="",first=!0;out(indent,"{\n"),obj.model_.id&&obj.model_.id!==opt_defaultModel&&(this.outputModel_(out,obj,nestedIndent),first=!1);for(var key in obj.model_.properties_){var prop=obj.model_.properties_[key];if(this.p(prop)&&"parent"!==prop.name&&prop.name in obj.instance_){var val=obj[prop.name];if(Array.isArray(val)&&!val.length)continue;first||out(",\n"),out(nestedIndent,this.keyify(prop.name),": "),Array.isArray(val)&&prop.subType?this.outputArray_(out,val,prop.subType,nestedIndent):this.output(out,val,nestedIndent),first=!1}}out("\n",indent,"}")},outputModel_:function(out,obj,indent){out(indent,'"model_": "',obj.model_.id,'"')},outputMap_:function(out,obj,opt_indent){var indent=opt_indent||"",nestedIndent=indent+"   ",str="",first=!0;out(indent,"{\n",nestedIndent);for(var key in obj){var val=obj[key];first||out(",\n"),out(nestedIndent,this.keyify(key),": "),this.output(out,val,nestedIndent),first=!1}out("\n",indent,"}")},outputArray_:function(out,a,opt_defaultModel,opt_indent){if(0==a.length)return out("[]"),out;var indent=opt_indent||"",nestedIndent=indent+"   ",str="",first=!0;out("[\n");for(var i=0;i<a.length;i++,first=!1){var obj=a[i];first||out(",\n"),"string"==typeof obj||"number"==typeof obj?(out(nestedIndent),this.output(out,obj,nestedIndent)):obj.model_?this.outputObject_(out,obj,nestedIndent):this.outputMap_(out,obj,nestedIndent)}out("\n",indent,"]")},outputFunction_:function(out,obj,indent){var str=obj.toString(),lines=str.split("\n");if(1==lines.length)return void out(str);for(var minIndent=1e4,i=0;i<lines.length;i++){for(var j=0;j<lines[i].length&&" "===lines[i].charAt(j)&&minIndent>j;j++);j>0&&minIndent>j&&(minIndent=j)}if(1e4===minIndent)return void out(str);for(var i=0;i<lines.length;i++)lines[i].length&&" "===lines[i].charAt(0)&&(lines[i]=indent+lines[i].substring(minIndent)),out(lines[i]),i<lines.length-1&&out("\n")}},moreCompact:{__proto__:AbstractFormatter},compressed:{__proto__:AbstractFormatter,stringify:function(obj){return Iuppiter.Base64.encode(Iuppiter.compress(JSONUtil.compact.stringify(obj),!0))}}};JSONUtil.prettyModel={__proto__:JSONUtil.pretty,outputModel_:function(out,obj,indent){out(indent,'model_: "',obj.model_.id,'"')},keys_:{},keyify:function(str){return this.keys_.hasOwnProperty(str)||(this.keys_[str]=/^[a-zA-Z\$_][0-9a-zA-Z$_]*$/.test(str)?str:'"'+str+'"'),this.keys_[str]}},JSONUtil.stringify=JSONUtil.pretty.stringify.bind(JSONUtil.pretty),JSONUtil.output=JSONUtil.pretty.output.bind(JSONUtil.pretty),JSONUtil.where=JSONUtil.pretty.where.bind(JSONUtil.pretty);var NOT_TRANSIENT=function(prop){return!prop["transient"]},XMLParser={__proto__:grammar,START:seq1(1,sym("whitespace"),sym("tag"),sym("whitespace")),tag:seq("<",sym("tagName"),sym("whitespace"),repeat(sym("attribute"),sym("whitespace")),sym("whitespace"),">",repeat(alt(sym("tag"),sym("text"))),"</",sym("tagName"),">"),label:str(plus(notChars(" =/	\r\n<>'\""))),tagName:sym("label"),text:str(plus(notChar("<"))),attribute:seq(sym("label"),"=",sym("value")),value:str(alt(seq1(1,'"',repeat(notChar('"')),'"'),seq1(1,"'",repeat(notChar("'")),"'"))),whitespace:repeat(alt(" ","	","\r","\n"))};XMLParser.addActions({tag:function(xs){if(xs[1]!=xs[8])return void 0;var obj={tag:xs[1],attrs:{},children:xs[6]};return xs[3].forEach(function(attr){obj.attrs[attr[0]]=attr[2]}),obj}});var XMLUtil={escape:function(str){return str&&str.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},unescape:function(str){return str&&str.toString().replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")},escapeAttr:function(str){return str&&str.replace(/"/g,"&quot;")},unescapeAttr:function(str){return str&&str.replace(/&quot;/g,'"')},parse:function(str){var result=XMLParser.parseString(str);return result?this.parseArray(result.children):result},parseObject:function(tag){var obj={},self=this;if(tag.children.forEach(function(c){if("object"==typeof c&&c.attrs&&c.attrs.name){var result;if(c.attrs.type&&"function"==c.attrs.type){var code=XMLUtil.unescape(c.children.join(""));result=code.startsWith("function")?eval("("+code+")"):new Function(code)}else result=self.parseArray(c.children);obj[self.unescapeAttr(c.attrs.name)]=result}}),!tag.attrs.model)return obj;var model=this.unescapeAttr(tag.attrs.model);return GLOBAL[model]?GLOBAL[model].create(obj):obj},parseArray:function(a){var self=this,ret=[];return a.forEach(function(x){"object"==typeof x&&ret.push("i"==x.tag?XMLUtil.unescape(x.children[0]):self.parseObject(x))}),ret.length?ret:XMLUtil.unescape(a.join(""))},compact:{stringify:function(obj){var buf=[];return this.output(buf.push.bind(buf),obj),"<foam>"+buf.join("")+"</foam>"},output:function(out,obj){Array.isArray(obj)?this.outputArray_(out,obj):"string"==typeof obj?out(XMLUtil.escape(obj)):obj instanceof Function?this.outputFunction_(out,obj):obj instanceof Object?obj.model_?this.outputObject_(out,obj):this.outputMap_(out,obj):out(obj)},outputObject_:function(out,obj){out('<object model="',XMLUtil.escapeAttr(obj.model_.name),'">');for(var key in obj.model_.properties_){var prop=obj.model_.properties_[key];if("parent"!==prop.name&&obj.instance_&&prop.name in obj.instance_){var val=obj[prop.name];if(Array.isArray(val)&&0==val.length)continue;if(val==prop.defaultValue)continue;out('<property name="',XMLUtil.escapeAttr(prop.name),'" '+("function"==typeof val?'type="function"':"")+">"),this.output(out,val),out("</property>")}}out("</object>")},outputMap_:function(out,obj){out("<object>");for(var key in obj){var val=obj[key];out('<property name="',XMLUtil.escapeAttr(key),'">'),this.output(out,val),out("</property>")}out("</object>")},outputArray_:function(out,a){if(0==a.length)return out;for(var i=0;i<a.length;i++,first=!1){var obj=a[i];"string"==typeof obj||"number"==typeof obj?out("<i>",XMLUtil.escape(obj),"</i>"):this.output(out,obj)}},outputFunction_:function(out,f){out(XMLUtil.escape(f.toString()))}},pretty:{stringify:function(obj){var buf=[];return this.output(buf.push.bind(buf),obj),"<foam>\n"+buf.join("")+"</foam>\n"},output:function(out,obj,opt_indent){var indent=opt_indent||"";if(Array.isArray(obj))this.outputArray_(out,obj,indent);else if("string"==typeof obj)out(XMLUtil.escape(obj));else if(obj instanceof Function)this.outputFunction_(out,obj,indent);else if(obj instanceof Object)try{obj.model_&&"string"!=typeof obj.model_?this.outputObject_(out,obj,indent):this.outputMap_(out,obj,indent)
}catch(x){console.log("toXMLError: ",x)}else out(obj)},outputObject_:function(out,obj,opt_indent){var indent=opt_indent||"",nestedIndent=indent+"  ";out(indent,'<object model="',XMLUtil.escapeAttr(obj.model_.name),'">');for(var key in obj.model_.properties_){var prop=obj.model_.properties_[key];if("parent"!==prop.name&&obj.instance_&&prop.name in obj.instance_){var val=obj[prop.name];if(Array.isArray(val)&&0==val.length)continue;if(val==prop.defaultValue)continue;var type="function"==typeof obj[prop.name]?' type="function"':"";out("\n",nestedIndent,'<property name="',XMLUtil.escapeAttr(prop.name),'"',type,">"),this.output(out,val,nestedIndent),out("</property>")}}out("\n",indent,"</object>"),out("\n")},outputMap_:function(out,obj,opt_indent){var indent=opt_indent||"",nestedIndent=indent+"  ";out(indent,"<object>");for(var key in obj){var val=obj[key];out("\n",nestedIndent,'<property name="',XMLUtil.escapeAttr(key),'">'),this.output(out,val,nestedIndent),out("</property>")}out("\n",indent,"</object>\n")},outputArray_:function(out,a,opt_indent){if(0==a.length)return out;for(var indent=opt_indent||"",nestedIndent=indent+"  ",i=0;i<a.length;i++,first=!1){var obj=a[i];out("\n"),"string"==typeof obj||"number"==typeof obj?out(nestedIndent,"<i>",XMLUtil.escape(obj),"</i>"):this.output(out,obj,nestedIndent)}out("\n",indent)},outputFunction_:function(out,f,opt_indent){out(XMLUtil.escape(f.toString())+"\n"+(opt_indent||""))}}};XMLUtil.stringify=XMLUtil.pretty.stringify.bind(XMLUtil.pretty),XMLUtil.output=XMLUtil.pretty.output.bind(XMLUtil.pretty);var X=sub({}),foam=X.foam={},registerFactory=function(model,factory){},registerModelForModel=function(modelType,targetModel,model){},registerFactoryForModel=function(factory,targetModel,model){},JSONParser=SkipGrammar.create({__proto__:grammar,START:copyInput(sym("objAsString")),objAsString:copyInput(sym("obj")),obj:seq1(1,"{",repeat(sym("pair"),","),"}"),pair:seq(sym("key"),":",sym("value")),key:alt(sym("symbol"),sym("string")),symbol:noskip(str(seq(sym("char"),str(repeat(sym("alpha")))))),"char":alt(range("a","z"),range("A","Z"),"_","$"),alpha:alt(range("a","z"),range("A","Z"),"_","$",range("0","9")),value:simpleAlt(sym("function literal"),sym("expr"),sym("number"),sym("string"),sym("obj"),sym("bool"),sym("array")),expr:str(seq(sym("symbol"),optional(str(alt(seq(".",sym("expr")),seq("(",str(repeat(sym("value"),",")),")")))))),number:noskip(seq(optional("-"),repeat(range("0","9"),null,1),optional(seq(".",repeat(range("0","9")))))),string:noskip(alt(sym("single quoted string"),sym("double quoted string"))),"double quoted string":seq1(1,'"',str(repeat(sym("double quoted char"))),'"'),"double quoted char":alt(sym("escape char"),literal('\\"','"'),notChar('"')),"single quoted string":seq1(1,"'",str(repeat(sym("single quoted char"))),"'"),"single quoted char":alt(sym("escape char"),literal("\\'","'"),notChar("'")),"escape char":alt(literal("\\\\","\\"),literal("\\n","\n")),bool:alt(literal("true",!0),literal("false",!1)),array:seq1(1,"[",repeat(sym("value"),","),"]"),"function literal":seq("function",optional(sym("symbol")),"(",repeat(sym("symbol"),","),")","{",repeat(notChar("}")),"}")}.addActions({obj:function(v){for(var m={},i=0;i<v.length;i++)m[v[i][0]]=v[i][2];return m}}),repeat0(alt(" ","	","\n","\r")));MODEL({name:"TemplateParser",extendsModel:"grammar",methods:{START:sym("markup"),markup:repeat0(alt(sym("comment"),sym("foamTag"),sym("create child"),sym("simple value"),sym("live value tag"),sym("raw values tag"),sym("values tag"),sym("code tag"),sym("ignored newline"),sym("newline"),sym("single quote"),sym("text"))),comment:seq1(1,"<!--",repeat0(not("-->",anyChar)),"-->"),foamTag:sym("foamTag_"),foamTag_:function(){},"create child":seq("$$",repeat(notChars(" $\n<{")),optional(JSONParser["export"]("objAsString"))),"simple value":seq("%%",repeat(notChars(' -"\n<'))),"live value tag":seq("<%#",repeat(not("%>",anyChar)),"%>"),"raw values tag":alt(seq("<%=",repeat(not("%>",anyChar)),"%>"),seq("{{{",repeat(not("}}}",anyChar)),"}}}")),"values tag":seq("{{",repeat(not("}}",anyChar)),"}}"),"code tag":seq("<%",repeat(not("%>",anyChar)),"%>"),"ignored newline":literal("\\\n"),newline:literal("\n"),"single quote":literal("'"),text:anyChar}});var TemplateOutput={create:function(obj){var buf="",f=function(){for(var i=0;i<arguments.length;i++){var o=arguments[i];"string"==typeof o?buf+=o:(o&&o.toView_&&(o=o.toView_()),null!==o&&void 0!==o&&(o.appendHTML?o.appendHTML(this):buf+=o.toHTML?o.toHTML():o,o.initHTML&&obj.addChild&&obj.addChild(o)))}};return f.toString=function(){return buf},f}},ConstantTemplate=function(str){var f=function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out(str),out.toString()};return f.toString=function(){return'function(opt_out) { var out = opt_out ? opt_out : TemplateOutput.create(this);\n  out("'+str.replace(/\n/g,"\\n").replace(/"/g,'\\"')+'");\n  return out.toString(); }'},f},TemplateCompiler={__proto__:TemplateParser,out:[],simple:!0,push:function(){this.simple=!1,this.pushSimple.apply(this,arguments)},pushSimple:function(){this.out.push.apply(this.out,arguments)},header:"var self = this; var X = this.X; var Y = this.Y; var escapeHTML = XMLUtil.escape;var out = opt_out ? opt_out : TemplateOutput.create(this);out('",footer:"');return out.toString();"}.addActions({markup:function(v){var wasSimple=this.simple,ret=wasSimple?null:this.header+this.out.join("")+this.footer;return this.out=[],this.simple=!0,[wasSimple,ret]},"create child":function(v){var name=v[1].join("");this.push("', self.createTemplateView('",name,"'",v[2]?", "+v[2]:"","),\n'")},foamTag:function(e){var fName=e.getAttribute("f");fName?(this.push("', self.createTemplateView('",fName,"',{}).fromElement(FOAM("),this.push(JSONUtil.where(NOT_TRANSIENT).stringify(e)),this.push("))")):(this.push("', X.foam.ui.FoamTagView.create({element: FOAM("),this.push(JSONUtil.where(NOT_TRANSIENT).stringify(e)),this.push(")}, Y.sub({data: this.data}))")),this.push(",\n'")},"simple value":function(v){this.push("',\n self.",v[1].join(""),",\n'")},"raw values tag":function(v){this.push("',\n",v[1].join(""),",\n'")},"values tag":function(v){this.push("',\nescapeHTML(",v[1].join(""),"),\n'")},"live value tag":function(v){this.push("',\nself.dynamicTag('span', function() { return ",v[1].join(""),"; }.bind(this)),\n'")},"code tag":function(v){this.push("');\n",v[1].join(""),";out('")},"single quote":function(){this.pushSimple("\\'")},newline:function(){this.pushSimple("\\n")},text:function(v){this.pushSimple(v)}});MODEL({name:"TemplateUtil",methods:{lazyCompile:function(t){var delegate,f=function(){if(!delegate)if(t.code)delegate=t.code;else{if(!t.template)throw"Must arequire() template model before use for "+this.name_+"."+t.name;delegate=TemplateUtil.compile(Template.isInstance(t)?t:Template.create(t))}return delegate.apply(this,arguments)};return f.toString=function(){return delegate?delegate.toString():t},f},compile_:function(t,code){for(var args=["opt_out"],i=0;i<t.args.length;i++)args.push(t.args[i].name);return eval("(function("+args.join(",")+"){"+code+"})")},compile:function(t){if(t.code)return t.code;var code=TemplateCompiler.parseString(t.template);if(code[0])return ConstantTemplate(t.template);try{return this.compile_(t,code[1])}catch(err){return console.log("Template Error: ",err),console.log(code),function(){}}},stringifyTemplate:function(template){return function(){var buf=[];return this.output(buf.push.bind(buf),obj),buf.join("")}},expandTemplate:function(self,t,opt_X){var X=opt_X||self.X;if("function"==typeof t)t=X.Template.create({name:t.name,args:t.toString().match(/\((.*?)\)/)[1].split(",").slice(1).map(function(a){return X.Arg.create({name:a.trim()})}),template:multiline(t)});else if("string"==typeof t)t=docTemplate=X.Template.create({name:"body",template:t});else if(t.template||t.code)"function"==typeof t.template&&(t.template=multiline(t.template));else{var future=afuture(),path=self.sourcePath;t.futureTemplate=future.get,path=path.substring(0,path.lastIndexOf("/")+1),path+=self.name+"_"+t.name+".ft";var xhr=new XMLHttpRequest;xhr.open("GET",path),xhr.asend(function(data){t.template=data,future.set(Template.create(t))})}return t.futureTemplate||(t.futureTemplate=aconstant(t)),t.template$||(t="undefined"!=typeof X.Template?JSONUtil.mapToObj(X,t,X.Template):t),t},expandModelTemplates:function(self){for(var templates=self.templates,i=0;i<templates.length;i++)templates[i]=TemplateUtil.expandTemplate(self,templates[i])}}});var aeval=function(src){return aconstant(eval("("+src+")"))},aevalTemplate=function(t,model){return aseq(t.futureTemplate,function(ret,t){ret(TemplateUtil.lazyCompile(t))})},$documents=[];window&&$documents.push(window.document);var $WID__=0,$=function(id){console.log("Deprecated use of GLOBAL.$.");for(var i=0;i<$documents.length;i++){if(document.FOAM_OBJECTS&&document.FOAM_OBJECTS[id])return document.FOAM_OBJECTS[id];var ret=$documents[i].getElementById(id);if(ret)return ret}return void 0},$$=function(cls){console.log("Deprecated use of GLOBAL.$$.");for(var i=0;i<$documents.length;i++){var ret=$documents[i].getElementsByClassName(cls);if(ret.length>0)return ret}return[]},FOAM=function(map,opt_X,seq){var obj=JSONUtil.mapToObj(opt_X||X,map,void 0,seq);return obj};FOAM.putFactory=function(ctx,name,factory){ctx.__defineGetter__(name,function(){return console.log("Bouncing Factory: ",name),delete ctx[name],ctx[name]=factory()})};var USED_MODELS={},UNUSED_MODELS={},NONMODEL_INSTANCES={};FOAM.browse=function(model,opt_dao,opt_X){var Y=opt_X||X.sub(void 0,"FOAM BROWSER");"string"==typeof model&&(model=Y[model]);var dao=opt_dao||Y[model.name+"DAO"]||Y[model.plural];dao||(Y[model.name+"DAO"]=[].dao);var ctrl=Y.DAOController.create({model:model,dao:dao,useSearchView:!1});if(Y.stack)Y.stack.pushView(ctrl);else{var w=opt_X?opt_X.window:window;Y.stack=Y.StackView.create();var win=Y.foam.ui.layout.Window.create({window:w,data:Y.stack},Y);document.body.insertAdjacentHTML("beforeend",win.toHTML()),win.initHTML(),Y.stack.setTopView(ctrl)}};var FOAM_POWERED='<a style="text-decoration:none;" href="https://github.com/foam-framework/foam/" target="_blank"><font size=+1 face="catull" style="text-shadow:rgba(64,64,64,0.3) 3px 3px 4px;"><font color="#3333FF">F</font><font color="#FF0000">O</font><font color="#FFCC00">A</font><font color="#33CC00">M</font><font color="#555555" > POWERED</font></font></a>',MODEL=CLASS,FObject={__proto__:PropertyChangeSupport,name_:"FObject",replaceModel_:function(model,otherModel,X){for(;otherModel;){var replacementName=(model["package"]?model["package"]+".":"")+(otherModel.name?otherModel.name:otherModel)+model.name,replacementModel=X.lookup(replacementName);if(replacementModel)return replacementModel;otherModel=X.lookup(otherModel.extendsModel)}return void 0},create_:function(){return Object.create(this)},create:function(args,opt_X){if(args&&args.model&&(opt_X||X).Model.isInstance(args.model)){var ret=this.replaceModel_(this.model_,args.model,opt_X||X);if(ret)return ret.create(args,opt_X)}var o=this.create_(this);if(o.instance_={},o.X=opt_X||X,o.Y=o.X.sub({},(o.X.NAME?o.X.NAME:"")+"Y"),this.model_.imports_&&this.model_.imports_.length){Object.prototype.hasOwnProperty.call(this,"imports__")||(this.imports__=this.model_.imports_.map(function(e){var s=e.split(" as ");return[s[0],s[1]||s[0]]}));for(var i=0;i<this.imports__.length;i++){var im=this.imports__[i];args&&args.hasOwnProperty(im[1])||"undefined"==typeof o.X[im[0]]||(o[im[1]]=o.X[im[0]])}}if(o.model_)for(var agents=this.initAgents(),i=0;i<agents.length;i++)agents[i][1](o,o.X,o.Y,args);return o.init(args),o},init:nop,xbind:function(map){return{__proto__:this,create:function(args,X){args=args||{};for(var key in map)args.hasOwnProperty(key)||(args[key]=map[key]);return this.__proto__.create(args,X)},xbind:function(m2){for(var key in map)m2.hasOwnProperty(key)||(m2[key]=map[key]);return this.__proto__.xbind(m2)}}},X:X,addInitAgent:function(priority,desc,agent){agent.toString=function(){return desc},this.initAgents_.push([priority,agent])},initAgents:function(){if(this.model_){if(!Object.hasOwnProperty.call(this,"initAgents_")){var agents=this.initAgents_=[],self=this;Object_forEach(this.model_.exports_,function(e){var exp=e.split("as ");if(0!=exp.length){var key=exp[0].trim(),alias=exp[1]||exp[0];if(key){var asValue="$"!==key&&"$$"!=key&&"$"==key.charAt(key.length-1);asValue&&(key=key.slice(0,key.length-1));var prop=self.model_.getProperty(key);prop?asValue?self.addInitAgent(1,"export property value "+key,function(o,X,Y){Y.set(alias,o[prop.name$_])}):self.addInitAgent(1,"export property "+key,function(o,X,Y){Y.setValue(alias,o[prop.name$_])}):self.addInitAgent(0,"export other "+key,function(o,X,Y){var out="function"==typeof o[key]?o[key].bind(o):o[key];Y.set(alias,out)})}else self.addInitAgent(0,"export this",function(o,X,Y){Y.set(alias,o)})}}),this.model_.properties_.forEach(function(prop){prop.initPropertyAgents?prop.initPropertyAgents(self):self.addInitAgent(0,"set proto-property "+prop.name,function(o,X,Y,m){m&&m.hasOwnProperty(prop.name)&&(o[prop.name]=m[prop.name])})}),self.addInitAgent(0,"Add create() to Model",function(o,X,Y){Model.isInstance(o)&&"Model"!=o.name&&(o.create=BootstrapModel.create)});for(key in agents)agents[key][2]=key;agents.sort(CompoundComparator(function(o1,o2){return o1[0]-o2[0]},function(o1,o2){return o1[2]-o2[2]}))}return this.initAgents_}},fromElement:function(e){var elements=this.elementMap_;if(!elements){elements={};for(var i=0;i<this.model_.properties_.length;i++){var p=this.model_.properties_[i];elements[p.name]=p,elements[p.name.toUpperCase()]=p,p.singular&&(elements[p.singular]=p,elements[p.singular.toUpperCase()]=p)}this.elementMap_=elements}for(var i=0;i<e.attributes.length;i++){var attr=e.attributes[i],p=elements[attr.name],val=attr.value;if(p)if(val.startsWith("#")){val=val.substring(1);var $val=this.X.$(val);$val?this[attr.name]=this.X.$(val):p.fromString.call(this,val,p)}else p.fromString.call(this,val,p);else({id:!0,model:!0,view:!0,showactions:!0,oninit:!0})[attr.name]||console.warn('Unknown attribute name: "'+attr.name+'"')}for(var i=0;i<e.children.length;i++){var c=e.children[i],p=elements[c.nodeName];p?p.fromElement.call(this,c,p):console.warn('Unknown element name: "'+c.nodeName+'"')}return this},installInDocument:function(X,document){for(var i=0;i<this.model_.templates.length;i++){var t=this.model_.templates[i];if("CSS"===t.name)return void t.futureTemplate(function(){X.addStyle(this.CSS())}.bind(this))}},defineFOAMGetter:function(name,getter){var stack=Events.onGet.stack;this.__defineGetter__(name,function(){var value=getter.call(this,name),f=stack[0];return f&&f(this,name,value),value})},defineFOAMSetter:function(name,setter){var stack=Events.onSet.stack;this.__defineSetter__(name,function(newValue){var f=stack[0];(!f||f(this,name,newValue))&&setter.call(this,newValue,name)})},toString:function(){return this.model_.name+"Prototype"},hasOwnProperty:function(name){return"undefined"!=typeof this.instance_[name]},writeActions:function(other,out){for(var i=0,property;property=this.model_.properties_[i];i++)if(property.actionFactory)for(var actions=property.actionFactory(this,property.f(this),property.f(other)),j=0;j<actions.length;j++)out(actions[j])},equals:function(other){return 0==this.compareTo(other)},compareTo:function(other){if(other===this)return 0;if(this.model_!==other.model_)return this.model_.name.compareTo(other.model_.name)||1;for(var ps=this.model_.properties_,i=0;i<ps.length;i++){var r=ps[i].compare(this,other);if(r)return r}return 0},diff:function(other){for(var diff={},i=0,property;property=this.model_.properties_[i];i++)if(Array.isArray(property.f(this))){var subdiff=property.f(this).diff(property.f(other));(0!==subdiff.added.length||0!==subdiff.removed.length)&&(diff[property.name]=subdiff)}else 0!==property.f(this).compareTo(property.f(other))&&(diff[property.name]=property.f(other));return diff},clearProperty:function(name){delete this.instance_[name]},defineProperty:function(prop){var name=prop.name;if(prop.name$_=name+"$",this.__lookupGetter__(prop.name$_)||Object.defineProperty(this,prop.name$_,{get:function(){return this.propertyValue(name)},set:function(value){Events.link(value,this.propertyValue(name))},configurable:!0}),prop.getter)this.defineFOAMGetter(name,prop.getter);else{if(prop.lazyFactory)var getter=function(){return"undefined"!=typeof this.instance_[name]?this.instance_[name]:(this.instance_[name]=prop.lazyFactory.call(this,prop),this.instance_[name])};else getter=prop.factory?function(){if("undefined"==typeof this.instance_[name]){this.instance_[name]=null;var val=prop.factory.call(this,prop);this[name]=val}return this.instance_[name]}:prop.defaultValueFn?function(){return"undefined"!=typeof this.instance_[name]?this.instance_[name]:prop.defaultValueFn.call(this,prop)}:function(){return"undefined"!=typeof this.instance_[name]?this.instance_[name]:prop.defaultValue};this.defineFOAMGetter(name,getter)}if(prop.setter)this.defineFOAMSetter(name,prop.setter);else{var setter=function(oldValue,newValue){this.instance_[name]=newValue};("int"===prop.type||"float"===prop.type)&&(setter=function(setter){return function(oldValue,newValue){setter.call(this,oldValue,"number"!=typeof newValue?Number(newValue):newValue)}}(setter)),prop.onDAOUpdate&&(setter="string"==typeof prop.onDAOUpdate?function(setter,onDAOUpdate,listenerName){return function(oldValue,newValue){setter.call(this,oldValue,newValue);var listener=this[listenerName]||(this[listenerName]=this[onDAOUpdate].bind(this));oldValue&&oldValue.unlisten(listener),newValue&&(newValue.listen(listener),listener())}}(setter,prop.onDAOUpdate,prop.name+"_onDAOUpdate"):function(setter,onDAOUpdate,listenerName){return function(oldValue,newValue){setter.call(this,oldValue,newValue);var listener=this[listenerName]||(this[listenerName]=onDAOUpdate.bind(this));oldValue&&oldValue.unlisten(listener),newValue&&(newValue.listen(listener),listener())}}(setter,prop.onDAOUpdate,prop.name+"_onDAOUpdate")),prop.postSet&&(setter=function(setter,postSet){return function(oldValue,newValue){setter.call(this,oldValue,newValue),postSet.call(this,oldValue,newValue,prop)}}(setter,prop.postSet));var propertyTopic=PropertyChangeSupport.propertyTopic(name);setter=function(setter){return function(oldValue,newValue){setter.call(this,oldValue,newValue),this.propertyChange_(propertyTopic,oldValue,newValue)}}(setter),prop.preSet&&(setter=function(setter,preSet){return function(oldValue,newValue){setter.call(this,oldValue,preSet.call(this,oldValue,newValue,prop))}}(setter,prop.preSet)),prop.adapt&&(setter=function(setter,adapt){return function(oldValue,newValue){setter.call(this,oldValue,adapt.call(this,oldValue,newValue,prop))}}(setter,prop.adapt)),setter=function(setter){return function(newValue){setter.call(this,"undefined"==typeof this.instance_[name]?prop.defaultValue:this.instance_[name],newValue)}}(setter),this.defineFOAMSetter(name,setter)}prop.install&&prop.install.call(this,prop)},addMethod:function(name,method){this.__proto__[name]?override(this,name,method):this[name]=method},hashCode:function(){for(var hash=17,i=0;i<this.model_.properties_.length;i++){var prop=this[this.model_.properties_[i].name],code=prop?prop.hashCode?prop.hashCode():prop.toString().hashCode():0;hash=(hash<<5)-hash+code,hash&=hash}return hash},toProtobuf:function(){var out=ProtoWriter.create();return this.outProtobuf(out),out.value},outProtobuf:function(out){for(var i=0;i<this.model_.properties_.length;i++){var prop=this.model_.properties_[i];Number.isFinite(prop.prototag)&&prop.outProtobuf(this,out)}},clone:function(){var c=Object.create(this.__proto__);c.instance_={},c.X=this.X,c.Y=this.Y;for(var key in this.instance_){var value=this[key];c.instance_[key]=Array.isArray(value)?value.clone():value}return c},deepClone:function(){var cln=this.clone();for(var key in cln.instance_){var val=cln.instance_[key];if(Array.isArray(val))for(var i=0;i<val.length;i++){var obj=val[i];val[i]=obj.deepClone()}}return cln},copyFrom:function(src){if(src&&this.model_)for(var ps=this.model_.properties_,i=0;i<ps.length;i++){var prop=ps[i];src.hasOwnProperty(prop.name)&&(this[prop.name]=src[prop.name]),src.hasOwnProperty(prop.name$_)&&(this[prop.name$_]=src[prop.name$_])}return this},output:function(out){return JSONUtil.output(out,this)},toJSON:function(){return JSONUtil.stringify(this)},toXML:function(){return XMLUtil.stringify(this)},write:function(document,opt_view){var view=(opt_view||X.foam.ui.DetailView).create({model:this.model_,data:this,showActions:!0});document.writeln(view.toHTML()),view.initHTML()},defaultView:function(opt_view){return(opt_view||X.foam.ui.DetailView).create({model:this.model_,data:this,showActions:!0})},decorate:function(name,func,that){var delegate=this[name];return this[name]=function(){return func.call(this,that,delegate.bind(this),arguments)},this},addDecorator:function(decorator){decorator.decorateObject&&decorator.decorateObject(this);for(var i=0;i<decorator.model_.methods.length;i++){var method=decorator.model_.methods[i];"decorateObject"!==method.name&&this.decorate(method.name,method.code,decorator)}return this},getMyFeature:function(featureName){return featureName=featureName.toUpperCase(),[this.properties_?this.properties_:[],this.actions_?this.actions_:[],this.methods?this.methods:[],this.listeners?this.listeners:[],this.templates?this.templates:[],this.models?this.models:[],this.tests?this.tests:[],this.relationships?this.relationships:[],this.issues?this.issues:[]].mapFind(function(list){return list.mapFind(function(f){return f.name&&f.name.toUpperCase()===featureName&&f})})},getAllMyFeatures:function(){var featureList=[];return[this.properties_?this.properties_:[],this.actions_?this.actions_:[],this.methods?this.methods:[],this.listeners?this.listeners:[],this.templates?this.templates:[],this.models?this.models:[],this.tests?this.tests:[],this.relationships?this.relationships:[],this.issues?this.issues:[]].map(function(list){featureList=featureList.concat(list)}),featureList},getFeature:function(featureName){var feature=this.getMyFeature(featureName);if(feature||!this.extendsModel)return feature;var ext=this.X.lookup(this.extendsModel);return ext?ext.getFeature(featureName):void 0},getAllFeatures:function(){var featureList=this.getAllMyFeatures();if(this.extendsModel){var ext=this.X.lookup(this.extendsModel);ext&&ext.getAllFeatures().map(function(subFeat){var subName=subFeat.name.toUpperCase();featureList.mapFind(function(myFeat){return myFeat&&myFeat.name&&myFeat.name.toUpperCase()===subName})||featureList.push(subFeat)})}return featureList}};this.Constant=null,this.Method=null,this.Action=null,this.Relationship=null;var BootstrapModel={__proto__:PropertyChangeSupport,name_:"BootstrapModel <startup only, error if you see this>",buildPrototype:function(){function addTraitToModel(traitModel,parentModel){var parentName=parentModel&&parentModel.id?parentModel.id.replace(/\./g,"__"):"",traitName=traitModel.id?traitModel.id.replace(/\./g,"__"):"",name=parentName+"_ExtendedWith_"+traitName;if(!lookup(name)){var model=traitModel.deepClone();model["package"]="",model.name=name,model.extendsModel=parentModel&&parentModel.id,model.models=traitModel.models,GLOBAL.X.registerModel(model)}var ret=GLOBAL.X.lookup(name);return console.assert(ret,"Error adding Trait to Model, unknown name: ",name),ret}function findProp(name){for(var i=0;i<props.length;i++)if(props[i].name==name)return i;return-1}if(DEBUG&&BootstrapModel.saveDefinition(this),this.extendsModel&&!this.X.lookup(this.extendsModel))throw"Unknown Model in extendsModel: "+this.extendsModel;var extendsModel=this.extendsModel&&this.X.lookup(this.extendsModel);if(this.traits)for(var i=0;i<this.traits.length;i++){var trait=this.traits[i],traitModel=this.X.lookup(trait);console.assert(traitModel,"Unknown trait: "+trait),traitModel?extendsModel=addTraitToModel(traitModel,extendsModel):console.warn("Missing trait: ",trait,", in Model: ",this.name)}var proto=extendsModel?extendsModel.getPrototype():FObject,cls=Object.create(proto);cls.model_=this,cls.name_=this.name,this.models&&Object_forEach(this.models,function(m){this[m.name]&&(cls[m.name]=this[m.name])}.bind(this)),Object_forEach(this.requires,function(i){var imp=i.split(" as "),m=imp[0],path=m.split("."),key=imp[1]||path[path.length-1];defineLocalProperty(cls,key,function(){var Y=this.Y,model=this.X.lookup(m);console.assert(model,"Unknown Model: "+m+" in "+this.name_);var proto=model.getPrototype();return{__proto__:model,create:function(args,X){return proto.create(args,X||Y)}}})});var props=this.properties_=this.properties?this.properties.clone():[];this.imports_=this.imports,extendsModel&&(this.imports_=this.imports_.concat(extendsModel.imports_)),Object_forEach(this.imports_,function(i){var imp=i.split(" as "),key=imp[0],alias=imp[1]||imp[0];alias.length&&"$"==alias.charAt(alias.length-1)&&(alias=alias.slice(0,alias.length-1));var i=findProp(alias);-1==i&&props.push(Property.create({name:alias,"transient":!0,hidden:!0}))});for(var i=0;i<props.length;i++){var p=props[i];if(extendsModel){var superProp=extendsModel.getProperty(p.name);if(superProp){var p0=p,p=superProp.clone().copyFrom(p);p0.adapt&&superProp.adapt&&(p.adapt=function(a1,a2){return function(oldValue,newValue,prop){return a2.call(this,oldValue,a1.call(this,oldValue,newValue,prop),prop)}}(p0.adapt,superProp.adapt)),p0.preSet&&superProp.preSet&&(p.preSet=function(a1,a2){return function(oldValue,newValue,prop){return a2.call(this,oldValue,a1.call(this,oldValue,newValue,prop),prop)}}(p0.preSet,superProp.preSet)),p0.postSet&&superProp.postSet&&(p.postSet=function(a1,a2){return function(oldValue,newValue,prop){a2.call(this,oldValue,newValue,prop),a1.call(this,oldValue,newValue,prop)}}(p0.postSet,superProp.postSet)),props[i]=p,this[constantize(p.name)]=p}}cls.defineProperty(p)}if(this.propertyMap_=null,extendsModel){for(var i=0;i<extendsModel.properties_.length;i++){var p=extendsModel.properties_[i],name=constantize(p.name);this[name]||(this[name]=p)}for(i=0;i<extendsModel.relationships.length;i++){var r=extendsModel.relationships[i],name=constantize(r.name);this[name]||(this[name]=r)}}if(this.exports_=this.exports?this.exports.clone():[],extendsModel&&(this.exports_=this.exports_.concat(extendsModel.exports_)),this.templates&&Object_forEach(this.templates,function(t){cls.addMethod(t.name,TemplateUtil.lazyCompile(t))}),this.actions_=this.actions?this.actions.clone():[],this.actions)for(var i=0;i<this.actions.length;i++)(function(a){if(extendsModel){var superAction=extendsModel.getAction(a.name);superAction&&(a=superAction.clone().copyFrom(a))}this.actions_[i]=a,Object.prototype.hasOwnProperty.call(cls,constantize(a.name))||(cls[constantize(a.name)]=a),cls.addMethod(a.name,function(opt_x){a.callIfEnabled(opt_x||this.X,this)})}).bind(this)(this.actions[i]);var key;for(key in this.constants){var c=this.constants[key];Constant?(Constant.isInstance(c)||(c=this.constants[key]=Constant.create(c)),Object.defineProperty(cls,c.name,{value:c.value}),Object.defineProperty(this,c.name,{value:c.value})):console.warn("Defining constant before Constant.")}for(key in this.messages){var c=this.messages[key];Message?(Message.isInstance(c)||(c=this.messages[key]=Message.create(c)),Object.defineProperty(cls,c.name,{get:function(){return c.value}}),Object.defineProperty(this,c.name,{get:function(){return c.value}})):console.warn("Defining message before Message.")}for(key in this.methods){var m=this.methods[key];Method&&Method.isInstance(m)?cls.addMethod(m.name,m.generateFunction()):cls.addMethod(key,m)}var self=this;this.relationships&&this.relationships.forEach(function(r){var name=constantize(r.name);self[name]||(self[name]=r),defineLazyProperty(cls,r.name,function(){var m=this.X.lookup(r.relatedModel),lcName=m.name[0].toLowerCase()+m.name.substring(1),dao=this.X[lcName+"DAO"]||this.X[m.name+"DAO"]||this.X[m.plural];return dao||console.error("Relationship "+r.name+" needs "+(m.name+"DAO")+" or "+m.plural+" in the context, and neither was found."),{get:function(){return dao.where(EQ(m.getProperty(r.relatedProperty),this.id))},configurable:!0}})});var createListenerTrampoline=function(cls,name,fn,isMerged,isFramed,whenIdle){console.assert(fn,"createListenerTrampoline: fn not defined"),fn.name=name,Object.defineProperty(cls,name,{get:function(){var l=fn.bind(this);return whenIdle&&(l=Movement.whenIdle(l)),isFramed?l=EventService.framed(l,this.X):isMerged&&(l=EventService.merged(l,isMerged===!0?void 0:isMerged,this.X)),Object.defineProperty(this,name,{value:l}),l},configurable:!0})};if(Array.isArray(this.listeners))for(var i=0;i<this.listeners.length;i++){var l=this.listeners[i];createListenerTrampoline(cls,l.name,l.code,l.isMerged,l.isFramed,l.whenIdle)}else this.listeners&&Object_forEach(this.listeners,function(l,key){createListenerTrampoline(cls,key,l)});if(this.topics&&Object_forEach(this.topics,function(t){}),extendsModel){for(var i=extendsModel.properties_.length-1;i>=0;i--){var p=extendsModel.properties_[i];this.getProperty&&this.getPropertyWithoutCache_(p.name)||this.properties_.unshift(p)}this.propertyMap_=null;for(var i=extendsModel.actions_.length-1;i>=0;i--){var a=extendsModel.actions_[i];this.getAction&&this.getAction(a.name)||this.actions_.unshift(a)}}if(this.properties_.length>0&&!cls.__lookupGetter__("id")){var primaryKey=this.ids;1==primaryKey.length?(cls.__defineGetter__("id",function(){return this[primaryKey[0]]}),cls.__defineSetter__("id",function(val){this[primaryKey[0]]=val})):primaryKey.length>1&&(cls.__defineGetter__("id",function(){return primaryKey.map(function(key){return this[key]}.bind(this))}),cls.__defineSetter__("id",function(val){primaryKey.map(function(key,i){this[key]=val[i]}.bind(this))}))}return cls},getAllRequires:function(){function setModel(o){o&&o.model_&&(requires[o.model_.id]=!0)}var requires={};return this.requires.forEach(function(r){requires[r.split(" ")[0]]=!0}),this.traits.forEach(function(t){requires[t]=!0}),this.extendsModel&&(requires[this.extendsModel]=!0),this.properties.forEach(setModel),this.actions.forEach(setModel),this.templates.forEach(setModel),this.listeners.forEach(setModel),Object.keys(requires)},getPrototype:function(){return this.instance_.prototype_||(this.instance_.prototype_=this.buildPrototype())},saveDefinition:function(self){self.definition_={},Array.isArray(self.methods)&&(self.definition_.methods=[].concat(self.methods)),Array.isArray(self.templates)&&(self.definition_.templates=[].concat(self.templates)),Array.isArray(self.relationships)&&(self.definition_.relationships=[].concat(self.relationships)),Array.isArray(self.properties)&&(self.definition_.properties=[].concat(self.properties)),Array.isArray(self.actions)&&(self.definition_.actions=[].concat(self.actions)),Array.isArray(self.listeners)&&(self.definition_.listeners=[].concat(self.listeners)),Array.isArray(self.models)&&(self.definition_.models=[].concat(self.models)),Array.isArray(self.tests)&&(self.definition_.tests=[].concat(self.tests)),Array.isArray(self.issues)&&(self.definition_.issues=[].concat(self.issues)),self.definition_.__proto__=FObject},create:function(args,opt_X){return this.getPrototype().create(args,opt_X)},isSubModel:function(model){return model&&model.getPrototype&&(model.getPrototype()===this.getPrototype()||this.isSubModel(model.getPrototype().__proto__.model_))},getPropertyWithoutCache_:function(name){for(var i=0;i<this.properties_.length;i++){var p=this.properties_[i];if(p.name===name)return p}return null},getProperty:function(name){if(!this.propertyMap_){this.properties_||this.getPrototype();for(var m={},i=0;i<this.properties_.length;i++){var prop=this.properties_[i];m[prop.name]=prop}this.propertyMap_=m}return this.propertyMap_[name]},getAction:function(name){for(var i=0;i<this.actions_.length;i++)if(this.actions_[i].name===name)return this.actions_[i]},hashCode:function(){var string="";for(var key in this.properties_)string+=this.properties_[key].toString();
return string.hashCode()},isInstance:function(obj){return obj&&obj.model_&&this.isSubModel(obj.model_)},toString:function(){return"BootstrapModel("+this.name+")"}},BinaryProtoGrammar,DocumentationBootstrap={name:"documentation",type:"Documentation",view:function(){return X.foam.ui.DetailView.create({model:Documentation})},help:"Documentation associated with this entity.",documentation:"The developer documentation for this $$DOC{ref:'.'}. Use a $$DOC{ref:'DocModelView'} to view documentation.",setter:function(nu){DEBUG&&(this.instance_.documentation=nu)},getter:function(){if(!DEBUG)return"";var doc=this.instance_.documentation;return!doc||"undefined"==typeof Documentation||!Documentation||doc.model_&&doc.model_.getPrototype&&Documentation.isInstance(doc)||(this.instance_.documentation=Documentation.create(doc.body?doc:{body:doc})),this.instance_.documentation}},Model={__proto__:BootstrapModel,instance_:{},name:"Model",plural:"Models",help:"Describes the attributes and properties of an entity.",documentation:{body:function(){}},tableProperties:["package","name","label","plural"],properties:[{name:"id","transient":!0},{name:"sourcePath",help:"Source location of this Model.",defaultValue:"","transient":!0},{name:"abstract",type:"boolean",defaultValue:!1,help:"If the java class is abstract.",documentation:function(){}},{name:"package",help:"Package that this Model belongs to.",defaultValue:"",postSet:function(_,p){return this.id=p?p+"."+this.name:this.name},documentation:function(){}},{name:"name",type:"String",postSet:function(_,n){return this.id=this["package"]?this["package"]+"."+n:n},required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the entity.",documentation:function(){}},{name:"label",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.name.labelize()},help:"The display label for the entity.",documentation:function(){}},{name:"javaClassName",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return(this["abstract"]?"Abstract":"")+this.name},help:"The Java classname of this Model.",documentation:function(){}},{name:"extendsModel",type:"String",displayWidth:70,displayHeight:1,defaultValue:"",help:"The parent model of this model.",documentation:function(){}},{name:"plural",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.name+"s"},help:"The plural form of this model's name.",documentation:function(){}},{name:"version",type:"int",defaultValue:1,help:"Version number of model.",documentation:function(){}},{name:"ids",label:"Key Properties",type:"Array[String]",view:"foam.ui.StringArrayView",defaultValueFn:function(){var id=this.getProperty("id");return id?["id"]:this.properties_.length?[this.properties_[0].name]:[]},help:"Properties which make up unique id.",documentation:function(){}},{name:"requires",type:"Array[String]",view:"foam.ui.StringArrayView",defaultValueFn:function(){return[]},help:"Model imports.",documentation:function(){}},{name:"imports",type:"Array[String]",view:"foam.ui.StringArrayView",defaultValueFn:function(){return[]},help:"Context imports.",documentation:function(){}},{name:"exports",type:"Array[String]",view:"foam.ui.StringArrayView",defaultValueFn:function(){return[]},help:"Context exports.",documentation:function(){}},{name:"implements",type:"Array[String]",view:"foam.ui.StringArrayView",defaultValueFn:function(){return[]},help:"Interfaces implemented by this Model.",documentation:function(){}},{name:"traits",type:"Array[String]",view:"foam.ui.StringArrayView",defaultValueFn:function(){return[]},help:"Traits to mix-into this Model.",documentation:function(){}},{name:"tableProperties",type:"Array[String]",view:"foam.ui.StringArrayView",displayWidth:70,lazyFactory:function(){return this.properties_.map(function(o){return o.name})},help:"Properties to be displayed in table view. Defaults to all properties.",documentation:function(){}},{name:"searchProperties",type:"Array[String]",view:"foam.ui.StringArrayView",displayWidth:70,defaultValueFn:function(){return this.tableProperties},help:"Properties display in a search view. Defaults to table properties.",documentation:function(){}},{name:"properties",type:"Array[Property]",subType:"Property",view:"foam.ui.ArrayView",factory:function(){return[]},defaultValue:[],help:"Properties associated with the entity.",preSet:function(oldValue,newValue){if(Property){for(var i=0;i<newValue.length;i++){var p=newValue[i];"string"==typeof p&&(newValue[i]=p={name:p}),p.model_?"string"==typeof p.model_&&(p=newValue[i]=JSONUtil.mapToObj(this.X,p)):p=newValue[i]=Property.create(p),this[constantize(p.name)]=newValue[i]}return this.propertyMap_=null,newValue}},documentation:function(){}},{name:"actions",type:"Array[Action]",subType:"Action",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},defaultValue:[],help:"Actions associated with the entity.",preSet:function(_,newValue){if(!Action)return newValue;for(var i=0;i<newValue.length;i++){var p=newValue[i];p.model_?"string"==typeof p.model_&&(newValue[i]=FOAM(p)):newValue[i]=Action.create(p),this[constantize(p.name)]=newValue[i]}return newValue},documentation:function(){}},{name:"constants",type:"Array[Constant]",subType:"Constant",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},defaultValue:[],help:"Constants associated with the entity.",preSet:function(_,newValue){if(!Constant)return newValue;if(Array.isArray(newValue))return JSONUtil.arrayToObjArray(this.X,newValue,Constant);var constants=[];for(var key in newValue){var oldValue=newValue[key],constant=Constant.create({name:key,value:oldValue});constants.push(constant)}return constants}},{name:"messages",type:"Array[Message]",subType:"Constant",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},defaultValue:[],help:"Messages associated with the entity.",preSet:function(_,newValue){if(!GLOBAL.Message)return newValue;if(Array.isArray(newValue))return JSONUtil.arrayToObjArray(this.X,newValue,Message);var messages=[];for(var key in newValue){var oldValue=newValue[key],message=Message.create({name:key,value:oldValue});messages.push(message)}return messages}},{model_:"ArrayProperty",name:"methods",subType:"Method",help:"Methods associated with the entity.",adapt:function(_,newValue){if(!Method)return newValue;if(Array.isArray(newValue))return JSONUtil.arrayToObjArray(this.X,newValue,Method);var methods=[];for(var key in newValue){var oldValue=newValue[key],method=Method.create({name:key,code:oldValue});if("function"==typeof oldValue){if(Arg&&DEBUG){var str=oldValue.toString();method.args=str.match(/^function[ _$\w]*\(([ ,\w]*)/)[1].split(",").filter(function(name){return name}).map(function(name){return Arg.create({name:name.trim()})})}}else console.warn("Constant defined as Method: ",this.name+"."+key);methods.push(method)}return methods},documentation:function(){}},{name:"listeners",type:"Array[Method]",subType:"Method",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},preSet:function(_,newValue){return Array.isArray(newValue)?JSONUtil.arrayToObjArray(this.X,newValue,Method):newValue},defaultValue:[],help:"Event listeners associated with the entity.",documentation:function(){}},{name:"templates",type:"Array[Template]",subType:"Template",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},defaultValue:[],postSet:function(_,templates){TemplateUtil.expandModelTemplates(this)},help:"Templates associated with this entity.",documentation:function(){}},{name:"models",type:"Array[Model]",subType:"Model",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},adapt:function(_,newValue){return Model&&Array.isArray(newValue)?JSONUtil.arrayToObjArray(this.X,newValue,Model):newValue},postSet:function(){this.models.forEach(function(m){this[m.name]=m}.bind(this))},defaultValue:[],help:"Sub-models embedded within this model.",documentation:function(){}},{name:"tests",label:"Unit Tests",type:"Array[Unit Test]",subType:"UnitTest",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},defaultValue:[],help:"Unit tests associated with this model.",documentation:function(){}},{name:"relationships",subType:"Relationship",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},defaultValue:[],help:"Relationships of this model to other models.",preSet:function(_,newValue){if(!Relationship)return newValue;for(var i=0;i<newValue.length;i++){var p=newValue[i];p.model_?"string"==typeof p.model_&&(p=newValue[i]=FOAM(p)):p=newValue[i]=Relationship.create(p),this[constantize(p.name)]=newValue[i]}return newValue},documentation:function(){}},{name:"issues",type:"Array[Issue]",subType:"Issue",view:"foam.ui.ArrayView",factory:function(){return[]},propertyToJSON:function(visitor,output,o){o[this.name].length&&(output[this.name]=o[this.name])},defaultValue:[],help:"Issues associated with this model.",documentation:function(){}},{name:"help",label:"Help Text",type:"String",displayWidth:70,displayHeight:6,view:"foam.ui.TextAreaView",defaultValue:"",help:"Help text associated with the entity.",documentation:function(){}},{name:"i18nComplete_",defaultValue:!1,hidden:!0,"transient":!0},{name:"translationHint",label:"Description for Translation",type:"String",defaultValueFn:function(){return this.name}},DocumentationBootstrap,{name:"notes",type:"String",displayWidth:70,displayHeight:6,view:"foam.ui.TextAreaView",defaultValue:"",help:"Internal documentation associated with this entity.",documentation:function(){}},{name:"createActionFactory",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",help:"Factory to create the action object for creating this object",documentation:function(){}},{name:"deleteActionFactory",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",help:"Factory to create the action object for deleting this object",documentation:function(){}},{name:"properties_","transient":!0,hidden:!0,help:"Runtime properties of the model."},{name:"imports_","transient":!0,hidden:!0,help:"Runtime imports of the model."},{name:"exports_","transient":!0,hidden:!0,help:"Runtime exports of the model."},{name:"actions_","transient":!0,hidden:!0,help:"Runtime actions of the model."}],toString:function(){return"Model"}},Property={__proto__:BootstrapModel,instance_:{},name:"Property",plural:"Properties",help:"Describes a properties of a modelled entity.",ids:["name"],tableProperties:["name","label","type","required","defaultValue"],documentation:function(){},properties:[{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the property.",documentation:function(){}},{name:"label",type:"String",required:!1,displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.name.labelize()},help:"The display label for the property.",documentation:function(){}},{name:"speechLabel",type:"String",required:!1,displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.label},help:"The speech label for the property.",documentation:function(){}},{name:"tableLabel",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.name.labelize()},help:"The table display label for the entity.",documentation:function(){}},{name:"type",type:"String",required:!0,view:{factory_:"foam.ui.ChoiceView",choices:["Array","Boolean","Color","Date","DateTime","Email","Enum","Float","Function","Image","Int","Object","Password","String","String[]","URL"]},defaultValue:"String",help:"The type of the property.",documentation:function(){}},{name:"protobufType",type:"String",required:!1,help:"The protobuf type that represents the type of this property.",defaultValueFn:function(){return this.type.toLowerCase()},documentation:function(){}},{name:"javaType",type:"String",required:!1,defaultValueFn:function(){return this.type},help:"The java type that represents the type of this property.",documentation:function(){}},{name:"javascriptType",type:"String",required:!1,defaultValueFn:function(){return this.type},help:"The javascript type that represents the type of this property.",documentation:function(){}},{name:"shortName",type:"String",required:!0,displayWidth:10,displayHeight:1,defaultValue:"",help:"A short alternate name to be used for compact encoding.",documentation:"A short alternate $$DOC{ref:'.name'} to be used for compact encoding."},{name:"singular",type:"String",required:!1,displayWidth:70},{name:"aliases",type:"Array[String]",view:"foam.ui.StringArrayView",defaultValue:[],help:"Alternate names for this property.",documentation:function(){}},{name:"mode",type:"String",defaultValue:"read-write",view:{factory_:"foam.ui.ChoiceView",choices:["read-only","read-write","final"]},documentation:function(){}},{name:"subType",label:"Sub-Type",type:"String",displayWidth:30,help:"The type of the property.",documentation:function(){}},{name:"units",type:"String",required:!0,displayWidth:70,displayHeight:1,defaultValue:"",help:"The units of the property.",documentation:function(){}},{name:"required",type:"Boolean",view:"foam.ui.BooleanView",defaultValue:!0,help:"Indicates if the property is a required field.",documentation:function(){}},{name:"hidden",type:"Boolean",view:"foam.ui.BooleanView",defaultValue:!1,help:"Indicates if the property is hidden.",documentation:function(){}},{name:"transient",type:"Boolean",view:"foam.ui.BooleanView",defaultValue:!1,help:"Indicates if the property is transient.",documentation:function(){}},{name:"displayWidth",type:"int",displayWidth:8,displayHeight:1,defaultValue:"30",help:"The display width of the property.",documentation:function(){}},{name:"displayHeight",type:"int",displayWidth:8,displayHeight:1,defaultValue:1,help:"The display height of the property.",documentation:function(){}},{model_:"ViewFactoryProperty",name:"view",type:"view",defaultValue:"foam.ui.TextFieldView",help:"View component for the property.",documentation:function(){}},{model_:"ViewFactoryProperty",name:"detailView",type:"view",defaultValueFn:function(){return this.view},help:"View component for the property when rendering within a DetailView.",documentation:function(){}},{model_:"ViewFactoryProperty",name:"citationView",type:"view",defaultValueFn:function(){return this.view},help:"View component for the property when rendering within a CitationView.",documentation:function(){}},{name:"detailViewPreRow",defaultValue:function(){return""},help:"Inject HTML before row in DetailView.",documentation:function(){}},{name:"detailViewPostRow",defaultValue:function(){return""},help:"Inject HTML before row in DetailView.",documentation:function(){}},{name:"defaultValue",type:"String",required:!1,displayWidth:70,displayHeight:1,defaultValue:"",postSet:function(old,nu){nu&&this.defaultValueFn&&(this.defaultValueFn=void 0)},help:"The property's default value.",documentation:function(){}},{name:"defaultValueFn",label:"Default Value Function",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",postSet:function(old,nu){nu&&this.defaultValue&&(this.defaultValue=void 0)},help:"The property's default value function.",documentation:function(){}},{name:"dynamicValue",label:"Value's Dynamic Function",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",help:"A dynamic function which computes the property's value.",documentation:function(){}},{name:"factory",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",help:"Factory for creating initial value when new object instantiated.",documentation:function(){}},{name:"lazyFactory",type:"Function",required:!1,view:"foam.ui.FunctionView",help:"Factory for creating the initial value. Only called when the property is accessed for the first time.",documentation:function(){}},{name:"getter",type:"Function",required:!1,displayWidth:70,displayHeight:3,view:"foam.ui.FunctionView",defaultValue:"",help:"The property's default value function.",documentation:function(){}},{name:"adapt",type:"Function",required:!1,displayWidth:70,displayHeight:3,view:"foam.ui.FunctionView",defaultValue:"",help:"An adapter function called before preSet.",documentation:function(){}},{name:"preSet",type:"Function",required:!1,displayWidth:70,displayHeight:3,view:"foam.ui.FunctionView",defaultValue:"",help:"An adapter function called before normal setter logic.",documentation:function(){}},{name:"postSet",type:"Function",required:!1,displayWidth:70,displayHeight:3,view:"foam.ui.FunctionView",defaultValue:"",help:"A function called after normal setter logic, but before property change event fired.",documentation:function(){}},{name:"setter",type:"Function",required:!1,displayWidth:70,displayHeight:3,view:"foam.ui.FunctionView",defaultValue:"",help:"The property's default value function.",documentation:function(){}},{name:"tableFormatter",label:"Table Cell Formatter",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",help:"Function to format value for display in TableView.",documentation:"A function to format the value for display in a $$DOC{ref:'foam.ui.TableView'}."},{name:"summaryFormatter",label:"Summary Formatter",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",help:"Function to format value for display in SummaryView.",documentation:"A function to format the value for display in a $$DOC{ref:'SummaryView'}."},{name:"tableWidth",type:"String",required:!1,defaultValue:"",help:"Table View Column Width.",documentation:"A Suggestion for $$DOC{ref:'foam.ui.TableView'} column width."},{name:"help",label:"Help Text",type:"String",required:!1,displayWidth:70,displayHeight:6,view:"foam.ui.TextAreaView",defaultValue:"",help:"Help text associated with the property.",documentation:function(){}},DocumentationBootstrap,{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field.",documentation:"The protobuf tag number for this field."},{name:"actionFactory",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",help:"Factory to create the action objects for taking this property from value A to value B",documentation:"Factory to create the $$DOC{ref:'Action'} objects for taking this $$DOC{ref:'Property'} from value A to value B"},{name:"compareProperty",type:"Function",view:"foam.ui.FunctionView",displayWidth:70,displayHeight:5,defaultValue:function(o1,o2){return(o1.localeCompare||o1.compareTo).call(o1,o2)},help:"Comparator function.",documentation:"A comparator function two compare two instances of this $$DOC{ref:'Property'}."},{name:"fromString",defaultValue:function(s,p){this[p.name]=s},help:"Function to extract value from a String."},{name:"fromElement",defaultValue:function(e,p){p.fromString.call(this,e.innerHTML,p)},help:"Function to extract from a DOM Element.",documentation:"Function to extract a value from a DOM Element."},{name:"propertyToJSON",defaultValue:function(visitor,output,o){this["transient"]||(output[this.name]=visitor.visit(o[this.name]))},help:"Function to extract from a DOM Element.",documentation:"Function to extract a value from a DOM Element."},{name:"autocompleter",subType:"Autocompleter",help:"Name or model for the autocompleter for this property.",documentation:function(){}},{name:"install",type:"Function",required:!1,displayWidth:70,displayHeight:3,rows:3,view:"foam.ui.FunctionView",defaultValue:"",help:"A function which installs additional features into the Model's prototype.",documentation:function(){}},{name:"exclusive",type:"Boolean",view:"foam.ui.BooleanView",defaultValue:!0,help:"Indicates if the property can only have a single value.",documentation:function(){}},{name:"memorable",type:"Boolean",help:"True if this value should be included in a memento for this object.",defaultValue:!1}],methods:{partialEval:function(){return this},f:function(obj){return obj[this.name]},compare:function(o1,o2){return this.compareProperty(this.f(o1),this.f(o2))},toSQL:function(){return this.name},toMQL:function(){return this.name},toBQL:function(){return this.name},initPropertyAgents:function(proto){var prop=this,name=prop.name,name$_=prop.name$_;proto.addInitAgent(this.postSet||this.setter?9:0,name+": "+(this.postSet||this.setter?"copy arg (postSet)":"copy arg"),function(o,X,Y,m){m&&(m.hasOwnProperty(name)&&(o[name]=m[name]),m.hasOwnProperty(name$_)&&(o[name$_]=m[name$_]))}),this.dynamicValue&&proto.addInitAgent(10,name+": dynamicValue",function(o,X,Y){var dynamicValue=prop.dynamicValue;Events.dynamic(dynamicValue.bind(o),function(value){o[name]=value})}),this.factory&&proto.addInitAgent(11,name+": factory",function(o,X,Y){o.hasOwnProperty(name)||o[name]})}},toString:function(){return"Property"}};Model.methods={getPropertyWithoutCache_:BootstrapModel.getPropertyWithoutCache_,getProperty:BootstrapModel.getProperty,getAction:BootstrapModel.getAction,hashCode:BootstrapModel.hashCode,buildPrototype:BootstrapModel.buildPrototype,getPrototype:BootstrapModel.getPrototype,isSubModel:BootstrapModel.isSubModel,isInstance:BootstrapModel.isInstance,getAllRequires:BootstrapModel.getAllRequires},Model=Model.create(Model),Model.model_=Model,Model.create=BootstrapModel.create,Property=Model.create(Property);for(var i=0;i<Property.properties.length;i++)Property.properties[i]=Property.create(Property.properties[i]);for(var i=0;i<Property.properties_.length;i++)Property[constantize(Property.properties_[i].name)]=Property.properties_[i]=Property.create(Property.properties_[i]);USED_MODELS.Property=!0,USED_MODELS.Model=!0;var StringProperty=Model.create({extendsModel:"Property",name:"StringProperty",help:"Describes a properties of type String.",properties:[{name:"displayHeight",type:"int",displayWidth:8,defaultValue:1,help:"The display height of the property."},{name:"type",type:"String",displayWidth:20,defaultValue:"String",help:"The FOAM type of this property."},{name:"adapt",defaultValue:function(_,v){return void 0===v||null===v?"":"function"==typeof v?multiline(v):v.toString()}},{name:"javaType",type:"String",displayWidth:70,defaultValue:"String",help:"The Java type of this property."},{name:"view",defaultValue:"foam.ui.TextFieldView"},{name:"pattern",help:"Regex pattern for property."},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."}]}),BooleanProperty=Model.create({extendsModel:"Property",name:"BooleanProperty",help:"Describes a properties of type String.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Boolean",help:"The FOAM type of this property."},{name:"javaType",type:"String",displayWidth:70,defaultValue:"bool",help:"The Java type of this property."},{name:"view",defaultValue:"foam.ui.BooleanView"},{name:"defaultValue",defaultValue:!1},{name:"adapt",defaultValue:function(_,v){return!!v}},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."},{name:"fromString",defaultValue:function(s,p){var txt=s.trim();this[p.name]=txt.equalsIC("y")||txt.equalsIC("yes")||txt.equalsIC("true")||txt.equalsIC("t")},help:"Function to extract value from a String."}]}),DateProperty=Model.create({extendsModel:"Property",name:"DateProperty",help:"Describes a properties of type String.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Date",help:"The FOAM type of this property."},{name:"displayWidth",defaultValue:50},{name:"javaType",type:"String",defaultValue:"Date",help:"The Java type of this property."},{name:"view",defaultValue:"DateFieldView"},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."},{name:"adapt",defaultValue:function(_,d){return"string"==typeof d?new Date(d):d}},{name:"tableFormatter",defaultValue:function(d){return d?d.toRelativeDateString():""}},{name:"compareProperty",defaultValue:function(o1,o2){return o1?o2?o1.compareTo(o2):1:o2?-1:0}}]}),DateTimeProperty=Model.create({extendsModel:"DateProperty",name:"DateTimeProperty",help:"Describes a properties of type String.",properties:[{name:"type",type:"String",displayWidth:25,defaultValue:"datetime",help:"The FOAM type of this property."},{name:"adapt",defaultValue:function(_,d){return"number"==typeof d?new Date(d):"string"==typeof d?new Date(d):d}},{name:"view",defaultValue:"foam.ui.DateTimeFieldView"}]}),IntProperty=Model.create({extendsModel:"Property",name:"IntProperty",help:"Describes a properties of type Int.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Int",help:"The FOAM type of this property."},{name:"displayWidth",defaultValue:10},{name:"javaType",type:"String",displayWidth:10,defaultValue:"int",help:"The Java type of this property."},{name:"view",defaultValue:"foam.ui.IntFieldView"},{name:"adapt",defaultValue:function(_,v){return"number"==typeof v?Math.round(v):v?parseInt(v):0}},{name:"defaultValue",defaultValue:0},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."},{name:"compareProperty",defaultValue:function(o1,o2){return o1===o2?0:o1>o2?1:-1}}]}),FloatProperty=Model.create({extendsModel:"Property",name:"FloatProperty",help:"Describes a properties of type Float.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Float",help:"The FOAM type of this property."},{name:"defaultValue",defaultValue:0},{name:"javaType",type:"String",displayWidth:10,defaultValue:"double",help:"The Java type of this property."},{name:"displayWidth",defaultValue:15},{name:"view",defaultValue:"foam.ui.FloatFieldView"},{name:"adapt",defaultValue:function(_,v){return"number"==typeof v?v:v?parseFloat(v):0}},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."}]}),FunctionProperty=Model.create({extendsModel:"Property",name:"FunctionProperty",help:"Describes a properties of type Function.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Function",help:"The FOAM type of this property."},{name:"javaType",type:"String",displayWidth:10,defaultValue:"Function",help:"The Java type of this property."},{name:"displayWidth",defaultValue:15},{name:"view",defaultValue:"foam.ui.FunctionView"},{name:"defaultValue",defaultValue:function(){}},{name:"fromElement",defaultValue:function(e,p){var txt=e.innerHTML.trim();this[p.name]=txt.startsWith("function")?eval("("+txt+")"):new Function(txt)}},{name:"adapt",defaultValue:function(_,value){return"string"==typeof value?value.startsWith("function")?eval("("+value+")"):new Function(value):value}}]}),ArrayProperty=Model.create({extendsModel:"Property",name:"ArrayProperty",help:"Describes a properties of type Array.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Array",help:"The FOAM type of this property."},{name:"singular",type:"String",displayWidth:70,defaultValueFn:function(){return this.name.replace(/s$/,"")},help:"The plural form of this model's name.",documentation:function(){}},{name:"subType",type:"String",displayWidth:20,defaultValue:"",help:"The FOAM sub-type of this property."},{name:"protobufType",defaultValueFn:function(){return this.subType}},{name:"adapt",defaultValue:function(_,a,prop){var m=this.X.lookup(prop.subType)||GLOBAL.lookup(prop.subType);if(!m)return a;for(var i=0;i<a.length;i++)a[i]=a[i].model_?FOAM(a[i]):m.create(a[i]);return a}},{name:"postSet",defaultValue:function(oldA,a,prop){var name=prop.name+"ArrayRelay_",l=this[name]||(this[name]=function(){this.propertyChange(prop.name,null,this[prop.name])}.bind(this));oldA&&oldA.unlisten&&oldA.unlisten(l),a&&a.listen&&a.listen(l)}},{name:"javaType",type:"String",displayWidth:10,defaultValueFn:function(p){return p.subType+"[]"},help:"The Java type of this property."},{name:"view",defaultValue:"foam.ui.ArrayView"},{name:"factory",defaultValue:function(){return[]}},{name:"propertyToJSON",defaultValue:function(visitor,output,o){!this["transient"]&&o[this.name].length&&(output[this.name]=visitor.visitArray(o[this.name]))}},{name:"install",defaultValue:function(prop){defineLazyProperty(this,prop.name+"$Proxy",function(){var proxy=ProxyDAO.create({delegate:this[prop.name].dao});return this.addPropertyListener(prop.name,function(_,_,_,a){proxy.delegate=a.dao}),{get:function(){return proxy},configurable:!0}}),this.addMethod("get"+capitalize(prop.singular),function(id){for(var i=0;i<this[prop.name].length;i++)if(this[prop.name][i].id===id)return this[prop.name][i]})}},{name:"fromElement",defaultValue:function(e,p){for(var model=this.X.lookup(e.getAttribute("model")||p.subType),children=e.children,a=[],i=0;i<children.length;i++){var o=model.create(null,this.Y);o.fromElement(children[i],p),a.push(o)}this[p.name]=a}},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."}]}),ReferenceProperty=Model.create({extendsModel:"Property",name:"ReferenceProperty",help:"A foreign key reference to another Entity.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Reference",help:"The FOAM type of this property."},{name:"subType",type:"String",displayWidth:20,defaultValue:"",help:"The FOAM sub-type of this property."},{name:"subKey",type:"EXPR",displayWidth:20,defaultValue:"ID",help:"The foreign key that this property references."},{name:"javaType",type:"String",displayWidth:10,defaultValueFn:function(p){return"Object"},help:"The Java type of this property."},{name:"view",defaultValue:"foam.ui.TextFieldView"},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."}]}),StringArrayProperty=Model.create({extendsModel:"Property",name:"StringArrayProperty",help:"An array of String values.",properties:[{name:"type",type:"String",displayWidth:20,defaultValue:"Array[]",help:"The FOAM type of this property."},{name:"singular",type:"String",displayWidth:70,defaultValueFn:function(){return this.name.replace(/s$/,"")},help:"The plural form of this model's name.",documentation:function(){}},{name:"subType",type:"String",displayWidth:20,defaultValue:"String",help:"The FOAM sub-type of this property."},{name:"displayWidth",defaultValue:50},{name:"adapt",defaultValue:function(_,v){return Array.isArray(v)?v:[v]}},{name:"factory",defaultValue:function(){return[]}},{name:"javaType",type:"String",displayWidth:10,defaultValue:"String[]",help:"The Java type of this property."},{name:"view",defaultValue:"foam.ui.StringArrayView"},{name:"prototag",label:"Protobuf tag",type:"Int",required:!1,help:"The protobuf tag number for this field."},{name:"exclusive",defaultValue:!1},{name:"fromElement",defaultValue:function(e,p){this[p.name]=this[p.name].pushF(e.innerHTML)}}]}),DAOProperty=Model.create({extendsModel:"Property",name:"DAOProperty",help:"Describes a DAO property.",properties:[{name:"type",defaultValue:"DAO",help:"The FOAM type of this property."},{name:"view",defaultValue:"foam.ui.ArrayView"},{name:"onDAOUpdate"},{name:"install",defaultValue:function(prop){defineLazyProperty(this,prop.name+"$Proxy",function(){if(this[prop.name])delegate=this[prop.name];
else var future=afuture(),delegate=FutureDAO.create({future:future.get});var proxy=ProxyDAO.create({delegate:delegate});return this.addPropertyListener(prop.name,function(_,_,_,dao){return future?(future.set(dao),void(future=null)):void(proxy.delegate=dao)}),{get:function(){return proxy},configurable:!0}})}}]}),ModelProperty=Model.create({name:"ModelProperty",extendsModel:"Property",help:"Describes a Model property.",properties:[{name:"type",defaultValue:"Model"},{name:"getter",defaultValue:function(name){var value=this.instance_[name];if("undefined"==typeof value){var prop=this.model_.getProperty(name);value=prop&&prop.defaultValueFn?prop.defaultValueFn.call(this,prop):prop.defaultValue}return this.X.lookup(value)}},{name:"propertyToJSON",defaultValue:function(visitor,output,o){this["transient"]||(output[this.name]=o[this.name].id)}}]}),ViewProperty=Model.create({name:"ViewProperty",extendsModel:"Property",help:"Describes a View-Factory property.",properties:[{name:"adapt",doc:"Can be specified as either a function, a Model, a Model path, or a JSON object.",defaultValue:function(_,f){return"function"==typeof f?f:"string"==typeof f?function(d,opt_X){return(opt_X||this.X).lookup(f).create(d,opt_X||this.Y)}.bind(this):"function"==typeof f.create?f.create.bind(f):"string"==typeof f.model_?function(d,opt_X){return FOAM(f,opt_X||this.Y).copyFrom(d)}:(console.error("******* Unknown view factory: ",f),f)}},{name:"defaultValue",adapt:function(_,f){return ViewProperty.ADAPT.defaultValue.call(this,null,f)}}]}),FactoryProperty=Model.create({name:"FactoryProperty",extendsModel:"Property",help:"Describes a Factory property.",properties:[{name:"preSet",doc:"Can be specified as either a function, a Model, a Model path, or a JSON object.",defaultValue:function(_,f){return"function"==typeof f?f:"string"==typeof f?function(map,opt_X){return(opt_X||this.X).lookup(f).create(map,opt_X||this.Y)}.bind(this):Model.isInstance(f)?f.create.bind(f):f.factory_?function(map,opt_X){var X=opt_X||this.X,m=X.lookup(f.factory_);return console.assert(m,"Unknown Factory Model: "+f.factory_),m.create(f,opt_X||this.Y)}.bind(this):(console.error("******* Invalid Factory: ",f),f)}}]}),ViewFactoryProperty=Model.create({name:"ViewFactoryProperty",extendsModel:"FactoryProperty",help:"Describes a View Factory property.",properties:[{name:"defaultValue",preSet:function(_,f){return ViewFactoryProperty.ADAPT.defaultValue.call(this,null,f)}},{name:"fromElement",defaultValue:function(e,p){this[p.name]=e.innerHTML_||(e.innerHTML_=e.innerHTML)}},{name:"adapt",doc:"Can be specified as either a function, String markup, a Model, a Model path, or a JSON object.",defaultValue:function(_,f){if(!f)return f;if("function"==typeof f)return f;var ret;if("string"==typeof f){if(/[^0-9a-zA-Z$_.]/.exec(f)){var VIEW_CACHE=ViewFactoryProperty.VIEW_CACHE||(ViewFactoryProperty.VIEW_CACHE={}),viewModel=VIEW_CACHE[f];viewModel||(viewModel=VIEW_CACHE[f]=Model.create({name:"InnerDetailView"+this.$UID,extendsModel:"foam.ui.DetailView",templates:[{name:"toHTML",template:f}]}),arequireModel(viewModel));var ret=function(args,X){return viewModel.create(args,X||this.Y)}}else ret=function(map,opt_X){return(opt_X||this.X).lookup(f).create(map,opt_X||this.Y)}.bind(this);return ret.toString=function(){return'"'+f+'"'},ret}return Model.isInstance(f)?f.create.bind(f):f.factory_?(ret=function(map,opt_X){var m=(opt_X||this.X).lookup(f.factory_);return console.assert(m,"Unknown ViewFactory Model: "+f.factory_),m.create(f,opt_X||this.Y).copyFrom(map)}.bind(this),ret.toString=function(){return JSON.stringify(f)},ret):this.X.lookup("foam.ui.BaseView").isInstance(f)?constantFn(f):(console.error("******* Invalid Factory: ",f),f)}}]}),ReferenceArrayProperty=Model.create({name:"ReferenceArrayProperty",extendsModel:"ReferenceProperty",properties:[{name:"type",defaultValue:"Array",displayWidth:20,help:"The FOAM type of this property."},{name:"factory",defaultValue:function(){return[]}},{name:"view",defaultValue:"foam.ui.StringArrayView"}]}),EMailProperty=StringProperty,URLProperty=StringProperty,DocumentationProperty=Model.create({extendsModel:"Property",name:"DocumentationProperty",help:"Describes the documentation properties found on Models, Properties, Actions, Methods, etc.",documentation:"The developer documentation for this $$DOC{ref:'.'}. Use a $$DOC{ref:'DocModelView'} to view documentation.",properties:[{name:"type",type:"String",defaultvalue:"Documentation"},{name:"getter",type:"Function",defaultValue:function(name){var doc=this.instance_[name];return!doc||"undefined"==typeof Documentation||!Documentation||doc.model_&&doc.model_.getPrototype&&Documentation.isInstance(doc)||(this.instance_[name]=Documentation.create(doc.body?doc:{body:doc})),this.instance_[name]}},{name:"view",defaultValue:"foam.ui.DetailView"},{name:"help",defaultValue:"Documentation for this entity."},{name:"documentation",factory:function(){return"The developer documentation for this $$DOC{ref:'.'}. Use a $$DOC{ref:'DocModelView'} to view documentation."}}]});CLASS({name:"Action",plural:"Actions",tableProperties:["name","label"],documentation:function(){},properties:[{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the action.",documentation:function(){}},{name:"label",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.name.labelize()},help:"The display label for the action.",documentation:function(){}},{name:"speechLabel",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.label},help:"The speech label for the action.",documentation:"A speakable label for the $$DOC{ref:'.'}. Used for accessibility."},{name:"help",label:"Help Text",type:"String",displayWidth:70,displayHeight:6,defaultValue:"",help:"Help text associated with the action.",documentation:function(){}},{model_:"DocumentationProperty",name:"documentation",documentation:function(){}},{name:"default",type:"Boolean",view:"foam.ui.BooleanView",defaultValue:!1,help:"Indicates if this is the default action.",documentation:function(){}},{model_:"FunctionProperty",name:"isAvailable",label:"Available",displayWidth:70,displayHeight:3,defaultValue:function(){return!0},help:"Function to determine if action is available.",documentation:function(){}},{model_:"FunctionProperty",name:"isEnabled",label:"Enabled",displayWidth:70,displayHeight:3,defaultValue:function(){return!0},help:"Function to determine if action is enabled.",documentation:function(){}},{model_:"FunctionProperty",name:"labelFn",label:"Label Function",defaultValue:function(action){return action.label},help:"Function to determine label. Defaults to 'this.label'.",documentation:function(){}},{name:"iconUrl",type:"String",defaultValue:void 0,help:"Provides a url for an icon to render for this action",documentation:function(){}},{name:"showLabel",type:"String",defaultValue:!0,help:"Property indicating whether the label should be rendered alongside the icon",documentation:function(){}},{name:"children",type:"Array",factory:function(){return[]},subType:"Action",view:"foam.ui.ArrayView",help:"Child actions of this action.",persistent:!1,documentation:function(){}},{name:"parent",type:"String",help:"The parent action of this action",documentation:function(){}},{model_:"FunctionProperty",name:"action",displayWidth:80,displayHeight:20,defaultValue:"",help:"Function to implement action.",documentation:function(){}},{model_:"StringArrayProperty",name:"keyboardShortcuts",documentation:function(){}},{name:"translationHint",label:"Description for Translation",type:"String",defaultValue:""}],methods:{callIfEnabled:function(X,that){this.isEnabled.call(that,this)&&(this.action.call(that,X,this),that.publish(["action",this.name],this))}}}),CLASS({name:"Arg",tableProperties:["type","name","description"],documentation:function(){},properties:[{name:"type",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"Object",help:"The type of this argument.",documentation:function(){}},{name:"javaType",type:"String",required:!1,defaultValueFn:function(){return this.type},help:"The java type that represents the type of this property.",documentation:function(){}},{name:"javascriptType",type:"String",required:!1,defaultValueFn:function(){return this.type},help:"The javascript type that represents the type of this property.",documentation:function(){}},{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the entity.",documentation:function(){}},{model_:"BooleanProperty",name:"required",defaultValue:!0,documentation:function(){}},{name:"defaultValue",help:"Default Value if not required and not provided.",documentation:function(){}},{name:"description",type:"String",displayWidth:70,displayHeight:1,defaultValue:"",help:"A brief description of this argument.",documentation:function(){}},{name:"help",label:"Help Text",type:"String",displayWidth:70,displayHeight:6,defaultValue:"",help:"Help text associated with the entity.",documentation:function(){}},{model_:"DocumentationProperty",name:"documentation",documentation:function(){}}],methods:{decorateFunction:function(f,i){if("Object"===this.type)return f;var type=this.type;return this.required?function(){return console.assert(void 0!==arguments[i],"Missing required argument# "+i),console.assert(typeof arguments[i]===type,"argument# "+i+" type expected to be "+type+", but was "+typeof arguments[i]+": "+arguments[i]),f.apply(this,arguments)}:function(){return console.assert(void 0===arguments[i]||typeof arguments[i]===type,"argument# "+i+" type expected to be "+type+", but was "+typeof arguments[i]+": "+arguments[i]),f.apply(this,arguments)}}},templates:[{model_:"Template",name:"javaSource",description:"Java Source",template:"<%= this.type %> <%= this.name %>"},{model_:"Template",name:"closureSource",description:"Closure JavaScript Source",template:"@param {<%= this.javascriptType %>} <%= this.name %> ."},{model_:"Template",name:"webIdl",description:"Web IDL Source",template:"<%= this.type %> <%= this.name %>"}]}),CLASS({name:"Constant",plural:"constants",tableProperties:["name","value","description"],documentation:function(){},properties:[{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the entity.",documentation:function(){}},{name:"description",type:"String",displayWidth:70,displayHeight:1,defaultValue:"",help:"A brief description of this method.",documentation:function(){}},{model_:"DocumentationProperty",name:"documentation",documentation:function(){}},{name:"value",help:"The value of the constant.."},{name:"type",defaultValue:"",help:"Type of the constant."},{name:"translationHint",label:"Description for Translation",type:"String",defaultValue:""}]}),CLASS({name:"Message",plural:"messages",tableProperties:["name","value","translationHint"],documentation:function(){},properties:[{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the message.",documentation:function(){}},{name:"value",type:"String",help:"The message itself."},{name:"translationHint",type:"String",displayWidth:70,displayHeight:1,defaultValue:"",help:"A brief description of this message and the context in which it used.",documentation:function(){}}]}),CLASS({name:"Method",plural:"Methods",tableProperties:["name","description"],documentation:function(){},properties:[{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the entity.",documentation:function(){}},{name:"description",type:"String",displayWidth:70,displayHeight:1,defaultValue:"",help:"A brief description of this method.",documentation:function(){}},{name:"help",label:"Help Text",type:"String",displayWidth:70,displayHeight:6,defaultValue:"",help:"Help text associated with the entity.",documentation:function(){}},{model_:"DocumentationProperty",name:"documentation",documentation:function(){}},{name:"code",type:"Function",displayWidth:80,displayHeight:30,view:"foam.ui.FunctionView",help:"Javascript code to implement this method.",postSet:function(){if(DEBUG){var multilineComment=/^\s*function\s*\([\$\s\w\,]*?\)\s*{\s*\/\*([\s\S]*?)\*\/[\s\S]*$|^\s*\/\*([\s\S]*?)\*\/([\s\S]*)/.exec(this.code.toString());if(multilineComment){var bodyFn=multilineComment[1];this.documentation=this.Y.Documentation.create({name:this.name,body:bodyFn})}}},documentation:function(){}},{name:"returnType",defaultValue:"",help:"Return type.",documentation:function(){}},{model_:"BooleanProperty",name:"returnTypeRequired",defaultValue:!0,documentation:function(){}},{model_:"ArrayProperty",name:"args",type:"Array[Arg]",subType:"Arg",view:"foam.ui.ArrayView",factory:function(){return[]},defaultValue:[],help:"Method arguments.",documentation:function(){}},{name:"whenIdle",help:"Should this listener be deferred until the system is idle (ie. not running any animations).",documentation:function(){}},{name:"isMerged",help:"As a listener, should this be merged?",documentation:function(){}},{model_:"BooleanProperty",name:"isFramed",help:"As a listener, should this be animated?",defaultValue:!1,documentation:function(){}}],templates:[{model_:"Template",name:"javaSource",description:"Java Source",template:'<%= this.returnType || "void" %> <%= this.name %>(<% for ( var i = 0 ; i < this.args.length ; i++ ) { var arg = this.args[i]; %><%= arg.javaSource() %><% if ( i < this.args.length-1 ) out(", ");%><% } %>)'},{model_:"Template",name:"closureSource",description:"Closure JavaScript Source",template:"/**\n<% for ( var i = 0; i < this.args.length ; i++ ) { var arg = this.args[i]; %> * <%= arg.closureSource() %>\n<% } %><% if (this.returnType) { %> * @return {<%= this.returnType %>} .\n<% } %> */\n<%= arguments[1] %>.prototype.<%= this.name %> = goog.abstractMethod;"},{model_:"Template",name:"webIdl",description:"Web IDL Source",template:"<%= this.returnType || 'void' %> <%= this.name %>(<% for ( var i = 0 ; i < this.args.length ; i++ ) { var arg = this.args[i]; %><%= arg.webIdl() %><% if ( i < this.args.length-1 ) out(\", \"); %><% } %>)"}]}),Method.getPrototype().decorateFunction=function(f){for(var i=0;i<this.args.length;i++){var arg=this.args[i];f=arg.decorateFunction(f,i)}var returnType=this.returnType;return returnType?function(){var ret=f.apply(this,arguments);return console.assert(typeof ret===returnType,"return type expected to be "+returnType+", but was "+typeof ret+": "+ret),ret}:f},Method.getPrototype().generateFunction=function(){var f=this.code;return DEBUG?this.decorateFunction(f):f},Method.methods={decorateFunction:Method.getPrototype().decorateFunction,generateFunction:Method.getPrototype().generateFunction},CLASS({name:"Interface",plural:"Interfaces",tableProperties:["package","name","description"],documentation:function(){},properties:[{name:"id","transient":!0,factory:function(){return this["package"]?this["package"]+"."+this.name:this.name}},{name:"name",required:!0,help:"Interface name.",documentation:function(){}},{name:"package",help:"Interface package.",documentation:Model.PACKAGE.documentation.clone()},{name:"extends",type:"Array[String]",view:"foam.ui.StringArrayView",help:"Interfaces extended by this interface.",documentation:function(){}},{name:"description",type:"String",required:!0,displayWidth:70,displayHeight:1,defaultValue:"",help:"The interface's description.",documentation:function(){}},{name:"help",label:"Help Text",displayWidth:70,displayHeight:6,view:"foam.ui.TextAreaView",help:"Help text associated with the argument.",documentation:function(){}},{model_:"DocumentationProperty",name:"documentation"},{model_:"ArrayProperty",name:"methods",type:"Array[Method]",subType:"Method",view:"foam.ui.ArrayView",factory:function(){return[]},defaultValue:[],help:"Methods associated with the interface.",documentation:function(){}}],templates:[{model_:"Template",name:"javaSource",description:"Java Source",template:'public interface <% out(this.name); %>\n<% if ( this.extends.length ) { %>   extends <%= this.extends.join(", ") %>\n<% } %>{\n<% for ( var i = 0 ; i < this.methods.length ; i++ ) { var meth = this.methods[i]; %>   <%= meth.javaSource() %>;\n<% } %>}'},{model_:"Template",name:"closureSource",description:"Closure JavaScript Source",template:"goog.provide('<%= this.name %>');\n\n/**\n * @interface\n<% for ( var i = 0 ; i < this.extends.length ; i++ ) { var ext = this.extends[i]; %> * @extends {<%= ext %>}\n<% } %> */\n<%= this.name %> = function() {};\n<% for ( var i = 0 ; i <  this.methods.length ; i++ ) { var meth = this.methods[i]; %>\n<%= meth.closureSource(undefined, this.name) %>\n<% } %>"},{model_:"Template",name:"webIdl",description:"Web IDL Source",template:"interface <%= this.name %> <% if (this.extends.length) { %>: <%= this.extends[0] %> <% } %>{\n<% for ( var i = 0 ; i < this.methods.length ; i++ ) { var meth = this.methods[i]; %>  <%= meth.webIdl() %>;\n<% } %>}"}]}),CLASS({name:"Template",tableProperties:["name","description"],documentation:function(){},properties:[{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The template's unique name.",documentation:function(){}},{name:"description",type:"String",required:!0,displayWidth:70,displayHeight:1,defaultValue:"",help:"The template's description.",documentation:"A human readable description of the $$DOC{ref:'.'}."},{model_:"ArrayProperty",name:"args",type:"Array[Arg]",subType:"Arg",view:"foam.ui.ArrayView",factory:function(){return[]},defaultValue:[],help:"Method arguments.",documentation:function(){}},{name:"template",type:"String",displayWidth:180,displayHeight:30,rows:30,cols:80,defaultValue:"",view:"foam.ui.TextAreaView",help:"Template text. <%= expr %> or <% out(...); %>",documentation:"The string content of the uncompiled $$DOC{ref:'Template'} body."},{name:"futureTemplate","transient":!0},{name:"code","transient":!0},{model_:"DocumentationProperty",name:"documentation"}]}),CLASS({name:"Documentation",tableProperties:["name"],documentation:function(){},properties:[{name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"documentation",help:"The Document's unique name.",documentation:"An optional name for the document. Documentation is normally referenced by the name of the containing Model."},{name:"label",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The Document's title or descriptive label.",documentation:"A human readable title to display. Used for books of documentation and chapters."},{name:"body",type:"Template",defaultValue:"",help:"The main content of the document.",documentation:"The main body text of the document. Any valid template can be used, including the $$DOC{ref:'foam.documentation.DocView'} specific $$DOC{ref:'foam.documentation.DocView',text:'$$DOC{\"ref\"}'} tag.",preSet:function(_,template){return TemplateUtil.expandTemplate(this,template)}},{model_:"ArrayProperty",name:"chapters",type:"Array[Document]",subtype:"Documentation",view:"foam.ui.ArrayView",factory:function(){return[]},defaultValue:[],help:"Sub-documents comprising the full body of this document.",documentation:"Optional sub-documents to be included in this document. A viewer may choose to provide an index or a table of contents.",preSet:function(old,nu){if(!DEBUG)return[];var self=this,foamalized=[];return nu.forEach(function(chapter){foamalized.push(!chapter||"undefined"==typeof self.Y.Documentation||!self.Y.Documentation||chapter.model_&&chapter.model_.getPrototype&&self.Y.Documentation.isInstance(chapter)?chapter:chapter.body?self.Y.Documentation.create(chapter):self.Y.Documentation.create({body:chapter}))}),foamalized}}]}),TemplateUtil.expandModelTemplates(Property),TemplateUtil.expandModelTemplates(Method),TemplateUtil.expandModelTemplates(Model),TemplateUtil.expandModelTemplates(Arg),CLASS({name:"UnitTest",plural:"Unit Tests",documentation:function(){},tableProperties:["description","passed","failed"],properties:[{model_:"Property",name:"name",type:"String",required:!0,displayWidth:50,documentation:"The unit test's name."},{model_:"Property",name:"description",type:"String",displayWidth:70,displayHeight:5,defaultValue:"",documentation:"A multi-line description of the unit test."},{model_:"BooleanProperty",name:"disabled",documentation:"When true, this test is ignored. Test runners should exclude disabled tests from their DAOs.",defaultValue:!1},{model_:"IntProperty",name:"passed",required:!0,"transient":!0,displayWidth:8,displayHeight:1,view:"foam.ui.IntFieldView",documentation:"Number of assertions which have passed."},{model_:"IntProperty",name:"failed",required:!0,"transient":!0,displayWidth:8,displayHeight:1,documentation:"Number of assertions which have failed."},{model_:"BooleanProperty",name:"async",defaultValue:!1,documentation:'Set to make this test asynchronoous. Async tests receive a <tt>ret</tt> parameter as their first argument, and $$DOC{ref: ".atest"} will not return until <tt>ret</tt> is called by the test code.'},{model_:"FunctionProperty",name:"code",label:"Test Code",displayWidth:80,displayHeight:30,documentation:'The code for the test. Should not include the <tt>function() { ... }</tt>, just the body. Should expect a <tt>ret</tt> parameter when the test is async, see $$DOC{ref: ".async", text: "above"}.',fromElement:function(e,p){var txt=e.innerHTML;txt=txt.trim().startsWith("function")?txt:this.async?"function(ret) {\n"+txt+"\n}":"function() {\n"+txt+"\n}",this[p.name]=eval("("+txt+")")},adapt:function(_,value){if("string"==typeof value&&(value=value.startsWith("function")?eval("("+value+")"):new Function(value)),"function"==typeof value&&this.async&&0===value.length){var str=value.toString();return eval("(function(ret)"+str.substring(str.indexOf("{"))+")")}return value}},{model_:"BooleanProperty",name:"hasRun","transient":!0,hidden:!0,defaultValue:!1,documentation:"Set after the test has finished executing. Prevents the test from running twice."},{model_:"Property",name:"results",type:"String",mode:"read-only",view:"foam.ui.UnitTestResultView","transient":!0,required:!0,displayWidth:80,displayHeight:20,documentation:'Log output for this test. Written to by $$DOC{ref: ".log"}, as well as $$DOC{ref: ".assert"} and its friends $$DOC{ref: ".fail"} and $$DOC{ref: ".ok"}.'},{model_:"StringArrayProperty",name:"tags",label:"Tags",documentation:"A list of tags for this test. Gives the environment(s) in which a test can be run. Currently in use: node, web."},{model_:"ArrayProperty",name:"tests",subType:"UnitTest",label:"Tests",view:"foam.ui.DAOListView",documentation:"An array of child tests. Will be run in order after the parent test."},{model_:"BooleanProperty",name:"runChildTests",documentation:"Whether the nested child tests should be run when this test is. Defaults to <tt>true</tt>, but some test runners set it to <tt>false</tt> so they can integrate with displaying the results.","transient":!0,defaultValue:!0}],actions:[{name:"test",documentation:'Synchronous helper to run the tests. Simply calls $$DOC{ref: ".atest"}.',action:function(obj){asynchronized(this.atest(),this.LOCK)(function(){})}}],constants:{LOCK:{}},methods:{atest:function(){var self=this;if(this.hasRun)return anop;this.hasRun=!0,this.Y=this.Y.sub({},this.name),this.Y.log=this.log.bind(this),this.Y.jlog=this.jlog.bind(this),this.Y.assert=this.assert.bind(this),this.Y.fail=this.fail.bind(this),this.Y.ok=this.ok.bind(this),this.Y.append=this.append.bind(this),this.Y.test=this,this.results="",this.passed=0,this.failed=0;var code;code=eval("("+this.code.toString()+")");var afuncs=[],oldLog;if(afuncs.push(function(ret){oldLog=console.log,console.log=self.log.bind(self.Y),ret()}),afuncs.push(this.async?code.bind(this.Y):code.abind(this.Y)),afuncs.push(function(ret){console.log=oldLog,ret()}),this.runChildTests){var query=this.X.childTestsFilter||TRUE,future=this.tests.dao.where(query).select([].sink);afuncs.push(function(ret){future(function(innerTests){var afuncsInner=[];innerTests.forEach(function(test){afuncsInner.push(function(ret){test.X=self.Y.sub(),test.atest()(ret)})}),afuncsInner.length?aseq.apply(this,afuncsInner)(ret):ret()})})}return afuncs.push(function(ret){self.hasRun=!0,self.X.onTestFailure&&self.hasFailed()&&self.X.onTestFailure(self),ret()}),aseq.apply(this,afuncs)},append:function(s){this.results+=s},log:function(){for(var i=0;i<arguments.length;i++)this.append(arguments[i]);this.append("\n")},jlog:function(){for(var i=0;i<arguments.length;i++)this.append(JSONUtil.stringify(arguments[i]));this.append("\n")},addHeader:function(name){this.log('<tr><th colspan=2 class="resultHeader">'+name+"</th></tr>")},assert:function(condition,comment){condition?this.passed++:this.failed++,this.log((comment?comment:"(no message)")+" "+(condition?"<font color=green>OK</font>":"<font color=red>ERROR</font>"))},fail:function(comment){this.assert(!1,comment)},ok:function(comment){this.assert(!0,comment)},hasFailed:function(){return this.failed>0}}}),CLASS({name:"RegressionTest",label:"Regression Test",documentation:'A $$DOC{ref: "UnitTest"} with a "gold master", which is compared with the output of the live test.',extendsModel:"UnitTest",properties:[{name:"master",documentation:'The "gold" version of the output. Compared with the $$DOC{ref: ".results"} using <tt>.equals()</tt>, and the test passes if they match.'},{name:"results",view:"foam.ui.RegressionTestResultView"},{model_:"BooleanProperty",name:"regression",hidden:!0,"transient":!0,defaultValue:!1,documentation:'Set after $$DOC{ref: ".atest"}: <tt>true</tt> if $$DOC{ref: ".master"} and $$DOC{ref: ".results"} match, <tt>false</tt> if they don\'t.'}],methods:{atest:function(){var sup=this.SUPER();return aseq(sup,function(ret){this.regression=this.hasRun&&!this.results.equals(this.master),ret()}.bind(this))},hasFailed:function(){return this.regression||this.hasRun&&!this.results.equals(this.master)}}}),CLASS({name:"UITest",label:"UI Test",extendsModel:"UnitTest",properties:[{name:"results",view:"foam.ui.UITestResultView"},{name:"runChildTests",help:"Don't run child tests by default for UITests; they need a view to be run properly.",defaultValue:!1}]}),CLASS({name:"Relationship",tableProperties:["name","label","relatedModel","relatedProperty"],documentation:function(){},properties:[{name:"name",type:"String",displayWidth:30,displayHeight:1,defaultValueFn:function(){return GLOBAL[this.relatedModel]?GLOBAL[this.relatedModel].plural:""},documentation:function(){},help:"The coding identifier for the relationship."},{name:"label",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.name.labelize()},documentation:function(){},help:"The display label for the relationship."},{name:"help",label:"Help Text",type:"String",displayWidth:70,displayHeight:6,defaultValue:"",documentation:function(){},help:"Help text associated with the relationship."},{model_:"DocumentationProperty",name:"documentation",documentation:function(){}},{name:"relatedModel",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",documentation:function(){},help:"The name of the related Model."},{name:"relatedProperty",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",documentation:function(){},help:"The join property of the related Model."}]}),CLASS({name:"Issue",plural:"Issues",help:"An issue describes a question, feature request, or defect.",ids:["id"],tableProperties:["id","severity","status","summary","assignedTo"],documentation:function(){},properties:[{model_:"IntProperty",name:"id",label:"Issue ID",displayWidth:12,documentation:function(){},help:"Issue's unique sequence number."},{name:"severity",view:{factory_:"foam.ui.ChoiceView",choices:["Feature","Minor","Major","Question"]},defaultValue:"String",documentation:function(){},help:"The severity of the issue."},{name:"status",type:"String",required:!0,view:{factory_:"foam.ui.ChoiceView",choices:["Open","Accepted","Complete","Closed"]},defaultValue:"String",documentation:function(){},help:"The status of the issue."},{model_:"Property",name:"summary",type:"String",required:!0,displayWidth:70,displayHeight:1,documentation:function(){},help:"A one line summary of the issue."},{model_:"Property",name:"created",type:"DateTime",required:!0,displayWidth:50,displayHeight:1,factory:function(){return new Date},documentation:function(){},help:"When this issue was created."},{model_:"Property",name:"createdBy",type:"String",defaultValue:"kgr",required:!0,displayWidth:30,displayHeight:1,documentation:function(){},help:"Who created the issue."},{model_:"Property",name:"assignedTo",type:"String",defaultValue:"kgr",displayWidth:30,displayHeight:1,documentation:function(){},help:"Who the issue is currently assigned to."},{model_:"Property",name:"notes",displayWidth:75,displayHeight:20,view:"foam.ui.TextAreaView",documentation:function(){},help:"Notes describing issue."}],tests:[{model_:"UnitTest",description:"test1",code:function(){this.addHeader("header"),this.ok("pass"),this.fail("fail")}}]}),function(){for(var i=0;i<Model.templates.length;i++)Model.templates[i]=JSONUtil.mapToObj(X,Model.templates[i]);Model.properties=Model.properties,delete Model.instance_.prototype_,Model=Model.create(Model)}();for(var id in USED_MODELS)recopyModelFeatures(GLOBAL.lookup(id));USED_MODELS.Model=!0,MODEL({"package":"foam.core.bootstrap",name:"ModelFileDAO",methods:{find:function(key,sink){var X=this.X,model=X.lookup(key);if(model)return void(sink&&sink.put&&sink.put(model));var sourcePath=window.FOAM_BOOT_DIR+"../js/"+key.replace(/\./g,"/")+".js",tag=X.document.createElement("script");tag.src=sourcePath,X.document.head.appendChild(tag),tag.onload=function(){var model=X.lookup(key);return model?void(sink&&sink.put&&sink.put(model)):(console.warn("Model load failed for: ",key),void(sink&&sink.error&&sink.error("Model load failed for: ",key)))}.bind(this.X.document.head)},select:function(sink){var sourcePath=window.FOAM_BOOT_DIR+"../js";this.scrapeDirectory(sourcePath,"",sink)},scrapeDirectory:function(dir,pkg,sink){var request=new XMLHttpRequest;request.open("GET",dir),request.addEventListener("readystatechange",function(e){if(4===request.readyState){var fre=/.*?(?:href=\")(.*?).js\".*?/gim;fre.sticky=!0;var files=[],fmatch;do(fmatch=fre.exec(request.response))&&files.push(fmatch[1]);while(fmatch);files.forEach(function(d){this.find(pkg?pkg+"."+d:d,sink)}.bind(this));var re=/.*?(?:href=\")(.*?)\/\".*?/gm;re.sticky=!0;var dirs=[],match;do(match=re.exec(request.response))&&dirs.push(match[1]);while(match);dirs.forEach(function(d){this.scrapeDirectory(dir+"/"+d,pkg?pkg+"."+d:d,sink)}.bind(this))}}.bind(this)),request.send()}}}),X.ModelDAO=X.foam.core.bootstrap.ModelFileDAO.create(),CLASS({"package":"foam.ui",name:"Window",exports:["$$","$","addStyle","animate","cancelAnimationFrame","clearInterval","clearTimeout","console","document","dynamic","error","info","log","lookup","memento","onRegisterModel","requestAnimationFrame","setInterval","setTimeout","warn","window"],properties:[{name:"registeredModels",factory:function(){return{}}},{model_:"StringProperty",name:"name",defaultValue:"window"},{name:"window",postSet:function(_,w){this.X.subDocument&&this.X.subDocument(w.document),w.X=this.Y,this.document=w.document}},{name:"document"},{name:"installedModels",lazyFactory:function(){return this.document.installedModels||(this.document.installedModels={})}},{model_:"BooleanProperty",name:"isBackground",defaultValue:!1},{name:"console",lazyFactory:function(){return this.window.console}},{name:"memento",lazyFactory:function(){this.window.WindowHashValue.create({window:this.window})}}],methods:{lookup:function(key){var ret=GLOBAL.lookup.call(this.Y,key);return ret&&!this.registeredModels[key]&&(this.registeredModels[key]=!0,this.onRegisterModel(ret)),ret},onRegisterModel:function(model){for(var Y=this.Y,document=this.document,m=model;m&&m.getPrototype;m=m.extendsModel&&this[m.extendsModel]){if(this.installedModels[m.id])return;
this.installedModels[m.id]=!0,arequireModel(m,this.Y)(function(m){m.getPrototype().installInDocument(Y,document)})}},addStyle:function(css){if(this.document&&this.document.createElement){var s=this.document.createElement("style");s.innerHTML=css,this.document.head.appendChild(s)}},log:function(){this.console.log.apply(this.console,arguments)},warn:function(){this.console.warn.apply(this.console,arguments)},info:function(){this.console.info.apply(this.console,arguments)},error:function(){this.console.error.apply(this.console,arguments)},$:function(id){return this.document.FOAM_OBJECTS&&this.document.FOAM_OBJECTS[id]?this.document.FOAM_OBJECTS[id]:this.document.getElementById(id)},$$:function(cls){return this.document.getElementsByClassName(cls)},dynamic:function(fn,opt_fn){Events.dynamic(fn,opt_fn,this.Y)},animate:function(duration,fn,opt_interp,opt_onEnd){return Movement.animate(duration,fn,opt_interp,opt_onEnd,this.Y)},setTimeout:function(f,t){return this.window.setTimeout.apply(this.window,arguments)},clearTimeout:function(id){this.window.clearTimeout(id)},setInterval:function(f,t){return this.window.setInterval.apply(this.window,arguments)},clearInterval:function(id){this.window.clearInterval(id)},requestAnimationFrame:function(f){return this.isBackground?this.setTimeout(f,16):(console.assert(this.window.requestAnimationFrame,"requestAnimationFrame not defined"),this.window.requestAnimationFrame(f))},cancelAnimationFrame:function(id){return this.isBackground?void this.clearTimeout(id):void(this.window.cancelAnimationFrame&&this.window.cancelAnimationFrame(id))}}}),function(){var w=foam.ui.Window.create({window:window,name:"DEFAULT WINDOW",isBackground:"object"==typeof process},X);FObject.X=X=w.Y}(),CLASS({name:"SimpleValue",properties:[{name:"value"}],methods:{init:function(value){this.value=value||""},get:function(){return this.value},set:function(val){this.value=val},toString:function(){return"SimpleValue("+this.value+")"}}}),CLASS({name:"SimpleReadOnlyValue",extendsModel:"SimpleValue",documentation:"A simple value that can only be set during initialization.",properties:[{name:"value",preSet:function(old,nu){return"undefined"==typeof this.instance_.value?nu:old}}],methods:{set:function(val){"undefined"==typeof this.instance_.value&&this.SUPER(val)},toString:function(){return"SimpleReadOnlyValue("+this.value+")"}}});var DOM={init:function(X){X.document.FOAM_OBJECTS||(X.document.FOAM_OBJECTS={});for(var fs=X.document.querySelectorAll("foam"),models=[],i=0;i<fs.length;i++){var e=fs[i];X.lookup(e.getAttribute("view")),X.lookup(e.getAttribute("model")),e.getAttribute("view")&&models.push(arequire(e.getAttribute("view"))),e.getAttribute("model")&&models.push(arequire(e.getAttribute("model")))}for(var key in USED_MODELS)models.push(arequire(key));atime("DOMInit",aseq(apar.apply(null,models),function(ret){for(var i=0;i<fs.length;i++){for(var e=fs[i],node=e,body=X.document.body;node&&node!==body;)node=node.parentNode;node&&(this.initElement(e,X,X.document),e.innerHTML=""),ret()}}.bind(this)))()},initElementChildren:function(e,X){for(var a=[],i=0;i<e.children.length;i++){var c=e.children[i];"FOAM"===c.tagName&&a.push(DOM.initElement(c,X))}return a},initElement:function(e,X,opt_document){arequire("foam.ui.FoamTagView")(function(t){foam.ui.FoamTagView.create({element:e},X)})},setClass:function(e,className,opt_enabled){var oldClassName=e.className||"",enabled=void 0===opt_enabled?!0:opt_enabled;e.className=oldClassName.replace(" "+className,"").replace(className,""),enabled&&(e.className=e.className+" "+className)}};window&&window.addEventListener&&window.addEventListener("load",function(){DOM.init(X)},!1);var DomValue={DEFAULT_EVENT:"change",DEFAULT_PROPERTY:"value",create:function(element,opt_event,opt_property){if(!element)throw"Missing Element in DomValue";return{__proto__:this,element:element,event:opt_event||this.DEFAULT_EVENT,property:opt_property||this.DEFAULT_PROPERTY}},setElement:function(element){this.element=element},get:function(){return this.element[this.property]},set:function(value){this.element[this.property]!==value&&(this.element[this.property]=value)},addListener:function(listener){if(this.event)try{this.element.addEventListener(this.event,listener,!1)}catch(x){}},removeListener:function(listener){if(this.event)try{this.element.removeEventListener(this.event,listener,!1)}catch(x){}},toString:function(){return"DomValue("+this.event+", "+this.property+")"}};CLASS({name:"DOMValue",properties:[{name:"element",required:!0},{name:"property",defaultValue:"value"},{name:"event",defaultValue:"change"},{name:"value",postSet:function(_,value){this.element[this.property]=value}},{name:"firstListener_",defaultValue:!0}],methods:{init:function(){this.SUPER(),this.value=this.element[this.property]},get:function(){return this.value},set:function(value){this.value=value},addListener:function(listener){this.firstListener_&&(this.event&&this.element.addEventListener(this.event,function(){},!1),this.firstListener_=!1),this.value$.addListener(listener)},removeListener:function(listener){this.value$.removeListener(listener)},toString:function(){return"DOMValue("+this.event+", "+this.property+")"}}}),CLASS({"package":"foam.ui",name:"FoamTagView",extendsModel:"foam.ui.View",requires:["foam.html.Element","foam.ui.View","foam.ui.DetailView"],imports:["document"],properties:[{name:"element"},{name:"className",defaultValue:"foam-tag"}],methods:{init:function(){this.SUPER(),this.Element.isInstance(this.element)||this.install()},install:function(){var e=this.element,models=[],style=e.getAttribute("style"),modelName=e.getAttribute("model"),viewName=e.getAttribute("view"),onInit=e.getAttribute("oninit");modelName&&models.push(arequire(modelName)),viewName&&models.push(arequire(viewName)),aseq(apar.apply(null,models),function(ret){var model=this.X.lookup(modelName);if(!model)return void this.error("Unknown Model: ",modelName);model.getPrototype();var obj=model.create(null,this.X);obj.fromElement(e);var view;if(viewName){var viewModel=this.X.lookup(viewName);view=viewModel.create({model:model,data:obj})}else if(this.X.lookup("foam.ui.BaseView").isInstance(obj))view=obj;else if(obj.toView_)view=obj.toView_();else{var a=this.element.getAttribute("showActions"),showActions=!a||a.equalsIC("y")||a.equalsIC("yes")||a.equalsIC("true")||a.equalsIC("t");view=this.X.lookup("foam.ui.DetailView").create({model:model,data:obj,showActions:showActions})}e.id&&(this.document.FOAM_OBJECTS[e.id]=obj),obj.view_=view,this.holder().outerHTML=view.toHTML(),style&&view.$.setAttribute("style",style),view.initHTML(),onInit&&aeval("function() { "+onInit+" }")(function(f){f.call(obj)})}.bind(this))()},holder:function(){return this.Element.isInstance(this.element)?this.$:this.element},error:function(msg){console.error(msg),this.holder.innerHTML=msg},initHTML:function(){this.install()}},templates:[function CSS(){}]}),CLASS({name:"Canvas",extendsModel:"foam.ui.View",properties:[{name:"background",label:"Background Color",type:"String",defaultValue:"white"},{name:"width",type:"int",defaultValue:100,postSet:function(_,width){this.$&&(this.$.width=width)}},{name:"height",type:"int",defaultValue:100,postSet:function(_,height){this.$&&(this.$.height=height)}}],listeners:[{name:"paint",isFramed:!0,code:function(){if(!this.$)throw EventService.UNSUBSCRIBE_EXCEPTION;this.erase(),this.paintChildren()}}],methods:{toHTML:function(){return'<canvas id="'+this.id+'" width="'+this.width+'" height="'+this.height+'"> </canvas>'},initHTML:function(){this.$&&(this.canvas=this.$.getContext("2d"))},addChild:function(child){child.parent=null,this.SUPER(child);try{child.addListener(this.paint)}catch(x){console.log(x)}return this},erase:function(){this.canvas.fillStyle=this.background,this.canvas.fillRect(0,0,this.width,this.height)},paintChildren:function(){for(var i=0;i<this.children.length;i++){var child=this.children[i];this.canvas.save(),child.paint(),this.canvas.restore()}}}}),CLASS({name:"CView",label:"CView",properties:[{name:"parent",type:"CView",hidden:!0},{name:"x",type:"int",view:"foam.ui.IntFieldView",defaultValue:10},{name:"y",type:"int",view:"foam.ui.IntFieldView",defaultValue:10},{name:"width",type:"int",view:"foam.ui.IntFieldView",defaultValue:10},{name:"height",type:"int",view:"foam.ui.IntFieldView",defaultValue:10},{name:"children",type:"CView[]",factory:function(){return[]},hidden:!0},{name:"background",label:"Background Color",type:"String",defaultValue:"white"},{name:"canvas",type:"Canvas",getter:function(){return this.parent&&this.parent.canvas},setter:void 0,hidden:!0}],listeners:[{name:"resizeParent",code:function(evt){this.parent.width=this.x+this.width+1,this.parent.height=this.y+this.height+2}}],methods:{toView_:function(){return this},toHTML:function(){return this.parent||(this.parent=this.X.Canvas.create(),this.x$.addListener(this.resizeParent),this.y$.addListener(this.resizeParent),this.width$.addListener(this.resizeParent),this.height$.addListener(this.resizeParent),this.resizeParent()),this.parent.toHTML()},initHTML:function(){var self=this,parent=this.parent;parent.addChild(this),parent.initHTML(),this.X.dynamic(function(){self.background},function(){parent.background=self.background})},write:function(document){document.writeln(this.toHTML()),this.initHTML()},addChild:function(child){return this.children.push(child),child.parent=this,this},removeChild:function(child){return this.children.deleteI(child),child.parent=void 0,this},erase:function(){this.canvas.fillStyle=this.background,this.canvas.fillRect(0,0,this.width,this.height)},paintChildren:function(){for(var i=0;i<this.children.length;i++){var child=this.children[i];this.canvas.save(),child.paint(),this.canvas.restore()}},paintSelf:function(){},paint:function(){this.parent.$&&(this.erase(),this.paintSelf(),this.paintChildren())}}}),CLASS({name:"Label",properties:[{name:"parent",type:"CView",hidden:!0},{name:"text",type:"String",defaultValue:""},{name:"align",label:"Alignment",type:"String",defaultValue:"start"},{name:"font",type:"String",defaultValue:""},{name:"color",type:"String",defaultValue:"black"},{name:"x",type:"int",defaultValue:100},{name:"y",type:"int",defaultValue:100},{name:"maxWidth",label:"Maximum Width",type:"int",defaultValue:-1}],methods:{paint:function(){var canvas=this.parent.canvas,oldFont=canvas.font,oldAlign=canvas.textAlign;this.font&&(canvas.font=this.font),canvas.textAlign=this.align,canvas.fillStyle=this.color,canvas.fillText(this.text,this.x,this.y),canvas.font=oldFont,canvas.textAlign=oldAlign}}}),CLASS({name:"Box",extendsModel:"Label",properties:[{name:"background",label:"Background Color",type:"String",defaultValue:"white"},{name:"border",label:"Border Color",type:"String",defaultValue:"black"},{name:"a",label:"Angle",type:"int",defaultValue:0},{name:"width",type:"int",defaultValue:100},{name:"height",type:"int",defaultValue:100}],methods:{paint:function(){var c=this.parent.canvas;c.save(),this.a&&(c.translate(this.x+this.width/2,this.y+this.height/2),c.rotate(this.a),c.translate(-this.x-this.width/2,-this.y-this.height/2)),c.fillStyle=this.background,c.fillRect(this.x,this.y,this.width,this.height),this.border&&this.width&&this.height&&(c.strokeStyle=this.border,c.strokeRect(this.x,this.y,this.width,this.height));var oldFont=c.font,oldAlign=c.textAlign;this.font&&(c.font=this.font),c.textAlign="center",c.fillStyle=this.color,c.fillText(this.text,this.x+this.width/2,this.y+this.height/2+10),c.font=oldFont,c.textAlign=oldAlign;var grad=c.createLinearGradient(this.x,this.y,this.x+this.width,this.y+this.height);grad.addColorStop(0,"rgba(0,0,0,0.35)"),grad.addColorStop(.5,"rgba(0,0,0,0)"),grad.addColorStop(1,"rgba(255,255,255,0.45)"),c.fillStyle=grad,c.fillRect(this.x,this.y,this.width,this.height),c.restore()}}}),CLASS({name:"Circle",properties:[{name:"parent",type:"CView",hidden:!0},{name:"color",type:"String",defaultValue:"white"},{name:"border",label:"Border Color",type:"String",defaultValue:void 0},{name:"borderWidth",type:"int",defaultValue:1},{name:"alpha",type:"int",defaultValue:1},{name:"x",type:"int",defaultValue:100},{name:"y",type:"int",defaultValue:100},{name:"r",label:"Radius",type:"int",defaultValue:20}],methods:{paint3d:function(){var canvas=this.parent.canvas,radgrad=canvas.createRadialGradient(this.x+this.r/6,this.y+this.r/6,this.r/3,this.x+2,this.y,this.r);radgrad.addColorStop(0,"#a7a7a7"),radgrad.addColorStop(.9,this.color),radgrad.addColorStop(1,"black"),canvas.fillStyle=radgrad,canvas.beginPath(),canvas.arc(this.x,this.y,this.r,0,2*Math.PI,!0),canvas.closePath(),canvas.fill()},paint:function(){var canvas=this.parent.canvas;canvas.save(),canvas.globalAlpha=this.alpha,canvas.fillStyle=this.color,this.border&&this.r&&(canvas.lineWidth=this.borderWidth,canvas.strokeStyle=this.border,canvas.beginPath(),canvas.arc(this.x,this.y,this.r,0,2*Math.PI,!0),canvas.closePath(),canvas.stroke()),this.color&&(canvas.beginPath(),canvas.arc(this.x,this.y,this.r,0,2*Math.PI,!0),canvas.closePath(),canvas.fill()),canvas.restore()}}}),CLASS({name:"ImageCView",properties:[{name:"parent",type:"CView",hidden:!0},{name:"alpha",type:"int",defaultValue:1},{name:"x",type:"int",defaultValue:100},{name:"y",type:"int",defaultValue:100},{name:"scale",type:"int",defaultValue:1},{name:"src",label:"Source",type:"String"}],methods:{init:function(){this.SUPER(),this.image_=new Image,this.image_.src=this.src},paint:function(){var c=this.parent.canvas;c.translate(this.x,this.y),c.scale(this.scale,this.scale),c.translate(-this.x,-this.y),c.drawImage(this.image_,this.x,this.y)}}}),CLASS({name:"Rectangle",properties:[{name:"parent",type:"CView",hidden:!0},{name:"color",type:"String",defaultValue:"white"},{name:"x",type:"int",defaultValue:1e3},{name:"y",type:"int",defaultValue:100},{name:"width",type:"int",defaultValue:100},{name:"height",type:"int",defaultValue:100}],methods:{paint:function(){var canvas=this.parent.canvas;canvas.fillStyle=this.color,canvas.fillRect(this.x,this.y,this.width,this.height)}}}),CLASS({name:"ProgressCView",extendsModel:"CView",properties:[{name:"value",type:"Value",factory:function(){return SimpleValue.create()},postSet:function(oldValue,newValue){oldValue&&oldValue.removeListener(this.updateValue),newValue.addListener(this.updateValue)}}],listeners:{updateValue:function(){this.paint()}},methods:{paint:function(){var c=this.canvas;c.fillStyle="#fff",c.fillRect(0,0,104,20),c.strokeStyle="#000",c.strokeRect(0,0,104,20),c.fillStyle="#f00",c.fillRect(2,2,parseInt(this.value.get()),16)},destroy:function(isParentDestroyed){this.SUPER(isParentDestroyed),this.value.removeListener(this.listener_)}}}),CLASS({name:"Graph",extendsModel:"CView",properties:[{name:"style",type:"String",defaultValue:"Line",view:{factory_:"foam.ui.ChoiceView",choices:["Bar","Line","Point"]}},{name:"width",type:"int",view:"foam.ui.IntFieldView",defaultValue:5},{name:"height",type:"int",view:"foam.ui.IntFieldView",defaultValue:5},{name:"graphColor",type:"String",defaultValue:"green"},{name:"backgroundColor",type:"String",defaultValue:void 0},{name:"lineWidth",type:"int",defaultValue:6},{name:"drawShadow",type:"boolean",defaultValue:!0},{name:"capColor",type:"String",defaultValue:""},{name:"axisColor",type:"String",defaultValue:"black"},{name:"gridColor",type:"String",defaultValue:void 0},{name:"axisSize",type:"int",defaultValue:2},{name:"xAxisInterval",type:"int",defaultValue:0},{name:"yAxisInterval",type:"int",defaultValue:0},{name:"maxValue",label:"Maximum Value",type:"float",defaultValue:-1},{name:"data",type:"Array[float]",factory:function(){return[]}},{name:"f",label:"Data Function",type:"Function",required:!1,displayWidth:70,displayHeight:3,view:"foam.ui.FunctionView",defaultValue:function(x){return x},help:"The graph's data function."}],issues:[{id:1e3,severity:"Major",status:"Open",summary:"Make 'style' view serializable",created:"Sun Dec 23 2012 18:14:56 GMT-0500 (EST)",createdBy:"kgr",assignedTo:"kgr",notes:"ChoiceView factory prevents Model from being serializable."}],methods:{paintLineData:function(canvas,x,y,xs,w,h,maxValue){if(this.graphColor){canvas.fillStyle=this.graphColor,canvas.beginPath(),canvas.moveTo(x+xs,y+h-xs);for(var i=0;i<this.data.length;i++){var d=this.f(this.data[i]),lx=x+xs+(0==i?0:w*i/(this.data.length-1)),ly=this.toY(d,maxValue);canvas.lineTo(lx,ly)}canvas.lineTo(x+this.width-1,y+h-xs),canvas.lineTo(x+xs,y+h-xs),canvas.fill()}if(this.capColor){this.drawShadow&&(canvas.shadowOffsetX=0,canvas.shadowOffsetY=2,canvas.shadowBlur=2,canvas.shadowColor="rgba(0, 0, 0, 0.5)"),canvas.strokeStyle=this.capColor,canvas.lineWidth=this.lineWidth,canvas.lineJoin="round",canvas.beginPath();for(var i=0;i<this.data.length;i++){var d=this.f(this.data[i]),lx=this.toX(i)+.5,ly=this.toY(d,maxValue)-5;0==i?canvas.moveTo(lx,ly):canvas.lineTo(lx,ly)}canvas.stroke()}},paintPointData:function(canvas,x,y,xs,w,h,maxValue){canvas.shadowOffsetX=2,canvas.shadowOffsetY=2,canvas.shadowBlur=2,canvas.shadowColor="rgba(0, 0, 0, 0.5)",canvas.strokeStyle=this.capColor,canvas.lineWidth=2,canvas.lineJoin="round",canvas.beginPath();for(var i=0;i<this.data.length;i++){var d=this.f(this.data[i]),lx=this.toX(i)+.5,ly=this.toY(d,maxValue)+.5;0==i?canvas.moveTo(lx,ly):canvas.lineTo(lx,ly)}canvas.stroke(),canvas.lineWidth=3;for(var i=0;i<this.data.length;i++){var d=this.f(this.data[i]),lx=this.toX(i)+.5,ly=this.toY(d,maxValue)+.5;canvas.beginPath(),canvas.arc(lx,ly,4,0,-Math.PI/2),canvas.closePath(),canvas.stroke()}},paintBarData:function(canvas,x,y,xs,w,h,maxValue){canvas.fillStyle=this.graphColor;for(var i=0;i<this.data.length;i++){var d=this.f(this.data[i]),x1=x+xs+w*i/this.data.length,y1=this.toY(d,maxValue);canvas.fillRect(x1,y1,w/this.data.length+1.5,d*h/maxValue)}},paint:function(){var canvas=this.canvas,x=this.x,y=this.y,xs=this.axisSize,w=this.width-xs,h=this.height-xs,maxValue=this.maxValue;if(this.backgroundColor&&(canvas.fillStyle=this.backgroundColor,canvas.fillRect(x,y,w,h)),-1==maxValue){maxValue=.001;for(var i=0;i<this.data.length;i++){var d=this.f(this.data[i]);maxValue=Math.max(maxValue,d)}}if("Line"==this.style?this.paintLineData(canvas,x,y,xs,w,h,maxValue):"Bar"==this.style?this.paintBarData(canvas,x,y,xs,w,h,maxValue):"Point"==this.style&&this.paintPointData(canvas,x,y,xs,w,h,maxValue),this.axisColor&&0!=xs&&(canvas.fillStyle=this.axisColor,canvas.fillRect(x,y+h-1.5*xs,this.width,xs),canvas.fillRect(x,y,xs,this.height-1.5*xs)),this.xAxisInterval)for(var i=this.xAxisInterval;i<=this.data.length;i+=this.xAxisInterval){var x2=this.toX(i);this.gridColor&&(canvas.save(),canvas.shadowOffsetX=0,canvas.shadowOffsetY=0,canvas.shadowBlur=0,canvas.fillStyle=this.gridColor,canvas.fillRect(x2+1.5,this.toY(0,1)-2*xs,.5,-this.height),canvas.restore()),canvas.fillRect(x2,this.toY(0,1)-2*xs,xs/2,-xs)}if(this.yAxisInterval)for(var i=this.yAxisInterval;maxValue>=i;i+=this.yAxisInterval){var y=this.toY(i,maxValue);this.gridColor&&(canvas.save(),canvas.shadowOffsetX=0,canvas.shadowOffsetY=0,canvas.shadowBlur=0,canvas.fillStyle=this.gridColor,canvas.fillRect(x+xs,y+3,this.width,.5),canvas.restore()),canvas.fillRect(x+xs,y,xs,xs/2)}},toX:function(val){var w=this.width-this.axisSize;return this.x+this.axisSize+(0==val?0:w*val/(this.data.length-1))},toY:function(val,maxValue){var h=this.height-this.axisSize;return this.y+h-val*h/maxValue+.5},lastValue:function(){return this.data[this.data.length-1]},addData:function(value,opt_maxNumValues){var maxNumValues=opt_maxNumValues||this.width;this.data.length==maxNumValues&&this.data.shift(),this.data.push(value)},watch:function(value,opt_maxNumValues){var graph=this;value.addListener(function(){graph.addData(value.get(),opt_maxNumValues)})}}});var WarpedCanvas={create:function(c,mx,my,w,h,mag){return{__proto__:c,warp:function(x,y){if(Math.abs(mag)<.01||1>mx&&1>my)return this.x=x,void(this.y=y);var dx=x-mx,dy=y-my,r=Math.sqrt(dx*dx+dy*dy),t=Math.atan2(dy,dx),R=400*(1+mag);r/=R,1>r&&(r+=3*mag*r*Math.pow(1-r,4)),r*=R,this.x=mx+Math.cos(t)*r,this.y=my+Math.sin(t)*r},moveTo:function(x,y){this.warp(x,y),c.moveTo(this.x,this.y),this.pX=x,this.pY=y},lineTo:function(x2,y2){for(var N=100,x1=this.pX,y1=this.pY,dx=(x2-x1)/N,dy=(y2-y1)/N,x=x1,y=y1,i=0;N>i;i++)x+=dx,y+=dy,this.warp(x,y),c.lineTo(this.x,this.y);this.pX=x2,this.pY=y2},line:function(x1,y1,x2,y2){c.beginPath(),this.moveTo(x1,y1),this.lineTo(x2,y2),c.stroke()},fillText:function(t,x,y){this.warp(x,y),c.fillText(t,this.x,this.y)},fillRect:function(x,y,width,height){c.beginPath(),this.moveTo(x,y),this.lineTo(x+width,y),this.lineTo(x+width,y+height),this.lineTo(x,y+height),this.lineTo(x,y),c.closePath(),c.fill()},get font(){return c.linewidth},set font(v){c.linewidth=v},get lineWidth(){return c.linewidth},set lineWidth(v){c.linewidth=v},get strokeStyle(){return c.strokeStyle},set strokeStyle(v){c.strokeStyle=v},get fillStyle(){return c.fillStyle},set fillStyle(v){c.fillStyle=v},get textAlign(){return c.textAlign},set textAlign(v){c.textAlign=v}}}};CLASS({name:"GridCView",extendsModel:"CView",label:"GridCView",requires:["foam.input.Mouse"],properties:[{name:"grid",type:"GridByExpr"},{name:"mag",help:"The current magnification level.  Animates to desiredMag.",defaultValue:.6},{name:"desiredMag",postSet:function(_,mag){this.mag=mag},defaultValue:.6},{name:"mouse",factory:function(){return this.Mouse.create()}}],listeners:[{name:"onMouseMove",code:function(evt){this.parent.paint()}}],methods:{initHTML:function(){var self=this;this.SUPER(),this.mouse.connect(this.parent.$),this.parent.$.addEventListener("mouseout",function(){this.animation_&&this.animation_(),this.animation_=Movement.animate(800,function(){self.mag=0},Movement.oscillate(.8,self.mag/4))()}),this.parent.$.addEventListener("mouseenter",function(){this.animation_&&this.animation_(),this.animation_=Movement.animate(400,function(){self.mag=self.desiredMag})()}),this.parent.$.onmousewheel=function(e){e.wheelDeltaY>0?this.desiredMag+=.05:this.desiredMag=Math.max(0,this.desiredMag-.05),this.parent.paint()}.bind(this),this.mouse.addListener(this.onMouseMove)},line:function(x1,y1,x2,y2){var c=this.canvas;c.beginPath(),c.moveTo(x1,y1),c.lineTo(x2,y2),c.closePath(),c.stroke()},paint:function(){function wdist(x1,y1,x2,y2){wc.warp(x2,y2);var dx=x1-wc.x,dy=y1-wc.y;return dx*dx+dy*dy}var ROW_LABEL_WIDTH=140,COL_LABEL_HEIGHT=30;this.width=this.parent.$.parentElement.clientWidth,this.height=this.parent.$.parentElement.clientHeight;var c=this.canvas,g=this.grid,cols=g.cols.groups,rows=g.rows.groups,sortedCols=g.sortedCols(),sortedRows=g.sortedRows(),w=this.width,h=this.height,wc=WarpedCanvas.create(c,this.mouse.x,this.mouse.y,w,h,this.mag),xw=(w-ROW_LABEL_WIDTH)/sortedCols.length,yw=(h-COL_LABEL_HEIGHT)/sortedRows.length;wc.fillStyle="#eee",wc.fillRect(0,0,this.width,COL_LABEL_HEIGHT),wc.fillRect(0,0,ROW_LABEL_WIDTH,this.height),wc.lineWidth=1,wc.strokeStyle="#000",wc.fillStyle="#000",wc.textAlign="left",wc.font="bold 10px arial";for(var i=0;i<sortedCols.length;i++){var x=ROW_LABEL_WIDTH+i*xw;wc.fillText(sortedCols[i],x+2,COL_LABEL_HEIGHT/2+2),wc.line(x,0,x,h)}wc.line(0,0,0,h),wc.line(w,0,w,h);for(var i=0;i<sortedRows.length;i++){var y=COL_LABEL_HEIGHT+i*yw;wc.fillText(sortedRows[i],5,y+yw/2),wc.line(0,y,w,y)}wc.line(0,0,w,0),wc.line(0,h,w,h);for(var j=0;j<sortedRows.length;j++)for(var y=sortedRows[j],i=0;i<sortedCols.length;i++){var x=sortedCols[i],value=rows[y].groups[x];if(value&&value.toCView){var cv=value.toCView(),cx=ROW_LABEL_WIDTH+xw*(i+.5),cy=COL_LABEL_HEIGHT+yw*(j+.5);wc.warp(cx,cy),cv.x=wc.x,cv.y=wc.y,cv.r=Math.sqrt(Math.min(wdist(cv.x,cv.y,cx+xw/2,cy),wdist(cv.x,cv.y,cx-xw/2,cy),wdist(cv.x,cv.y,cx,cy+yw/2),wdist(cv.x,cv.y,cx,cy-yw/2)))-4,cv.x-=cv.r,cv.y-=cv.r,cv.parent=this.parent,cv.r>3&&cv.paint()}}}}});var ListChoiceViewRenderer={start:function(id){return'<ul id="'+id+'"/>'},choice:function(name,c,autoId,index,isCurrentSelection){return'<li id="'+autoId+'" name="'+name+'"'+(isCurrentSelection?' class="'+this.selectedCssClass+'"':"")+' value="'+index+'">'+c.n.toString()+"</li>"},end:function(){return"</ul>"}};CLASS({name:"ListChoiceView",extendsModel:"foam.ui.View",properties:[{name:"name",type:"String",defaultValue:"field"},{name:"helpText",type:"String",defaultValue:void 0},{name:"cssClass",type:"String",defaultValue:"foamListChoiceView"},{name:"selectedCssClass",type:"String",defaultValue:"foamListChoiceViewSelected"},{name:"value",type:"Value",factory:function(){return SimpleValue.create("")}},{name:"choicesDao",type:"DAO",help:"A DAO providing choices to populate the list.",defaultValue:void 0,postSet:function(_,newValue){newValue.listen({put:EventService.merged(this.updateHTML.bind(this),500),remove:EventService.merged(this.updateHTML.bind(this),500)})}},{name:"displayNameProperty",type:"Property",help:"The property used to retrieve the display name from the DAO"},{name:"valueProperty",type:"Property",help:"The property used to retieve the value from the DAO"},{name:"renderableProperty",type:"Property",help:"The property used to query the DOA to see if the choice is renderable.",defaultValue:{f:function(){return!0}}},{name:"choices",type:"Array[StringField]",help:"Array of choices or array of { n: name, v: value } pairs.",defaultValue:[],postSet:function(){}},{name:"initialSelectionValue",type:"Value",factory:function(){return SimpleValue.create()}},{name:"renderer",help:"The renderer that renders the view.",defaultValue:ListChoiceViewRenderer}],methods:{toHTML:function(){var renderer=this.renderer,out=renderer.start(this.id)+renderer.end();return out},updateHTML:function(){var self=this;if(this.choicesDao){var choices=[];this.choicesDao.select({put:function(c){self.renderableProperty.f(c)&&(c={n:self.displayNameProperty.f(c),v:self.valueProperty.f(c),o:c},choices.push(c))}})(function(){var oldChoices=self.choices;oldChoices!=choices&&(self.choices=choices,self.listToHTML())})}else self.listToHTML()},listToHTML:function(){var out=[];this.helpText;for(var i=0;i<this.choices.length;i++){var choice=this.choices[i],id=this.nextID(),name=this.name;try{this.on("click",this.onClick,id),this.on("mouseover",this.onMouseOver,id),this.on("mouseout",this.onMouseOut,id)}catch(x){}var isCurrentSelection=this.prev?choice.v==this.prev.get():this.value?choice.v==this.value.get():choice.v==this.initialSelectedValue.get();out.push(this.renderer.choice(name,choice,id,i,isCurrentSelection))}this.$.innerHTML=out.join(""),selectedAsList=this.$.getElementsByClassName(this.selectedCssClass),selectedAsList&&selectedAsList.length&&(this.selectedElement=selectedAsList[0]),View.getPrototype().initHTML.call(this)},getValue:function(){return this.value},setValue:function(value){this.value=value},initHTML:function(){var e=this.$;Events.dynamic(function(){this.choices}.bind(this),this.listToHTML.bind(this)),this.updateHTML(),this.setValue(this.value)},indexToValue:function(v){var i=parseInt(v);return isNaN(i)?v:this.choices[i].v},evtToValue:function(e){for(var labelView=e.target;labelView.parentNode!=this.$;)labelView=labelView.parentNode;return this.indexToValue(labelView.getAttribute("value"))}},listeners:[{name:"onMouseOver",code:function(e){this.timer_&&window.clearTimeout(this.timer_),this.prev=void 0===this.prev?this.value.get():this.prev,this.value.set(this.evtToValue(e))}},{name:"onMouseOut",code:function(e){this.timer_&&window.clearTimeout(this.timer_),this.timer_=window.setTimeout(function(){this.value.set(this.prev||""),this.prev=void 0}.bind(this),1)}},{name:"onClick",code:function(e){this.prev=this.evtToValue(e),this.value.set(this.prev),this.selectedElement&&(this.selectedElement.className=""),e.target.className="selected",this.selectedElement=e.target}}]}),CLASS({name:"ScrollCView",extendsModel:"CView",properties:[{name:"parent",type:"CView",hidden:!0,postSet:function(oldValue,newValue){var e=newValue&&newValue.$;e&&(e.addEventListener("mousedown",this.mouseDown,!1),e.addEventListener("touchstart",this.touchStart,!1))}},{name:"vertical",type:"boolean",defaultValue:!0},{name:"value",type:"int",help:"The first element being shown, starting at zero.",preSet:function(_,value){return Math.max(0,Math.min(this.size-this.extent,value))},defaultValue:0},{name:"extent",help:"Number of elements shown.",type:"int",minValue:1,defaultValue:10},{name:"size",type:"int",defaultValue:0,help:"Total number of elements being scrolled through.",postSet:function(){this.paint()}},{name:"minHandleSize",type:"int",defaultValue:10,help:"Minimum size to make the drag handle."},{name:"startY",type:"int",defaultValue:0},{name:"startValue",help:"Starting value or current drag operation.",type:"int",defaultValue:0},{name:"handleColor",type:"String",defaultValue:"rgb(107,136,173)"},{name:"borderColor",type:"String",defaultValue:"#555"}],listeners:{mouseDown:function(e){this.startY=e.y-e.offsetY,e.target.ownerDocument.defaultView.addEventListener("mouseup",this.mouseUp,!0),e.target.ownerDocument.defaultView.addEventListener("mousemove",this.mouseMove,!0),e.target.ownerDocument.defaultView.addEventListener("touchstart",this.touchstart,!0),this.mouseMove(e)},mouseUp:function(e){e.preventDefault(),e.target.ownerDocument.defaultView.removeEventListener("mousemove",this.mouseMove,!0),e.target.ownerDocument.defaultView.removeEventListener("mouseup",this.mouseUp,!0)},mouseMove:function(e){var y=e.y-this.startY;e.preventDefault(),this.value=Math.max(0,Math.min(this.size-this.extent,Math.round((y-this.y)/(this.height-4)*this.size)))},touchStart:function(e){this.startY=e.targetTouches[0].pageY,this.startValue=this.value,e.target.ownerDocument.defaultView.addEventListener("touchmove",this.touchMove,!1),this.touchMove(e)},touchEnd:function(e){e.target.ownerDocument.defaultView.removeEventListener("touchmove",this.touchMove,!1),e.target.ownerDocument.defaultView.removeEventListener("touchend",this.touchEnd,!1)},touchMove:function(e){var y=e.targetTouches[0].pageY;e.preventDefault(),this.value=Math.max(0,Math.min(this.size-this.extent,Math.round(this.startValue+(y-this.startY)/(this.height-4)*this.size)))}},methods:{paint:function(){if(this.size){var c=this.canvas;if(c&&(this.erase(),!(this.extent>=this.size))){c.strokeStyle=this.borderColor,c.strokeRect(this.x,this.y,this.width-7,this.height),c.fillStyle=this.handleColor;var h=this.height-8,handleSize=this.extent/this.size*h;handleSize<this.minHandleSize&&(handleSize=this.minHandleSize,h-=this.minHandleSize-handleSize),c.fillRect(this.x+2,this.y+2+this.value/this.size*h,this.width-11,this.y+4+handleSize)}}}}}),CLASS({name:"ScrollBorder",extendsModel:"foam.ui.View",properties:[{name:"view",type:"view",postSet:function(_,view){this.scrollbar.extent=this.view.rows}},{name:"scrollbar",type:"ScrollCView",factory:function(){var sb=ScrollCView.create({height:1800,width:20,x:0,y:0,extent:10});return this.dao&&this.dao.select(COUNT())(function(c){sb.size=c.count}),sb}},{name:"dao",label:"DAO",type:"DAO",hidden:!0,required:!0,postSet:function(oldValue,newValue){this.view.dao=newValue;var self=this;this.dao&&this.dao.select(COUNT())(function(c){self.scrollbar.size=c.count,self.scrollbar.value=Math.max(0,Math.min(self.scrollbar.value,self.scrollbar.size-self.scrollbar.extent)),self.dao&&(self.view.dao=self.dao.skip(self.scrollbar.value))})}}],listeners:[{name:"layout",code:function(){this.view.layout()}}],methods:{toHTML:function(){return'<table id="'+this.id+'" width=100% height=100% border=0><tr><td valign=top>'+this.view.toHTML()+'</td><td valign=top><div class="scrollSpacer"></div>'+this.scrollbar.toHTML()+"</td></tr></table>"},initHTML:function(){window.addEventListener("resize",this.layout,!1),this.view.initHTML(),this.scrollbar.initHTML(),this.scrollbar.paint();var view=this.view,scrollbar=this.scrollbar,self=this;view.$.onmousewheel=function(e){e.wheelDeltaY>0&&scrollbar.value?scrollbar.value--:e.wheelDeltaY<0&&scrollbar.value<scrollbar.size-scrollbar.extent&&scrollbar.value++},scrollbar.addPropertyListener("value",EventService.framed(function(){self.dao&&(self.view.dao=self.dao.skip(scrollbar.value))})),Events.dynamic(function(){view.rows},function(){scrollbar.extent=view.rows
}),Events.dynamic(function(){view.height},function(){scrollbar.height=Math.max(view.height-26,0)}),this.layout()}}}),CLASS({"package":"foam.html",name:"Element",constants:{OPTIONAL_CLOSE_TAGS:{HTML:!0,HEAD:!0,BODY:!0,P:!0,DT:!0,DD:!0,LI:!0,OPTION:!0,THEAD:!0,TH:!0,TBODY:!0,TR:!0,TD:!0,TFOOT:!0,COLGROUP:!0},ILLEGAL_CLOSE_TAGS:{IMG:!0,INPUT:!0,BR:!0,HR:!0,FRAME:!0,AREA:!0,BASE:!0,BASEFONT:!0,COL:!0,ISINDEX:!0,LINK:!0,META:!0,PARAM:!0}},properties:[{name:"id"},{name:"nodeName"},{name:"attributeMap_","transient":!0,factory:function(){return{}}},{name:"attributes",factory:function(){return[]},postSet:function(_,attrs){for(var i=0;i<attrs.length;i++)this.attributeMap_[attrs[i].name]=attrs[i]}},{name:"childNodes",factory:function(){return[]}},{name:"children","transient":!0,getter:function(){return this.childNodes.filter(function(c){return"string"!=typeof c})}},{name:"outerHTML","transient":!0,getter:function(){var out="<"+this.nodeName;this.id&&(out+=' id="'+this.id+'"');for(key in this.attributeMap_){var value=this.attributeMap_[key].value;out+=void 0==value?" "+key:" "+key+'="'+this.attributeMap_[key].value+'"'}return this.ILLEGAL_CLOSE_TAGS[this.nodeName]||this.OPTIONAL_CLOSE_TAGS[this.nodeName]&&!this.childNodes.length||(out+=">",out+=this.innerHTML,out+="</"+this.nodeName),out+=">"}},{name:"innerHTML","transient":!0,getter:function(){for(var out="",i=0;i<this.childNodes.length;i++)out+=this.childNodes[i].toString();return out}}],methods:{setAttribute:function(name,value){var attr=this.getAttributeNode(name);attr?attr.value=value:(attr={name:name,value:value},this.attributes.push(attr),this.attributeMap_[name]=attr)},getAttributeNode:function(name){return this.attributeMap_[name]},getAttribute:function(name){var attr=this.getAttributeNode(name);return attr&&attr.value},appendChild:function(c){this.childNodes.push(c)},removeChild:function(c){for(var i=0;i<this.childNodes.length;++i)if(this.childNodes[i]===c){this.childNodes.splice(i,1);break}},toString:function(){return this.outerHTML}}});var HTMLParser={__proto__:grammar,create:function(){return{__proto__:this,stack:[X.foam.html.Element.create({nodeName:"html"})]}},peek:function(){return this.stack[this.stack.length-1]},START:sym("html"),html:repeat0(sym("htmlPart")),htmlPart:simpleAlt(sym("comment"),sym("text"),sym("endTag"),sym("startTag")),tag:seq(sym("startTag"),repeat(seq1(1,sym("matchingHTML"),sym("htmlPart")))),matchingHTML:function(ps){return this.stack.length>1?ps:null},startTag:seq("<",sym("tagName"),sym("whitespace"),sym("attributes"),sym("whitespace"),optional("/"),">"),endTag:function(){var endTag_=sym("endTag_");return function(ps){return this.stack.length>1?this.parse(endTag_,ps):void 0}}(),endTag_:seq1(1,"</",sym("tagName"),">"),comment:seq("<!--",repeat0(not("-->",anyChar)),"-->"),attributes:repeat(sym("attribute"),sym("whitespace")),label:str(plus(notChars(" =/	\r\n<>'\""))),tagName:sym("label"),text:str(plus(alt("<%",notChar("<")))),attribute:seq(sym("label"),optional(seq1(1,"=",sym("value")))),value:str(alt(plus(alt(range("a","z"),range("A","Z"),range("0","9"))),seq1(1,'"',repeat(notChar('"')),'"'))),whitespace:repeat0(alt(" ","	","\r","\n"))}.addActions({START:function(xs){var ret=this.stack[0];return this.stack=[X.foam.html.Element.create({nodeName:"html"})],ret},tag:function(xs){var ret=this.stack[0];return this.stack=[X.foam.html.Element.create({nodeName:"html"})],ret.childNodes[0]},attribute:function(xs){return{name:xs[0],value:xs[1]}},text:function(xs){this.peek()&&this.peek().appendChild(xs)},startTag:function(xs){var tag=xs[1],obj=X.foam.html.Element.create({nodeName:tag,attributes:xs[3]});return this.peek()&&this.peek().appendChild(obj),"/"!=xs[5]&&this.stack.push(obj),obj},endTag:function(tag){for(var stack=this.stack;stack.length>1;){if(this.peek().nodeName===tag)return void stack.pop();var top=stack.pop();this.peek().childNodes=this.peek().childNodes.concat(top.childNodes),top.childNodes=[]}}});!function(){var registry={};X.registerElement=function(name,model){registry[name]=model,TemplateParser.foamTag_=function(){var start=seq("<",simpleAlt.apply(null,Object.keys(registry).sort(function(o1,o2){return o2.compareTo(o1)}).map(function(k){return literal_ic(k)})),alt("/"," ",">")),html=HTMLParser.create()["export"]("tag");return function(ps){var res=this.parse(start,ps)&&this.parse(html,ps);if(!res)return null;var elem=res.value,model=registry[elem.nodeName];return model&&elem.setAttribute("model",model),res.setValue(elem)}}(),invalidateParsers()},X.elementModel=function(name){return registry[name]}}(),X.registerElement("foam",null),CLASS({name:"Expr",documentation:"Parent model for all mLang expressions. Contains default implementations for many methods.",methods:{toMQL:function(){return this.label_},toSQL:function(){return this.label_},toBQL:function(){return this.label_},toString:function(){return this.toMQL()},collectInputs:function(terms){terms.push(this)},partialEval:function(){return this},minterm:function(index,term){return!!(term>>>index[0]--&1)},normalize:function(){return this;var inputs,minterms,i,terms,subterms,j,ret},pipe:function(sink){var expr=this;return{__proto__:sink,put:function(obj){expr.f(obj)&&sink.put(obj)},remove:function(obj){expr.f(obj)&&sink.remove(obj)}}}}});var TRUE=FOAM({model_:"Model",name:"TRUE",extendsModel:"Expr",documentation:"Model for the primitive true value.",methods:{toString:function(){return"<true>"},toSQL:function(){return"( 1 = 1 )"},toMQL:function(){return""},toBQL:function(){return""},f:function(){return!0}}}).create(),FALSE=FOAM({model_:"Model",name:"FALSE",extendsModel:"Expr",documentation:"Model for the primitive false value.",methods:{toSQL:function(out){return"( 1 <> 1 )"},toMQL:function(out){return"<false>"},toBQL:function(out){return"<false>"},f:function(){return!1}}}).create(),IDENTITY=FOAM({model_:"Model",name:"IDENTITY",extendsModel:"Expr",documentation:"The identity expression, which passes through its input unchanged.",methods:{f:function(obj){return obj},toString:function(){return"IDENTITY"}}}).create();CLASS({name:"NARY",extendsModel:"Expr","abstract":!0,documentation:"Parent model for expressions which take an arbitrary number of arguments.",properties:[{name:"args",label:"Arguments",type:"Expr[]",help:"Sub-expressions",documentation:"An array of subexpressions which are the arguments to this n-ary expression.",factory:function(){return[]}}],methods:{toString:function(){for(var s=this.name_+"(",i=0;i<this.args.length;i++){var a=this.args[i];s+=a.toString(),i<this.args.length-1&&(s+=", ")}return s+")"},toSQL:function(){var s;s=this.model_.label,s+="(";for(var i=0;i<this.args.length;i++){var a=this.args[i];s+=a.toSQL(),i<this.args.length-1&&out.push(",")}return s+=")"},toMQL:function(){var s;s=this.model_.label,s+="(";for(var i=0;i<this.args.length;i++){var a=this.args[i];s+=a.toMQL(),i<this.args.length-1&&out.push(",")}return s+=")",str},toBQL:function(){var s;s=this.model_.label,s+="(";for(var i=0;i<this.args.length;i++){var a=this.args[i];s+=a.toBQL(),i<this.args.length-1&&out.push(",")}return s+=")",str}}}),CLASS({name:"UNARY",extendsModel:"Expr","abstract":!0,documentation:"Parent model for one-argument expressions.",properties:[{name:"arg1",label:"Argument",type:"Expr",help:"Sub-expression",documentation:"The first argument to the expression.",defaultValue:TRUE}],methods:{toSQL:function(){return this.label_+"("+this.arg1.toSQL()+")"},toMQL:function(){return this.label_+"("+this.arg1.toMQL()+")"},toBQL:function(){return this.label_+"("+this.arg1.toBQL()+")"}}}),CLASS({name:"BINARY",extendsModel:"UNARY","abstract":!0,documentation:'Parent model for two-argument expressions. Extends $$DOC{ref: "UNARY"} to include $$DOC{ref: ".arg2"}.',properties:[{name:"arg2",label:"Argument",type:"Expr",help:"Sub-expression",documentation:"Second argument to the expression.",defaultValue:TRUE}],methods:{toSQL:function(){return this.arg1.toSQL()+" "+this.label_+" "+this.arg2.toSQL()},toMQL:function(){return this.arg1.toMQL()+" "+this.label_+" "+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+" "+this.label_+" "+this.arg2.toBQL()}}}),CLASS({name:"MaxExpr",extendsModel:"UNARY",properties:[{name:"max",type:"int",help:"Maximum value.",defaultValue:void 0}],methods:{maximum:function(o1,o2){return o1.compareTo(o2)>0?o1:o2},reduce:function(other){return MaxExpr.create({max:this.maximum(this.max,other.max)})},reduceI:function(other){this.max=this.maximum(this.max,other.max)},pipe:function(sink){sink.put(this)},put:function(obj){var v=this.arg1.f(obj);this.max=void 0===this.max?v:this.maximum(this.max,v)},remove:function(obj){},toString:function(){return this.max}}}),CLASS({name:"ExplainExpr",extendsModel:"UNARY",documentation:"Pseudo-expression which outputs a human-readable description of its subexpression, and the plan for evaluating it.",properties:[{name:"plan",help:"Execution Plan",defaultValue:""}],methods:{toString:function(){return this.plan},toSQL:function(){return this.arg1.toSQL()},toMQL:function(){return this.arg1.toMQL()},toBQL:function(){return this.arg1.toBQL()},partialEval:function(){var newArg=this.arg1.partialEval();return this.arg1===newArg?this:EXPLAIN(newArg)},f:function(obj){return this.arg1.f(obj)}}}),CLASS({name:"CountExpr",extendsModel:"Expr",properties:[{name:"count",type:"int",defaultValue:0}],methods:{reduce:function(other){return CountExpr.create({count:this.count+other.count})},reduceI:function(other){this.count=this.count+other.count},pipe:function(sink){sink.put(this)},put:function(obj){this.count++},remove:function(obj){this.count--},toString:function(){return this.count}}}),CLASS({name:"InExpr",extendsModel:"BINARY",documentation:"Binary expression which is true if its first argument is EQ to any element of its second argument, which is an array.",properties:[{name:"arg2",label:"Argument",type:"Expr",help:"Sub-expression",postSet:function(){this.valueSet_=void 0}}],methods:{partialEval:function(){return 1==this.arg2.length?EQ(this.arg1,this.arg2[0]):this},valueSet:function(){if(!this.valueSet_){for(var s={},i=0;i<this.arg2.length;i++)s[this.arg2[i]]=!0;this.valueSet_=s}return this.valueSet_},toSQL:function(){return this.arg1.toSQL()+" IN "+this.arg2},toMQL:function(){return this.arg1.toMQL()+"="+this.arg2.join(",")},toBQL:function(){return this.arg1.toBQL()+":("+this.arg2.join("|")+")"},f:function(obj){return this.valueSet().hasOwnProperty(this.arg1.f(obj))}}}),CLASS({name:"EqExpr",extendsModel:"BINARY","abstract":!0,documentation:function(){},methods:{toSQL:function(){return this.arg1.toSQL()+"="+this.arg2.toSQL()},toMQL:function(){return this.arg1.toMQL&&this.arg2.toMQL?this.arg2===TRUE?"is:"+this.arg1.toMQL():""==this.arg2.f()?"-has:"+this.arg1.toMQL():this.arg1.toMQL()+"="+this.arg2.toMQL():""},toBQL:function(){return this.arg1.toBQL&&this.arg2.toBQL?this.arg2===TRUE?this.arg1.toBQL()+":true":this.arg1.toBQL()+":"+this.arg2.toBQL():""},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval();return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(newArg1.f()==newArg2.f()):this.arg1!==newArg1||this.arg2!==newArg2?EqExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){var arg1=this.arg1.f(obj),arg2=this.arg2.f(obj);return Array.isArray(arg1)?arg1.some(function(arg){return arg==arg2}):arg2===TRUE?!!arg1:arg2===FALSE?!arg1:arg1==arg2}}}),CLASS({name:"LtExpr",extendsModel:"BINARY","abstract":!0,methods:{toSQL:function(){return this.arg1.toSQL()+"<"+this.arg2.toSQL()},toMQL:function(){return this.arg1.toMQL()+"-before:"+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+"<"+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval();return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(newArg1.f()<newArg2.f()):this.arg1!==newArg1||this.arg2!=newArg2?LtExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){return this.arg1.f(obj)<this.arg2.f(obj)}}}),CLASS({name:"GtExpr",extendsModel:"BINARY","abstract":!0,methods:{toSQL:function(){return this.arg1.toSQL()+">"+this.arg2.toSQL()},toMQL:function(){return this.arg1.toMQL()+"-after:"+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+">"+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval();return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(newArg1.f()>newArg2.f()):this.arg1!==newArg1||this.arg2!=newArg2?GtExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){return this.arg1.f(obj)>this.arg2.f(obj)}}}),CLASS({name:"LteExpr",extendsModel:"BINARY","abstract":!0,methods:{toSQL:function(){return this.arg1.toSQL()+"<="+this.arg2.toSQL()},toMQL:function(){return this.arg1.toMQL()+"-before:"+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+"<="+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval();return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(newArg1.f()<=newArg2.f()):this.arg1!==newArg1||this.arg2!=newArg2?LtExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){return this.arg1.f(obj)<=this.arg2.f(obj)}}}),CLASS({name:"GteExpr",extendsModel:"BINARY","abstract":!0,methods:{toSQL:function(){return this.arg1.toSQL()+">="+this.arg2.toSQL()},toMQL:function(){return this.arg1.toMQL()+"-after:"+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+">="+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval();return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(newArg1.f()>=newArg2.f()):this.arg1!==newArg1||this.arg2!=newArg2?GtExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){return this.arg1.f(obj)>=this.arg2.f(obj)}}}),CLASS({name:"ConstantExpr",extendsModel:"UNARY",methods:{escapeSQLString:function(str){return"'"+str.replace(/\\/g,"\\\\").replace(/'/g,"\\'")+"'"},escapeMQLString:function(str){return str.length>0&&-1==str.indexOf(" ")&&-1==str.indexOf('"')&&-1==str.indexOf(",")?str:'"'+str.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'},toSQL:function(){return"string"==typeof this.arg1?this.escapeSQLString(this.arg1):this.arg1.toString()},toMQL:function(){return"string"==typeof this.arg1?this.escapeMQLString(this.arg1):this.arg1.toMQL?this.arg1.toMQL():this.arg1.toString()},toBQL:function(){return"string"==typeof this.arg1?this.escapeMQLString(this.arg1):this.arg1.toBQL?this.arg1.toBQL():this.arg1.toString()},f:function(obj){return this.arg1}}}),CLASS({name:"AndExpr",extendsModel:"NARY","abstract":!0,documentation:"N-ary expression which is true only if each of its 0 or more arguments is true. AND() === TRUE",methods:{toSQL:function(){for(var s="",i=0;i<this.args.length;i++){var a=this.args[i];s+=a.toSQL(),i<this.args.length-1&&(s+=" AND ")}return s},toMQL:function(){for(var s="",i=0;i<this.args.length;i++){var a=this.args[i],sub=a.toMQL();OrExpr.isInstance(a)&&(sub="("+sub+")"),s+=sub,i<this.args.length-1&&(s+=" ")}return s},toBQL:function(){for(var s="",i=0;i<this.args.length;i++){var a=this.args[i],sub=a.toBQL();OrExpr.isInstance(a)&&(sub="("+sub+")"),s+=sub,i<this.args.length-1&&(s+=" ")}return s},collectInputs:function(terms){for(var i=0;i<this.args.length;i++)this.args[i].collectInputs(terms)},minterm:function(index,term){for(var out=!0,i=0;i<this.args.length;i++)out=this.args[i].minterm(index,term)&&out;return out}},constants:{PARTIAL_AND_RULES:[["EqExpr","EqExpr",function(e1,e2){return e1.arg1.exclusive?e1.arg2.f()==e2.arg2.f()?e1:FALSE:e1.arg2.f()==e2.arg2.f()?e1:null}],["InExpr","InExpr",function(e1,e2){var i=e1.arg1.exclusive?e1.arg2.intersection(e2.arg2):e1.arg2.union(e2.arg2);return i.length?IN(e1.arg1,i):FALSE}],["InExpr","ContainedInICExpr",function(e1,e2){if(!e1.arg1.exclusive)return null;var i=e1.arg2.filter(function(o){return o=o.toUpperCase(),e2.arg2.some(function(o2){return-1!=o.indexOf(o2)})});return i.length?IN(e1.arg1,i):FALSE}],["ContainedInICExpr","ContainedInICExpr",function(e1,e2){console.assert(!1,"AND.partialEval: ContainedInICExpr has no partialEval rule")}],["InExpr","ContainsICExpr",function(e1,e2){if(e1.arg1.exclusive)var i=e1.arg2.filter(function(o){return-1!==o.indexOfIC(e2.arg2.f())})}],["InExpr","ContainsExpr",function(e1,e2){if(e1.arg1.exclusive){var i=e1.arg2.filter(function(o){return-1!==o.indexOf(e2.arg2.f())});return i.length?IN(e1.arg1,i):FALSE}}],["EqExpr","InExpr",function(e1,e2){return e1.arg1.exclusive?-1===e2.arg2.indexOf(e1.arg2.f())?FALSE:e1:void 0}]],partialAnd:function(e1,e2){if(OrExpr.isInstance(e2)){var tmp=e1;e1=e2,e2=tmp}if(OrExpr.isInstance(e1)){for(var args=[],i=0;i<e1.args.length;i++)args.push(AND(e2,e1.args[i]));return OrExpr.create({args:args}).partialEval()}if(!BINARY.isInstance(e1))return null;if(!BINARY.isInstance(e2))return null;if(e1.arg1!=e2.arg1)return null;for(var RULES=this.PARTIAL_AND_RULES,i=0;i<RULES.length;i++){if(e1.model_.name==RULES[i][0]&&e2.model_.name==RULES[i][1])return RULES[i][2](e1,e2);if(e2.model_.name==RULES[i][0]&&e1.model_.name==RULES[i][1])return RULES[i][2](e2,e1)}return DEBUG&&console.log("Unknown partialAnd combination: ",e1.name_,e2.name_),null},partialEval:function(){for(var newArgs=[],updated=!1,i=0;i<this.args.length;i++){var a=this.args[i],newA=this.args[i].partialEval();if(newA===FALSE)return FALSE;if(AndExpr.isInstance(newA)){for(var j=0;j<newA.args.length;j++)newArgs.push(newA.args[j]);updated=!0}else newA===TRUE?updated=!0:(newArgs.push(newA),a!==newA&&(updated=!0))}for(var i=0;i<newArgs.length-1;i++)for(var j=i+1;j<newArgs.length;j++){var a=this.partialAnd(newArgs[i],newArgs[j]);if(a){if(console.log("***************** ",newArgs[i].toMQL()," <PartialAnd> ",newArgs[j].toMQL()," -> ",a.toMQL()),a===FALSE)return FALSE;newArgs[i]=a,newArgs.splice(j,1)}}return 0==newArgs.length?TRUE:1==newArgs.length?newArgs[0]:updated?AndExpr.create({args:newArgs}):this},f:function(obj){return this.args.every(function(arg){return arg.f(obj)})}}}),CLASS({name:"OrExpr",extendsModel:"NARY",documentation:"N-ary expression which is true if any one of its 0 or more subexpressions is true. OR() === FALSE",methods:{toSQL:function(){var s;s="(";for(var i=0;i<this.args.length;i++){var a=this.args[i];s+=a.toSQL(),i<this.args.length-1&&(s+=" OR ")}return s+=")"},toMQL:function(){for(var s="",i=0;i<this.args.length;i++){var a=this.args[i];s+=a.toMQL(),i<this.args.length-1&&(s+=" OR ")}return s},toBQL:function(){for(var s="",i=0;i<this.args.length;i++){var a=this.args[i];s+=a.toBQL(),i<this.args.length-1&&(s+=" | ")}return s},collectInputs:function(terms){for(var i=0;i<this.args.length;i++)this.args[i].collectInputs(terms)},minterm:function(index,term){for(var out=!1,i=0;i<this.args.length;i++)out=this.args[i].minterm(index,term)||out;return out}},constants:{PARTIAL_OR_RULES:[["InExpr","EqExpr",function(e1,e2){return IN(e1.arg1,e1.arg1.union([e2.arg2.f()]))}],["InExpr","InExpr",function(e1,e2){var i=e1.arg2.filter(function(o){return-1!==e2.arg2.indexOf(o)});return IN(e1.arg1,e1.arg2.union(e2.arg2))}]],partialOr:function(e1,e2){if(!BINARY.isInstance(e1))return null;if(!BINARY.isInstance(e2))return null;if(e1.arg1!=e2.arg1)return null;for(var RULES=this.PARTIAL_OR_RULES,i=0;i<RULES.length;i++){if(e1.model_.name==RULES[i][0]&&e2.model_.name==RULES[i][1])return RULES[i][2](e1,e2);if(e2.model_.name==RULES[i][0]&&e1.model_.name==RULES[i][1])return RULES[i][2](e2,e1)}return console.log("************** Unknown partialOr combination: ",e1.name_,e2.name_),null},partialEval:function(){for(var newArgs=[],updated=!1,i=0;i<this.args.length;i++){var a=this.args[i],newA=this.args[i].partialEval();if(newA===TRUE)return TRUE;if(OrExpr.isInstance(newA)){for(var j=0;j<newA.args.length;j++)newArgs.push(newA.args[j]);updated=!0}else newA!==FALSE&&newArgs.push(newA),a!==newA&&(updated=!0)}for(var i=0;i<newArgs.length-1;i++)for(var j=i+1;j<newArgs.length;j++){var a=this.partialOr(newArgs[i],newArgs[j]);if(a){if(console.log("***************** ",newArgs[i].toMQL()," <PartialOr> ",newArgs[j].toMQL()," -> ",a.toMQL()),a===TRUE)return TRUE;newArgs[i]=a,newArgs.splice(j,1)}}return 0==newArgs.length?FALSE:1==newArgs.length?newArgs[0]:updated?OrExpr.create({args:newArgs}):this},f:function(obj){return this.args.some(function(arg){return arg.f(obj)})}}}),CLASS({name:"NotExpr",extendsModel:"UNARY","abstract":!0,documentation:"Unary expression which inverts the truth value of its argument.",methods:{toSQL:function(){return"not ( "+this.arg1.toSQL()+" )"},toMQL:function(){return"-"+this.arg1.toMQL()},toBQL:function(){return"-"+this.arg1.toBQL()},collectInputs:function(terms){this.arg1.collectInputs(terms)},minterm:function(index,term){return!this.arg1.minterm(index,term)},partialEval:function(){var newArg=this.arg1.partialEval();return newArg===TRUE?FALSE:newArg===FALSE?TRUE:NotExpr.isInstance(newArg)?newArg.arg1:EqExpr.isInstance(newArg)?NeqExpr.create(newArg):NeqExpr.isInstance(newArg)?EqExpr.create(newArg):LtExpr.isInstance(newArg)?GteExpr.create(newArg):GtExpr.isInstance(newArg)?LteExpr.create(newArg):LteExpr.isInstance(newArg)?GtExpr.create(newArg):GteExpr.isInstance(newArg)?LtExpr.create(newArg):this.arg1===newArg?this:NOT(newArg)},f:function(obj){return!this.arg1.f(obj)}}}),CLASS({name:"ContainedInICExpr",extendsModel:"BINARY",documentation:"Checks if the first argument is contained in the array-valued right argument, ignoring case in strings.",properties:[{name:"arg2",label:"Argument",type:"Expr",help:"Sub-expression",preSet:function(_,a){return a.map(function(o){return o.toUpperCase()})}}],methods:{toSQL:function(){return this.arg1.toSQL()+" IN "+this.arg2},toMQL:function(){return this.arg1.toMQL()+":"+this.arg2.join(",")},toBQL:function(){return this.arg1.toBQL()+":("+this.arg2.join("|")+")"},f:function(obj){var v=this.arg1.f(obj);if(Array.isArray(v)){for(var j=0;j<v.length;j++)for(var a=v[j].toUpperCase(),i=0;i<this.arg2.length;i++)if(-1!=a.indexOf(this.arg2[i]))return!0}else{v=(""+v).toUpperCase();for(var i=0;i<this.arg2.length;i++)if(-1!=v.indexOf(this.arg2[i]))return!0}return!1}}}),CLASS({name:"ContainsExpr",extendsModel:"BINARY",methods:{toSQL:function(){return this.arg1.toSQL()+" like '%' + "+this.arg2.toSQL()+"+ '%'"},toMQL:function(){return this.arg1.toMQL()+":"+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+":"+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval();return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(-1!=newArg1.f().indexOf(newArg2.f())):this.arg1!==newArg1||this.arg2!=newArg2?ContainsExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){var arg1=this.arg1.f(obj),arg2=this.arg2.f(obj);return Array.isArray(arg1)?arg1.some(function(arg){return-1!=arg.indexOf(arg2)}):-1!=arg1.indexOf(arg2)}}}),CLASS({name:"ContainsICExpr",extendsModel:"BINARY",properties:[{name:"arg2",label:"Argument",type:"Expr",help:"Sub-expression",defaultValue:TRUE,postSet:function(_,value){this.pattern_=void 0}}],methods:{toSQL:function(){return this.arg1.toSQL()+" like '%' + "+this.arg2.toSQL()+"+ '%'"},toMQL:function(){return this.arg1.toMQL()+":"+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+":"+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval();return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(-1!=newArg1.f().toLowerCase().indexOf(newArg2.f())):this.arg1!==newArg1||this.arg2!=newArg2?ContainsICExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){var arg1=this.arg1.f(obj),pattern=this.pattern_||(this.pattern_=new RegExp(this.arg2.f().toString().replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"i"));if(Array.isArray(arg1)){var pattern=this.pattern_;return arg1.some(function(arg){return pattern.test(arg)})}return this.pattern_.test(arg1)}}}),CLASS({name:"NeqExpr",extendsModel:"BINARY","abstract":!0,methods:{toSQL:function(){return this.arg1.toSQL()+"<>"+this.arg2.toSQL()},toMQL:function(){return"-"+this.arg1.toMQL()+"="+this.arg2.toMQL()},toBQL:function(){return"-"+this.arg1.toBQL()+":"+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval();return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(newArg1.f()!=newArg2.f()):this.arg1!==newArg1||this.arg2!=newArg2?NeqExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){return this.arg1.f(obj)!=this.arg2.f(obj)}}}),CLASS({name:"StartsWithExpr",extendsModel:"BINARY",methods:{toSQL:function(){return this.arg1.toSQL()+" like '%' + "+this.arg2.toSQL()+"+ '%'"},toMQL:function(){return this.arg1.toMQL()+"-after:"+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+">="+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval();return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(newArg1.f().startsWith(newArg2.f())):this.arg1!==newArg1||this.arg2!=newArg2?StartsWithExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){var arg1=this.arg1.f(obj),arg2=this.arg2.f(obj);return Array.isArray(arg1)?arg1.some(function(arg){return arg.startsWith(arg2)}):arg1.startsWith(arg2)}}}),CLASS({name:"StartsWithICExpr",extendsModel:"BINARY",methods:{toSQL:function(){return this.arg1.toSQL()+" like '%' + "+this.arg2.toSQL()+"+ '%'"},toMQL:function(){return this.arg1.toMQL()+"-after:"+this.arg2.toMQL()},toBQL:function(){return this.arg1.toBQL()+">="+this.arg2.toBQL()},partialEval:function(){var newArg1=this.arg1.partialEval(),newArg2=this.arg2.partialEval();return ConstantExpr.isInstance(newArg1)&&ConstantExpr.isInstance(newArg2)?compile_(newArg1.f().startsWithIC(newArg2.f())):this.arg1!==newArg1||this.arg2!=newArg2?StartsWithICExpr.create({arg1:newArg1,arg2:newArg2}):this},f:function(obj){return this.arg1.f(obj).startsWithIC(this.arg2.f(obj))}}}),CLASS({name:"ConcatExpr",extendsModel:"NARY",label:"concat",methods:{partialEval:function(){return this},f:function(obj){for(var str=[],i=0;i<this.args.length;i++)str.push(this.args[i].f(obj));return str.join("")}}}),CLASS({name:"SumExpr",extendsModel:"UNARY",properties:[{name:"sum",type:"int",help:"Sum of values.",factory:function(){return 0}}],methods:{pipe:function(sink){sink.put(this)},put:function(obj){this.instance_.sum+=this.arg1.f(obj)},remove:function(obj){this.sum-=this.arg1.f(obj)},toString:function(){return this.sum}}}),CLASS({name:"AvgExpr",extendsModel:"UNARY",properties:[{name:"count",type:"int",defaultValue:0},{name:"sum",type:"int",help:"Sum of values.",defaultValue:0},{name:"avg",type:"floag",help:"Average of values.",getter:function(){return this.sum/this.count}}],methods:{pipe:function(sink){sink.put(this)},put:function(obj){this.count++,this.sum+=this.arg1.f(obj)},remove:function(obj){this.count--,this.sum-=this.arg1.f(obj)},toString:function(){return this.avg}}}),CLASS({name:"MinExpr",extendsModel:"UNARY",properties:[{name:"min",type:"int",help:"Minimum value.",defaultValue:void 0}],methods:{minimum:function(o1,o2){return o1.compareTo(o2)>0?o2:o1},reduce:function(other){return MinExpr.create({max:this.mininum(this.min,other.min)})},reduceI:function(other){this.min=this.minimum(this.min,other.min)},pipe:function(sink){sink.put(this)},put:function(obj){var v=this.arg1.f(obj);this.min=void 0===this.min?v:this.minimum(this.min,v)},remove:function(obj){},toString:function(){return this.min}}}),CLASS({name:"DistinctExpr",extendsModel:"BINARY",properties:[{name:"values",help:"Distinct values.",factory:function(){return{}}}],methods:{reduce:function(other){},reduceI:function(other){},put:function(obj){var key=this.arg1.f(obj);this.values.hasOwnProperty(key)||(this.values[key]=!0,this.arg2.put(obj))},remove:function(obj){},toString:function(){return this.arg2.toString()},toHTML:function(){return this.arg2.toHTML()}}}),CLASS({name:"GroupByExpr",extendsModel:"BINARY",properties:[{name:"groups",type:"Map[Expr]",help:"Groups.",factory:function(){return{}}},{name:"groupKeys",factory:function(){return[]}}],methods:{reduce:function(other){},reduceI:function(other){for(var i in other.groups)this.groups[i]?this.groups[i].reduceI(other.groups[i]):this.groups[i]=other.groups[i].deepClone()},pipe:function(sink){for(key in this.groups)sink.push([key,this.groups[key].toString()]);return sink},putInGroup_:function(key,obj){var group=this.groups.hasOwnProperty(key)&&this.groups[key];group||(group=this.arg2.clone(),this.groups[key]=group,this.groupKeys.push(key)),group.put(obj)},put:function(obj){var key=this.arg1.f(obj);if(Array.isArray(key))if(key.length)for(var i=0;i<key.length;i++)this.putInGroup_(key[i],obj);else this.putInGroup_("",obj);else this.putInGroup_(key,obj)},clone:function(){return GroupByExpr.create({arg1:this.arg1,arg2:this.arg2})},remove:function(obj){},toString:function(){return this.groups},deepClone:function(){var cl=this.clone();cl.groups={};for(var i in this.groups)cl.groups[i]=this.groups[i].deepClone();return cl},toHTML:function(){var out=[];out.push("<table border=1>");for(var key in this.groups){var value=this.groups[key],str=value.toHTML?value.toHTML():value;out.push("<tr><th>",key,"</th><td>",str,"</td></tr>")}return out.push("</table>"),out.join("")},initHTML:function(){for(var key in this.groups){var value=this.groups[key];value.initHTML&&value.initHTML()}}}}),CLASS({name:"GridByExpr",extendsModel:"Expr",properties:[{name:"xFunc",label:"X-Axis Function",type:"Expr",help:"Sub-expression",defaultValue:TRUE},{name:"yFunc",label:"Y-Axis Function",type:"Expr",help:"Sub-expression",defaultValue:TRUE},{name:"acc",label:"Accumulator",type:"Expr",help:"Sub-expression",defaultValue:TRUE},{name:"rows",type:"Map[Expr]",help:"Rows.",factory:function(){return{}}},{name:"cols",label:"Columns",type:"Map[Expr]",help:"Columns.",factory:function(){return{}}},{model_:"ArrayProperty",name:"children"}],methods:{init:function(){this.SUPER();var self=this,f=function(){self.cols=GROUP_BY(self.xFunc,COUNT()),self.rows=GROUP_BY(self.yFunc,GROUP_BY(self.xFunc,self.acc))};self.addPropertyListener("xFunc",f),self.addPropertyListener("yFunc",f),self.addPropertyListener("acc",f),f()},reduce:function(other){},reduceI:function(other){},pipe:function(sink){},put:function(obj){this.rows.put(obj),this.cols.put(obj)},clone:function(){return this.model_.create({xFunc:this.xFunc,yFunc:this.yFunc,acc:this.acc})},remove:function(obj){},toString:function(){return this.groups},deepClone:function(){},renderCell:function(x,y,value){var str=value?value.toHTML?value.toHTML():value:"";return value&&value.toHTML&&value.initHTML&&this.children.push(value),"<td>"+str+"</td>"},sortAxis:function(values,f){return values.sort(f.compareProperty)},sortCols:function(cols,xFunc){return this.sortAxis(cols,xFunc)},sortRows:function(rows,yFunc){return this.sortAxis(rows,yFunc)},sortedCols:function(){return this.sortCols(this.cols.groupKeys,this.xFunc)},sortedRows:function(){return this.sortRows(this.rows.groupKeys,this.yFunc)},toHTML:function(){var out;this.children=[];var cols=this.cols.groups,rows=this.rows.groups,sortedCols=this.sortedCols(),sortedRows=this.sortedRows();out='<table border=0 cellspacing=0 class="gridBy"><tr><th></th>';for(var i=0;i<sortedCols.length;i++){var x=sortedCols[i],str=x.toHTML?x.toHTML():x;out+="<th>"+str+"</th>"}out+="</tr>";for(var j=0;j<sortedRows.length;j++){var y=sortedRows[j];out+="<tr><th>"+y+"</th>";for(var i=0;i<sortedCols.length;i++){var x=sortedCols[i],value=rows[y].groups[x];value&&(value.x=x,value.y=y),out+=this.renderCell(x,y,value)}out+="</tr>"}return out+="</table>"},initHTML:function(){for(var i=0;i<this.children.length;i++)this.children[i].initHTML();this.children=[]}}}),CLASS({name:"MapExpr",extendsModel:"BINARY",methods:{reduce:function(other){},reduceI:function(other){},pipe:function(sink){},put:function(obj){var val=this.arg1.f?this.arg1.f(obj):this.arg1(obj),acc=this.arg2;acc.put(val)},clone:function(){return MapExpr.create({arg1:this.arg1,arg2:this.arg2.clone()})
},remove:function(obj){},toString:function(){return this.arg2.toString()},deepClone:function(){},toHTML:function(){return this.arg2.toHTML?this.arg2.toHTML():this.toString()},initHTML:function(){this.arg2.initHTML&&this.arg2.initHTML()}}}),CLASS({name:"SeqExpr",extendsModel:"NARY",methods:{pipe:function(sink){sink.put(this)},put:function(obj){for(var ret=[],i=0;i<this.args.length;i++){var a=this.args[i];a.put(obj)}},f:function(obj){for(var ret=[],i=0;i<this.args.length;i++){var a=this.args[i];ret.push(a.f(obj))}return ret},clone:function(){return SeqExpr.create({args:this.args.clone()})},toString:function(obj){var out=[];out.push("(");for(var i=0;i<this.args.length;i++){var a=this.args[i];out.push(a.toString()),i<this.args.length-1&&out.push(",")}return out.push(")"),out.join("")},toHTML:function(obj){for(var out=[],i=0;i<this.args.length;i++){var a=this.args[i];out.push(a.toHTML?a.toHTML():a.toString()),i<this.args.length-1&&out.push("&nbsp;")}return out.join("")}}}),CLASS({name:"UpdateExpr",extendsModel:"NARY",label:"UpdateExpr",properties:[{name:"dao",type:"DAO","transient":!0,hidden:!0}],methods:{put:function(obj){(this.objs_||(this.objs_=[])).push(obj)},eof:function(){if(this.objs_){for(var i=0;i<this.objs_.length;i++){var obj=this.objs_[i],newObj=this.f(obj);newObj.id!==obj.id&&this.dao.remove(obj.id),this.dao.put(newObj)}this.objs_=void 0}},f:function(obj){for(var newObj=obj.clone(),i=0;i<this.args.length;i++)this.args[i].f(newObj);return newObj},reduce:function(other){return UpdateExpr.create({args:this.args.concat(other.args),dao:this.dao})},reduceI:function(other){this.args=this.args.concat(other.args)},toString:function(){return this.toSQL()},toSQL:function(){for(var s="SET ",i=0;i<this.args.length;i++){var a=this.args[i];s+=a.toSQL(),i<this.args.length-1&&(s+=", ")}return s}}}),CLASS({name:"SetExpr",label:"SetExpr",extendsModel:"BINARY",methods:{toSQL:function(){return this.arg1.toSQL()+" = "+this.arg2.toSQL()},f:function(obj){Property.isInstance(this.arg1)&&(obj[this.arg1.name]=this.arg2.f(obj))}}}),CLASS({name:"ExpandableGroupByExpr",extendsModel:"BINARY",properties:[{name:"groups",type:"Map[Expr]",help:"Groups.",factory:function(){return{}}},{name:"expanded",type:"Map",help:"Expanded.",factory:function(){return{}}},{name:"values",type:"Object",help:"Values",factory:function(){return[]}}],methods:{reduce:function(other){},reduceI:function(other){},select:function(sink,options){var self=this;return this.values.select({put:function(o){sink.put(o);var key=self.arg1.f(o),a=o.children;if(a)for(var i=0;i<a.length;i++)sink.put(a[i])}},options),aconstant(sink)},putKeyValue_:function(key,value){var group=this.groups.hasOwnProperty(key)&&this.groups[key];group?group.count++:(group=value.clone(),this.expanded[key]&&(group.children=[]),this.groups[key]=group,group.count=1,this.values.push(group)),group.children&&group.children.push(obj)},put:function(obj){var key=this.arg1.f(obj);if(Array.isArray(key))for(var i=0;i<key.length;i++)this.putKeyValue_(key[i],obj);else this.putKeyValue_(key,obj)},where:function(query){return(this.Y||X).FilteredDAO_.create({query:query,delegate:this})},limit:function(count){return(this.Y||X).LimitedDAO_.create({count:count,delegate:this})},skip:function(skip){return(this.Y||X).SkipDAO_.create({skip:skip,delegate:this})},orderBy:function(){return(this.Y||X).OrderedDAO_.create({comparator:1==arguments.length?arguments[0]:argsToArray(arguments),delegate:this})},listen:function(){},unlisten:function(){},remove:function(obj){},toString:function(){return this.groups},deepClone:function(){return this}}}),CLASS({name:"TreeExpr",extendsModel:"Expr",properties:[{name:"parentProperty"},{name:"childrenProperty"},{name:"items_",help:"Temporary map to store collected objects.",factory:function(){return{}},"transient":!0},{model_:"ArrayProperty",name:"roots"}],methods:{put:function(o){this.items_[o.id]=o,this.parentProperty.f(o)||this.roots.push(o)},eof:function(){var pprop=this.parentProperty,cprop=this.childrenProperty;for(var key in this.items_){var item=this.items_[key],parentId=pprop.f(item);if(parentId){var parent=this.items_[parentId];parent[cprop.name]=cprop.f(parent).concat(item)}}this.items_={}}}}),CLASS({name:"DescExpr",extendsModel:"UNARY",methods:{toSQL:function(){return this.arg1.toMQL()+"DESC"},toMQL:function(){return"-"+this.arg1.toMQL()},compare:function(o1,o2){return-1*this.arg1.compare(o1,o2)}}}),CLASS({name:"AddExpr",extendsModel:"BINARY",methods:{toSQL:function(){return this.arg1.toSQL()+" + "+this.arg2.toSQL()},f:function(o){return this.arg1.f(o)+this.arg2.f(o)}}});var JOIN=function(dao,key,sink){return sink=sink||[].sink,{f:function(o){var s=sink.clone();return dao.where(EQ(key,o.id)).select(s),[o,s]}}};CLASS({name:"MQLExpr",extendsModel:"UNARY",documentation:"Parse an MQL query string and use it as a predicate.",properties:[{name:"specializations_",factory:function(){return{}}}],methods:{specialize:function(model){var qp=QueryParserFactory(model,!0);return qp.parseString(this.arg1)||FALSE},specialization:function(model){return this.specializations_[model.name]||(this.specializations_[model.name]=this.specialize(model))},toSQL:function(){return this.arg1},toMQL:function(){return this.arg1},partialEval:function(){return this},f:function(obj){return this.specialization(obj.model_).f(obj)}}}),CLASS({name:"KeywordExpr",extendsModel:"UNARY",documentation:"Keyword search.",methods:{toSQL:function(){return this.arg1},toMQL:function(){return this.arg1},partialEval:function(){return this},f:function(obj){var pattern=this.pattern_||(this.pattern_=new RegExp(this.arg1.toString().replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"i"));return this.pattern_.test(obj.toJSON())}}});var MONTH=function(p){return{f:function(o){return p.f(o).getMonth()}}},QueryParserFactory=function(model,opt_enableKeyword){for(var g={__proto__:grammar,START:sym("query"),query:sym("or"),or:repeat(sym("and"),alt(literal_ic(" OR "),literal(" | ")),1),and:repeat(sym("expr"),alt(literal_ic("AND "),not(alt(literal_ic(" OR"),literal(" |"))," ")),1),expr:alt(sym("paren"),sym("negate"),sym("has"),sym("is"),sym("equals"),sym("before"),sym("after"),sym("id"),sym("keyword")),paren:seq1(1,"(",sym("query"),")"),negate:alt(seq("-",sym("expr")),seq("NOT ",sym("expr"))),id:sym("number"),has:seq(literal_ic("has:"),sym("fieldname")),is:seq(literal_ic("is:"),sym("fieldname")),equals:seq(sym("fieldname"),alt(":","="),sym("valueList")),before:seq(sym("fieldname"),alt("<","<=","-before:"),sym("value")),after:seq(sym("fieldname"),alt(">",">=","-after:"),sym("value")),value:alt(sym("me"),sym("date"),sym("string"),sym("number")),compoundValue:alt(sym("negateValue"),sym("orValue"),sym("andValue")),negateValue:seq("(",alt("-",literal_ic("not ")),sym("value"),")"),orValue:seq("(",repeat(sym("value"),alt("|",literal_ic(" or ")," | "),1),")"),andValue:seq("(",repeat(sym("value"),alt(literal_ic(" and ")," "),1),")"),valueList:alt(sym("compoundValue"),repeat(sym("value"),",",1)),keyword:function(){var keyword_=sym("keyword_");return function(ps){return opt_enableKeyword&&this.parse(keyword_,ps)}}(),keyword_:str(plus(notChar(" "))),me:seq(literal_ic("me"),lookahead(not(sym("char")))),date:alt(sym("range date"),sym("literal date"),sym("relative date")),"range date":seq(sym("literal date"),"..",sym("literal date")),"literal date":alt(seq(sym("number"),"-",sym("number"),"-",sym("number"),"T",sym("number"),":",sym("number")),seq(sym("number"),"-",sym("number"),"-",sym("number"),"T",sym("number")),seq(sym("number"),"-",sym("number"),"-",sym("number")),seq(sym("number"),"-",sym("number")),seq(sym("number"),"/",sym("number"),"/",sym("number"))),"relative date":seq(literal_ic("today"),optional(seq("-",sym("number")))),string:alt(sym("word"),sym("quoted string")),"quoted string":str(seq1(1,'"',repeat(alt(literal('\\"','"'),notChar('"'))),'"')),word:str(plus(sym("char"))),"char":alt(range("a","z"),range("A","Z"),range("0","9"),"-","^","_","@","%","."),number:str(plus(range("0","9")))},fields=[],i=0;i<model.properties_.length;i++){var prop=model.properties_[i];fields.push(literal_ic(prop.name,prop))}for(var i=0;i<model.properties_.length;i++)for(var prop=model.properties_[i],j=0;j<prop.aliases.length;j++)prop.aliases[j]&&fields.push(literal_ic(prop.aliases[j],prop));for(var i=0;i<model.properties_.length;i++){var prop=model.properties_[i];prop.shortName&&fields.push(literal_ic(prop.shortName,prop))}return fields.sort(function(a,b){var d=a.length-b.length;return 0!==d?d:a==b?0:b>a?1:-1}),g.fieldname=alt.apply(null,fields),g.addActions({id:function(v){return EQ(model.ID,v)},or:function(v){return OR.apply(OR,v)},and:function(v){return AND.apply(AND,v)},negate:function(v){return NOT(v[1])},number:function(v){return parseInt(v)},me:function(){return this.ME||this.X.ME||""},has:function(v){return NEQ(v[1],"")},is:function(v){return EQ(v[1],TRUE)},before:function(v){return Array.isArray(v[2])&&v[2][0]instanceof Date&&(v[2]="<="===v[1]?v[2][1]:v[2][0]),("<="===v[1]?LTE:LT)(v[0],v[2])},after:function(v){return Array.isArray(v[2])&&v[2][0]instanceof Date&&(v[2]=">="===v[1]?v[2][0]:v[2][1]),(">="===v[1]?GTE:GT)(v[0],v[2])},equals:function(v){var prop=v[0],values=v[2],isInt=IntProperty.isInstance(prop),isNum=isInt||FloatProperty.isInstance(prop),isDateField=DateProperty.isInstance(prop)||DateTimeProperty.isInstance(prop),isDateRange=Array.isArray(values[0])&&values[0][0]instanceof Date;if(isDateField||isDateRange){if(!isDateRange){var start=new Date(0),end=new Date(0);start.setUTCFullYear(values[0]),end.setUTCFullYear(+values[0]+1),values=[[start,end]]}var q=AND(GTE(prop,values[0][0]),LT(prop,values[0][1]));return q}if(isNum)for(var i=0;i<values.length;i++)values[i]=isInt?parseInt(values[i]):parseFloat(values[i]);var expr="="===v[1]||isNum?IN(v[0],values):ContainedInICExpr.create({arg1:compile_(prop),arg2:values});return values.negated?NOT(expr):values.and?AndExpr.create({args:values.map(function(x){return expr.model_.create({arg1:expr.arg1,arg2:[x]})})}):expr},keyword:function(v){return KEYWORD(v)},negateValue:function(v){return v.negated=!0,v},orValue:function(v){return v=v[1],v.or=!0,v},andValue:function(v){return v=v[1],v.and=!0,v},"literal date":function(v){var start,end,interval;start=new Date,end=new Date;for(var ops=["FullYear","Month","Date","Hours","Minutes","Seconds"],defaults=[0,1,1,0,0,0],i=0;i<ops.length;i++){var x=2*i>v.length?defaults[i]:v[2*i];start["setUTC"+ops[i]](x-(1==i?1:0)),end["setUTC"+ops[i]](x-(1==i?1:0))}var last=Math.floor(v.length/2),op="UTC"+ops[last];return end["set"+op](end["get"+op]()+1),[start,end]},"relative date":function(v){var d=new Date;return v[1]&&d.setDate(d.getDate()-v[1][1]),d},"range date":function(v){return[v[0][0],v[2][1]]}}),g};CLASS({name:"GroupBySearchView",extendsModel:"foam.ui.View",label:"GroupBy Search View",properties:[{name:"view",type:"view",factory:function(){return ChoiceView.create({size:this.size,cssClass:"foamSearchChoiceView"})}},{name:"width",type:"int",defaultValue:47},{name:"size",type:"int",defaultValue:17},{name:"dao",label:"DAO",type:"DAO",required:!0,postSet:function(){this.view.id&&this.updateDAO()}},{name:"property",type:"Property"},{name:"filter",type:"Object",defaultValue:TRUE},{name:"predicate",type:"Object",defaultValue:TRUE},{name:"label",type:"String",defaultValueFn:function(){return this.property.label}}],methods:{toHTML:function(){return'<div class="foamSearchView"><div class="foamSearchViewLabel">'+this.label+"</div>"+this.view.toHTML()+"</div>"},initHTML:function(){this.view.initHTML(),Events.dynamic(function(){this.dao},this.updateDAO),this.propertyValue("filter").addListener(this.updateDAO),this.view.data$.addListener(this.updateChoice)}},listeners:[{name:"updateDAO",code:function(){var self=this;this.dao.where(this.filter).select(GROUP_BY(this.property,COUNT()))(function(groups){var options=[];for(var key in groups.groups){var count=("("+groups.groups[key]+")").intern(),subKey=key.substring(0,self.width-count.length-3),cleanKey=subKey.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");options.push([key,cleanKey+Array(self.width-subKey.length-count.length).join("&nbsp;").intern()+count])}options.sort(),options.splice(0,0,["","-- CLEAR SELECTION --"]),self.view.choices=options})}},{name:"updateChoice",code:function(_,_,_,choice){this.predicate=choice?EQ(this.property,choice):TRUE}}]}),CLASS({name:"TextSearchView",extendsModel:"foam.ui.View",properties:[{name:"width",type:"int",defaultValue:47},{name:"property",type:"Property"},{name:"predicate",type:"Object",defaultValue:TRUE},{name:"view",type:"view",factory:function(){return TextFieldView.create({displayWidth:this.width,cssClass:"foamSearchTextField"})}},{name:"label",type:"String",defaultValueFn:function(){return this.property.label}}],methods:{toHTML:function(){return'<div class="foamSearchView"><div class="foamSearchViewLabel">'+this.label+"</div>"+this.view.toHTML()+"</div><div id="+this.on("click",this.clear)+' style="text-align:right;width:100%;float:right;margin-bottom:20px;" class="searchTitle"><font size=-1><u>Clear</u></font></div>'},initHTML:function(){this.SUPER(),this.view.initHTML(),this.view.data$.addListener(this.updateValue)}},listeners:[{name:"updateValue",code:function(){var value=this.view.data;return value?void(this.predicate=CONTAINS_IC(this.property,value)):void(this.predicate=TRUE)}},{name:"clear",code:function(){this.view.data="",this.predicate=TRUE}}]}),CLASS({name:"SearchView",extendsModel:"foam.ui.View",properties:[{name:"dao"},{name:"model"},{name:"predicate",type:"Object",defaultValue:TRUE}],methods:{buildSubViews:function(){for(var props=this.model.searchProperties,i=0;i<props.length;i++){var view=GroupBySearchView.create({dao:this.dao,property:this.model[constantize(props[i])]});this.addChild(view),view.addPropertyListener("predicate",this.updatePredicate)}},toInnerHTML:function(){this.children.length||this.buildSubViews();for(var str="",i=0;i<this.children.length;i++)str+=this.children[i].toHTML();return str}},listeners:[{name:"updatePredicate",code:function(){for(var p=TRUE,i=0;i<this.children.length;i++){var view=this.children[i];view.predicate&&(p=AND(p,view.predicate))}this.predicate=p.partialEval()}}]}),CLASS({name:"SearchBorder",properties:[{name:"dao"},{name:"model"},{name:"view",factory:function(){return SearchView.create({dao:this.dao,model:this.model})}}],methods:{decorateObject:function(object){this.view.addPropertyListener("predicate",function(border,_,_,pred){object.dao=border.dao.where(pred)})},toHTML:function(border,delegate,args){return this.addChild(border.view),border.view.toHTML()+delegate()}}});var OAM={time:function(name,fn){return function(){console.time(name);var ret=fn.apply(this,arguments);return console.timeEnd(name),ret}},profile:function(fn){return function(){console.profile();var ret=fn.apply(this,arguments);return console.profileEnd(),ret}}},Visitor={create:function(){return{__proto__:this,stack:[]}},push:function(o){this.stack.push(o)},pop:function(){return this.stack.pop()},top:function(){return this.stack.length&&this.stack[this.stack.length-1]},visit:function(o){return Array.isArray(o)?this.visitArray(o):"string"==typeof o?this.visitString(o):"number"==typeof o?this.visitNumber(o):o instanceof Function?this.visitFunction(o):o instanceof Date?this.visitDate(o):o===!0?this.visitTrue():o===!1?this.visitFalse():null===o?this.visitNull():o instanceof Object?o.model_?this.visitObject(o):this.visitMap(o):this.visitUndefined()},visitArray:function(o){for(var len=o.length,i=0;len>i;i++)this.visitArrayElement(o,i);return o},visitArrayElement:function(arr,i){this.visit(arr[i])},visitString:function(o){return o},visitFunction:function(o){return o},visitNumber:function(o){return o},visitDate:function(o){return o},visitObject:function(o){for(var key in o.model_.properties_){var prop=o.model_.properties_[key];prop.name in o.instance_&&this.visitProperty(o,prop)}return o},visitProperty:function(o,prop){this.visit(o[prop.name])},visitMap:function(o){for(var key in o)this.visitMapElement(key,o[key]);return o},visitMapElement:function(key,value){},visitTrue:function(){return!0},visitFalse:function(){return!1},visitNull:function(){return null},visitUndefined:function(){return void 0}};CLASS({name:"XHR",properties:[{model_:"IntProperty",name:"delay",defaultValue:0},{model_:"IntProperty",name:"retries",defaultValue:0},{name:"authAgent"},{name:"responseType",defaultValue:"text"}],methods:{init:function(args){this.SUPER(args),this.delay&&this.addDecorator(DelayDecorator.create({delayMs:this.delay})),this.authAgent&&this.addDecorator(OAuthXhrDecorator.create({authAgent:this.authAgent})),this.retries&&this.addDecorator(RetryDecorator.create({maxAttempts:this.retries}))},makeXhr:function(){return new XMLHttpRequest},open:function(xhr,method,url){xhr.open(method,url)},setRequestHeader:function(xhr,header,value){xhr.setRequestHeader(header,value)},configure:function(xhr){xhr.responseType=this.responseType,this.setRequestHeader(xhr,"Content-Type","application/json")},bindListeners:function(xhr,ret){var self=this;xhr.onreadystatechange=function(){if(4==xhr.readyState){if("json"===self.responseType&&"string"==typeof xhr.response)var response=JSON.parse(xhr.response);else response=xhr.response;ret(response,xhr)}}},send:function(xhr,data){xhr.send(data)},asend:function(ret,url,data,method){var xhr=this.makeXhr();this.open(xhr,method||"GET",url),this.configure(xhr),this.bindListeners(xhr,ret),this.send(xhr,data&&data.toJSON?data.toJSON():data)}}}),CLASS({name:"OAuthXhrDecorator",properties:["authAgent"],methods:{configure:function(decorator,delegate,args){var xhr=args[0];return xhr.setRequestHeader("Authorization","Bearer "+decorator.authAgent.accessToken),delegate.apply(this,args)},asend:function(decorator,delegate,args){var ret=args[0];return args[0]=function(response,xhr){401===xhr.status?decorator.authAgent.refresh(function(){ret(response,xhr)}):ret(response,xhr)},delegate.apply(null,args)}}}),CLASS({name:"RetryDecorator",properties:[{model_:"IntProperty",name:"maxAttempts",defaultValue:3}],methods:{asend:function(decorator,delegate,args){var originalRet=args[0],attempts=0,self=this,response;awhile(function(){return!0},aseq(function(ret){args[0]=ret,delegate.apply(self,args)},function(ret,response,xhr){return xhr.status>=200&&xhr.status<300||404===xhr.status||++attempts>=decorator.maxAttempts?(finished=!0,void originalRet(response,xhr)):void ret()}))(function(){})}}}),CLASS({name:"DelayDecorator",properties:[{model_:"IntProperty",name:"delayMs"}],methods:{decorateObject:function(target){var asend=adelay(target.asend.bind(target),this.delayMs);target.decorate("asend",function(_,_,args){asend.apply(null,args)})}}}),CLASS({name:"XhrMessenger",properties:[{model_:"URLProperty",name:"url"},{model_:"StringProperty",name:"method",defaultValue:"POST"}],methods:{put:function(obj,sink){var xhr=this.Y.XHR.create();xhr.asend(function(response,xhr){return xhr.status>=200&&xhr.status<300?void(sink&&sink.put&&sink.put(response)):void(sink&&sink.error&&sink.error([response,xhr]))},this.url,obj,this.method)}}});var LoggingDAO={create:function(){var logger,delegate;return 2==arguments.length?(logger=arguments[0],delegate=arguments[1]):(logger=console.log.bind(console),delegate=arguments[0]),{__proto__:delegate,put:function(obj,sink){logger("put",obj),delegate.put(obj,sink)},remove:function(query,sink){logger("remove",query),delegate.remove(query,sink)},select:function(sink,options){return logger("select",options||""),delegate.select(sink,options)},removeAll:function(sink,options){return logger("removeAll",options),delegate.removeAll(sink,options)}}}},TimingDAO={create:function(name,delegate){function start(op){var str=name+"-"+op,key=activeOps[op]++?str+"-"+id++:str;return console.time(id),[key,str,window.performance.now(),op]}function end(act){activeOps[act[3]]--,id--,console.timeEnd(act[0]),console.log("Timing: ",act[1]," ",(window.performance.now()-act[2]).toFixed(3)," ms")}function endSink(act,sink){return{put:function(){end(act),sink&&sink.put&&sink.put.apply(sink,arguments)},remove:function(){end(act),sink&&sink.remove&&sink.remove.apply(sink,arguments)},error:function(){end(act),sink&&sink.error&&sink.error.apply(sink,arguments)},eof:function(){end(act),sink&&sink.eof&&sink.eof.apply(sink,arguments)}}}var id,activeOps={put:0,remove:0,find:0,select:0};return{__proto__:delegate,put:function(obj,sink){var act=start("put");delegate.put(obj,endSink(act,sink))},remove:function(query,sink){var act=start("remove");delegate.remove(query,endSink(act,sink))},find:function(key,sink){var act=start("find");delegate.find(key,endSink(act,sink))},select:function(sink,options){var act=start("select"),fut=afuture();return delegate.select(sink,options)(function(s){end(act),fut.set(s)}),fut.get}}}},ObjectToJSON={__proto__:Visitor.create(),visitFunction:function(o){return o.toString()},visitObject:function(o){return this.push({model_:(o.model_["package"]?o.model_["package"]+".":"")+o.model_.name}),this.__proto__.visitObject.call(this,o),this.pop()},visitProperty:function(o,prop){prop.propertyToJSON(this,this.top(),o)},visitMap:function(o){return this.push({}),Visitor.visitMap.call(this,o),this.pop()},visitMapElement:function(key,value){this.top()[key]=this.visit(value)},visitArray:function(o){return this.push([]),this.__proto__.visitArray.call(this,o),this.pop()},visitArrayElement:function(arr,i){this.top().push(this.visit(arr[i]))}},JSONToObject={__proto__:ObjectToJSON.create(),visitString:function(o){try{return"function("===o.substr(0,9)?eval("("+o+")"):o}catch(x){return console.log(x,o),o}},visitObject:function(o){var model=X.lookup(o.model_);if(!model)throw new Error("Unknown Model: "+o.model_);var obj=model.create();return Object_forEach(o,function(value,key){"model_"!==key&&(obj[key]=this.visit(value))}.bind(this)),obj},visitArray:Visitor.visitArray,visitArrayElement:function(arr,i){arr[i]=this.visit(arr[i])}};CLASS({name:"AbstractDAO",documentation:function(){},properties:[{name:"daoListeners_","transient":!0,hidden:!0,factory:function(){return[]}}],methods:{update:function(expr){return this.select(UPDATE(expr,this))},listen:function(sink,options){sink=this.decorateSink_(sink,options,!0),this.daoListeners_.push(sink)},select:function(sink,options){},remove:function(query,sink){},pipe:function(sink,options){sink=this.decorateSink_(sink,options,!0);var fc=this.createFlowControl_(),self=this;this.select({put:function(){sink.put&&sink.put.apply(sink,arguments)},remove:function(){sink.remove&&sink.remove.apply(sink,arguments)},error:function(){sink.error&&sink.error.apply(sink,arguments)},eof:function(){fc.stopped?sink.eof&&sink.eof():self.listen(sink,options)}},options,fc)},decorateSink_:function(sink,options,isListener,disableLimit){return options&&(disableLimit||(options.limit&&(sink=limitedSink(options.limit,sink)),options.skip&&(sink=skipSink(options.skip,sink))),options.order&&!isListener&&(sink=orderedSink(options.order,sink)),options.query&&(sink=predicatedSink(options.query.partialEval?options.query.partialEval():options.query,sink))),sink},createFlowControl_:function(){return{stop:function(){this.stopped=!0},error:function(e){this.errorEvt=e}}},where:function(query){return(this.Y||X).FilteredDAO_.create({query:query,delegate:this})},limit:function(count){return(this.Y||X).LimitedDAO_.create({count:count,delegate:this})},skip:function(skip){return(this.Y||X).SkipDAO_.create({skip:skip,delegate:this})},orderBy:function(){return(this.Y||X).OrderedDAO_.create({comparator:1==arguments.length?arguments[0]:argsToArray(arguments),delegate:this})},unlisten:function(sink){for(var ls=this.daoListeners_,i=0;i<ls.length;i++)if(ls[i].$UID===sink.$UID)return ls.splice(i,1),!0},removeAll:function(sink,options){var self=this,future=afuture();return this.select({put:function(obj){self.remove(obj,{remove:sink&&sink.remove})}})(function(){sink&&sink.eof(),future.set()}),future.get},notify_:function(fName,args){for(var i=0;i<this.daoListeners_.length;i++){var l=this.daoListeners_[i],fn=l[fName];if(fn){args[2]={stop:function(fn,l){return function(){fn(l)}}(this.unlisten.bind(this),l),error:function(e){}};try{fn.apply(l,args)}catch(err){err!==this.UNSUBSCRIBE_EXCEPTION&&console.error("Error delivering event (removing listener): ",fName,err),this.unlisten(l)}}}}}}),Function.prototype.put=function(){this.apply(this,arguments)},Function.prototype.remove=function(){this.apply(this,arguments)},Function.prototype.reset=function(){this.call(this)},CLASS({name:"ProxyDAO",extendsModel:"AbstractDAO",documentation:function(){},properties:[{name:"delegate",type:"DAO",mode:"read-only",hidden:!0,required:!0,"transient":!0,documentation:"The internal DAO to proxy.",factory:function(){return NullDAO.create()},postSet:function(oldDAO,newDAO){this.daoListeners_.length&&(oldDAO&&oldDAO.unlisten(this.relay()),newDAO.listen(this.relay()),FutureDAO.isInstance(oldDAO)||this.notify_("reset",[]))}},{model_:"ModelProperty",name:"model",type:"Model",defaultValueFn:function(){return this.delegate.model},documentation:function(){}}],methods:{relay:function(){if(!this.relay_){var self=this;this.relay_={put:function(){self.notify_("put",arguments)},remove:function(){self.notify_("remove",arguments)},reset:function(){self.notify_("reset",arguments)},toString:function(){return"RELAY("+this.$UID+", "+self.model_.name+", "+self.delegate+")"}}}return this.relay_},put:function(value,sink){this.delegate.put(value,sink)},remove:function(query,sink){this.delegate.remove(query,sink)},removeAll:function(){return this.delegate.removeAll.apply(this.delegate,arguments)},find:function(key,sink){this.delegate.find(key,sink)},select:function(sink,options){return this.delegate.select(sink,options)},listen:function(sink,options){!this.daoListeners_.length&&this.delegate&&this.delegate.listen(this.relay()),this.SUPER(sink,options)},unlisten:function(sink){this.SUPER(sink),!this.daoListeners_.length&&this.delegate&&this.delegate.unlisten(this.relay())},toString:function(){return this.name_+"("+this.delegate+")"}}}),CLASS({name:"FutureDAO",extendsModel:"ProxyDAO",documentation:function(){},properties:[{name:"delegate",factory:function(){return null},postSet:function(oldDAO,newDAO){this.daoListeners_.length&&(oldDAO&&oldDAO.unlisten(this.relay()),newDAO.listen(this.relay()))}},{name:"future",required:!0,documentation:"The future on which to operate before the delegate becomes available."},{name:"model",defaultValueFn:function(){return this.delegate?this.delegate.model:""},documentation:function(){}}],methods:{init:function(){this.SUPER(),this.future(function(delegate){this.delegate=delegate}.bind(this))},put:function(value,sink){this.delegate?this.delegate.put(value,sink):this.future(this.put.bind(this,value,sink))},remove:function(query,sink){this.delegate?this.delegate.remove(query,sink):this.future(this.remove.bind(this,query,sink))},removeAll:function(){if(this.delegate)return this.delegate.removeAll.apply(this.delegate,arguments);var a=arguments,f=afuture();return this.future(function(delegate){this.removeAll.apply(this,a)(f.set)}.bind(this)),f.get},find:function(key,sink){this.delegate?this.delegate.find(key,sink):this.future(this.find.bind(this,key,sink))},select:function(sink,options){if(this.delegate)return this.delegate.select(sink,options);var a=arguments,f=afuture();return this.future(function(){this.select.apply(this,a)(f.set)}.bind(this)),f.get}}}),CLASS({name:"SeqNoDAO",label:"SeqNoDAO",extendsModel:"ProxyDAO",properties:[{name:"property",type:"Property",required:!0,hidden:!0,defaultValueFn:function(){return this.delegate.model?this.delegate.model.ID:void 0},"transient":!0},{model_:"IntProperty",name:"sequenceValue",defaultValue:1}],methods:{init:function(){this.SUPER();var future=afuture();this.WHEN_READY=future.get,this.delegate.select(MAX(this.property))(function(max){max.max&&(this.sequenceValue=max.max+1),future.set(!0)}.bind(this))},put:function(obj,sink){this.WHEN_READY(function(){var val=this.property.f(obj);val==this.property.defaultValue&&(obj[this.property.name]=this.sequenceValue++),this.delegate.put(obj,sink)}.bind(this))}}}),CLASS({name:"GUIDDAO",label:"GUIDDAO",extendsModel:"ProxyDAO",properties:[{name:"property",type:"Property",required:!0,hidden:!0,defaultValueFn:function(){return this.delegate.model?this.delegate.model.ID:void 0},"transient":!0}],methods:{createGUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=16*Math.random()|0,v="x"===c?r:3&r|8;return v.toString(16)})},put:function(obj,sink){obj.hasOwnProperty(this.property.name)||(obj[this.property.name]=this.createGUID()),this.delegate.put(obj,sink)}}}),CLASS({name:"CachingDAO",extendsModel:"ProxyDAO",properties:[{name:"src"},{name:"cache",help:"Alias for delegate.",getter:function(){return this.delegate},setter:function(dao){this.delegate=dao}},{name:"model",defaultValueFn:function(){return this.src.model||this.cache.model}}],methods:{init:function(){this.SUPER();var src=this.src,cache=this.cache,futureDelegate=afuture();this.cache=FutureDAO.create({future:futureDelegate.get}),src.select(cache)(function(){src.listen(cache),futureDelegate.set(cache),this.cache=cache}.bind(this))},put:function(obj,sink){this.src.put(obj,sink)},remove:function(query,sink){this.src.remove(query,sink)},removeAll:function(sink,options){return this.src.removeAll(sink,options)}}}),CLASS({name:"FilteredDAO_",extendsModel:"ProxyDAO",documentation:function(){},properties:[{name:"query",required:!0}],methods:{select:function(sink,options){return this.delegate.select(sink,options?{__proto__:options,query:options.query?AND(this.query,options.query):this.query}:{query:this.query})},removeAll:function(sink,options){return this.delegate.removeAll(sink,options?{__proto__:options,query:options.query?AND(this.query,options.query):this.query}:{query:this.query})},listen:function(sink,options){return this.delegate.listen(sink,options?{__proto__:options,query:options.query?AND(this.query,options.query):this.query}:{query:this.query})},toString:function(){return this.delegate+".where("+this.query+")"}}}),CLASS({name:"OrderedDAO_",extendsModel:"ProxyDAO",documentation:function(){},properties:[{name:"comparator",required:!0}],methods:{select:function(sink,options){return options?options.order||(options={__proto__:options,order:this.comparator}):options={order:this.comparator},this.delegate.select(sink,options)},toString:function(){return this.delegate+".orderBy("+this.comparator+")"}}}),CLASS({name:"LimitedDAO_",extendsModel:"ProxyDAO",documentation:function(){},properties:[{name:"count",required:!0}],methods:{select:function(sink,options){return options=options?"limit"in options?{__proto__:options,limit:Math.min(this.count,options.limit)}:{__proto__:options,limit:this.count}:{limit:this.count},this.delegate.select(sink,options)},toString:function(){return this.delegate+".limit("+this.count+")"}}}),CLASS({name:"SkipDAO_",extendsModel:"ProxyDAO",documentation:function(){},properties:[{name:"skip",required:!0,postSet:function(){this.skip!==Math.floor(this.skip)&&console.warn("skip() called with non-integer value: "+this.skip)}}],methods:{select:function(sink,options){return options=options?{__proto__:options,skip:this.skip}:{__proto__:options,skip:this.skip},this.delegate.select(sink,options)},toString:function(){return this.delegate+".skip("+this.skip+")"}}}),CLASS({name:"EasyDAO",extendsModel:"ProxyDAO",requires:["foam.core.dao.StorageDAO","foam.core.dao.MigrationDAO"],help:"A facade for easy DAO setup.",documentation:function(){},properties:[{name:"name",defaultValueFn:function(){return this.model.plural},documentation:"The developer-friendly name for this $$DOC{ref:'.'}."},{model_:"BooleanProperty",name:"seqNo",defaultValue:!1,documentation:"Have $$DOC{ref:'.'} use a sequence number to index items. Note that $$DOC{ref:'.seqNo'} and $$DOC{ref:'.guid'} features are mutually exclusive."},{model_:"BooleanProperty",name:"guid",label:"GUID",defaultValue:!1,documentation:"Have $$DOC{ref:'.'} generate guids to index items. Note that $$DOC{ref:'.seqNo'} and $$DOC{ref:'.guid'} features are mutually exclusive."},{name:"seqProperty",type:"Property",documentation:"The property on your items to use to store the sequence number or guid. This is required for $$DOC{ref:'.seqNo'} or $$DOC{ref:'.guid'} mode."},{model_:"BooleanProperty",name:"cache",defaultValue:!1,documentation:"Enable local caching of the $$DOC{ref:'DAO'}."},{model_:"BooleanProperty",name:"logging",defaultValue:!1,documentation:"Enable logging on the $$DOC{ref:'DAO'}."},{model_:"BooleanProperty",name:"timing",defaultValue:!1,documentation:"Enable time tracking for concurrent $$DOC{ref:'DAO'} operations."},{name:"daoType",defaultValue:"IDBDAO",documentation:function(){}},{model_:"BooleanProperty",name:"autoIndex",defaultValue:!1,documentation:"Automatically generate an index."},{model_:"ArrayProperty",name:"migrationRules",subType:"foam.core.dao.MigrationRule",documentation:"Creates an internal $$DOC{ref:'MigrationDAO'} and applies the given array of $$DOC{ref:'MigrationRule'}."}],constants:{ALIASES:{IDB:"IDBDAO",LOCAL:"foam.core.dao.StorageDAO",SYNC:"foam.core.dao.StorageDAO"}},methods:{init:function(args){this.SUPER(args),window.chrome&&chrome.storage&&(this.ALIASES.LOCAL="foam.core.dao.ChromeStorageDAO",this.ALIASES.SYNC="foam.core.dao.ChromeSyncStorageDAO");
var daoType="string"==typeof this.daoType?this.ALIASES[this.daoType]||this.daoType:this.daoType,daoModel="string"==typeof daoType?this.X.lookup(daoType):daoType,params={model:this.model,autoIndex:this.autoIndex};this.name&&(params.name=this.name),(this.seqNo||this.guid)&&(params.property=this.seqProperty);var dao=daoModel.create(params);if(MDAO.isInstance(dao)?this.mdao=dao:(this.migrationRules&&this.migrationRules.length&&(dao=this.X.MigrationDAO.create({delegate:dao,rules:this.migrationRules,name:this.model.name+"_"+daoModel.name+"_"+this.name},this.Y)),this.cache&&(this.mdao=MDAO.create(params),dao=CachingDAO.create({cache:this.mdao,src:dao,model:this.model}))),this.seqNo&&this.guid)throw"EasyDAO 'seqNo' and 'guid' features are mutually exclusive.";if(this.seqNo){var args={__proto__:params,delegate:dao,model:this.model};this.seqProperty&&(args.property=this.seqProperty),dao=SeqNoDAO.create(args)}if(this.guid){var args={__proto__:params,delegate:dao,model:this.model};this.seqProperty&&(args.property=this.seqProperty),dao=GUIDDAO.create(args)}this.timing&&(dao=TimingDAO.create(this.name+"DAO",dao)),this.logging&&(dao=LoggingDAO.create(dao)),this.delegate=dao},addIndex:function(){return this.mdao&&this.mdao.addIndex.apply(this.mdao,arguments),this},addRawIndex:function(){return this.mdao&&this.mdao.addRawIndex.apply(this.mdao,arguments),this}}}),CLASS({name:"NullDAO",help:"A DAO that stores nothing and does nothing.",methods:{put:function(obj,sink){sink&&sink.put&&sink.put(obj)},remove:function(obj,sink){sink&&sink.remove&&sink.remove(obj)},select:function(sink){return sink&&sink.eof&&sink.eof(),aconstant(sink||[].sink)},find:function(q,sink){sink&&sink.error&&sink.error("find",q)},listen:function(){},removeAll:function(){},unlisten:function(){},pipe:function(){},where:function(){return this},limit:function(){return this},skip:function(){return this}}}),CLASS({name:"BusyStatusDAO",extendsModel:"ProxyDAO",imports:["busyStatus"],methods:{wrapSink:function(op,sink){var comp=this.busyStatus.start(),mysink={error:function(){comp(),sink&&sink.error&&sink.error.apply(sink,arguments)},eof:"select"===op||"removeAll"===op?function(){comp(),sink&&sink.eof&&sink.eof()}:sink&&sink.eof&&sink.eof.bind(sink),put:"put"===op||"find"===op?function(x){comp(),sink&&sink.put&&sink.put(x)}:sink&&sink.put&&sink.put.bind(sink),remove:"remove"===op?function(x){comp(),sink&&sink.remove&&sink.remove(x)}:sink&&sink.remove&&sink.remove.bind(sink)};return mysink},select:function(sink,options){return this.delegate.select(this.wrapSink("select",sink||[].sink),options)},put:function(obj,sink){this.delegate.put(obj,this.wrapSink("put",sink))},remove:function(obj,sink){this.delegate.remove(obj,this.wrapSink("remove",sink))},find:function(obj,sink){this.delegate.find(obj,this.wrapSink("find",sink))},removeAll:function(sink,options){return this.delegate.removeAll(this.wrapSink("removeAll",sink),options)}}}),CLASS({name:"ContextualizingDAO",extendsModel:"ProxyDAO",methods:{find:function(id,sink){var X=this.Y;this.delegate.find(id,{put:function(o){o.X=X,sink&&sink.put&&sink.put(o)},error:function(){sink&&sink.error&&sink.error.apply(sink,arguments)}})}}}),CLASS({name:"IDBDAO",label:"IndexedDB DAO",extendsModel:"AbstractDAO",properties:[{name:"model",type:"Model",required:!0},{name:"name",label:"Store Name",type:"String",defaultValueFn:function(){return this.model.plural}},{model_:"BooleanProperty",name:"useSimpleSerialization",defaultValue:!0},{model_:"StringArrayProperty",name:"indicies"}],methods:{init:function(){this.SUPER(),this.useSimpleSerialization?(this.serialize=this.SimpleSerialize,this.deserialize=this.SimpleDeserialize):(this.serialize=this.FOAMSerialize,this.deserialize=this.FOAMDeserialize),this.withDB=amemo(this.openDB.bind(this))},FOAMDeserialize:function(json){return JSONToObject.visitObject(json)},FOAMSerialize:function(obj){return ObjectToJSON.visitObject(obj)},SimpleDeserialize:function(json){return this.model.create(json)},SimpleSerialize:function(obj){var s={};for(var key in obj.instance_){var prop=obj.model_.getProperty(key);prop["transient"]||(s[key]=obj.instance_[key])}return s},openDB:function(cc){var indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB,request=indexedDB.open("FOAM:"+this.name,1);request.onupgradeneeded=function(e){for(var store=e.target.result.createObjectStore(this.name),i=0;i<this.indicies.length;i++)store.createIndex(this.indicies[i][0],this.indicies[i][0],{unique:this.indicies[i][1]})}.bind(this),request.onsuccess=function(e){cc(e.target.result)}.bind(this),request.onerror=function(e){console.log("************** failure",e)}},withStore:function(mode,fn){if("readwrite"!==mode)return this.withStore_(mode,fn);var self=this;if(this.q_)this.q_.push(fn),1e4==this.q_.length&&(this.q_=void 0);else{var q=[fn];this.q_=q,EventService.async(function(){self.withStore_(mode,function(store){self.q_==q&&(self.q_=void 0);for(var i=0;i<q.length;i++)q[i](store)})},this.X)()}},withStore_:function(mode,fn){if(GLOBAL.__TXN__&&GLOBAL.__TXN__.store)try{return void fn.call(this,__TXN__.store)}catch(x){GLOBAL.__TXN__=void 0}this.withDB(function(db){var tx=db.transaction([this.name],mode),os=tx.objectStore(this.name);GLOBAL.__TXN__&&(GLOBAL.__TXN__.store=os),fn.call(this,os)}.bind(this))},put:function(value,sink){var self=this;this.withStore("readwrite",function(store){var request=store.put(self.serialize(value),value[self.model.ids[0]]);request.transaction.addEventListener("complete",function(e){self.notify_("put",[value]),sink&&sink.put&&sink.put(value)}),request.transaction.addEventListener("error",function(e){sink&&sink.error&&sink.error("put",value)})})},find:function(key,sink){if(Expr.isInstance(key)){var found=!1;return void this.limit(1).where(key).select({put:function(){found=!0,sink.put.apply(sink,arguments)},eof:function(){found||sink.error("find",key)}})}var self=this;this.withStore("readonly",function(store){var request=store.get(key);request.transaction.addEventListener("complete",function(){if(!request.result)return void(sink&&sink.error&&sink.error("find",key));var result=self.deserialize(request.result);sink&&sink.put&&sink.put(result)}),request.onerror=function(e){sink&&sink.error&&sink.error("find",key)}})},remove:function(obj,sink){var self=this,key=void 0!=obj[this.model.ids[0]]?obj[this.model.ids[0]]:obj;this.withStore("readwrite",function(store){var getRequest=store.get(key);getRequest.onsuccess=function(e){if(!getRequest.result)return void(sink&&sink.error&&sink.error("remove",obj));var data=self.deserialize(getRequest.result),delRequest=store["delete"](key);delRequest.transaction.addEventListener("complete",function(e){self.notify_("remove",[data]),sink&&sink.remove&&sink.remove(data)}),delRequest.onerror=function(e){sink&&sink.error&&sink.error("remove",e)}},getRequest.onerror=function(e){sink&&sink.error&&sink.error("remove",e)}})},removeAll:function(sink,options){var query=options&&options.query&&options.query.partialEval()||{f:function(){return!0}},future=afuture(),self=this;return options||sink&&sink.remove?(this.withStore("readwrite",function(store){var request=store.openCursor();request.onsuccess=function(e){var cursor=e.target.result;if(cursor){var value=self.deserialize(cursor.value);if(query.f(value)){var deleteReq=cursor["delete"]();deleteReq.transaction.addEventListener("complete",function(){self.notify_("remove",[value]),sink&&sink.remove&&sink.remove(value)}),deleteReq.onerror=function(e){sink&&sink.error&&sink.error("remove",e)}}cursor["continue"]()}},request.transaction.oncomplete=function(){sink&&sink.eof&&sink.eof(),future.set(sink)},request.onerror=function(e){sink&&sink.error&&sink.error("remove",e)}}),future.get):(this.withStore("readwrite",function(store){var req=store.clear();req.onsuccess=function(){future.set()},req.onerror=function(){future.set()}}),future.get)},select:function(sink,options){sink=sink||[].sink,sink=this.decorateSink_(sink,options,!1);var fc=this.createFlowControl_(),future=afuture(),self=this;return this.withStore("readonly",function(store){if(options&&options.query&&EqExpr.isInstance(options.query)&&store.indexNames.contains(options.query.arg1.name))var request=store.index(options.query.arg1.name).openCursor(IDBKeyRange.only(options.query.arg2.f()));else var request=store.openCursor();request.onsuccess=function(e){var cursor=e.target.result;if(!fc.stopped){if(fc.errorEvt)return sink.error&&sink.error(fc.errorEvt),void future.set(sink,fc.errorEvt);if(!cursor)return sink.eof&&sink.eof(),void future.set(sink);var value=self.deserialize(cursor.value);sink.put(value),cursor["continue"]()}},request.onerror=function(e){sink.error&&sink.error(e)}}),future.get},addIndex:function(prop){return this.indicies.push([prop.name,!1]),this}},listeners:[{name:"updated",code:function(evt){console.log("updated: ",evt),this.publish("updated")}}]}),CLASS({name:"LazyCacheDAO",extendsModel:"ProxyDAO",properties:[{name:"cache",postSet:function(old,nu){old&&this.unlisten(old),nu&&this.listen(nu)}},{model_:"BooleanProperty",name:"refreshOnCacheHit",defaultValue:!1,documentation:"When true, makes a network call in the background to update the record, even on a cache hit."},{model_:"BooleanProperty",name:"cacheOnSelect",documentation:"Whether to populate the cache on select().",defaultValue:!1},{model_:"IntProperty",name:"staleTimeout",defaultValue:500,units:"ms",documentation:"Time in milliseconds before we consider the delegate results to be stale for a particular query and will issue a new select."},{name:"finds",factory:function(){return{}}},{name:"selects",factory:function(){return{}}},{name:"selectKey",defaultValue:function(sink,options){var query=options&&options.query&&options.query.toSQL()||"",limit=options&&options.limit,skip=options&&options.skip,order=options&&options.order&&options.order.toSQL()||"";return[query,limit,skip,order]}}],methods:{find:function(id,sink){var self=this;if(this.finds[id])return void this.finds[id].push(sink);var mysink={put:this.refreshOnCacheHit?function(){self.cache.put.apply(self.cache,arguments),sink.put.apply(sink,arguments)}:sink.put.bind(sink),error:function(){return self.finds[id]?void self.finds[id].push(sink):(self.finds[id]=[sink],void self.delegate.find(id,{put:function(obj){var args=arguments;self.cache.put(obj,{put:function(){for(var finds=self.finds[id],i=0;i<finds.length;i++){var s=finds[i];s&&s.put&&s.put.apply(s,args)}delete self.finds[id]}})},error:function(){for(var finds=self.finds[id],i=0;i<finds.length;i++){var s=finds[i];s&&s.error&&s.error.apply(sink,arguments)}delete self.finds[id]}}))}};this.cache.find(id,mysink)},select:function(sink,options){function readFromCache(){self.cache.select(sink,options)(future.set)}if(!this.cacheOnSelect)return this.SUPER(sink,options);sink=sink||[].sink;var key=this.selectKey(sink,options),future=afuture(),self=this,entry=this.selects[key];return(!entry||Date.now()-this.selects[key][1]>this.staleTimeout)&&(this.selects[key]=entry=[afuture(),Date.now()],this.delegate.select(this.cache,options)(entry[0].set)),self.cache.select(COUNT(),options)(function(c){c.count>0?readFromCache():entry[0].get(readFromCache)}),future.get}}}),CLASS({name:"DAOVersion",ids:["name"],properties:["name","version"]}),function(){var pmap={};for(var key in AbstractDAO.methods)pmap[AbstractDAO.methods[key].name]=AbstractDAO.methods[key].code;defineProperties(Array.prototype,pmap)}(),defineLazyProperty(Array.prototype,"daoListeners_",function(){return{value:[],configurable:!0}});var ArraySink={__proto__:Array.prototype,put:function(obj,sink){this.push(obj),this.notify_("put",arguments),sink&&sink.put&&sink.put(obj)},clone:function(){return this.slice(0).sink},deepClone:function(){for(var a=this.slice(0),i=0;i<a.length;i++)a[i]=a[i].deepClone();return a.sink}};Object.defineProperty(Array.prototype,"dao",{get:function(){return this.__proto__=Array.prototype,this},writeable:!0}),Object.defineProperty(Array.prototype,"sink",{get:function(){return this.__proto__=ArraySink,this},writeable:!0}),defineProperties(Array.prototype,{listen:AbstractDAO.getPrototype().listen,unlisten:AbstractDAO.getPrototype().unlisten,notify_:AbstractDAO.getPrototype().notify_,deleteF:function(v){for(var a=this.clone(),i=0;i<a.length;i++)if(a[i]===v){a.splice(i,1);break}return a},deleteI:function(v){for(var i=0;i<this.length;i++)if(this[i]===v)return this.splice(i,1),!0;return!1},removeF:function(p){for(var a=this.clone(),i=0;i<a.length;i++)if(p.f(a[i])){a.splice(i,1);break}return a},removeI:function(p){for(var i=0;i<this.length;i++)p.f(this[i])&&(this.splice(i,1),breeak);return this},pushF:function(obj){var a=this.clone();return a.push(obj),a},clone:function(){return this.slice(0)},deepClone:function(){for(var a=this.slice(0),i=0;i<a.length;i++)a[i]=a[i].deepClone();return a},id:function(obj){return obj.id||obj.$UID},put:function(obj,sink){for(var idx=0;idx<this.length;idx++)if(this[idx].id===obj.id)return this[idx]=obj,sink&&sink.put&&sink.put(obj),void this.notify_("put",arguments);this.push(obj),this.notify_("put",arguments),sink&&sink.put&&sink.put(obj)},find:function(query,sink){if(query.f){for(var idx=0;idx<this.length;idx++)if(query.f(this[idx]))return void(sink&&sink.put&&sink.put(this[idx]))}else for(var idx=0;idx<this.length;idx++)if(this[idx].id===query)return void(sink&&sink.put&&sink.put(this[idx]));sink&&sink.error&&sink.error("find",query)},remove:function(obj,sink){if(!obj)return void(sink&&sink.error&&sink.error("missing key"));for(var objId=obj.id,id=void 0!==objId&&""!==objId?objId:obj,idx=0;idx<this.length;idx++)if(this[idx].id===id){var rem=this.splice(idx,1)[0];return void(sink&&sink.remove&&sink.remove(rem[0]))}sink&&sink.error&&sink.error("remove",obj)},removeAll:function(sink,options){options||(options={}),options.query||(options.query={f:function(){return!0}});for(var i=0;i<this.length;i++){var obj=this[i];if(options.query.f(obj)){var rem=this.splice(i,1)[0];sink&&sink.remove&&sink.remove(rem),i--}}return sink&&sink.eof&&sink.eof(),anop()},select:function(sink,options){sink=sink||[].sink;var hasQuery=options&&(options.query||options.order),originalsink=sink;if(sink=this.decorateSink_(sink,options,!1,!hasQuery),!hasQuery&&GLOBAL.CountExpr&&CountExpr.isInstance(sink))return sink.count=this.length,aconstant(originalsink);for(var fc=this.createFlowControl_(),start=Math.max(0,hasQuery?0:options&&options.skip||0),end=hasQuery?this.length:Math.min(this.length,start+(options&&options.limit||this.length)),i=start;end>i&&(sink.put(this[i],null,fc),!fc.stopped);i++)if(fc.errorEvt)return sink.error&&sink.error(fc.errorEvt),aconstant(originalsink,fc.errorEvt);return sink.eof&&sink.eof(),aconstant(originalsink)}});var NOT_FOUND={cost:0,execute:function(_,sink,_){return anop},toString:function(){return"no-match(cost=0)"}},NO_PLAN={cost:Number.MAX_VALUE,execute:function(){return anop},toString:function(){return"no-plan"}},ValueIndex={put:function(s,newValue){return newValue},remove:function(){return void 0},plan:function(){var plan={cost:1,execute:function(s,sink){return sink.put(s),anop},toString:function(){return"unique"}};return function(){return plan}}(),get:function(value,key){return value},select:function(value,sink,options){if(options){if(options.query&&!options.query.f(value))return;if("skip"in options&&options.skip-->0)return;if("limit"in options&&options.limit--<1)return}sink.put(value)},selectReverse:function(value,sink,options){this.select(value,sink,options)},size:function(obj){return 1},toString:function(){return"value"}},KEY=0,VALUE=1,SIZE=2,LEVEL=3,LEFT=4,RIGHT=5,TreeIndex={create:function(prop,tail){return tail=tail||ValueIndex,{__proto__:this,prop:prop,tail:tail,selectCount:0}},bulkLoad:function(a){if(this.tail===ValueIndex)return a.sort(toCompare(this.prop)),this.bulkLoad_(a,0,a.length-1);for(var s=void 0,i=0;i<a.length;i++)s=this.put(s,a[i]);return s},bulkLoad_:function(a,start,end){if(start>end)return void 0;var m=start+Math.floor((end-start+1)/2),tree=this.put(void 0,a[m]);return tree[LEFT]=this.bulkLoad_(a,start,m-1),tree[RIGHT]=this.bulkLoad_(a,m+1,end),tree[SIZE]+=this.size(tree[LEFT])+this.size(tree[RIGHT]),tree},dedup:function(obj,value){obj[this.prop.name]=value},maybeClone:function(s){return s&&this.selectCount>0?s.clone():s},put:function(s,newValue){return this.putKeyValue(s,this.prop.f(newValue),newValue)},putKeyValue:function(s,key,value){if(!s)return[key,this.tail.put(null,value),1,1];s=this.maybeClone(s);var r=this.compare(s[KEY],key);if(0===r)this.dedup(value,s[KEY]),s[SIZE]-=this.tail.size(s[VALUE]),s[VALUE]=this.tail.put(s[VALUE],value),s[SIZE]+=this.tail.size(s[VALUE]);else{var side=r>0?LEFT:RIGHT;s[side]&&(s[SIZE]-=s[side][SIZE]),s[side]=this.putKeyValue(s[side],key,value),s[SIZE]+=s[side][SIZE]}return this.split(this.skew(s))},skew:function(s){if(s&&s[LEFT]&&s[LEFT][LEVEL]===s[LEVEL]){var l=this.maybeClone(s[LEFT]);return s[LEFT]=l[RIGHT],l[RIGHT]=s,this.updateSize(s),this.updateSize(l),l}return s},updateSize:function(s){s[SIZE]=this.size(s[LEFT])+this.size(s[RIGHT])+this.tail.size(s[VALUE])},split:function(s){if(s&&s[RIGHT]&&s[RIGHT][RIGHT]&&s[LEVEL]===s[RIGHT][RIGHT][LEVEL]){var r=this.maybeClone(s[RIGHT]);return s[RIGHT]=r[LEFT],r[LEFT]=s,r[LEVEL]++,this.updateSize(s),this.updateSize(r),r}return s},remove:function(s,value){return this.removeKeyValue(s,this.prop.f(value),value)},removeKeyValue:function(s,key,value){if(!s)return s;s=this.maybeClone(s);var r=this.compare(s[KEY],key);if(0===r){if(s[SIZE]-=this.tail.size(s[VALUE]),s[VALUE]=this.tail.remove(s[VALUE],value),s[VALUE])return s[SIZE]+=this.tail.size(s[VALUE]),s;if(!s[LEFT]&&!s[RIGHT])return void 0;var side=s[LEFT]?LEFT:RIGHT,l=side===LEFT?this.predecessor(s):this.successor(s);s[KEY]=l[KEY],s[VALUE]=l[VALUE],s[side]=this.removeNode(s[side],l[KEY])}else{var side=r>0?LEFT:RIGHT;s[SIZE]-=this.size(s[side]),s[side]=this.removeKeyValue(s[side],key,value),s[SIZE]+=this.size(s[side])}return s=this.skew(this.decreaseLevel(s)),s[RIGHT]&&(s[RIGHT]=this.skew(this.maybeClone(s[RIGHT])),s[RIGHT][RIGHT]&&(s[RIGHT][RIGHT]=this.skew(this.maybeClone(s[RIGHT][RIGHT])))),s=this.split(s),s[RIGHT]=this.split(this.maybeClone(s[RIGHT])),s},removeNode:function(s,key){if(!s)return s;s=this.maybeClone(s);var r=this.compare(s[KEY],key);if(0===r)return s[LEFT]?s[LEFT]:s[RIGHT];var side=r>0?LEFT:RIGHT;return s[SIZE]-=this.size(s[side]),s[side]=this.removeNode(s[side],key),s[SIZE]+=this.size(s[side]),s},predecessor:function(s){if(!s[LEFT])return s;for(s=s[LEFT];s[RIGHT];s=s[RIGHT]);return s},successor:function(s){if(!s[RIGHT])return s;for(s=s[RIGHT];s[LEFT];s=s[LEFT]);return s},decreaseLevel:function(s){var expectedLevel=Math.min(s[LEFT]?s[LEFT][LEVEL]:0,s[RIGHT]?s[RIGHT][LEVEL]:0)+1;return expectedLevel<s[LEVEL]&&(s[LEVEL]=expectedLevel,s[RIGHT]&&expectedLevel<s[RIGHT][LEVEL]&&(s[RIGHT]=this.maybeClone(s[RIGHT]),s[RIGHT][LEVEL]=expectedLevel)),s},get:function(s,key){if(!s)return void 0;var r=this.compare(s[KEY],key);return 0===r?s[VALUE]:this.get(r>0?s[LEFT]:s[RIGHT],key)},select:function(s,sink,options){if(s){if(options){if("limit"in options&&options.limit<=0)return;var size=this.size(s);if(options.skip>=size&&!options.query)return void(options.skip-=size)}this.select(s[LEFT],sink,options),this.tail.select(s[VALUE],sink,options),this.select(s[RIGHT],sink,options)}},selectReverse:function(s,sink,options){if(s){if(options){if("limit"in options&&options.limit<=0)return;var size=this.size(s);if(options.skip>=size)return void(options.skip-=size)}this.selectReverse(s[RIGHT],sink,options),this.tail.selectReverse(s[VALUE],sink,options),this.selectReverse(s[LEFT],sink,options)}},findPos:function(s,key,incl){if(!s)return 0;var r=this.compare(s[KEY],key);return 0===r?incl?this.size(s[LEFT]):this.size(s)-this.size(s[RIGHT]):r>0?this.findPos(s[LEFT],key,incl):this.findPos(s[RIGHT],key,incl)+this.size(s)-this.size(s[RIGHT])},size:function(s){return s?s[SIZE]:0},compare:function(o1,o2){return this.prop.compareProperty(o1,o2)},plan:function(s,sink,options){var query=options&&options.query;if(query===FALSE)return NOT_FOUND;if(!query&&CountExpr.isInstance(sink)){var count=this.size(s);return{cost:0,execute:function(unused,sink,options){return sink.count+=count,anop},toString:function(){return"short-circuit-count("+count+")"}}}var prop=this.prop,isExprMatch=function(model){if(query){if(model.isInstance(query)&&query.arg1===prop){var arg2=query.arg2;return query=void 0,arg2}if(AndExpr.isInstance(query))for(var i=0;i<query.args.length;i++){var q=query.args[i];if(model.isInstance(q)&&q.arg1===prop)return query=query.clone(),query.args[i]=TRUE,query=query.partialEval(),query===TRUE&&(query=null),q.arg2}}return void 0},index=this,arg2=isExprMatch(InExpr);if(arg2&&Math.log(this.size(s))/Math.log(2)*arg2.length<this.size(s)){var keys=arg2,subPlans=[],results=[],cost=1,newOptions={};query&&(newOptions.query=query),"limit"in options&&(newOptions.limit=options.limit),"skip"in options&&(newOptions.skip=options.skip),"order"in options&&(newOptions.order=options.order);for(var i=0;i<keys.length;i++){var result=this.get(s,keys[i]);if(result){var subPlan=this.tail.plan(result,sink,newOptions);cost+=subPlan.cost,subPlans.push(subPlan),results.push(result)}}return 0==subPlans.length?NOT_FOUND:{cost:1+cost,execute:function(s2,sink,options){for(var pars=[],i=0;i<subPlans.length;i++)pars.push(subPlans[i].execute(results[i],sink,newOptions));return apar.apply(null,pars)},toString:function(){return"IN(key="+prop.name+", size="+results.length+")"}}}if(arg2=isExprMatch(EqExpr),void 0!=arg2){var key=arg2.f(),result=this.get(s,key);if(!result)return NOT_FOUND;var newOptions={};query&&(newOptions.query=query),"limit"in options&&(newOptions.limit=options.limit),"skip"in options&&(newOptions.skip=options.skip),"order"in options&&(newOptions.order=options.order);var subPlan=this.tail.plan(result,sink,newOptions);return{cost:1+subPlan.cost,execute:function(s2,sink,options){return subPlan.execute(result,sink,newOptions)},toString:function(){return"lookup(key="+prop.name+", cost="+this.cost+(query&&query.toSQL?", query: "+query.toSQL():"")+") "+subPlan.toString()}}}if(arg2=isExprMatch(GtExpr),void 0!=arg2){var key=arg2.f(),pos=this.findPos(s,key,!1),newOptions={skip:(options&&options.skip||0)+pos};query&&(newOptions.query=query),"limit"in options&&(newOptions.limit=options.limit),"order"in options&&(newOptions.order=options.order),options=newOptions}if(arg2=isExprMatch(GteExpr),void 0!=arg2){var key=arg2.f(),pos=this.findPos(s,key,!0),newOptions={skip:(options&&options.skip||0)+pos};query&&(newOptions.query=query),"limit"in options&&(newOptions.limit=options.limit),"order"in options&&(newOptions.order=options.order),options=newOptions}if(arg2=isExprMatch(LtExpr),void 0!=arg2){var key=arg2.f(),pos=this.findPos(s,key,!0),newOptions={limit:pos-(options&&options.skip)||0};query&&(newOptions.query=query),"limit"in options&&(newOptions.limit=Math.min(options.limit,newOptions.limit)),"skip"in options&&(newOptions.skip=options.skip),"order"in options&&(newOptions.order=options.order),options=newOptions}if(arg2=isExprMatch(LteExpr),void 0!=arg2){var key=arg2.f(),pos=this.findPos(s,key,!1),newOptions={limit:pos-(options&&options.skip)||0};query&&(newOptions.query=query),"limit"in options&&(newOptions.limit=Math.min(options.limit,newOptions.limit)),"skip"in options&&(newOptions.skip=options.skip),"order"in options&&(newOptions.order=options.order),options=newOptions}var cost=this.size(s),sortRequired=!1,reverseSort=!1;return options&&options.order&&(options.order===prop||(DescExpr.isInstance(options.order)&&options.order.arg1===prop?reverseSort=!0:(sortRequired=!0,0!=cost&&(cost*=Math.log(cost)/Math.log(2))))),options&&!sortRequired&&(options.skip&&(cost-=options.skip),options.limit&&(cost=Math.min(cost,options.limit))),{cost:cost,execute:function(){if(sortRequired){var a=[];index.selectCount++,index.select(s,a,{query:options.query}),index.selectCount--,a.sort(toCompare(options.order));var skip=options.skip||0,limit=Number.isFinite(options.limit)?options.limit:a.length;limit+=skip,limit=Math.min(a.length,limit);for(var i=skip;limit>i;i++)sink.put(a[i])}else index.selectCount++,reverseSort?index.selectReverse(s,sink,options):index.select(s,sink,options),index.selectCount--;return anop},toString:function(){return"scan(key="+prop.name+", cost="+this.cost+(query&&query.toSQL?", query: "+query.toSQL():"")+")"}}},toString:function(){return"TreeIndex("+this.prop.name+", "+this.tail+")"}},CITreeIndex={__proto__:TreeIndex,create:function(prop,tail){return tail=tail||ValueIndex,{__proto__:this,prop:prop,tail:tail}},put:function(s,newValue){return this.putKeyValue(s,this.prop.f(newValue).toLowerCase(),newValue)},remove:function(s,value){return this.removeKeyValue(s,this.prop.f(value).toLowerCase(),value)}},SetIndex={__proto__:TreeIndex,create:function(prop,tail){return tail=tail||ValueIndex,{__proto__:this,prop:prop,tail:tail}},dedup:function(obj,value){},put:function(s,newValue){var a=this.prop.f(newValue);if(a.length)for(var i=0;i<a.length;i++)s=this.putKeyValue(s,a[i],newValue);else s=this.putKeyValue(s,"",newValue);return s},remove:function(s,value){var a=this.prop.f(value);if(a.length)for(var i=0;i<a.length;i++)s=this.removeKeyValue(s,a[i],value);else s=this.removeKeyValue(s,"",value);return s}},PositionQuery={create:function(args){return{__proto__:this,skip:args.skip,limit:args.limit,s:args.s}},reduce:function(other){var otherFinish=other.skip+other.limit,myFinish=this.skip+this.limit;return other.skip>myFinish?null:other.skip>=this.skip?PositionQuery.create({skip:this.skip,limit:Math.max(myFinish,otherFinish)-this.skip,s:this.s}):other.reduce(this)},equals:function(other){return this.skip===other.skip&&this.limit===other.limit}},AutoPositionIndex={create:function(factory,mdao,networkdao,maxage){var obj={__proto__:this,factory:factory,maxage:maxage,dao:mdao,networkdao:networkdao,sets:[],alt:AltIndex.create()};return obj},put:function(s,value){return this.alt.put(s,value)},remove:function(s,value){return this.alt.remove(s,value)},bulkLoad:function(a){return[]},addIndex:function(s,index){return this},addPosIndex:function(s,options){var index=PositionIndex.create(options&&options.order,options&&options.query,this.factory,this.dao,this.networkdao,this.queue,this.maxage);this.alt.delegates.push(index),s.push(index.bulkLoad([]))},hasIndex:function(options){for(var i=0;i<this.sets.length;i++){var set=this.sets[i];if(set[0].equals(options&&options.query||"")&&set[1].equals(options&&options.order||""))return!0}return!1},plan:function(s,sink,options){var subPlan=this.alt.plan(s,sink,options);return subPlan!=NO_PLAN?subPlan:options&&null!=options.skip&&null!=options.limit||CountExpr.isInstance(sink)?this.hasIndex(options)?NO_PLAN:(this.sets.push([options&&options.query||"",options&&options.order||""]),this.addPosIndex(s,options),this.alt.plan(s,sink,options)):NO_PLAN}},PositionIndex={create:function(order,query,factory,dao,networkdao,queue,maxage){var obj={__proto__:this,order:order||"",query:query||"",factory:factory,dao:dao,networkdao:networkdao.where(query).orderBy(order),maxage:maxage,queue:arequestqueue(function(ret,request){var s=request.s;obj.networkdao.skip(request.skip).limit(request.limit).select()(function(objs){for(var now=Date.now(),i=0;i<objs.length;i++)s[request.skip+i]={obj:objs[i].id,timestamp:now},s.feedback=objs[i].id,obj.dao.put(objs[i]),s.feedback=null;ret()})},void 0,1)};return obj},put:function(s,newValue){if(s.feedback===newValue.id)return s;if(this.query&&!this.query.f(newValue))return s;for(var compare=toCompare(this.order),i=0;i<s.length;i++){var entry=s[i];if(entry){if(this.dao.find(entry.obj,{put:function(o){entry=o}}),entry.id===newValue.id)break;if(compare(entry,newValue)>0){for(var j=s.length;j>i;j--)s[j]=s[j-1];(0==i||s[i-1])&&(s[i]={obj:newValue.id,timestamp:Date.now()});break}}}return s},remove:function(s,obj){if(s.feedback===obj.id)return s;for(var i=0;i<s.length;i++)if(s[i]&&s[i].obj===obj.id){for(var j=i;j<s.length-1;j++)s[j]=s[j+1];break}return s},bulkLoad:function(a){return[]},plan:function(s,sink,options){var order=options&&options.order||"",query=options&&options.query||"",skip=options&&options.skip,limit=options&&options.limit,self=this;if(!order.equals(this.order)||!query.equals(this.query))return NO_PLAN;if(CountExpr.isInstance(sink))return{cost:0,execute:function(s,sink,options){return s.count||(s.count=amemo(function(ret){self.networkdao.select(COUNT())(function(c){ret(c)})},self.maxage)),function(ret,count){sink.copyFrom(count),ret()}.ao(s.count)},toString:function(){return"position-index(cost="+this.cost+", count)"}};if(void 0==skip||void 0==limit)return NO_PLAN;var threshold=Date.now()-this.maxage;return{cost:0,toString:function(){return"position-index(cost="+this.cost+")"},execute:function(s,sink,options){for(var objs=[],min,max,i=0;limit>i;i++){var o=s[i+skip];(!o||o.timestamp<threshold)&&(void 0==min&&(min=i+skip),max=i+skip),o?self.dao.find(o.obj,{put:function(obj){objs[i]=obj}}):objs[i]=self.factory(),!objs[i]}void 0!=min&&self.queue(PositionQuery.create({skip:min,limit:max-min+1,s:s}));for(var i=0;i<objs.length;i++)sink.put(objs[i]);return anop}}}},AltIndex={GOOD_ENOUGH_PLAN:10,create:function(){return{__proto__:this,delegates:argsToArray(arguments)}},addIndex:function(s,index){var a=[];return this.plan(s,a).execute(s,a),s.push(index.bulkLoad(a)),this.delegates.push(index),this},bulkLoad:function(a){for(var i=0;i<this.delegates.length;i++)this.root[i]=this.delegates[i].bulkLoad(a)},get:function(s,key){return this.delegates[0].get(s[0],key)},put:function(s,newValue){s=s||[].sink;for(var i=0;i<this.delegates.length;i++)s[i]=this.delegates[i].put(s[i],newValue);return s},remove:function(s,obj){s=s||[].sink;for(var i=0;i<this.delegates.length;i++)s[i]=this.delegates[i].remove(s[i],obj);return s},plan:function(s,sink,options){for(var bestPlan,bestPlanI=0,i=0;i<this.delegates.length;i++){var plan=this.delegates[i].plan(s[i],sink,options);if(plan.cost<=AltIndex.GOOD_ENOUGH_PLAN){bestPlanI=i,bestPlan=plan;break}(!bestPlan||plan.cost<bestPlan.cost)&&(bestPlanI=i,bestPlan=plan)}return void 0==bestPlan||bestPlan==NO_PLAN?NO_PLAN:{__proto__:bestPlan,execute:function(unused,sink,options){return bestPlan.execute(s[bestPlanI],sink,options)}}},size:function(obj){return this.delegates[0].size(obj[0])},toString:function(){return"Alt("+this.delegates.join(",")+")"}},mLangIndex={create:function(mlang){return{__proto__:this,mlang:mlang,PLAN:{cost:0,execute:function(s,sink,options){return sink.copyFrom(s),anop},toString:function(){return"mLangIndex("+this.s+")"}}}},bulkLoad:function(a){return a.select(this.mlang),this.mlang},put:function(s,newValue){return s=s||this.mlang.clone(),s.put(newValue),s},remove:function(s,obj){return s=s||this.mlang.clone(),s.remove&&s.remove(obj),s},size:function(s){return Number.MAX_VALUE},plan:function(s,sink,options){return options&&options.query?NO_PLAN:sink.model_&&sink.model_.isInstance(s)&&s.arg1===sink.arg1?(this.PLAN.s=s,this.PLAN):NO_PLAN},toString:function(){return"mLangIndex("+this.mlang+")"}},AutoIndex={create:function(mdao){return{__proto__:this,properties:{id:!0},mdao:mdao}},put:function(s,newValue){return s},remove:function(s,obj){return s},bulkLoad:function(a){return"auto"},addIndex:function(prop){DescExpr.isInstance(prop)&&(prop=prop.arg1),console.log("Adding AutoIndex : ",prop.name),this.properties[prop.name]=!0,this.mdao.addIndex(prop)},plan:function(s,sink,options){return options&&(options.order&&Property.isInstance(options.order)&&!this.properties[options.order.name]?this.addIndex(options.order):options.query),NO_PLAN},toString:function(){return"AutoIndex()"}},MDAO=Model.create({extendsModel:"AbstractDAO",name:"MDAO",label:"Indexed DAO",properties:[{name:"model",type:"Model",required:!0},{model_:"BooleanProperty",name:"autoIndex",defaultValue:!1}],methods:{init:function(){this.SUPER(),this.map={},this.index=TreeIndex.create(this.model.getProperty(this.model.ids[0])),this.autoIndex&&this.addRawIndex(AutoIndex.create(this))
},addIndex:function(){for(var props=argsToArray(arguments),i=0;i<this.model.ids.length;i++)if(props.push(this.model.getProperty(this.model.ids[i])),!props[props.length-1])throw"Undefined index property";return this.addUniqueIndex.apply(this,props)},addUniqueIndex:function(){for(var index=ValueIndex,i=arguments.length-1;i>=0;i--){var prop=arguments[i],proto="Array[]"==prop.type?SetIndex:TreeIndex;index=proto.create(prop,index)}return this.addRawIndex(index)},addRawIndex:function(index){return this.index.delegates||(this.index=AltIndex.create(this.index),this.root=[this.root]),this.index.addIndex(this.root,index),this},bulkLoad:function(dao,sink){var self=this;dao.select({__proto__:[].sink,eof:function(){self.root=self.index.bulkLoad(this),sink&&sink.eof&&sink.eof()}})},put:function(obj,sink){var oldValue=this.map[obj.id];oldValue?(this.root=this.index.put(this.index.remove(this.root,oldValue),obj),this.notify_("remove",[oldValue])):this.root=this.index.put(this.root,obj),this.map[obj.id]=obj,this.notify_("put",[obj]),sink&&sink.put&&sink.put(obj)},findObj_:function(key,sink){var obj=this.map[key];obj?sink.put&&sink.put(obj):sink.error&&sink.error("find",key)},find:function(key,sink){if(void 0==key)return void(sink&&sink.error&&sink.error("missing key"));if(!key.f)return void this.findObj_(key,sink);var found=!1;this.where(key).limit(1).select({put:function(obj){found=!0,sink&&sink.put&&sink.put(obj)},eof:function(){found||sink&&sink.error&&sink.error("find",key)}})},remove:function(obj,sink){if(!obj)return void(sink&&sink.error&&sink.error("missing key"));var id=void 0!==obj.id&&""!==obj.id?obj.id:obj,self=this;this.find(id,{put:function(obj){self.root=self.index.remove(self.root,obj),delete self.map[obj.id],self.notify_("remove",[obj]),sink&&sink.remove&&sink.remove(obj)},error:function(){sink&&sink.error&&sink.error("remove",obj)}})},removeAll:function(sink,options){options||(options={}),options.query||(options.query=TRUE);var future=afuture();return this.where(options.query).select()(function(a){for(var i=0;i<a.length;i++)this.root=this.index.remove(this.root,a[i]),delete this.map[a[i].id],this.notify_("remove",[a[i]]),sink&&sink.remove&&sink.remove(a[i]);sink&&sink.eof&&sink.eof(),future.set(sink)}.bind(this)),future.get},select:function(sink,options){if(sink=sink||[].sink,options&&(options={__proto__:options}),ExplainExpr.isInstance(sink)){var plan=this.index.plan(this.root,sink.arg1,options);return sink.plan="cost: "+plan.cost+", "+plan.toString(),sink&&sink.eof&&sink.eof(),aconstant(sink)}var plan=this.index.plan(this.root,sink,options),future=afuture();return plan.execute(this.root,sink,options)(function(ret){sink&&sink.eof&&sink.eof(),future.set(sink)}),future.get},toString:function(){return"MDAO("+this.model.name+","+this.index+")"}}});CLASS({name:"Timer",properties:[{model_:"IntProperty",name:"interval",help:"Interval of time between updating time.",units:"ms",defaultValue:10},{model_:"IntProperty",name:"i",defaultValue:0},{model_:"FloatProperty",name:"timeWarp",defaultValue:1},{model_:"IntProperty",name:"duration",units:"ms",defaultValue:-1},{model_:"FloatProperty",name:"percent",defaultValue:0},{model_:"IntProperty",name:"startTime",defaultValue:0},{model_:"IntProperty",name:"time",help:"The current time in milliseconds since epoch.",preSet:function(_,t){return Math.ceil(t)},defaultValue:0},{model_:"IntProperty",name:"second",help:"The second of the current minute.",defaultValue:0},{model_:"IntProperty",name:"minute",help:"The minute of the current hour.",defaultValue:0},{model_:"IntProperty",name:"hour",help:"The hour of the current day.",defaultValue:0},{name:"isStarted",defaultValue:!1,hidden:!0}],actions:[{name:"start",help:"Start the timer.",isAvailable:function(){return!0},isEnabled:function(){return!this.isStarted},action:function(){this.isStarted=!0,this.tick()}},{name:"step",help:"Step the timer.",isAvailable:function(){return!0},action:function(){this.i++,this.time+=this.interval*this.timeWarp,this.second=this.time/1e3%60<<0,this.minute=this.time/6e4%60<<0,this.hour=this.time/36e5%24<<0}},{name:"stop",help:"Stop the timer.",isAvailable:function(){return!0},isEnabled:function(){return this.isStarted},action:function(){this.isStarted=!1,this.timeout&&(clearTimeout(this.timeout),this.timeout=void 0)}}],listeners:[{name:"tick",isFramed:!0,code:function(e){if(this.timeout=void 0,this.isStarted){var prevTime=this.startTime_||0;this.startTime_=Date.now(),this.interval=Math.min(100,this.startTime_-prevTime),this.step(),this.tick()}}}]}),CLASS({name:"Binding",documentation:function(){},properties:[{name:"id",hidden:!0},{name:"value",hidden:!0},{name:"version",defaultValue:1,hidden:!0}]}),CLASS({name:"PersistentContext",documentation:function(){},properties:[{name:"dao",label:"DAO",type:"DAO",hidden:!0},{name:"context",hidden:!0},{name:"predicate",type:"Expr",defaultValueFn:function(){return TRUE},hidden:!0}],methods:{manage:function(name,obj,version){obj.addListener(EventService.merged(function(){console.log("PersistentContext","updating",name),this.dao.put(this.Y.Binding.create({id:name,value:JSONUtil.where(this.predicate).stringify(obj),version:version}))}.bind(this),void 0,this.Y))},bindObjects:function(a){},clearBinding:function(ret,name){var self=this;self.dao.remove.ao(self.dao.find.bind(self.dao,name))(ret)},bindObject:function(name,factory,transientValues,version){version=version||1,console.log("PersistentContext","binding",name);var future=afuture();if(transientValues=transientValues||{},this.context[name])future.set(this.context[name]);else{var newinit=function(){console.log("PersistentContext","newInit",name);var obj=factory.create();obj.copyFrom(transientValues),this.context[name]=obj,this.manage(name,obj,version),future.set(obj)}.bind(this);this.dao.find(name,{put:function(binding){if(binding.version!==version)return console.log("PersistentContext","verison mismatch",name),void newinit();console.log("PersistentContext","existingInit",name);var json=JSON.parse(binding.value),obj=JSONUtil.mapToObj(this.Y,json);obj.copyFrom(transientValues),this.context[name]=obj,this.manage(name,obj,version),future.set(obj)}.bind(this),error:newinit})}return future.get}}}),CLASS({name:"UserInfo",label:"UserInfo",properties:[{model_:"StringProperty",name:"email"}]}),CLASS({name:"PieGraph",extendsModel:"CView",properties:[{name:"r",type:"int",view:"foam.ui.IntFieldView",postSet:function(_,r){this.width=this.height=2*r+2},defaultValue:50},{name:"lineColor",type:"String",defaultValue:"white"},{name:"lineWidth",type:"int",defaultValue:1},{name:"colorMap",defaultValue:void 0},{name:"data",type:"Array[float]",factory:function(){return[]}},{name:"groups",label:"Group Data",defaultValue:{Apples:5,Oranges:6,Bananas:4}}],methods:{toCount:function(o){return CountExpr.isInstance(o)?o.count:o},toHSLColor:function(i,n){return"hsl("+Math.floor(360*i/n)+", 95%, 75%)"},toColor:function(key,i,n){return this.colorMap&&this.colorMap[key]||this.toHSLColor(i,n)},paint:function(){var c=this.canvas;if(c){var x=this.x,y=this.y,r=this.r;c.save(),c.translate(x,y);var sum=0,n=0;for(var key in this.groups)sum+=this.toCount(this.groups[key]),n++;r>10&&(c.fillStyle="lightgray",c.beginPath(),c.arc(r+2,r+2,r,0,2*Math.PI),c.fill()),c.lineWidth=this.lineWidth,c.strokeStyle=this.lineColor;var rads=0,i=0;for(var key in this.groups){var start=rads,count=this.toCount(this.groups[key]);rads+=count/sum*2*Math.PI,c.fillStyle=this.toColor(key,i++,n),c.beginPath(),sum>count&&c.moveTo(r,r),c.arc(r,r,r,start,rads),sum>count&&c.lineTo(r,r),c.fill(),c.stroke()}c.restore()}}}}),CLASS({name:"PieExpr",extendsModel:"GroupByExpr",methods:{toCView:function(){return this.graph_||(this.graph_=PieGraph.create({groups:this.groups,r:50,x:0}),this.graph_.copyFrom(this.opt_args)),this.graph_},toHTML:function(){return this.toCView().toHTML()},initHTML:function(){this.graph_.initHTML(),this.graph_.paint()},write:function(d){d.writeln?d.writeln(this.toHTML()):d.log(this.toHTML()),this.initHTML()},put:function(obj){this.SUPER.apply(this,arguments),this.graph_&&(this.graph_.groups=this.groups,this.graph_.paint())},remove:function(){this.SUPER.apply(this,arguments),this.graph_&&this.graph_.paint()},clone:function(){var p=PieExpr.create({arg1:this.arg1,arg2:this.arg2.clone()});return p.opt_args=this.opt_args,p}}});var PIE=function(f,opt_args){var p=PieExpr.create({arg1:f,arg2:COUNT()});return p.opt_args=opt_args,p};CLASS({model_:"Model","package":"com.google.mail",name:"MobileController",extendsModel:"foam.ui.View",requires:["foam.ui.md.AppController","foam.util.busy.BusyFlagTracker","foam.util.busy.BusyStatus","CachingDAO","foam.ui.DetailView","foam.ui.layout.FloatingView","foam.input.touch.GestureManager","IDBDAO","MDAO","foam.oauth2.OAuth2Redirect as Auth","foam.input.touch.TouchManager","XHR","foam.ui.layout.CSSStackView as StackView","com.google.mail.ComposeView","com.google.mail.EMailCitationView","com.google.mail.EMailDAO","com.google.mail.EMailExtensionsAgent","com.google.mail.EMailView","com.google.mail.FOAMGMailLabel","com.google.mail.GMailRestDAO","com.google.mail.GMailUserInfo","com.google.mail.MenuView","com.google.mail.ProfileView","com.google.mail.QueryParser","foam.lib.contacts.Contact as Contact","foam.lib.contacts.ContactNetworkDAO as ContactNetworkDAO","foam.lib.email.EMail","foam.ui.md.ResponsiveAppControllerView"],imports:["setInterval"],exports:["XHR","touchManager","gestureManager","contactDAO as ContactDAO","labelDao as LabelDAO","emailDao as EMailDAO","profile$ as profile$","as controller","stack","openComposeView"],traits:["foam.ui.layout.PositionedDOMViewTrait"],properties:[{model_:"Property",name:"XHR",factory:function(){return XHR.xbind({authAgent:this.oauth,retries:3,delay:10})}},{model_:"Property",name:"jsonpFuture",factory:function(){return deferJsonP(this.X)}},{model_:"Property",name:"touchManager",factory:function(){return this.TouchManager.create()}},{model_:"Property",name:"busyStatus",factory:function(){return this.BusyStatus.create()}},{model_:"Property",name:"gestureManager",factory:function(){return this.GestureManager.create()}},{model_:"Property",name:"oauth",factory:function(){return this.Auth.create({clientId:"945476427475-oaso9hq95r8lnbp2rruo888rl3hmfuf8.apps.googleusercontent.com",clientSecret:"GTkp929u268_SXAiHitESs-1",scopes:["https://www.googleapis.com/auth/userinfo.profile","https://www.googleapis.com/auth/userinfo.email","https://mail.google.com/","https://www.google.com/m8/feeds"]})},postSet:function(_,v){v.setJsonpFuture(this.X,this.jsonpFuture)}},{model_:"Property",name:"controller",type:"foam.ui.md.AppController",postSet:function(_,controller){var Y=this.controller.Y.sub(),view=this.ResponsiveAppControllerView.create({data:this.controller},Y);this.stack.setTopView(view),view.onResize()}},{model_:"Property",name:"emailDao",factory:function(){return this.EMailDAO.create()},postSet:function(_,dao){dao.sync&&this.BusyFlagTracker.create({busyStatus:this.busyStatus,target:dao.sync.syncing$})}},{model_:"Property",name:"labelDao",type:"DAO",factory:function(){return this.CachingDAO.create({src:this.GMailRestDAO.create({model:this.FOAMGMailLabel,modelName:"labels"}),delegate:this.MDAO.create({model:this.FOAMGMailLabel})})}},{model_:"Property",name:"contactDAO",factory:function(){return this.CachingDAO.create({src:this.ContactNetworkDAO.create(),delegate:this.IDBDAO.create({model:this.Contact,useSimpleSerialization:!1})})}},{model_:"Property",name:"stack",subType:"foam.ui.StackView",factory:function(){return this.StackView.create(null,this.Y)},postSet:function(old,v){old&&(Events.unfollow(this.width$,old.width$),Events.unfollow(this.height$,old.height$)),Events.follow(this.width$,v.width$),Events.follow(this.height$,v.height$)}},{model_:"Property",name:"profile"}],actions:[{model_:"Action",name:"compose",label:"+",action:function(){var view=this.X.foam.ui.layout.FloatingView.create({view:this.X.com.google.mail.ComposeView.create({data:this.X.foam.lib.email.EMail.create({id:"draft_"+Math.floor(4294967295*Math.random()).toString(16),labels:["DRAFT"]})},this.Y)});this.X.stack.pushView(view,void 0,void 0,"fromRight")}}],constants:[{model_:"Constant",name:"SYNC_INTERVAL",value:3e4}],methods:{init:function(args){this.SUPER(args),this.EMailExtensionsAgent.create().execute();var xhr=this.Y.XHR.create({responseType:"json"});aseq(function(ret){xhr.asend(ret,"https://www.googleapis.com/oauth2/v1/userinfo")})(function(resp){var user=this.GMailUserInfo.create();user.fromJSON(resp),this.profile=user}.bind(this))},openComposeView:function(X,email){var view=X.foam.ui.layout.FloatingView.create({view:this.ComposeView.create({data:email},this.controller.Y)});this.stack.pushView(view,void 0,void 0,"fromRight")},toHTML:function(){return this.stack.toHTML()},initHTML:function(){this.stack.initHTML();var toTop=function(id){return{compare:function(o1,o2){return o1.id==id?-1:o2.id==id?1:0}}};if(this.emailDao.withSync)var sync=this.emailDao.sync;var self=this;this.controller=this.AppController.create({model:this.EMail,dao:this.emailDao,createAction:this.model_.COMPOSE,citationView:"com.google.mail.EMailCitationView",queryParser:this.QueryParser.create().parser,editableCitationViews:!0,busyStatus:this.busyStatus,sortChoices:[[DESC(this.EMail.TIMESTAMP),"Newest First"],[this.EMail.TIMESTAMP,"Oldest First"],[this.EMail.SUBJECT,"Subject"]],refreshAction:Action.create({name:"refresh",label:"",iconUrl:"icons/ic_refresh_48px.svg",isEnabled:function(){return!(sync&&sync.syncing)},action:function(){sync&&sync.sync()}}),menuFactory:function(){return self.MenuView.create({topSystemLabelDAO:this.X.LabelDAO.where(EQ(this.X.com.google.mail.FOAMGMailLabel.getProperty("type"),"system")).orderBy(toTop("INBOX"),toTop("STARRED"),toTop("DRAFT")).limit(3),bottomSystemLabelDAO:this.X.LabelDAO.where(AND(EQ(this.X.com.google.mail.FOAMGMailLabel.getProperty("type"),"system"),NEQ(this.X.com.google.mail.FOAMGMailLabel.ID,"INBOX"),NEQ(this.X.com.google.mail.FOAMGMailLabel.ID,"STARRED"),NEQ(this.X.com.google.mail.FOAMGMailLabel.ID,"UNREAD"),NEQ(this.X.com.google.mail.FOAMGMailLabel.ID,"DRAFT"))).orderBy(toTop("SENT"),toTop("SPAM"),toTop("TRASH")),userLabelDAO:this.X.LabelDAO.where(NEQ(this.X.com.google.mail.FOAMGMailLabel.getProperty("type"),"system")).orderBy(this.X.com.google.mail.FOAMGMailLabel.NAME)})}}),this.labelDao.where(EQ(this.FOAMGMailLabel.ID,"INBOX")).select({put:function(inbox){self.changeLabel(inbox)}})},open:function(id){var self=this;this.emailDao.find(id,{put:function(m){m.markRead(self.controller.Y);var v=self.FloatingView.create({view:self.EMailView.create({data:m},self.controller.Y)});self.stack.pushView(v,"")}})},openEmail:function(email){this.open(email.id)},changeLabel:function(label){label?(this.controller.q="l:"+label.id,this.controller.name=label.label):(this.controller.q="",this.controller.name="All Mail"),this.stack.back()}},templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n.mdui-app-controller .header {\n  background: #db4437;\n}\n\n.mdui-app-controller.searchMode .header .search {\n  background: #db4437;\n}\n\n.header canvas {\n  background: #db4437;\n}\n\n.email-view .header {\n  background: #db4437;\n}\n\ninput[name=q] {\n  background: #db4437;\n}\n\ntable {\n  border-spacing: 0;\n}\n\n* {\n  box-sizing: border-box;\n}\n\nbody, tbody, tr, td {\n  margin: 0;\n  padding: 0;\n}\n\nhr {\n  border-top: 1px solid rgba(0,0,0,.1);\n  border: none;\n  height: 1px;\n  margin: 0;\n  padding: 0;\n  background: rgba(0,0,0,.1);\n}\n\na {\n  text-decoration: none;\n  color: #4285f4;\n}\n\n.actionButton {\n  padding: 8px;\n  vertical-align: middle;\n  background: #db4437;\n  border: none;\n  -webkit-box-shadow: none;\n  box-shadown: none;\n  opacity: 0.76;\n  outline: none;\n}\n\n.actionButton img {\n  height: 24px;\n  opacity: 0.76;\n  width: 24px;\n}\n\n.popupChoiceList {\n  box-shadow: 0 0 2px 2px rgba(0,0,0,.1), 0 0 3px 1px rgba(0,0,0,.1);\n  border: none;\n  border-radius: 2px;\n  padding: 8px 0;\n  min-width: 190px;\n}\n\n.popupChoiceList li {\n  color: rgba(0, 0, 0, 0.54);\n  font-size: 16px;\n  padding: 16px;\n  margin: 0;\n  line-height: 16px;\n}\n\n.popupChoiceList li.selected {\n  color: #e51c23;\n}\n\n.star {\n  flex-shrink: 0;\n  -webkit-flex-shrink: 0;\n  height: 24px;\n  opacity: 0.76;\n  vertical-align: middle;\n  width: 24px;\n  margin-top: auto;\n}\n\n.hide {\n  display: none;\n}\n\n::-webkit-search-cancel-button {\n  -webkit-appearance: none;\n}\n\n.actionButton-leaveSearchMode, .actionButton-back {\n  margin: 4px;\n}\n\n.actionButton-leaveSearchMode img, .actionButton-back img {\n  margin: 4px;\n  opacity: 0.76;\n}\n\nselect[name=sortOrder] {\n  align-self: center;\n  -webkit-align-self: center;\n  margin: 20px;\n}\n\n\n.swipeAltOuter {\n  -webkit-flex-grow: 1;\n  flex-grow: 1;\n}\n\n.swipeAltInner {\n  padding-top: 8px;\n}\n\nspan[name=projectName] {\n  align-self: center;\n  -webkit-align-self: center;\n  color: white;\n  flex: 1.0;\n  -webkit-box-flex: 1.0;\n  vertical-align: middle;\n  font-size: 20px;\n  font-weight: 500;\n  margin-left: 16px;\n}\n\n.stackview {\n  height: 100%;\n}\n\n.stackview table {\n  height: 100%;\n}\n\n.stackview_navbar {\n  display: none;\n}\n\n.stackview_navactions {\n  display: none;\n}\n\n.stackview-previewarea-td {\n  display: none;\n}\n\n.stackview-viewarea {\n  height: 100%;\n}\n\n.actionButton-save {\n  border: none;\n  margin-right: 40px;\n}\n\n.status-icon {\n  height: 24px;\n  margin: 0 24px 0 0;\n  opacity: 0.54;\n  padding: 2px;\n  width: 24px;\n}\n\nselect[name=pri], select[name=status] {\n  background: white;\n  border-color: white;\n  width: 250px;\n  height: 30px;\n  margin-left: 30px;\n  margin-top: 16px;\n  outline: none;\n}\n\n.actionButton-changeProject {\n  margin: 4px;\n}\n\n.swipeAltHeader {\n  height: 36px;\n}\n\n.swipeAltHeader li {\n  font-size: 14px;\n  opacity: 0.8;\n  line-height: 48px;\n  padding-bottom: 14px;\n}\n\n.swipeAltHeader .selected {\n  border-bottom: 2px solid #ff3f80;\n  color: white;\n  font-weight: 500;\n  opacity: 1;\n}\n\nul.swipeAltHeader {\n  background: #db4437;\n  box-shadow: 0 1px 1px rgba(0,0,0,.25);\n  color: white;\n  height: 48px;\n  margin: 0;\n  overflow: hidden;\n  padding: 0 0 0 56px;\n}\n\n.actionButton {\n  width: 48px;\n  height: 48px;\n  background: transparent;\n}\n\n.foamChoiceListView {\n  padding: 14px 16px;\n  margin: 0;\n}\n\n.stackview-slidearea {\n   box-shadow: 1px 0px 1px 1px rgba(0,0,0,.2);\n}\n\n\n.email-view .monogram-string-view {\n  margin: auto 6px auto 0;\n}\n\n.email-view .header {\n  background: #db4437;\n  position: fixed;\n  width: 100%;\n  top: 0;\n  z-index: 2;\n  box-shadow: 0 1px 1px rgba(0,0,0,.15), 0 1px 3px rgba(0,0,0,.15);\n  display: flex;\n  display: -webkit-flex;\n}\n\n.email-view .header .actionButton {\n  margin: 4px;\n}\n\n.email-view .from {\n  font-size: 14px;\n  font-weight: bold;\n  display: block;\n  overflow-x: hidden;\n  white-space: nowrap;\n  text-overflow: ellipsis;\n}\n\n.email-view .details {\n  font-size: 12px;\n  color: rgb(119, 119, 119);\n  overflow-x: hidden;\n  white-space: nowrap;\n  text-overflow: ellipsis;\n}\n\n.email-view .content {\n  margin-top: 62px;\n  margin-left: 18px;\n  margin-right: 18px;\n  word-break: break-word;\n}\n\n.email-view .subject {\n  color: #fff;\n  display: block;\n  font-size: 20px;\n  line-height: 28px;\n  margin: auto;\n  overflow-x: hidden;\n  padding: 0px 16px;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n  flex: 1;\n  -webkit-box-flex: 1.0;\n}\n\n.email-view .body {\n  white-space: pre-wrap;\n  margin-top: 20px;\n  display: block;\n}\n\n.email-compose-view .header {\n  background: #db4437;\n  position: fixed;\n  width: 100%;\n  top: 0;\n  z-index: 2;\n  box-shadow: 0 1px 1px rgba(0,0,0,.15), 0 1px 3px rgba(0,0,0,.15);\n  display: flex;\n  display: -webkit-flex;\n}\n\n.email-compose-view .header .actionButton {\n  margin: 4px;\n}\n\n.email-compose-view .content {\n  margin-top: 62px;\n  margin-left: 6px;\n  margin-right: 6px;\n}\n\n.email-compose-view .to {\n}\n\n.email-compose-view .cc {\n}\n\n.email-compose-view .bcc {\n}\n\n.email-compose-view .subject {\n  color: #fff;\n  display: block;\n  font-size: 20px;\n  line-height: 28px;\n  margin: auto;\n  overflow-x: hidden;\n  padding: 0px 16px;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n  flex: 1;\n  -webkit-box-flex: 1.0;\n}\n\n.email-compose-view .richtext {\n  height: 300px;\n}\n  "),out.toString()}}]}),CLASS({model_:"Model","package":"foam.ui.md",name:"AppController",requires:["foam.graphics.ActionButtonCView","foam.ui.md.SharedStyles","foam.ui.DAOListView","foam.ui.PopupChoiceView","foam.ui.PredicatedView","foam.ui.ScrollView","foam.ui.SpinnerView","foam.ui.SwipeAltView","foam.ui.ViewChoice"],properties:[{model_:"Property",name:"model"},{model_:"Property",name:"installStyles_",hidden:!0,factory:function(){return this.SharedStyles.create()},help:"Forces the Material Design global CSS styles to be installed."},{model_:"Property",name:"name",defaultValueFn:function(){return this.model.plural}},{model_:"Property",name:"dao"},{model_:"Property",name:"sortChoices",help:"Possible sorting options for the view."},{model_:"Property",name:"citationView",defaultValueFn:function(){return this.model.name+"CitationView"}},{model_:"Property",name:"citationRenderer",defaultValueFn:function(){return this.model.name+"CitationRenderer"}},{model_:"Property",name:"sortOrder",defaultValueFn:function(){return this.sortChoices?this.sortChoices[0][0]:""}},{model_:"Property",name:"sortOrderView",lazyFactory:function(){return this.sortChoices?this.PopupChoiceView.create({iconUrl:"images/ic_sort_24dp.png",data$:this.sortOrder$,choices:this.sortChoices}):""}},{model_:"Property",name:"filterChoices"},{model_:"DAOProperty",name:"filteredDAO",help:"Top-level filtered DAO. Further filtered by each canned query."},{model_:"Property",name:"queryParser",lazyFactory:function(){return QueryParserFactory(this.model)}},{model_:"BooleanProperty",name:"editableCitationViews",help:"True if you want to allow the citation views to be editable.",defaultValue:!1},{model_:"Property",name:"filteredDAOView",lazyFactory:function(){var DAOListView=this.ScrollView.xbind({model:this.model,mode:this.editableCitationViews?"read-write":"read-only",rowView:this.citationView,runway:500});if(!this.filterChoices)return DAOListView.create({dao:this.filteredDAO$Proxy});var self=this,views=this.filterChoices.map(function(filter){return self.ViewChoice.create({view:self.PredicatedView.create({predicate:("string"==typeof filter[0]?self.queryParser.parseString(filter[0]):filter[0])||TRUE,dao:self.filteredDAO$Proxy,view:DAOListView.create()}),label:filter[1]})});return this.SwipeAltView.create({views:views})}},{model_:"BooleanProperty",name:"searchMode",defaultValue:!1},{model_:"Property",name:"q",displayWidth:25,view:{factory_:"foam.ui.TextFieldView",type:"search",onKeyMode:!0,placeholder:"Search"}},{model_:"FunctionProperty",name:"menuFactory"},{model_:"Property",name:"busyStatus"},{model_:"Property",name:"spinner",factory:function(){return this.busyStatus?this.SpinnerView.create({data$:this.busyStatus.busy$,color:"#fff"}):void 0}},{model_:"Property",name:"refreshAction",type:"Action"},{model_:"Property",name:"createAction",type:"Action"}],actions:[{model_:"Action",name:"menu",label:"",iconUrl:"images/ic_menu_24dp.png",action:function(){this.X.stack.slideView(this.menuFactory())}},{model_:"Action",name:"previousQuery"},{model_:"Action",name:"enterSearchMode",label:"",iconUrl:"images/ic_search_24dp.png",action:function(){this.previousQuery=this.q,this.searchMode=!0}},{model_:"Action",name:"leaveSearchMode",label:"",iconUrl:"images/ic_arrow_back_24dp.png",action:function(){this.q=this.previousQuery,this.searchMode=!1}}],methods:{init:function(){this.SUPER(),this.Y.registerModel(this.ActionButtonCView.xbind({alpha:1,width:48,height:44,iconWidth:24,iconHeight:24}),"foam.ui.ActionButton");var self=this;Events.dynamic(function(){self.sortOrder,self.q},function(){var query=(self.queryParser.parseString(self.q)||TRUE).partialEval();self.filteredDAO=self.dao.where(query).orderBy(self.sortOrder)})}},templates:[{model_:"Template",name:"toDetailHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('\n    <div id="',this.id,'"  class="mdui-app-controller">\n       <div class="header">\n         <span class="default">\n           ',self.createTemplateView("menu"),"\n           ",self.createTemplateView("name",{mode:"read-only",className:"name"}),"\n           "),this.data.refreshAction&&out(this.createActionView(this.data.refreshAction,{data:this.data})),out("\n           "),this.data.spinner&&out('\n             <span class="mdui-app-controller-spinner">\n               ',this.data.spinner,"\n             </span>\n           "),out("\n           ",self.createTemplateView("enterSearchMode",{halo:""})," ",self.data.sortOrderView,'\n         </span>\n         <span class="search">\n           ',self.createTemplateView("leaveSearchMode",{className:"backButton",halo:""})," ",self.createTemplateView("q"),"\n         </span>\n       </div>\n       ",self.data.filteredDAOView,"\n       "),this.data.createAction&&out(this.createActionView(this.data.createAction,{data:this.data,className:"createButton",color:"white",font:"30px Roboto Arial",alpha:1,width:44,height:44,radius:22,background:"#e51c23"})),out("\n    </div>\n    "),this.addInitializer(function(){if(self.filterChoices){var v=self.data.filteredDAOView;v.index$.addListener(function(){self.qView.$.placeholder="Search "+v.views[v.index].label.toLowerCase()})}self.data.searchMode$.addListener(function(){DOM.setClass(self.X.$(self.id),"searchMode",self.data.searchMode),self.data.searchMode&&self.qView.focus()},100)}),this.on("touchstart",function(){self.qView.$&&self.qView.$.blur()},this.data.filteredDAOView.id),this.on("click",function(){self.qView.focus()},this.qView.id),out("\n  "),out.toString()}},{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      body { background: white; }\n\n      .floatingView { background: white; }\n\n      .mdui-app-controller-spinner {\n        display: inline-block;\n        height: 42px;\n        width: 42px;\n        overflow: hidden;\n      }\n      .mdui-app-controller-spinner .spinner-fixed-box {\n        height: 26px;\n        width: 26px;\n      }\n      .mdui-app-controller-spinner .spinner-circle {\n        border-width: 3px;\n      }\n   "),out.toString()}}]}),CLASS({model_:"Model","package":"foam.graphics",name:"ActionButtonCView",extendsModel:"foam.graphics.CView",requires:["foam.ui.md.Halo","foam.input.touch.GestureTarget"],imports:["gestureManager"],properties:[{model_:"Property",name:"action",postSet:function(oldValue,action){this.bindIsAvailable()}},{model_:"Property",name:"font",type:"String",defaultValue:""},{model_:"Property",name:"data",postSet:function(){this.bindIsAvailable()}},{model_:"Property",name:"label",defaultValue:""},{model_:"Property",name:"showLabel",defaultValueFn:function(){return this.action.showLabel}},{model_:"Property",name:"iconUrl",defaultValueFn:function(){return this.action.iconUrl},postSet:function(_,v){this.image_&&(this.image_.src=v)}},{model_:"Property",name:"haloColor",defaultValue:"rgb(241, 250, 65)"},{model_:"Property",name:"halo",factory:function(){return this.Halo.create({alpha:0,r:10,color:this.haloColor})},postSet:function(old,nu){old&&this.removeChild(old),nu&&this.addChild(nu)}},{model_:"Property",name:"iconWidth",type:"int",defaultValue:0},{model_:"Property",name:"iconHeight",type:"int",defaultValue:0},{model_:"Property",name:"radius",type:"int",defaultValue:0,postSet:function(_,r){r&&(this.width=this.height=2*r)}},{model_:"Property",name:"tapGesture",hidden:!0,"transient":!0,lazyFactory:function(){return this.GestureTarget.create({containerID:this.view.id,handler:this,gesture:"tap"})}},{model_:"Property",name:"className",defaultValueFn:function(){return"actionButtonCView actionButtonCView-"+this.action.name},help:"CSS class name(s), space separated."},{model_:"Property",name:"tooltip",defaultValueFn:function(){return this.action.help}},{model_:"Property",name:"speechLabel",defaultValueFn:function(){return this.action.speechLabel}},{model_:"Property",name:"tabIndex"},{model_:"Property",name:"role"},{model_:"Property",name:"state_",defaultValue:"default"}],methods:{init:function(){this.SUPER(),this.iconUrl&&(this.image_=new Image,this.image_.onload=function(){this.iconWidth||(this.iconWidth=this.image_.width),this.iconHeight||(this.iconHeight=this.image_.height),this.view.$&&this.view.paint()}.bind(this),this.image_.src=this.iconUrl)},bindIsAvailable:function(){if(this.action&&this.data){var self=this;Events.dynamic(function(){self.action.isAvailable.call(self.data,self.action)},function(){self.action.isAvailable.call(self.data,self.action)?self.oldWidth_&&self.oldHeight_&&(self.x=self.oldX_,self.y=self.oldY_,self.width=self.oldWidth_,self.height=self.oldHeight_):(self.width||self.height)&&(self.oldX_=self.x,self.oldY_=self.y,self.oldWidth_=self.width,self.oldHeight_=self.height,self.width=0,self.height=0,self.x=0,self.y=0)})}},initCView:function(){this.halo&&(this.halo.view=this.view,this.halo.addListener(this.view.paint)),this.gestureManager&&this.gestureManager.install(this.tapGesture),this.$.addEventListener("keypress",function(e){32!=e.charCode||e.altKey||e.ctrlKey||e.shiftKey||(e.preventDefault(),e.stopPropagation(),this.tapClick())}.bind(this)),this.$.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),e.x||e.y||this.tapClick()}.bind(this))},destroy:function(isParentDestroyed){this.SUPER(isParentDestroyed),this.gestureManager&&this.gestureManager.uninstall(this.tapGesture)},erase:function(){var c=this.canvas;c.clearRect(0,0,this.width,this.height);var r=Math.min(this.width,this.height)/2;c.fillStyle=this.background,c.beginPath(),c.arc(this.width/2,this.height/2,r,0,2*Math.PI,!0),c.closePath(),c.fill()},paintSelf:function(){var c=this.canvas;this.halo&&this.halo.paint(),this.font&&(c.font=this.font),c.globalAlpha=this.alpha,c.textAlign="center",c.textBaseline="middle",c.fillStyle=this.color,this.image_&&this.image_.complete?c.drawImage(this.image_,this.x+(this.width-this.iconWidth)/2,this.y+(this.height-this.iconHeight)/2,this.iconWidth,this.iconHeight):c.fillText(this.label||this.action.labelFn.call(this.data,this.action),this.x+this.width/2,this.y+this.height/2)}},listeners:[{model_:"Method",name:"tapClick",code:function(){this.action.callIfEnabled(this.X,this.data)}}]}),CLASS({model_:"Model","package":"foam.ui.md",name:"Halo",extendsModel:"foam.graphics.Circle",properties:[{model_:"Property",name:"style",defaultValue:"solid",postSet:function(_,style){style!==this.RING_INNER_COLOR&&this.setColorAndBorder()}},{model_:"Property",name:"state_",defaultValue:"default"},{model_:"Property",name:"easeInTime",defaultValue:200},{model_:"Property",name:"easeOutTime",defaultValue:150},{model_:"Property",name:"startAlpha",defaultValue:.8},{model_:"Property",name:"pressedAlpha",defaultValue:.4},{model_:"Property",name:"finishAlpha",defaultValue:0}],methods:{setColorAndBorder:function(){if("ring"===this.style){var color=this.color;this.border=color,this.borderWidth=12,this.color=this.RING_INNER_COLOR}},initCView:function(){this.$.addEventListener("mousedown",this.onMouseDown),this.$.addEventListener("mouseup",this.onMouseUp),this.$.addEventListener("mouseleave",this.onMouseUp),this.$.addEventListener("touchstart",this.onMouseDown),this.$.addEventListener("touchend",this.onMouseUp),this.$.addEventListener("touchleave",this.onMouseUp),this.$.addEventListener("touchcancel",this.onMouseUp)},isTouchInRect:function(t,rect){return t.pageX>=rect.left&&t.pageX<=rect.right&&t.pageY>=rect.top&&t.pageY<=rect.bottom}},listeners:[{model_:"Method",name:"onMouseDown",code:function(evt){if("default"===this.state_){if(this.state_="pressing","touchstart"===evt.type){for(var rect=this.$.getBoundingClientRect(),touchFound=!1,t,i=0;i<evt.touches.length;++i)if(t=evt.touches[i],this.isTouchInRect(t,rect)){touchFound=!0;
break}touchFound?(this.x=t.pageX-rect.left,this.y=t.pageY-rect.top):(console.warn("No touches",evt.touches,"in element rect",rect),this.x=rect.width/2,this.y=rect.height/2)}else this.x=evt.offsetX,this.y=evt.offsetY;this.r=2,this.alpha=this.startAlpha,this.X.animate(this.easeInTime,function(){this.x=this.parent.width/2,this.y=this.parent.height/2,this.r=Math.min(28,Math.min(this.$.width,this.parent.height)/2),this.alpha=this.pressedAlpha}.bind(this),void 0,function(){"cancelled"===this.state_?(this.state_="pressed",this.onMouseUp()):this.state_="pressed"}.bind(this))()}}},{model_:"Method",name:"onMouseUp",code:function(evt){return"default"!==this.state_?"pressing"===this.state_?void(this.state_="cancelled"):void("cancelled"!==this.state_&&(this.state_="released",this.X.animate(this.easeOutTime,function(){this.alpha=this.finishAlpha}.bind(this),Movement.easeIn(.5),function(){"released"===this.state_&&(this.state_="default")}.bind(this))())):void 0}}]}),CLASS({model_:"Model","package":"foam.graphics",name:"Circle",extendsModel:"foam.graphics.CView",properties:[{model_:"Property",name:"border",label:"Border Color",type:"String",defaultValue:""},{model_:"Property",name:"borderWidth",type:"int",defaultValue:1},{model_:"Property",name:"r",label:"Radius",type:"int",defaultValue:20},{model_:"Property",name:"startAngle",defaultValue:0},{model_:"Property",name:"endAngle",label:"Radius",type:"int",defaultValue:6.283185307179586},{model_:"Property",name:"width",defaultValueFn:function(){return 2*this.r}},{model_:"Property",name:"height",defaultValueFn:function(){return 2*this.r}}],methods:{paintSelf:function(){var c=this.canvas;c&&(c.globalAlpha=this.alpha,this.r&&(this.color&&(c.beginPath(),c.moveTo(0,0),c.arc(0,0,this.r,-this.endAngle,-this.startAngle,!1),c.closePath(),c.fillStyle=this.color,c.fill()),this.border&&(c.lineWidth=this.borderWidth,c.beginPath(),c.arc(0,0,this.r+this.borderWidth/2-.1,-this.endAngle,-this.startAngle,!1),c.closePath(),c.strokeStyle=this.border,c.stroke())))}}}),CLASS({model_:"Model","package":"foam.graphics",name:"CView",label:"CView",requires:["foam.graphics.PositionedCViewView","foam.graphics.CViewView"],traits:["foam.patterns.ChildTreeTrait"],properties:[{model_:"Property",name:"view",type:"Canvas2",hidden:!0,"transient":!0,postSet:function(_,view){for(var key in this.children){var child=this.children[key];child.view=view,view&&child.addListener(view.paint)}}},{model_:"Property",name:"canvas",hidden:!0,"transient":!0,getter:function(){return this.view&&this.view.canvas}},{model_:"Property",name:"$",hidden:!0,"transient":!0,getter:function(){return this.view&&this.view.$}},{model_:"Property",name:"state",defaultValue:"initial"},{model_:"BooleanProperty",name:"suspended",defaultValue:!1},{model_:"Property",name:"className",defaultValue:"",help:"CSS class name(s), space separated. Used if adapted with a CViewView."},{model_:"FloatProperty",name:"x",defaultValue:0},{model_:"FloatProperty",name:"y",defaultValue:0},{model_:"Property",name:"canvasX",getter:function(){return this.x+(this.parent?this.parent.canvasX:0)}},{model_:"Property",name:"canvasY",getter:function(){return this.y+(this.parent?this.parent.canvasY:0)}},{model_:"IntProperty",name:"width",defaultValue:10},{model_:"IntProperty",name:"height",defaultValue:10},{model_:"FloatProperty",name:"alpha",defaultValue:1},{model_:"Property",name:"color",label:"Foreground Color",type:"String",defaultValue:"black"},{model_:"Property",name:"background",label:"Background Color",type:"String",defaultValue:"white"},{model_:"Property",name:"font"},{model_:"BooleanProperty",name:"clipped",defaultValue:!1}],methods:{toView_:function(){if(!this.view){var params={cview:this};this.className&&(params.className=this.className),this.tooltip&&(params.tooltip=this.tooltip),this.speechLabel&&(params.speechLabel=this.speechLabel),this.tabIndex&&(params.tabIndex=this.tabIndex),this.role&&(params.role=this.role),this.data$&&(params.data$=this.data$),this.view=this.CViewView.create(params)}return this.view},toPositionedView_:function(){if(!this.view){var params={cview:this};this.className&&(params.className=this.className),this.view=this.PositionedCViewView.create(params)}return this.view},initCView:function(){},write:function(document){var v=this.toView_();document.writeln(v.toHTML()),v.initHTML()},addChild:function(child){return this.SUPER(child),this.view&&(child.view=this.view,child.addListener(this.view.paint)),this},removeChild:function(child){return this.SUPER(child),child.view=void 0,child.removeListener(this.view.paint),this},erase:function(){this.canvas.clearRect(0,0,this.width,this.height),this.canvas.fillStyle=this.background,this.canvas.fillRect(0,0,this.width,this.height)},paintChildren:function(){for(var i=0;i<this.children.length;i++){var child=this.children[i];this.canvas.save(),this.canvas.beginPath(),child.paint(),this.canvas.restore()}},paintSelf:function(){},paint:function(){this.$&&("initial"===this.state&&(this.initCView(),this.state="active"),this.suspended||(this.canvas.save(),this.canvas.translate(this.x,this.y),this.clipped&&(this.canvas.rect(0,0,this.width,this.height),this.canvas.clip()),this.paintSelf(),this.paintChildren(),this.canvas.restore()))},mapToParent:function(point){return point.x+=this.x,point.y+=this.y,point},mapToCanvas:function(point){return this.mapToParent(point),this.parent&&this.parent.mapToCanvas&&this.parent.mapToCanvas(point),point}}}),CLASS({model_:"Model","package":"foam.graphics",name:"PositionedCViewView",extendsModel:"foam.graphics.AbstractCViewView",traits:["foam.ui.layout.PositionedDOMViewTrait"],properties:[{model_:"Property",name:"tagName",factory:function(){return"canvas"}}],methods:{init:function(){this.SUPER(),this.X.dynamic(function(){this.cview,this.width,this.height}.bind(this),function(){this.cview&&(this.cview.width=this.width,this.cview.height=this.height)}.bind(this))},toHTML:function(){var className=this.className?' class="'+this.className+'"':"";return'<canvas id="'+this.id+'"'+className+' width="'+this.canvasWidth()+'" height="'+this.canvasHeight()+'" '+this.layoutStyle()+"></canvas>"}},listeners:[{model_:"Method",name:"resize",code:function(){this.$&&(this.$.width=this.canvasWidth(),this.$.style.width=this.styleWidth(),this.$.height=this.canvasHeight(),this.$.style.height=this.styleHeight(),this.cview.width=this.width,this.cview.height=this.height,this.paint())},isFramed:!0}]}),CLASS({model_:"Model","package":"foam.ui.layout",name:"PositionedDOMViewTrait",traits:["foam.ui.layout.PositionedViewTrait"],properties:[{model_:"Property",name:"tagName",defaultValue:"div"}],methods:{toHTML:function(){return"<"+this.tagName+' id="'+this.id+'"'+this.layoutStyle()+this.cssClassAttr()+">"+this.toInnerHTML()+"</div>"},layoutStyle:function(){return' style="-webkit-transform:'+this.transform()+";width:"+this.styleWidth()+";height:"+this.styleHeight()+';position:absolute;"'},initHTML:function(){this.SUPER();var self=this;this.X.dynamic(function(){self.x,self.y,self.z},this.position),this.X.dynamic(function(){self.width,self.height},this.resize),this.$.style.position="absolute",this.position(),this.resize()},transform:function(){return"translate3d("+this.x+"px,"+this.y+"px,"+this.z+"px)"},styleWidth:function(){return this.width+"px"},styleHeight:function(){return this.height+"px"}},listeners:[{model_:"Method",name:"position",code:function(){this.$&&(this.$.style.webkitTransform=this.transform())}},{model_:"Method",name:"resize",code:function(){this.$&&(this.$.style.width=this.styleWidth(),this.$.style.height=this.styleHeight())}}]}),CLASS({model_:"Model","package":"foam.ui.layout",name:"PositionedViewTrait",properties:[{model_:"FloatProperty",name:"x",units:"px",defaultValue:0},{model_:"FloatProperty",name:"y",units:"px",defaultValue:0},{model_:"FloatProperty",name:"z",units:"px",defaultValue:0},{model_:"IntProperty",name:"width",units:"px",defaultValue:100},{model_:"IntProperty",name:"height",units:"px",defaultValue:100},{model_:"IntProperty",name:"preferredWidth",units:"px",defaultValue:100},{model_:"IntProperty",name:"preferredHeight",units:"px",defaultValue:100}]}),CLASS({model_:"Model","package":"foam.graphics",name:"AbstractCViewView",extendsModel:"foam.ui.View",properties:[{model_:"Property",name:"cview",type:"foam.graphics.CView",postSet:function(_,cview){cview.view=this,this.width=cview.x+cview.width,this.height=cview.y+cview.height}},{model_:"Property",name:"className",defaultValue:"",help:"CSS class name(s), space separated."},{model_:"FloatProperty",name:"scalingRatio",preSet:function(_,v){return 0>=v?1:v},defaultValue:1},{model_:"Property",name:"speechLabel"},{model_:"Property",name:"role"},{model_:"Property",name:"tabIndex"},{model_:"IntProperty",name:"width",defaultValue:100},{model_:"IntProperty",name:"height",defaultValue:100},{model_:"Property",name:"canvas",getter:function(){return this.instance_.canvas?this.instance_.canvas:this.instance_.canvas=this.$&&this.$.getContext("2d")}}],methods:{init:function(){this.SUPER(),this.X.dynamic(function(){this.scalingRatio,this.width,this.height}.bind(this),this.resize)},styleWidth:function(){return this.width+"px"},canvasWidth:function(){return this.width*this.scalingRatio},styleHeight:function(){return this.height+"px"},canvasHeight:function(){return this.height*this.scalingRatio},toString:function(){return"CViewView("+this.cview+")"},toHTML:function(){var className=this.className?' class="'+this.className+'"':"",title=this.speechLabel?' aria-role="button" aria-label="'+this.speechLabel+'"':"",tabIndex=this.tabIndex?' tabindex="'+this.tabIndex+'"':"",role=this.role?' role="'+this.role+'"':"";return'<canvas id="'+this.id+'"'+className+title+tabIndex+role+' width="'+this.canvasWidth()+'" height="'+this.canvasHeight()+'" style="width:'+this.styleWidth()+";height:"+this.styleHeight()+";min-width:"+this.styleWidth()+";min-height:"+this.styleHeight()+'"></canvas>'},initHTML:function(){if(this.$){this.maybeInitTooltip(),this.canvas=this.$.getContext("2d");var devicePixelRatio=this.X.window.devicePixelRatio||1,backingStoreRatio=this.canvas.backingStoreRatio||this.canvas.webkitBackingStorePixelRatio||1;devicePixelRatio!==backingStoreRatio&&(this.scalingRatio=devicePixelRatio/backingStoreRatio);var style=this.X.window.getComputedStyle(this.$);style.backgroundColor&&!this.cview.hasOwnProperty("background")&&(this.cview.background=style.backgroundColor),this.paint()}},destroy:function(isParentDestroyed){this.SUPER(isParentDestroyed)}},listeners:[{model_:"Method",name:"resize",code:function(){this.$&&(this.$.width=this.canvasWidth(),this.$.style.width=this.styleWidth(),this.$.style.minWidth=this.styleWidth(),this.$.height=this.canvasHeight(),this.$.style.height=this.styleHeight(),this.$.style.minHeight=this.styleHeight(),this.paint())},isFramed:!0},{model_:"Method",name:"paint",code:function(){if(!this.$)throw EventService.UNSUBSCRIBE_EXCEPTION;this.canvas.save(),this.canvas.clearRect(0,0,this.canvasWidth(),this.canvasHeight()),this.canvas.fillStyle=this.cview.background,this.canvas.fillRect(0,0,this.canvasWidth(),this.canvasHeight()),this.canvas.scale(this.scalingRatio,this.scalingRatio),this.cview.paint(),this.canvas.restore()},isFramed:!0}]}),CLASS({model_:"Model","package":"foam.ui",name:"View",extendsModel:"foam.ui.DestructiveDataView",requires:["Property"],exports:["propertyViewProperty"],traits:["foam.ui.HTMLViewTrait","foam.ui.ViewActionsTrait","foam.ui.TemplateSupportTrait"],properties:[{model_:"Property",name:"propertyViewProperty",type:"Property",defaultValueFn:function(){return this.Property.DETAIL_VIEW}}]}),CLASS({model_:"Model","package":"foam.ui",name:"HTMLViewTrait",label:"HTMLView",requires:["foam.input.touch.GestureTarget"],properties:[{model_:"Property",name:"id",label:"Element ID",type:"String",factory:function(){return this.instance_.id||this.nextID()}},{model_:"Property",name:"shortcuts",type:"Array[Shortcut]",factory:function(){return[]}},{model_:"Property",name:"$",mode:"read-only",hidden:!0,getter:function(){return this.X.document.getElementById(this.id)},setter:function(){},help:"DOM Element."},{model_:"Property",name:"tagName",defaultValue:"span"},{model_:"Property",name:"className",defaultValue:"",help:"CSS class name(s), space separated."},{model_:"Property",name:"tooltip"},{model_:"Property",name:"tabIndex"},{model_:"Property",name:"extraClassName",defaultValue:""},{model_:"Property",name:"propertyViewProperty",type:"Property",defaultValueFn:function(){return this.X.Property.VIEW}},{model_:"Property",name:"initializers_",factory:function(){return[]}},{model_:"Property",name:"destructors_",factory:function(){return[]}}],constants:[{model_:"Constant",name:"KEYPRESS_CODES",value:{8:!0,37:!0,38:!0,39:!0,40:!0}},{model_:"Constant",name:"ON_HIDE",value:["onHide"]},{model_:"Constant",name:"ON_SHOW",value:["onShow"]}],methods:{toView_:function(){return this},strToHTML:function(str){return XMLUtil.escape(str.toString())},cssClassAttr:function(){if(!this.className&&!this.extraClassName)return"";var s=' class="';return this.className&&(s+=this.className,this.extraClassName&&(s+=" ")),this.extraClassName&&(s+=this.extraClassName),s+'"'},bindSubView:function(view,prop){view.setValue(this.propertyValue(prop.name))},focus:function(){this.$&&this.$.focus&&this.$.focus()},addChild:function(child){return child.toView_&&(child=child.toView_()),-1==this.children.indexOf(child)?this.SUPER(child):void 0},addShortcut:function(key,callback,context){this.shortcuts.push([key,callback,context])},nextID:function(){return"view"+(arguments.callee._nextId=(arguments.callee._nextId||0)+1)},addInitializer:function(f){this.initializers_.push(f)},addDestructor:function(f){this.destructors_.push(f)},tapClick:function(){},on:function(event,listener,opt_id){if(opt_id=opt_id||this.nextID(),listener=listener.bind(this),"click"===event&&this.X.gestureManager){var self=this,manager=this.X.gestureManager,target=this.GestureTarget.create({containerID:opt_id,handler:{tapClick:function(pointMap){return listener({preventDefault:function(){},stopPropagation:function(){},pointMap:pointMap})}},gesture:"tap"});return manager.install(target),this.addDestructor(function(){manager.uninstall(target)}),opt_id}return this.addInitializer(function(){var e=this.X.$(opt_id);e&&e.addEventListener(event,listener,!1)}.bind(this)),opt_id},setAttribute:function(attributeName,valueFn,opt_id){opt_id=opt_id||this.nextID(),valueFn=valueFn.bind(this),this.addInitializer(function(){this.X.dynamic(valueFn,function(){var e=this.X.$(opt_id);if(!e)throw EventService.UNSUBSCRIBE_EXCEPTION;var newValue=valueFn(e.getAttribute(attributeName));void 0==newValue?e.removeAttribute(attributeName):e.setAttribute(attributeName,newValue)}.bind(this))}.bind(this))},setClass:function(className,predicate,opt_id){return opt_id=opt_id||this.nextID(),predicate=predicate.bind(this),this.addInitializer(function(){this.X.dynamic(predicate,function(){var e=this.X.$(opt_id);if(!e)throw EventService.UNSUBSCRIBE_EXCEPTION;DOM.setClass(e,className,predicate())}.bind(this))}.bind(this)),opt_id},setClasses:function(map,opt_id){opt_id=opt_id||this.nextID();for(var keys=Objects.keys(map),i=0;i<keys.length;i++)this.setClass(keys[i],map[keys[i]],opt_id);return opt_id},insertInElement:function(name){var e=this.X.$(name);e.innerHTML=this.toHTML(),this.initHTML()},write:function(document){document.writeln(this.toHTML()),this.initHTML()},updateHTML:function(){this.$&&(this.destroy(),this.construct())},construct:function(){this.SUPER(),this.generateContent()},generateContent:function(){this.$&&(this.$.innerHTML=this.toInnerHTML(),this.initInnerHTML())},toInnerHTML:function(){return""},toHTML:function(){return this.invokeDestructors(),"<"+this.tagName+' id="'+this.id+'"'+this.cssClassAttr()+">"+this.toInnerHTML()+"</"+this.tagName+">"},initHTML:function(){this.initInnerHTML(),this.initKeyboardShortcuts(),this.maybeInitTooltip()},maybeInitTooltip:function(){this.tooltip&&this.$&&(this.$.addEventListener("mouseenter",this.openTooltip),this.$.addEventListener("mouseleave",this.closeTooltip))},initInnerHTML:function(){this.invokeInitializers(),this.initChildren()},initChildren:function(){if(this.children)for(var i=0;i<this.children.length;i++)try{this.children[i].initHTML()}catch(x){console.log("Error on View.child.initHTML",x,x.stack)}},invokeInitializers:function(){for(var i=0;i<this.initializers_.length;i++)this.initializers_[i]();this.initializers_=[]},invokeDestructors:function(){for(var i=0;i<this.destructors_.length;i++)this.destructors_[i]();this.destructors_=[]},evtToCharCode:function(evt){var s="";return evt.altKey&&(s+="alt-"),evt.ctrlKey&&(s+="ctrl-"),evt.shiftKey&&"keydown"===evt.type&&(s+="shift-"),evt.metaKey&&(s+="meta-"),s+=String.fromCharCode("keydown"===evt.type?evt.which:evt.charCode)},initKeyboardShortcuts:function(){function init(actions,opt_value){actions.forEach(function(action){for(var j=0;j<action.keyboardShortcuts.length;j++){var key=action.keyboardShortcuts[j];"number"==typeof key&&(key=String.fromCharCode(key)),keyMap[key]=opt_value?function(){action.callIfEnabled(self.X,opt_value.get())}:action.callIfEnabled.bind(action,self.X,self),found=!0}})}var keyMap={},found=!1,self=this;init(this.model_.actions),this.data&&this.data.model_&&this.data.model_.actions&&init(this.data.model_.actions,this.data$),found&&(console.assert(this.$,"View must define outer id when using keyboard shortcuts: "+this.name_),this.keyMap_=keyMap,this.$.parentElement.addEventListener("keydown",this.onKeyboardShortcut),this.$.parentElement.addEventListener("keypress",this.onKeyboardShortcut))},destroy:function(isParentDestroyed){this.invokeDestructors(),this.SUPER(isParentDestroyed),delete this.instance_.$},close:function(){this.$&&this.$.remove(),this.destroy(),this.publish("closed")}},listeners:[{model_:"Method",name:"openTooltip",code:function(e){console.assert(!this.tooltip_,"Tooltip already defined"),arequire("foam.ui.Tooltip")(function(Tooltip){this.tooltip_=Tooltip.create({text:this.tooltip,target:this.$},this.Y)}.bind(this))}},{model_:"Method",name:"closeTooltip",code:function(e){this.tooltip_&&(this.tooltip_.close(),this.tooltip_=null)}},{model_:"Method",name:"onKeyboardShortcut",code:function(evt){if("keydown"!==evt.type||this.KEYPRESS_CODES[evt.which]){var action=this.keyMap_[this.evtToCharCode(evt)];action&&action(),evt.preventDefault(),evt.stopPropagation()}}}]}),CLASS({model_:"Model","package":"foam.input.touch",name:"GestureTarget",properties:[{model_:"Property",name:"id"},{model_:"Property",name:"gesture",help:"The name of the gesture to be tracked."},{model_:"Property",name:"containerID",help:"The containing DOM node's ID. Used for checking what inputs are within which gesture targets."},{model_:"Property",name:"getElement",defaultValue:function(){return this.X.$(this.containerID)},help:"Function to retrieve the element this gesture is attached to. Defaults to $(containerID)."},{model_:"Property",name:"handler",help:"The target for the gesture's events, after it has been recognized."}],help:"Created by each view that wants to receive gestures."}),CLASS({model_:"Model","package":"foam.ui",name:"ViewActionsTrait",requires:["foam.ui.ActionButton","foam.ui.ActionBorder"],properties:[{model_:"BooleanProperty",name:"showActions",postSet:function(oldValue,showActions){!oldValue&&showActions&&this.addDecorator(this.ActionBorder.create())},defaultValue:!1}],methods:{createActionView:function(action,opt_args){var X=opt_args&&opt_args.X||this.Y,modelName=opt_args&&opt_args.model_?opt_args.model_:"foam.ui.ActionButton",v=X.lookup(modelName,X).create({action:action},X).copyFrom(opt_args);return this[action.name+"View"]=v,v}}}),CLASS({model_:"Model","package":"foam.ui",name:"ActionButton",extendsModel:"foam.ui.BaseView",traits:["foam.ui.HTMLViewTrait"],properties:[{model_:"Property",name:"action",postSet:function(old,nu){old&&old.removeListener(this.render),nu.addListener(this.render)}},{model_:"Property",name:"data"},{model_:"Property",name:"className",factory:function(){return"actionButton actionButton-"+this.action.name}},{model_:"Property",name:"tagName",defaultValue:"button"},{model_:"Property",name:"showLabel",defaultValueFn:function(){return this.action.showLabel}},{model_:"Property",name:"label",defaultValueFn:function(){return this.data?this.action.labelFn.call(this.data,this.action):this.action.label}},{model_:"Property",name:"iconUrl",defaultValueFn:function(){return this.action.iconUrl}},{model_:"Property",name:"tooltip",defaultValueFn:function(){return this.action.help}}],methods:{toHTML:function(){var superResult=this.SUPER(),self=this;return this.on("click",function(){self.action.callIfEnabled(self.X,self.data)},this.id),this.setAttribute("disabled",function(){return self.closeTooltip(),self.action.isEnabled.call(self.data,self.action)?void 0:"disabled"},this.id),this.setClass("available",function(){return self.closeTooltip(),self.action.isAvailable.call(self.data,self.action)},this.id),this.X.dynamic(function(){self.action.labelFn.call(self.data,self.action),self.updateHTML()}),superResult},toInnerHTML:function(){var out="";return this.iconUrl&&(out+='<img src="'+XMLUtil.escapeAttr(this.iconUrl)+'">'),this.showLabel&&(out+=this.label),out}},listeners:[{model_:"Method",name:"render",code:function(){this.updateHTML()},isFramed:!0}]}),CLASS({model_:"Model","package":"foam.ui",name:"BaseView",extendsModel:"foam.patterns.ChildTreeTrait",properties:[{model_:"Property",name:"data"}],methods:{addDataChild:function(child){Events.link(this.data$,child.data$),this.addChild(child)},addSelfDataChild:function(child){child.data=this,this.addChild(child)}}}),CLASS({model_:"Model","package":"foam.patterns",name:"ChildTreeTrait",properties:[{model_:"Property",name:"parent",type:"foam.patterns.ChildTreeTrait",hidden:!0},{model_:"Property",name:"children",type:"Array[foam.patterns.ChildTreeTrait]",factory:function(){return[]}}],methods:{onAncestryChange_:function(){Array.prototype.forEach.call(this.children,function(c){c.onAncestryChange_&&c.onAncestryChange_()})},addChild:function(child){if(-1==this.children.indexOf(child)){try{child.parent=this}catch(x){console.log(x)}child.onAncestryChange_&&child.onAncestryChange_();var children=this.children;return children.push(child),this.children=children,this}},removeChild:function(child){return child.destroy(!0),this.children.deleteI(child),child.parent=void 0,this},removeAllChildren:function(isParentDestroyed){var list=this.children.slice();Array.prototype.forEach.call(list,function(child){this.removeChild(child)}.bind(this))},addChildren:function(){if(Array.isArray(arguments))Array.prototype.forEach.call(arguments,this.addChild.bind(this));else for(var key in arguments)this.addChild(arguments[key]);return this},destroy:function(isParentDestroyed){return isParentDestroyed?Array.prototype.forEach.call(this.children,function(child){child.destroy(!0)}):this.removeAllChildren(),this},construct:function(){return this},deepPublish:function(topic){var count=this.publish.apply(this,arguments);if(this.children)for(var i=0;i<this.children.length;i++){var child=this.children[i];count+=child.deepPublish.apply(child,arguments)}return count}}}),CLASS({model_:"Model","package":"foam.ui",name:"ActionBorder",methods:{toHTML:function(border,delegate,args){var str="";str+=delegate.apply(this,args),str+='<div class="actionToolbar">';for(var actions=this.model_.actions,i=0;i<actions.length;i++){var v=this.createActionView(actions[i]);this.addSelfDataChild(v),str+=" "+v.toView_().toHTML()+" "}if(this.X.lookup("foam.ui.DetailView").isInstance(this)){actions=this.model.actions;for(var i=0;i<actions.length;i++){var v=this.createActionView(actions[i]);this.addDataChild(v),str+=" "+v.toView_().toHTML()+" "}}return str+="</div>"}}}),CLASS({model_:"Model","package":"foam.ui",name:"TemplateSupportTrait",requires:["foam.ui.PropertyView","foam.ui.ActionButton","SimpleReadOnlyValue"],methods:{init:function(){this.SUPER(),arequire("foam.ui.RelationshipView")},createView:function(prop,opt_args){var X=opt_args&&opt_args.X||this.Y,v=this.PropertyView.create({prop:prop,args:opt_args},X);return this[prop.name+"View"]=v.view,v},removeChild:function(child){this.PropertyView.isInstance(child)&&child.prop&&delete this[child.prop.name+"View"],this.SUPER(child)},createRelationshipView:function(r,opt_args){var X=opt_args&&opt_args.X||this.Y;return this[r.name+"View"]=X.foam.ui.RelationshipView.create({relationship:r,args:opt_args}),this[r.name+"View"]},createTemplateView:function(name,opt_args){var args=opt_args||{},X=this.Y,myData=this.data$;if(myData&&myData.value&&myData.value.model_){var o=myData.value.model_.getFeature(name);if(o){var v;return v=Action.isInstance(o)?this.createActionView(o,args):Relationship.isInstance(o)?this.createRelationshipView(o,args):this.createView(o,args),this.addDataChild(v),v}}var o=this.model_.getFeature(name);if(!o)throw"Unknown View Name: "+name;if(Action.isInstance(o))var v=this.createActionView(o,args);else v=Relationship.isInstance(o)?this.createRelationshipView(o,args):this.createView(o,args);return this.addSelfDataChild(v),v},dynamicTag:function(tagName,f){var id=this.nextID();return this.addInitializer(function(){this.X.dynamic(function(){var html=f(),e=this.X.$(id);e&&(e.innerHTML=html)}.bind(this))}.bind(this)),"<"+tagName+' id="'+id+'"></'+tagName+">"}}}),CLASS({model_:"Model","package":"foam.ui",name:"PropertyView",extendsModel:"foam.ui.BasePropertyView",traits:["foam.ui.HTMLViewTrait","foam.ui.HTMLPropertyViewTrait"]}),CLASS({model_:"Model","package":"foam.ui",name:"HTMLPropertyViewTrait",properties:[{model_:"Property",name:"id",label:"Element ID",type:"String",factory:function(){return this.instance_.id||this.nextID()+"PROP"}}],methods:{finishPropertyRender:function(){this.SUPER(),this.$&&(this.$.outerHTML=this.toInnerHTML(),this.initInnerHTML())},toInnerHTML:function(){return this.view?this.view.toHTML():""},toHTML:function(){return this.invokeDestructors(),this.view?this.toInnerHTML():this.SUPER()},initHTML:function(){this.view&&this.view.initHTML()}}}),CLASS({model_:"Model","package":"foam.ui",name:"BasePropertyView",extendsModel:"foam.ui.BaseView",requires:["foam.ui.TextFieldView"],properties:[{model_:"Property",name:"prop",type:"Property",postSet:function(old,nu){old&&this.bound_&&this.unbindData(this.data),nu&&!this.bound_&&this.bindData(this.data)}},{model_:"Property",name:"data",postSet:function(old,nu){old&&this.bound_&&this.unbindData(old),nu&&this.bindData(nu)}},{model_:"Property",name:"childData"},{model_:"Property",name:"parent",type:"foam.ui.View",postSet:function(_,p){p&&(p[this.prop.name+"View"]=this.view,this.view&&(this.view.parent=p))}},{model_:"Property",name:"innerView",help:"Override for prop.view"},{model_:"Property",name:"view",type:"foam.ui.View"},{model_:"Property",name:"args"},{model_:"BooleanProperty",name:"bound_",defaultValue:!1}],methods:{init:function(){this.SUPER(),this.construct()},fromElement:function(e){return this.view.fromElement(e),this},createViewFromProperty:function(prop,ret){var viewName=this.innerView||prop.view;if(viewName)if("string"==typeof viewName)arequire(viewName,this.X)(function(m){ret(m.create(prop,this.Y))}.bind(this));else if(viewName.model_&&"string"==typeof viewName.model_){var m=FOAM(prop.view);arequireModel(m,this.X)(ret)}else if(viewName.model_){var v=viewName.model_.create(viewName,this.X),vId=v.id;v.copyFrom(prop),v.id=vId,ret(v)}else if(viewName.factory_){var v=this.X.lookup(viewName.factory_).create(viewName,this.X),vId=v.id;v.copyFrom(prop),v.id=vId,ret(v)}else ret("function"==typeof viewName?viewName(prop,this):viewName.create(prop));else ret(this.TextFieldView.create(prop,this.Y))},unbindData:function(oldData){if(this.bound_&&oldData&&this.prop){var pValue=oldData.propertyValue(this.prop.name);Events.unlink(pValue,this.childData$),this.bound_=!1}},bindData:function(data){if(!this.bound_&&data&&this.prop){var pValue=data.propertyValue(this.prop.name);Events.link(pValue,this.childData$),this.bound_=!0}},toString:function(){return"PropertyView("+this.prop.name+", "+this.view+")"},destroy:function(isParentDestroyed){this.unbindData(this.data),this.SUPER(isParentDestroyed)},finishPropertyRender:function(){},construct:function(){if(this.bindData(this.data),this.args&&this.args.model_){var model=this.Y.lookup(this.args.model_);console.assert(model,"Unknown View: "+this.args.model_),this.args.model&&(this.prop.model=this.args.model);var view=model.create(this.prop,this.Y);delete this.args.model_,this.finishConstruct(view,this.finishPropertyRender.bind(this))}else view=this.createViewFromProperty(this.prop,function(v){this.finishConstruct(v,this.finishPropertyRender.bind(this))}.bind(this))},finishConstruct:function(view,ret){view.copyFrom(this.args),view.parent=this.parent,view.prop=this.prop,this.view=view,this.addDataChild(view),ret&&ret()},addDataChild:function(child){Events.link(this.childData$,child.data$),this.addChild(child)}}}),CLASS({model_:"Model","package":"foam.ui",name:"TextFieldView",label:"Text Field",extendsModel:"foam.ui.BaseView",traits:["foam.ui.HTMLViewTrait","foam.ui.ViewActionsTrait"],properties:[{model_:"StringProperty",name:"name",defaultValue:"field"},{model_:"IntProperty",name:"displayWidth",defaultValue:30},{model_:"IntProperty",name:"displayHeight",defaultValue:1},{model_:"StringProperty",name:"type",defaultValue:"text"},{model_:"StringProperty",name:"placeholder",defaultValue:""},{model_:"BooleanProperty",name:"onKeyMode",help:"If true, value is updated on each keystroke."},{model_:"BooleanProperty",name:"escapeHTML",help:"If true, HTML content is escaped in display mode.",defaultValue:!0},{model_:"StringProperty",name:"mode",defaultValue:"read-write",view:{factory_:"foam.ui.ChoiceView",choices:["read-only","read-write","final"]}},{model_:"BooleanProperty",name:"required"},{model_:"StringProperty",name:"pattern"},{model_:"Property",name:"domValue",hidden:!0},{model_:"Property",name:"data"},{model_:"StringProperty",name:"readWriteTagName",hidden:!0,defaultValueFn:function(){return 1===this.displayHeight?"input":"textarea"}},{model_:"BooleanProperty",name:"autocomplete",defaultValue:!0},{model_:"Property",name:"autocompleter"},{model_:"Property",name:"autocompleteView"}],constants:[{model_:"Constant",name:"ESCAPE",value:["escape"]}],methods:{toHTML:function(){return"read-write"===this.mode?this.toReadWriteHTML():this.toReadOnlyHTML()},toReadWriteHTML:function(){var str="<"+this.readWriteTagName+' id="'+this.id+'"';return str+=' type="'+this.type+'" '+this.cssClassAttr(),this.on("click",this.onClick,this.id),str+="input"===this.readWriteTagName?' size="'+this.displayWidth+'"':' rows="'+this.displayHeight+'" cols="'+this.displayWidth+'"',this.required&&(str+=" required"),this.pattern&&(str+=' pattern="'+this.pattern+'"'),str+=this.extraAttributes(),str+=' name="'+this.name+'">',str+="</"+this.readWriteTagName+">"},extraAttributes:function(){return""},toReadOnlyHTML:function(){var self=this;return this.setClass("placeholder",function(){return""===self.data},this.id),"<"+this.tagName+' id="'+this.id+'"'+this.cssClassAttr()+' name="'+this.name+'"></'+this.tagName+">"},setupAutocomplete:function(){if(this.autocomplete&&this.autocompleter){var view=this.autocompleteView=this.X.AutocompleteView.create({autocompleter:this.autocompleter,target:this});this.bindAutocompleteEvents(view)}},onAutocomplete:function(data){this.data=data},bindAutocompleteEvents:function(view){this.$.addEventListener("blur",function(){view.publish("blur")}),this.$.addEventListener("input",function(){view.autocomplete(this.textToValue(this.$.value))}.bind(this)),this.$.addEventListener("focus",function(){view.autocomplete(this.textToValue(this.$.value))}.bind(this))},initHTML:function(){this.$&&(this.SUPER(),"read-write"===this.mode?(this.placeholder&&(this.$.placeholder=this.placeholder),this.domValue=DomValue.create(this.$,this.onKeyMode?"input":"change"),Events.relate(this.data$,this.domValue,this.valueToText.bind(this),this.textToValue.bind(this),this.onKeyMode),this.onKeyMode&&this.$.addEventListener("blur",this.onBlur),this.$.addEventListener("keydown",this.onKeyDown),this.setupAutocomplete()):(this.domValue=DomValue.create(this.$,"undefined",this.escapeHTML?"textContent":"innerHTML"),Events.map(this.data$,this.domValue,this.valueToText.bind(this))))
},textToValue:function(text){return text},valueToText:function(value){return"read-only"===this.mode&&""===value?this.placeholder:value},destroy:function(isParentDestroyed){this.SUPER(isParentDestroyed),Events.unlink(this.domValue,this.data$)}},listeners:[{model_:"Method",name:"onKeyDown",code:function(e){27==e.keyCode?(this.domValue.set(this.data),this.publish(this.ESCAPE)):this.publish(["keydown"],e)}},{model_:"Method",name:"onBlur",code:function(e){this.domValue.get()!==this.data&&this.domValue.set(this.data)}},{model_:"Method",name:"onClick",code:function(e){this.$&&this.$.focus()}}]}),CLASS({model_:"Model","package":"foam.ui",name:"DestructiveDataView",extendsModel:"foam.ui.BaseView",requires:["SimpleValue"],properties:[{model_:"Property",name:"data",preSet:function(old,nu){return this.shouldDestroy(old,nu)&&this.destroy(),nu},postSet:function(old,nu){this.shouldDestroy(old,nu)&&this.construct()}},{model_:"Property",name:"dataLinkedChildren",type:"Array[foam.patterns.ChildTreeTrait]",factory:function(){return[]}}],methods:{shouldDestroy:function(old,nu){return!0},destroy:function(isParentDestroyed){isParentDestroyed||(this.dataLinkedChildren.forEach(function(child){Events.unfollow(this.data$,child.data$)}.bind(this)),this.dataLinkedChildren=[]),this.SUPER(isParentDestroyed)},addDataChild:function(child){Events.follow(this.data$,child.data$),this.dataLinkedChildren.push(child),this.addChild(child)}}}),CLASS({model_:"Model","package":"foam.graphics",name:"CViewView",extendsModel:"foam.graphics.AbstractCViewView",properties:[{model_:"Property",name:"cview",postSet:function(_,cview){cview.view=this,this.X.dynamic(function(){this.width=cview.x+cview.width,this.height=cview.y+cview.height}.bind(this))}}],help:"DOM wrapper for a CView, auto adjusts it size to fit the given cview."}),CLASS({model_:"Model","package":"foam.ui.md",name:"SharedStyles",templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n@import url(https://fonts.googleapis.com/css?family=Roboto:400,500,700);\n\nbody {\n  font-family: Roboto, 'Helvetica Neue', Helvetica, Arial;\n}\n\ntable {\n  border-spacing: 0;\n}\n\n* {\n  box-sizing: border-box;\n}\n\nbody, tbody, tr, td {\n  margin: 0;\n  padding: 0;\n}\n\nhr {\n  border-top: 1px solid rgba(0,0,0,.1);\n  border: none;\n  height: 1px;\n  margin: 0;\n  padding: 0;\n  background: rgba(0,0,0,.1);\n}\n\na {\n  text-decoration: none;\n  color: #4285f4;\n}\n\n.mdui-app-controller {\n  background: white;\n  display: flex;\n  display: -webkit-flex;\n  flex-direction: column;\n  -webkit-flex-direction: column;\n  height: 100%;\n}\n\n.mdui-app-controller .header {\n  display: flex;\n  display: -webkit-flex;\n  background: #3e50b4;\n  flex-shrink: 0;\n  -webkit-flex-shrink: 0;\n  padding: 0;\n  height: 56px;\n}\n\n.mdui-app-controller .header .default {\n  flex: 1.0;\n  -webkit-box-flex: 1.0;\n  display: flex;\n  display: -webkit-flex;\n  margin: 4px;\n  flex-grow: 1.0;\n  -webkit-flex-grow: 1.0;\n}\n\n.mdui-app-controller.searchMode .header {\n  height: 50px;\n}\n\n.mdui-app-controller.searchMode .header .default {\n  display: none;\n}\n\n.mdui-app-controller:not(.searchMode) .header .search {\n  display: none;\n}\n\n.mdui-app-controller.searchMode .header .search {\n  display: inherit;\n  height: 50px;\n  width: 100%;\n  background: #3e50b4;\n  z-index: 2;\n}\n\n.swipeAltInner {\n  overflow: hidden;\n}\n\n.mdui-app-controller.searchMode .swipeAltHeader {\n  display: none;\n}\n\n.mdui-app-controller .header .name {\n  align-self: center;\n  -webkit-align-self: center;\n  color: white;\n  flex: 1.0;\n  -webkit-box-flex: 1.0;\n  font-size: 20px;\n  font-weight: 500;\n  margin-left: 16px;\n  vertical-align: middle;\n  white-space: nowrap;\n  overflow-x: hidden;\n  text-overflow: ellipsis;\n  flex-grow: 1.0;\n  -webkit-flex-grow: 1.0;\n}\n\ninput[name=q] {\n  align-self: center;\n  -webkit-align-self: center;\n  background: #3e50b4;\n  border: none;\n  color: white;\n  font-size: 20px;\n  height: 30px;\n  margin: 13px 20px 13px 6px;\n  padding-left: 10px;\n  width: 100%;\n}\n\ninput[name=q]:focus {\n  outline: none;\n  opacity: 0.76;\n}\n\ninput[name=q]::-webkit-input-placeholder {\n  font-size: 20px;\n  color: white;\n  opacity: 0.76;\n  height: 55px;\n}\n\n.backButton {\n  margin: 3px 6px 2px 4px;\n}\n\n.header canvas {\n  background: #3e50b4\n}\n\n.body canvas {\n  background: white;\n}\n\n.popupChoiceView {\n  padding: 0;\n}\n\n.md-floating-label-container {\n  align-items: center;\n  display: flex;\n  padding: 40px 16px 8px;\n  position: relative;\n}\n\n.md-floating-label {\n  color: #999;\n  flex-grow: 1;\n  font-size: 12px;\n  font-weight: 500;\n  position: absolute;\n  top: 16px;\n  z-index: 0;\n}\n\ncanvas.createButton {\n  position: absolute;\n  bottom: 10px;\n  right: 20px;\n  z-index: 10;\n  background: rgba(0,0,0,0);\n  box-shadow: 3px 3px 3px #aaa;\n  border-radius: 30px;\n}\n"),out.toString()}}]}),CLASS({model_:"Model","package":"foam.ui",name:"DAOListView",extendsModel:"foam.ui.View",requires:["SimpleValue"],traits:["foam.ui.DAODataViewTrait"],properties:[{model_:"BooleanProperty",name:"isHidden",postSet:function(_,isHidden){this.dao&&!isHidden&&this.onDAOUpdate()},defaultValue:!1},{model_:"ViewFactoryProperty",name:"rowView",defaultValue:"foam.ui.DetailView"},{model_:"Property",name:"mode",view:{factory_:"foam.ui.ChoiceView",choices:["read-only","read-write","final"]},defaultValue:"read-write"},{model_:"Property",name:"useSelection",postSet:function(old,nu){this.useSelection&&!this.X.selection$&&(this.X.selection$=this.SimpleValue.create()),this.selection$=this.X.selection$},help:"Backward compatibility for selection mode. Create a X.selection$ value in your context instead."},{model_:"Property",name:"selection",factory:function(){return this.SimpleValue.create()},help:"Backward compatibility for selection mode. Create a X.selection$ value in your context instead."},{model_:"Property",name:"scrollContainer",help:"Containing element that is responsible for scrolling."},{model_:"Property",name:"chunkSize",defaultValue:0,help:"Number of entries to load in each infinite scroll chunk."},{model_:"Property",name:"chunksLoaded",defaultValue:1,help:"The number of chunks currently loaded."},{model_:"BooleanProperty",name:"painting","transient":!0,defaultValue:!1},{model_:"BooleanProperty",name:"repaintRequired","transient":!0,defaultValue:!1}],methods:{init:function(){this.SUPER();var self=this;this.subscribe(this.ON_HIDE,function(){self.isHidden=!0}),this.subscribe(this.ON_SHOW,function(){self.isHidden=!1}),this.X.selection$&&(this.selection$=this.X.selection$)},initHTML:function(){if(this.SUPER(),this.chunkSize>0){for(var e=this.$;e&&"scroll"!==window.getComputedStyle(e).overflow;)e=e.parentElement;this.scrollContainer=e||window,this.scrollContainer.addEventListener("scroll",this.onScroll,!1)}this.isHidden||this.updateHTML()},construct:function(){if(this.dao&&this.$){if(this.painting)return void(this.repaintRequired=!0);this.painting=!0;var out=[];this.children=[],this.initializers_=[];var doneFirstItem=!1,d=this.dao;this.chunkSize&&(d=d.limit(this.chunkSize*this.chunksLoaded)),d.select({put:function(o){"read-write"===this.mode&&(o=o.model_.create(o,this.Y));var view=this.rowView({data:o,model:o.model_},this.Y);view.DAO=this.dao,"read-write"===this.mode&&o.addListener(function(){this.dao.put(o.deepClone())}.bind(this,o)),this.addChild(view),doneFirstItem?this.separatorToHTML(out):doneFirstItem=!0,this.X.selection$&&out.push('<div class="'+this.className+'-row" id="'+this.on("click",function(){this.selection=o}.bind(this))+'">'),out.push(view.toHTML()),this.X.selection$&&out.push("</div>")}.bind(this)})(function(){if(this.repaintRequired)return this.repaintRequired=!1,this.painting=!1,void this.realDAOUpdate();var e=this.$;e&&(e.innerHTML=out.join(""),this.initInnerHTML(),this.children=[],this.painting=!1)}.bind(this))}},fromElement:function(e){var children=e.children;1==children.length&&"rowView"===children[0].nodeName?this.SUPER(e):this.rowView=e.innerHTML},separatorToHTML:function(out){}},listeners:[{model_:"Method",name:"onDAOUpdate",code:function(){this.realDAOUpdate()}},{model_:"Method",name:"realDAOUpdate",code:function(){this.isHidden||this.updateHTML()},isFramed:!0},{model_:"Method",name:"onScroll",code:function(){var e=this.scrollContainer;this.chunkSize>0&&e.scrollTop+e.offsetHeight>=e.scrollHeight&&(this.chunksLoaded++,this.updateHTML())}}]}),CLASS({model_:"Model","package":"foam.ui",name:"DAODataViewTrait",exports:["dao$ as daoViewCurrentDAO$"],properties:[{model_:"Property",name:"data",postSet:function(old,nu){this.dao!==nu&&(this.dao=nu)}},{model_:"DAOProperty",name:"dao",label:"DAO",postSet:function(oldDAO,dao){dao?equals(this.data,dao)||(this.data=dao):this.data=""},help:"An alias for the data property.",onDAOUpdate:"onDAOUpdate"}],methods:{onDAOUpdate:function(){}}}),CLASS({model_:"Model","package":"foam.ui",name:"PopupChoiceView",extendsModel:"foam.ui.AbstractChoiceView",requires:["foam.ui.ChoiceListView"],traits:["foam.input.touch.VerticalScrollNativeTrait"],properties:[{model_:"Property",name:"linkLabel"},{model_:"Property",name:"iconUrl"},{model_:"Property",name:"tagName",defaultValue:"span"},{model_:"Property",name:"className",defaultValue:"popupChoiceView"},{model_:"BooleanProperty",name:"showValue"},{model_:"FunctionProperty",name:"updateListener"},{model_:"Property",name:"mode",defaultValue:"read-write"},{model_:"Property",name:"scrollerID",factory:function(){return this.id+"-popup-list-scroller"}}],actions:[{model_:"Action",name:"open",labelFn:function(){return this.linkLabel},action:function(){function mouseMove(evt){if(!view.$.contains(evt.target)){var margin=50,left=view.$.offsetLeft-margin,right=view.$.offsetWidth+left+2*margin,top=view.$.offsetTop-margin,bottom=view.$.offsetHeight+top+2*margin;left<evt.pageX&&evt.pageX<right&&top<evt.pageY&&evt.pageY<bottom||remove()}}function remove(){self.X.document.removeEventListener("touchstart",removeListener),self.X.document.removeEventListener("mousemove",mouseMove),view.$&&(view.$.outerHTML="")}var self=this,view=this.ChoiceListView.create({id:this.scrollerID,className:"popupChoiceList",data:this.data,choices:this.choices,autoSetData:this.autoSetData}),pos=findViewportXY(this.$.querySelector(".action")),e=this.X.document.body.insertAdjacentHTML("beforeend",view.toHTML()),s=this.X.window.getComputedStyle(view.$),removeListener;removeListener=function(evt){view&&view.$&&view.$.contains(evt.target)||remove()},view.data$.addListener(EventService.framed(function(){self.data=view.data,remove()},this.X)),view.$.style.top=pos[1]-2+"px";var left=Math.max(0,pos[0]-toNum(s.width)+30);view.$.style.left=left+"px",view.$.style.maxHeight=Math.max(200,this.X.window.innerHeight-pos[1]-10)+"px",view.initHTML(),this.X.document.addEventListener("touchstart",removeListener),this.X.document.addEventListener("mousemove",mouseMove)}}],methods:{toHTML:function(){return"read-only"===this.mode?'<span id="'+id+'" class="popupChoiceView-readonly">'+(this.choice&&this.choice[1]||"")+"</span>":this.SUPER()},toInnerHTML:function(){var out="";if(this.showValue){var id=this.nextID();out+='<span id="'+id+'" class="value">'+(this.choice&&this.choice[1]||"")+"</span>",this.updateListener&&this.data$.removeListener(this.updateListener),this.updateListener=function(){var e=this.X.$(id);e&&(e.innerHTML=this.choice[1])}.bind(this),this.data$.addListener(this.updateListener)}out+='<span class="action">';var action=this.model_.getAction("open");action.iconUrl=this.iconUrl;var button=this.createActionView(action).toView_();return this.addSelfDataChild(button),out+=button.toHTML(),out+="</span>"}},templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .popupChoiceList {\n        border: 2px solid grey;\n        background: white;\n        display: table-footer-group;\n        overflow-y: auto;\n        position: absolute;\n        top: 20;\n        left: 50;\n        margin: 0;\n      }\n\n      .popupChoiceList li {\n        display: block;\n        margin: 15px;\n        margin-left: -20px;\n      }\n    "),out.toString()}}]}),CLASS({model_:"Model","package":"foam.ui",name:"ChoiceListView",extendsModel:"foam.ui.AbstractChoiceView",properties:[{model_:"Property",name:"orientation",view:{factory_:"foam.ui.ChoiceView",choices:[["horizontal","Horizontal"],["vertical","Vertical"]]},defaultValue:"horizontal",postSet:function(old,nu){this.$&&(DOM.setClass(this.$,old,!1),DOM.setClass(this.$,nu))}},{model_:"Property",name:"className",defaultValueFn:function(){return"foamChoiceListView "+this.orientation}},{model_:"Property",name:"tagName",defaultValue:"ul"},{model_:"Property",name:"innerTagName",defaultValue:"li"}],methods:{init:function(){this.SUPER(),this.index$.addListener(this.updateSelected),this.choices$.addListener(this.updateSelected)},choiceToHTML:function(id,choice){return"<"+this.innerTagName+' id="'+id+'" class="choice">'+choice[1]+"</"+this.innerTagName+">"},toInnerHTML:function(){for(var out=[],i=0;i<this.choices.length;i++){var choice=this.choices[i],id=this.nextID();this.on("click",function(index){this.choice=this.choices[index]}.bind(this,i),id),out.push(this.choiceToHTML(id,choice))}return out.join("")},initInnerHTML:function(){this.SUPER(),this.updateSelected()},scrollToSelection:function(){var e=this.$.children[this.index];if(e){for(var parent=e.parentElement;parent;){var overflow=this.X.window.getComputedStyle(parent).overflow;if("scroll"===overflow||"auto"===overflow)break;parent=parent.parentElement}parent=parent||this.X.window,e.offsetTop<parent.scrollTop?e.scrollIntoView(!0):e.offsetTop+e.offsetHeight>=parent.scrollTop+parent.offsetHeight&&e.scrollIntoView()}}},listeners:[{model_:"Method",name:"updateSelected",code:function(){if(this.$&&this.$.children)for(var i=0;i<this.$.children.length;i++){var c=this.$.children[i];DOM.setClass(c,"selected",i===this.index)}}}]}),CLASS({model_:"Model","package":"foam.ui",name:"AbstractChoiceView",extendsModel:"foam.ui.View",properties:[{model_:"BooleanProperty",name:"autoSetData",help:"If true, this.data is set when choices update and the current data is not one of the choices.",defaultValue:!0},{model_:"Property",name:"text",postSet:function(_,d){for(var i=0;i<this.choices.length;i++)if(this.choices[i][1]===d)return void(this.index!==i&&(this.index=i))},help:"The user-visible text of the current choice (ie. [value, text] -> text)."},{model_:"Property",name:"choice",getter:function(){for(var value=this.data,i=0;i<this.choices.length;i++){var choice=this.choices[i];if(value===choice[0])return choice}return void 0},setter:function(choice){var oldValue=this.choice;this.autoSetData&&(this.data=choice[0]),this.text=choice[1],this.propertyChange("choice",oldValue,this.choice)},help:"The current choice (ie. [value, text])."},{model_:"Property",name:"choices",type:"Array[StringField]",preSet:function(_,a){if("object"==typeof a&&!Array.isArray(a)){var out=[];for(var key in a)a.hasOwnProperty(key)&&out.push([key,a[key]]);return out}a=a.clone();for(var i=0;i<a.length;i++)Array.isArray(a[i])||(a[i]=[a[i],a[i]]);return a},postSet:function(_,newValue){for(var value=this.data,i=0;i<newValue.length;i++){var choice=newValue[i];if(value===choice[0]){this.useSelection?this.index=i:this.choice=choice;break}}this.autoSetData&&i===newValue.length&&(this.useSelection?this.index=0:this.data=newValue.length?newValue[0][0]:void 0),this.updateHTML()}},{model_:"Property",name:"index",preSet:function(_,i){return 0>i||0==this.choices.length?0:i>=this.choices.length?this.choices.length-1:i},postSet:function(_,i){this.useSelection||this.autoSetData&&this.data!==this.choices[i][0]&&(this.data=this.choices[i][0])},help:"The index of the current choice."},{model_:"FunctionProperty",name:"objToChoice",help:"A Function which adapts an object from the DAO to a [key, value, ...] choice."},{model_:"BooleanProperty",name:"useSelection",help:"When set, data and choice do not update until an entry is firmly selected"},{model_:"DAOProperty",name:"dao",onDAOUpdate:"onDAOUpdate"},{model_:"Property",name:"data",postSet:function(old,nu){for(var i=0;i<this.choices.length;i++)if(this.choices[i][0]===nu)return void(this.index!==i&&(this.text=this.choices[i][1],this.index=i));nu&&this.choices.length&&console.warn("ChoiceView data set to invalid choice: ",nu)}}],methods:{initHTML:function(){this.SUPER(),this.dao=this.dao},findChoiceIC:function(name){name=name.toLowerCase();for(var i=0;i<this.choices.length;i++)if(this.choices[i][1].toLowerCase()==name)return this.choices[i]},commit:function(){this.useSelection&&this.choices[this.index]&&(this.choice=this.choices[this.index])}},listeners:[{model_:"Method",name:"onDAOUpdate",code:function(){this.dao.select(MAP(this.objToChoice))(function(map){this.choices=map.arg2}.bind(this))},isMerged:100}]}),CLASS({model_:"Model","package":"foam.input.touch",name:"VerticalScrollNativeTrait",requires:["foam.input.touch.GestureTarget"],properties:[{model_:"Property",name:"scroller$",getter:function(){return this.X.$(this.scrollerID)}},{model_:"Property",name:"scrollGesture",hidden:!0,"transient":!0,lazyFactory:function(){return this.scrollerID?this.GestureTarget.create({containerID:this.scrollerID,handler:this,gesture:"verticalScrollNative"}):(console.warn("VerticalScrollNativeTrait attached to View without a scrollerID property set."),"")}}],methods:{initHTML:function(){this.SUPER(),this.X.gestureManager&&this.X.gestureManager.install(this.scrollGesture),this.onScroll&&this.scroller$.addEventListener("scroll",this.onScroll)},destroy:function(isParentDestroyed){this.SUPER(isParentDestroyed),this.X.gestureManager&&this.X.gestureManager.uninstall(this.scrollGesture),this.onScroll&&this.scroller$&&this.scroller$.removeEventListener("scroll",this.onScroll)}}}),CLASS({model_:"Model","package":"foam.ui",name:"PredicatedView",extendsModel:"foam.ui.View",properties:[{model_:"Property",name:"dao",help:"Payload of the view; assumed to be a DAO."},{model_:"Property",name:"predicate",defaultValueFn:function(){return TRUE},postSet:function(_,p){this.predicatedDAO=this.dao.where(p)}},{model_:"DAOProperty",name:"predicatedDAO"},{model_:"Property",name:"view",required:!0,preSet:function(_,v){return"string"==typeof v&&(v=this.Y.lookup(v)),this.children=[v],v.data=v.dao=this.predicatedDAO$Proxy,v}}],methods:{init:function(){this.SUPER(),this.Y=this.Y.sub({DAO:this.predicatedDAO$Proxy})},toHTML:function(){return this.view.toHTML()},initHTML:function(){this.view.initHTML()}}}),CLASS({model_:"Model","package":"foam.ui",name:"ScrollView",extendsModel:"foam.ui.AbstractDAOView",requires:["foam.util.busy.BusyStatus","foam.ui.SpinnerView","foam.ui.ScrollViewRow"],traits:["foam.input.touch.VerticalScrollNativeTrait"],properties:[{model_:"Property",name:"model",defaultValueFn:function(){return this.dao.model}},{model_:"Property",name:"runway",defaultValue:800},{model_:"Property",name:"count",defaultValue:0,postSet:function(old,nu){this.scrollHeight=nu*this.rowHeight}},{model_:"Property",name:"scrollHeight",postSet:function(old,nu){this.$&&(this.container$().style.height=nu+"px")}},{model_:"Property",name:"scrollTop",defaultValue:0},{model_:"Property",name:"rowHeight",defaultValue:-1},{model_:"Property",name:"rowSizeView",hidden:!0},{model_:"Property",name:"rowView",postSet:function(_,nu){var view=this.Y.lookup(nu);view.PREFERRED_HEIGHT&&this.rowHeight<0&&(this.rowHeight=view.create({model:this.dao.model}).preferredHeight)}},{model_:"Property",name:"viewportHeight"},{model_:"Property",name:"visibleRows",factory:function(){return{}}},{model_:"Property",name:"extraRows",factory:function(){return[]}},{model_:"ArrayProperty",name:"cache",factory:function(){return[]}},{model_:"Property",name:"scrollerID",factory:function(){return this.nextID()}},{model_:"Property",name:"containerID",factory:function(){return this.nextID()}},{model_:"Property",name:"loadedTop",defaultValue:-1},{model_:"Property",name:"loadedBottom",defaultValue:-1},{model_:"Property",name:"visibleTop",defaultValue:0},{model_:"Property",name:"visibleBottom",defaultValue:0},{model_:"Property",name:"daoUpdateNumber",hidden:!0,"transient":!0,defaultValue:0},{model_:"Property",name:"mode",view:{factory_:"foam.ui.ChoiceView",choices:["read-only","read-write","final"]},defaultValue:"read-write"},{model_:"Property",name:"oldVisibleTop",defaultValue:-1},{model_:"Property",name:"oldVisibleBottom",defaultValue:-1},{model_:"Property",name:"spinnerBusyStatus",factory:function(){return this.BusyStatus.create()}},{model_:"Property",name:"busyComplete_"},{model_:"Property",name:"spinnerContainerID",factory:function(){return this.nextID()}},{model_:"Property",name:"spinner",factory:function(){return this.SpinnerView.create({data$:this.spinnerBusyStatus.busy$})}}],methods:{initHTML:function(){if(this.SUPER(),this.$.style.height||(this.$.style.height="100%"),this.addScrollListener(),this.onResize(),this.rowHeight<0){var outer=this.X.$(this.id+"-rowsize"),style=this.X.window.getComputedStyle(outer.children[0]);this.rowHeight=this.X.parseFloat(style.height),this.rowSizeView.destroy(),this.rowSizeView="",outer.outerHTML=""}this.onDAOUpdate()},container$:function(){return this.X.document.getElementById(this.containerID)},allocateVisible:function(){if(this.visibleTop!==this.oldVisibleTop||this.visibleBottom!==this.oldVisibleBottom){for(var homeless=[],foundIDs={},self=this,i=this.visibleTop;i<=this.visibleBottom;i++)this.visibleRows[i]?foundIDs[i]=!0:homeless.push(i);for(var keys=Object.keys(this.visibleRows),i=0;i<keys.length&&0!==homeless.length;i++)if(!foundIDs[keys[i]]){var h=homeless.shift(),r=self.visibleRows[keys[i]];delete self.visibleRows[keys[i]],self.visibleRows[h]=r,r.data=self.cache[h],r.y=h*self.rowHeight}if(homeless.length){for(var html=[],newViews=[],rowView=this.Y.lookup(this.rowView),i=0;i<homeless.length;i++){var h=homeless[i],x=self.cache[h];if(x)if(this.extraRows.length){var r=this.extraRows.shift();self.visibleRows[h]=r,r.data=x,r.y=h*self.rowHeight}else{var v=rowView.create({model:x.model_,data:x},this.Y),svr=self.ScrollViewRow.create({data:x,id:v.nextID()});self.visibleRows[h]=svr,html.push('<div style="width: 100%; position: absolute; height: '+self.rowHeight+'px; overflow: visible" id="'+svr.id+'">'),html.push(v.toHTML()),html.push("</div>"),newViews.push([h,svr]),svr.view=v}}html.length&&this.container$().insertAdjacentHTML("beforeend",html.join(""));for(var i=0;i<newViews.length;i++){var r=newViews[i];r[1].view.initHTML(),r[1].y=r[0]*self.rowHeight}}for(var i=0;i<this.extraRows.length;i++)this.extraRows[i].y=-1e4;this.oldVisibleTop=this.visibleTop,this.oldVisibleBottom=this.visibleBottom}},destroy:function(isParentDestroyed){this.SUPER(isParentDestroyed);for(var keys=Object.keys(this.visibleRows),i=0;i<keys.length;i++)this.visibleRows[keys[i]].destroy();for(this.visibleRows={},i=0;i<this.extraRows.length;i++)this.extraRows[i].destroy();this.extraRows=[],this.cache=[],this.loadedTop=-1,this.loadedBottom=-1,this.oldVisibleBottom=-1,this.oldVisibleTop=-1,this.removeScrollListener()},invalidate:function(){if(this.visibleRows){for(var keys=Object.keys(this.visibleRows),i=0;i<keys.length;i++)this.extraRows.push(this.visibleRows[keys[i]]);this.visibleRows={}}this.cache=[],this.loadedTop=-1,this.loadedBottom=-1,this.oldVisibleBottom=-1,this.oldVisibleTop=-1},addScrollListener:function(){this.$&&this.$.ownerDocument.defaultView.addEventListener("resize",this.onResize)},removeScrollListener:function(){this.$&&this.$.ownerDocument.defaultView.removeEventListener("resize",this.onResize)}},listeners:[{model_:"Method",name:"onResize",code:function(){this.viewportHeight=this.$.offsetHeight},isMerged:100},{model_:"Method",name:"onScroll",code:function(){this.scrollTop=this.scroller$.scrollTop,this.update()}},{model_:"Method",name:"onDAOUpdate",code:function(){this.invalidate();var oldComplete=this.busyComplete_;this.busyComplete_=this.spinnerBusyStatus.start(),oldComplete&&oldComplete(),this.dao.select(COUNT())(function(c){this.count=c.count;var s=this.scroller$;s&&(s.scrollTop=this.scrollTop),this.X.setTimeout(this.update.bind(this),0)}.bind(this))},isFramed:!0},{model_:"Method",name:"update",code:function(){if(this.$&&!(this.rowHeight<0)){var runwayCount=Math.ceil(this.runway/this.rowHeight);this.visibleIndex=Math.floor(this.scrollTop/this.rowHeight),this.visibleTop=Math.max(0,this.visibleIndex-runwayCount),this.visibleBottom=Math.min(this.count-1,this.visibleIndex+Math.ceil((this.runway+this.viewportHeight)/this.rowHeight));var maxVisible=Math.ceil((2*this.runway+this.viewportHeight)/this.rowHeight);this.visibleBottom-this.visibleTop+1<maxVisible&&(0===this.visibleTop?this.visibleBottom=Math.min(maxVisible-1,this.count-1):this.visibleTop=Math.max(0,this.visibleBottom-maxVisible+1));var toLoadTop,toLoadBottom;if(this.visibleTop>=this.loadedTop&&this.visibleBottom<=this.loadedBottom||(this.visibleTop<this.loadedTop&&this.visibleBottom>=this.loadedTop?(toLoadBottom=this.loadedTop-1,toLoadTop=Math.max(0,this.visibleTop-2*runwayCount)):this.visibleBottom>this.loadedBottom&&this.visibleTop<=this.loadedBottom?(toLoadTop=this.loadedBottom+1,toLoadBottom=Math.min(this.count-1,this.visibleBottom+2*runwayCount)):(this.invalidate(),toLoadTop=Math.max(0,this.visibleTop-2*runwayCount),toLoadBottom=Math.min(this.count,this.visibleBottom+2*runwayCount))),toLoadTop>=0&&toLoadBottom>=0&&toLoadBottom>=toLoadTop){var self=this,updateNumber=++this.daoUpdateNumber;this.dao.skip(toLoadTop).limit(toLoadBottom-toLoadTop+1).select()(function(a){if(updateNumber===self.daoUpdateNumber&&a&&a.length){self.busyComplete_();for(var i=0;i<a.length;i++){var o=a[i];"read-write"===self.mode&&(o=a[i].clone(),o.addListener(function(x){this.dao.put(x.deepClone())}.bind(self,o))),self.cache[toLoadTop+i]=o}self.loadedTop=self.loadedTop>=0?Math.min(toLoadTop,self.loadedTop):toLoadTop,self.loadedBottom=Math.max(toLoadBottom,self.loadedBottom),self.allocateVisible()}})}else this.allocateVisible(),this.busyComplete_()}}}],templates:[{model_:"Template",name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      "),this.destroy(),out('\n      <div id="',self.id,'" style="overflow:hidden;position:relative">\n        '),this.rowHeight<0&&(out('\n          <div id="',this.id+"-rowsize",'" style="visibility: hidden">\n            '),this.rowSizeView=this.Y.lookup(this.rowView).create({data:this.dao.model.create()},this.Y),out(this.rowSizeView.toHTML()),this.addChild(this.rowSizeView),out("\n          </div>\n        ")),out('\n        <div id="',self.spinnerContainerID,'" style="display: none; width: 100%; height: 100%">\n          ',this.spinner,"\n        </div>\n        "),this.addInitializer(function(){self.spinnerBusyStatus.busy$.addListener(function(){var e=this.X.$(self.spinnerContainerID);e&&(e.style.display=self.spinnerBusyStatus.busy?"block":"none")})}),out('\n        <div id="',self.scrollerID,'" style="-webkit-overflow-scrolling: touch; overflow-y: scroll; width:100%; height: 100%;">\n          <div id="',self.containerID,'" style="position:relative;width:100%;height:100%; -webkit-transform: translate3d(0px, 0px, 0px);">\n          </div>\n        </div>\n      </div>\n    '),out.toString()}}]}),CLASS({model_:"Model","package":"foam.util.busy",name:"BusyStatus",imports:["clearTimeout","setTimeout"],properties:[{model_:"Property",name:"busy",defaultValue:!1},{model_:"Property",name:"minPreSpinnerWait",units:"ms",defaultValue:500},{model_:"Property",name:"minSpinnerShowTime",units:"ms",defaultValue:500},{model_:"Property",name:"waiting_",hidden:!0,getter:function(){return Object.keys(this.processes_).length>0}},{model_:"Property",name:"processes_",factory:function(){return{}}},{model_:"Property",name:"nextProcessId_",defaultValue:0},{model_:"Property",name:"timer_"}],methods:{start:function(){var alreadyWaiting=this.waiting_,pid=this.nextProcessId_++;this.processes_[pid]=!0;var completeFunc=this.done_.bind(this,pid);return alreadyWaiting?completeFunc:(this.timer_&&this.clearTimeout(this.timer_),this.timer_=this.setTimeout(this.onTimer,this.minPreSpinnerWait),completeFunc)},done_:function(pid){this.processes_[pid]&&(delete this.processes_[pid],this.waiting_||(this.timer_&&!this.busy?(this.clearTimeout(this.timer_),this.timer_=""):this.busy&&(this.busy=!1)))}},listeners:[{model_:"Method",name:"onTimer",code:function(){var waiting=this.waiting_;this.timer_="",this.busy&&!waiting?this.busy=!1:!this.busy&&waiting&&(this.busy=!0)}}]}),CLASS({model_:"Model","package":"foam.ui",name:"SpinnerView",extendsModel:"foam.ui.View",properties:[{model_:"Property",name:"data",defaultValue:!0,postSet:function(old,nu){this.$&&(nu?!old&&nu&&(this.$.innerHTML=this.toInnerHTML(),this.initInnerHTML()):this.$.innerHTML="")}},{model_:"Property",name:"color",defaultValue:"#4285F4"},{model_:"Property",name:"extraClassName",defaultValue:"spinner-container"}],constants:[{model_:"Constant",name:"DURATION",value:"1333"}],methods:{initHTML:function(){this.SUPER(),this.data=this.data}},templates:[{model_:"Template",name:"CSS",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);out("\n      ");var prefixes=["-webkit-","-moz-",""];out("\n      ");var bezier="cubic-bezier(0.4, 0.0, 0.2, 1)";out("\n      .spinner-container {\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        height: 100%;\n        width: 100%;\n      }\n      .spinner-fixed-box {\n        position: relative;\n        height: 64px;\n        width: 64px;\n        ");for(var i=0;i<prefixes.length;i++)out("\n          ",prefixes[i],"transform: translate3d(0px, 0px, 0px);\n        ");out("\n      }\n\n      .spinner-turning-box {\n        ");for(var i=0;i<prefixes.length;i++)out("\n          ",prefixes[i],"animation: container-rotate 1568ms linear infinite;\n        ");out("\n        width: 100%;\n        height: 100%;\n      }\n\n      .spinner-layer {\n        position: absolute;\n        height: 100%;\n        width: 100%;\n        ");for(var j=0;j<prefixes.length;j++)out("\n          ",prefixes[j],"animation: fill-unfill-rotate ",4*this.DURATION,"ms ",bezier," infinite both;\n        ");out("\n      }\n\n      .spinner-circle-clipper {\n        overflow: hidden;\n        border-color: inherit;\n        display: inline-block;\n        height: 100%;\n        position: relative;\n        width: 50%;\n      }\n\n      .spinner-circle-clipper.spinner-clipper-left .spinner-circle {\n        ");for(var i=0;i<prefixes.length;i++)out("\n          ",prefixes[i],"animation: left-spin ",this.DURATION,"ms ",bezier," infinite;\n          ",prefixes[i],"transform: rotate(129deg);\n        ");out("\n        border-right-color: transparent !important;\n      }\n\n      .spinner-circle-clipper.spinner-clipper-right .spinner-circle {\n        ");for(var i=0;i<prefixes.length;i++)out("\n          ",prefixes[i],"animation: right-spin ",this.DURATION,"ms ",bezier," infinite;\n          ",prefixes[i],"transform: rotate(-129deg);\n        ");out("\n        border-left-color: transparent !important;\n        left: -100%\n      }\n\n      .spinner-circle-clipper .spinner-circle {\n        width: 200%;\n      }\n\n      .spinner-circle {\n        position: absolute;\n        top: 0;\n        bottom: 0;\n        left: 0;\n        right: 0;\n        box-sizing: border-box;\n        height: 100%;\n        border-width: 4px;\n        border-style: solid;\n        border-color: inherit;\n        border-bottom-color: transparent !important;\n        border-radius: 50%;\n        ");for(var i=0;i<prefixes.length;i++)out("\n          ",prefixes[i],"animation: none;\n        ");out("\n      }\n\n      .spinner-gap-patch {\n        position: absolute;\n        box-sizing: border-box;\n        top: 0;\n        left: 45%;\n        width: 10%;\n        height: 100%;\n        overflow: hidden;\n        border-color: inherit;\n      }\n\n      .spinner-gap-patch .spinner-circle {\n        width: 1000%;\n        left: -450%;\n      }\n\n      ");
for(var i=0;i<prefixes.length;i++)out("\n        @",prefixes[i],"keyframes fill-unfill-rotate {\n          12.5% { ",prefixes[i],"transform: rotate(135deg); }\n          25%   { ",prefixes[i],"transform: rotate(270deg); }\n          37.5% { ",prefixes[i],"transform: rotate(405deg); }\n          50%   { ",prefixes[i],"transform: rotate(540deg); }\n          62.5% { ",prefixes[i],"transform: rotate(675deg); }\n          75%   { ",prefixes[i],"transform: rotate(810deg); }\n          87.5% { ",prefixes[i],"transform: rotate(945deg); }\n          to    { ",prefixes[i],"transform: rotate(1080deg); }\n        }\n\n        @",prefixes[i],"keyframes left-spin {\n          from { ",prefixes[i],"transform: rotate(130deg); }\n          50%  { ",prefixes[i],"transform: rotate(-5deg); }\n          to   { ",prefixes[i],"transform: rotate(130deg); }\n        }\n\n        @",prefixes[i],"keyframes right-spin {\n          from { ",prefixes[i],"transform: rotate(-130deg); }\n          50%  { ",prefixes[i],"transform: rotate(5deg); }\n          to   { ",prefixes[i],"transform: rotate(-130deg); }\n        }\n\n        @",prefixes[i],"keyframes container-rotate {\n          to { ",prefixes[i],"transform: rotate(360deg);\n        }\n      ");return out("\n    "),out.toString()}},{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('\n      <div class="spinner-fixed-box">\n        <div class="spinner-turning-box">\n          <div class="spinner-layer" style="border-color: ',this.color,'">\n            <div class="spinner-circle-clipper spinner-clipper-left"><div class="spinner-circle"></div></div><div class="spinner-gap-patch"><div class="spinner-circle"></div></div><div class="spinner-circle-clipper spinner-clipper-right"><div class="spinner-circle"></div></div>\n          </div>\n        </div>\n      </div>\n    '),out.toString()}}]}),CLASS({model_:"Model","package":"foam.ui",name:"ScrollViewRow",requires:["foam.ui.DetailView"],properties:[{model_:"Property",name:"data",postSet:function(old,nu){if(this.view&&(this.view.data=nu,!this.DetailView.isInstance(this.view))){var e=this.X.$(this.id);e.innerHTML=this.view.toHTML(),this.view.initHTML()}}},{model_:"Property",name:"view",postSet:function(old,nu){nu&&(nu.data=this.data)}},{model_:"Property",name:"id"},{model_:"Property",name:"y",postSet:function(old,nu){this.view&&this.id&&old!==nu&&(this.X.$(this.id).style.webkitTransform="translate3d(0px,"+nu+"px, 0px)")}}],methods:{destroy:function(isParentDestroyed){this.view.destroy(isParentDestroyed)}}}),CLASS({model_:"Model","package":"foam.ui",name:"DetailView",extendsModel:"foam.ui.View",requires:["Property","foam.ui.TextFieldView","foam.ui.IntFieldView","foam.ui.FloatFieldView","foam.ui.DAOController"],exports:["propertyViewProperty"],properties:[{model_:"Property",name:"className",defaultValue:"detailView"},{model_:"Property",name:"data",preSet:function(old,nu){return nu.model_&&(this.model=nu.model_),nu}},{model_:"Property",name:"model",type:"Model"},{model_:"Property",name:"title",defaultValueFn:function(){return"Edit "+this.model.label}},{model_:"StringProperty",name:"mode",defaultValue:"read-write"},{model_:"BooleanProperty",name:"showRelationships",defaultValue:!1},{model_:"Property",name:"propertyViewProperty",type:"Property",defaultValueFn:function(){return this.Property.DETAIL_VIEW}}],methods:{shouldDestroy:function(old,nu){return old&&old.model_&&nu&&nu.model_?old.model_!==nu.model_:!0},generateContent:function(){this.$&&(this.$.outerHTML=this.toHTML(),this.initHTML())},titleHTML:function(){var title=this.title;return title?'<tr><th colspan=2 class="heading">'+title+"</th></tr>":""},startForm:function(){return"<table>"},endForm:function(){return"</table>"},startColumns:function(){return"<tr><td colspan=2><table valign=top><tr><td valign=top><table>"},nextColumn:function(){return"</table></td><td valign=top><table valign=top>"},endColumns:function(){return"</table></td></tr></table></td></tr>"},rowToHTML:function(prop,view){var str="";return prop.detailViewPreRow&&(str+=prop.detailViewPreRow(this)),str+='<tr class="detail-'+prop.name+'">',this.DAOController.isInstance(view)?(str+="<td colspan=2><div class=detailArrayLabel>"+prop.label+"</div>",str+=view.toHTML(),str+="</td>"):(str+="<td class='label'>"+prop.label+"</td>",str+="<td>",str+=view.toHTML(),str+="</td>"),str+="</tr>",prop.detailViewPostRow&&(str+=prop.detailViewPostRow(this)),str},toHTML:function(){if(!this.data)return'<span id="'+this.id+'"></span>';if(!this.model)throw"DetailView: either 'data' or 'model' must be specified.";return(this.model.getPrototype().toDetailHTML||this.defaultToHTML).call(this)},defaultToHTML:function(){this.children=[];var model=this.model,str="";str+='<div id="'+this.id+'" '+this.cssClassAttr()+'" name="form">',str+=this.startForm(),str+=this.titleHTML();for(var i=0;i<model.properties_.length;i++){var prop=model.properties_[i];if(!prop.hidden){var view=this.createView(prop);this.addDataChild(view),str+=this.rowToHTML(prop,view)}}if(str+=this.endForm(),this.showRelationships){var view=this.RelationshipsView.create({data:this.data});this.addDataChild(view),str+=view.toHTML()}return str+="</div>"}},templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n          .detailView {\n            border: solid 2px #dddddd;\n            background: #fafafa;\n            width: 99%;\n          }\n\n          .detailView .heading {\n            float: left;\n            font-size: 14px;\n            font-weight: bold;\n            margin-bottom: 8px;\n          }\n\n          .detailView .propertyLabel {\n            font-size: 14px;\n            display: block;\n            font-weight: bold;\n            text-align: right;\n            float: left;\n          }\n\n          .detailView input {\n            font-size: 12px;\n            padding: 4px 2px;\n            border: solid 1px #aacfe4;\n            margin: 2px 0 0px 10px;\n          }\n\n          .detailView textarea {\n            float: left;\n            font-size: 12px;\n            padding: 4px 2px;\n            border: solid 1px #aacfe4;\n            margin: 2px 0 0px 10px;\n            width: 98%;\n            overflow: auto;\n          }\n\n          .detailView select {\n            font-size: 12px;\n            padding: 4px 2px;\n            border: solid 1px #aacfe4;\n            margin: 2px 0 0px 10px;\n          }\n\n          .detailView .label {\n            vertical-align: top;\n          }\n\n          .detailArrayLabel {\n            font-size: medium;\n          }\n\n          .detailArrayLabel .foamTable {\n            margin: 1px;\n            width: 99%;\n          }\n      "),out.toString()}}]}),CLASS({model_:"Model","package":"foam.ui",name:"IntFieldView",extendsModel:"foam.ui.AbstractNumberFieldView",methods:{textToValue:function(text){return parseInt(text)||"0"},valueToText:function(value){return value?value:"0"}}}),CLASS({model_:"Model","package":"foam.ui",name:"AbstractNumberFieldView",extendsModel:"foam.ui.TextFieldView",properties:[{model_:"Property",name:"type",defaultValue:"number"},{model_:"Property",name:"step"}],methods:{extraAttributes:function(){return this.step?' step="'+this.step+'"':""}}}),CLASS({model_:"Model","package":"foam.ui",name:"FloatFieldView",extendsModel:"foam.ui.AbstractNumberFieldView",properties:[{model_:"Property",name:"precision",defaultValue:""}],methods:{formatNumber:function(val){if(!val)return"0";val=val.toFixed(this.precision);for(var i=val.length-1;i>0&&"0"===val.charAt(i);i--);return val.substring(0,"."===val.charAt(i)?i:i+1)},valueToText:function(val){return this.hasOwnProperty("precision")?this.formatNumber(val):""+val},textToValue:function(text){return parseFloat(text)||0}}}),CLASS({model_:"Model","package":"foam.ui",name:"DAOController",label:"DAO Controller",extendsModel:"foam.ui.View",requires:["SearchBorder"],properties:[{model_:"ModelProperty",name:"model"},{model_:"Property",name:"subType",setter:function(v){this.model=v}},{model_:"Property",name:"dao",view:"foam.ui.TableView"},{model_:"Property",name:"data",getter:function(){return this.dao},setter:function(v){this.dao=v}},{model_:"Property",name:"selection"},{model_:"BooleanProperty",name:"useSearchView",postSet:function(_,value){value&&this.addDecorator(this.SearchBorder.create({model:this.model,data:this.data}))},defaultValue:!1}],actions:[{model_:"Action",name:"new",help:"Create a new record.",action:function(){var createView=this.X.DAOCreateController.create({model:this.model,dao:this.dao,showActions:!0});createView.parentController=this,this.X.stack.pushView(createView,"New")}},{model_:"Action",name:"edit",help:"Edit the current record.","default":"true",action:function(){this.selection=this.daoView.selection;for(var obj=this.selection,actions=this.X.DAOUpdateController.actions.slice(0),i=0;i<this.model.actions.length;i++){var action=this.model.actions[i],newAction=this.X.Action.create(action);newAction.action=function(oldAction){return function(){oldAction.call(obj)}}(action.action),actions.push(newAction)}console.log(["selection: ",this.selection]);var updateView=this.X.DAOUpdateController.create({data:this.selection,model:this.model,dao:this.dao,showActions:!0});this.X.stack.pushView(updateView,"Edit")}},{model_:"Action",name:"delete",help:"Delete the current record.",action:function(){this.selection=this.daoView.selection;var self=this;this.dao.remove(this.selection)}}],methods:{init:function(){this.SUPER(),this.showActions=!0},initHTML:function(){this.SUPER(),this.daoView.subscribe(this.daoView.DOUBLE_CLICK,this.onDoubleClick),this.daoView.selection$.addListener(this.onSelection)}},listeners:[{model_:"Method",name:"onDoubleClick",code:function(evt){for(var i=0;i<this.model_.actions.length;i++){var action=this.model_.actions[i];if(action["default"]){action.action.call(this);break}}}},{model_:"Method",name:"onSelection",code:function(evt){var obj=this.daoView.selection;obj&&this.X.stack.setPreview(this.X.SummaryView.create({model:this.model,data:this.daoView.selection}))}}],templates:[{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out(" ",self.createTemplateView("dao",{model:this.model})," "),out.toString()}}]}),CLASS({model_:"Model","package":"foam.ui",name:"AbstractDAOView",extendsModel:"foam.ui.View",exports:["dao$ as daoViewCurrentDAO$"],properties:[{model_:"Property",name:"data",postSet:function(oldDAO,dao){this.dao!==dao&&(this.dao=dao)}},{model_:"DAOProperty",name:"dao",label:"DAO",postSet:function(oldDAO,dao){dao?this.data!==dao&&(this.data=dao):this.data=""},help:"An alias for the data property.",onDAOUpdate:"onDAOUpdate"}],methods:{onDAOUpdate:function(){}}}),CLASS({model_:"Model","package":"foam.ui",name:"SwipeAltView",extendsModel:"foam.ui.View",requires:["foam.input.touch.GestureTarget","foam.ui.md.ChoiceListView"],properties:[{model_:"Property",name:"views",type:"Array",subType:"foam.ui.ViewChoice",view:"foam.ui.ArrayView",factory:function(){return[]},help:"View Choices"},{model_:"Property",name:"index",hidden:!0,defaultValue:0,preSet:function(old,nu){return 0>nu?0:nu>=this.views.length?this.views.length-1:nu},postSet:function(oldValue,viewChoice){this.views[oldValue].view().deepPublish(this.ON_HIDE),this.snapToCurrent(Math.abs(oldValue-viewChoice))},help:"The index of the currently selected view"},{model_:"Property",name:"headerView",factory:function(){return this.ChoiceListView.create({choices:this.views.map(function(x){return x.label}),index$:this.index$,className:"swipeAltHeader foamChoiceListView horizontal"},this.Y)},help:"Optional View to be displayed in header."},{model_:"Property",name:"slider",hidden:!0,help:"Internal element which gets translated around"},{model_:"Property",name:"width",hidden:!0,getter:function(){return this.$.clientWidth},help:"Set when we know the width"},{model_:"Property",name:"x",hidden:!0,postSet:function(old,nu){this.slider.style["-webkit-transform"]="translate3d(-"+nu+"px, 0, 0)"},help:"X coordinate of the translation"},{model_:"Property",name:"swipeGesture",hidden:!0,"transient":!0,factory:function(){return this.GestureTarget.create({containerID:this.id,handler:this,gesture:"horizontalScroll"})}}],methods:{init:function(){this.SUPER();var self=this;this.views.forEach(function(choice,index){index!=self.index&&choice.view().deepPublish(self.ON_HIDE)}),this.views[this.index].view().deepPublish(this.ON_SHOW)},toHTML:function(){var str=[],viewChoice=this.views[this.index];return this.headerView&&(str.push(this.headerView.toHTML()),this.addChild(this.headerView)),str.push('<div id="'+this.id+'" class="swipeAltOuter">'),str.push('<div class="swipeAltSlider" style="width: 100%">'),str.push('<div class="swipeAltInner" style="left: 0px">'),str.push(viewChoice.view().toHTML()),str.push("</div>"),str.push("</div>"),str.push("</div>"),str.join("")},initHTML:function(){if(this.$){this.SUPER(),this.slider=this.$.children[0];for(var str=[],i=0;i<this.views.length;i++)str.push('<div class="swipeAltInner"'+(i?' style="visibility:hidden;"':"")+">"),str.push(this.views[i].view().toHTML()),str.push("</div>");this.slider.innerHTML=str.join(""),window.addEventListener("resize",this.resize,!1),this.X.gestureManager.install(this.swipeGesture);var self=this;window.setTimeout(function(){self.resize(),self.views.forEach(function(choice){choice.view().initHTML()});for(var vs=self.slider.querySelectorAll(".swipeAltInner"),i=0;i<vs.length;i++)vs[i].style.visibility=""},0)}},destroy:function(isParentDestroyed){this.SUPER(isParentDestroyed),this.X.gestureManager.uninstall(this.swipeGesture),this.views.forEach(function(c){c.view().destroy()})},snapToCurrent:function(sizeOfMove){var self=this,time=150+150*sizeOfMove;Movement.animate(time,function(evt){self.x=self.index*self.width},Movement.ease(150/time,150/time),function(){self.views[self.index].view().deepPublish(self.ON_SHOW)})()}},listeners:[{model_:"Method",name:"resize",code:function(){if(!this.$)return void window.removeEventListener("resize",this.resize,!1);var self=this,frame=window.requestAnimationFrame(function(){self.x=self.index*self.width;for(var i=0;i<self.slider.children.length;i++)self.slider.children[i].style.left=100*i+"%",self.slider.children[i].style.visibility="";window.cancelAnimationFrame(frame)})},isMerged:100},{model_:"Method",name:"horizontalScrollMove",code:function(dx,tx,x){var x=this.index*this.width-tx;0>x&&(x=0);var maxWidth=(this.views.length-1)*this.width;x>maxWidth&&(x=maxWidth),this.x=x}},{model_:"Method",name:"horizontalScrollEnd",code:function(dx,tx,x){Math.abs(tx)>this.width/3?0>tx?this.index++:this.index--:this.snapToCurrent(1)}}],templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .swipeAltInner {\n        position: absolute;\n        top: 0px;\n        height: 100%;\n        width: 100%;\n      }\n\n      .swipeAltOuter {\n        display: flex;\n        overflow: hidden;\n        min-width: 240px;\n        width: 100%;\n      }\n\n      .swipeAltSlider {\n        position: relative;\n        width: 100%;\n        top: 0px;\n        -webkit-transform: translate3d(0,0,0);\n      }\n\n    "),out.toString()}}]}),CLASS({model_:"Model","package":"foam.ui.md",name:"ChoiceListView",extendsModel:"foam.ui.ChoiceListView",requires:["foam.ui.md.Flare"],properties:[{model_:"Property",name:"autoSetData",defaultValue:!1},{model_:"Property",name:"extraClassName",defaultValue:"mdChoiceListView"},{model_:"Property",name:"flareFactory",factory:function(){return this.Flare.xbind({color:"rgb(255,255,255)",startAlpha:.2,cssPosition:"absolute",startX:.5,startY:.5,growTime:250,fadeTime:250})}}],methods:{initHTML:function(){this.SUPER.apply(this,arguments);for(var i=0;i<this.choices.length;++i){var choice=this.choices[i];choice.flare=this.Flare.create({element:this.X.$(choice.htmlId),color:"rgb(255,255,255)",startAlpha:.2,cssPosition:"absolute",startX:.5,startY:.5,growTime:250,fadeTime:250}),this.on("click",function(index,e){var flare=this.choices[index].flare,choice=this.choice=this.choices[index],element=this.X.$(choice.htmlId),pointMap=e.pointMap,x=element.offsetLeft,y=element.offsetTop,w=element.offsetWidth,h=element.offsetHeight,startX=.5,startY=.5;Object_forEach(e.pointMap,function(p){p.x>=x&&p.x<=x+w&&p.y>=y&&p.y<=y+h&&(startX=(p.x-x)/w,startY=(p.y-y)/h)}),flare.startX=startX,flare.startY=startY,flare.fire()}.bind(this,i),choice.htmlId)}},toInnerHTML:function(){for(var out=[],i=0;i<this.choices.length;i++){var choice=this.choices[i],id=choice.htmlId=choice.htmlId||this.nextID();out.push(this.choiceToHTML(id,choice))}return out.join("")}},templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .mdChoiceListView.horizontal > li.choice {\n        position: relative;\n        overflow: hidden;\n        display: inline-block;\n        line-height: 1.25em;\n        border-radius: 2px 2px 0px 0px;\n      }\n      .mdChoiceListView.horizontal > li.selected {\n        line-height: 1.0em;\n        border-bottom: 2px solid #ffffff;\n      }\n    "),out.toString()}}]}),CLASS({model_:"Model","package":"foam.ui.md",name:"Flare",requires:["foam.graphics.Circle"],properties:[{model_:"Property",name:"color"},{model_:"Property",name:"element"},{model_:"Property",name:"startAlpha",defaultValue:1},{model_:"Property",name:"startX",defaultValue:1},{model_:"Property",name:"startY",defaultValue:1},{model_:"Property",name:"cssPosition",defaultValue:"fixed"},{model_:"Property",name:"state",defaultValue:"detached"},{model_:"IntProperty",name:"growTime",defaultValue:400},{model_:"IntProperty",name:"fadeTime",defaultValue:200}],listeners:[{model_:"Method",name:"fire",code:function(){var w=this.element.offsetWidth,h=this.element.offsetHeight,c=this.Circle.create({r:0,width:w,height:h,x:this.startX*w,y:this.startY*h,color:this.color,alpha:this.startAlpha});0==this.startX&&0==this.startY?(c.startAngle=1.5*Math.PI,c.endAngle=2*Math.PI):0==this.startX&&1==this.startY?(c.startAngle=0,c.endAngle=Math.PI/2):1==this.startX&&0==this.startY?(c.startAngle=Math.PI,c.endAngle=1.5*Math.PI):1==this.startX&&1==this.startY&&(c.startAngle=Math.PI/2,c.endAngle=Math.PI);var view=c.toView_(),div=document.createElement("div"),dStyle=div.style;dStyle.position=this.cssPosition,dStyle.left=0,dStyle.top=0,dStyle.zIndex=4;var id=this.X.lookup("foam.ui.View").getPrototype().nextID();div.id=id,div.innerHTML=view.toHTML(),this.state="growing",this.element.appendChild(div),view.initHTML(),Movement.compile([[this.growTime,function(){c.r=1.25*Math.sqrt(w*w+h*h)}],function(){this.state="fading"}.bind(this),[this.fadeTime,function(){c.alpha=0}],function(){div.remove(),this.state="detached"}.bind(this)])(),c.r$.addListener(EventService.framed(view.paint.bind(view))),c.alpha$.addListener(EventService.framed(view.paint.bind(view)))}}]}),CLASS({model_:"Model","package":"foam.ui",name:"ViewChoice",tableProperties:["label","view"],properties:[{model_:"Property",name:"label",type:"String",displayWidth:20,defaultValue:"",help:"View's label."},{model_:"ViewFactoryProperty",name:"view",type:"view",help:"View factory.",defaultValue:"foam.ui.DetailView"}]}),CLASS({model_:"Model","package":"foam.util.busy",name:"BusyFlagTracker",properties:[{model_:"Property",name:"busyStatus"},{model_:"Property",name:"target",postSet:function(oldTarget,newTarget){this.callback&&(this.callback(),this.callback=null),oldTarget&&oldTarget.remoteListener(this.onChange),newTarget.addListener(this.onChange)}},{model_:"Property",name:"callback"}],listeners:[{model_:"Method",name:"onChange",code:function(_,_,oldValue,newValue){newValue?(this.callback&&this.callback(),this.callback=this.busyStatus.start()):(this.callback(),this.callback=null)}}]}),CLASS({model_:"Model","package":"foam.ui.layout",name:"FloatingView",extendsModel:"foam.ui.View",traits:["foam.ui.layout.PositionedDOMViewTrait"],properties:[{model_:"Property",name:"view"},{model_:"Property",name:"width",defaultValue:300},{model_:"Property",name:"preferredWidth",defaultValueFn:function(){return this.view.preferredWidth}},{model_:"Property",name:"height",defaultValue:300},{model_:"Property",name:"className",defaultValue:"floatingView"}],methods:{destroy:function(){this.SUPER(),this.view.destroy()}},templates:[{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out(" ",self.view," "),out.toString()}}]}),CLASS({model_:"Model","package":"foam.input.touch",name:"GestureManager",requires:["foam.input.touch.DragGesture","foam.input.touch.Gesture","foam.input.touch.GestureTarget","foam.input.touch.PinchTwistGesture","foam.input.touch.ScrollGesture","foam.input.touch.TapGesture","foam.input.touch.InputPoint"],imports:["document","touchManager"],properties:[{model_:"Property",name:"gestures",factory:function(){return{verticalScroll:this.ScrollGesture.create(),verticalScrollMomentum:this.ScrollGesture.create({momentumEnabled:!0}),verticalScrollNative:this.ScrollGesture.create({nativeScrolling:!0}),horizontalScroll:this.ScrollGesture.create({direction:"horizontal"}),horizontalScrollMomentum:this.ScrollGesture.create({direction:"horizontal",momentumEnabled:!0}),horizontalScrollNative:this.ScrollGesture.create({direction:"horizontal",nativeScrolling:!0}),tap:this.TapGesture.create(),drag:this.DragGesture.create(),pinchTwist:this.PinchTwistGesture.create()}}},{model_:"Property",name:"targets",factory:function(){return{}}},{model_:"Property",name:"active",factory:function(){return{}},help:"Gestures that are active right now and should be checked for recognition. This is the gestures active on the FIRST touch. Rectangles are not checked for subsequent touches."},{model_:"Property",name:"recognized",help:"Set to the recognized gesture. Cleared when all points are lifted."},{model_:"Property",name:"points",factory:function(){return{}}},{model_:"Property",name:"wheelTimer"},{model_:"Property",name:"scrollWheelTimeout",defaultValue:300},{model_:"Property",name:"scrollViewTargets",defaultValue:0}],methods:{init:function(){this.SUPER(),this.touchManager.subscribe(this.touchManager.TOUCH_START,this.onTouchStart),this.touchManager.subscribe(this.touchManager.TOUCH_MOVE,this.onTouchMove),this.touchManager.subscribe(this.touchManager.TOUCH_END,this.onTouchEnd),this.document.addEventListener("mousedown",this.onMouseDown),this.document.addEventListener("mousemove",this.onMouseMove),this.document.addEventListener("mouseup",this.onMouseUp),this.document.addEventListener("wheel",this.onWheel),this.document.addEventListener("contextmenu",this.onContextMenu)},install:function(target){target.containerID?(this.targets[target.containerID]||(this.targets[target.containerID]=[]),this.targets[target.containerID].push(target)):console.warn("no container ID on touch target")},uninstall:function(target){var arr=this.targets[target.containerID];if(arr){for(var i=0;i<arr.length;i++)if(arr[i]===target){arr.splice(i,1);break}0===arr.length&&delete this.targets[target.containerID]}},purge:function(){for(var keys=Object.keys(this.targets),count=0,i=0;i<keys.length;i++)this.document.getElementById(keys[i])||(delete this.targets[keys[i]],count++);return console.log("Purged "+count+" targets"),count},activateContainingGestures:function(x,y,opt_predicate){for(var e=this.X.document.elementFromPoint(x,y);e;){if(e.id){var matches=this.targets[e.id];if(matches&&matches.length)for(var i=0;i<matches.length;i++){var t=matches[i],g=this.gestures[t.gesture];!g||opt_predicate&&!opt_predicate(g)||(this.active[g.name]||(this.active[g.name]=[]),this.active[g.name].push(t))}}e=e.parentNode}},checkRecognition:function(){if(!this.recognized){var self=this,matches=[];if(Object.keys(this.active).forEach(function(name){var answer=self.gestures[name].recognize(self.points);answer>=self.Gesture.WAIT&&matches.push([name,answer])}),0!==matches.length){var i,lastYes=-1;for(i=0;i<matches.length;i++)matches[i][1]===this.Gesture.YES&&(lastYes=i);var lastMaybe=-1;for(i=0;i<matches.length;i++)matches[i][1]===this.Gesture.MAYBE&&(lastMaybe=i);var match;if(0>lastYes){if(matches.length>1||0>lastMaybe)return;match=matches[lastMaybe][0]}else match=matches[lastYes][0];var matched=this.active[match],legal=[];for(i=0;i<matched.length;i++){for(var m=matched[i].getElement(),contained=0,j=0;j<matched.length;j++){var n=matched[j].getElement();m!==n&&m.contains(n)&&contained++}0===contained&&legal.push(matched[i].handler)}this.gestures[match].attach(this.points,legal),this.recognized=this.gestures[match]}}},resetState:function(){this.active={},this.recognized=null,this.points={}}},listeners:[{model_:"Method",name:"onTouchStart",code:function(_,__,touch){if(this.recognized)return void(this.recognized.addPoint&&this.recognized.addPoint(touch));var pointCount=Object.keys(this.points).length;pointCount||this.activateContainingGestures(touch.x,touch.y),this.points[touch.id]=touch,this.checkRecognition()}},{model_:"Method",name:"onMouseDown",code:function(event){var point=this.InputPoint.create({id:"mouse",type:"mouse",x:event.clientX,y:event.clientY});if(this.recognized)return void(this.recognized.addPoint&&this.recognized.addPoint(point));var pointCount=Object.keys(this.points).length;pointCount||this.activateContainingGestures(point.x,point.y),this.points[point.id]=point,this.checkRecognition()}},{model_:"Method",name:"onTouchMove",code:function(_,__,touch){this.recognized||this.checkRecognition()}},{model_:"Method",name:"onMouseMove",code:function(event){this.points.mouse&&(this.points.mouse.x=event.clientX,this.points.mouse.y=event.clientY,this.checkRecognition())}},{model_:"Method",name:"onTouchEnd",code:function(_,__,touch){this.recognized||this.checkRecognition(),delete this.points[touch.id],this.active={},this.recognized=void 0}},{model_:"Method",name:"onMouseUp",code:function(event){this.points.mouse&&(this.points.mouse.x=event.clientX,this.points.mouse.y=event.clientY,this.points.mouse.done=!0,this.recognized||this.checkRecognition(),delete this.points.mouse,this.active={},this.recognized=void 0)}},{model_:"Method",name:"onWheel",code:function(event){if(this.wheelTimer)this.points.wheel.x-=event.deltaX,this.points.wheel.y-=event.deltaY,this.X.window.clearTimeout(this.wheelTimer),this.wheelTimer=this.X.window.setTimeout(this.onWheelDone,this.scrollWheelTimeout);else{if(this.recognized||Object.keys(this.points).length>0)return;var wheel=this.InputPoint.create({id:"wheel",type:"wheel",x:event.clientX,y:event.clientY}),dir=Math.abs(event.deltaX)>Math.abs(event.deltaY)?"horizontal":"vertical",gestures=[dir+"Scroll",dir+"ScrollMomentum",dir+"ScrollNative"];this.activateContainingGestures(wheel.x,wheel.y,function(g){return gestures.indexOf(g.name)>=0}),wheel.x-=event.deltaX,wheel.y-=event.deltaY;for(var i=0;i<gestures.length;i++){var gesture=gestures[i];if(this.active[gesture]&&this.active[gesture].length){this.points.wheel||(this.points.wheel=wheel),this.gestures[gesture].attach(this.points,this.active[gesture].map(function(gt){return gt.handler})),this.recognized=this.gestures[gesture],this.wheelTimer=this.X.window.setTimeout(this.onWheelDone,this.scrollWheelTimeout);break}}}}},{model_:"Method",name:"onWheelDone",code:function(){this.wheelTimer=void 0,this.points.wheel.done=!0,delete this.points.wheel,this.recognized=void 0}},{model_:"Method",name:"onContextMenu",code:function(){this.resetState()}}]}),CLASS({model_:"Model","package":"foam.input.touch",name:"DragGesture",extendsModel:"foam.input.touch.Gesture",properties:[{model_:"Property",name:"name",defaultValue:"drag"}],methods:{recognize:function(map){var keys=Object.keys(map);if(keys.length>1)return this.NO;var point=map[keys[0]];if(point.done)return this.NO;var delta=Math.max(Math.abs(point.totalX),Math.abs(point.totalY)),r=delta>=20?this.YES:this.MAYBE;return r!=this.NO&&(point.shouldPreventDefault=!0),r},attach:function(map,handlers){var point=map[Object.keys(map)[0]];this.handlers=handlers||[],point.done$.addListener(this.onDone),this.pingHandlers("dragStart",point)},pingHandlers:function(method,point){for(var i=0;i<this.handlers.length;i++){var h=this.handlers[i];h&&h[method]&&h[method](point)}}},listeners:[{model_:"Method",name:"onDone",code:function(obj,prop,old,nu){obj.done$.removeListener(this.onDone),this.pingHandlers("dragEnd",obj)}}],help:"Gesture that understands a hold and drag with mouse or one touch point."}),CLASS({model_:"Model","package":"foam.input.touch",name:"Gesture",properties:[{model_:"Property",name:"name",required:!0}],constants:[{model_:"Constant",name:"YES",value:3},{model_:"Constant",name:"MAYBE",value:2},{model_:"Constant",name:"WAIT",value:1},{model_:"Constant",name:"NO",value:0}],methods:{recognize:function(map){return this.NO},attach:function(handlers){},newPoint:function(point){}},help:"Installed in the GestureManager to watch for a particular kind of gesture"}),CLASS({model_:"Model","package":"foam.input.touch",name:"PinchTwistGesture",extendsModel:"foam.input.touch.Gesture",properties:[{model_:"Property",name:"name",defaultValue:"pinchTwist"},{model_:"Property",name:"handlers"},{model_:"Property",name:"points"}],methods:{getPoints:function(map){var keys=Object.keys(map);return[map[keys[0]],map[keys[1]]]},recognize:function(map){if(2!==Object.keys(map).length)return this.NO;var points=this.getPoints(map);if(points[0].done||points[1].done)return this.NO;var moved=!(0===points[0].dx&&0===points[0].dy||0===points[1].dx&&0===points[1].dy);return moved?this.YES:this.MAYBE},attach:function(map,handlers){Object_forEach(map,function(p){p.shouldPreventDefault=!0}),this.points=this.getPoints(map),this.handlers=handlers||[],this.points.forEach(function(p){p.x$.addListener(this.onMove),p.y$.addListener(this.onMove),p.done$.addListener(this.onDone)}.bind(this)),this.pingHandlers("pinchStart"),this.onMove()},pingHandlers:function(method,scale,rotation){for(var i=0;i<this.handlers.length;i++){var h=this.handlers[i];h&&h[method]&&h[method](scale,rotation)}},distance:function(x1,y1,x2,y2){var dx=x2-x1,dy=y2-y1;return Math.sqrt(dx*dx+dy*dy)}},listeners:[{model_:"Method",name:"onMove",code:function(){for(var oldDist=this.distance(this.points[0].x0,this.points[0].y0,this.points[1].x0,this.points[1].y0),newDist=this.distance(this.points[0].x,this.points[0].y,this.points[1].x,this.points[1].y),scale=newDist/oldDist,oldAngle=Math.atan2(this.points[1].y0-this.points[0].y0,this.points[1].x0-this.points[0].x0),newAngle=Math.atan2(this.points[1].y-this.points[0].y,this.points[1].x-this.points[0].x),rotation=newAngle-oldAngle;rotation<-Math.PI;)rotation+=2*Math.PI;for(;rotation>Math.PI;)rotation-=2*Math.PI;rotation*=360,rotation/=2*Math.PI,this.pingHandlers("pinchMove",scale,rotation)}},{model_:"Method",name:"onDone",code:function(obj,prop,old,nu){this.points.forEach(function(p){p.x$.removeListener(this.onMove),p.y$.removeListener(this.onMove),p.done$.removeListener(this.onDone)}),this.pingHandlers("pinchEnd")}}],help:"Gesture that understands a two-finger pinch/stretch and rotation"}),CLASS({model_:"Model","package":"foam.input.touch",name:"ScrollGesture",extendsModel:"foam.input.touch.Gesture",properties:[{model_:"Property",name:"name",factory:function(){return this.direction+"Scroll"+(this.momentumEnabled?"Momentum":this.nativeScrolling?"Native":"")}},{model_:"Property",name:"direction",defaultValue:"vertical"},{model_:"Property",name:"isVertical",factory:function(){return"vertical"===this.direction}},{model_:"Property",name:"momentumEnabled",defaultValue:!1,help:'Set me to true (usually by attaching the "verticalScrollMomentum" gesture) to enable momentum'},{model_:"Property",name:"nativeScrolling",defaultValue:!1,help:'Set me to true (usually by attaching the "verticalScrollNative" gesture) to enable native browser scrolling'},{model_:"Property",name:"dragCoefficient",defaultValue:.94,help:"Each frame, the momentum will be multiplied by this coefficient. Higher means LESS drag."},{model_:"Property",name:"dragClamp",defaultValue:.05,help:"The speed threshold (pixels/millisecond) below which the momentum drops to 0."},{model_:"Property",name:"momentum",defaultValue:0,help:"The current speed, in pixels/millisecond, at which the scroller is sliding."},{model_:"Property",name:"lastTime",hidden:!0,defaultValue:0,help:"The performance.now() value for the last time we computed the momentum slide."},{model_:"Property",name:"tickRunning",hidden:!0,defaultValue:!1,help:"True when the physics tick should run."},{model_:"Property",name:"handlers"}],methods:{recognize:function(map){if(1!==Object.keys(map).length)return this.NO;
var point=map[Object.keys(map)[0]];if("mouse"===point.type||point.done)return this.NO;if(Math.abs(this.momentum)>0)return this.YES;var delta=Math.abs(this.isVertical?point.totalY:point.totalX);return delta>10?this.YES:this.MAYBE},attach:function(map,handlers){var point=map[Object.keys(map)[0]];this.handlers=handlers||[],this.nativeScrolling||(Object_forEach(map,function(p){p.shouldPreventDefault=!0}),(this.isVertical?point.y$:point.x$).addListener(this.onDelta),point.done$.addListener(this.onDone),0===this.momentum?this.pingHandlers(this.direction+"ScrollStart",0,0,this.isVertical?point.y0:point.x0):this.tickRunning=!1)},pingHandlers:function(method,d,t,c){for(var i=0;i<this.handlers.length;i++){var h=this.handlers[i];h&&h[method]&&h[method](d,t,c,this.stopMomentum)}},sendEndEvent:function(point){var delta=this.isVertical?point.dy:point.dx,total=this.isVertical?point.totalY:point.totalX,current=this.isVertical?point.y:point.x;this.pingHandlers(this.direction+"ScrollEnd",delta,total,current)},calculateInstantaneousVelocity:function(point){var now=this.X.performance.now(),lastTime=this.tickRunning?this.lastTime:point.lastTime,velocity=(this.isVertical?point.dy:point.dx)/(now-point.lastTime);return this.tickRunning&&(this.lastTime=now),velocity}},listeners:[{model_:"Method",name:"onDelta",code:function(obj,prop,old,nu){if(this.momentumEnabled){var velocity=this.calculateInstantaneousVelocity(obj),delta=velocity-this.momentum;this.momentum+=delta}var delta=this.isVertical?obj.dy:obj.dx,total=this.isVertical?obj.totalY:obj.totalX,current=this.isVertical?obj.y:obj.x;this.pingHandlers(this.direction+"ScrollMove",delta,total,current)}},{model_:"Method",name:"onDone",code:function(obj,prop,old,nu){(this.isVertical?obj.y$:obj.x$).removeListener(this.onDelta),obj.done$.removeListener(this.onDone),this.momentumEnabled?Math.abs(this.momentum)<this.dragClamp?(this.momentum=0,this.sendEndEvent(obj)):(this.tickRunning=!0,this.lastTime=this.X.performance.now(),this.tick(obj)):this.sendEndEvent(obj)}},{model_:"Method",name:"tick",code:function(touch){if(this.tickRunning){var xy=this.isVertical?"y":"x",now=this.X.performance.now(),elapsed=now-this.lastTime;this.lastTime=now;var distance=this.momentum*elapsed;touch[xy]+=distance;var delta,total,current;this.isVertical?(delta=touch.dy,total=touch.totalY,current=touch.y):(delta=touch.dx,total=touch.totalX,current=touch.x),0!=delta&&this.pingHandlers(this.direction+"ScrollMove",delta,total,current),this.momentum*=this.dragCoefficient,Math.abs(this.momentum)<this.dragClamp?(this.momentum=0,this.tickRunning=!1,this.sendEndEvent(touch)):this.tick(touch)}},isFramed:!0},{model_:"Method",name:"stopMomentum",code:function(){this.momentum=0}}],help:"Gesture that understands vertical or horizontal scrolling."}),CLASS({model_:"Model","package":"foam.input.touch",name:"TapGesture",extendsModel:"foam.input.touch.Gesture",properties:[{model_:"Property",name:"name",defaultValue:"tap"},{model_:"Property",name:"handlers"}],methods:{recognize:function(map){for(var response,doneCount=0,self=this,keys=Object.keys(map),i=0;i<keys.length;i++){var key=keys[i],p=map[key];if(Math.abs(p.totalX)>=10||Math.abs(p.totalY)>=10)return this.NO;p.done&&doneCount++}return response===this.NO?response:doneCount===keys.length?this.YES:this.WAIT},attach:function(map,handlers){if(handlers&&handlers.length){var points=0;Object_forEach(map,function(point){points++,point.shouldPreventDefault=!0}),handlers.forEach(function(h){h&&h.tapClick&&h.tapClick(map)})}}},help:"Gesture that understands a quick, possible multi-point tap. Calls into the handler: tapClick(numberOfPoints)."}),CLASS({model_:"Model","package":"foam.input.touch",name:"InputPoint",properties:[{model_:"Property",name:"id"},{model_:"Property",name:"type"},{model_:"BooleanProperty",name:"done"},{model_:"Property",name:"x",postSet:function(old,nu){this.lastX=old}},{model_:"Property",name:"y",postSet:function(old,nu){this.lastY=old}},{model_:"Property",name:"x0",factory:function(){return this.x}},{model_:"Property",name:"y0",factory:function(){return this.y}},{model_:"Property",name:"lastX",factory:function(){return this.x}},{model_:"Property",name:"lastY",factory:function(){return this.y}},{model_:"Property",name:"dx",getter:function(){return this.x-this.lastX}},{model_:"Property",name:"dy",getter:function(){return this.y-this.lastY}},{model_:"Property",name:"totalX",getter:function(){return this.x-this.x0}},{model_:"Property",name:"totalY",getter:function(){return this.y-this.y0}},{model_:"Property",name:"lastTime"},{model_:"Property",name:"shouldPreventDefault",defaultValue:!1}]}),CLASS({model_:"Model","package":"foam.oauth2",name:"OAuth2Redirect",extendsModel:"foam.oauth2.OAuth2",imports:["window","location","setTimeout"],properties:[{model_:"Property",name:"redirects","transient":!0,defaultValue:0}],methods:{init:function(args){this.loadState_();var self=this;this.setTimeout(function(){self.redirects=0},this.REDIRECTS_TIMEOUT),this.loadToken_(),this.SUPER(args)},loadState_:function(){var state=this.location.hash.match(/state=([^&]*)/);return state=state&&state[1],state&&(this.redirects=parseInt(state)),state},loadToken_:function(){var token=this.location.hash.match(/token=([^&]*)/);return token=token&&token[1],token&&(this.accessToken=token),token},refreshNow_:function(ret){if(this.redirects<2){this.redirects+=1;var redirect=this.location.protocol+"//"+this.location.host+this.location.pathname+this.location.search,params=["response_type=token","client_id="+encodeURIComponent(this.clientId),"redirect_uri="+encodeURIComponent(redirect),"scope="+encodeURIComponent(this.scopes.join(" ")),"state="+this.redirects];return void(this.window.location=this.endpoint+"auth?"+params.join("&"))}console.error("Failed to authenticated after ",this.redirects,"attempts.")},setJsonpFuture:function(X,future){var agent=this;future.set(function(url,params){var tries=0;return params=params.clone(),params.push("access_token="+encodeURIComponent(agent.accessToken)),function(ret){function callback(data){null===data?(tries++,3==tries?ret(null):agent.refresh(function(token){params[params.length-1]="access_token="+encodeURIComponent(token),ajsonp(url,params)(callback)})):ret(data)}ajsonp(url,params)(callback)}})}},help:"OAuth2 strategy that uses the redirect."}),CLASS({model_:"Model","package":"foam.oauth2",name:"OAuth2",label:"OAuth 2.0",requires:["XHR"],properties:[{model_:"Property",name:"accessToken",help:"Token used to authenticate requests."},{model_:"Property",name:"clientId",required:!0,"transient":!0},{model_:"Property",name:"clientSecret",required:!0,"transient":!0},{model_:"StringArrayProperty",name:"scopes",required:!0,"transient":!0},{model_:"StringProperty",name:"endpoint",defaultValue:"https://accounts.google.com/o/oauth2/"}],methods:{init:function(){this.SUPER(),this.refresh_=amerged(this.refreshNow_.bind(this))},refreshNow_:function(){},refresh:function(ret,opt_forceInteractive){return this.refresh_(ret,opt_forceInteractive)},setJsonpFuture:function(X,future){var agent=this;future.set(function(){var factory=agent.XHR.xbind({authAgent:agent,responseType:"json",retries:3});return function(url,params,opt_method,opt_payload){return function(ret){var xhr=factory.create();xhr.asend(function(data,xhr){ret(data,xhr.status)},url+(params?"?"+params.join("&"):""),opt_payload,opt_method?opt_method:"GET")}}}())}}}),CLASS({model_:"Model","package":"foam.input.touch",name:"TouchManager",requires:["foam.input.touch.InputPoint"],properties:[{model_:"Property",name:"touches",factory:function(){return{}}}],constants:[{model_:"Constant",name:"TOUCH_START",value:["touch-start"]},{model_:"Constant",name:"TOUCH_END",value:["touch-end"]},{model_:"Constant",name:"TOUCH_MOVE",value:["touch-move"]}],methods:{init:function(){this.SUPER(),this.X.document&&this.install(this.X.document)},install:function(d){d.addEventListener("touchstart",this.onTouchStart)},attach:function(e){e.addEventListener("touchmove",this.onTouchMove),e.addEventListener("touchend",this.onTouchEnd),e.addEventListener("touchcancel",this.onTouchCancel),e.addEventListener("touchleave",this.onTouchEnd)},detach:function(e){e.removeEventListener("touchmove",this.onTouchMove),e.removeEventListener("touchend",this.onTouchEnd),e.removeEventListener("touchcancel",this.onTouchCancel),e.removeEventListener("touchleave",this.onTouchEnd)},touchStart:function(i,t,e){this.touches[i]=this.InputPoint.create({id:i,type:"touch",x:t.pageX,y:t.pageY}),this.publish(this.TOUCH_START,this.touches[i])},touchMove:function(i,t,e){var touch=this.touches[i];touch.x=t.pageX,touch.y=t.pageY,touch.lastTime=this.X.performance.now(),touch.shouldPreventDefault&&e.preventDefault(),this.publish(this.TOUCH_MOVE,this.touch)},touchEnd:function(i,t,e){var touch=this.touches[i];touch.x=t.pageX,touch.y=t.pageY,touch.done=!0,this.publish(this.TOUCH_END,touch),touch.shouldPreventDefault&&e.cancelable&&e.preventDefault(),delete this.touches[i]},touchCancel:function(i,t,e){this.touches[i].done=!0,this.publish(this.TOUCH_END,this.touches[i])},touchLeave:function(i,t,e){this.touches[i].done=!0,this.publish(this.TOUCH_END,this.touches[i])}},listeners:[{model_:"Method",name:"onTouchStart",code:function(e){this.attach(e.target);for(var i=0;i<e.changedTouches.length;i++){var t=e.changedTouches[i];this.touchStart(t.identifier,t,e)}}},{model_:"Method",name:"onTouchMove",code:function(e){for(var i=0;i<e.changedTouches.length;i++){var t=e.changedTouches[i],id=t.identifier;this.touches[id]?this.touchMove(id,t,e):console.warn("Touch move for unknown touch.")}}},{model_:"Method",name:"onTouchEnd",code:function(e){this.detach(e.target);for(var i=0;i<e.changedTouches.length;i++){var t=e.changedTouches[i],id=t.identifier;this.touches[id]?this.touchEnd(id,t,e):console.warn("Touch end for unknown touch "+id,Object.keys(this.touches))}}},{model_:"Method",name:"onTouchCancel",code:function(e){this.detach(e.target);for(var i=0;i<e.changedTouches.length;i++){var t=e.changedTouches[i],id=t.identifier;this.touches[id]?this.touchCancel(id,t,e):console.warn("Touch cancel for unknown touch.")}}},{model_:"Method",name:"onTouchLeave",code:function(e){this.detach(e.target);for(var i=0;i<e.changedTouches.length;i++){var t=e.changedTouches[i],id=t.identifier;this.touches[id]?this.touchLeave(id,t,e):console.warn("Touch cancel for unknown touch.")}}}]}),CLASS({model_:"Model","package":"foam.ui.layout",name:"CSSStackView",extendsModel:"foam.ui.View",requires:["foam.ui.layout.CSSOverlaySlider as OverlaySlider","foam.ui.layout.FloatingView"],imports:["dynamic"],traits:["foam.ui.layout.PositionedDOMViewTrait"],properties:[{model_:"Property",name:"stack",factory:function(){return[]}},{model_:"IntProperty",name:"currentView",preSet:function(_,v){return Math.min(Math.max(v,0),this.stack.length-1)},defaultValue:0},{model_:"Property",name:"animating",defaultValue:!1},{model_:"IntProperty",name:"direction",defaultValue:-1},{model_:"Property",name:"overlaySlider",factory:function(){return this.OverlaySlider.create()},postSet:function(old,v){old&&old.unsubscribe(["click"],this.overlayBack),v.subscribe(["click"],this.overlayBack)}},{model_:"BooleanProperty",name:"sliderOpen",defaultValue:!1},{model_:"foam.core.types.DOMElementProperty",name:"innerContainer"},{model_:"foam.core.types.DOMElementProperty",name:"containerViewport"}],actions:[{model_:"Action",name:"back",action:function(){this.sliderOpen?(this.overlaySlider.close(),this.sliderOpen=!1):(this.animating=!0,this.currentView=this.currentView-1)}}],methods:{init:function(){this.SUPER();var self=this;this.dynamic(function(){self.width,self.height,self.sliderOpen},this.layout),this.dynamic(function(){self.currentView,self.width},this.transform),this.dynamic(function(){self.width,self.height},this.resizeContainer)},setTopView:function(view){view.model_.Z||(view=this.FloatingView.create({view:view})),this.stack=[view],this.currentView=0,this.layout(),this.resizeContainer(),this.innerContainer.innerHTML=view.toHTML(),view.initHTML()},setPreview:function(){},slideView:function(view,opt_label,opt_side,opt_delay){view.model_.Z||(view=this.FloatingView.create({view:view})),this.sliderOpen&&(this.overlaySlider.close(!0),this.sliderOpen=!1),this.sliderOpen=!0,this.overlaySlider.open(view)},pushView:function(view,opt_label,opt_back,opt_transition){view.model_.Z||(view=this.FloatingView.create({view:view}));var nextView=this.currentView+1;this.stack[nextView]&&(this.stack[nextView].$.remove(),this.stack[nextView].destroy()),this.stack[nextView]=view,this.propertyChange("stack",this.stack,this.stack),this.layout(),this.resizeContainer(),this.innerContainer.insertAdjacentHTML("beforeend",view.toHTML()),view.initHTML(),this.currentView=nextView,this.animating="none"==opt_transition?!1:!0}},listeners:[{model_:"Method",name:"overlayBack",code:function(){this.sliderOpen&&this.back()}},{model_:"Method",name:"resizeContainer",code:function(){this.innerContainer&&(this.innerContainer.style.width=this.stack.length*this.width+"px",this.innerContainer.style.height=this.height+"px",this.containerViewport.style.width=this.styleWidth(),this.containerViewport.style.height=this.styleHeight())},isFramed:!0},{model_:"Method",name:"updateContents",code:function(){},isFramed:!0},{model_:"Method",name:"fixLayout",code:function(){this.containerViewport&&(this.containerViewport.scrollLeft=0)},isMerged:100},{model_:"Method",name:"layout",code:function(){this.fixLayout(),this.overlaySlider.x=0,this.overlaySlider.y=0,this.overlaySlider.z=this.sliderOpen?1:0,this.overlaySlider.width=this.width,this.overlaySlider.height=this.height;for(var i=0;i<this.stack.length;i++)this.stack[i].x=i*this.width,this.stack[i].y=0,this.stack[i].z=0,this.stack[i].width=this.width,this.stack[i].height=this.height}},{model_:"Method",name:"transform",code:function(){this.innerContainer&&(this.innerContainer.style.webkitTransform="translate3d("+-1*this.currentView*this.width+"px, 0px, 0px)")},isFramed:!0}],templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n.cssslider-animate {\n  -webkit-transition: -webkit-transform 300ms ease-in;\n}\n"),out.toString()}},{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out("",this.overlaySlider,'<div id="',this.containerViewport=this.nextID(),'" style="overflow:hidden;position:absolute"><div id="',this.innerContainer=this.setClass("cssslider-animate",function(){self.animating}),'"></div></div>'),out.toString()}}]}),CLASS({model_:"Model","package":"foam.ui.layout",name:"CSSOverlaySlider",extendsModel:"foam.ui.View",requires:["foam.ui.layout.FloatingView"],traits:["foam.ui.layout.PositionedDOMViewTrait"],properties:[{model_:"Property",name:"view"},{model_:"BooleanProperty",name:"isOpen",defaultValue:!1},{model_:"BooleanProperty",name:"animating",defaultValue:!1},{model_:"foam.core.types.DOMElementProperty",name:"overlaySlider"},{model_:"foam.core.types.DOMElementProperty",name:"viewContainer"}],methods:{init:function(args){this.SUPER(args);var self=this;this.X.dynamic(function(){self.width,self.height},this.layout)},open:function(view){view.model_.Z||(view=this.FloatingView.create({view:view})),this.view&&this.view.$&&(this.view.$.remove(),this.view.destroy()),this.view=view,this.isOpen=!1,this.animating=!1,this.layout(),this.viewContainer.innerHTML=view.toHTML(),view.initHTML(),this.animating=!0,this.isOpen=!0,this.layout()},close:function(rightNow){this.isOpen=!1,this.animating=!rightNow,this.layout()}},listeners:[{model_:"Method",name:"onClick",code:function(){this.publish(["click"])}},{model_:"Method",name:"layout",code:function(){var width=Math.min(this.view.preferredWidth,this.width);if(this.view&&(this.view.width=width,this.view.height=this.height,this.view.x=0,this.view.y=0,this.view.z=1),this.$){var overlay=this.overlaySlider;overlay.style.webkitTransition=this.animating?"opacity 300ms "+(this.isOpen?"ease-out":"ease-in"):"",overlay.style.webkitTransform="translate3d(0px,0px,0px)",overlay.style.width=this.width+"px",overlay.style.height=this.height+"px",overlay.style.opacity=this.isOpen?.4:0;var container=this.viewContainer;container.style.webkitTransition=this.animating?"-webkit-transform 300ms "+(this.isOpen?"ease-out":"ease-in"):"",container.style.webkitTransform="translate3d("+(this.isOpen?0:-width)+"px,0px,0px)",container.style.width=width+"px",container.style.height=this.styleHeight()}}}],templates:[{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('<div id="',this.overlaySlider=this.on("click",this.onClick),'" class="overlay-slider"></div>\n<div id="',this.viewContainer=this.nextID(),'" class="overlay-container"></div>\n  '),out.toString()}},{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n.overlay-slider {\n  position: absolute;\n  background: black;\n}\n\n.overlay-conatiner {\n  position: absolute;\n}\n\n* {\n  transform-style: preserve-3d;\n  -webkit-transform-style: preserve-3d;\n}\n"),out.toString()}}]}),CLASS({model_:"Model","package":"foam.core.types",name:"DOMElementProperty",extendsModel:"StringProperty",properties:[{model_:"Property",name:"getter",defaultValue:function(name){return this.X.document.getElementById(this.instance_[name])}}]}),CLASS({model_:"Model","package":"com.google.mail",name:"ComposeView",extendsModel:"foam.ui.DetailView",requires:["foam.ui.md.ToolbarRichTextView","foam.ui.md.TextFieldView","Property"],imports:["data"],exports:["propertyViewProperty"],properties:[{model_:"Property",name:"parent",type:"foam.patterns.ChildTreeTrait",hidden:!0},{model_:"Property",name:"children",type:"Array[foam.patterns.ChildTreeTrait]",factory:function(){return[]}},{model_:"Property",name:"id",label:"Element ID",type:"String",factory:function(){return this.instance_.id||this.nextID()}},{model_:"Property",name:"shortcuts",type:"Array[Shortcut]",factory:function(){return[]}},{model_:"Property",name:"$",mode:"read-only",hidden:!0,getter:function(){return this.X.document.getElementById(this.id)},help:"DOM Element."},{model_:"Property",name:"tagName",defaultValue:"span"},{model_:"Property",name:"tooltip"},{model_:"Property",name:"tabIndex"},{model_:"Property",name:"extraClassName",defaultValue:""},{model_:"BooleanProperty",name:"showActions",postSet:function(oldValue,showActions){!oldValue&&showActions&&this.addDecorator(this.X.ActionBorder.create(null,this.Y))},defaultValue:!1},{model_:"Property",name:"initializers_",factory:function(){return[]}},{model_:"Property",name:"destructors_",factory:function(){return[]}},{model_:"Property",name:"className",defaultValue:"detailView",help:"CSS class name(s), space separated."},{model_:"Property",name:"model",type:"Model",postSet:function(_,m){this.$&&(this.children=[],this.$.outerHTML=this.toHTML(),this.initHTML())}},{model_:"Property",name:"title",defaultValueFn:function(){return"Edit "+this.model.label}},{model_:"StringProperty",name:"mode",defaultValue:"read-write"},{model_:"BooleanProperty",name:"showRelationships",defaultValue:!1},{model_:"Property",name:"propertyViewProperty",type:"Property",defaultValueFn:function(){return this.Property.DETAIL_VIEW}},{model_:"Property",name:"data",hidden:!0,"transient":!0,postSet:function(_,data){data&&data.model_&&this.model!==data.model_&&(this.model=data.model_)}}],actions:[{model_:"Action",name:"back",label:"",isEnabled:function(){return!0},iconUrl:"images/ic_arrow_back_24dp.png",action:function(){this.X.stack.back()}}],templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .email-compose-view {\n        display: flex;\n        flex-direction: column;\n        height: 100%;\n      }\n\n      .content {\n        margin-left: 16px;\n        margin-top: 44px;\n        display: flex;\n        flex-direction: column;\n        flex-grow: 1;\n        position: relative;\n       }\n\n      .richText {\n        flex-grow: 1;\n        margin-top: 30px;\n        margin-left: -2px;\n      }\n\n      .richText .placeholder { font-size: 14px; font-family: Roboto; }\n\n      iframe {\n        border: none;\n      }\n\n      .actionButtonCView-send {\n        position: absolute;\n        bottom: 10px;\n        right: 24px;\n        box-shadow: 3px 3px 3px #aaa;\n        border-radius: 30px;\n      }\n\n      .md-text-field-container {\n        height: 68p x;\n        margin-left: -12px;\n        margin-top: -18px;\n        margin-bottom: -8px;\n      }\n    "),out.toString()}},{model_:"Template",name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('\n      <div id="',this.id,'" class="email-compose-view">\n        <div class="header">\n          ',self.createTemplateView("back",{className:"backButton"}),"\n          ",self.createTemplateView("subject",{mode:"read-only",className:"subject"}),'\n        </div>\n        <div class="content">\n        ',self.createTemplateView("to",{placeholder:"To",model_:"foam.ui.md.TextFieldView"})," <br>\n        ",self.createTemplateView("cc",{placeholder:"Cc",model_:"foam.ui.md.TextFieldView"})," <br>\n        ",self.createTemplateView("bcc",{placeholder:"Bcc",model_:"foam.ui.md.TextFieldView"})," <br>\n        ",self.createTemplateView("subject",{placeholder:"Subject",onKeyMode:!0,model_:"foam.ui.md.TextFieldView"}),"\n        ",self.createTemplateView("body",{model_:"foam.ui.md.ToolbarRichTextView",height:300,placeholder:"Message"}),"\n        </div>\n        ",self.createTemplateView("send",{background:"#259b24",radius:24,iconUrl:"images/send.png"}),"\n      </div>\n    "),out.toString()}}]}),CLASS({model_:"Model","package":"foam.ui.md",name:"ToolbarRichTextView",extendsModel:"foam.ui.RichTextView",actions:[{model_:"Action",name:"bold",label:"",iconUrl:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhLS0gR2VuZXJhdG9yOiBBZG9iZSBJbGx1c3RyYXRvciAxNS4wLjAsIFNWRyBFeHBvcnQgUGx1Zy1JbiAgLS0+DQo8IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiIFsNCgk8IUVOVElUWSBuc19mbG93cyAiaHR0cDovL25zLmFkb2JlLmNvbS9GbG93cy8xLjAvIj4NCl0+DQo8c3ZnIHZlcnNpb249IjEuMSINCgkgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeG1sbnM6YT0iaHR0cDovL25zLmFkb2JlLmNvbS9BZG9iZVNWR1ZpZXdlckV4dGVuc2lvbnMvMy4wLyINCgkgeD0iMHB4IiB5PSIwcHgiIHdpZHRoPSIyMXB4IiBoZWlnaHQ9IjIxcHgiIHZpZXdCb3g9IjAgMCAyMSAyMSIgb3ZlcmZsb3c9InZpc2libGUiIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDIxIDIxIg0KCSB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxkZWZzPg0KPC9kZWZzPg0KPHBhdGggZmlsbD0iIzg4OCIgZD0iTTEyLjE5OSwxMC41YzAsMCwxLjgwMS0wLjUsMS44MDEtMlMxMyw2LDExLjUsNkg2djloNS41YzEuNSwwLDIuNS0xLDIuNS0yLjVTMTIuMTk5LDEwLjUsMTIuMTk5LDEwLjV6IE0xMC41LDE0SDl2LTNoMS41DQoJYzAuNTUzLDAsMC44NSwwLjY3MiwwLjg1LDEuNVMxMS4wNTMsMTQsMTAuNSwxNHogTTEwLjUsMTBIOVY3aDEuNWMwLjU1MywwLDAuODUsMC42NzIsMC44NSwxLjVTMTEuMDUzLDEwLDEwLjUsMTB6Ii8+DQo8cmVjdCBvcGFjaXR5PSIwIiBmaWxsPSIjNDM4N0ZEIiB3aWR0aD0iMjEiIGhlaWdodD0iMjEiLz4NCjwvc3ZnPg0K"},{model_:"Action",name:"italic",label:"",iconUrl:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhLS0gR2VuZXJhdG9yOiBBZG9iZSBJbGx1c3RyYXRvciAxNS4wLjAsIFNWRyBFeHBvcnQgUGx1Zy1JbiAgLS0+DQo8IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiIFsNCgk8IUVOVElUWSBuc19mbG93cyAiaHR0cDovL25zLmFkb2JlLmNvbS9GbG93cy8xLjAvIj4NCl0+DQo8c3ZnIHZlcnNpb249IjEuMSINCgkgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeG1sbnM6YT0iaHR0cDovL25zLmFkb2JlLmNvbS9BZG9iZVNWR1ZpZXdlckV4dGVuc2lvbnMvMy4wLyINCgkgeD0iMHB4IiB5PSIwcHgiIHdpZHRoPSIyMXB4IiBoZWlnaHQ9IjIxcHgiIHZpZXdCb3g9IjAgMCAyMSAyMSIgb3ZlcmZsb3c9InZpc2libGUiIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDIxIDIxIg0KCSB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxkZWZzPg0KPC9kZWZzPg0KPHBvbHlnb24gZmlsbD0iIzg4OCIgcG9pbnRzPSI5LDYgOSw3IDEwLjksNyA2LjksMTQgNSwxNCA1LDE1IDExLjI1LDE1IDExLjI1LDE0IDkuMSwxNCAxMy4xLDcgMTUsNyAxNSw2ICIvPg0KPHJlY3Qgb3BhY2l0eT0iMCIgZmlsbD0iIzQzODdGRCIgd2lkdGg9IjIxIiBoZWlnaHQ9IjIxIi8+DQo8L3N2Zz4NCg=="},{model_:"Action",name:"underline",label:"",iconUrl:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhLS0gR2VuZXJhdG9yOiBBZG9iZSBJbGx1c3RyYXRvciAxNS4wLjAsIFNWRyBFeHBvcnQgUGx1Zy1JbiAgLS0+DQo8IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiIFsNCgk8IUVOVElUWSBuc19mbG93cyAiaHR0cDovL25zLmFkb2JlLmNvbS9GbG93cy8xLjAvIj4NCl0+DQo8c3ZnIHZlcnNpb249IjEuMSINCgkgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeG1sbnM6YT0iaHR0cDovL25zLmFkb2JlLmNvbS9BZG9iZVNWR1ZpZXdlckV4dGVuc2lvbnMvMy4wLyINCgkgeD0iMHB4IiB5PSIwcHgiIHdpZHRoPSIyMXB4IiBoZWlnaHQ9IjIxcHgiIHZpZXdCb3g9IjAgMCAyMSAyMSIgb3ZlcmZsb3c9InZpc2libGUiIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDIxIDIxIg0KCSB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxkZWZzPg0KPC9kZWZzPg0KPHBhdGggZmlsbD0iIzg4OCIgZD0iTTEwLDE0YzIsMCw0LTEuNSw0LTRWNWgtMS44MDF2NWMwLDEuNS0wLjY5OSwyLjI1LTIuMTk5LDIuMjVTNy44LDExLjUsNy44LDEwVjVINnY1QzYsMTIuNSw4LDE0LDEwLDE0eiBNNSwxNXYxaDEwdi0xSDV6Ig0KCS8+DQo8cmVjdCBvcGFjaXR5PSIwIiBmaWxsPSIjNDM4N0ZEIiB3aWR0aD0iMjEiIGhlaWdodD0iMjEiLz4NCjwvc3ZnPg0K"},{model_:"Action",name:"link",label:"",iconUrl:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhLS0gR2VuZXJhdG9yOiBBZG9iZSBJbGx1c3RyYXRvciAxNS4wLjAsIFNWRyBFeHBvcnQgUGx1Zy1JbiAgLS0+DQo8IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiIFsNCgk8IUVOVElUWSBuc19mbG93cyAiaHR0cDovL25zLmFkb2JlLmNvbS9GbG93cy8xLjAvIj4NCl0+DQo8c3ZnIHZlcnNpb249IjEuMSINCgkgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeG1sbnM6YT0iaHR0cDovL25zLmFkb2JlLmNvbS9BZG9iZVNWR1ZpZXdlckV4dGVuc2lvbnMvMy4wLyINCgkgeD0iMHB4IiB5PSIwcHgiIHdpZHRoPSIyMXB4IiBoZWlnaHQ9IjIxcHgiIHZpZXdCb3g9IjAgMCAyMSAyMSIgb3ZlcmZsb3c9InZpc2libGUiIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDIxIDIxIg0KCSB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxkZWZzPg0KPC9kZWZzPg0KPHBhdGggZmlsbD0iIzg4OCIgZD0iTTIuNzY4LDExLjAwOFY5Ljk5MkMyLjc2OCw5LjMxMSwzLjMxOCw4Ljc2LDQsOC43Nmg1QzguNTksNy43NjgsNy41MjUsNyw2LjUsN2gtMkMyLjU2Niw3LDEsOC41NjcsMSwxMC41UzIuNTY2LDE0LDQuNSwxNA0KCWgyYzEuMDI1LDAsMi4wOS0wLjc2OCwyLjUtMS43Nkg0QzMuMzE4LDEyLjI0LDIuNzY4LDExLjY4OSwyLjc2OCwxMS4wMDh6IE0xNS41LDdoLTJjLTEuMDI1LDAtMi4wOSwwLjc2OC0yLjUsMS43Nmg1DQoJYzAuNjgyLDAsMS4yMzIsMC41NTEsMS4yMzIsMS4yMzJ2MS4wMTZjMCwwLjY4Mi0wLjU1MSwxLjIzMi0xLjIzMiwxLjIzMmgtNWMwLjQxLDAuOTkyLDEuNDc1LDEuNzYsMi41LDEuNzZoMg0KCWMxLjkzNCwwLDMuNS0xLjU2NywzLjUtMy41UzE3LjQzNCw3LDE1LjUsN3ogTTYsMTAuNDk5YzAsMC40MTQsMC4zMzYsMC43NTEsMC43NSwwLjc1MWg2LjVjMC40MTQsMCwwLjc1LTAuMzM3LDAuNzUtMC43NTENCgljMC0wLjQxNS0wLjMzNi0wLjc0OS0wLjc1LTAuNzQ5aC02LjVDNi4zMzYsOS43NSw2LDEwLjA4NCw2LDEwLjQ5OXoiLz4NCjxyZWN0IG9wYWNpdHk9IjAiIGZpbGw9IiM0Mzg3RkQiIHdpZHRoPSIyMSIgaGVpZ2h0PSIyMSIvPg0KPC9zdmc+DQo="},{model_:"Action",name:"leftJustify",label:"",iconUrl:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhLS0gR2VuZXJhdG9yOiBBZG9iZSBJbGx1c3RyYXRvciAxNS4wLjAsIFNWRyBFeHBvcnQgUGx1Zy1JbiAgLS0+DQo8IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiIFsNCgk8IUVOVElUWSBuc19mbG93cyAiaHR0cDovL25zLmFkb2JlLmNvbS9GbG93cy8xLjAvIj4NCl0+DQo8c3ZnIHZlcnNpb249IjEuMSINCgkgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeG1sbnM6YT0iaHR0cDovL25zLmFkb2JlLmNvbS9BZG9iZVNWR1ZpZXdlckV4dGVuc2lvbnMvMy4wLyINCgkgeD0iMHB4IiB5PSIwcHgiIHdpZHRoPSIyMXB4IiBoZWlnaHQ9IjIxcHgiIHZpZXdCb3g9IjAgMCAyMSAyMSIgb3ZlcmZsb3c9InZpc2libGUiIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDIxIDIxIg0KCSB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxkZWZzPg0KPC9kZWZzPg0KPHBhdGggZmlsbD0iIzg4OCIgZD0iTTMsMTZoMTB2LTFIM1YxNnogTTEzLDExSDN2MWgxMFYxMXogTTEzLDdIM3YxaDEwVjd6IE0zLDE0aDE0di0xSDNWMTR6IE0zLDEwaDE0VjlIM1YxMHogTTMsNXYxaDE0VjVIM3oiLz4NCjxyZWN0IG9wYWNpdHk9IjAiIGZpbGw9IiM0Mzg3RkQiIHdpZHRoPSIyMSIgaGVpZ2h0PSIyMSIvPg0KPC9zdmc+DQo="},{model_:"Action",name:"centerJustify",label:"",iconUrl:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhLS0gR2VuZXJhdG9yOiBBZG9iZSBJbGx1c3RyYXRvciAxNS4wLjAsIFNWRyBFeHBvcnQgUGx1Zy1JbiAgLS0+DQo8IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiIFsNCgk8IUVOVElUWSBuc19mbG93cyAiaHR0cDovL25zLmFkb2JlLmNvbS9GbG93cy8xLjAvIj4NCl0+DQo8c3ZnIHZlcnNpb249IjEuMSINCgkgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeG1sbnM6YT0iaHR0cDovL25zLmFkb2JlLmNvbS9BZG9iZVNWR1ZpZXdlckV4dGVuc2lvbnMvMy4wLyINCgkgeD0iMHB4IiB5PSIwcHgiIHdpZHRoPSIyMXB4IiBoZWlnaHQ9IjIxcHgiIHZpZXdCb3g9IjAgMCAyMSAyMSIgb3ZlcmZsb3c9InZpc2libGUiIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDIxIDIxIg0KCSB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxkZWZzPg0KPC9kZWZzPg0KPHBhdGggZmlsbD0iIzg4OCIgZD0iTTUsMTF2MWgxMHYtMUg1eiBNMywxNGgxNHYtMUgzVjE0eiBNNSwxNmgxMHYtMUg1VjE2eiBNMywxMGgxNFY5SDNWMTB6IE01LDd2MWgxMFY3SDV6IE0zLDV2MWgxNFY1SDN6Ii8+DQo8cmVjdCBvcGFjaXR5PSIwIiBmaWxsPSIjNDM4N0ZEIiB3aWR0aD0iMjEiIGhlaWdodD0iMjEiLz4NCjwvc3ZnPg0K"},{model_:"Action",name:"rightJustify",label:"",iconUrl:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhLS0gR2VuZXJhdG9yOiBBZG9iZSBJbGx1c3RyYXRvciAxNS4wLjAsIFNWRyBFeHBvcnQgUGx1Zy1JbiAgLS0+DQo8IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiIFsNCgk8IUVOVElUWSBuc19mbG93cyAiaHR0cDovL25zLmFkb2JlLmNvbS9GbG93cy8xLjAvIj4NCl0+DQo8c3ZnIHZlcnNpb249IjEuMSINCgkgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeG1sbnM6YT0iaHR0cDovL25zLmFkb2JlLmNvbS9BZG9iZVNWR1ZpZXdlckV4dGVuc2lvbnMvMy4wLyINCgkgeD0iMHB4IiB5PSIwcHgiIHdpZHRoPSIyMXB4IiBoZWlnaHQ9IjIxcHgiIHZpZXdCb3g9IjAgMCAyMSAyMSIgb3ZlcmZsb3c9InZpc2libGUiIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDIxIDIxIg0KCSB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxkZWZzPg0KPC9kZWZzPg0KPHBhdGggZmlsbD0iIzg4OCIgZD0iTTUsMTF2MWgxMHYtMUg1eiBNMywxNGgxNHYtMUgzVjE0eiBNNSwxNmgxMHYtMUg1VjE2eiBNMywxMGgxNFY5SDNWMTB6IE01LDd2MWgxMFY3SDV6IE0zLDV2MWgxNFY1SDN6Ii8+DQo8cmVjdCBvcGFjaXR5PSIwIiBmaWxsPSIjNDM4N0ZEIiB3aWR0aD0iMjEiIGhlaWdodD0iMjEiLz4NCjwvc3ZnPg0K"},{model_:"Action",name:"numberedList",label:"",iconUrl:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhLS0gR2VuZXJhdG9yOiBBZG9iZSBJbGx1c3RyYXRvciAxNS4wLjAsIFNWRyBFeHBvcnQgUGx1Zy1JbiAgLS0+DQo8IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiIFsNCgk8IUVOVElUWSBuc19mbG93cyAiaHR0cDovL25zLmFkb2JlLmNvbS9GbG93cy8xLjAvIj4NCl0+DQo8c3ZnIHZlcnNpb249IjEuMSINCgkgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeG1sbnM6YT0iaHR0cDovL25zLmFkb2JlLmNvbS9BZG9iZVNWR1ZpZXdlckV4dGVuc2lvbnMvMy4wLyINCgkgeD0iMHB4IiB5PSIwcHgiIHdpZHRoPSIyMXB4IiBoZWlnaHQ9IjIxcHgiIHZpZXdCb3g9IjAgMCAyMSAyMSIgb3ZlcmZsb3c9InZpc2libGUiIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDIxIDIxIg0KCSB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxkZWZzPg0KPC9kZWZzPg0KPHBhdGggZmlsbD0iIzg4OCIgZD0iTTYsMTVjMC0wLjU1My0wLjQ0Ny0xLTEtMUgzdjFoMi4yNWwtMSwxbDEsMUgzdjFoMmMwLjU1MywwLDEtMC40NDcsMS0xYzAtMC4yNzYtMC4xMTEtMC41MjYtMC4yOTMtMC43MDdMNS40MTQsMTYNCglsMC4yOTMtMC4yOTNDNS44ODksMTUuNTI2LDYsMTUuMjc2LDYsMTV6IE01LjcwNywxMC43MDdDNS44ODksMTAuNTI2LDYsMTAuMjc2LDYsMTBjMC0wLjU1My0wLjQ0Ny0xLTEtMUgzdjFoMi4yNUwzLDEyLjI1VjEzaDN2LTENCglINC40MTRDNC40MTQsMTIsNS41MjUsMTAuODg5LDUuNzA3LDEwLjcwN3ogTTgsNXYxaDlWNUg4eiBNNCw4aDFWNEgzdjFoMVY4eiBNOCwxMWg5di0xSDhWMTF6IE04LDE2aDl2LTFIOFYxNnoiLz4NCjxyZWN0IG9wYWNpdHk9IjAiIGZpbGw9IiM0Mzg3RkQiIHdpZHRoPSIyMSIgaGVpZ2h0PSIyMSIvPg0KPC9zdmc+DQo="},{model_:"Action",name:"bulletList",label:"",iconUrl:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhLS0gR2VuZXJhdG9yOiBBZG9iZSBJbGx1c3RyYXRvciAxNS4wLjAsIFNWRyBFeHBvcnQgUGx1Zy1JbiAgLS0+DQo8IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiIFsNCgk8IUVOVElUWSBuc19mbG93cyAiaHR0cDovL25zLmFkb2JlLmNvbS9GbG93cy8xLjAvIj4NCl0+DQo8c3ZnIHZlcnNpb249IjEuMSINCgkgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeG1sbnM6YT0iaHR0cDovL25zLmFkb2JlLmNvbS9BZG9iZVNWR1ZpZXdlckV4dGVuc2lvbnMvMy4wLyINCgkgeD0iMHB4IiB5PSIwcHgiIHdpZHRoPSIyMXB4IiBoZWlnaHQ9IjIxcHgiIHZpZXdCb3g9IjAgMCAyMSAyMSIgb3ZlcmZsb3c9InZpc2libGUiIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDIxIDIxIg0KCSB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxkZWZzPg0KPC9kZWZzPg0KPHBhdGggZmlsbD0iIzg4OCIgZD0iTTYsMTVjMC0wLjU1My0wLjQ0Ny0xLTEtMUgzdjFoMi4yNWwtMSwxbDEsMUgzdjFoMmMwLjU1MywwLDEtMC40NDcsMS0xYzAtMC4yNzYtMC4xMTEtMC41MjYtMC4yOTMtMC43MDdMNS40MTQsMTYNCglsMC4yOTMtMC4yOTNDNS44ODksMTUuNTI2LDYsMTUuMjc2LDYsMTV6IE01LjcwNywxMC43MDdDNS44ODksMTAuNTI2LDYsMTAuMjc2LDYsMTBjMC0wLjU1My0wLjQ0Ny0xLTEtMUgzdjFoMi4yNUwzLDEyLjI1VjEzaDN2LTENCglINC40MTRDNC40MTQsMTIsNS41MjUsMTAuODg5LDUuNzA3LDEwLjcwN3ogTTgsNXYxaDlWNUg4eiBNNCw4aDFWNEgzdjFoMVY4eiBNOCwxMWg5di0xSDhWMTF6IE04LDE2aDl2LTFIOFYxNnoiLz4NCjxyZWN0IG9wYWNpdHk9IjAiIGZpbGw9IiM0Mzg3RkQiIHdpZHRoPSIyMSIgaGVpZ2h0PSIyMSIvPg0KPC9zdmc+DQo="},{model_:"Action",name:"decreaseIndentation",label:"",iconUrl:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhLS0gR2VuZXJhdG9yOiBBZG9iZSBJbGx1c3RyYXRvciAxNS4wLjAsIFNWRyBFeHBvcnQgUGx1Zy1JbiAgLS0+DQo8IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiIFsNCgk8IUVOVElUWSBuc19mbG93cyAiaHR0cDovL25zLmFkb2JlLmNvbS9GbG93cy8xLjAvIj4NCl0+DQo8c3ZnIHZlcnNpb249IjEuMSINCgkgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeG1sbnM6YT0iaHR0cDovL25zLmFkb2JlLmNvbS9BZG9iZVNWR1ZpZXdlckV4dGVuc2lvbnMvMy4wLyINCgkgeD0iMHB4IiB5PSIwcHgiIHdpZHRoPSIyMXB4IiBoZWlnaHQ9IjIxcHgiIHZpZXdCb3g9IjAgMCAyMSAyMSIgb3ZlcmZsb3c9InZpc2libGUiIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDIxIDIxIg0KCSB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxkZWZzPg0KPC9kZWZzPg0KPHBhdGggZmlsbD0iIzg4OCIgZD0iTTMsMTZoMTR2LTFIM1YxNnogTTgsOGg5VjdIOFY4eiBNOCwxMGg5VjlIOFYxMHogTTgsMTJoOXYtMUg4VjEyeiBNOCwxNGg5di0xSDhWMTR6IE0zLDV2MWgxNFY1SDN6Ii8+DQo8cG9seWdvbiBvcGFjaXR5PSIwLjg1IiBwb2ludHM9IjYsOCA2LDEzIDMsMTAuNSAiLz4NCjxyZWN0IG9wYWNpdHk9IjAiIGZpbGw9IiM0Mzg3RkQiIHdpZHRoPSIyMSIgaGVpZ2h0PSIyMSIvPg0KPC9zdmc+DQo="},{model_:"Action",name:"increaseIndentation",label:"",iconUrl:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhLS0gR2VuZXJhdG9yOiBBZG9iZSBJbGx1c3RyYXRvciAxNS4wLjAsIFNWRyBFeHBvcnQgUGx1Zy1JbiAgLS0+DQo8IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiIFsNCgk8IUVOVElUWSBuc19mbG93cyAiaHR0cDovL25zLmFkb2JlLmNvbS9GbG93cy8xLjAvIj4NCl0+DQo8c3ZnIHZlcnNpb249IjEuMSINCgkgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeG1sbnM6YT0iaHR0cDovL25zLmFkb2JlLmNvbS9BZG9iZVNWR1ZpZXdlckV4dGVuc2lvbnMvMy4wLyINCgkgeD0iMHB4IiB5PSIwcHgiIHdpZHRoPSIyMXB4IiBoZWlnaHQ9IjIxcHgiIHZpZXdCb3g9IjAgMCAyMSAyMSIgb3ZlcmZsb3c9InZpc2libGUiIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDIxIDIxIg0KCSB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxkZWZzPg0KPC9kZWZzPg0KPHBhdGggZmlsbD0iIzg4OCIgZD0iTTYsMTVjMC0wLjU1My0wLjQ0Ny0xLTEtMUgzdjFoMi4yNWwtMSwxbDEsMUgzdjFoMmMwLjU1MywwLDEtMC40NDcsMS0xYzAtMC4yNzYtMC4xMTEtMC41MjYtMC4yOTMtMC43MDdMNS40MTQsMTYNCglsMC4yOTMtMC4yOTNDNS44ODksMTUuNTI2LDYsMTUuMjc2LDYsMTV6IE01LjcwNywxMC43MDdDNS44ODksMTAuNTI2LDYsMTAuMjc2LDYsMTBjMC0wLjU1My0wLjQ0Ny0xLTEtMUgzdjFoMi4yNUwzLDEyLjI1VjEzaDN2LTENCglINC40MTRDNC40MTQsMTIsNS41MjUsMTAuODg5LDUuNzA3LDEwLjcwN3ogTTgsNXYxaDlWNUg4eiBNNCw4aDFWNEgzdjFoMVY4eiBNOCwxMWg5di0xSDhWMTF6IE04LDE2aDl2LTFIOFYxNnoiLz4NCjxyZWN0IG9wYWNpdHk9IjAiIGZpbGw9IiM0Mzg3RkQiIHdpZHRoPSIyMSIgaGVpZ2h0PSIyMSIvPg0KPC9zdmc+DQo="},{model_:"Action",name:"blockQuote",label:"",iconUrl:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhLS0gR2VuZXJhdG9yOiBBZG9iZSBJbGx1c3RyYXRvciAxNS4wLjAsIFNWRyBFeHBvcnQgUGx1Zy1JbiAgLS0+DQo8IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiIFsNCgk8IUVOVElUWSBuc19mbG93cyAiaHR0cDovL25zLmFkb2JlLmNvbS9GbG93cy8xLjAvIj4NCl0+DQo8c3ZnIHZlcnNpb249IjEuMSINCgkgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeG1sbnM6YT0iaHR0cDovL25zLmFkb2JlLmNvbS9BZG9iZVNWR1ZpZXdlckV4dGVuc2lvbnMvMy4wLyINCgkgeD0iMHB4IiB5PSIwcHgiIHdpZHRoPSIyMXB4IiBoZWlnaHQ9IjIxcHgiIHZpZXdCb3g9IjAgMCAyMSAyMSIgb3ZlcmZsb3c9InZpc2libGUiIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDIxIDIxIg0KCSB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxkZWZzPg0KPC9kZWZzPg0KPHBhdGggZmlsbD0iIzg4OCIgZD0iTTMsMTZoMTR2LTFIM1YxNnogTTgsOGg5VjdIOFY4eiBNOCwxMGg5VjlIOFYxMHogTTgsMTJoOXYtMUg4VjEyeiBNOCwxNGg5di0xSDhWMTR6IE0zLDV2MWgxNFY1SDN6Ii8+DQo8cG9seWdvbiBvcGFjaXR5PSIwLjg1IiBwb2ludHM9IjYsOCA2LDEzIDMsMTAuNSAiLz4NCjxyZWN0IG9wYWNpdHk9IjAiIGZpbGw9IiM0Mzg3RkQiIHdpZHRoPSIyMSIgaGVpZ2h0PSIyMSIvPg0KPC9zdmc+DQo="}],methods:{init:function(){this.SUPER(),this.Y=this.Y=this.Y.sub(),this.Y.registerModel(this.X.lookup("foam.graphics.ActionButtonCView").xbind({background:"white",radius:18}),"foam.ui.ActionButton")
},toHTML:function(){return this.SUPER()+this.toolbar()}},templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      @media (max-width: 360px) {\n        .actionButtonCView-leftJustify, .actionButtonCView-centerJustify, .actionButtonCView-rightJustify {\n          display: none;\n        }\n      }\n\n      @media (max-width: 440px) {\n        .actionButtonCView-numberedList, .actionButtonCView-bulletList {\n          display: none;\n        }\n      }\n\n      @media (max-width: 510px) {\n        .actionButtonCView-decreaseIndentation, .actionButtonCView-increaseIndentation {\n          display: none;\n        }\n      }\n\n      @media (max-width: 560px) {\n        .actionButtonCView-blockQuote {\n          display: none;\n        }\n      }\n    "),out.toString()}},{model_:"Template",name:"toolbar",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('\n      <div class="toolbar">\n      ',self.createTemplateView("bold")," ",self.createTemplateView("italic")," ",self.createTemplateView("underline")," ",self.createTemplateView("link")," ",self.createTemplateView("leftJustify")," ",self.createTemplateView("centerJustify")," ",self.createTemplateView("rightJustify")," ",self.createTemplateView("numberedList")," ",self.createTemplateView("bulletList")," ",self.createTemplateView("decreaseIndentation")," ",self.createTemplateView("increaseIndentation")," ",self.createTemplateView("blockQuote"),"\n      </div>\n    "),out.toString()}}]}),CLASS({model_:"Model","package":"foam.ui",name:"RichTextView",extendsModel:"foam.ui.SimpleView",requires:["foam.util.Base64Decoder","foam.ui.Link"],properties:[{model_:"StringProperty",name:"height",defaultValue:"400"},{model_:"StringProperty",name:"width",defaultValue:"100%"},{model_:"Property",name:"mode",type:"String",view:{factory_:"foam.ui.ChoiceView",choices:["read-only","read-write","final"]},defaultValue:"read-write"},{model_:"Property",name:"data",postSet:function(){this.maybeShowPlaceholder()}},{model_:"Property",name:"placeholder",help:"Placeholder text to appear when no text is entered."},{model_:"Property",name:"document",hidden:!0}],actions:[{model_:"Action",name:"bold",label:"<b>B</b>",help:"Bold (Ctrl-B)",action:function(){this.$.contentWindow.focus(),this.document.execCommand("bold")}},{model_:"Action",name:"italic",label:"<i>I</i>",help:"Italic (Ctrl-I)",action:function(){this.$.contentWindow.focus(),this.document.execCommand("italic")}},{model_:"Action",name:"underline",label:"<u>U</u>",help:"Underline (Ctrl-U)",action:function(){this.$.contentWindow.focus(),this.document.execCommand("underline")}},{model_:"Action",name:"link",label:"Link",help:"Insert link (Ctrl-K)",action:function(){this.Link.create({richTextView:this,label:this.getSelectionText()}).open(5,120)}},{model_:"Action",name:"fontSize",label:"Font Size",help:"Change the font size.",action:function(){}},{model_:"Action",name:"small",label:"small",help:"Set's the font size to small.",parent:"fontSize",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontSize",!1,"2")}},{model_:"Action",name:"normal",label:"normal",help:"Set's the font size to normal.",parent:"fontSize",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontSize",!1,"3")}},{model_:"Action",name:"large",label:"large",help:"Set's the font size to small.",parent:"fontSize",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontSize",!1,"5")}},{model_:"Action",name:"huge",label:"huge",help:"Set's the font size to huge.",parent:"fontSize",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontSize",!1,"7")}},{model_:"Action",name:"fontFace",label:"Font",help:"Set's the font face."},{model_:"Action",name:"sansSerif",help:"Set's the font face.",parent:"fontFace",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontName",!1,"arial, sans-serif")}},{model_:"Action",name:"serif",help:"Set's the font face.",parent:"fontFace",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontName",!1,"times new roman, serif")}},{model_:"Action",name:"wide",help:"Set's the font face.",parent:"fontFace",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontName",!1,"arial bold, sans-serif")}},{model_:"Action",name:"narrow",help:"Set's the font face.",parent:"fontFace",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontName",!1,"arial narrow, sans-serif")}},{model_:"Action",name:"comicSans",help:"Set's the font face.",parent:"fontFace",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontName",!1,"comic sans, sans-serif")}},{model_:"Action",name:"courierNew",help:"Set's the font face.",parent:"fontFace",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontName",!1,"courier new, monospace")}},{model_:"Action",name:"garamond",help:"Set's the font face.",parent:"fontFace",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontName",!1,"garamond, sans-serif")}},{model_:"Action",name:"georgia",help:"Set's the font face.",parent:"fontFace",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontName",!1,"georgia, sans-serif")}},{model_:"Action",name:"tahoma",help:"Set's the font face.",parent:"fontFace",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontName",!1,"tahoma, sans-serif")}},{model_:"Action",name:"trebuchet",help:"Set's the font face.",parent:"fontFace",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontName",!1,"trebuchet ms, sans-serif")}},{model_:"Action",name:"verdana",help:"Set's the font face.",parent:"fontFace",action:function(){this.$.contentWindow.focus(),this.document.execCommand("fontName",!1,"verdana, sans-serif")}},{model_:"Action",name:"removeFormatting",help:"Removes formatting from the current selection.",action:function(){this.$.contentWindow.focus(),this.document.execCommand("removeFormat")}},{model_:"Action",name:"justification",action:function(){}},{model_:"Action",name:"leftJustify",help:"Align Left (Ctrl-Shift-W)",parent:"justification",action:function(){this.$.contentWindow.focus(),this.document.execCommand("justifyLeft")}},{model_:"Action",name:"centerJustify",help:"Align Center (Ctrl-Shift-E)",parent:"justification",action:function(){this.$.contentWindow.focus(),this.document.execCommand("justifyCenter")}},{model_:"Action",name:"rightJustify",help:"Align Right (Ctrl-Shift-R)",parent:"justification",action:function(){this.$.contentWindow.focus(),this.document.execCommand("justifyRight")}},{model_:"Action",name:"numberedList",help:"Numbered List (Ctrl-Shift-7)",action:function(){this.$.contentWindow.focus(),this.document.execCommand("insertOrderedList")}},{model_:"Action",name:"bulletList",help:"Bulleted List (Ctrl-Shift-7)",action:function(){this.$.contentWindow.focus(),this.document.execCommand("insertUnorderedList")}},{model_:"Action",name:"decreaseIndentation",help:"Indent Less (Ctrl-[)",action:function(){this.$.contentWindow.focus(),this.document.execCommand("outdent")}},{model_:"Action",name:"increaseIndentation",help:"Indent More (Ctrl-])",action:function(){this.$.contentWindow.focus(),this.document.execCommand("indent")}},{model_:"Action",name:"blockQuote",help:"Quote (Ctrl-Shift-9)",action:function(){this.$.contentWindow.focus(),this.document.execCommand("formatBlock",!1,"<blockquote>")}}],methods:{toHTML:function(){var sandbox="read-write"===this.mode?"":' sandbox="allow-same-origin"',id=this.id;return this.dropId=this.nextID(),this.placeholderId=this.nextID(),'<div class="richtext"><div id="'+this.dropId+'" class="dropzone"><div class=spacer></div>Drop files here<div class=spacer></div></div><div id="'+this.placeholderId+'" class="placeholder">'+this.placeholder+'</div><iframe style="width:'+this.width+";min-height:"+this.height+'px" id="'+this.id+'"'+sandbox+' img-src="*"></iframe></div>'},initHTML:function(){this.SUPER();var drop=$(this.dropId);this.dropzone=drop,this.document=this.$.contentDocument;var body=this.document.body;body.style.whiteSpace="pre-wrap",$(this.placeholderId).addEventListener("click",function(){body.focus()}),this.document.head.insertAdjacentHTML("afterbegin","<style>blockquote{border-left-color:#ccc;border-left-style:solid;padding-left:1ex;}</style>"),body.style.overflow="auto",body.style.margin="5px";var self=this;body.ondrop=function(e){e.preventDefault(),self.showDropMessage(!1);for(var length=e.dataTransfer.files.length,i=0;length>i;i++){var file=e.dataTransfer.files[i],id=this.addAttachment(file);if(file.type.startsWith("image/")){var img=document.createElement("img");img.id=id,img.src=URL.createObjectURL(file),this.insertElement(img)}}if(length=e.dataTransfer.items.length){var div=this.sanitizeDroppedHtml(e.dataTransfer.getData("text/html"));this.insertElement(div)}}.bind(this),self.dragging_=0,body.ondragenter=function(e){self.dragging_++,self.showDropMessage(!0)},body.ondragleave=function(e){0==--self.dragging_&&self.showDropMessage(!1)},"read-write"===this.mode&&(this.document.body.contentEditable=!0),this.domValue=DomValue.create(this.document.body,"input","innerHTML"),Events.link(this.data$,this.domValue),this.maybeShowPlaceholder()},getSelectionText:function(){var window=this.$.contentWindow,selection=window.getSelection();return selection.rangeCount?selection.getRangeAt(0).toLocaleString():""},insertElement:function(e){var window=this.$.contentWindow,selection=window.getSelection();if(selection.rangeCount){var r=selection.getRangeAt(0);r.deleteContents(),r.insertNode(e)}else{var range=window.document.createRange();range.selectNodeContents(window.document.body),range.insertNode(e)}this.updateValue()},updateValue:function(){this.data=this.document.body.innerHTML},showDropMessage:function(show){this.$.style.opacity=show?"0":"1"},sanitizeDroppedHtml:function(html){function copyNodes(parent,node){for(var i=0;i<allowedElements.length;i++)if(allowedElements[i].name===node.nodeName){if(allowedElements[i].clone)newNode=allowedElements[i].clone(node);else if(node.nodeType===Node.ELEMENT_NODE){newNode=document.createElement(node.nodeName);for(var j=0;j<allowedElements[i].attributes.length;j++)node.hasAttribute(allowedElements[i].attributes[j])&&newNode.setAttribute(allowedElements[i].attributes[j],node.getAttribute(allowedElements[i].attributes[j]))}else newNode=node.nodeType===Node.TEXT_NODE?document.creatTextNode(node.nodeValue):document.createTextNode("");break}for(i===allowedElements.length&&(newNode=document.createElement("div")),newNode&&parent.appendChild(newNode),j=0;j<node.children.length;j++)copyNodes(newNode,node.children[j])}var self=this,allowedElements=[{name:"B",attributes:[]},{name:"I",attributes:[]},{name:"U",attributes:[]},{name:"P",attributes:[]},{name:"SECTION",attributes:[]},{name:"BR",attributes:[]},{name:"BLOCKQUOTE",attributes:[]},{name:"DIV",attributes:[]},{name:"IMG",attributes:["src"],clone:function(node){var newNode=document.createElement("img");if(node.src.startsWith("http")){var xhr=new XMLHttpRequest;xhr.open("GET",node.src),xhr.responseType="blob",xhr.asend(function(blob){blob.name="dropped image",blob?(newNode.id=self.addAttachment(blob),newNode.src=URL.createObjectURL(blob)):blob.parent.removeChild(blob),self.updateValue()})}else{if(!node.src.startsWith("data:"))return null;var type=node.src.substring(5,node.src.indexOf(";")),decoder=self.Base64Decoder.create({bufsize:node.src.length});decoder.put(node.src.substring(node.src.indexOf("base64,")+7)),decoder.eof();var blob=new Blob(decoder.sink,{type:type});blob.name="dropped image",newNode.id=self.addAttachment(blob),newNode.src=URL.createObjectURL(blob)}return newNode}},{name:"A",attributes:["href"]},{name:"#TEXT",attributes:[]}],frame=document.createElement("iframe");frame.sandbox="allow-same-origin",frame.style.display="none",document.body.appendChild(frame),frame.contentDocument.body.innerHTML=html;for(var sanitizedContent=new DocumentFragment,i=0;i<frame.contentDocument.body.children.length;i++)copyNodes(sanitizedContent,frame.contentDocument.body.children[i]);return document.body.removeChild(frame),sanitizedContent},addAttachment:function(file){var id="att"+{}.$UID;return console.log("file: ",file,id),this.publish("attachmentAdded",file,id),id},removeImage:function(imageID){var e=this.document.getElementById(imageID);e&&(e.outerHTML="",this.data=this.document.body.innerHTML)},destroy:function(isParentDestroyed){this.SUPER(isParentDestroyed),Events.unlink(this.domValue,this.value)},textToValue:function(text){return text},valueToText:function(value){return value},setForegroundColor:function(color){this.$.contentWindow.focus(),this.document.execCommand("foreColor",!1,color)},setBackgroundColor:function(color){this.$.contentWindow.focus(),this.document.execCommand("backColor",!1,color)}},listeners:[{model_:"Method",name:"maybeShowPlaceholder",code:function(){var e=$(this.placeholderId);e&&(e.style.visibility=""==this.data?"visible":"hidden")}}]}),CLASS({model_:"Model","package":"foam.util",name:"Base64Decoder",properties:[{model_:"IntProperty",name:"bufsize",help:"Size of the internal buffer to use.",defaultValue:512},{model_:"Property",name:"buffer",factory:function(){return new ArrayBuffer(this.bufsize)}},{model_:"IntProperty",name:"pos",defaultValue:0},{model_:"IntProperty",name:"chunk",defaultValue:3},{model_:"Property",name:"sink",factory:function(){return[].sink}}],constants:[{model_:"Constant",name:"TABLE",value:{0:52,1:53,2:54,3:55,4:56,5:57,6:58,7:59,8:60,9:61,A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,L:11,M:12,N:13,O:14,P:15,Q:16,R:17,S:18,T:19,U:20,V:21,W:22,X:23,Y:24,Z:25,a:26,b:27,c:28,d:29,e:30,f:31,g:32,h:33,i:34,j:35,k:36,l:37,m:38,n:39,o:40,p:41,q:42,r:43,s:44,t:45,u:46,v:47,w:48,x:49,y:50,z:51,"+":62,"/":63,"-":62,_:63}}],methods:{lookup:function(data){return this.TABLE[data]},put:function(data){var tmp=0;this.view=new DataView(this.buffer);for(var i=0;i<data.length&&"="!=data[i];i++){var value=this.lookup(data[i]);void 0!==value&&(tmp|=value<<6*this.chunk,0==this.chunk?(this.emit(3,tmp),tmp=0,this.chunk=3):this.chunk-=1)}"="==data[i]&&(i++,i<data.length?"="==data[i]&&this.emit(1,tmp):this.emit(2,tmp))},emit:function(bytes,tmp){for(var j=0;bytes>j;j++)this.view.setUint8(this.pos,tmp>>8*(2-j)&255),this.pos+=1,this.pos>=this.buffer.byteLength&&(this.sink.put(this.buffer),this.buffer=new ArrayBuffer(this.bufsize),this.view=new DataView(this.buffer),this.pos=0)},eof:function(){this.sink.put(this.buffer.slice(0,this.pos)),this.sink.eof&&this.sink.eof()}}}),CLASS({model_:"Model","package":"foam.ui",name:"Link",requires:["foam.ui.LinkView"],properties:[{model_:"Property",name:"richTextView"},{model_:"Property",name:"label",displayWidth:28},{model_:"Property",name:"link",displayWidth:19,view:{factory_:"foam.ui.TextFieldView",placeholder:"Type or paste link."},preSet:function(_,value){return value=value.trim(),value.toLowerCase().startsWith("javascript:")&&(value=""),value}}],actions:[{model_:"Action",name:"insert",label:"Apply",help:"Insert this link into the document.",action:function(){var a=document.createElement("a"),txt=document.createTextNode(this.label);a.href=this.link,a.appendChild(txt),this.richTextView.insertElement(a),this.view.close()}}],methods:{open:function(x,y){var view=this.LinkView.create({data:this});this.richTextView.$.parentNode.insertAdjacentHTML("beforebegin",view.toHTML()),view.$.style.left=x+this.richTextView.$.offsetLeft,view.$.style.top=y+this.richTextView.$.offsetTop,view.initHTML(),this.view=view}}}),CLASS({model_:"Model","package":"foam.ui",name:"LinkView",extendsModel:"foam.ui.DetailView",properties:[{model_:"Property",name:"insertButton",factory:function(){return ActionButton.create({action:Link.INSERT,data:this.data})}}],methods:{init:function(){this.SUPER(),this.addChild(this.insertButton)},initHTML:function(){this.SUPER(),this.$.addEventListener("keyup",this.keyUp),this.labelView.focus()},close:function(){this.$.remove()}},listeners:[{model_:"Method",name:"keyUp",code:function(e){27==e.keyCode&&(e.stopPropagation(),this.close())}}],templates:[{model_:"Template",name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('<div id="',this.id,'" class="linkDialog" style="position:absolute">        <table><tr>        <th>Text</th><td>',self.createTemplateView("label"),"</td></tr><tr>        <th>Link</th><td>",self.createTemplateView("link"),"        ",self.insertButton,"</td>        </tr></table>        </div>"),out.toString()}}]}),CLASS({model_:"Model","package":"foam.ui",name:"SimpleView",extendsModel:"foam.ui.BaseView",requires:["Property"],exports:["propertyViewProperty"],traits:["foam.ui.HTMLViewTrait","foam.ui.ViewActionsTrait","foam.ui.TemplateSupportTrait"],properties:[{model_:"Property",name:"propertyViewProperty",type:"Property",defaultValueFn:function(){return this.Property.DETAIL_VIEW}}]}),CLASS({model_:"Model","package":"foam.ui.md",name:"TextFieldView",extendsModel:"foam.ui.SimpleView",properties:[{model_:"Property",name:"className",defaultValueFn:function(){return"md-text-field-container"+(this.floatingLabel?"":" md-text-field-no-label")}},{model_:"Property",name:"data"},{model_:"Property",name:"softData"},{model_:"Property",name:"inputId"},{model_:"Property",name:"$input",getter:function(){return this.X.$(this.inputId)}},{model_:"Property",name:"labelId"},{model_:"Property",name:"$label",getter:function(){return this.X.$(this.labelId)}},{model_:"BooleanProperty",name:"focused",defaultValue:!1},{model_:"Property",name:"prop"},{model_:"Property",name:"label",defaultValueFn:function(){return this.prop.label}},{model_:"BooleanProperty",name:"onKeyMode"},{model_:"IntProperty",name:"displayHeight"},{model_:"IntProperty",name:"displayWidth"},{model_:"BooleanProperty",name:"floatingLabel",defaultValue:!0},{model_:"BooleanProperty",name:"growable",defaultValue:!1},{model_:"Property",name:"clearAction",defaultValue:!1}],actions:[{model_:"Action",name:"clear",label:"",isAvailable:function(){return!!this.softData.length},iconUrl:"images/ic_cancel_24dp.png",action:function(){this.softData=""}}],methods:{initHTML:function(){this.SUPER(),this.softValue=DomValue.create(this.$input,"input",this.growable?"textContent":"value"),this.softValue.set(this.data),Events.link(this.softValue,this.softData$),this.onKeyMode?Events.link(this.data$,this.softData$):Events.follow(this.data$,this.softData$)},focus:function(){this.$input.focus()},blur:function(){this.$input&&this.$input.blur()}},listeners:[{model_:"Method",name:"onFocus",code:function(){this.focused=!0}},{model_:"Method",name:"onBlur",code:function(){this.focused=!1}},{model_:"Method",name:"onInput",code:function(){}},{model_:"Method",name:"onChange",code:function(){this.data=this.softData}},{model_:"Method",name:"onKeyDown",code:function(){}},{model_:"Method",name:"onClick",code:function(){this.$input.focus()}}],templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .md-text-field-container {\n        align-items: center;\n        width: 100%;\n        display: flex;\n        position: relative;\n      }\n      .md-text-field-label {\n        position: absolute;\n        top: 40px;\n        font-size: 14px;\n        font-weight: 500;\n        color: #999;\n        transition: font-size 0.5s, top 0.5s;\n        flex-grow: 1;\n        margin-left: 16px;\n        z-index: 0;\n      }\n      .md-text-field-input {\n        background: transparent;\n        border-bottom: 1px solid #e0e0e0;\n        border-left: none;\n        border-right: none;\n        border-top: none;\n        color: #444;\n        flex-grow: 1;\n        font-family: Roboto;\n        font-size: 14px;\n        margin: 40px 16px 8px;\n        padding: 0 0 7px 0;\n        resize: none;\n        z-index: 1;\n      }\n      .md-text-field-container.md-text-field-no-label .md-text-field-input {\n        font-size: 16px;\n        margin: 8px 0;\n        padding: 8px 2px;\n      }\n\n      .md-text-field-input:focus {\n        border-bottom: 2px solid #4285f4;\n        padding: 0 0 6px 0;\n        outline: none;\n      }\n      .md-text-field-label-offset {\n        font-size: 12px;\n        top: 16px;\n      }\n    "),out.toString()}},{model_:"Template",name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);out("\n      ");var input=this.inputId=this.nextID(),label=this.labelId=this.nextID();return this.on("focus",this.onFocus,input),this.on("blur",this.onBlur,input),this.on("input",this.onInput,input),this.on("change",this.onChange,input),this.on("click",this.onClick,input),this.on("keydown",this.onKeyDown,input),this.floatingLabel&&this.setClass("md-text-field-label-offset",function(){var focused=self.focused,data=self.data;return focused||(""+data).length>0},label),out("\n      <div ",self.cssClassAttr(),' id="',self.id,'">\n        '),this.floatingLabel&&out('\n          <label id="',label,'" class="md-text-field-label">',self.label,"</label>\n        "),out("\n        "),this.growable?out('\n          <div id="',input,'" class="md-text-field-input" contenteditable>\n          </div>\n        '):this.displayHeight>1?out('\n          <textarea id="',input,'" type="text" class="md-text-field-input" rows="',this.displayHeight,'"></textarea>\n        '):(out('\n          <input id="',input,'" type="text" class="md-text-field-input"\n              ',this.floatingLabel?"":'placeholder="'+this.label+'"'," />\n          "),this.clearAction&&out("\n            ",self.createTemplateView("clear"),"\n          "),out("\n        ")),out("\n      </div>\n    "),out.toString()}}]}),CLASS({model_:"Model","package":"com.google.mail",name:"EMailCitationView",extendsModel:"foam.ui.DetailView",requires:["foam.ui.md.MonogramStringView","foam.ui.RelativeDateTimeFieldView","foam.ui.ImageBooleanView"],imports:["controller"],properties:[{model_:"Property",name:"className",defaultValue:"email-citation"},{model_:"Property",name:"preferredHeight",defaultValue:82,help:"Specifying the preferred height of this view for the ScrollView, since an empty row is too small."}],templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .email-citation {\n        display: flex;\n        display: -webkit-flex;\n        border-bottom: solid #B5B5B5 1px;\n        padding: 10px 14px 10px 6px;\n      }\n\n      .email-citation.unread {\n        font-weight: bold;\n      }\n\n      .email-citation .from {\n        display: block;\n        font-size: 17px;\n        line-height: 24px;\n        white-space: nowrap;\n        overflow-x:hidden;\n        text-overflow: ellipsis;\n        flex-grow: 1;\n        -webkit-flex-grow: 1;\n      }\n\n      .email-citation .timestamp {\n        font-size: 12px;\n        color: rgb(17, 85, 204);\n        white-space: nowrap;\n        flex-shrink: 0;\n        -webkit-flex-shrink: 0;\n      }\n\n      .email-citation .subject {\n        display: block;\n        font-size: 13px;\n        line-height: 17px;\n        overflow-x:hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n      }\n\n      .email-citation .snippet {\n        color: rgb(119, 119, 119);\n        display: block;\n        font-size: 13px;\n        height: 20px;\n        overflow-x: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n      }\n\n      .email-citation .monogram-string-view {\n        margin: auto 6px auto 0;\n      }\n    "),out.toString()}},{model_:"Template",name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);out("\n      ");var id=this.setClass("unread",function(){return self.data&&self.data.unread},this.id);return this.on("click",function(){this.controller.open(this.data.id)},this.id),out('\n\n      <div id="',id,'" ',self.cssClassAttr()," >\n        ",self.createTemplateView("from",{model_:"foam.ui.md.MonogramStringView"}),'\n        <div style="flex: 1; -webkit-flex: 1">\n          <div style="display: flex; display: -webkit-flex">\n            ',self.createTemplateView("from",{mode:"read-only",className:"from",escapeHTML:!0}),"\n            ",self.createTemplateView("timestamp",{model_:"foam.ui.RelativeDateTimeFieldView",mode:"read-only",className:"timestamp"}),"\n          </div>\n          <div style=\"display: flex; display: -webkit-flex\">\n            <div style='flex-grow: 1; -webkit-flex-grow: 1'>\n              ",self.createTemplateView("subject",{mode:"read-only",className:"subject"}),"\n              ",self.createTemplateView("snippet",{mode:"read-only",className:"snippet"}),"\n            </div>\n            ",self.createTemplateView("starred",{model_:"foam.ui.ImageBooleanView",className:"star",trueImage:"images/ic_star_24dp.png",falseImage:"images/ic_star_outline_24dp.png"}),"\n          </div>\n        </div>\n      </div>\n    "),out.toString()}}]}),CLASS({model_:"Model","package":"foam.ui.md",name:"MonogramStringView",extendsModel:"foam.ui.View",traits:["foam.ui.md.ColoredBackgroundTrait"],properties:[{model_:"Property",name:"className",defaultValue:"monogram-string-view"},{model_:"Property",name:"tooltip",defaultValueFn:function(){return this.data}},{model_:"Property",name:"data",postSet:function(old,nu){this.updateHTML()}}],methods:{generateColor:function(data){return data?this.SUPER(data):"url(images/silhouette.png) center no-repeat #e0e0e0"},updateHTML:function(){return this.$&&(this.$.style.background=this.generateColor(this.data)),this.SUPER()}},templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .monogram-string-view {\n        -webkit-align-items: center;\n        -webkit-flex-grow: 0;\n        -webkit-justify-content: center;\n        align-items: center;\n        border-radius: 20px;\n        border: 1px solid rgba(0,0,0,.1);\n        color: #fff;\n        display: -webkit-inline-flex;\n        display: inline-flex;\n        flex-grow: 0;\n        font-size: 20px;\n        height: 40px;\n        justify-content: center;\n        margin-right: 16px;\n        overflow: hidden;\n        padding-bottom: 2px;\n        width: 40px;\n      }\n    "),out.toString()}},{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out(" ",this.data[0]&&this.data[0].toUpperCase()||"&nbsp;"," "),out.toString()}},{model_:"Template",name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('\n      <div id="',this.id,'" ',this.cssClassAttr(),' style="background: ',this.generateColor(this.data),'">\n        ',this.toInnerHTML(),"\n      </div>\n    "),out.toString()}}]}),CLASS({model_:"Model","package":"foam.ui.md",name:"ColoredBackgroundTrait",properties:[{model_:"Property",name:"colors",defaultValue:["e8ad62","9b26af","6639b6","4184f3","02a8f3","00bbd3","009587","0e9c57","9e9c57","8ac249","ccdb38","ffea3a","f3b300","ff9700","ff5621","785447"]}],methods:{generateColor:function(data){return"#"+this.colors[Math.abs(data.hashCode())%this.colors.length]},generateColorStyle:function(data){return' style="background:'+this.generateColor(data)+';"'}}}),CLASS({model_:"Model","package":"foam.ui",name:"RelativeDateTimeFieldView",label:"Relative Date-Time Field",extendsModel:"foam.ui.DateTimeFieldView",properties:[{model_:"Property",name:"mode",defaultValue:"read-only"}],methods:{valueToDom:function(value){return value?value.toRelativeDateString():""}}}),CLASS({model_:"Model","package":"foam.ui",name:"DateTimeFieldView",label:"Date-Time Field",extendsModel:"foam.ui.SimpleView",properties:[{model_:"StringProperty",name:"name"},{model_:"StringProperty",name:"mode",defaultValue:"read-write"},{model_:"Property",name:"domValue",postSet:function(oldValue){oldValue&&this.value&&Events.unlink(oldValue,this.value)}},{model_:"Property",name:"data"}],methods:{valueToDom:function(value){return value?value.getTime():0},domToValue:function(dom){return new Date(dom)},toHTML:function(){return"read-write"===this.mode?'<input id="'+this.id+'" type="datetime-local" name="'+this.name+'"/>':'<span id="'+this.id+'" name="'+this.name+'" '+this.cssClassAttr()+"></span>"},initHTML:function(){this.SUPER(),this.domValue=DomValue.create(this.$,"read-write"===this.mode?"input":void 0,"read-write"===this.mode?"valueAsNumber":"textContent"),Events.relate(this.data$,this.domValue,this.valueToDom.bind(this),this.domToValue.bind(this))}}}),CLASS({model_:"Model","package":"foam.ui",name:"ImageBooleanView",extendsModel:"foam.ui.View",properties:[{model_:"Property",name:"data",postSet:function(old,nu){this.updateHTML()}},{model_:"Property",name:"name",label:"Name",type:"String",defaultValue:""},{model_:"Property",name:"trueImage"},{model_:"Property",name:"falseImage"},{model_:"Property",name:"trueClass"},{model_:"Property",name:"falseClass"}],methods:{image:function(){return this.data?this.trueImage:this.falseImage},toHTML:function(){var id=this.id;return this.on("click",this.onClick,id),this.name?'<img id="'+id+'" '+this.cssClassAttr()+'" name="'+this.name+'">':'<img id="'+id+'" '+this.cssClassAttr()+">"},initHTML:function(){this.$&&(this.SUPER(),this.updateHTML())},updateHTML:function(){this.$&&(this.$.src=this.image(),this.data?(this.trueClass&&this.$.classList.add(this.trueClass),this.falseClass&&this.$.classList.remove(this.falseClass)):(this.trueClass&&this.$.classList.remove(this.trueClass),this.falseClass&&this.$.classList.add(this.falseClass)))}},listeners:[{model_:"Method",name:"onClick",code:function(e){e.stopPropagation(),this.data=!this.data}}]}),CLASS({model_:"Model","package":"com.google.mail",name:"EMailDAO",extendsModel:"ProxyDAO",requires:["Binding","CachingDAO","ContextualizingDAO","FutureDAO","IDBDAO","MDAO","PersistentContext","com.google.mail.FOAMGMailMessage","com.google.mail.GMailMessageDAO","com.google.mail.GMailToEMailDAO","com.google.mail.Sync","com.google.mail.SyncDecorator","foam.core.dao.MergeDAO","foam.core.dao.PropertyOffloadDAO","foam.core.dao.StripPropertiesDAO","foam.core.dao.CloningDAO","foam.core.dao.VersionNoDAO","foam.lib.email.EMail"],imports:["setInterval"],exports:["as emailDao"],properties:[{model_:"BooleanProperty",name:"withSync",defaultValue:!0},{model_:"IntProperty",name:"syncInterval",defaultValue:3e4},{model_:"Property",name:"persistentContext",lazyFactory:function(){var context={};return this.PersistentContext.create({dao:this.IDBDAO.create({model:this.Binding,name:"EMailDAO-Bindings"}),predicate:NOT_TRANSIENT,context:context})}},{model_:"Property",name:"remoteDao",factory:function(){var future=afuture();return this.persistentContext.bindObject("remoteDao",this.GMailMessageDAO)(future.set),this.GMailToEMailDAO.create({delegate:this.FutureDAO.create({future:future.get})})}},{model_:"Property",name:"bodyDAO",factory:function(){return this.IDBDAO.create({model:this.EMail,name:"EMail-Bodies",loadOnSelect:!1})}},{model_:"Property",name:"delegate",type:"DAO",factory:function(){return this.ContextualizingDAO.create({delegate:this.VersionNoDAO.create({property:this.EMail.CLIENT_VERSION,delegate:this.cachingDAO})})}},{model_:"Property",name:"cachingDAO",factory:function(){return this.PropertyOffloadDAO.create({property:this.EMail.BODY,offloadDAO:this.bodyDAO,delegate:this.CloningDAO.create({delegate:this.CachingDAO.create({src:this.IDBDAO.create({model:this.EMail}),delegate:this.MDAO.create({model:this.EMail})})})})
},postSet:function(_,dao){dao.select(COUNT())(function(c){0===c.count&&this.StripPropertiesDAO.create({delegate:this.remoteDao,propertyNames:["serverVersion"]}).where(EQ(this.EMail.LABELS,"INBOX")).limit(100).select(dao)}.bind(this))}},{model_:"Property",name:"sync",factory:function(){if(this.withSync){var sync=this.Sync.create({local:this.SyncDecorator.create({delegate:this.MergeDAO.create({delegate:this.cachingDAO,mergeStrategy:function(ret,oldValue,newValue){newValue.clientVersion<oldValue.clientVersion&&(newValue.labelIds=oldValue.labelIds,newValue.clientVersion=oldValue.clientVersion),ret(newValue)}})}),remote:this.remoteDao,localVersionProp:this.EMail.CLIENT_VERSION,remoteVersionProp:this.EMail.SERVER_VERSION,deletedProp:this.EMail.DELETED,initialSyncWindow:10});return this.delegate.listen(this.doSync),this.setInterval(this.doSync,this.syncInterval),sync}}}],listeners:[{model_:"Method",name:"doSync",code:function(){this.sync.sync()},isMerged:1e3}]}),CLASS({model_:"Model","package":"com.google.mail",name:"FOAMGMailMessage",extendsModel:"com.google.mail.GMailMessage",plural:"messages",requires:["foam.util.Base64Decoder","foam.util.Base64Encoder","foam.util.encodings.IncrementalUtf8"],properties:[{model_:"StringProperty",name:"historyId",help:"The ID of the last history record that modified this message."},{model_:"StringProperty",name:"id",help:"The immutable ID of the message."},{model_:"StringArrayProperty",name:"labelIds",help:"List of IDs of labels applied to this message."},{model_:"Property",name:"payload",subType:"MessagePart",help:"The parsed email structure in the message parts."},{model_:"StringProperty",name:"raw",help:"The entire email message in an RFC 2822 formatted string. Returned in messages.get and drafts.get responses when the format=RAW parameter is supplied."},{model_:"IntProperty",name:"sizeEstimate",help:"Estimated size in bytes of the message."},{model_:"StringProperty",name:"snippet",help:"A short part of the message text."},{model_:"StringProperty",name:"threadId",help:'The ID of the thread the message belongs to. To add a message or draft to a thread, the following criteria must be met: \n- The requested threadId must be specified on the Message or Draft.Message you supply with your request. \n- The References and In-Reply-To headers must be set in compliance with the <a href="https://tools.ietf.org/html/rfc2822"RFC 2822 standard. \n- The Subject headers must match.'},{model_:"BooleanProperty",name:"deleted"},{model_:"BooleanProperty",name:"isSent",defaultValue:!1},{model_:"IntProperty",name:"clientVersion"},{model_:"StringProperty",name:"draftId"},{model_:"StringProperty",name:"messageId"}],constants:[{model_:"Constant",name:"FOAM_MESSAGEID_HEADER",value:"X-FOAM-Message-ID"}],methods:{getHeader:function(name){if(!this.payload)return null;for(var i=0;i<this.payload.headers.length;i++)if(this.payload.headers[i].name===name)return this.payload.headers[i].value;return null},setHeader:function(name,value){if(this.payload){for(var i=0;i<this.payload.headers.length;i++)if(this.payload.headers[i].name===name)return void(this.payload.headers[i].value=value);this.payload.headers.push({name:name,value:value})}},toRaw:function(){function doPart(p){for(var i=0,header;header=p.headers[i];i++)if(buffer+=header.name+": "+header.value+"\r\n","Content-Type"===header.name&&header.value.startsWith("multipart"))var boundary=header.value.match(/boundary=([\S]+)/)[1];if(buffer+="\r\n",p.body&&p.body.size>0){var decoder=self.Base64Decoder.create({sink:this.IncrementalUtf8.create(),bufsize:p.body.size});decoder.put(p.body.data),decoder.eof(),buffer+=decoder.sink.string}if(p.parts&&p.parts.length>0){for(var i=0,part;part=p.parts[i];i++)buffer+="--"+boundary+"\r\n",doPart(part),buffer+="\r\n";buffer+="--"+boundary+"--\r\n"}}var buffer="",self=this,obj=this.clone();return obj.clearProperty("payload"),obj.raw||(doPart(this.payload),obj.raw=this.Base64Encoder.create({urlSafe:!0}).encode(new Uint8Array(stringtoutf8(buffer)))),obj}}}),CLASS({model_:"Model","package":"foam.util",name:"Base64Encoder",properties:[{model_:"Property",name:"table",defaultValueFn:function(){return this.TABLE}},{model_:"BooleanProperty",name:"urlSafe",postSet:function(_,v){this.table=this.TABLE.clone(),v&&(this.table[62]="-",this.table[63]="_")}}],constants:[{model_:"Constant",name:"TABLE",value:["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"]}],methods:{encode:function(b,opt_break){var result="",out;if(opt_break>=0){var count=0;out=function(c){result+=c,count=(count+1)%opt_break,0===count&&(result+="\r\n")}}else out=function(c){result+=c};for(var view=new Uint8Array(b),i=0;i+2<b.byteLength;i+=3)out(this.table[view[i]>>>2]),out(this.table[(3&view[i])<<4|view[i+1]>>>4]),out(this.table[(15&view[i+1])<<2|view[i+2]>>>6]),out(this.table[63&view[i+2]]);return i<b.byteLength&&(out(this.table[view[i]>>>2]),i+1<b.byteLength?(out(this.table[(3&view[i])<<4|view[i+1]>>>4]),out(this.table[(15&view[i+1])<<2])):(out(this.table[(3&view[i])<<4]),out("=")),out("=")),result}}}),CLASS({model_:"Model","package":"foam.util.encodings",name:"IncrementalUtf8",properties:[{model_:"Property",name:"charcode",defaultValue:null},{model_:"Property",name:"remaining",defaultValue:0},{model_:"Property",name:"string"}],methods:{reset:function(){this.string="",this.remaining=0,this.charcode=null},put:function(byte){if(byte instanceof ArrayBuffer)for(var data=new Uint8Array(byte),i=0;i<data.length;i++)this.put(data[i]);else{if(null==this.charcode)if(this.charcode=byte,128&this.charcode)if(192==(224&this.charcode))this.remaining=1,this.charcode=(31&byte)<<6*this.remaining;else if(224==(240&this.charcode))this.remaining=2,this.charcode=(15&byte)<<6*this.remaining;else if(240==(248&this.charcode))this.remaining=3,this.charcode=(7&byte)<<6*this.remaining;else if(248==(252&this.charcode))this.remaining=4,this.charcode=(3&byte)<<6*this.remaining;else{if(252!=(254&this.charcode))throw"Bad charcode value";this.remaining=5,this.charcode=(1&byte)<<6*this.remaining}else this.remaining=0,this.charcode=(127&byte)<<6*this.remaining;else this.remaining>0&&(this.remaining--,this.charcode|=(63&byte)<<6*this.remaining);0==this.remaining&&(this.string+=String.fromCharCode(this.charcode),this.charcode=void 0)}}}}),CLASS({model_:"Model","package":"com.google.mail",name:"GMailMessage",plural:"messages",properties:[{model_:"StringProperty",name:"historyId",help:"The ID of the last history record that modified this message."},{model_:"StringProperty",name:"id",help:"The immutable ID of the message."},{model_:"StringArrayProperty",name:"labelIds",help:"List of IDs of labels applied to this message."},{model_:"Property",name:"payload",subType:"MessagePart",help:"The parsed email structure in the message parts."},{model_:"StringProperty",name:"raw",help:"The entire email message in an RFC 2822 formatted string. Returned in messages.get and drafts.get responses when the format=RAW parameter is supplied."},{model_:"IntProperty",name:"sizeEstimate",help:"Estimated size in bytes of the message."},{model_:"StringProperty",name:"snippet",help:"A short part of the message text."},{model_:"StringProperty",name:"threadId",help:'The ID of the thread the message belongs to. To add a message or draft to a thread, the following criteria must be met: \n- The requested threadId must be specified on the Message or Draft.Message you supply with your request. \n- The References and In-Reply-To headers must be set in compliance with the <a href="https://tools.ietf.org/html/rfc2822"RFC 2822 standard. \n- The Subject headers must match.'}]}),CLASS({model_:"Model","package":"com.google.mail",name:"GMailMessageDAO",extendsModel:"com.google.mail.GMailRestDAO",requires:["com.google.mail.FOAMGMailMessage","com.google.mail.GMailRestDAO","com.google.mail.GMailDraft","com.google.mail.GMailMessage","com.google.mail.GMailHistory","NullDAO","com.google.mail.GMailHistory"],imports:["ajsonp"],properties:[{model_:"Property",name:"url","transient":!0,defaultValue:"https://www.googleapis.com/gmail/v1/users"},{model_:"Property",name:"modelName","transient":!0,defaultValueFn:function(){return this.model.plural}},{model_:"Property",name:"xhr","transient":!0,factory:function(){return this.X.XHR.create({responseType:"json"},this.Y)}},{model_:"Property",name:"model",hidden:!0,"transient":!0,defaultValueFn:function(){return this.FOAMGMailMessage}},{model_:"Property",name:"messageUrl","transient":!0,defaultValueFn:function(){return this.url+"/me/messages"}},{model_:"Property",name:"draftUrl","transient":!0,defaultValueFn:function(){return this.url+"/me/drafts"}},{model_:"Property",name:"draftDao",hidden:!0,"transient":!0,factory:function(){return this.GMailRestDAO.create({model:this.GMailDraft})}},{model_:"Property",name:"localDao",hidden:!0,"transient":!0,factory:function(){return this.NullDAO.create({model:this.GMailMessage})}},{model_:"Property",name:"historyDao",hidden:!0,"transient":!0,factory:function(){return this.GMailRestDAO.create({model:this.GMailHistory})}},{model_:"IntProperty",name:"pollingPeriod",units:"ms",defaultValue:1e4},{model_:"BooleanProperty",name:"syncing","transient":!0,defaultValue:!1},{model_:"IntProperty",name:"lastClientVersion"}],methods:{listen:function(l,options){this.SUPER(l,options),1===this.daoListeners_.length&&this.startSync()},unlisten:function(l){this.SUPER(l),0===this.daoListeners_.length&&this.stopSync()},doSync:function(ret){var self=this;this.historyDao.where(GT(this.GMailHistory.ID,self.lastHistoryId)).select({put:function(item){self.lastHistoryId=item.id;for(var i=0,msg;msg=item.messages[i];i++)self.find(msg.id,{put:function(obj){self.notify_("put",[obj])},error:function(_,status){if(404===status){var obj=self.jsonToObj(msg);return void self.notify_("remove",[obj])}}})},error:function(){ret()},eof:function(){ret()}})},startSync:function(){var self=this;this.syncing||aseq(function(ret){return self.syncing=!0,self.lastHistoryId?void ret():void self.limit(1).select()(function(msgs){return msgs&&0!==msgs.length?(self.lastHistoryId=msgs[0].historyId,void ret()):void self.X.setTimeout(self.startSync.bind(self),6e4)})},awhile(function(){return self.syncing},aseq(function(ret){self.doSync(ret)},function(ret){self.X.setTimeout(ret,self.pollingPeriod)})))(function(){})},stopSync:function(){this.syncing=!1},postProcessObject:function(ret,error,obj){var self=this,earlyOut=ret;return obj.payload?1===obj.payload.headers.length&&"From"===obj.payload.headers[0].name?(obj.labelIds=["CHAT"].concat(obj.labelIds),void ret(obj)):void aseq(aif(function(){return-1!=obj.labelIds.indexOf("DRAFT")&&0!=obj.id.indexOf("draft_")},aseq(function(ret){self.setDraftId_(ret,obj)},function(ret,success){return success?void ret():(error("Could not find matching draft for "+obj.id),void earlyOut(null))})),function(ret){ret(obj)})(ret):void this.find(obj.id,{put:function(o){ret(o)},error:function(){error("Failed to find object."),ret(null)}})},onSelectData:function(ret,data,sink,fc){if(!sink||!sink.put)return void ret();var self=this,obj,earlyOut=ret,tmp;aseq(function(ret){self.postProcessObject(ret,fc.error.bind(fc),data)},function(ret,o){return"CHAT"===o.labelIds[0]?void ret():(fc.errorEvt||sink.put(o,null,fc),void ret())})(ret)},setDraftId_:function(ret,obj){var self=this;self.draftDao.where(EQ({partialEval:function(){return this},f:function(o){return o.message.id}},obj.id)).limit(1).select()(function(drafts){return 0===drafts.length?void ret(!1):(obj.messageId=drafts[0].message.id,obj.draftId=drafts[0].id,obj.id=obj.getHeader(obj.FOAM_MESSAGEID_HEADER)||"draft_"+obj.draftId,void ret(!0))})},sendDraft_:function(ret,draftId,obj,sink){var self=this;return obj.deleted?void ret():void aseq(function(ret){self.xhr.asend(ret,self.draftUrl+"/send",JSON.stringify({id:draftId}),"POST")},function(ret,response,xhr){return xhr.status<200||xhr.status>=300?(sink&&sink.error&&sink.error(["Could not send"]),void ret()):(self.lastClientVersion=Math.max(self.lastClientVersion,obj.clientVersion),obj=obj.deepClone(),obj.deleted=!0,sink&&sink.put&&sink.put(obj),void ret())})(ret)},saveDraft_:function(ret,draftId,obj,url,method,sink){var self=this;aseq(function(ret){var raw=obj.toRaw(),payload={id:draftId,message:{raw:raw.raw}},formatter={__proto__:JSONUtil.pretty,outputModel_:function(){}};self.xhr.asend(ret,self.draftUrl+url,formatter.stringify(payload),method)},function(ret,response,xhr){return xhr.status<200||xhr.status>=300?void(sink&&sink.error&&sink.error(["Error updating/creating draft.",url,method])):(self.lastClientVersion=Math.max(self.lastClientVersion,obj.clientVersion),void self.find("draft_"+response.id,{put:function(o){o.messageId=response.message.id,o.draftId=response.id,o.clientVersion=obj.clientVersion,ret(o)},error:function(){sink&&sink.error&&sink.error(["Error fetching created message."])}}))})(ret)},put:function(obj,sink){var self=this,jsonToObj,dstUrl,dstMethod;if(obj.setHeader(obj.FOAM_MESSAGEID_HEADER,obj.id),0===obj.id.indexOf("draft_"))var draftId=obj.draftId||obj.id.substring(6);aif(0===obj.id.indexOf("draft_"),aseq(function(ret){self.xhr.asend(ret,self.draftUrl+"/"+draftId+"?format=minimal")},function(ret,response,xhr){if(dstUrl="/"+draftId,dstMethod="PUT",404===xhr.status)dstUrl="",dstMethod="POST";else if(200!==xhr.status)return void(sink&&sink.error&&sink.error(["Can't fetch draft."]));self.saveDraft_(ret,draftId,obj,dstUrl,dstMethod,sink)},aif(obj.isSent,function(ret,draft){self.sendDraft_(ret,draft.draftId,draft,sink)},function(ret,draft){self.lastClientVersion=Math.max(self.lastClientVersion,obj.clientVersion),sink&&sink.put&&sink.put(obj)})),aseq(function(ret){self.xhr.asend(ret,self.messageUrl+"/"+obj.id+"?format=minimal")},function(ret,response,xhr){if(xhr.status<200||xhr.status>=300)return void(sink&&sink.error&&sink.error(["Error fetching message for comparison."]));var msg=self.jsonToObj(response),diff=msg.labelIds.diff(obj.labelIds);if(0==diff.added.length&&0==diff.removed.length)return void ret({},xhr);var payload={addLabelIds:diff.added,removeLabelIds:diff.removed};self.xhr.asend(ret,self.messageUrl+"/"+obj.id+"/modify",JSON.stringify(payload),"POST")},function(ret,response,xhr){return xhr.status<200||xhr.status>=300?void(sink&&sink.error&&sink.error(["Error modifying message."])):(obj=obj.deepClone(),response.labelIds&&(obj.labelIds=response.labelIds),self.lastClientVersion=Math.max(self.lastClientVersion,obj.clientVersion),void(sink&&sink.put&&sink.put(obj)))}))(function(){})},remove:function(obj,sink){sink&&sink.error&&sink.error("Unimplemented.")},find:function(key,sink){if(key.startsWith("draft_"))return void this.findDraft_(key,sink);var self=this;this.SUPER(key,{put:function(o){self.postProcessObject(function(obj){!obj&&sink?sink.error():sink&&sink.put&&sink.put(obj)},sink&&sink.error?sink.error.bind(sink):function(){},o)},error:function(args){return 404===args[1]?void(sink&&sink.put&&sink.put(self.model.create({id:key,deleted:!0}))):void(sink&&sink.error&&sink.error.apply(sink,arguments))}})},findDraft_:function(key,sink){var self=this;aseq(function(ret){self.xhr.asend(ret,self.draftUrl+"/"+key.substring(6)+"?format=full")},function(ret,response,xhr){if(xhr.status<200||xhr.status>=300||!response)return void(sink&&sink.error&&sink.error(["Error fetching draft",response,xhr]));var msg=self.jsonToObj(response.message);msg.id="draft_"+response.id,sink&&sink.put&&sink.put(msg),ret()})(function(){})},selectFromHistory_:function(sink,historyId){sink=sink||[];var fc=this.createFlowControl_(),self=this,future=afuture();return this.historyDao.where(GT(this.GMailHistory.ID,historyId)).select()(function(items){if(!items||!items.length)return void future.set(sink);var next=function(){var i=0,j=0,item=items[0];return function me(){return item?item.messages&&item.messages[j]?item.messages[j++]:(j=0,item=items[++i],me()):null}}(),current;awhile(function(){return current=next(),current&&!fc.stopped},aseq(function(ret){self.find(current.id,{put:ret,error:function(){sink.error&&sink.error.apply(sink,arguments),future.set(sink)}})},function(ret,obj){return fc.errorEvt?(sink.error&&sink.error(fc.errorEvt),void future.set(sink)):("CHAT"!=obj.labelIds[0]&&sink.put&&sink.put(obj,null,fc),void ret())}))(function(){sink.eof&&sink.eof(),future.set(sink)})}),future.get},select:function(sink,options){if(sink=sink||[].sink,MaxExpr.isInstance(sink)&&sink.arg1==this.model.CLIENT_VERSION)return sink.max=this.lastClientVersion,aconstant(sink);if(options&&options.query){var query=options&&options.query;if(GtExpr.isInstance(query)&&query.arg1==this.model.HISTORY_ID&&0!==query.arg2.f())return this.selectFromHistory_(sink,query.arg2.f())}return this.SUPER(sink,options)}}}),CLASS({model_:"Model","package":"com.google.mail",name:"GMailRestDAO",extendsModel:"foam.core.dao.RestDAO",requires:["com.google.mail.GMailHistory"],imports:["ajsonp"],properties:[{model_:"Property",name:"daoListeners_",hidden:!0,"transient":!0,factory:function(){return[]}},{model_:"Property",name:"model",label:"Type of data stored in this DAO."},{model_:"ArrayProperty",name:"paramProperties",help:"Properties that are handled as separate parameters rather than in the query.",subType:"Property"},{model_:"IntProperty",name:"batchSize",defaultValue:200},{model_:"IntProperty",name:"skipThreshold",defaultValue:1e3},{model_:"Property",name:"url",label:"REST API URL.",defaultValue:"https://www.googleapis.com/gmail/v1/users"},{model_:"Property",name:"modelName",defaultValueFn:function(){return this.model.plural}},{model_:"Property",name:"xhr","transient":!0,factory:function(){return this.X.XHR.create({responseType:"json"},this.Y)}},{model_:"Property",name:"ajsonp",hidden:!0,"transient":!0}],methods:{buildURL:function(){return this.url+"/me/"+this.modelName},buildSelectParams:function(sink,query){var params=[];return CountExpr.isInstance(sink)&&params.push("maxResults=1"),this.GMailHistory.isSubModel(this.model)&&GtExpr.isInstance(query)&&query.arg1===this.GMailHistory.ID&&params.push("startHistoryId="+query.arg2.f()),this.model.LABEL_IDS&&EqExpr.isInstance(query)&&this.model.LABEL_IDS==query.arg1&&params.push("labelIds="+encodeURIComponent(query.arg2)),params},select:function(sink,options){sink=sink||[],options&&!CountExpr.isInstance(sink)&&(sink=this.decorateSink_(sink,options)),options=options||{};var params=this.buildSelectParams(sink,options.query);options.limit&&!options.query&&params.push("maxResults="+options.limit);var url=this.buildURL(),fc=this.createFlowControl_(),self=this,future=afuture(),pageToken;return awhile(function(){return!fc.stopped&&!fc.errorEvt},aseq(function(ret){var p=pageToken?params.concat("pageToken="+pageToken):params;self.xhr.asend(ret,url+"?"+p.join("&"))},function(ret,data){if(!data||!data[self.modelName])return fc.error("No data"),void ret();CountExpr.isInstance(sink)&&(sink.count=data.resultSizeEstimate,fc.stop());var items=data[self.modelName],i=0;pageToken=data.nextPageToken,awhile(function(){return i<items.length},function(ret){return fc.stopped?(i=items.length,void ret()):fc.errorEvt?(sink.error&&sink.error(fc.errorEvt),i=items.length,void ret()):void self.onSelectData(ret,items[i++],sink,fc)})(ret)},function(ret){pageToken||fc.stop(),ret()}))(function(){sink.eof&&sink.eof(),future.set(sink)}),future.get},onSelectData:function(ret,data,sink,fc){sink.put&&sink.put(this.jsonToObj(data),null,fc),ret()},find:function(key,sink,options){options=options||{};var self=this,obj;aseq(function(ret){self.xhr.asend(ret,self.buildFindURL(key)+"?"+self.buildFindParams(options.urlParams).join("&"))},function(ret,response,xhr){return xhr.status<200||xhr.status>=300||!response?void(sink&&sink.error&sink.error(["Failed to find message.",xhr.status])):(obj=self.jsonToObj(response),sink&&sink.put&&sink.put(obj),void ret())})(function(){})},buildFindURL:function(key){return this.url+"/me/"+this.modelName+"/"+key},buildFindParams:function(urlParams){var params=urlParams||[];return params}}}),CLASS({model_:"Model","package":"com.google.mail",name:"GMailHistory",plural:"history",properties:[{model_:"StringProperty",name:"id",help:"The mailbox sequence ID."},{model_:"ReferenceArrayProperty",name:"messages",help:"The messages that changed in this history record.",subType:"Message",subKey:"ID"}]}),CLASS({model_:"Model","package":"foam.core.dao",name:"RestDAO",extendsModel:"AbstractDAO",imports:["ajsonp"],properties:[{model_:"Property",name:"model",label:"Type of data stored in this DAO."},{model_:"Property",name:"url",label:"REST API URL."},{model_:"ArrayProperty",name:"paramProperties",help:"Properties that are handled as separate parameters rather than in the query.",subType:"Property"},{model_:"IntProperty",name:"batchSize",defaultValue:200},{model_:"IntProperty",name:"skipThreshold",defaultValue:1e3}],methods:{jsonToObj:function(json){return this.model.create(json)},objToJson:function(obj){return JSONUtil.compact.stringify(obj)},buildURL:function(query){return this.url},buildFindURL:function(key){return this.url+"/"+key},buildPutURL:function(obj){return this.url},buildPutParams:function(obj){return[]},buildSelectParams:function(sink,query){return[]},put:function(value,sink){var self=this,extra={};this.ajsonp(this.buildPutURL(value),this.buildPutParams(value),"POST",this.objToJson(value,extra))(function(resp,status){var obj;return void 0!==status&&200!==status||!(obj=self.jsonToObj(resp,extra))?void(sink&&sink.error&&sink.error([resp,status])):(sink&&sink.put&&sink.put(obj),void self.notify_("put",[obj]))})},remove:function(query,sink){},select:function(sink,options){sink=sink||[].sink;var fut=afuture(),self=this,limit,skipped=0,index=0,fc=this.createFlowControl_(),extra={},params=[];if(options){index+=options.skip||0;var query=options.query.partialEval(),url;if(query){var origQuery=query;query=query.normalize();var outquery=[query,origQuery.deepClone()];params=this.buildSelectParams(sink,outquery),url=this.buildURL(outquery,extra),query=outquery[0],origQuery=outquery[1];var mql=query.toMQL();mql&&params.push("q="+encodeURIComponent(query.toMQL()))}else url=this.buildURL();if(options.order){var sort=options.order.toMQL();params.push("sort="+sort)}options.limit&&(limit=options.limit)}var finished=!1;return awhile(function(){return!finished},function(ret){var batch=self.batchSize;if(Number.isFinite(limit))var batch=Math.min(batch,limit);CountExpr.isInstance(sink)&&(batch=0);var myparams=params.slice();myparams.push("maxResults="+batch),myparams.push("startIndex="+index),self.ajsonp(url,myparams)(Movement.whenIdle(function(data){if(CountExpr.isInstance(sink))return sink.count=data.totalResults,finished=!0,void ret();var items=data&&data.items?data.items:[];0==items.length&&(finished=!0),index+=items.length;for(var i=0;i<items.length;i++){var item=self.jsonToObj(items[i],extra);if(!origQuery||origQuery.f(item)){if(Number.isFinite(limit)){if(0>=limit){finished=!0;break}limit--}if(fc.stopped){finished=!0;break}if(fc.errorEvt){sink.error&&sink.error(fc.errorEvt),finished=!0;break}sink&&sink.put&&sink.put(item,null,fc)}else skipped++}0>=limit&&(finished=!0),(!data||index>=data.totalResults)&&(finished=!0),skipped>=self.skipThreshold&&(finished=!0),ret()}))})(function(){sink&&sink.eof&&sink.eof(),fut.set(sink)}),fut.get},buildFindParams:function(key){return[]},find:function(key,sink){var self=this;this.ajsonp(this.buildFindURL(key),this.buildFindParams())(function(data,status){var deserialized;return 200===status&&(deserialized=self.jsonToObj(data))?void(sink&&sink.put&&sink.put(deserialized)):void(sink&&sink.error&&sink.error("Network error"))})}}}),CLASS({model_:"Model","package":"com.google.mail",name:"GMailDraft",plural:"drafts",properties:[{model_:"StringProperty",name:"id",help:"The immutable ID of the draft."},{model_:"Property",name:"message",subType:"Message",help:"The message content of the draft."}]}),CLASS({model_:"Model","package":"com.google.mail",name:"GMailToEMailDAO",extendsModel:"foam.core.dao.AbstractAdapterDAO",requires:["foam.lib.email.EMail","com.google.mail.FOAMGMailMessage","foam.util.Base64Encoder","foam.util.Base64Decoder","foam.util.encodings.IncrementalUtf8"],properties:[{model_:"ModelProperty",name:"model",defaultValueFn:function(){return this.EMail},type:"Model"}],methods:{adaptSink_:function(sink){return MaxExpr.isInstance(sink)&&sink.arg1==this.EMail.CLIENT_VERSION?MAX(this.FOAMGMailMessage.CLIENT_VERSION,sink.arg2):this.SUPER(sink)},init:function(args){this.SUPER(args);var identityMap=function(x){return x},toArrayMap=function(x){return x.split(",").map(function(x){return x.trim()})},fromArrayMap=function(x){return x.join(", ")},headersMap=[["Date","timestamp",identityMap,identityMap],["From","from",identityMap,identityMap],["To","to",identityMap,identityMap],["Cc","cc",toArrayMap,fromArrayMap],["Bcc","bcc",toArrayMap,fromArrayMap],["Reply-To","replyTo",toArrayMap,fromArrayMap],["Subject","subject",identityMap,identityMap]];this.writeHeaders=function(headers,obj){for(var i=0,mapping;mapping=headersMap[i];i++)obj.hasOwnProperty(mapping[1])&&(Array.isArray(obj[mapping[1]])&&0==obj[mapping[1]].length||headers.push({name:mapping[0],value:mapping[3](obj[mapping[1]])}))},this.readHeaders=function(headers,obj){for(var map={},i=0;i<headers.length;i++)map[headers[i].name]=headers[i].value;for(var i=0,mapping;mapping=headersMap[i];i++)map.hasOwnProperty(mapping[0])&&(obj[mapping[1]]=mapping[2](map[mapping[0]]))}},aToB:function(obj){var msg=this.FOAMGMailMessage.create({id:obj.id,labelIds:obj.labels,isSent:obj.messageSent,clientVersion:obj.clientVersion,snippet:obj.snippet,deleted:obj.deleted}),headers=[];headers.push({name:"MIME-Version",value:"1.0"}),headers.push({name:"Content-Type",value:"text/html; charset=UTF-8"}),this.writeHeaders(headers,obj);var payload={headers:headers,body:{size:obj.body.length,data:this.Base64Encoder.create({urlSafe:!0}).encode(new Uint8Array(stringtoutf8(obj.body)))}};return msg.payload=payload,msg},bToA:function(obj){var self=this,decode=function(str){var decoder=self.Base64Decoder.create({sink:self.IncrementalUtf8.create()});return decoder.put(str),decoder.eof(),decoder.sink.string},body="",plainBody,richBody;!function go(part){if("text/plain"===part.mimeType)plainBody=part;else if("text/html"===part.mimeType)richBody=part;else if(part.parts)for(var i=0;i<part.parts.length;i++)go(part.parts[i])}(obj.payload),richBody?body=decode(richBody.body.data):plainBody&&(body="<pre>"+decode(plainBody.body.data)+"</pre>");var args={id:obj.id,convId:obj.threadId,labels:obj.labelIds,serverVersion:obj.historyId,body:body,snippet:obj.snippet,deleted:obj.deleted};return this.readHeaders(obj.payload.headers||[],args),this.EMail.create(args)},adaptOptions_:function(options){var newoptions={};if(options){if(options.limit&&(newoptions.limit=options.limit),options.skip&&(newoptions.skip=options.skip),options.query){var query=options.query;EqExpr.isInstance(query)&&this.EMail.LABELS===query.arg1?newoptions.query=EQ(this.FOAMGMailMessage.LABEL_IDS,query.arg2):GtExpr.isInstance(query)&&query.arg1==this.EMail.SERVER_VERSION?newoptions.query=GT(this.FOAMGMailMessage.HISTORY_ID,query.arg2):MQLExpr.isInstance(query)&&(newoptions.query=query)}return newoptions}}}}),CLASS({model_:"Model","package":"foam.lib.email",name:"EMail",plural:"EMail",tableProperties:["from","subject","timestamp"],properties:[{model_:"StringProperty",name:"id",label:"Message ID",mode:"read-write",required:!0,hidden:!0,displayWidth:50,compareProperty:function(a,b){if(a.length!==b.length)return a.length<b.length?-1:1;for(var TABLE="0123456789abcdef",i=0;i<a.length;i++){var ia=TABLE.indexOf(a[i]),ib=TABLE.indexOf(b[i]);if(ia!==ib)return ib>ia?-1:1}return 0}},{model_:"StringProperty",name:"convId",label:"Conversation ID",mode:"read-write",hidden:!0,displayWidth:30},{model_:"DateProperty",name:"timestamp",label:"Date",aliases:["time","modified","t"],mode:"read-write",required:!0,displayHeight:1,factory:function(){return new Date},preSet:function(_,d){return"string"==typeof d||"number"==typeof d?new Date(d):d},tableWidth:"100",displayWidth:45,view:"foam.ui.TextFieldView"},{model_:"StringProperty",name:"from",shortName:"f",mode:"read-write",required:!0,displayWidth:90,factory:function(){return GLOBAL.user||""},tableFormatter:function(t){var ret;return ret=-1!=t.search("<.*>")?t.replace(/<.*>/,"").replace(/"/g,""):t.replace(/@.*/,""),ret.trim()},tableWidth:"120"},{model_:"StringArrayProperty",name:"to",shortName:"t",required:!0,tableFormatter:function(t){return t.replace(/"/g,"").replace(/<.*/,"")},displayWidth:90},{model_:"StringArrayProperty",name:"cc",required:!0,tableFormatter:function(t){return t.replace(/"/g,"").replace(/<.*/,"")},displayWidth:90},{model_:"StringArrayProperty",name:"bcc",required:!0,tableFormatter:function(t){return t.replace(/"/g,"").replace(/<.*/,"")},displayWidth:90},{model_:"StringArrayProperty",name:"replyTo"},{model_:"Property",name:"subject",type:"String",shortName:"s",mode:"read-write",required:!0,displayWidth:100,view:"foam.ui.TextFieldView",tableWidth:"45%"},{model_:"StringArrayProperty",name:"labels",postSet:function(_,a){if(a)for(var i=0;i<a.length;i++)a[i]=a[i].intern()},help:"Email labels."},{model_:"Property",name:"attachments",label:"Attachments",tableLabel:"@",type:"Array[Attachment]",subType:"Attachment",view:"ArrayView",factory:function(){return[]},tableFormatter:function(a){return a.length?a.length:""},tableWidth:"20",help:"Email attachments."},{model_:"StringProperty",name:"body",label:"",shortName:"b",displayWidth:70,summaryFormatter:function(t){return'<div class="messageBody">'+t.replace(/\n/g,"<br/>")+"</div>"},help:"Email message body.",displayHeight:20,view:"foam.ui.TextFieldView"},{model_:"foam.lib.email.EMailLabelProperty",name:"starred"},{model_:"foam.lib.email.EMailLabelProperty",name:"unread"},{model_:"foam.lib.email.EMailLabelProperty",name:"isDraft"},{model_:"foam.lib.email.EMailLabelProperty",name:"inInbox"},{model_:"StringProperty",name:"snippet",mode:"read-only",defaultValueFn:function(){return this.body.substr(0,100)}},{model_:"BooleanProperty",name:"messageSent",help:"True if the user has marked this message to be sent.",defaultValue:!1},{model_:"BooleanProperty",name:"deleted"},{model_:"IntProperty",name:"clientVersion"},{model_:"IntProperty",name:"serverVersion"},{model_:"Property",name:"type",hidden:!0,defaultValue:"EMail"},{model_:"Property",name:"iconURL",view:"foam.ui.ImageView",defaultValue:"images/email.png"}],actions:[{model_:"foam.lib.email.EMailMutationAction",name:"send",help:"Send the email.",isAvailable:function(){return this.isDraft},isEnabled:function(){return!this.messageSent},backOnComplete:!0,action:function(){this.messageSent=!0}},{model_:"Action",name:"reply",help:"Reply to an email.",action:function(X){var replyMail=X.foam.lib.email.EMail.create({to:[this.from],subject:this.subject,body:this.body,labels:["DRAFT"]});X.openComposeView(X,replyMail)}},{model_:"Action",name:"replyAll",help:"Reply to all recipients of an email.",action:function(X){for(var replyMail=X.foam.lib.email.EMail.create({to:[this.from],cc:this.cc,subject:"Re.: "+this.subject,body:this.body,labels:["DRAFT"]}),i=0;i<this.to;i++)replyMail.to.push(this.to[i]);X.openComposeView(X,replyMail)}},{model_:"Action",name:"forward",help:"Forward an email.",action:function(X){var forwardedMail=X.foam.lib.email.EMail.create({subject:this.subject,body:this.body,labels:["DRAFT"]});X.openComposeView(X,forwardedMail)}},{model_:"foam.lib.email.EMailMutationAction",name:"star",help:"Star an email.",action:function(){this.toggleLabel("STARRED")}},{model_:"foam.lib.email.EMailMutationAction",name:"archive",help:"Archive an email.",isAvailable:function(){return this.hasLabel("INBOX")},action:function(){this.removeLabel("INBOX")}},{model_:"foam.lib.email.EMailMutationAction",name:"moveToInbox",help:"Un-archive an email.",isAvailable:function(){return!this.hasLabel("INBOX")
},action:function(){this.addLabel("INBOX"),this.removeLabel("SPAM"),this.removeLabel("TRASH")}},{model_:"foam.lib.email.EMailMutationAction",name:"spam",help:"Report an email as SPAM.",isAvailable:function(){return!this.hasLabel("SPAM")},action:function(){this.removeLabel("INBOX"),this.addLabel("SPAM")}},{model_:"foam.lib.email.EMailMutationAction",name:"trash",help:"Move an email to the trash.",isAvailable:function(){return!this.hasLabel("TRASH")},action:function(){this.removeLabel("INBOX"),this.addLabel("TRASH")}},{model_:"foam.lib.email.EMailMutationAction",name:"markRead",help:"Mark an email as read.",isAvailable:function(){return this.hasLabel("UNREAD")},action:function(){this.removeLabel("UNREAD")}},{model_:"foam.lib.email.EMailMutationAction",name:"markUnread",help:"Mark an email as unread.",isAvailable:function(){return!this.hasLabel("UNREAD")},action:function(){this.addLabel("UNREAD")}}],methods:{updateLabelByName:function(id){var self=this;EMailLabelDAO.find(EQ(EMailLabel.DISPLAY_NAME,id),{put:function(label){var mail=self.clone();mail.toggleLabel(label.id),EMailDAO.put(mail)}})},hasLabel:function(l){return-1!=this.labels.indexOf(l)},toggleLabel:function(l){this.hasLabel(l)?this.removeLabel(l):this.addLabel(l)},addLabel:function(l){this.labels=this.labels.deleteF(l).pushF(l)},removeLabel:function(l){this.labels=this.labels.deleteF(l)},atoMime:function(ret){for(var inline=[],attachments=[],i=0;i<this.attachments.length;i++)this.attachments[i].inline?inline.push(this.attachments[i]):attachments.push(this.attachments[i]);var newBoundary=function(){var boundary=Math.floor(1e4*Math.random());return function(){return(boundary+=1).toString(16)}}(),body="Content-Type: text/html; charset=UTF-8\r\n\r\n",fragment=new DocumentFragment;fragment.appendChild(document.createElement("body")),fragment.firstChild.innerHTML=this.body;for(var images=fragment.querySelectorAll("img"),i=0;i<images.length;i++)images[i].id&&(images[i].src="cid:"+images[i].id,images[i].removeAttribute("id"));body+=fragment.firstChild.innerHTML+"\r\n";var i,self=this,addAttachments=function(attachments,inline){return aseq(function(ret){boundary=newBoundary(),body="Content-Type: multipart/"+(inline?"related":"mixed")+"; boundary="+boundary+"\r\n\r\n--"+boundary+"\r\n"+body+"\r\n--"+boundary,i=0,ret()},awhile(function(){return i<attachments.length},aseq(function(ret){var att=attachments[i];i++,att.atoMime(ret)},function(ret,data){body+="\r\n"+data,body+="--"+boundary,ret()})),function(ret){body+="--",ret()})};aseq(aif(inline.length>0,addAttachments(inline,!0)),aif(attachments.length>0,addAttachments(attachments,!1)))(function(){body="From: "+self.from+"\r\nTo: "+self.to.join(", ")+"\r\n"+(self.cc.length?"Cc: "+self.cc.join(", ")+"\r\n":"")+(self.bcc.length?"Bcc: "+self.bcc.join(", ")+"\r\n":"")+"Subject: "+self.subject+"\r\n"+body,ret(body)})}}}),CLASS({model_:"Model","package":"foam.lib.email",name:"EMailLabelProperty",extendsModel:"BooleanProperty",properties:[{model_:"Property",name:"setter",defaultValue:function(v,name){var old=this.v,label=this.model_[constantize(name)].labelName;v?this.addLabel(label):this.removeLabel(label),this.propertyChange_(this.propertyTopic(name),old,v)}},{model_:"Property",name:"getter",defaultValue:function(name){var label=this.model_[constantize(name)].labelName;return this.hasLabel(label)}}]}),CLASS({model_:"Model","package":"foam.lib.email",name:"EMailMutationAction",extendsModel:"Action",properties:[{model_:"Property",name:"name",type:"String",required:!0,displayWidth:30,displayHeight:1,defaultValue:"",help:"The coding identifier for the action."},{model_:"Property",name:"label",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.name.labelize()},help:"The display label for the action."},{model_:"Property",name:"speechLabel",type:"String",displayWidth:70,displayHeight:1,defaultValueFn:function(){return this.label},help:"The speech label for the action."},{model_:"Property",name:"help",label:"Help Text",type:"String",displayWidth:70,displayHeight:6,defaultValue:"",help:"Help text associated with the action."},{model_:"DocumentationProperty",name:"documentation",getter:function(){var doc=this.instance_.documentation;return!doc||"undefined"==typeof Documentation||!Documentation||doc.model_&&doc.model_.getPrototype&&Documentation.isInstance(doc)||(this.instance_.documentation=Documentation.create(doc.body?doc:{body:doc})),this.instance_.documentation}},{model_:"Property",name:"default",type:"Boolean",view:"BooleanView",defaultValue:!1,help:"Indicates if this is the default action."},{model_:"FunctionProperty",name:"isAvailable",label:"Available",displayHeight:3,help:"Function to determine if action is available.",displayWidth:70,defaultValue:function(){return!0}},{model_:"FunctionProperty",name:"isEnabled",label:"Enabled",displayHeight:3,help:"Function to determine if action is enabled.",displayWidth:70,defaultValue:function(){return!0}},{model_:"FunctionProperty",name:"labelFn",label:"Label Function",help:"Function to determine label. Defaults to 'this.label'.",defaultValue:function(action){return action.label}},{model_:"Property",name:"iconUrl",type:"String",defaultValue:"",help:"Provides a url for an icon to render for this action"},{model_:"Property",name:"showLabel",type:"String",defaultValue:!0,help:"Property indicating whether the label should be rendered alongside the icon"},{model_:"Property",name:"children",type:"Array",subType:"Action",view:"ArrayView",factory:function(){return[]},help:"Child actions of this action."},{model_:"Property",name:"parent",type:"String",help:"The parent action of this action"},{model_:"StringArrayProperty",name:"keyboardShortcuts"},{model_:"Property",name:"translationHint",label:"Description for Translation",type:"String",defaultValue:""},{model_:"BooleanProperty",name:"backOnComplete",defaultValue:!1},{model_:"FunctionProperty",name:"action",displayHeight:20,preSet:function(_,a){var f=function(X,action){var obj=this;a.apply(obj,arguments);var self=this,sink=action.backOnComplete?{put:function(){X.stack.back()},error:function(){X.stack.back()}}:void 0;X.EMailDAO&&X.EMailDAO.put(obj,sink)};return f.toString=function(){return a.toString()},f},help:"Function to implement action.",displayWidth:80,defaultValue:""}]}),CLASS({model_:"Model","package":"foam.core.dao",name:"AbstractAdapterDAO",extendsModel:"ProxyDAO",methods:{adaptKey_:function(key){return key},put:function(obj,sink){obj=this.aToB(obj),this.SUPER(obj,sink)},remove:function(obj,sink){obj=this.aToB(obj),this.SUPER(obj,sink)},adaptSink_:function(sink){var self=this;return{put:function(o,s,fc){o=self.bToA(o),sink&&sink.put&&sink.put(o,s,fc)},eof:function(){sink&&sink.eof&&sink.eof()}}},select:function(sink,options){sink=this.decorateSink_(sink,options);var mysink=this.adaptSink_(sink);options=this.adaptOptions_(options);var future=afuture();return this.SUPER(mysink,options)(function(){future.set(sink)}),future.get},find:function(key,sink){var self=this;this.SUPER(this.adaptKey_(key),{put:function(o){sink&&sink.put&&sink.put(self.bToA(o))},error:function(){sink&&sink.error&&sink.error.apply(sink,arguments)}})},removeAll:function(sink,options){options=this.adaptOptions_(options);var self=this,mysink={remove:function(o,sink,fc){sink&&sink.remove&&sink.remove(self.bToA(o),sink,fc)},error:function(){sink&&sink.error&&sink.error.apply(sink,arguments)}};this.SUPER(mysink,options)},listen:function(s,options){if(options)var myoptions=this.adaptOptions_(options);var self=this,mysink={$UID:s.$UID,put:function(o,sink,fc){s.put&&s.put(o&&self.bToA(o),sink,fc)},remove:function(o,sink,fc){s.remove&&s.remove(self.bToA(o),sink,fc)},error:function(){s.error&&s.error.apply(s,arguments)}};s=this.decorateSink_(s,options,!0),this.SUPER(mysink,myoptions)}},help:"An abstract decorator for adapting a DAO of one data type to another data type.  Extend this class and implement aToB() and bToA()."}),CLASS({model_:"Model","package":"com.google.mail",name:"Sync",extendsModel:"foam.core.dao.Sync",requires:["foam.lib.email.EMail"],methods:{purge:function(ret,remoteLocal){var self=this;this.SUPER(function(purged){this.local.where(AND(LTE(this.localVersionProp,remoteLocal),EQ(this.EMail.MESSAGE_SENT,!0),EQ(this.EMail.LABELS,"DRAFT"))).removeAll(purged)(ret)}.bind(this),remoteLocal)}}}),CLASS({model_:"Model","package":"foam.core.dao",name:"Sync",properties:[{model_:"Property",name:"local",hidden:!0},{model_:"Property",name:"remote",hidden:!0},{model_:"Property",name:"localVersionProp",hidden:!0},{model_:"Property",name:"remoteVersionProp",hidden:!0},{model_:"Property",name:"deletedProp",hidden:!0},{model_:"IntProperty",name:"syncs"},{model_:"BooleanProperty",name:"syncing",defaultValue:!1},{model_:"IntProperty",name:"initialSyncWindow",help:"Number of objects to sync from client if client store is empty.  0 to sync them all",defaultValue:0},{model_:"IntProperty",name:"syncedFromServer"},{model_:"IntProperty",name:"syncedFromClient"},{model_:"IntProperty",name:"purgedFromClient"}],actions:[{model_:"Action",name:"sync",isEnabled:function(){return!this.syncing},action:function(){this.syncing=!0,this.syncs+=1;var self=this;aseq(apar(aseq(function(ret){self.local.select(MAX(self.remoteVersionProp))(function(m){ret(m&&m.max||0)})},function(ret,localRemote){var remote=self.remote;0==localRemote&&self.initialSyncWindow>0&&(remote=remote.limit(self.initialSyncWindow)),remote=remote.where(GT(self.remoteVersionProp,localRemote)),remote.select(SEQ(self.local,COUNT()))(ret)}),aseq(function(ret){self.remote.select(MAX(self.localVersionProp))(function(m){ret(m&&m.max||0)})},apar(function(ret,remoteLocal){var local=self.local;local=local.where(GT(self.localVersionProp,remoteLocal)),local.select(SEQ(self.remote,COUNT()))(ret)},self.purge.bind(self)))),function(ret,downstream,upstream,purged){self.syncedFromServer+=downstream.args[1].count,self.syncedFromClient+=upstream.args[1].count,self.purgedFromClient-=purged.count,ret()})(function(){self.syncing=!1})}}],methods:{purge:function(ret,remoteLocal){var local=this.local;local=local.where(AND(LTE(this.localVersionProp,remoteLocal),EQ(this.deletedProp,!0))),local.removeAll(COUNT())(ret)}}}),CLASS({model_:"Model","package":"com.google.mail",name:"SyncDecorator",extendsModel:"ProxyDAO",requires:["com.google.mail.FOAMGMailMessage"],methods:{put:function(obj,sink){obj.deleted&&this.delegate.where(EQ(this.FOAMGMailMessage.MESSAGE_ID,obj.id)).update(SET(this.FOAMGMailMessage.DELETED,!0)),this.SUPER(obj,sink)}}}),CLASS({model_:"Model","package":"foam.core.dao",name:"MergeDAO",extendsModel:"ProxyDAO",properties:[{model_:"FunctionProperty",name:"mergeStrategy",required:!0}],methods:{put:function(obj,sink){var self=this;this.delegate.find(obj.id,{put:function(oldValue){aseq(function(ret){self.mergeStrategy(ret,oldValue,obj)},function(ret,obj){self.delegate.put(obj,sink)})()},error:function(){self.delegate.put(obj,sink)}})}}}),CLASS({model_:"Model","package":"foam.core.dao",name:"PropertyOffloadDAO",extendsModel:"ProxyDAO",properties:[{model_:"Property",name:"property"},{model_:"Property",name:"offloadDAO"},{model_:"BooleanProperty",name:"loadOnSelect"}],methods:{put:function(obj,sink){if(obj.hasOwnProperty(this.property.name)){var offload=this.model.create({id:obj.id});offload[this.property.name]=this.property.f(obj),obj.clearProperty(this.property.name),this.offloadDAO.put(offload)}this.delegate.put(obj,sink)},select:function(sink,options){if(!this.loadOnSelect)return this.delegate.select(sink,options);var mysink=this.offloadSink(sink);return this.delegate.select(mysink,options)},offloadSink:function(sink){var self=this;return{__proto__:sink,put:function(obj){sink.put&&sink.put.apply(sink,arguments),self.offloadDAO.find(obj.id,{put:function(offload){offload[self.property.name]&&(obj[self.property.name]=offload[self.property.name])}})}}},find:function(id,sink){this.delegate.find(id,this.offloadSink(sink))}}}),CLASS({model_:"Model","package":"foam.core.dao",name:"StripPropertiesDAO",extendsModel:"ProxyDAO",properties:[{model_:"StringArrayProperty",name:"propertyNames"}],methods:{process_:function(obj){obj=obj.clone();for(var i=0;i<this.propertyNames.length;i++)obj.clearProperty(this.propertyNames[i]);return obj},select:function(sink,options){sink=sink||[].sink;var self=this,future=afuture();return this.SUPER({put:function(obj,_,fc){sink.put&&sink.put(self.process_(obj),null,fc)},error:function(){sink.error&&sink.error.apply(sink,arguments)},eof:function(){sink.eof&&sink.eof()}},options)(function(){future.set(sink)}),future.get}}}),CLASS({model_:"Model","package":"foam.core.dao",name:"CloningDAO",extendsModel:"ProxyDAO",properties:[{model_:"BooleanProperty",name:"onSelect",defaultValue:!1}],methods:{select:function(sink,options){if(!this.onSelect)return this.SUPER(sink,options);sink=sink||[].sink;var future=afuture();return this.delegate.select({put:function(obj,s,fc){obj=obj.deepClone(),sink.put&&sink.put(obj,s,fc)},error:function(){sink.error&&sink.error.apply(sink,argumentS)},eof:function(){sink.eof&&sink.eof(),future.set(sink)}},options),future.get},find:function(key,sink){return this.SUPER(key,{put:function(o){var clone=o.deepClone();sink&&sink.put&&sink.put(clone)},error:sink&&sink.error&&sink.error.bind(sink)})}}}),CLASS({model_:"Model","package":"foam.core.dao",name:"VersionNoDAO",extendsModel:"ProxyDAO",properties:[{model_:"Property",name:"property",type:"Property",required:!0,hidden:!0,"transient":!0},{model_:"IntProperty",name:"version",defaultValue:1}],methods:{init:function(){this.SUPER();var future=afuture();this.WHEN_READY=future.get,this.delegate.select(MAX(this.property))(function(max){max.max&&(this.version=max.max+1),future.set(!0)}.bind(this))},put:function(obj,sink){this.WHEN_READY(function(){var val=this.property.f(obj);obj[this.property.name]=this.version++,this.delegate.put(obj,sink)}.bind(this))}}}),CLASS({model_:"Model","package":"com.google.mail",name:"EMailExtensionsAgent",requires:["foam.lib.email.EMail"],methods:{execute:function(){var self=this;Object_forEach({ARCHIVE:"archive",TRASH:"delete",REPLY:"reply",REPLY_ALL:"reply_all",SPAM:"report",FORWARD:"forward",STAR:"star",MOVE_TO_INBOX:"inbox",SEND:"send",MARK_UNREAD:"markunread"},function(image,name){self.EMail[name].copyFrom({iconUrl:"icons/ic_"+image+"_black_24dp.png",label:""})})}}}),CLASS({model_:"Model","package":"com.google.mail",name:"EMailView",extendsModel:"foam.ui.UpdateDetailView",requires:["foam.ui.WebView","foam.ui.md.MonogramStringView","foam.ui.RelativeDateTimeFieldView","foam.ui.ImageBooleanView","foam.ui.ActionSheetView","foam.ui.StringArrayView"],actions:[{model_:"Action",name:"back",label:"",isAvailable:function(){return!0},iconUrl:"images/ic_arrow_back_24dp.png"},{model_:"Action",name:"moreActions",label:"",isEnabled:function(){return!0},iconUrl:"icons/ic_more_horiz_white_24dp.png",action:function(){var actionSheet=this.ActionSheetView.create({data:this.data,actions:this.data.model_.actions},this.Y);this.X.stack.slideView(actionSheet)}}],templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .actionButtonCView-moreActions {\n        margin-right: 10px;\n      }\n    "),out.toString()}},{model_:"Template",name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      "),this.destroy(),out('\n      <div id="',this.id,'" class="email-view">\n        <div class="header">\n          ',self.createTemplateView("back",{radius:22,className:"backButton"}),"\n          ",self.createTemplateView("subject",{mode:"read-only",className:"subject"}),"\n          ",self.createTemplateView("archive",{iconUrl:"icons/ic_archive_white_24dp.png"}),"\n          ",self.createTemplateView("moveToInbox",{iconUrl:"icons/ic_inbox_white_24dp.png"}),"\n          ",self.createTemplateView("trash",{iconUrl:"icons/ic_delete_white_24dp.png"}),"\n          ",self.createTemplateView("moreActions"),'\n        </div>\n        <div class="content">\n          <div style="display: flex; display: -webkit-flex">\n            ',self.createTemplateView("from",{model_:"foam.ui.md.MonogramStringView"}),"\n            <div style='flex: 1; -webkit-flex: 1'>\n              ",self.createTemplateView("from",{mode:"read-only",className:"from",escapeHTML:!0}),"\n              <div class='details'>\n                ",self.createTemplateView("to",{mode:"read-only"}),"\n                ",self.createTemplateView("cc",{mode:"read-only"}),"\n                <br>\n                ",self.createTemplateView("timestamp",{model_:"foam.ui.RelativeDateTimeFieldView",mode:"read-only",className:"timestamp"}),"\n              </div>\n            </div>\n            ",self.createTemplateView("starred",{model_:"foam.ui.ImageBooleanView",className:"actionButton",trueImage:"images/ic_star_24dp.png",falseImage:"images/ic_star_outline_24dp.png"}),"\n          </div>\n          ",self.createTemplateView("body",{model_:"foam.ui.WebView",className:"body"}),"\n        </div>\n      </div>\n    "),out.toString()}}]}),CLASS({model_:"Model","package":"foam.ui",name:"WebView",extendsModel:"foam.ui.SimpleView",imports:["window"],properties:[{model_:"Property",name:"data"},{model_:"Property",name:"intervalId"}],methods:{init:function(){this.SUPER(),this.data$.addListener(function(){this.$.outerHTML=this.toHTML(),this.initHTML()}.bind(this))},toHTML:function(){var id=this.id;return'<iframe id="'+id+'"></iframe>'},initHTML:function(){this.SUPER(),this.$.contentDocument.write(this.data),this.intervalId=this.window.setInterval(this.onResize,500),this.onResize()},destroy:function(){this.window.clearInterval(this.intervalId)}},listeners:[{model_:"Method",name:"onResize",code:function(){return this.$?void(this.$.contentDocument.documentElement&&(this.$.style.height=this.$.contentDocument.documentElement.offsetHeight)):void this.window.clearInterval(this.intervalId)},isMerged:500}],help:"A view that renders the HTML given to it."}),CLASS({model_:"Model","package":"foam.ui",name:"ActionSheetView",extendsModel:"foam.ui.View",traits:["foam.ui.layout.PositionedDOMViewTrait"],properties:[{model_:"Property",name:"actions"},{model_:"Property",name:"data"},{model_:"Property",name:"className",defaultValue:"actionSheet"},{model_:"Property",name:"preferredWidth",defaultValue:200}],templates:[{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);out("\n      ");for(var i=0,action;action=this.actions[i];i++){var view=this.createActionView(action);this.addDataChild(view),out(view)}return out("\n    "),out.toString()}},{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .actionSheet {\n        background: white;\n      }\n    "),out.toString()}}],help:"A controller that shows a list of actions."}),CLASS({model_:"Model","package":"foam.ui",name:"StringArrayView",extendsModel:"foam.ui.TextFieldView",methods:{findCurrentValues:function(){for(var start=this.$.selectionStart,value=this.$.value,values=value.split(","),i=0,sum=0;sum+values[i].length<start;)sum+=values[i].length+1,i++;return{values:values,i:i}},setValues:function(values,index){this.domValue.set(this.valueToText(values)+","),this.data=this.textToValue(this.domValue.get());for(var isLast=values.length-1===index,selection=0,i=0;index>=i;i++)selection+=values[i].length+1;this.$.setSelectionRange(selection,selection),isLast&&this.X.setTimeout(function(){this.autocompleteView.autocomplete("")}.bind(this),0)},onAutocomplete:function(data){var current=this.findCurrentValues();current.values[current.i]=data,this.setValues(current.values,current.i)},bindAutocompleteEvents:function(view){function onInput(){var values=self.findCurrentValues();view.autocomplete(values.values[values.i])}var self=this;this.$.addEventListener("input",onInput),this.$.addEventListener("focus",onInput),this.$.addEventListener("blur",function(){view.publish("blur")})},textToValue:function(text){return""===text?[]:text.replace(/\s/g,"").split(",")},valueToText:function(value){return value?value.toString():""}}}),CLASS({model_:"Model","package":"foam.ui",name:"UpdateDetailView",extendsModel:"foam.ui.DetailView",imports:["DAO as dao","stack"],properties:[{model_:"Property",name:"rawData",postSet:function(old,nu){old&&old.removeListener(this.rawUpdate),nu&&nu.addListener(this.rawUpdate)}},{model_:"Property",name:"originalData"},{model_:"Property",name:"data",preSet:function(_,v){return v?(this.rawData=v,v.deepClone()):void 0},postSet:function(_,data){data&&(this.originalData=data.deepClone(),data&&data.model_&&(this.model=data.model_),data.subscribe(["property"],function(){this.version++,this.rawData=""}.bind(this)))}},{model_:"Property",name:"view"},{model_:"IntProperty",name:"version"}],actions:[{model_:"Action",name:"save",help:"Save updates.",isAvailable:function(){return this.version,!this.originalData.equals(this.data)},action:function(){var self=this,obj=this.data;this.stack.back(),this.dao.put(obj,{put:function(){console.log("Saving: ",obj.toJSON()),self.originalData.copyFrom(obj)},error:function(){console.error("Error saving",arguments)}})}},{model_:"Action",name:"cancel",help:"Cancel update.",isAvailable:function(){return this.version,!this.originalData.equals(this.data)},action:function(){this.stack.back()}},{model_:"Action",name:"back",isAvailable:function(){return this.version,this.originalData.equals(this.data)},action:function(){this.stack.back()}},{model_:"Action",name:"reset",isAvailable:function(){return this.version,!this.originalData.equals(this.data)},action:function(){this.data.copyFrom(this.originalData)}}],listeners:[{model_:"Method",name:"rawUpdate",code:function(){this.data=this.rawData}}]}),CLASS({model_:"Model","package":"com.google.mail",name:"FOAMGMailLabel",extendsModel:"com.google.mail.GMailLabel",properties:[{model_:"StringProperty",name:"id",help:"The immutable ID of the label."},{model_:"StringProperty",name:"labelListVisibility",help:"The visibility of the label in the label list in the Gmail web interface."},{model_:"StringProperty",name:"messageListVisibility",help:"The visibility of the label in the message list in the Gmail web interface."},{model_:"StringProperty",name:"type",help:"The owner type for the label. User labels are created by the user and can be modified and deleted by the user and can be applied to any message or thread. System labels are internally created and cannot be added, modified, or deleted. System labels may be able to be applied to or removed from messages and threads under some circumstances but this is not guaranteed. For example, users can apply and remove the INBOX and UNREAD labels from messages and threads, but cannot apply or remove the DRAFTS or SENT labels from messages or threads."},{model_:"StringProperty",name:"name",postSet:function(_,nu){"system"===this.type&&this.LABELS[nu]&&(this.label=this.LABELS[nu])},help:"The display name of the label."},{model_:"Property",name:"label",defaultValueFn:function(){return this.name}},{model_:"Property",name:"iconUrl",view:"foam.ui.ImageView",defaultValueFn:function(){return this.ICONS[this.name]?this.ICONS[this.name]:"icons/ic_label_black_24dp.png"}}],constants:[{model_:"Constant",name:"LABELS",value:{INBOX:"Inbox",STARRED:"Starred",DRAFT:"Drafts",SENT:"Sent",SPAM:"Spam",TRASH:"Trash",CATEGORY_FORUMS:"Forums",CATEGORY_PERSONAL:"Personal",CATEGORY_PROMOTIONS:"Promotions",CATEGORY_SOCIAL:"Social",CATEGORY_UPDATES:"Updates",IMPORTANT:"Priority Inbox"}},{model_:"Constant",name:"ICONS",value:{INBOX:"icons/ic_inbox_black_24dp.png",STARRED:"icons/ic_star_black_24dp.png",DRAFT:"icons/ic_drafts_black_24dp.png",SENT:"icons/ic_send_black_24dp.png",SPAM:"icons/ic_report_black_24dp.png",TRASH:"icons/ic_delete_black_24dp.png",IMPORTANT:"icons/ic_priority_inbox_black_24dp.png"}}]}),CLASS({model_:"Model","package":"com.google.mail",name:"GMailLabel",plural:"labels",properties:[{model_:"StringProperty",name:"id",help:"The immutable ID of the label."},{model_:"StringProperty",name:"labelListVisibility",help:"The visibility of the label in the label list in the Gmail web interface."},{model_:"StringProperty",name:"messageListVisibility",help:"The visibility of the label in the message list in the Gmail web interface."},{model_:"StringProperty",name:"name",help:"The display name of the label."},{model_:"StringProperty",name:"type",help:"The owner type for the label. User labels are created by the user and can be modified and deleted by the user and can be applied to any message or thread. System labels are internally created and cannot be added, modified, or deleted. System labels may be able to be applied to or removed from messages and threads under some circumstances but this is not guaranteed. For example, users can apply and remove the INBOX and UNREAD labels from messages and threads, but cannot apply or remove the DRAFTS or SENT labels from messages or threads."}]}),CLASS({model_:"Model","package":"com.google.mail",name:"GMailUserInfo",properties:[{model_:"Property",name:"email"},{model_:"Property",name:"name"},{model_:"Property",name:"avatarUrl"}],methods:{fromJSON:function(obj){this.email=obj.email,this.name=obj.name,this.avatarUrl=obj.picture+"?sz=50"}}}),CLASS({model_:"Model","package":"com.google.mail",name:"MenuView",extendsModel:"foam.ui.View",requires:["com.google.mail.MenuLabelCitationView","com.google.mail.FOAMGMailLabel","com.google.mail.ProfileView","foam.lib.email.EMail"],imports:["profile$","EMailDAO"],exports:["counts"],traits:["foam.ui.layout.PositionedDOMViewTrait"],properties:[{model_:"Property",name:"topSystemLabelDAO",view:{factory_:"foam.ui.DAOListView",rowView:"com.google.mail.MenuLabelCitationView"}},{model_:"Property",name:"bottomSystemLabelDAO",view:{factory_:"foam.ui.DAOListView",rowView:"com.google.mail.MenuLabelCitationView"}},{model_:"Property",name:"userLabelDAO",view:{factory_:"foam.ui.DAOListView",rowView:"com.google.mail.MenuLabelCitationView"}},{model_:"Property",name:"preferredWidth",defaultValue:280},{model_:"Property",name:"counts",factory:function(){var sink=GROUP_BY(this.EMail.LABELS,COUNT());return this.EMailDAO.select(sink),sink}}],templates:[{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('\n      <div class="menuView">\n        <div class="menuHeader">\n          ',this.ProfileView.create({data$:this.profile$}),"\n        </div>\n        ",self.createTemplateView("topSystemLabelDAO"),"\n        <hr>\n        ",self.createTemplateView("bottomSystemLabelDAO"),"\n        <hr>\n        ",this.MenuLabelCitationView.create({data:this.FOAMGMailLabel.create({id:"All Mail",name:"All Mail"})}),"\n        ",self.createTemplateView("userLabelDAO"),"\n      </div>\n    "),out.toString()}},{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .menuView {\n        height: 100%;\n        display: block;\n        overflow-y: auto;\n        background: white;\n      }\n\n      .menuHeader {\n        background: #db4437;\n        box-shadow: 0 3px 6px #888;\n        color: white;\n        padding: 10px 0 8px 15px;\n      }\n      .menuHeader:hover {\n        background: #db4437 !important;\n      }\n\n      .menuHeader img {\n        border-radius: 50%;\n        margin-bottom: 15px;\n      }\n\n      .menuHeader .name {\n        font-weight: bold;\n      }\n\n      .menuView div:hover {\n        background: #e0e0e0;\n      }\n   "),out.toString()}}]}),CLASS({model_:"Model","package":"com.google.mail",name:"MenuLabelCitationView",extendsModel:"foam.ui.DetailView",requires:["SimpleValue"],imports:["counts","controller"],properties:[{model_:"Property",name:"count",view:{factory_:"foam.ui.TextFieldView",mode:"read-only",extraClassName:"count"}}],methods:{init:function(){this.SUPER(),this.counts.groups[this.data.name]?this.bindGroup():this.bindCounts()},bindCounts:function(){this.counts.addListener(this.bindGroup)}},listeners:[{model_:"Method",name:"bindGroup",code:function(){this.counts.groups[this.data.name]&&(this.counts.removeListener(this.bindGroup),this.counts.groups[this.data.name].addListener(this.updateCount),this.updateCount())}},{model_:"Method",name:"updateCount",code:function(){this.counts.groups[this.data.name]&&(this.count=this.counts.groups[this.data.name].count)}}],templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .label-row {\n        height: 42px;\n        line-height: 42px;\n        padding-left: 15px;\n        display: flex;\n        align-items: center;\n      }\n      .label-row img {\n        height: 24px;\n        width: 24px;\n        opacity: 0.6;\n        margin-right: 25px;\n        flex-grow: 0;\n        flex-shrink: 0;\n      }\n      .label-row .label {\n        flex-grow: 1;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n      }\n      .label-row .count {\n        flex-grow: 0;\n        flex-shrink: 0;\n        margin-right: 10px;\n        text-align: center;\n        text-align: right;\n        width: 40px;\n      }\n    "),out.toString()}},{model_:"Template",name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('\n      <div id="',self.id,'" class="label-row">\n        ',self.createTemplateView("iconUrl"),"\n        ",self.createTemplateView("label",{mode:"read-only",extraClassName:"label"}),"\n        ",self.createTemplateView("count"),"\n      </div>\n      "),this.on("click",function(){this.controller.changeLabel(this.data)},this.id),out("\n    "),out.toString()}}]}),CLASS({model_:"Model","package":"com.google.mail",name:"ProfileView",extendsModel:"foam.ui.View",requires:["com.google.mail.GMailUserInfo","foam.ui.ImageView"],properties:[{model_:"ModelProperty",name:"model",factory:function(){return this.GMailUserInfo}}],templates:[{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      "),this.data&&out("\n          ",self.createTemplateView("avatarUrl",{model_:"foam.ui.ImageView"}),"\n          ",self.createTemplateView("name",{mode:"read-only",extraClassName:"name"}),"\n          ",self.createTemplateView("email",{mode:"read-only",extraClassName:"email"}),"\n      "),out("\n    "),out.toString()}}]}),CLASS({model_:"Model","package":"foam.ui",name:"ImageView",extendsModel:"foam.ui.View",properties:[{model_:"Property",name:"className",defaultValue:"imageView"},{model_:"Property",name:"backupImage"},{model_:"Property",name:"domValue",postSet:function(oldValue,newValue){oldValue&&Events.unfollow(this.data$,oldValue),newValue&&Events.follow(this.data$,newValue)}},{model_:"Property",name:"displayWidth",postSet:function(_,newValue){this.$&&(this.$.style.width=newValue)}},{model_:"Property",name:"displayHeight",postSet:function(_,newValue){this.$&&(this.$.style.height=newValue)}}],methods:{toHTML:function(){var src=window.IS_CHROME_APP?this.backupImage?' src="'+this.backupImage+'"':"":' src="'+this.data+'"';return"<img "+this.cssClassAttr()+' id="'+this.id+'"'+src+">"},isSupportedUrl:function(url){return url=url.trim().toLowerCase(),url.startsWith("data:")||url.startsWith("blob:")||url.startsWith("filesystem:")},initHTML:function(){if(this.SUPER(),this.backupImage&&this.$.addEventListener("error",function(){this.data=this.backupImage}.bind(this)),window.IS_CHROME_APP&&!this.isSupportedUrl(this.data)){var self=this,xhr=new XMLHttpRequest;xhr.open("GET",this.data),xhr.responseType="blob",xhr.asend(function(blob){blob&&(self.$.src=URL.createObjectURL(blob))
})}else this.domValue=DomValue.create(this.$,void 0,"src"),this.displayHeight=this.displayHeight,this.displayWidth=this.displayWidth}}}),CLASS({model_:"Model","package":"com.google.mail",name:"QueryParser",requires:["foam.lib.email.EMail"],properties:[{model_:"Property",name:"parser",lazyFactory:function(){var EMail=this.EMail,parser={__proto__:QueryParserFactory(EMail),id:sym("string"),labelMatch:seq(alt("label","l"),alt(":","="),sym("valueList"))}.addActions({id:function(v){return OR(CONTAINS_IC(EMail.TO,v),CONTAINS_IC(EMail.FROM,v),CONTAINS_IC(EMail.SUBJECT,v),CONTAINS_IC(EMail.BODY,v))},labelMatch:function(v){for(var or=OR(),values=v[2],i=0;i<values.length;i++)or.args.push(EQ(EMail.LABELS,values[i]));return or}});return parser.expr=alt(sym("labelMatch"),parser["export"]("expr")),parser}}]}),CLASS({model_:"Model","package":"foam.lib.contacts",name:"Contact",properties:[{model_:"StringProperty",name:"id"},{model_:"Property",name:"type",hidden:!0,defaultValue:"Contact"},{model_:"StringProperty",name:"title",displayWidth:50},{model_:"DateTimeProperty",name:"updated",factory:function(){return new Date}},{model_:"BooleanProperty",name:"deleted"},{model_:"StringProperty",name:"etag"},{model_:"StringProperty",name:"prefix"},{model_:"StringProperty",name:"first"},{model_:"StringProperty",name:"middle"},{model_:"StringProperty",name:"last"},{model_:"StringProperty",name:"suffix"},{model_:"StringProperty",name:"displayName",defaultValueFn:function(){return this.title.length>0?this.title:this.first.length>0||this.last.length>0?this.first+" "+this.last:this.email}},{model_:"StringProperty",name:"email",label:""},{model_:"ArrayProperty",name:"phoneNumbers",subType:"PhoneNumber"},{model_:"ArrayProperty",name:"addresses",subType:"Address"},{model_:"DateProperty",name:"birthday"},{model_:"StringProperty",name:"url",displayWidth:70},{model_:"Property",name:"avatar",type:"String",view:"foam.ui.ImageView",defaultValueFn:function(){var key=this.title?this.title[0].toUpperCase():this.email?this.email[0].toUpperCase():"";return this.generateAvatar(key)}},{model_:"Property",name:"iconURL",view:"foam.ui.ImageView",defaultValue:"images/contact.png"},{model_:"StringProperty",name:"note",displayHeight:10}],methods:{init:function(){this.SUPER(),this.model_.getPrototype().generateAvatar.memoized||(this.model_.getPrototype().generateAvatar=memoize(this.model_.getPrototype().generateAvatar),this.model_.getPrototype().generateAvatar.memoized=!0)},generateAvatar:function(letter){return letter.length<1?"":'data:image/svg+xml;utf-8,<svg version="1.1" xmlns="http://www.w3.org/2000/svg" x="0" y="0" width="21" height="21"><rect width="21" height="21" x="0" y="0" style="fill:#d40000"/><text x="10" y="17" style="text-anchor:middle;font-size:19;font-style:normal;font-weight:bold;font-family:Arial, sans;fill:#fff">'+letter+"</text></svg>"}}}),CLASS({model_:"Model","package":"foam.lib.contacts",name:"ContactNetworkDAO",extendsModel:"AbstractDAO",requires:["foam.lib.contacts.Contact as Contact","foam.lib.contacts.PhoneNumber as PhoneNumber","foam.lib.contacts.Address as Address"],imports:["ajsonp","authAgent"],properties:[{model_:"Property",name:"daoListeners_",hidden:!0,"transient":!0,factory:function(){return[]}},{model_:"Property",name:"url",defaultValue:"https://www.google.com/m8/feeds/contacts/default/full"},{model_:"Property",name:"authAgent"},{model_:"IntProperty",name:"batchSize",defaultValue:1e3},{model_:"Property",name:"ajsonp",hidden:!0,"transient":!0}],methods:{select:function(sink,options){options={__proto__:options};var params=["alt=json","v=3.0","max-results="+this.batchSize,"orderby=lastmodified"];this.authAgent&&this.authAgent.accessToken&&param.push("access_token="+encodeURIComponent(this.authAgent.accessToken));var query=options.query;query&&GtExpr.isInstance(query)&&query.arg1.equals(this.Contact.UPDATED)&&ConstantExpr.isInstance(query.arg2)&&(params.push("updated-min="+encodeURIComponent(query.arg2.f().toISOString())),query=TRUE),options.query=query,options.order&&(options.order.equals(this.Contact.UPDATED)?options.order=void 0:DescExpr.isInstance(options.order)&&options.order.arg1.equals(this.Contact.UPDATE)&&(options.order=void 0,params.push("sortorder=descending"))),sink=this.decorateSink_(sink||[].sink,options);var url=this.url,fc=this.createFlowControl_(),self=this,future=afuture(),index=1,total=1/0,error=!1;return awhile(function(){return total>=index&&!fc.stopped&&!fc.errorEvt},aseq(function(ret){var myparams=params.slice();myparams.push("start-index="+index),self.ajsonp(url,myparams)(ret)},function(ret,data){var contacts=data&&data.feed&&data.feed.entry;if(!contacts)return error=!0,sink&&sink.error&&sink.error("Error loading contacts"),void future.set(sink);total=data.feed.openSearch$totalResults.$t;for(var i=0;i<contacts.length&&!fc.stopped;i++){if(fc.errorEvt)return error=!0,sink.error&&sink.error(fc.errorEvt),future.set(sink),void ret();var c=contacts[i],contact=self.objFromJson(c);index++,sink.put&&sink.put(contact,null,fc)}ret()}))(function(){error||(sink.eof&&sink.eof(),future.set(sink))}),future.get},objFromJson:function(c){var self=this,obj=this.Contact.create({id:c.id?c.id.$t.split("/").pop():"",title:c.title?c.title.$t:"",email:c.gd$email?c.gd$email[0].address:"",updated:c.updated?c.updated.$t:""});return c.gd$phoneNumber&&c.gd$phoneNumber.forEach(function(p){obj.phoneNumbers.push(self.PhoneNumber.create({type:p.rel?p.rel.replace(/^.*#/,""):p.label?p.label:"main",number:p.$t}))}),c.gd$postalAddress&&c.gd$postalAddress.forEach(function(a){obj.addresses.push(self.Address.create({type:a.rel.replace(/^.*#/,""),street:a.$t}))}),obj}}}),CLASS({model_:"Model","package":"foam.lib.contacts",name:"PhoneNumber",ids:["number"],properties:[{model_:"StringProperty",name:"type"},{model_:"StringProperty",name:"number"}]}),CLASS({model_:"Model","package":"foam.lib.contacts",name:"Address",ids:["type"],properties:[{model_:"StringProperty",name:"type"},{model_:"StringProperty",name:"poBox",label:"P.O. Box",displayWidth:70},{model_:"StringProperty",name:"street",displayWidth:70},{model_:"StringProperty",name:"localArea",displayWidth:70},{model_:"StringProperty",name:"city",displayWidth:70},{model_:"StringProperty",name:"county",label:"County / Area",displayWidth:70},{model_:"StringProperty",name:"postalCode",displayWidth:12},{model_:"StringProperty",name:"country",displayWidth:40}]}),CLASS({model_:"Model","package":"foam.ui.md",name:"ResponsiveAppControllerView",extendsModel:"foam.ui.layout.ResponsiveView",requires:["foam.ui.layout.ResponsiveViewOption","foam.ui.md.TwoPane","foam.ui.DetailView"],properties:[{model_:"Property",name:"options",factory:function(){return[this.ResponsiveViewOption.create({data$:this.data$,controller:"foam.ui.DetailView",minWidth:0}),this.ResponsiveViewOption.create({data$:this.data$,controller:"foam.ui.md.TwoPane",minWidth:600})]}}]}),CLASS({model_:"Model","package":"foam.ui.layout",name:"ResponsiveViewOption",properties:[{model_:"Property",name:"data"},{model_:"ViewFactoryProperty",name:"controller"},{model_:"IntProperty",name:"minWidth"}]}),CLASS({model_:"Model","package":"foam.ui.md",name:"TwoPane",extendsModel:"foam.ui.DetailView",requires:["foam.ui.layout.DOMPanel"],properties:[{model_:"ModelProperty",name:"model",defaultValue:"AppController"}],templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .panes {\n      display: flex;\n      }\n      .right-pane {\n        flex-grow: 1;\n      }\n      .left-pane {\n        display: flex;\n        flex-direction: column;\n        width: 300px;\n      }\n    "),out.toString()}},{model_:"Template",name:"toHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out('\n    <div id="',this.setClass("searchMode",function(){return self.data.searchMode},this.id),'"  class="mdui-app-controller">\n       <div class="header">\n         <span class="default">\n           ',self.createTemplateView("name",{mode:"read-only",className:"name"}),"\n           "),this.data.refreshAction&&out(this.createActionView(this.data.refreshAction,{data:this.data})),out("\n           "),this.data.spinner&&out('\n             <span class="mdui-app-controller-spinner">\n               ',this.data.spinner,"\n             </span>\n           "),out("\n           ",self.createTemplateView("enterSearchMode")," ",self.data.sortOrderView,'\n         </span>\n         <span class="search">\n           ',self.createTemplateView("leaveSearchMode",{className:"backButton"})," ",self.createTemplateView("q"),'\n         </span>\n       </div>\n       <div class="panes">\n         ',this.DOMPanel.create({className:"left-pane",data:this.data.menuFactory()}),'\n         <div class="right-pane">\n           ',self.data.filteredDAOView,"\n           "),this.data.createAction&&out(this.createActionView(this.data.createAction,{data:this.data,className:"createButton",color:"white",font:"30px Roboto Arial",alpha:1,width:44,height:44,radius:22,background:"#e51c23"})),out("\n         </div>\n       </div>\n    </div>\n    "),this.addInitializer(function(){if(self.filterChoices){var v=self.data.filteredDAOView;v.index$.addListener(function(){self.qView.$.placeholder="Search "+v.views[v.index].label.toLowerCase()})}self.data.searchMode$.addListener(EventService.merged(function(){self.qView.$.focus()},100))}),this.on("touchstart",function(){console.log("blurring"),self.qView.$.blur()},this.data.filteredDAOView.id),this.on("click",function(){console.log("focusing"),self.qView.$.focus()},this.qView.id),out("\n    "),out.toString()}}]}),CLASS({model_:"Model","package":"foam.ui.layout",name:"DOMPanel",extendsModel:"foam.ui.BaseView",imports:["window"],traits:["foam.ui.HTMLViewTrait","foam.ui.TemplateSupportTrait","foam.ui.ViewActionsTrait"],properties:[{model_:"IntProperty",name:"width"},{model_:"IntProperty",name:"height"},{model_:"Property",name:"tagName",defaultValue:"div"},{model_:"Property",name:"data",postSet:function(){this.updateHTML()}}],methods:{init:function(){this.SUPER();var self=this;this.X.dynamic(function(){self.width,self.height},this.layout)},initHTML:function(){this.SUPER(),this.window.addEventListener("resize",this.onResize),this.width=this.$.clientWidth,this.height=this.$.clientHeight,this.onResize()},destroy:function(isParentDestroyed){this.SUPER(isParentDestroyed),this.window&&this.window.removeEventListener("resize",this.onResize)}},listeners:[{model_:"Method",name:"layout",code:function(){this.data&&(this.data.x=0,this.data.y=0,this.data.z=0,this.data.width=this.width,this.data.height=this.height)},isFramed:!0},{model_:"Method",name:"onResize",code:function(){this.$&&(this.width=this.$.clientWidth,this.height=this.$.clientHeight)},isMerged:100}],templates:[{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out("",this.data,""),out.toString()}}]}),CLASS({model_:"Model","package":"foam.ui.layout",name:"ResponsiveView",extendsModel:"foam.ui.View",requires:["foam.ui.layout.ResponsiveViewOption"],imports:["window"],properties:[{model_:"ArrayProperty",name:"options",preSet:function(_,v){return v.slice().sort(toCompare(this.ResponsiveViewOption.MIN_WIDTH))},subType:"foam.ui.layout.ResponsiveViewOption"},{model_:"Property",name:"current",type:"foam.ui.layout.ResponsiveViewOption",postSet:function(old,v){old!==v&&this.updateHTML()}},{model_:"Property",name:"tagName",defaultValue:"div"}],methods:{initInnerHTML:function(){this.SUPER(),this.window.addEventListener("resize",this.onResize),this.onResize_()},destroy:function(isParentDestroyed){this.SUPER(isParentDestroyed),this.window.removeEventListener("resize",this.onResize)},onResize_:function(){if(this.$){for(var width=this.$.clientWidth,i=0;i<this.options.length;i++){var option=this.options[i];if(option.minWidth>width)break}i=Math.max(i-1,0),this.current=this.options[i]}}},listeners:[{model_:"Method",name:"onResize",code:function(){this.onResize_()},isMerged:100}],templates:[{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out(""),this.destroy(),out("",this.current?this.current.controller({data$:this.data$}):"",""),out.toString()}}]}),CLASS({model_:"Model","package":"foam.ui.layout",name:"MobileWindow",extendsModel:"foam.ui.layout.Window",methods:{init:function(args){this.SUPER(args),this.window.document.head.insertAdjacentHTML("afterbegin",'<meta name="viewport" content="initial-scale=1.0, width=device-width, user-scalable=no">')}}}),CLASS({model_:"Model","package":"foam.ui.layout",name:"Window",extendsModel:"foam.ui.BaseView",imports:["dynamic","window"],traits:["foam.ui.HTMLViewTrait","foam.ui.TemplateSupportTrait","foam.ui.ViewActionsTrait"],properties:[{model_:"IntProperty",name:"width"},{model_:"IntProperty",name:"height"},{model_:"Property",name:"window",hidden:!0,postSet:function(o,w){o&&o.removeEventListener("resize",this.onResize),w.addEventListener("resize",this.onResize),this.onResize()}},{model_:"Property",name:"data",postSet:function(_,v){var self=this;v.x=0,v.y=0,this.dynamic(function(){self.width,self.height},function(){v.width=self.width,v.height=self.height}),this.rendered&&this.updateHTML()}},{model_:"BooleanProperty",name:"rendered",defaultValue:!1}],methods:{init:function(args){this.SUPER(args);var self=this;this.dynamic(function(){self.height},function(){self.window.document.body.style.height=self.height+"px"})},updateHTML:function(){this.window.document.body.innerHTML=this.toHTML(),this.initHTML()},toHTML:function(){return this.rendered=!0,this.children=[this.data],this.data&&this.data.toHTML()}},listeners:[{model_:"Method",name:"onResize",code:function(){this.height=this.window.innerHeight,this.width=this.window.innerWidth}}],templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .body {\n        padding: 0px;\n        margin: 0px;\n        border: 0px\n      }\n    "),out.toString()}}]}),CLASS({model_:"Model","package":"foam.ui",name:"RelationshipView",extendsModel:"foam.ui.BaseView",traits:["foam.ui.HTMLViewTrait","foam.ui.TemplateSupportTrait","foam.ui.ViewActionsTrait"],properties:[{model_:"Property",name:"data",postSet:function(old,nu){this.destroy(),this.construct()}},{model_:"Property",name:"relationship",required:!0},{model_:"Property",name:"args"},{model_:"ViewFactoryProperty",name:"viewModel",defaultValue:"foam.ui.DAOController"},{model_:"Property",name:"view"}],methods:{init:function(args){this.SUPER(args),this.args&&this.args.model_&&(this.viewModel=this.args.model_)},construct:function(){this.SUPER(),this.view=this.viewModel({dao:this.data[this.relationship.name],model:this.relationship.relatedModel},this.X).copyFrom(this.args),this.addChild(this.view)}},templates:[{model_:"Template",name:"toInnerHTML",code:function(opt_out){var self=this,X=this.X,Y=this.Y,escapeHTML=XMLUtil.escape,out=opt_out?opt_out:TemplateOutput.create(this);return out(" ",self.view," "),out.toString()}}]}),CLASS({model_:"Model","package":"foam.ui",name:"Tooltip",extendsModel:"foam.ui.View",properties:[{model_:"Property",name:"text",help:"Help text to be shown in tooltip."},{model_:"Property",name:"target",help:"Target element to provide tooltip for."},{model_:"Property",name:"className",defaultValue:"tooltip"},{model_:"Property",name:"closed",defaultValue:!1}],methods:{init:function(){this.SUPER();var document=this.X.document;document.previousTooltip_=this,this.X.setTimeout(function(){if(!this.closed&&document.previousTooltip_==this){var div=document.createElement("div");this.X.setTimeout(this.close.bind(this),5e3),div.className=this.className,div.id=this.id,div.innerHTML=this.toInnerHTML(),document.body.appendChild(div);var s=this.X.window.getComputedStyle(div),pos=findViewportXY(this.target),screenHeight=this.X.document.body.clientHeight,scrollY=this.X.window.scrollY,above=pos[1]-scrollY>screenHeight/2,left=pos[0]+(this.target.clientWidth-toNum(s.width))/2,maxLeft=this.X.document.body.clientWidth+this.X.window.scrollX-15-div.clientWidth,targetHeight=this.target.clientHeight||this.target.offsetHeight;div.style.top=above?pos[1]-targetHeight/2-4:pos[1]+targetHeight/2+4,div.style.left=Math.max(this.X.window.scrollX+15,Math.min(maxLeft,left)),DOM.setClass(div,"animated"),this.X.setTimeout(function(){div.style.top=above?pos[1]-targetHeight-8:pos[1]+targetHeight+8},10),this.initHTML()}}.bind(this),800)},toInnerHTML:function(){return this.text},close:function(){this.closed||(this.closed=!0,this.X.setTimeout(function(){this.$&&(this.X.setTimeout(this.$.remove.bind(this.$),1e3),DOM.setClass(this.$,"fadeout"))}.bind(this),500))},destroy:function(isParentDestroyed){this.SUPER(isParentDestroyed),this.close()}},templates:[{model_:"Template",name:"CSS",code:function(opt_out){var out=opt_out?opt_out:TemplateOutput.create(this);return out("\n      .tooltip {\n        background: rgba(80,80,80,0.9);\n        border-radius: 4px;\n        color: white;\n        font-size: 10pt;\n        left: 0;\n        padding: 5px 8px;\n        position: absolute;\n        top: 0;\n        visibility: hidden;\n        z-index: 999;\n        -webkit-transform: translate3d(0, 0, 2px);\n      }\n      .tooltip.animated {\n        transition: top 0.5s ease-in-out;\n        visibility: visible;\n      }\n      .tooltip.fadeout {\n        opacity: 0;\n        transition: opacity 0.5s ease-in-out;\n      }\n    "),out.toString()}}]});